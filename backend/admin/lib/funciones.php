<?php
include_once 'lib/mssqlclass.php';
include_once 'lib/mysqlclass.php';
include_once 'lib/phpmailer/libemail.php';
include_once 'models/lista.php';
include_once 'models/notificacion.php';
include_once 'models/pais.php';
include_once 'models/diasemana.php';

include_once 'vendor/autoload.php';

use ExpoSDK\Expo;
use ExpoSDK\ExpoMessage;


function cambiarNombreEstatus($compania_id=null, $estatus_nombre=null, $tiposervicio_cod=null){

  $estatus_nombre = trim($estatus_nombre);

  if ($compania_id=="459" || $compania_id=="466"){

    if ($tiposervicio_cod=="7"){ // Sigueme

      if ($estatus_nombre=="Cotizacion"){$estatus_nombre="En curso";} 
      else if ($estatus_nombre=="En Viaje"){$estatus_nombre="En curso";}
      else if ($estatus_nombre=="Esperando al conductor"){$estatus_nombre="En curso";}
      else if ($estatus_nombre=="Por confirmar operador"){$estatus_nombre="En curso";}
      else if ($estatus_nombre=="Operador llegó donde el pasajero"){$estatus_nombre="Viaje finalizado";}

    }else{

      if ($estatus_nombre=="Cotizacion"){$estatus_nombre="Alerta enviada";} 
      else if ($estatus_nombre=="En Viaje"){$estatus_nombre="En curso";}
      else if ($estatus_nombre=="Esperando al operador"){$estatus_nombre="Esperando al operador";}
      else if ($estatus_nombre=="Por confirmar operador"){$estatus_nombre="Alerta esperando ser atendida";}
      else if ($estatus_nombre=="Conductor llegó donde el pasajero"){$estatus_nombre="Operador llegó al sitio";}

    }

    

  }
  
  return $estatus_nombre;
}


function actualizarInventarioFechaVencimiento($compania_id=null){

  // Verificar todos los productos y verificar la fecha de vencimiento y colocar estatus
	// 1.- Obtengo todos los estatus posibles por colocar:
  $instancialista = new Lista();

  $obtenerCodigoLista = 1; // En fecha
  $obtenerTipoLista = 396; // Estatus de productos por fecha de vencimiento
  $estatusenfecha = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

  $obtenerCodigoLista = 2; // Por vencer	
  $obtenerTipoLista = 396; // Estatus de productos por fecha de vencimiento
  $estatusporvencer = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

  $obtenerCodigoLista = 3; // Vencido	
  $obtenerTipoLista = 396; // Estatus de productos por fecha de vencimiento
  $estatusvencido = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

  $obtenerCodigoLista = 4; // No notificar	
  $obtenerTipoLista = 396; // Estatus de productos por fecha de vencimiento
  $estatusnonotificar = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

  $conexion = new ConexionBd();

  // 2.- Recorro los productos 
  // Coloco en estatus en fecha
  $resultado = $conexion->doUpdate("productostockfechavence", "
    l_estatus_id ='$estatusenfecha'
  ",
  "prodstockfechavence_activo='1' AND DATEDIFF(prodstockfechavence_vence, NOW()) > 60 and l_estatus_id <> '2778'  ");	

  // Coloco en estatus en por vencer	
  $resultado = $conexion->doUpdate("productostockfechavence", "
    l_estatus_id ='$estatusporvencer'
  ",
  "prodstockfechavence_activo='1' AND DATEDIFF(prodstockfechavence_vence, NOW()) BETWEEN 1 AND 60 and l_estatus_id <> '2778'   ");
  

  // Coloco en estatus en por vencer	
  $resultado = $conexion->doUpdate("productostockfechavence", "
    l_estatus_id ='$estatusvencido'
  ",
  "prodstockfechavence_activo='1' AND DATEDIFF(prodstockfechavence_vence, NOW()) <= 0 and l_estatus_id <> '2778' ");

  return true;

}

function cargarrequisitosEnFunciones($compania_id=null, $fechaactual=null, $usuario_id=null, $perfil_id=null){

  $instancialista = new Lista();

  $obtenerIdLista = 5; // Pendiente por Cargar
  $obtenerTipoLista = 50; // Estatus del Requisito
  $estatuspendiente = $instancialista->ObtenerIdLista($obtenerIdLista, $obtenerTipoLista);

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("lista.lista_id, lista.cuenta_id",
  "
  lista 
    inner join usuario cuentasistema on cuentasistema.usuario_id = lista.cuenta_id
    inner join compania companiasistema on companiasistema.compania_id = lista.compania_id	    	    	

    inner join listacuenta on listacuenta.lista_id = lista.lista_id
      and listacuenta.compania_id = '$compania_id'
          
    inner join usuario cuenta on cuenta.usuario_id = listacuenta.cuenta_id
    inner join compania on compania.compania_id = listacuenta.compania_id	    	    	
      and listacuenta.compania_id = '$compania_id'

    inner join listarequisitoperfil on listarequisitoperfil.l_requisitolista_id = lista.lista_id and listarequisitoperfil_activo = '1'

    inner join perfil on perfil.perfil_id = listarequisitoperfil.perfil_id
      and perfil.perfil_idorig = '$perfil_id'

  ",
  "lista.lista_eliminado = '0' and lista.tipolista_id = '49'  and ((lista.lista_ppal = '1'  and lista.lista_activo = '1'  ) or (lista.lista_ppal = '0' )) $where ", null, "lista.lista_orden asc");


foreach($arrresultado as $i=>$valor){

      $lista_id = utf8_encode($valor["lista_id"]); // El id del requisito
      $cuenta_id = utf8_encode($valor["cuenta_id"]);

      $arrresultado2 = $conexion->doSelect("requisito_id",
      "requisito",
      "l_requisitolista_id = '$lista_id' and requisito_activo = '1' and usuario_id = '$usuario_id'");

      if (count($arrresultado2)==0){

          $resultado = $conexion->doInsert("
          requisito
          (l_requisitolista_id, requisito_descrip, l_tipoarchivo_id, requisito_arch, 
          requisito_archnombre, requisito_cantarchivos, cuenta_id, compania_id, 
          requisito_activo, requisito_eliminado, requisito_fechareg, 
          usuario_idreg, l_estatus_id, usuario_id)
              ",
          "'$lista_id', '', '0', '0.jpg',
          '', '0', '$cuenta_id', '$compania_id', 
          '1', '0','$fechaactual',
          '$usuario_id','$estatuspendiente', '$usuario_id'");	
          
      }

  }

  $total = count($arrresultado);

  return $total;
}

function formatofechaSQL($compania_id=null){

  $fecha = "%d/%m/%Y";

  if ($compania_id=="447"){
    $fecha = "%Y-%m-%d";
  }

  return $fecha;
}

function ListadoPagoRemesas($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Cuenta  
        
        $columnacompania = "<th>Compañia</th>";
        $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' ";

  } else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,
    pago.l_estatus_id, 

    pagotransaccion.pagotrans_id, pagotransaccion.trans_id, 
    pagotransaccion.pagotrans_fechareg,
    estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb, 
    transaccion.trans_codigo,
    tiporemesa.lista_cod as tiporemesa_cod,
    tiporemesa.lista_nombre as tiporemesa_nombre

    ",
    "pago
      inner join pagotransaccion on pagotransaccion.pago_id = pago.pago_id
      inner join pagotransaccionremesa on pagotransaccionremesa.pago_id = pago.pago_id
      inner join lista tiporemesa on tiporemesa.lista_id = pagotransaccionremesa.l_tiporemesa_id
      inner join transaccion on transaccion.trans_id = pagotransaccion.trans_id
      inner join lista moneda on moneda.lista_id = pago.l_moneda_id      
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id
      

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 



  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){
    
    $tiporemesa_cod = utf8_encode($valor["tiporemesa_cod"]);
    $tiporemesa_nombre = utf8_encode($valor["tiporemesa_nombre"]);

    $trans_codigo = utf8_encode($valor["trans_codigo"]);
    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);

    $pagotrans_id = utf8_encode($valor["pagotrans_id"]);      
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]); 
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);


    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $aaa); 

    $trans_codigo = "#$trans_codigo";

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verpagoremesa?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verpagoremesa?id=$pago_id'>#$pago_id (Ver)</a>";


    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>            
            <td>$usuario</td>     
            <td>$trans_codigo</td>                           
            <td>$tiporemesa_nombre</td>         
            <td>$pago_monto $moneda_siglas</td>         
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}

function is_valid_email($str)
{
  return (false !== strpos($str, "@") && false !== strpos($str, "."));
}

function envioNotificacionEmail($correomasivo_id=null, $usuario_nombre=null, $usuario_apellido=null, $usuario_email=null, $usuario_id=null, $estatusenviado=null, $fechaactual=null, $descripcion=null, $titulo=null, $usuario_pushtoken=null, $cuenta_id=null, $compania_id=null, $elemento_id=null, $tipo=null){

  $asunto = $titulo;
  $texto = "
  
        <table border='0' width='100%' cellpadding='0' cellspacing='0' bgcolor='ffffff' class='bg_color'>

            <tr>
                <td align='center'>
                    <table border='0' align='center' width='590' cellpadding='0' cellspacing='0' class='container590'>
                        
                        <tr>
                            <td align='left' style='color: #343434; font-size: 16px; font-family: Calibri, sans-serif; font-weight:normal;letter-spacing: 2px; line-height: 35px;' class='main-header'>
                                <div style='line-height: 35px'>
                                    $descripcion
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td height='10' style='font-size: 10px; line-height: 10px;'>&nbsp;</td>
                        </tr>
                        <tr>
                            <td align='center'>
                                <table border='0' width='40' align='center' cellpadding='0' cellspacing='0' bgcolor='eeeeee'>
                                    <tr>
                                        <td height='2' style='font-size: 2px; line-height: 2px;'>&nbsp;</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>         
        </table>              
    ";

  $libemail = new LibEmail();          
  if ($usuario_email!=""){
    $resultado = $libemail->enviarcorreo($usuario_email, $asunto, $texto, $compania_id);
  }  

  return true;
}

function envioNotificacionPush($correomasivo_id=null, $usuario_nombre=null, $usuario_apellido=null, $usuario_email=null, $usuario_id=null, $estatusenviado=null, $fechaactual=null, $descripcion=null, $titulo=null, $usuario_pushtoken=null, $cuenta_id=null, $compania_id=null, $elemento_id=null, $tipo=null, $usuario_iddestino=null){

  if($elemento_id==""){$elemento_id=0;}

  if ($usuario_iddestino==""){$usuario_iddestino=0;}

  if ($usuario_pushtoken==""){
    return true;
  }

  if ($usuario_nombre=="Demo" && $compania_id=="408"){
    return true;
  }

  $instancialista = new Lista();

  $obtenerCodigoLista = 2; // Enviado
  $obtenerTipoLista = 158; //  Estatus de Correo Masivos
  $estatusenviado = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

	$obtenerCodigoLista = 3; // Usuarios
	$obtenerTipoLista = 276; // Tipo Notificación Mensaje Destino
	$tiponotificaciondestino = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

	$obtenerCodigoLista = 2; // Notificación a la App	
	$obtenerTipoLista = 284; // Tipo Notificación Envío
	$tiponotificacionenvio = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);


	$obtenerCodigoLista = 3; // No Leído
	$obtenerTipoLista = 158; //  Estatus de Correo Masivos
	$estatusnoleido = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

	$conexion = new ConexionBd();

  $tituloConvert = utf8_decode($titulo);	
  $descripcionConvert = utf8_decode($descripcion);	

	$resultado = $conexion->doInsert("
	correomasivo
	(correomasivocampana_id, correomasivo_fechaprog, correomasivo_fechaenvio, 
	correomasivo_activo, correomasivo_eliminado, correomasivo_fechareg, 
	l_estatus_id, cuenta_id, compania_id, usuario_idreg, correomasivo_nombre, 
	correomasivo_cantidad, l_tiponotificaciondestino_id, l_tiponotificacionenvio_id, correomasivo_codigo) 
	",
	"'0', null,'$fechaactual',
	'1','0', '$fechaactual', 
	'$estatusenviado','$cuenta_id','$compania_id','$usuario_id','$tituloConvert',
	'1','$tiponotificaciondestino','$tiponotificacionenvio', '$tipo'");

	$arrresultado2 = $conexion->doSelect("max(correomasivo_id) as correomasivo_id","correomasivo");
	if (count($arrresultado2)>0){
		foreach($arrresultado2 as $i=>$valor){
			$correomasivo_id = ($valor["correomasivo_id"]);
		}
	}

	$resultado = $conexion->doInsert("
	correomasivodetalle
		(correomasivo_id, correomasivodet_usuarionombre, correomasivodet_usuarioemail, usuario_id, 
		l_estatus_id, correomasivodet_activo, correomasivodet_eliminado, correomasivodet_fechareg, 
		correomasivodet_usuariopush, correomasivodet_titulo, correomasivodet_descrip, elemento_id,
		usuario_iddestino, correomasivodet_leido)
	",
	"'$correomasivo_id', '$usuario_nombre $usuario_apellido','$usuario_email','$usuario_id',
	'$estatusnoleido','1','0', '$fechaactual', 
	'$usuario_pushtoken','$tituloConvert','$descripcionConvert', '$elemento_id',
  '$usuario_iddestino', '0'");

	$arrresultado2 = $conexion->doSelect("max(correomasivodet_id) as correomasivodet_id","correomasivodetalle");
	if (count($arrresultado2)>0){
		foreach($arrresultado2 as $i=>$valor){
			$correomasivodet_id = ($valor["correomasivodet_id"]);
		}
	}

	$valores = array(
		"id" => $elemento_id,
		"tipo" => $tipo
	);
	
	$object = (object) $valores;	
  /*
  if ($compania_id=="406"){
    $titulo = "canción";
    $descripcion = "canción2";
  }
    */

	if ($descripcion!=""){
		$messages = [
			new ExpoMessage([
				'title' => $titulo,
				'body' => $descripcion,
				'data' => $object
			]),
		];
	}else{
		$messages = [
			new ExpoMessage([
				'title' => $titulo,
				'data' => $object
			]),
		];
	}	
	
	$defaultRecipients = [    
		$usuario_pushtoken
	];
	
	$response = (new Expo)->send($messages)->to($defaultRecipients)->push();
	
	$data = $response->getData();

	foreach($data as $i=>$valor){
		$id = utf8_encode($valor["id"]);
		$status = utf8_encode($valor["status"]);
	   
		if ($status=="ok"){

			$resultado = $conexion->doUpdate("correomasivodetalle", "
				correomasivodet_usuariopushresponse ='1'
			",
			"correomasivodet_id='$correomasivodet_id'");	
			
			return true;
		}
	
	}

}

function enviarNotificacionFunciones($correomasivo_id=null, $usuario_nombre=null, $usuario_apellido=null, $usuario_email=null, $usuario_id=null, $estatusenviado=null, $fechaactual=null, $descripcion=null, $titulo=null, $usuario_pushtoken=null, $cuenta_id=null, $compania_id=null, $elemento_id=null, $tipo=null, $descripcionemail, $usuario_iddestino=null){

  if ($usuario_iddestino=="" || $usuario_iddestino=="0"){
    $usuario_iddestino= $usuario_id;
  }

  if ($elemento_id==""){
    $elemento_id = 0;
  }

  // Envio de notificacion por PushToken
  envioNotificacionPush($correomasivo_id, $usuario_nombre, $usuario_apellido, $usuario_email, $usuario_id, $estatusenviado, $fechaactual, $descripcion, $titulo, $usuario_pushtoken, $cuenta_id, $compania_id, $elemento_id, $tipo, $usuario_iddestino);

  if ($compania_id=="470"){
    return true;
  }

  // Envio de notificacion por Email
  envioNotificacionEmail($correomasivo_id, $usuario_nombre, $usuario_apellido, $usuario_email, $usuario_id, $estatusenviado, $fechaactual, $descripcionemail, $titulo, $usuario_pushtoken, $cuenta_id, $compania_id, $elemento_id, $tipo);  

}

function ObtenerListaEjercicioFisico($cuentaseleccionada=null, $companiaseleccionada=null, $getejerciciofisico_id=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and ejercicio_fisico.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and ejercicio_fisico.cuenta_id = '$_COOKIE[idcuenta]' and ejercicio_fisico.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and ejercicio_fisico.cuenta_id = '$_COOKIE[idcuenta]' and ejercicio_fisico.compania_id = '$_COOKIE[idcompania]' ";

  } 

  session_start();
  $iniuser = $_COOKIE[iniuser];
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("	
	ejercicio_fisico.ejerciciofisico_id, ejercicio_fisico.ejerciciofisico_nombre, 
	ejercicio_fisico.ejerciciofisico_cod, ejercicio_fisico.ejerciciofisico_descrip, 
	ejercicio_fisico.ejerciciofisico_img, ejercicio_fisico.usuario_id, 
	ejercicio_fisico.cuenta_id, ejercicio_fisico.compania_id, 
	ejercicio_fisico.ejerciciofisico_activo,
	ejercicio_fisico.ejerciciofisico_eliminado,
	DATE_FORMAT(ejercicio_fisico.ejerciciofisico_fechareg,'%d/%m/%Y %H:%i:%s') as ejerciciofisico_fechareg,			
	usuario.usuario_nombre as usuario_nombre,
	usuario.usuario_apellido as usuario_apellido,
	cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
	cuenta.usuario_apellido as cuenta_apellido, compania_nombre
	",
	"ejercicio_fisico					
		inner join usuario on usuario.usuario_id = ejercicio_fisico.usuario_id
		inner join usuario cuenta on cuenta.usuario_id = ejercicio_fisico.cuenta_id
		inner join compania on compania.compania_id = ejercicio_fisico.compania_id						
	",
	"ejerciciofisico_eliminado = '0' $where", null, "ejercicio_fisico.ejerciciofisico_id desc");
	
  if ($iniuser!=""){
    $option .= "<option value=''>-- Seleccione --</option>";
  }

  foreach($arrresultado as $i=>$valor){	
    
		$ejerciciofisico_id = utf8_encode($valor["ejerciciofisico_id"]);
		$ejerciciofisico_nombre = utf8_encode($valor["ejerciciofisico_nombre"]);

    if ($getejerciciofisico_id==$ejerciciofisico_id){
      $option .= "<option selected='selected' value='$ejerciciofisico_id'>$ejerciciofisico_nombre</option>";
    }else{
      $option .= "<option value='$ejerciciofisico_id'>$ejerciciofisico_nombre</option>";
    }

  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN EJERCICIOS</option>";
  }

  return $option;

}

function ObtenerListaEntrenamiento($cuentaseleccionada=null, $companiaseleccionada=null, $getentrenamiento_id=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and entrenamiento.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and entrenamiento.cuenta_id = '$_COOKIE[idcuenta]' and entrenamiento.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and entrenamiento.cuenta_id = '$_COOKIE[idcuenta]' and entrenamiento.compania_id = '$_COOKIE[idcompania]' ";

  } 

  session_start();
  $iniuser = $_COOKIE[iniuser];
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("
    entrenamiento.entrenamiento_id, entrenamiento.entrenamiento_nombre,
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre
    ",
    "entrenamiento						
      inner join usuario cuenta on cuenta.usuario_id = entrenamiento.cuenta_id
      inner join compania on compania.compania_id = entrenamiento.compania_id	
    ",
    "entrenamiento_eliminado = '0'  $where ", null, "entrenamiento_nombre asc");

  if ($iniuser!=""){
    $option .= "<option value=''>-- Seleccione --</option>";
  }

  foreach($arrresultado as $i=>$valor){	
    $entrenamiento_id = utf8_encode($valor["entrenamiento_id"]);
    $entrenamiento_nombre = utf8_encode($valor["entrenamiento_nombre"]);    

    if ($getentrenamiento_id==$entrenamiento_id){
      $option .= "<option selected='selected' value='$entrenamiento_id'>$entrenamiento_nombre</option>";
    }else{
      $option .= "<option value='$entrenamiento_id'>$entrenamiento_nombre</option>";
    }

  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN ENTRENAMIENTOS</option>";
  }

  return $option;

}

function ObtenerListaJuegoModalidad($cuentaseleccionada=null, $companiaseleccionada=null, $juego_id=null, $getjuegomodalidad_id=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and juego.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and juego.cuenta_id = '$_COOKIE[idcuenta]' and juego.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and juego.cuenta_id = '$_COOKIE[idcuenta]' and juego.compania_id = '$_COOKIE[idcompania]' ";

  } 

  session_start();
  $iniuser = $_COOKIE[iniuser];
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("

    juegomodalidad_id, juegomodalidad_nombre, juegomodalidad_descrip, juegomodalidad_img, juegomodalidad_orden, juegomodalidad_activo, juegomodalidad_eliminado, juegomodalidad_usuarios,
    juego.juego_id, juego.juego_nombre, juego.juego_descrip, juego.juego_img, 
    juego.juego_orden, juego.juego_fechareg, juego.cuenta_id, juego.compania_id, 
    juego.juego_activo, juego.juego_eliminado,
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre
    ",
    "juego			
      inner join juegomodalidad on juegomodalidad.juego_id = juego.juego_id			
      inner join usuario cuenta on cuenta.usuario_id = juego.cuenta_id
      inner join compania on compania.compania_id = juego.compania_id	
    ",
    "juego_eliminado = '0' and juegomodalidad_activo = '1' and juego.juego_id = '$juego_id'  $where ", null, "juegomodalidad_nombre asc");

  if ($iniuser!=""){
    $option .= "<option value=''>-- Seleccione --</option>";
  }

  foreach($arrresultado as $i=>$valor){	
    $juegomodalidad_id = utf8_encode($valor["juegomodalidad_id"]);
    $juegomodalidad_nombre = utf8_encode($valor["juegomodalidad_nombre"]);    

    if ($getjuegomodalidad_id==$juegomodalidad_id){
      $option .= "<option selected='selected' value='$juegomodalidad_id'>$juegomodalidad_nombre</option>";
    }else{
      $option .= "<option value='$juegomodalidad_id'>$juegomodalidad_nombre</option>";
    }

  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN MODALIDADES</option>";
  }

  return $option;

}

function ObtenerListaEvento($cuentaseleccionada=null, $companiaseleccionada=null, $getevento_id=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and evento.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and evento.cuenta_id = '$_COOKIE[idcuenta]' and evento.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and evento.cuenta_id = '$_COOKIE[idcuenta]' and evento.compania_id = '$_COOKIE[idcompania]' ";

  } 

  session_start();
  $iniuser = $_COOKIE[iniuser];
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("
    evento.evento_id, evento.evento_nombre,
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre
    ",
    "evento						
      inner join usuario cuenta on cuenta.usuario_id = evento.cuenta_id
      inner join compania on compania.compania_id = evento.compania_id	
    ",
    "evento_eliminado = '0'  $where ", null, "evento_nombre asc");

  if ($iniuser!=""){
    $option .= "<option value=''>-- Seleccione --</option>";
  }

  foreach($arrresultado as $i=>$valor){	
    $evento_id = utf8_encode($valor["evento_id"]);
    $evento_nombre = utf8_encode($valor["evento_nombre"]);    

    if ($getevento_id==$evento_id){
      $option .= "<option selected='selected' value='$evento_id'>$evento_nombre</option>";
    }else{
      $option .= "<option value='$evento_id'>$evento_nombre</option>";
    }

  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN EVENTOS</option>";
  }

  return $option;

}

function ObtenerListaJuego($cuentaseleccionada=null, $companiaseleccionada=null, $getjuego_id=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and juego.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and juego.cuenta_id = '$_COOKIE[idcuenta]' and juego.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and juego.cuenta_id = '$_COOKIE[idcuenta]' and juego.compania_id = '$_COOKIE[idcompania]' ";

  } 

  session_start();
  $iniuser = $_COOKIE[iniuser];
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("
    juego.juego_id, juego.juego_nombre, juego.juego_descrip, juego.juego_img, 
    juego.juego_orden, juego.juego_fechareg, juego.cuenta_id, juego.compania_id, 
    juego.juego_activo, juego.juego_eliminado,
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre
    ",
    "juego						
      inner join usuario cuenta on cuenta.usuario_id = juego.cuenta_id
      inner join compania on compania.compania_id = juego.compania_id	
    ",
    "juego_eliminado = '0'  $where ", null, "juego_nombre asc");

  if ($iniuser!=""){
    $option .= "<option value=''>-- Seleccione --</option>";
  }

  foreach($arrresultado as $i=>$valor){	
    $juego_id = utf8_encode($valor["juego_id"]);
    $juego_nombre = utf8_encode($valor["juego_nombre"]);    

    if ($getjuego_id==$juego_id){
      $option .= "<option selected='selected' value='$juego_id'>$juego_nombre</option>";
    }else{
      $option .= "<option value='$juego_id'>$juego_nombre</option>";
    }

  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN JUEGOS</option>";
  }

  return $option;

}

function ObtenerJuegoPlataforma($cuentaseleccionada=null, $companiaseleccionada=null, $juego_id=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and lista.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and lista.cuenta_id = '$_COOKIE[idcuenta]' and lista.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and lista.cuenta_id = '$_COOKIE[idcuenta]' and lista.compania_id = '$_COOKIE[idcompania]' ";

  } 

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("
    lista.lista_id, lista.lista_nombre,
    juegoplataforma.juegoplataforma_id,
		cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
		cuenta.usuario_apellido as cuenta_apellido, compania_nombre    
		",
		"lista						
			  inner join usuario cuenta on cuenta.usuario_id = lista.cuenta_id
		    inner join compania on compania.compania_id = lista.compania_id		
        left join juegoplataforma on juegoplataforma.l_juegoplataforma_id = lista.lista_id and juegoplataforma.juego_id = '$juego_id' and juegoplataforma_activo = '1'
        
		",
		"lista_activo = '1' and lista.tipolista_id = '337' ", null, "lista.lista_nombre asc");
	foreach($arrresultado as $i=>$valor){

		$lista_id = utf8_encode($valor["lista_id"]);
		$lista_nombre = utf8_encode($valor["lista_nombre"]);
    $juegoplataforma_id = utf8_encode($valor["juegoplataforma_id"]);

    if ($juegoplataforma_id!=""){
      $option .= "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
    }else{
      $option .= "<option value='$lista_id'>$lista_nombre</option>";
    }

  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN PLATAFORMAS</option>";
  }

  return $option;

}

function ObtenerJuegoCaracteristica($cuentaseleccionada=null, $companiaseleccionada=null, $juego_id=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and lista.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and lista.cuenta_id = '$_COOKIE[idcuenta]' and lista.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and lista.cuenta_id = '$_COOKIE[idcuenta]' and lista.compania_id = '$_COOKIE[idcompania]' ";

  } 

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("
    lista.lista_id, lista.lista_nombre,
    juegocaracteristica.juegocaract_id,
		cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
		cuenta.usuario_apellido as cuenta_apellido, compania_nombre    
		",
		"lista						
			  inner join usuario cuenta on cuenta.usuario_id = lista.cuenta_id
		    inner join compania on compania.compania_id = lista.compania_id		
        left join juegocaracteristica on juegocaracteristica.l_juegocaract_id = lista.lista_id and juegocaracteristica.juego_id = '$juego_id' and juegocaract_activo = '1'
        
		",
		"lista_activo = '1' and lista.tipolista_id = '336' ", null, "lista.lista_nombre asc");
	foreach($arrresultado as $i=>$valor){

		$lista_id = utf8_encode($valor["lista_id"]);
		$lista_nombre = utf8_encode($valor["lista_nombre"]);
    $juegocaract_id = utf8_encode($valor["juegocaract_id"]);

    if ($juegocaract_id!=""){
      $option .= "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
    }else{
      $option .= "<option value='$lista_id'>$lista_nombre</option>";
    }

  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN CARACTERISTICAS</option>";
  }

  return $option;

}

function ListadoPagoContribuciones($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Cuenta  
        
        $columnacompania = "<th>Compañia</th>";
        $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' ";

  } else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,
    pago.l_estatus_id, 
    pago.pago_archoriginal,

    estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb, 

    transaccion.cliente_id, 
		usuariodenunciante.usuario_nombre as usuariodenunciante_nombre,
		usuariodenunciante.usuario_apellido as usuariodenunciante_apellido,
		usuariodenunciante.usuario_id as usuariodenunciante_id,		
		transaccion.trans_codigo, transaccion.trans_id,
		categoria.lista_nombre as categ_nombre
    
    ",
    "pago
      inner join lista moneda on moneda.lista_id = pago.l_moneda_id      
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id

      inner join pagotransaccionincidente on pagotransaccionincidente.pago_id = pago.pago_id
			inner join transaccion on transaccion.trans_id = pagotransaccionincidente.trans_id
			inner join usuarioretiro on usuarioretiro.usuarioretiro_id = pagotransaccionincidente.usuarioretiro_id
			inner join usuario usuariodenunciante on usuariodenunciante.usuario_id = usuarioretiro.usuario_id
			inner join transaccionincidente on transaccionincidente.trans_id = transaccion.trans_id
			inner join lista categoria on categoria.lista_id = transaccionincidente.l_categoriaincidencia_id
      

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 



  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $usuariodenunciante_nombre = utf8_encode($valor["usuariodenunciante_nombre"]);
    $usuariodenunciante_apellido = utf8_encode($valor["usuariodenunciante_apellido"]);
    $usuariodenunciante_id = utf8_encode($valor["usuariodenunciante_id"]);

    $usuariodenunciante = $usuariodenunciante_nombre." ".$usuariodenunciante_apellido;

    $trans_codigo = utf8_encode($valor["trans_codigo"]);
    $trans_id = utf8_encode($valor["trans_id"]);
    $categ_nombre = utf8_encode($valor["categ_nombre"]);   

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);

    $pagotrans_id = utf8_encode($valor["pagotrans_id"]);      
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]); 
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);


    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $moneda_siglas); 

    $listaplansuscrip_montoorig = $listaplansuscrip_monto;
    $listaplansuscrip_monto = number_format_personalizado($listaplansuscrip_monto, $monedaplan_siglas);

    $listaplansuscrip_montomaxrecaudacion = number_format_personalizado($listaplansuscrip_montomaxrecaudacion, $monedaplan_siglas);
    $listaplansuscrip_montomaxreporte = number_format_personalizado($listaplansuscrip_montomaxreporte, $monedaplan_siglas);

    if ($duracion=="1 Meses"){$duracion = "Mensual";}
    else if ($duracion=="1 Años"){$duracion = "Anual";}

    $pedido = "#$trans_codigo";

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verpagocontribucion?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verpagocontribucion?id=$pago_id'>#$pago_id (Ver pago)</a>";


    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>            
            <td># $trans_codigo</td>     
            <td>$usuariodenunciante</td>               
            <td>$pago_monto</td>         
            <td>$usuario</td>         
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}


function ListadoPagoSuscripcion($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Cuenta  
        
        $columnacompania = "<th>Compañia</th>";
        $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' ";

  } else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,
    pago.l_estatus_id, 
    pago.pago_archoriginal,

    estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb, 

    plan.lista_nombre as plan_nombre,
    listaplansuscripcion.listaplansuscrip_id, listaplansuscripcion.lista_id, 
    listaplansuscripcion.listaplansuscrip_monto, 
    listaplansuscripcion.l_moneda_id, listaplansuscripcion.listaplansuscrip_cantduracion, 
    listaplansuscripcion.l_tiempoduracion_id, 
    listaplansuscripcion.listaplansuscrip_montomaxrecaudacion, 
    listaplansuscripcion.listaplansuscrip_montomaxreporte, 

    tiempoduracion.lista_nombre as tiempoduracion_nombre,
    monedaplan.lista_nombredos as monedaplan_siglas,

    tipousuario.lista_nombre as tipousuario_nombre

    
    ",
    "pago
      inner join pagoplansuscripcion on pagoplansuscripcion.pago_id = pago.pago_id
      inner join lista moneda on moneda.lista_id = pago.l_moneda_id      
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id
      inner join lista plan on plan.lista_id = pagoplansuscripcion.l_plan_id
      inner join listaplansuscripcion on listaplansuscripcion.lista_id = plan.lista_id
      inner join lista monedaplan on monedaplan.lista_id = listaplansuscripcion.l_moneda_id  
      
      inner join lista tiempoduracion on tiempoduracion.lista_id = listaplansuscripcion.l_tiempoduracion_id  
			inner join lista tipousuario on tipousuario.lista_id = listaplansuscripcion.l_tipousuario_id  

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 



  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $tipousuario_nombre = utf8_encode($valor["tipousuario_nombre"]);
    $listaplansuscrip_id = utf8_encode($valor["listaplansuscrip_id"]);
    $lista_id = utf8_encode($valor["lista_id"]);
    $listaplansuscrip_monto = utf8_encode($valor["listaplansuscrip_monto"]);
    $l_moneda_id = utf8_encode($valor["l_moneda_id"]);
    $listaplansuscrip_cantduracion = utf8_encode($valor["listaplansuscrip_cantduracion"]);	
    $monedaplan_siglas = utf8_encode($valor["monedaplan_siglas"]);		
    $l_tiempoduracion_id = utf8_encode($valor["l_tiempoduracion_id"]);		
    $tiempoduracion_nombre = utf8_encode($valor["tiempoduracion_nombre"]);		
    $listaplansuscrip_montomaxrecaudacion = utf8_encode($valor["listaplansuscrip_montomaxrecaudacion"]);		
    $listaplansuscrip_montomaxreporte = utf8_encode($valor["listaplansuscrip_montomaxreporte"]);		

    $listaplansuscrip_montomaxrecaudacionoriginal = $listaplansuscrip_montomaxrecaudacion;
    $listaplansuscrip_montomaxreporteoriginal = $listaplansuscrip_montomaxreporte;

    $duracion = $listaplansuscrip_cantduracion." ".$tiempoduracion_nombre;

    $plan_nombre = utf8_encode($valor["plan_nombre"]);

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);

    $pagotrans_id = utf8_encode($valor["pagotrans_id"]);      
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]); 
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);


    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $moneda_siglas); 

    $listaplansuscrip_montoorig = $listaplansuscrip_monto;
    $listaplansuscrip_monto = number_format_personalizado($listaplansuscrip_monto, $monedaplan_siglas);

    $listaplansuscrip_montomaxrecaudacion = number_format_personalizado($listaplansuscrip_montomaxrecaudacion, $monedaplan_siglas);
    $listaplansuscrip_montomaxreporte = number_format_personalizado($listaplansuscrip_montomaxreporte, $monedaplan_siglas);

    if ($duracion=="1 Meses"){$duracion = "Mensual";}
    else if ($duracion=="1 Años"){$duracion = "Anual";}

    $pedido = "#$trans_codigo";

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verpagosuscripcion?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verpagosuscripcion?id=$pago_id'>#$pago_id (Ver pago)</a>";


    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>            
            <td>$usuario</td>     
            <td>$plan_nombre</td>               
            <td>$pago_monto</td>         
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}

function obtenerListaTasaCambioFuente($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and tasacambiofuente.cuenta_id = '$_COOKIE[idcuenta]' ";

      if ($companiaseleccionada!=""){
        $where = " and tasacambiofuente.cuenta_id = '$_COOKIE[idcuenta]' and tasacambiofuente.compania_id = '$companiaseleccionada'  ";              
      }

  }  else { 

    $where = " and tasacambiofuente.cuenta_id = '$_COOKIE[idcuenta]' and tasacambiofuente.compania_id = '$_COOKIE[idcompania]' ";

  } 

  $option = "<option value=''>-- Seleccione --</option>";

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("	
  tasacambiofuente_id, tasacambiofuente_nombre, tasacambiofuente_img, tasacambiofuente_url, tasacambiofuente_orden, tasacambiofuente.cuenta_id, tasacambiofuente.compania_id, l_moneda_idorigen, l_moneda_iddestino, tasacambiofuente_fechareg, tasacambiofuente_activo, tasacambiofuente_eliminado
		",
		"tasacambiofuente 
			  inner join usuario cuenta on cuenta.usuario_id = tasacambiofuente.cuenta_id
		    inner join compania on compania.compania_id = tasacambiofuente.compania_id
		",
		"tasacambiofuente_activo = '1' $where ", null, "tasacambiofuente_orden desc");
	foreach($arrresultado as $i=>$valor){

		$tasacambiofuente_id = utf8_encode($valor["tasacambiofuente_id"]);
		$tasacambiofuente_nombre = utf8_encode($valor["tasacambiofuente_nombre"]);
    
    if ($tasacambiofuente_id==$idseleccionado){
      $option .= "<option value='$tasacambiofuente_id' selected= 'selected'>$tasacambiofuente_nombre</option>";    
    }else{
      $option .= "<option value='$tasacambiofuente_id'>$tasacambiofuente_nombre</option>";    
    }
    
  }

  return $option;

}

function obtenerListaPublicacionMensaje($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and publicacionmensaje.cuenta_id = '$_COOKIE[idcuenta]' ";

      if ($companiaseleccionada!=""){
        $where = " and publicacionmensaje.cuenta_id = '$_COOKIE[idcuenta]' and publicacionmensaje.compania_id = '$companiaseleccionada'  ";              
      }

  }  else { 

    $where = " and publicacionmensaje.cuenta_id = '$_COOKIE[idcuenta]' and publicacionmensaje.compania_id = '$_COOKIE[idcompania]' ";

  } 

  $option = "<option value=''>-- Seleccione --</option>";

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("	
		publicacionmensaje.publicacionmsje_id, publicacionmensaje.publicacionmsje_texto,
		publicacionmensaje.publicacionmsje_img,
		publicacionmensaje.publicacionmsje_orden,
		publicacionmensaje.publicacionmsje_fechareg, publicacionmensaje.publicacionmsje_activo,
		publicacionmensaje.publicacionmsje_eliminado, 
		publicacionmensaje.cuenta_id, publicacionmensaje.compania_id,
		cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
		cuenta.usuario_apellido as cuenta_apellido, compania_nombre		
		",
		"publicacionmensaje 
			  inner join usuario cuenta on cuenta.usuario_id = publicacionmensaje.cuenta_id
		    inner join compania on compania.compania_id = publicacionmensaje.compania_id
		",
		"publicacionmsje_activo = '1' $wheree ", null, "publicacionmsje_id desc");
	foreach($arrresultado as $i=>$valor){

		$publicacionmsje_id = utf8_encode($valor["publicacionmsje_id"]);
		$publicacionmsje_texto = utf8_encode($valor["publicacionmsje_texto"]);
    
    if ($publicacionmsje_id==$idseleccionado){
      $option .= "<option value='$publicacionmsje_id' selected= 'selected'>$publicacionmsje_texto</option>";    
    }else{
      $option .= "<option value='$publicacionmsje_id'>$publicacionmsje_texto</option>";    
    }
    
  }

  return $option;

}

function obtenerListaCuentaRedSocial($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and cuentaredsocial.cuenta_id = '$_COOKIE[idcuenta]' ";

      if ($companiaseleccionada!=""){
        $where = " and cuentaredsocial.cuenta_id = '$_COOKIE[idcuenta]' and cuentaredsocial.compania_id = '$companiaseleccionada'  ";              
      }

  }  else { 

    $where = " and cuentaredsocial.cuenta_id = '$_COOKIE[idcuenta]' and cuentaredsocial.compania_id = '$_COOKIE[idcompania]' ";

  } 

  $option = "<option value=''>-- Seleccione --</option>";

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("	
    cuentaredsocial.cuentaredsocial_id, cuentaredsocial.cuentaredsocial_nombre, 
    cuentaredsocial.cuentaredsocial_email, cuentaredsocial.cuentaredsocial_clave, 
    cuentaredsocial.l_red_id, cuentaredsocial.cuenta_id, cuentaredsocial.compania_id,
		cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
		cuenta.usuario_apellido as cuenta_apellido, compania_nombre		
		",
		"cuentaredsocial 
			  inner join usuario cuenta on cuenta.usuario_id = cuentaredsocial.cuenta_id
		    inner join compania on compania.compania_id = cuentaredsocial.compania_id
		",
		"cuentaredsocial_activo = '1' $wheree ", null, "cuentaredsocial.cuentaredsocial_id desc");
	foreach($arrresultado as $i=>$valor){

		$cuentaredsocial_id = utf8_encode($valor["cuentaredsocial_id"]);
		$cuentaredsocial_nombre = utf8_encode($valor["cuentaredsocial_nombre"]);
    
    if ($cuentaredsocial_id==$idseleccionado){
      $option .= "<option value='$cuentaredsocial_id' selected= 'selected'>$cuentaredsocial_nombre</option>";    
    }else{
      $option .= "<option value='$cuentaredsocial_id'>$cuentaredsocial_nombre</option>";    
    }
    
  }

  return $option;

}

function obtenerListaPublicacionRed($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and publicacionred.cuenta_id = '$_COOKIE[idcuenta]' ";

      if ($companiaseleccionada!=""){
        $where = " and publicacionred.cuenta_id = '$_COOKIE[idcuenta]' and publicacionred.compania_id = '$companiaseleccionada'  ";              
      }

  }  else { 

    $where = " and publicacionred.cuenta_id = '$_COOKIE[idcuenta]' and publicacionred.compania_id = '$_COOKIE[idcompania]' ";

  } 

  $option = "<option value=''>-- Seleccione --</option>";

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("	
		publicacionred_id, publicacionred_nombre, publicacionred_url, publicacionred_cantidad,
		publicacionred.l_red_id, publicacionred.l_tipopublired_id, 
		publicacionred.publicacionred_orden, publicacionred.publicacionred_fechareg,
		publicacionred.publicacionred_activo, publicacionred.publicacionred_eliminado, 
		publicacionred.cuenta_id, publicacionred.compania_id,
		cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
		cuenta.usuario_apellido as cuenta_apellido, compania_nombre		
		",
		"publicacionred 
			inner join usuario cuenta on cuenta.usuario_id = publicacionred.cuenta_id
		    inner join compania on compania.compania_id = publicacionred.compania_id
		",
		"publicacionred_activo = '1' $wheree ", null, "publicacionred_cantidad desc");
	foreach($arrresultado as $i=>$valor){

		$publicacionred_id = utf8_encode($valor["publicacionred_id"]);
		$publicacionred_nombre = utf8_encode($valor["publicacionred_nombre"]);
    $publicacionred_cantidad = utf8_encode($valor["publicacionred_cantidad"]);
    $publicacionred_cantidad = number_format($publicacionred_cantidad, 0, ',', '.');
    
    if ($publicacionred_id==$idseleccionado){
      $option .= "<option value='$publicacionred_id' selected= 'selected'>$publicacionred_nombre ($publicacionred_cantidad)</option>";    
    }else{
      $option .= "<option value='$publicacionred_id'>$publicacionred_nombre ($publicacionred_cantidad)</option>";    
    }
    
  }

  return $option;

}

function totalizarReferidos($usuario_idreferido=null, $compania_id=null){

  $conexion = new ConexionBd();  

  $total = 0;

  $arrresultado = $conexion->doSelect("count(*) as total",
		"usuario",
		"usuario_idreferido = '$usuario_idreferido' and usuario_eliminado = '0' and compania_id = '$compania_id'");
	foreach($arrresultado as $i=>$valor){
		$total = utf8_encode($valor["total"]);
  }

  $resultado = $conexion->doUpdate("usuario", 
  "usuario_totalreferidos = '$total'", 
  "usuario_id='$usuario_idreferido'");

  return true;

}

function verificarExisteUsuarioBalance($usuario_id=null, $compania_id=null){

  $conexion = new ConexionBd();  

  $arrresultado = $conexion->doSelect("cuenta_id",
		"usuario",
		"usuario_id = '$usuario_id' and compania_id = '$compania_id'");
	foreach($arrresultado as $i=>$valor){
		$cuenta_id = utf8_encode($valor["cuenta_id"]);
  }

  $arrresultado = $conexion->doSelect("usuario_id",
		"usuariobalance",
		"usuariobalance_eliminado = '0' and usuario_id = '$usuario_id' and compania_id = '$compania_id'");
	if (count($arrresultado)==0){

    $fechaactualreg = formatoFechaHoraBd();     
    $l_moneda_id = ObtenerMonedaPrincipalId($cuenta_id, $compania_id);

    $resultado = $conexion->doInsert("
      usuariobalance
      (usuario_id, usuariobalance_total, usuariobalance_bloqueado, 
      usuariobalance_disponible, usuariobalance_pendiente, usuariobalance_fechareg, 
      usuariobalance_activo, usuariobalance_eliminado, cuenta_id, compania_id, l_moneda_id,usuariobalance_cantidad, usuariobalance_sucursales)
    ",
    "'$usuario_id', '0', '0', 
    '0', '0', '$fechaactualreg',
    '1', '0','$cuenta_id','$compania_id', '$l_moneda_id',
    '0','0'");
    
  }

  return true;

}

function ObtenerListaTrenRamal($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and trenlinea.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and trenramal.cuenta_id = '$_COOKIE[idcuenta]' and trenramal.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and trenramal.cuenta_id = '$_COOKIE[idcuenta]' and trenramal.compania_id = '$_COOKIE[idcompania]' ";

  } 

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("
	trenramal.trenramal_id, trenramal.trenlinea_id, trenramal.trenestacion_idorigen, 
	trenramal.trenestacion_iddestino, trenramal.trenramal_orden, trenramal.trenramal_nombre, 
	trenramal.trenramal_img, trenramal.trenramal_docmapa, trenramal.trenramal_dochorarios, 
	trenramal.trenramal_doctarifas, trenramal.l_estatus_id, trenramal.cuenta_id, 
	trenramal.compania_id, trenramal.trenramal_activo, trenramal.trenramal_eliminado, 
	DATE_FORMAT(trenramal_fechareg,'%d/%m/%Y %H:%i:%s') as trenramal_fechareg,
	trenestacionorigen.trenestacion_nombre as trenestacionorigen_nombre,
	trenestaciondestino.trenestacion_nombre as trenestaciondestino_nombre,
	trenlinea.trenservicio_id, trenlinea.trenlinea_orden, 
	trenlinea.trenlinea_nombre, trenlinea.trenlinea_mapa, trenlinea.trenlinea_img, 
	trenlinea.cuenta_id, trenlinea.compania_id, 
	trenlinea.trenlinea_activo, trenlinea.trenlinea_eliminado, 
	DATE_FORMAT(trenlinea.trenlinea_fechareg,'%d/%m/%Y %H:%i:%s') as trenlinea_fechareg,
	trenservicio.trenservicio_orden, trenservicio.trenservicio_nombre,
	trenservicio.trenservicio_img, 
	trenservicio.trenservicio_activo, trenservicio.trenservicio_eliminado, 
	DATE_FORMAT(trenservicio.trenservicio_fechareg,'%d/%m/%Y %H:%i:%s') as trenservicio_fechareg,
	cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
	cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
	estatus.lista_nombre as estatus_nombre
		",
		"
		trenramal
			inner join trenestacion trenestacionorigen on trenestacionorigen.trenestacion_id = trenramal.trenestacion_idorigen
			inner join trenestacion trenestaciondestino on trenestaciondestino.trenestacion_id = trenramal.trenestacion_iddestino
			inner join trenlinea on trenlinea.trenlinea_id = trenramal.trenlinea_id
			inner join trenservicio	on trenservicio.trenservicio_id = trenlinea.trenservicio_id	
			inner join lista estatus on estatus.lista_id = trenramal.l_estatus_id			
			inner join usuario cuenta on cuenta.usuario_id = trenramal.cuenta_id
		    inner join compania on compania.compania_id = trenramal.compania_id		      
		",
		"trenramal_activo = '1' $where ", null, "trenramal.trenramal_id desc");

    $option = "<option value=''>-- Seleccione --</option>";

	foreach($arrresultado as $i=>$valor){

		$trenramal_id = utf8_encode($valor["trenramal_id"]);
		$trenramal_nombre = utf8_encode($valor["trenramal_nombre"]);
		
    if ($trenramal_id==$idseleccionado){
      $option .= "<option selected='selected' value='$trenramal_id'>$trenramal_nombre</option>";
    }else{
      $option .= "<option value='$trenramal_id'>$trenramal_nombre</option>";
    }

  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN RAMAL DE TREN</option>";
  }

  return $option;

}

function ObtenerListaTrenEstacion($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and trenestacion.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and trenestacion.cuenta_id = '$_COOKIE[idcuenta]' and trenestacion.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and trenestacion.cuenta_id = '$_COOKIE[idcuenta]' and trenestacion.compania_id = '$_COOKIE[idcompania]' ";

  } 

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("

	trenestacion.trenestacion_id, trenestacion.trenlinea_id, 
	trenestacion.trenestacion_nombre, trenestacion.trenestacion_img, trenestacion.l_estatus_id, 
	trenestacion.cuenta_id, trenestacion.compania_id, trenestacion.trenestacion_activo, 
	trenestacion.trenestacion_eliminado, trenestacion_observ,
	DATE_FORMAT(trenestacion.trenestacion_fechareg,'%d/%m/%Y %H:%i:%s') as trenestacion_fechareg,
	trenlinea.trenservicio_id, trenlinea.trenlinea_orden, 
	trenlinea.trenlinea_nombre, trenlinea.trenlinea_mapa, trenlinea.trenlinea_img, 
	trenlinea.cuenta_id, trenlinea.compania_id, 
	trenlinea.trenlinea_activo, trenlinea.trenlinea_eliminado, 
	DATE_FORMAT(trenlinea.trenlinea_fechareg,'%d/%m/%Y %H:%i:%s') as trenlinea_fechareg,
	trenservicio.trenservicio_orden, trenservicio.trenservicio_nombre,
	trenservicio.trenservicio_img, 
	trenservicio.trenservicio_activo, trenservicio.trenservicio_eliminado, 
	DATE_FORMAT(trenservicio.trenservicio_fechareg,'%d/%m/%Y %H:%i:%s') as trenservicio_fechareg,
	cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
	cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
	estatus.lista_nombre as estatus_nombre
		",
		"
		trenestacion
			inner join trenlinea on trenlinea.trenlinea_id = trenestacion.trenlinea_id
			inner join trenservicio	on trenservicio.trenservicio_id = trenlinea.trenservicio_id	
			inner join lista estatus on estatus.lista_id = trenestacion.l_estatus_id			
			inner join usuario cuenta on cuenta.usuario_id = trenestacion.cuenta_id
		    inner join compania on compania.compania_id = trenestacion.compania_id		      
		",
		"trenestacion_activo = '1' $where ", null, "trenestacion.trenestacion_nombre asc");

    $option = "<option value=''>-- Seleccione --</option>";

	foreach($arrresultado as $i=>$valor){

		$trenestacion_id = utf8_encode($valor["trenestacion_id"]);
		$trenestacion_nombre = utf8_encode($valor["trenestacion_nombre"]);
    $trenestacion_observ = utf8_encode($valor["trenestacion_observ"]);

    if ($trenestacion_observ!=""){
      $trenestacion_nombre .= " ($trenestacion_observ)";
    }
		
    if ($trenestacion_id==$idseleccionado){
      $option .= "<option selected='selected' value='$trenestacion_id'>$trenestacion_nombre</option>";
    }else{
      $option .= "<option value='$trenestacion_id'>$trenestacion_nombre</option>";
    }

  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN ESTACIONES</option>";
  }

  return $option;

}

function ObtenerListaTrenLinea($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and trenlinea.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and trenlinea.cuenta_id = '$_COOKIE[idcuenta]' and trenlinea.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and trenlinea.cuenta_id = '$_COOKIE[idcuenta]' and trenlinea.compania_id = '$_COOKIE[idcompania]' ";

  } 

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("

	trenlinea.trenlinea_id, trenlinea.trenservicio_id, trenlinea.trenlinea_orden, 
	trenlinea.trenlinea_nombre, trenlinea.trenlinea_mapa, trenlinea.trenlinea_img, 
	trenlinea.l_estatus_id, trenlinea.cuenta_id, trenlinea.compania_id, 
	trenlinea.trenlinea_activo, trenlinea.trenlinea_eliminado, 
	DATE_FORMAT(trenlinea.trenlinea_fechareg,'%d/%m/%Y %H:%i:%s') as trenlinea_fechareg,
	trenservicio.trenservicio_orden, trenservicio.trenservicio_nombre,
	trenservicio.trenservicio_img, 
	trenservicio.trenservicio_activo, trenservicio.trenservicio_eliminado, 
	DATE_FORMAT(trenservicio.trenservicio_fechareg,'%d/%m/%Y %H:%i:%s') as trenservicio_fechareg,
	cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
	cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
	estatus.lista_nombre as estatus_nombre
		",
		"
		trenlinea
			inner join trenservicio	on trenservicio.trenservicio_id = trenlinea.trenservicio_id	
			inner join lista estatus on estatus.lista_id = trenlinea.l_estatus_id			
			inner join usuario cuenta on cuenta.usuario_id = trenlinea.cuenta_id
		    inner join compania on compania.compania_id = trenlinea.compania_id		      
		",
		"trenlinea_activo = '1' $where ", null, "trenlinea.trenlinea_orden asc");

    $option = "<option value=''>-- Seleccione --</option>";

	foreach($arrresultado as $i=>$valor){

		$trenlinea_id = utf8_encode($valor["trenlinea_id"]);
		$trenlinea_nombre = utf8_encode($valor["trenlinea_nombre"]);
		
    if ($trenlinea_id==$idseleccionado){
      $option .= "<option selected='selected' value='$trenlinea_id'>$trenlinea_nombre</option>";
    }else{
      $option .= "<option value='$trenlinea_id'>$trenlinea_nombre</option>";
    }

  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN LINEAS DE TREN</option>";
  }

  return $option;

}


function ObtenerListaTrenServicio($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and trenservicio.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and trenservicio.cuenta_id = '$_COOKIE[idcuenta]' and trenservicio.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and trenservicio.cuenta_id = '$_COOKIE[idcuenta]' and trenservicio.compania_id = '$_COOKIE[idcompania]' ";

  } 

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("
	trenservicio.trenservicio_id, trenservicio.trenservicio_orden, trenservicio.trenservicio_nombre,
	trenservicio.trenservicio_img, trenservicio.cuenta_id, trenservicio.compania_id, 
	trenservicio.trenservicio_activo, trenservicio.trenservicio_eliminado, 
	DATE_FORMAT(trenservicio.trenservicio_fechareg,'%d/%m/%Y %H:%i:%s') as trenservicio_fechareg
		",
		"trenservicio						
			inner join usuario cuenta on cuenta.usuario_id = trenservicio.cuenta_id
		    inner join compania on compania.compania_id = trenservicio.compania_id		      
		",
		"trenservicio_activo = '1' $where ", null, "trenservicio.trenservicio_orden asc");

    $option = "<option value=''>-- Seleccione --</option>";

	foreach($arrresultado as $i=>$valor){

		$trenservicio_id = utf8_encode($valor["trenservicio_id"]);
		$trenservicio_orden = utf8_encode($valor["trenservicio_orden"]);
		$trenservicio_nombre = utf8_encode($valor["trenservicio_nombre"]);
		$trenservicio_img = utf8_encode($valor["trenservicio_img"]);
		$trenservicio_activo = utf8_encode($valor["trenservicio_activo"]);
		$trenservicio_fechareg = utf8_encode($valor["trenservicio_fechareg"]);

    if ($trenservicio_id==$idseleccionado){
      $option .= "<option selected='selected' value='$trenservicio_id'>$trenservicio_nombre</option>";
    }else{
      $option .= "<option value='$trenservicio_id'>$trenservicio_nombre</option>";
    }

  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN TREN SERVICIOS</option>";
  }

  return $option;

}


function ListadoJugadasDetalleNumero($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $gettransaccionloteriadet_id=null, $sinfiltrofecha=null, $idget=null, $idgetnumero=null, $getloteriafecha_id=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (transaccion.trans_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($sinfiltrofecha=="1"){
    $wherefecha = "";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' ";

  } else { 

    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' and transaccion.usuario_id = '$_COOKIE[iniuser]' ";

  } 


  
  if($gettransaccionloteriadet_id!=""){
    $wheretransaccion = " and transaccionloteriadetalle.transaccionloteriadet_id = '$gettransaccionloteriadet_id' ";
    $wherefecha = "";
  }

  if($idget!=""){
    $wheretransaccion = " and transaccionloteriadetalle.transaccionloteriadet_id = '$idget' ";
    $wherefecha = "";
  }

  if($idgetnumero!=""){
    $wheretransaccionnumerodet = " and transaccionloteriadetallenumero.transaccionloteriadetnum_id = '$idgetnumero' ";
    $wherefecha = "";
  }


  if($getloteriafecha_id!=""){
    $whereloteriafecha = " and transaccionloteriadetalle.loteriafecha_id = '$getloteriafecha_id' ";
    $wherefecha = "";
  }

  

  if($getestatus!=""){
    $whereestatus = " and transaccion.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    transaccion.trans_id, transaccion.trans_montototal, transaccion.trans_codigo,
    DATE_FORMAT(transaccion.trans_fechareg,'%d/%m/%Y %H:%i:%s') as trans_fechareg,
    estatus.lista_nombre as estatus_nombre,
    estatus.lista_id as estatus_id,
    transaccionloteria.transaccionloteria_cant,			
    cliente.usuario_nombre, cliente.usuario_apellido,
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
    moneda.lista_nombre as moneda_nombre, 
    moneda.lista_nombredos as moneda_siglas,
    transaccionloteriadetalle.transaccionloteriadet_id, transaccionloteriadet_monto,
    transaccionloteriadet_jugadas, transaccionloteriadet_activo,
    loteriatipo.loteriatipo_nombre,

    transaccionloteriadetallenumero.transaccionloteriadet_valor,
    transaccionloteriadetallenumero.transaccionloteriadetnum_orden,
    transaccionloteriadetallenumero.transaccionloteriadetnum_id,
    transaccion.cliente_id, transaccionloteria.transaccionloteria_id

  ",
  "transaccion 
    inner join compania on compania.compania_id = transaccion.compania_id
    inner join usuario cuenta on cuenta.usuario_id = transaccion.cuenta_id
    inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
    inner join transaccionloteria on transaccionloteria.trans_id = transaccion.trans_id
    inner join transaccionloteriadetalle on transaccionloteriadetalle.trans_id = transaccion.trans_id
    inner join transaccionloteriadetallenumero on transaccionloteriadetallenumero.transaccionloteriadet_id = transaccionloteriadetalle.transaccionloteriadet_id
    inner join loteriatipo on loteriatipo.loteriatipo_id = transaccionloteriadetalle.loteriatipo_id

    inner join lista estatus on estatus.lista_id = transaccionloteriadetallenumero.l_estatus_id
    inner join usuario cliente on cliente.usuario_id = transaccion.cliente_id
    inner join lista tipotransaccion on tipotransaccion.lista_id = transaccion.l_tipotrans_id
  ",
  "transaccion.trans_activo = '1' and transaccionloteriadetalle.transaccionloteriadet_eliminado = '0' $where $whereestatus $wherefecha $wheretransaccion $wheretransaccionnumerodet $whereloteriafecha ", null, "transaccionloteria.transaccionloteria_id, transaccionloteriadetallenumero.transaccionloteriadetnum_id asc");
    
  if ($idget!=""){    
    return $arrresultado;
  }

  if ($idgetnumero!=""){    
    return $arrresultado;
  }

  if ($getloteriafecha_id!=""){    
    return $arrresultado;
  }
  

foreach($arrresultado as $i=>$valor){

    $transaccionloteriadet_valor = utf8_encode($valor["transaccionloteriadet_valor"]);
    $transaccionloteriadetnum_orden = utf8_encode($valor["transaccionloteriadetnum_orden"]);

    $transaccionloteriadet_id = utf8_encode($valor["transaccionloteriadet_id"]);
    $transaccionloteriadet_monto = utf8_encode($valor["transaccionloteriadet_monto"]);
    $transaccionloteriadet_jugadas = utf8_encode($valor["transaccionloteriadet_jugadas"]);
    $transaccionloteriadet_activo = utf8_encode($valor["transaccionloteriadet_activo"]);
    $loteriatipo_nombre = utf8_encode($valor["loteriatipo_nombre"]);

    $trans_id = utf8_encode($valor["trans_id"]);
    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $trans_activo = utf8_encode($valor["trans_activo"]);
    $trans_montototal = utf8_encode($valor["trans_montototal"]);
    $trans_codigo = utf8_encode($valor["trans_codigo"]);
    $trans_fechareg = utf8_encode($valor["trans_fechareg"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
    $transaccionloteria_cant = utf8_encode($valor["transaccionloteria_cant"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    
    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    if ($trans_montototal==""){$trans_montototal=0;}

    $trans_montototal  = number_format_personalizado($trans_montototal, $moneda_siglas);

    $transaccionloteriadet_monto  = number_format_personalizado($transaccionloteriadet_monto, $moneda_siglas);

    if ($transaccionloteriadet_activo=="0"){
      $activo = "<i onclick='cambiarestatustransaccionloteriadetalle(\"".$transaccionloteriadet_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatustransaccionloteriadetalle(\"".$transaccionloteriadet_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminartransaccionloteriadetalle(\"".$transaccionloteriadet_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verjugadadetalle?tid=$trans_id&id=$transaccionloteriadet_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $verid = "<a href='verjugadadetalle?tid=$trans_id&id=$transaccionloteriadet_id'>(Ver Detalle por Número)</a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $textohtml .= "
      <tr>
        <td>$transaccionloteriadetnum_id</td>   
        $mostrarcolumnacuenta
        $mostrarcolumnacompania				          
        <td>$transaccionloteriadet_valor</td>
        <td>$transaccionloteriadetnum_orden</td>
        <td>$estatus_nombre</td>
        </tr>
  ";

  }

  return $textohtml;

}

function ListadoJugadasDetalle($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $jugada_id=null, $sinfiltrofecha=null, $idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (transaccion.trans_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($sinfiltrofecha=="1"){
    $wherefecha = "";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' ";

  } else { 

    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' and transaccion.usuario_id = '$_COOKIE[iniuser]' ";

  } 


  
  if($jugada_id!=""){
    $wheretransaccion = " and transaccion.trans_id = '$jugada_id' ";
    $wherefecha = "";
  }

  if($idget!=""){
    $wheretransaccion = " and transaccionloteriadetalle.transaccionloteriadet_id = '$idget' ";
    $wherefecha = "";
  }

  if($getestatus!=""){
    $whereestatus = " and transaccion.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    transaccion.trans_id, transaccion.trans_montototal, transaccion.trans_codigo,
    DATE_FORMAT(transaccion.trans_fechareg,'%d/%m/%Y %H:%i:%s') as trans_fechareg,
    estatus.lista_nombre as estatus_nombre,
    estatus.lista_id as estatus_id,
    transaccionloteria.transaccionloteria_cant,			
    cliente.usuario_nombre, cliente.usuario_apellido,
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
    moneda.lista_nombre as moneda_nombre, 
    moneda.lista_nombredos as moneda_siglas,
    transaccionloteriadet_id, transaccionloteriadet_monto,
    transaccionloteriadet_jugadas, transaccionloteriadet_activo,
    loteriatipo.loteriatipo_nombre,
    loteria_nombre,
    DATE_FORMAT(loteriafecha.loteriafecha_fecha,'%d/%m/%Y %H:%i') as loteriafecha_fecha
  ",
  "transaccion 
    inner join compania on compania.compania_id = transaccion.compania_id
    inner join usuario cuenta on cuenta.usuario_id = transaccion.cuenta_id
    inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
    inner join transaccionloteria on transaccionloteria.trans_id = transaccion.trans_id
    inner join transaccionloteriadetalle on transaccionloteriadetalle.trans_id = transaccion.trans_id
    inner join loteriafecha on loteriafecha.loteriafecha_id = transaccionloteriadetalle.loteriafecha_id
    inner join loteria on loteria.loteria_id = transaccionloteriadetalle.loteria_id
    inner join loteriatipo on loteriatipo.loteriatipo_id = transaccionloteriadetalle.loteriatipo_id

    inner join lista estatus on estatus.lista_id = transaccionloteriadetalle.estatus_id
    inner join usuario cliente on cliente.usuario_id = transaccion.cliente_id
    inner join lista tipotransaccion on tipotransaccion.lista_id = transaccion.l_tipotrans_id
  ",
  "transaccion.trans_activo = '1' and transaccionloteriadetalle.transaccionloteriadet_eliminado = '0' $where $whereestatus $wherefecha $wheretransaccion  ", null, "transaccionloteriadetalle.transaccionloteriadet_id asc");
    
  if ($idget!=""){    
    return $arrresultado;
  }

foreach($arrresultado as $i=>$valor){

    $loteria_nombre = utf8_encode($valor["loteria_nombre"]);
    $transaccionloteriadet_id = utf8_encode($valor["transaccionloteriadet_id"]);
    $transaccionloteriadet_monto = utf8_encode($valor["transaccionloteriadet_monto"]);
    $transaccionloteriadet_jugadas = utf8_encode($valor["transaccionloteriadet_jugadas"]);
    $transaccionloteriadet_activo = utf8_encode($valor["transaccionloteriadet_activo"]);
    $loteriatipo_nombre = utf8_encode($valor["loteriatipo_nombre"]);
    $loteriafecha_fecha = utf8_encode($valor["loteriafecha_fecha"]);
    

    $trans_id = utf8_encode($valor["trans_id"]);
    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $trans_activo = utf8_encode($valor["trans_activo"]);
    $trans_montototal = utf8_encode($valor["trans_montototal"]);
    $trans_codigo = utf8_encode($valor["trans_codigo"]);
    $trans_fechareg = utf8_encode($valor["trans_fechareg"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
    $transaccionloteria_cant = utf8_encode($valor["transaccionloteria_cant"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    
    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    if ($trans_montototal==""){$trans_montototal=0;}

    $trans_montototal  = number_format_personalizado($trans_montototal, $moneda_siglas);

    $transaccionloteriadet_monto  = number_format_personalizado($transaccionloteriadet_monto, $moneda_siglas);

    if ($transaccionloteriadet_activo=="0"){
      $activo = "<i onclick='cambiarestatustransaccionloteriadetalle(\"".$transaccionloteriadet_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatustransaccionloteriadetalle(\"".$transaccionloteriadet_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminartransaccionloteriadetalle(\"".$transaccionloteriadet_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verjugadadetalle?tid=$trans_id&id=$transaccionloteriadet_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $verid = "<a href='verjugadadetalle?tid=$trans_id&id=$transaccionloteriadet_id'>(Ver Detalle por Número)</a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $textohtml .= "
      <tr>
        <td>$transaccionloteriadet_id</td>   
        $mostrarcolumnacuenta
        $mostrarcolumnacompania				         
        <td>$loteria_nombre</td>
        <td>$loteriafecha_fecha</td> 
        <td>$transaccionloteriadet_jugadas</td>
        <td>$loteriatipo_nombre</td>
        <td>$transaccionloteriadet_monto</td>
        <td>$estatus_nombre</td>
        <td>$verid</td>
        <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
        </tr>
  ";

  }

  return $textohtml;

}

function ListadoJugadas($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $idget=null, $sinfiltrofecha=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (transaccion.trans_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($sinfiltrofecha=="1"){
    $wherefecha = "";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' ";

  } else { 

    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' and transaccion.usuario_id = '$_COOKIE[iniuser]' ";

  } 


  if($idget!=""){
    $wheretransaccion = " and transaccion.trans_id = '$idget' ";
    $wherefecha = "";
  }

  if($getestatus!=""){
    $whereestatus = " and transaccion.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    transaccion.trans_id, transaccion.trans_montototal, transaccion.trans_codigo,
    DATE_FORMAT(transaccion.trans_fechareg,'%d/%m/%Y %H:%i:%s') as trans_fechareg,
    estatus.lista_nombre as estatus_nombre,
    estatus.lista_id as estatus_id,
    transaccionloteria.transaccionloteria_cant,			
    cliente.usuario_nombre, cliente.usuario_apellido,
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
    moneda.lista_nombre as moneda_nombre, 
    moneda.lista_nombredos as moneda_siglas,
    transaccionloteriagan_monto, transaccionloteriagan_id
  ",
  "transaccion 
    inner join compania on compania.compania_id = transaccion.compania_id
    inner join usuario cuenta on cuenta.usuario_id = transaccion.cuenta_id
    inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
    inner join transaccionloteria on transaccionloteria.trans_id = transaccion.trans_id
    inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id
    inner join usuario cliente on cliente.usuario_id = transaccion.cliente_id
    inner join lista tipotransaccion on tipotransaccion.lista_id = transaccion.l_tipotrans_id

    left join transaccionloteriaganancia on transaccionloteriaganancia.transaccionloteria_id = transaccionloteria.transaccionloteria_id and transaccionloteriagan_activo = '1'

  ",
  "transaccion.trans_activo = '1' $where $whereestatus $wherefecha $wheretransaccion  ", null, "transaccion.trans_fechareg desc");
    
  if ($idget!=""){    
    return $arrresultado;
  }

foreach($arrresultado as $i=>$valor){

    $transaccionloteriagan_id = utf8_encode($valor["transaccionloteriagan_id"]);
    $transaccionloteriagan_monto = utf8_encode($valor["transaccionloteriagan_monto"]);
    $trans_id = utf8_encode($valor["trans_id"]);
    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $trans_activo = utf8_encode($valor["trans_activo"]);
    $trans_montototal = utf8_encode($valor["trans_montototal"]);
    $trans_codigo = utf8_encode($valor["trans_codigo"]);
    $trans_fechareg = utf8_encode($valor["trans_fechareg"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
    $transaccionloteria_cant = utf8_encode($valor["transaccionloteria_cant"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    
    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    if ($trans_montototal==""){$trans_montototal=0;}

    $trans_montototal  = number_format_personalizado($trans_montototal, $moneda_siglas);
    $transaccionloteriagan_monto  = number_format_personalizado($transaccionloteriagan_monto, $moneda_siglas);

    if ($transaccionloteriagan_id==""){
      $transaccionloteriagan_monto = "";
    }
    

    if ($trans_activo=="0"){
      $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminartransaccion(\"".$trans_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verjugada?id=$trans_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $verid = "<a href='verjugada?id=$trans_id'>#$trans_codigo (Ver Jugada)</a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $textohtml .= "
      <tr>
        <td>$trans_id</td>   
        $mostrarcolumnacuenta
        $mostrarcolumnacompania				          
        <td>$verid</td>
        <td>$usuario</td>
        <td>$transaccionloteria_cant</td>
        <td>$trans_montototal</td>
        <td>$transaccionloteriagan_monto</td>
        <td>$estatus_nombre</td>
        <td>$trans_fechareg</td>
        <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
        </tr>
  ";

  }

  return $textohtml;

}

function ObtenerUrlPaises($companiaseleccionada=null){

  $conexion = new ConexionBd();  
  /* 
  $url = "https://www.gestiongo.com/adminapp/arch"; 
  
  if ($companiaseleccionada=="374"){// Juega tu Loteria
    $url = "https://www.juegatuloteria.com/admsyslot/arch"; 
  }else if ($companiaseleccionada=="380"){// Moto Taxi Bolivia
    $url = "https://www.mototaxibolivia.com/adminsys/arch"; 
  }else if ($companiaseleccionada=="381"){// App Gestion
    $url = "http://localhostwww.gestiongo.com/appgestion/arch"; 
  } */

  $url = "https://www.gestiongo.com/appremesas/dist/img/pais/"; 

  return $url;

}


function ObtenerUrlArch($companiaseleccionada=null, $tipo=null){

  $conexion = new ConexionBd();  
  
  $url = "https://www.gestiongo.com/admin/arch"; 
  
  if ($companiaseleccionada=="374"){// Juega tu Loteria
    $url = "https://www.juegatuloteria.com/admsyslot/arch"; 
  }else if ($companiaseleccionada=="380"){// Moto Taxi Bolivia
    $url = "https://www.gestiongo.com/admin/arch"; 
  }else if ($companiaseleccionada=="381"){// App Gestion
    $url = "https://www.gestiongo.com/admin/arch"; 
  }else if ($companiaseleccionada=="381"){// App Gestion

    $url = "https://www.gestiongo.com/admin/arch"; 
    if ($tipo=="2"){// Hotel
      $url = "https://www.gestiongo.com/admin/arch"; 
    }else if ($tipo=="3"){// asvicaj
      $url = "https://www.asvicaj.com/adsysm/arch"; 
    }    
  }else if ($companiaseleccionada=="382"){// 
    $url = "https://www.gestiongo.com/admin/arch"; 
  }
  else if ($companiaseleccionada=="10"){// Demo
    $url = "https://www.gestiongo.com/admin/arch"; 
  }
  else if ($companiaseleccionada=="387"){// Demo
    $url = "https://www.agrocomercioec.com/admin/arch"; 
  }
  else if ($companiaseleccionada=="444"){// Indproyect
    $url = "https://www.gestiongo.com/admin/arch"; 
  }
  else if ($companiaseleccionada=="451"){// Pacenos Driver
    $url = "https://www.gestiongo.com/admin/arch"; 
  }
  else if ($companiaseleccionada=="452"){// Medicos
    $url = "https://www.medfyndhconecth.com/admin/arch"; 
  }
  else if ($companiaseleccionada=="453"){// IQ testing
    $url = "https://www.iqnetingapps.com/admin/arch"; 
  }
  else if ($companiaseleccionada=="454"){// Taxi Durango
    $url = "https://www.taxidurango.app/admin/arch"; 
  }
  else if ($companiaseleccionada=="457"){// Sateli Taxi
    $url = "https://www.satelitaxi.com/admin/arch"; 
  }
  else if ($companiaseleccionada=="458"){// corsepsa.com
    $url = "https://www.corsepsa.com/admin/arch"; 
  }
  else if ($companiaseleccionada=="459"){// Reina Roja
    $url = "https://www.appreinaroja.com/admin/arch"; 
  }
  else if ($companiaseleccionada=="460"){ // 99 Place
    $url = "https://www.99placeapp.com/admin/arch"; 
  }
  else if ($companiaseleccionada=="462"){ // Amigo Market
    $url = "https://www.amigomarket.com.mx/admin/arch"; 
  }
  else if ($companiaseleccionada=="464"){ // Bufalo Soap
    $url = "https://www.gestiongo.com/admin/arch";
  }
  else if ($companiaseleccionada=="465"){ // PymeGo
    $url = "https://www.gestiongo.com/admin/arch";
  }
  else if ($companiaseleccionada=="466"){ // VT Panico
    $url = "https://www.gestiongo.com/admin/arch";
  }
  
  return $url;

}

function ObtenerUrlArchMotoTaxiBolivia($companiaseleccionada=null){

  $url = "https://www.mototaxibolivia.com/adminsys/arch"; 
  return $url;

}

function ObtenerMonedaPrincipalIdTaxi($cuentaseleccionada=null, $companiaseleccionada=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    $where = " and listaconfig.cuenta_id = '$cuentaseleccionada'";
  } else {
    $where = " and listaconfig.cuenta_id = '$cuentaseleccionada' and listaconfig.compania_id = '$companiaseleccionada' ";
  }

  
    
  $arrresultado = $conexion->doSelect("listaconfig_valoruno",
    "
    listaconfig
    ",
    "listaconfig_activo = '1' and tipolista_id = '257' $where");
      
  foreach($arrresultado as $i=>$valor){

    $listaconfig_valoruno = utf8_encode($valor["listaconfig_valoruno"]);  

    if ($listaconfig_valoruno!=""){
      $lista_id = $listaconfig_valoruno;
    }
  }

  if ($lista_id==""){
    $lista_id = "0";
  }

  

  return $lista_id;

}

function ListadoPagoUsuariosDepositos($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$cuentaseleccionada' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and pago.cuenta_id = '$cuentaseleccionada' and pago.compania_id = '$companiaseleccionada'";

}  else if ($_COOKIE[perfil]=="7"){ // Empleados 
      
  $columnacompania = "<th>Compañia</th>";
  $where = " and pago.cuenta_id = '$cuentaseleccionada' and pago.compania_id = '$companiaseleccionada'";

} else { 

    $where = " and pago.cuenta_id = '$cuentaseleccionada' and pago.compania_id = '$companiaseleccionada' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,
    pago.l_estatus_id, 

    estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb, 
    formapago.lista_nombre as formapago_nombre,
    pago_codexterno, pago.modulo_id, pago.elemento_id,
    modulo_nombreunico, tipopago.lista_cod as tipopago_cod,
    pago_codint

    ",
    "pago      
    left join lista moneda on moneda.lista_id = pago.l_moneda_id      
      left join usuario on usuario.usuario_id = pago.usuario_id
      left join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      left join compania on compania.compania_id = pago.compania_id
      left join lista estatus on estatus.lista_id = pago.l_estatus_id
      left join lista formapago on formapago.lista_id = pago.l_formapago_id
      left join lista tipopago on tipopago.lista_id = pago.l_tipopago_id
      left join modulo on modulo.modulo_id = pago.modulo_id
      

    ",
    "pago_eliminado = '0'   $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 
//and tipopago.lista_cod = '1'
  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $tipopago_cod = utf8_encode($valor["tipopago_cod"]);
    $pago_codint = utf8_encode($valor["pago_codint"]);
    

    $modulo_id = utf8_encode($valor["modulo_id"]);
    $modulo_nombreunico = utf8_encode($valor["modulo_nombreunico"]);
    $elemento_id = utf8_encode($valor["elemento_id"]);
    $pago_codexterno = utf8_encode($valor["pago_codexterno"]);

    $formapago_nombre = utf8_encode($valor["formapago_nombre"]);

    $trans_codigo = utf8_encode($valor["trans_codigo"]);
    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);

    $pagotrans_id = utf8_encode($valor["pagotrans_id"]);      
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]); 
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);


    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $moneda_siglas);

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $urlir = "";
    $verid = "";

    $urlir = "verpagodeposito?id=$pago_id";
    $verid = "<a href='$urlir'>#$pago_codint (Ver Depósito)</a>";
    $modulo_nombreunico = "Depósito";

    $modificar = "<a href='$urlir'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    
    //             <td>$modulo_nombreunico</td>            


    $textohtml .= "
          <tr>               
            <td>$pago_id</td>  
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>   
            <td>$usuario</td>                 
            <td>$pago_monto</td>    
            <td>$formapago_nombre</td>   
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}

function AgrupaIngredientesRequisicion($trans_id=null){

  $conexion = new ConexionBd();  

  $arrresultado = $conexion->doSelect("sum(prodagrup_cantidad) as cantidad, 
  productoagrupado.l_tipounidad_id, prod_idagrupado, transaccionrequisicion.transreq_id
	",
		"transaccion    
			inner join lista tipotransaccion on tipotransaccion.lista_id = transaccion.l_tipotrans_id
			inner join usuario cuenta on cuenta.usuario_id = transaccion.cuenta_id
			inner join compania on compania.compania_id = transaccion.compania_id 
			inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id 
			inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
			inner join transaccionrequisicion on transaccion.trans_id = transaccionrequisicion.trans_id
			

      inner join transacciondetalle on transacciondetalle.trans_id = transaccion.trans_id and transacciondetalle.transdet_activo = '1'
      inner join producto on producto.prod_id = transacciondetalle.prod_id
      inner join productoagrupado on productoagrupado.prod_idoriginal = producto.prod_id and prodagrup_activo = '1'
		",
		"trans_eliminado = '0' and tipotransaccion.lista_cod = '13' and transaccion.trans_id = '$trans_id'", "productoagrupado.l_tipounidad_id, prod_idagrupado, transaccionrequisicion.transreq_id");


  foreach($arrresultado as $i=>$valor){

    $cantidad = utf8_encode($valor["cantidad"]);
    $l_tipounidad_id = utf8_encode($valor["l_tipounidad_id"]);
    $prod_idagrupado = utf8_encode($valor["prod_idagrupado"]);
    $transreq_id = utf8_encode($valor["transreq_id"]);

    $resultado = $conexion->doInsert("
    transaccionrequisicionagrupado
      (transreq_id, trans_id, prod_id, l_tipounidad_id, transreqagrup_cantidad,
      transreqagrup_activo, transreqagrup_eliminado)
      ",
      "'$transreq_id', '$trans_id', '$prod_idagrupado', '$l_tipounidad_id', '$cantidad', 
      '1','0'");

  }  

  return true;

}


function AsignarProveedorRequisicion($trans_id=null, $transreq_id=null){

  $conexion = new ConexionBd();  

  $instanciatransaccionventas = new TransaccionVenta();
  $arrresultado = $instanciatransaccionventas->ListadoRequisicionesDetalle($trans_id);

  foreach($arrresultado as $i=>$valor){

    $prod_id = utf8_encode($valor["prod_id"]);
    $transdet_id = utf8_encode($valor["transdet_id"]);
    
    $usuario_id = 0;

    // Busco minimo precio
    $arrresultado = $conexion->doSelect("min(productoprecio.prodprecio_monto) as preciomin,
    usuario_id
    ",
       "producto
         inner join productoprecio on productoprecio.prod_id = producto.prod_id and prodprecio_activo = '1'       
       ",
       "prod_activo = '1' and producto.prod_id = '$prod_id' ");

    foreach($arrresultado2 as $n=>$valorn){
      $usuario_id = utf8_encode($valorn["usuario_id"]); // Proveedor a asignar
      $preciomin = utf8_encode($valorn["preciomin"]); 
    }

    $resultado = $conexion->doInsert("
      transaccionrequisiciondetalle
        (transreq_id, trans_id, transdet_id, u_proveedor_id, transreqdet_precio,
        transreqdet_activo, transreqdet_eliminado)
        ",
        "'$transreq_id', '$trans_id', '$transdet_id', '$usuario_id', '$preciomin', 
        '1','0'");

  }  

  return true;

}

function ObtenerListaProductosUsuario($cuentaseleccionada=null, $companiaseleccionada=null, $usuario_id=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

      
     $arrresultado = $conexion->doSelect("producto.prod_id, producto.prod_nombre,
     usuarioproducto.usuarioprod_id 
     ",
        "producto
          inner join lista tipoproducto on tipoproducto.lista_id = producto.l_tipoproducto_id
          left join usuarioproducto on usuarioproducto.prod_id = producto.prod_id
          and prod_activo = '1' and usuarioproducto.usuario_id = '$usuario_id'
        ",
        "prod_activo = '1' and tipoproducto.lista_cod = '1' and producto.cuenta_id = '$cuentaseleccionada' and producto.compania_id = '$companiaseleccionada' ", null, "producto.prod_nombre asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

          $prod_id = utf8_encode($valor["prod_id"]);
          $prod_nombre = utf8_encode($valor["prod_nombre"]);
          $usuarioprod_id = utf8_encode($valor["usuarioprod_id"]);


        if($usuarioprod_id != ""){
          $option .= "<option selected='selected' value='$prod_id'>$prod_nombre</option>";
        }else{
           $option .= "<option value='$prod_id'>$prod_nombre</option>";
         }

      }

       if (count($arrresultado)==0){
         $option = "<option  value=''>NO EXISTEN ARTICULOS CREADOS</option>";
       }

  }
  
  return $option;

}

function ObtenerListaCategoriasUsuario($cuentaseleccionada=null, $companiaseleccionada=null, $usuario_id=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

      
     $arrresultado = $conexion->doSelect("lista.lista_id, lista.lista_nombre,
     usuariocategoria.usuariocateg_id
     ",
        "lista
          left join usuariocategoria on usuariocategoria.l_categ_id = lista.lista_id
          and usuariocateg_activo = '1' and usuario_id = '$usuario_id'
        ",
        "lista_activo = '1' and lista.tipolista_id = '39' and lista.cuenta_id = '$cuentaseleccionada' and lista.compania_id = '$companiaseleccionada' ", null, "lista_nombre asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

          $lista_id = utf8_encode($valor["lista_id"]);
          $lista_nombre = utf8_encode($valor["lista_nombre"]);
          $usuariocateg_id = utf8_encode($valor["usuariocateg_id"]);


        if($usuariocateg_id != ""){
          $option .= "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
        }else{
           $option .= "<option value='$lista_id'>$lista_nombre</option>";
         }

      }

       if (count($arrresultado)==0){
         $option = "<option  value=''>NO EXISTEN CATEGORIAS CREADAS</option>";
       }

  }
  
  return $option;

}

function calcularminutosdistancia($distanciametros=null){

  $minutospormetro = 0.0020;
  $tiempo = $distanciametros * $minutospormetro;
  $tiempo = round($tiempo, 0);
  /*
  if ($tiempo>200){
    $tiempo=0;
  }
  */
  
  return $tiempo;
}

function distance2($lat1, $lon1, $lat2, $lon2, $unit, $incluirsiglas=null) {
  
  $theta = $lon1 - $lon2;
		$dist = sin(deg2rad($lat1)) * sin(deg2rad($lat2)) +  cos(deg2rad($lat1)) * cos(deg2rad($lat2)) * cos(deg2rad($theta));
		$dist = acos($dist);
		$dist = rad2deg($dist);
		$miles = $dist * 60 * 1.1515;
		$unit = strtoupper($unit);
		$km = 0;


		if ($unit == "K") {
			$km = $miles * 1.609344;
			$km = $km * 1000;
			$km = round($km, 1);
		
			if ($km>=1000){
				$km = round(($km/1000),1);
				if ($incluirsiglas==1){
				$km = $km." Km";
				}
			}else{
				$km = round(($km),0);
				if ($incluirsiglas==1){
				$km = $km." metros";
				}
			}
		
			return ($km);
		}
	
		if ($unit == "M") {
			$km = $miles * 1.609344;
			$metros = $km * 1000; // Aqui pase a metro
			$metros = round(($metros),2);

			if ($incluirsiglas==1){
				$metros = $metros." metros";
			}

			return ($metros);

			//$distancia = $metros;
			/*

			if ($metros>=1000){
				$km = round(($metros/1000),1);
				if ($incluirsiglas==1){
					$km = $km." Km";
				}
				$distancia = $km;
			}else{
				if ($incluirsiglas==1){
					$metros = $metros." metros";
				}

				$distancia = $metros;
			}
		
			//echo "distancia:$distancia";
			//exit();
			*/
		

			return ($km);
		} 



}

function distance($lat1, $lon1, $lat2, $lon2, $unit) {
 
  $theta = $lon1 - $lon2;
  $dist = sin(deg2rad($lat1)) * sin(deg2rad($lat2)) +  cos(deg2rad($lat1)) * cos(deg2rad($lat2)) * cos(deg2rad($theta));
  $dist = acos($dist);
  $dist = rad2deg($dist);
  $miles = $dist * 60 * 1.1515;
  $unit = strtoupper($unit);
  $km = 0;
  if ($unit == "K") {
	$km = $miles * 1.609344;
	$km = $km * 1000;
	$km = round($km, 1);

	if ($km>=1000){
		$km = round(($km/1000),1)." Km";
	}else{
		$km = "$km metros";
	}

    return ($km);
  } else if ($unit == "N") {
      return ($miles * 0.8684);
    } else {
        return $miles;
      }
}

function formatearDistancia($distancia=null){

  $distancia = round($distancia,0);    
  $distanciaFormateo ="";
  if ($distancia>1000){
      $distanciaFormateo =  round(($distancia / 1000),1)." km";
  }else{
      $distanciaFormateo = round(($distancia),0)." m";
  }

  return $distanciaFormateo;
  
}

function ObtenerDiaSemanaTarifaTaxi($cuentaseleccionada=null, $companiaseleccionada=null, $tarifa_id=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and loteria.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and loteria.cuenta_id = '$_COOKIE[idcuenta]' and loteria.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and loteria.cuenta_id = '$_COOKIE[idcuenta]' and loteria.compania_id = '$_COOKIE[idcompania]' ";

  } 

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("
    diasemana.diasemana_id, diasemana.diasemana_nombre, tarifataxidia_id
		",
		"diasemana									    
        left join tarifataxidia on tarifataxidia.diasemana_id = diasemana.diasemana_id and tarifataxidia.tarifa_id = '$tarifa_id' and tarifataxidia_activo = '1' 
		",
		"diasemana_activo = '1' $whereEEEEEEEEE ", null, "diasemana_orden asc");

	foreach($arrresultado as $i=>$valor){

		$tarifataxidia_id = utf8_encode($valor["tarifataxidia_id"]);
		$diasemana_id = utf8_encode($valor["diasemana_id"]);
    $diasemana_nombre = utf8_encode($valor["diasemana_nombre"]);

      if ($tarifataxidia_id!=""){
        $option .= "<option selected='selected' value='$diasemana_id'>$diasemana_nombre</option>";
      }else{
        $option .= "<option value='$diasemana_id'>$diasemana_nombre</option>";
      }
  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN DIAS</option>";
  }

  return $option;

}

/** 
 * Get hearder Authorization
 * */
function getAuthorizationHeader(){
  $headers = null;
  if (isset($_SERVER['Authorization'])) {
      $headers = trim($_SERVER["Authorization"]);
  }
  else if (isset($_SERVER['HTTP_AUTHORIZATION'])) { //Nginx or fast CGI
      $headers = trim($_SERVER["HTTP_AUTHORIZATION"]);
  } elseif (function_exists('apache_request_headers')) {
      $requestHeaders = apache_request_headers();
      // Server-side fix for bug in old Android versions (a nice side-effect of this fix means we don't care about capitalization for Authorization)
      $requestHeaders = array_combine(array_map('ucwords', array_keys($requestHeaders)), array_values($requestHeaders));
      //print_r($requestHeaders);
      if (isset($requestHeaders['Authorization'])) {
          $headers = trim($requestHeaders['Authorization']);
      }
  }
  return $headers;
}
/**
* get access token from header
* */
function getBearerToken() {
  $headers = getAuthorizationHeader();
  // HEADER: Get the access token from the header
  if (!empty($headers)) {
    if (preg_match('/Bearer\s(\S+)/', $headers, $matches)) {
        return $matches[1];
    }
  }
return null;
}

function ObtenerLoteriaTipo($cuentaseleccionada=null, $companiaseleccionada=null, $loteria_id=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and loteriatipo.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and loteriatipo.cuenta_id = '$_COOKIE[idcuenta]' and loteriatipo.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and loteriatipo.cuenta_id = '$_COOKIE[idcuenta]' and loteriatipo.compania_id = '$_COOKIE[idcompania]' ";

  } 

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("
		loteriatipo.loteriatipo_id, loteriatipo.loteriatipo_nombre, loteriatipo.loteriatipo_min, 
		loteriatipo.loteriatipo_max, loteriatipo.loteriatipo_orden, 
		loteriatipo.loteriatipo_fechareg, loteriatipo.loteriatipo_activo, 
		loteriatipo.loteriatipo_eliminado, loteriatipo.cuenta_id, 
		loteriatipo.compania_id,
		cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
		cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
    loteriatiporel.loteriatiporel_id
		",
		"loteriatipo						
			  inner join usuario cuenta on cuenta.usuario_id = loteriatipo.cuenta_id
		    inner join compania on compania.compania_id = loteriatipo.compania_id		
        left join loteriatiporel on loteriatiporel.loteriatipo_id = loteriatipo.loteriatipo_id and loteriatiporel.loteria_id = '$loteria_id' and loteriatiporel_activo = '1'
        
		",
		"loteriatipo_eliminado = '0' $where ", null, "loteriatipo.loteriatipo_nombre asc");
	foreach($arrresultado as $i=>$valor){

		$loteriatipo_id = utf8_encode($valor["loteriatipo_id"]);
		$loteriatipo_nombre = utf8_encode($valor["loteriatipo_nombre"]);
    $loteriatiporel_id = utf8_encode($valor["loteriatiporel_id"]);

    if ($loteriatiporel_id!=""){
      $option .= "<option selected='selected' value='$loteriatipo_id'>$loteriatipo_nombre</option>";
    }else{
      $option .= "<option value='$loteriatipo_id'>$loteriatipo_nombre</option>";
    }

  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN TIPOS</option>";
  }

  return $option;

}

function ObtenerLoteriaFecha($cuentaseleccionada=null, $companiaseleccionada=null, $loteriaget_id=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and loteria.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and loteria.cuenta_id = '$_COOKIE[idcuenta]' and loteria.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and loteria.cuenta_id = '$_COOKIE[idcuenta]' and loteria.compania_id = '$_COOKIE[idcompania]' ";

  } 

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("
		loteria.loteria_id, loteria.loteria_nombre, loteria.loteria_img, loteria.loteria_fechareg,
		loteria.loteria_activo, loteria.loteria_eliminado, 
		loteria.cuenta_id, loteria.compania_id,
		cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
		cuenta.usuario_apellido as cuenta_apellido, compania_nombre    
		",
		"loteria						
			  inner join usuario cuenta on cuenta.usuario_id = loteria.cuenta_id
		    inner join compania on compania.compania_id = loteria.compania_id		  
		",
		"loteria_eliminado = '0' $where ", null, "loteria_id desc");

	foreach($arrresultado as $i=>$valor){

		$loteria_id = utf8_encode($valor["loteria_id"]);
		$loteria_nombre = utf8_encode($valor["loteria_nombre"]);
    $loteriafecha_id = utf8_encode($valor["loteriafecha_id"]);

      if ($loteria_id==$loteriaget_id){
        $option .= "<option selected='selected' value='$loteria_id'>$loteria_nombre</option>";
      }else{
        $option .= "<option value='$loteria_id'>$loteria_nombre</option>";
      }
  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN LOTERIAS</option>";
  }

  return $option;

}

function generarPdfCarnet($getusuario_id, $getcompania_id){

  $conexion = new ConexionBd();   

  $arrresultado = $conexion->doSelect("cliente.usuario_id, cliente.usuario_codigo, cliente.usuario_email, cliente.usuario_clave, 
      cliente.usuario_nombre, cliente.usuario_apellido, cliente.usuario_telf,  cliente.usuario_activo, 
      cliente.usuario_eliminado, cliente.usuario_documento, cliente.usuario_img, cliente.perfil_id,	   
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, cliente.usuario_img,
      compania_nombre, compania_img,
      usuarioclub_id, usuarioclub_qr,
      DATE_FORMAT(cliente.usuario_fechanac,'%d/%m/%Y') as usuario_fechanac
    ",
		"usuario cliente
			inner join usuario cuenta on cliente.cuenta_id = cuenta.usuario_id
      
      inner join perfil on perfil.perfil_id = cliente.perfil_id	
      inner join usuarioclub on usuarioclub.usuario_id = usuarioclub.usuario_id 
            and usuarioclub.compania_id = usuarioclub.compania_id and usuarioclub_activo = '1'

      inner join compania on compania.compania_id = usuarioclub.compania_id
			    	
		",
		"cliente.usuario_eliminado = '0' and usuarioclub_activo = '1'  and compania.compania_eliminado = '0' and (perfil.perfil_id = '4' or perfil.perfil_idorig = '4') and cliente.usuario_id = '$getusuario_id' and usuarioclub.compania_id = '$getcompania_id'");
	foreach($arrresultado as $i=>$valor){

    $usuario_img = utf8_encode($valor["usuario_img"]);	
    $usuario_fechanac = utf8_encode($valor["usuario_fechanac"]);	
		$usuarioclub_qr = utf8_encode($valor["usuarioclub_qr"]);	
    $usuarioclub_id = utf8_encode($valor["usuarioclub_id"]);	
		$usuariocompania_fechareg = utf8_encode($valor["usuariocompania_fechareg"]);    

		$compania_id = utf8_encode($valor["compania_id"]);
    $compania_img = utf8_encode($valor["compania_img"]);

		$cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
		$cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
		$cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
		$cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

		$usuario_id = utf8_encode($valor["usuario_id"]);
		$usuario_codigo = utf8_encode($valor["usuario_codigo"]);
		$usuario_email = utf8_encode($valor["usuario_email"]);
		$usuario_clave = utf8_encode($valor["usuario_clave"]);
		$usuario_nombre = utf8_encode($valor["usuario_nombre"]);
		$usuario_apellido = utf8_encode($valor["usuario_apellido"]);
		$usuario_telf = utf8_encode($valor["usuario_telf"]);
		$usuario_fechareg = utf8_encode($valor["usuario_fechareg"]);
		$usuario_activo = utf8_encode($valor["usuario_activo"]);
		$usuario_documento = utf8_encode($valor["usuario_documento"]);	
		$t_perfil_id = utf8_encode($valor["perfil_id"]);		
	  
	  $compania_nombre = utf8_encode($valor["compania_nombre"]);
	}

  if ($usuario_documento!=""){
    $divusuario_documento = "<br>DNI: $usuario_documento";
  }

  if ($usuario_fechanac!=""){
    $divusuario_fechanac = "<br>Fecha Nac: $usuario_fechanac";
  }
    
    //HTMLCarnet
    $htmlpdf = "
      <body style='font-family: sans-serif; font-size: 12px; '>           
        <div id='div_inicio' class='rounder'  style='display: ; font-family:'Times New Roman',Georgia,Serif; background: white; margin: auto auto auto auto '>
            <br>
            <div class='containerpanel'  style='margin-left: 0px; margin-top: 0px;  width: 250px; height: 200px; border: 1px solid #D5D5D5; overflow: hidden;'>    
                <div style='border: 0px solid red; margin: 0px
                 0px 10px 0px; '>
                    <div class='backcarnet' style='width:100%; height: 100px; color: #FFF; text-align: center; padding-top: 5px; font-size: 10px; font-weight: bold; overflow: hidden;'>
                        <table style='text-align: center; border-collapse: collapse; margin-top: 20px '>
                            <tr>    
                                <td style='text-align: center; font-weight: bold; font-size: 13px; width: 30px'>                             
                                </td>                                     
                                <td style='text-align: center; font-weight: bold; font-size: 13px; width: 180px'> 
                                    <div>
                                      <div >
                                        <img src='arch/$usuario_img' style='width: 50px'>                                  
                                      </div>
                                    </div>                                   
                                </td>                 
                                <td style='text-align: center; font-weight: bold; font-size: 13px; width: 20px'>                             
                                </td> 
                            </tr>                                                                  
                        </table>
                        <table style='text-align: center; border-collapse: collapse; margin-top:10px '>                         
                            <tr>    
                                <td style='text-align: center; font-weight: bold; font-size: 13px; width: 30px'>                             
                                </td>                                     
                                <td style='text-align: center; font-weight: bold; font-size: 13px; width: 180px'> 
                                    <div>
                                      <div >
                                        $usuario_nombre $usuario_apellido                                        
                                        $divusuario_documento
                                        $divusuario_fechanac                                        
                                      </div>
                                    </div>                                   
                                </td>                 
                                <td style='text-align: center; font-weight: bold; font-size: 13px; width: 20px'>                             
                                </td> 
                            </tr>                                               
                        </table>
                        <table style='text-align: center; border-collapse: collapse; margin-top: 0px '>                          
                            <tr>    
                                <td style='text-align: center; font-weight: bold; font-size: 13px; width: 50px'>                                                                   
                                </td>                                     
                                <td style='text-align: center; font-weight: bold; font-size: 13px; width: 30px'>                                  
                                  <div>
                                    <div >
                                      <img src='arch/$compania_img' style='width: 50px'>                                  
                                    </div>
                                  </div> 
                                </td>  
                                <td style='text-align: center; font-weight: bold; font-size: 13px; width: 20px'>                             
                                </td>                                    
                                <td style='text-align: center; font-weight: bold; font-size: 13px; width: 100px'> 
                                    <div>
                                      <div >
                                      <br>
                                        <img src='arch/$usuarioclub_qr' style='width: 80px'>                                  
                                      </div>
                                    </div>                                   
                                </td>                 
                                
                            </tr>                                              
                        </table>
                    </div>
                </div>
            </div>                  
        </div>
      </body> 
    ";
  
  return $htmlpdf;

}

function resumenClientes(){

  $modulo_url = "cliente";

  $conexion = new ConexionBd();   
  
  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    $where = "";
  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta	
      $where = " and cliente.cuenta_id = '$_COOKIE[idcuenta]' ";

      $arrresultado = $conexion->doSelect("count(*) as total",
      "usuario cliente
        inner join usuario cuenta on cliente.cuenta_id = cuenta.usuario_id
        inner join compania on compania.compania_id = cliente.compania_id
        inner join perfil on perfil.perfil_id = cliente.perfil_id      
      ",
      "cliente.usuario_eliminado = '0'  and compania.compania_eliminado = '0' and (perfil.perfil_id = '4' or perfil.perfil_idorig = '4') $where ", null, "cliente.usuario_id desc");
    
    
  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia			
    $where = " and cliente.cuenta_id = '$_COOKIE[idcuenta]'  and usuariocompania.compania_id = '$_COOKIE[idcompania]'";
    $modulo_url = "clienteclub";

    
    $arrresultado = $conexion->doSelect("count(*) as total",
    "usuario cliente
      inner join usuario cuenta on cliente.cuenta_id = cuenta.usuario_id
      inner join compania on compania.compania_id = cliente.compania_id
      inner join perfil on perfil.perfil_id = cliente.perfil_id      
      inner join usuariocompania on usuariocompania.usuario_id = cliente.usuario_id 
      $where
    ",
    "cliente.usuario_eliminado = '0'  and compania.compania_eliminado = '0' and (perfil.perfil_id = '4' or perfil.perfil_idorig = '4') ", null, "cliente.usuario_id desc");

  } else { 
    $nomostrarclientes = 1;
  } 

  

  if ($nomostrarclientes!=1){

    foreach($arrresultado as $i=>$valor){
      $total = utf8_encode($valor["total"]);   
    }  

    $panelmoduloclientes  .="
      <div class='col-lg-3 col-sm-6 col-xs-12'>      
        <div class='small-box div_accesodirecto' style='background: #109C9A'>
          <div class='inner'>
            <a href='$modulo_url'><h3>$total</h3></a>
            <a href='$modulo_url'><p>Clientes </p></a>
          </div>
          <div class='icon'>
            <a href='$modulo_url'>
              <i class='fa fa-users'></i>
            </a>
          </div>
          <a href='$modulo_url' class='small-box-footer'>Ver &nbsp <i class='fa fa-arrow-circle-right'></i></a>
        </div>
      </div>
    ";  
  }

  return $panelmoduloclientes;

}

function ListadoPagoCuotas($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null, $getcompaniarel=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
        
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' ";

  } else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  if ($getcompaniarel!=""){
    $where .=" and cuota.compania_id = '$getcompaniarel' ";
    $wherefecha = "";
  }



  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,
    pago.l_estatus_id, 

    estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb, 
    formapago.lista_nombre as formapago_nombre,
    pago_codexterno, pago.modulo_id, pago.elemento_id,
    modulo_nombreunico,

    cuota.cuota_id, cuota.cuota_nombre, cuota.cuota_codigo, cuota.cuota_monto, 
		cuota.l_moneda_id, cuota.cuota_usuarios, cuota.cuotaperiodo_id, cuota.cuota_activo, cuota.cuota_eliminado, 
		cuota.usuario_idreg, cuota.cuenta_id, cuota.compania_id,
		DATE_FORMAT(cuota.cuota_fechareg,'%d/%m/%Y %H:%i:%s') as cuota_fechareg,
		moneda.lista_nombredos as moneda_siglas,

		cuotausuario.cuotausuario_id, cuotausuario_fechareg, cuotausuario_activo, 
		
		estatuscuota.lista_nombre as estatuscuota_nombre,
	
		socio.usuario_nombre as socio_nombre,
		socio.usuario_apellido as socio_apellido


    ",
    "pago      
      inner join lista moneda on moneda.lista_id = pago.l_moneda_id      
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id
      inner join lista formapago on formapago.lista_id = pago.l_formapago_id

      inner join pagocuota on pagocuota.pago_id = pago.pago_id
			inner join cuotausuario on cuotausuario.cuotausuario_id = pagocuota.cuotausuario_id
			inner join cuota on cuota.cuota_id = cuotausuario.cuota_id
			inner join lista estatuscuota on estatuscuota.lista_id = cuotausuario.l_estatus_id
			inner join usuario socio on socio.usuario_id = cuotausuario.usuario_id

      left join modulo on modulo.modulo_id = pago.modulo_id



    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 

  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $cuotausuario_id = utf8_encode($valor["cuotausuario_id"]);
		$cuotausuario_fechareg = utf8_encode($valor["cuotausuario_fechareg"]);
		$cuotausuario_activo = utf8_encode($valor["cuotausuario_activo"]);
		$estatus_nombre = utf8_encode($valor["estatus_nombre"]);
		

		$moneda_siglas = utf8_encode($valor["moneda_siglas"]);
		$cuotaperiodo_nombre = utf8_encode($valor["cuotaperiodo_nombre"]);

		$cuota_id = utf8_encode($valor["cuota_id"]);
		$cuota_nombre = utf8_encode($valor["cuota_nombre"]);
		$cuota_codigo = utf8_encode($valor["cuota_codigo"]);
		$cuota_monto = utf8_encode($valor["cuota_monto"]);
		$l_moneda_id = utf8_encode($valor["l_moneda_id"]);
		$cuota_usuarios = utf8_encode($valor["cuota_usuarios"]);
		$cuotaperiodo_id = utf8_encode($valor["cuotaperiodo_id"]);
		$cuota_activo = utf8_encode($valor["cuota_activo"]);
		$cuota_fechareg = utf8_encode($valor["cuota_fechareg"]);

		$socio_nombre = utf8_encode($valor["socio_nombre"]);
		$socio_apellido = utf8_encode($valor["socio_apellido"]);    
		$socio = $socio_nombre." ".$socio_apellido." ";

		$cuota_monto = number_format_personalizado($cuota_monto, $moneda_siglas);
    
    $modulo_id = utf8_encode($valor["modulo_id"]);
    $modulo_nombreunico = utf8_encode($valor["modulo_nombreunico"]);
    $elemento_id = utf8_encode($valor["elemento_id"]);
    $pago_codexterno = utf8_encode($valor["pago_codexterno"]);

    $formapago_nombre = utf8_encode($valor["formapago_nombre"]);

    $trans_codigo = utf8_encode($valor["trans_codigo"]);
    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);

    $pagotrans_id = utf8_encode($valor["pagotrans_id"]);      
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]); 
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);


    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $aaa); 

    $pedido = "#$pago_codexterno";

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $urlir = "";
    $verid = "";

    if ($modulo_id=="1"){
      $urlir = "verpagoventa?id=$pago_id";
      $verid = "<a href='$urlir'>#$elemento_id (Ver Pago $modulo_nombreunico)</a>";
    }
    else if ($modulo_id=="1129"){
      $urlir = "verpagoprestamo?id=$pago_id";
      $verid = "<a href='$urlir'>#$elemento_id (Ver Pago $modulo_nombreunico)</a>";
    }
    else if ($modulo_id=="1222"){
      $urlir = "verpagocuotausuario?id=$pago_id";
      $verid = "<a href='$urlir'>#$elemento_id (Ver Pago $modulo_nombreunico)</a>";
    }

    $modificar = "<a href='$urlir'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    


    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$usuario</td>  
            <td>$cuota_nombre</td>  
            <td>$pago_monto $moneda_siglas</td>    
            <td>$formapago_nombre</td>   
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}

function ListadoCuotasUsuarios($cuentaseleccionada=null, $companiaseleccionada=null,$fechadesde =null, $fechahasta=null, $getdate=null, $cuota_id=null, $getestatus=null, $getusuario_id=null, $devolverarray=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and cuota.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and cuota.cuenta_id = '$_COOKIE[idcuenta]' and usuarioclub.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and cuota.cuenta_id = '$_COOKIE[idcuenta]' and usuarioclub.compania_id = '$_COOKIE[idcompania]' and cuotausuario.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (cuota.cuotaperiodo_fechaini BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (cuota.cuotaperiodo_fechaini BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (cuota.cuotaperiodo_fechaini > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (cuota.cuotaperiodo_fechaini BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }
  /*
  if ($encuesta_id!=""){
    $where .=" and encuesta.encuesta_id = '$encuesta_id' ";
    $wherefecha = "";
  }

  if ($encuestapreg_id!=""){
    $where .=" and encuestapregunta.encuestapreg_id = '$encuestapreg_id' ";
    $wherefecha = "";
  }

 
  */

  

  if ($getcompaniarel!=""){
    $where .=" and cuota.compania_id = '$getcompaniarel' ";
    $wherefecha = "";
  }

  if ($cuota_id!=""){
    $where .=" and cuota.cuota_id = '$cuota_id' ";
    $wherefecha = "";
  }

  if ($getestatus!=""){
    $where .=" and cuotausuario.l_estatus_id = '$getestatus' ";
    $wherefecha = "";
  }

  if ($getusuario_id!=""){
    $where .=" and cuotausuario.usuario_id = '$getusuario_id' ";
    $wherefecha = "";
  }

  


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("
    cuota.cuota_id, cuota.cuota_nombre, cuota.cuota_codigo, cuota.cuota_monto, 
    cuota.l_moneda_id, cuota.cuota_usuarios, cuota.cuotaperiodo_id, cuota.cuota_activo, cuota.cuota_eliminado, 
    cuota.usuario_idreg, cuota.cuenta_id, cuota.compania_id,
    DATE_FORMAT(cuota.cuota_fechareg,'%d/%m/%Y %H:%i:%s') as cuota_fechareg,
    moneda.lista_nombredos as moneda_siglas,
    cuotaperiodo.cuotaperiodo_nombre,

    cuotausuario_id, cuotausuario_fechareg, cuotausuario_activo, 
    estatus.lista_nombre as estatus_nombre,
    estatus.lista_cod as estatus_cod,

    socio.usuario_nombre as socio_nombre,
    socio.usuario_apellido as socio_apellido,

    
    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre
    ",
    "cuota
        inner join usuario cuenta on cuenta.usuario_id = cuota.cuenta_id
        inner join compania on compania.compania_id = cuota.compania_id  
        inner join cuotausuario on cuotausuario.cuota_id = cuota.cuota_id
        inner join lista moneda on moneda.lista_id = cuota.l_moneda_id    
        inner join cuotaperiodo on cuotaperiodo.cuotaperiodo_id = cuota.cuotaperiodo_id   
        
        inner join lista estatus on estatus.lista_id = cuotausuario.l_estatus_id
        inner join usuario socio on socio.usuario_id = cuotausuario.usuario_id

        inner join usuarioclub on usuarioclub.usuario_id = socio.usuario_id and usuarioclub_activo = '1'
        and usuarioclub.compania_id = cuota.compania_id 
        
    ",
    "cuota_eliminado = '0' and cuotausuario_eliminado = '0' $where ", null, "cuota.cuota_id asc");
  
  if ($devolverarray!=""){
    return $arrresultado;
  }
  

  foreach($arrresultado as $i=>$valor){
    $cuotausuario_id = utf8_encode($valor["cuotausuario_id"]);
    $cuotausuario_fechareg = utf8_encode($valor["cuotausuario_fechareg"]);
    $cuotausuario_activo = utf8_encode($valor["cuotausuario_activo"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
    $estatus_cod = utf8_encode($valor["estatus_cod"]);


    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
    $cuotaperiodo_nombre = utf8_encode($valor["cuotaperiodo_nombre"]);

    $cuota_id = utf8_encode($valor["cuota_id"]);
    $cuota_nombre = utf8_encode($valor["cuota_nombre"]);
    $cuota_codigo = utf8_encode($valor["cuota_codigo"]);
    $cuota_monto = utf8_encode($valor["cuota_monto"]);
    $l_moneda_id = utf8_encode($valor["l_moneda_id"]);
    $cuota_usuarios = utf8_encode($valor["cuota_usuarios"]);
    $cuotaperiodo_id = utf8_encode($valor["cuotaperiodo_id"]);
    $cuota_activo = utf8_encode($valor["cuota_activo"]);
    $cuota_fechareg = utf8_encode($valor["cuota_fechareg"]);

    $socio_nombre = utf8_encode($valor["socio_nombre"]);
    $socio_apellido = utf8_encode($valor["socio_apellido"]);    
    $socio = $socio_nombre." ".$socio_apellido." ";

    $cuota_monto = number_format_personalizado($cuota_monto, $moneda_siglas);
   
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    

    if ($cuotausuario_activo=="0"){
      $activo = "<i onclick='cambiarestatuscuotausuario(\"".$cuotausuario_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuscuotausuario(\"".$cuotausuario_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarcuotausuario(\"".$cuotausuario_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='vercuotausuario?id=$cuotausuario_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $cuota_nombre = "<a href='vercuotausuario?id=$cuotausuario_id'>$cuota_nombre <br>Ver Cuota</a>";
    
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    $formapagoventa = "";
    $pagar = "";

    if ($estatus_cod=="1"){

      $moduloactual = 1222;
      /*
        $cuota_monto = "<a href='pagoformapago?id=$cuotausuario_id&cu=$t_cuenta_id&co=$t_compania_id&m=$moduloactual'>
          $cuota_monto
          <img title='Registrar Pago' style='cursor:pointer; height: 24px; width: 20px' src='dist/img/registrarpago.png'>
        </a>";

        $pagar = "<a href='pagoformapago?id=$cuotausuario_id&cu=$t_cuenta_id&co=$t_compania_id&m=$moduloactual'>        
          <img title='Registrar Pago' style='cursor:pointer; height: 24px; width: 20px' src='dist/img/registrarpago.png'>
        </a>";
      */

      $cuota_monto = "<a onclick='pagarcuotausuario(\"".$cuotausuario_id."\")' style='cursor: pointer'>
          $cuota_monto
          <img title='Registrar Pago' style='cursor:pointer; height: 24px; width: 20px' src='dist/img/registrarpago.png'>
        </a>";

      $pagar = "<a onclick='pagarcuotausuario(\"".$cuotausuario_id."\")' style='cursor: pointer'>        
          <img title='Registrar Pago' style='cursor:pointer; height: 24px; width: 20px' src='dist/img/registrarpago.png'>
        </a>";

    }

    

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $textohtml .= "
          <tr style='font-size: 14px; text-align: center'>            
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                                         
            <td>$cuota_nombre</td>      
            <td>$cuota_monto</td>                  
            <td>$socio</td>                      
            <td>$estatus_nombre</td>                                            
            <td style='text-align: center'>$pagar &nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}

function ObtenerListaCuotaPeriodo($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and cuotaperiodo.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and cuotaperiodo.cuenta_id = '$_COOKIE[idcuenta]' and cuotaperiodo.compania_id = '$_COOKIE[idcompania]' ";

}  else { 

    $where = " and cuotaperiodo.cuenta_id = '$_COOKIE[idcuenta]' and cuotaperiodo.compania_id = '$_COOKIE[idcompania]' ";

  } 


  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($companiaseleccionada!=""){
    $where .= " and cuotaperiodo.compania_id = '$companiaseleccionada'";
  }
  

  $arrresultado = $conexion->doSelect("

  cuotaperiodo.cuotaperiodo_id, cuotaperiodo.cuotaperiodo_nombre, 
  cuotaperiodo.cuotaperiodo_activo, cuotaperiodo.cuotaperiodo_eliminado, 
  cuotaperiodo.cuotaperiodo_fechareg, cuotaperiodo.usuario_idreg, 
  DATE_FORMAT(cuotaperiodo.cuotaperiodo_fechareg,'%d/%m/%Y %H:%i:%s') as cuotaperiodo_fechareg,    
  DATE_FORMAT(cuotaperiodo.cuotaperiodo_fechaini,'%d/%m/%Y') as cuotaperiodo_fechaini,    
  DATE_FORMAT(cuotaperiodo.cuotaperiodo_fechafin,'%d/%m/%Y') as cuotaperiodo_fechafin,    
  
  cuenta.usuario_codigo as cuenta_codigo, 
  cuenta.usuario_nombre as cuenta_nombre,
  cuenta.usuario_apellido as cuenta_apellido, 
  compania_nombre

  ",
  "cuotaperiodo
      inner join usuario cuenta on cuenta.usuario_id = cuotaperiodo.cuenta_id
      inner join compania on compania.compania_id = cuotaperiodo.compania_id                 
      
  ",
  "cuotaperiodo_eliminado = '0' $where ", null, "cuotaperiodo.cuotaperiodo_id desc");

  $option = "<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

      $cuotaperiodo_id = utf8_encode($valor["cuotaperiodo_id"]);
      $cuotaperiodo_nombre = utf8_encode($valor["cuotaperiodo_nombre"]);      

        if ($idseleccionado==$cuotaperiodo_id){
          $option .= "<option selected='selected' value='$cuotaperiodo_id'>$cuotaperiodo_nombre</option>";
      }else{
          $option .= "<option value='$cuotaperiodo_id'>$cuotaperiodo_nombre</option>";
      }
  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN PERIODOS</option>";
  }

  return $option;

}

function ListadoCuotaPeriodo($cuentaseleccionada=null, $companiaseleccionada=null, $cuotaperiodo_id=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and cuotaperiodo.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and cuotaperiodo.cuenta_id = '$_COOKIE[idcuenta]' and cuotaperiodo.compania_id = '$_COOKIE[idcompania]' ";

  }  else { 

    $where = " and cuotaperiodo.cuenta_id = '$_COOKIE[idcuenta]' and cuotaperiodo.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if ($cuotaperiodo_id!=""){
    $where .=" and cuotaperiodo.cuotaperiodo_id = '$cuotaperiodo_id' ";
    $wherefecha = "";
  }


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("

    cuotaperiodo.cuotaperiodo_id, cuotaperiodo.cuotaperiodo_nombre, 
    cuotaperiodo.cuotaperiodo_activo, cuotaperiodo.cuotaperiodo_eliminado, 
    cuotaperiodo.cuotaperiodo_fechareg, cuotaperiodo.usuario_idreg, 
    DATE_FORMAT(cuotaperiodo.cuotaperiodo_fechareg,'%d/%m/%Y %H:%i:%s') as cuotaperiodo_fechareg,    
    DATE_FORMAT(cuotaperiodo.cuotaperiodo_fechaini,'%d/%m/%Y') as cuotaperiodo_fechaini,    
    DATE_FORMAT(cuotaperiodo.cuotaperiodo_fechafin,'%d/%m/%Y') as cuotaperiodo_fechafin,    
    
    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre

    ",
    "cuotaperiodo
        inner join usuario cuenta on cuenta.usuario_id = cuotaperiodo.cuenta_id
        inner join compania on compania.compania_id = cuotaperiodo.compania_id                 
        
    ",
    "cuotaperiodo_eliminado = '0' $where ", null, "cuotaperiodo.cuotaperiodo_id desc");

  if ($cuotaperiodo_id!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $cuotaperiodo_id = utf8_encode($valor["cuotaperiodo_id"]);
    $cuotaperiodo_nombre = utf8_encode($valor["cuotaperiodo_nombre"]);
    $cuotaperiodo_fechaini = utf8_encode($valor["cuotaperiodo_fechaini"]);
    $cuotaperiodo_fechafin = utf8_encode($valor["cuotaperiodo_fechafin"]);
    $cuotaperiodo_activo = utf8_encode($valor["cuotaperiodo_activo"]);
    $cuotaperiodo_fechareg = utf8_encode($valor["cuotaperiodo_fechareg"]);
    
   
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    

    if ($cuotaperiodo_activo=="0"){
      $activo = "<i onclick='cambiarestatuscuotaperiodo(\"".$cuotaperiodo_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuscuotaperiodo(\"".$cuotaperiodo_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarcuotaperiodo(\"".$cuotaperiodo_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='modificarcuotaperiodo?id=$cuotaperiodo_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
          <tr style='font-size: 14px'>            
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
            <td>$cuotaperiodo_nombre</td>  
            <td>$cuotaperiodo_fechaini / $cuotaperiodo_fechafin</td>              
            <td style='text-align: center'>$cuotaperiodo_fechareg</td>   
            <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}

function ListadoCuotas($cuentaseleccionada=null, $companiaseleccionada=null,$fechadesde =null, $fechahasta=null, $getdate=null, $cuota_id=null, $getcompaniarel=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and cuota.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and cuota.cuenta_id = '$_COOKIE[idcuenta]' and cuota.compania_id = '$_COOKIE[idcompania]' ";

  }  else { 

    $where = " and cuota.cuenta_id = '$_COOKIE[idcuenta]' and cuota.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (diagnostico.diagnostico_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (diagnostico.diagnostico_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (diagnostico.diagnostico_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (diagnostico.diagnostico_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }
  /*
  if ($encuesta_id!=""){
    $where .=" and encuesta.encuesta_id = '$encuesta_id' ";
    $wherefecha = "";
  }

  if ($encuestapreg_id!=""){
    $where .=" and encuestapregunta.encuestapreg_id = '$encuestapreg_id' ";
    $wherefecha = "";
  }

 
  */

  

  if ($getcompaniarel!=""){
    $where .=" and cuota.compania_id = '$getcompaniarel' ";
    $wherefecha = "";
  }

  if ($cuota_id!=""){
    $where .=" and cuota.cuota_id = '$cuota_id' ";
    $wherefecha = "";
  }


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("
    cuota.cuota_id, cuota.cuota_nombre, cuota.cuota_codigo, cuota.cuota_monto, 
    cuota.l_moneda_id, cuota.cuota_usuarios, cuota.cuotaperiodo_id, cuota.cuota_activo, cuota.cuota_eliminado, 
    cuota.usuario_idreg, cuota.cuenta_id, cuota.compania_id,
    DATE_FORMAT(cuota.cuota_fechareg,'%d/%m/%Y %H:%i:%s') as cuota_fechareg,
    moneda.lista_nombredos as moneda_siglas,
    cuotaperiodo.cuotaperiodo_nombre,

    
    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre
    ",
    "cuota
        inner join usuario cuenta on cuenta.usuario_id = cuota.cuenta_id
        inner join compania on compania.compania_id = cuota.compania_id    
        left join lista moneda on moneda.lista_id = cuota.l_moneda_id    
        left join cuotaperiodo on cuotaperiodo.cuotaperiodo_id = cuota.cuotaperiodo_id         
    ",
    "cuota_eliminado = '0' $where ", null, "cuota.cuota_id desc");

  if ($cuota_id!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){


    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
    $cuotaperiodo_nombre = utf8_encode($valor["cuotaperiodo_nombre"]);

    $cuota_id = utf8_encode($valor["cuota_id"]);
    $cuota_nombre = utf8_encode($valor["cuota_nombre"]);
    $cuota_codigo = utf8_encode($valor["cuota_codigo"]);
    $cuota_monto = utf8_encode($valor["cuota_monto"]);
    $l_moneda_id = utf8_encode($valor["l_moneda_id"]);
    $cuota_usuarios = utf8_encode($valor["cuota_usuarios"]);
    $cuotaperiodo_id = utf8_encode($valor["cuotaperiodo_id"]);
    $cuota_activo = utf8_encode($valor["cuota_activo"]);
    $cuota_fechareg = utf8_encode($valor["cuota_fechareg"]);

    $cuota_monto = number_format_personalizado($cuota_monto, $moneda_siglas);
   
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    

    if ($cuota_activo=="0"){
      $activo = "<i onclick='cambiarestatuscuota(\"".$cuota_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuscuota(\"".$cuota_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarcuota(\"".$cuota_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='modificarcuota?id=$cuota_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $cuotasgeneradas = "
    <a href='cuotausuario?id=$cuota_id'>
      $cuota_usuarios (Ver Cuotas)
    </a>";  
 
    
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $textohtml .= "
          <tr style='font-size: 14px; text-align: center'>            
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                                         
            <td>$cuotaperiodo_nombre</td>      
            <td>$cuota_nombre</td>                  
            <td>$cuota_monto</td>                      
            <td>$cuotasgeneradas</td>      
            <td>$cuota_fechareg</td>                          
            <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}
 

function ObtenerListaEncuestaPregunta($cuentaseleccionada=null, $companiaseleccionada=null, $encuesta_id=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and encuesta.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and encuesta.cuenta_id = '$_COOKIE[idcuenta]' and encuesta.compania_id = '$_COOKIE[idcompania]' ";

  } 


  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("
    encuesta.encuesta_id, encuesta.encuesta_nombre, encuestapregunta.encuestapreg_id, encuestapregunta.encuestapreg_nombre, encuestapregunta.encuestapreg_orden
    ",
    "encuesta
        inner join encuestapregunta on encuestapregunta.encuesta_id = encuesta.encuesta_id
        inner join usuario cuenta on cuenta.usuario_id = encuesta.cuenta_id
        inner join compania on compania.compania_id = encuesta.compania_id             
    ",
    "encuesta_eliminado = '0' and encuestapregunta.encuestapreg_eliminado = '0' $where  ", null, "encuestapregunta.encuestapreg_orden asc");

    $option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $encuestapreg_id = utf8_encode($valor["encuestapreg_id"]);
      $encuestapreg_nombre = utf8_encode($valor["encuestapreg_nombre"]);
      $encuestapreg_orden = utf8_encode($valor["encuestapreg_orden"]);
      $encuesta_id = utf8_encode($valor["encuesta_id"]);
      $encuesta_nombre = utf8_encode($valor["encuesta_nombre"]);

       if ($encuestapreg_id==$idseleccionado){
          $option .= "<option selected='selected' value='$encuestapreg_id'>$encuestapreg_orden.- $encuestapreg_nombre</option>";
      }else{
          $option .= "<option value='$encuestapreg_id'>$encuestapreg_orden.- $encuestapreg_nombre</option>";
      }
    }


    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN CAMPOS</option>";
    }

  return $option;

}


function ListadoEncuestasPreguntasRespuestas($cuentaseleccionada=null, $companiaseleccionada=null, $encuesta_id=null, $encuestapreg_id=null, $idseleccionado=null, $getestatus=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and encuesta.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and encuesta.cuenta_id = '$_COOKIE[idcuenta]' and encuesta.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if ($encuesta_id!=""){
    $where .=" and encuesta.encuesta_id = '$encuesta_id' ";
    $wherefecha = "";
  }

  if ($encuestapreg_id!=""){
    $where .=" and encuestapregunta.encuestapreg_id = '$encuestapreg_id' ";
    $wherefecha = "";
  }

  if ($idseleccionado!=""){
    $where .=" and encuestapreguntarespuesta.encuestapregresp_id = '$idseleccionado' ";
    $wherefecha = "";
  }


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("

    encuesta.encuesta_id, encuesta.encuesta_nombre, encuesta.encuesta_img, 
    encuesta.encuesta_descrip, encuesta.encuesta_codigo, encuesta.encuesta_msjefin, 
    encuesta.encuesta_activo, encuesta.encuesta_eliminado, 
    encuesta.cuenta_id, encuesta.compania_id, 
    
    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre,

    encuestapregunta.encuestapreg_id, encuestapregunta.encuesta_id, encuestapregunta.encuestaseccion_id, 
    encuestapregunta.encuestapreg_nombre, encuestapregunta.encuestapreg_descrip, 
    encuestapreg_img,
    encuestapregunta.encuestapreg_orden,
    encuestapregunta.encuestapreg_activo, 
    encuestapregunta.encuestapreg_eliminado, 

    encuestapreguntarespuesta.encuestapregresp_id, encuestapreguntarespuesta.encuesta_id, 
    encuestapreguntarespuesta.encuestapreg_id, encuestapreguntarespuesta.l_tipodato_id, 
    encuestapreguntarespuesta.encuestapreg_idrel, encuestapreguntarespuesta.encuestapregresp_nombre, 
    encuestapreguntarespuesta.encuestapregresp_descrip, encuestapreguntarespuesta.encuestapregresp_orden, 
    encuestapreguntarespuesta.encuestapregresp_activo, 
    encuestapreguntarespuesta.encuestapregresp_eliminado, encuestapregresp_img,
    DATE_FORMAT(encuestapreguntarespuesta.encuestapregresp_fechareg,'%d/%m/%Y %H:%i:%s') as encuestapregresp_fechareg
    ",
    "encuesta
        inner join usuario cuenta on cuenta.usuario_id = encuesta.cuenta_id
        inner join compania on compania.compania_id = encuesta.compania_id 
        inner join encuestapregunta on encuestapregunta.encuesta_id = encuesta.encuesta_id 
        inner join encuestapreguntarespuesta on encuestapreguntarespuesta.encuestapreg_id = encuestapregunta.encuestapreg_id         
    ",
    "encuesta_eliminado = '0' and encuestapregresp_eliminado = '0' $where ", null, "encuestapregunta.encuestapreg_orden asc");

  if ($idseleccionado!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $encuestapregresp_id = utf8_encode($valor["encuestapregresp_id"]);
    $l_tipodato_id = utf8_encode($valor["l_tipodato_id"]);
    $encuestapreg_idrel = utf8_encode($valor["encuestapreg_idrel"]);
    $encuestapregresp_nombre = utf8_encode($valor["encuestapregresp_nombre"]);
    $encuestapregresp_descrip = utf8_encode($valor["encuestapregresp_descrip"]);
    $encuestapregresp_orden = utf8_encode($valor["encuestapregresp_orden"]);
    $encuestapregresp_activo = utf8_encode($valor["encuestapregresp_activo"]);
    $encuestapregresp_fechareg = utf8_encode($valor["encuestapregresp_fechareg"]);
    $encuestapregresp_img = utf8_encode($valor["encuestapregresp_img"]);


    $encuestapreg_id = utf8_encode($valor["encuestapreg_id"]);
    $encuestapreg_nombre = utf8_encode($valor["encuestapreg_nombre"]);
    $encuestapreg_descrip = utf8_encode($valor["encuestapreg_descrip"]);
    $encuestapreg_orden = utf8_encode($valor["encuestapreg_orden"]);
    $encuestapreg_activo = utf8_encode($valor["encuestapreg_activo"]);    
    $encuestapreg_img = utf8_encode($valor["encuestapreg_img"]);    
    $encuestapreg_fechareg = utf8_encode($valor["encuestapreg_fechareg"]);    

    $encuesta_id = utf8_encode($valor["encuesta_id"]);
    $encuesta_nombre = utf8_encode($valor["encuesta_nombre"]);
    $encuesta_img = utf8_encode($valor["encuesta_img"]);
    $encuesta_descrip = utf8_encode($valor["encuesta_descrip"]);
    $encuesta_codigo = utf8_encode($valor["encuesta_codigo"]);
    $encuesta_msjefin = utf8_encode($valor["encuesta_msjefin"]);
    $encuesta_activo = utf8_encode($valor["encuesta_activo"]);
    $encuesta_eliminado = utf8_encode($valor["encuesta_eliminado"]);
    $encuesta_fechareg = utf8_encode($valor["encuesta_fechareg"]);    
   
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    

    if ($encuestapregresp_activo=="0"){
      $activo = "<i onclick='cambiarestatusencuestapreguntarespuesta(\"".$encuestapregresp_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusencuestapreguntarespuesta(\"".$encuestapregresp_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarencuestapreguntarespuesta(\"".$encuestapregresp_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='modificarencuestapreguntarespuesta?id=$encuestapregresp_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $imagen = "
    <a href='modificarencuestapreguntarespuesta?id=$encuestapregresp_id'>
      <img src='arch//$encuestapregresp_img' style='height: 50px; width: 50ox' />
    </a>";  
 
    
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
          <tr style='font-size: 14px'>            
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
            <td>$encuesta_nombre</td>              
            <td>$encuestapreg_nombre</td>      
            <td>$encuestapregresp_nombre</td>      
            <td>$encuestapregresp_orden</td>                      
            <td>$encuestapregresp_fechareg</td>                          
            <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}
 

function ListadoEncuestasPreguntas($cuentaseleccionada=null, $companiaseleccionada=null, $encuesta_id=null, $idseleccionado=null, $getestatus=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and encuesta.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and encuesta.cuenta_id = '$_COOKIE[idcuenta]' and encuesta.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if ($idseleccionado!=""){
    $where .=" and encuestapregunta.encuestapreg_id = '$idseleccionado' ";
    $wherefecha = "";
  }

  if ($encuesta_id!=""){
    $where .=" and encuesta.encuesta_id = '$encuesta_id' ";
    $wherefecha = "";
  }




  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("

    encuesta.encuesta_id, encuesta.encuesta_nombre, encuesta.encuesta_img, 
    encuesta.encuesta_descrip, encuesta.encuesta_codigo, encuesta.encuesta_msjefin, 
    encuesta.encuesta_activo, encuesta.encuesta_eliminado, 
    encuesta.cuenta_id, encuesta.compania_id, 
    
    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre,

    encuestapregunta.encuestapreg_id, encuestapregunta.encuesta_id, encuestapregunta.encuestaseccion_id, 
    encuestapregunta.encuestapreg_nombre, encuestapregunta.encuestapreg_descrip, 
    encuestapreg_img,
    encuestapregunta.encuestapreg_orden,
    encuestapregunta.encuestapreg_activo, encuestapregunta.l_tipopreg_id,
    encuestapregunta.encuestapreg_eliminado,  

    DATE_FORMAT(encuestapregunta.encuestapreg_fechareg,'%d/%m/%Y %H:%i:%s') as encuestapreg_fechareg
    ",
    "encuesta
        inner join usuario cuenta on cuenta.usuario_id = encuesta.cuenta_id
        inner join compania on compania.compania_id = encuesta.compania_id 
        inner join encuestapregunta on encuestapregunta.encuesta_id = encuesta.encuesta_id         
    ",
    "encuesta_eliminado = '0' and encuestapreg_eliminado = '0' $where ", null, "encuestapregunta.encuestapreg_orden asc");

  if ($idseleccionado!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $l_tipopreg_id = utf8_encode($valor["l_tipopreg_id"]);
    $encuestapreg_id = utf8_encode($valor["encuestapreg_id"]);
    $encuestapreg_nombre = utf8_encode($valor["encuestapreg_nombre"]);
    $encuestapreg_descrip = utf8_encode($valor["encuestapreg_descrip"]);
    $encuestapreg_orden = utf8_encode($valor["encuestapreg_orden"]);
    $encuestapreg_activo = utf8_encode($valor["encuestapreg_activo"]);    
    $encuestapreg_img = utf8_encode($valor["encuestapreg_img"]);    
    $encuestapreg_fechareg = utf8_encode($valor["encuestapreg_fechareg"]);   

    $encuesta_id = utf8_encode($valor["encuesta_id"]);
    $encuesta_nombre = utf8_encode($valor["encuesta_nombre"]);
    $encuesta_img = utf8_encode($valor["encuesta_img"]);
    $encuesta_descrip = utf8_encode($valor["encuesta_descrip"]);
    $encuesta_codigo = utf8_encode($valor["encuesta_codigo"]);
    $encuesta_msjefin = utf8_encode($valor["encuesta_msjefin"]);
    $encuesta_activo = utf8_encode($valor["encuesta_activo"]);
    $encuesta_eliminado = utf8_encode($valor["encuesta_eliminado"]);
    $encuesta_fechareg = utf8_encode($valor["encuesta_fechareg"]);    
   
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    

    if ($encuestapreg_activo=="0"){
      $activo = "<i onclick='cambiarestatusencuestapregunta(\"".$encuestapreg_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusencuestapregunta(\"".$encuestapreg_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarencuestapregunta(\"".$encuestapreg_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='modificarencuestapregunta?eid=$encuesta_id&id=$encuestapreg_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $imagen = "
    <a href='modificarencuestapregunta?id=$encuesta_id'>
      <img src='arch//$encuestapreg_img' style='height: 50px; width: 50ox' />
    </a>";  

    $respuestas = "
    <a href='encuestapreguntarespuesta?eid=$encuesta_id&pid=$encuestapreg_id'>
      Respuestas
    </a>";  
    
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
          <tr style='font-size: 14px'>            
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
            <td>$encuesta_nombre</td>  
            <td>$encuestapreg_orden</td>      
            <td>$encuestapreg_nombre</td>      
            <td>$respuestas</td>                      
            <td>$encuestapreg_fechareg</td>                          
            <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}
 

function ObtenerListaEncuesta($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and encuesta.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and encuesta.cuenta_id = '$_COOKIE[idcuenta]' and encuesta.compania_id = '$_COOKIE[idcompania]' ";

  } 


  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("
    encuesta.encuesta_id, encuesta.encuesta_nombre
    ",
    "encuesta
        inner join usuario cuenta on cuenta.usuario_id = encuesta.cuenta_id
        inner join compania on compania.compania_id = encuesta.compania_id             
    ",
    "encuesta_eliminado = '0' $where  ", null, "encuesta.encuesta_nombre asc");

    $option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $encuesta_id = utf8_encode($valor["encuesta_id"]);
      $encuesta_nombre = utf8_encode($valor["encuesta_nombre"]);

       if ($encuesta_id==$idseleccionado){
          $option .= "<option selected='selected' value='$encuesta_id'>$encuesta_nombre</option>";
      }else{
          $option .= "<option value='$encuesta_id'>$encuesta_nombre</option>";
      }
    }


    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN CAMPOS</option>";
    }

  return $option;

}

function ListadoEncuestasSeccion($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null, $getestatus=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and encuesta.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and encuesta.cuenta_id = '$_COOKIE[idcuenta]' and encuesta.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if ($idseleccionado!=""){
    $where .=" and encuesta.encuesta_id = '$idseleccionado' ";
    $wherefecha = "";
  }


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("

    encuesta.encuesta_id, encuesta.encuesta_nombre, encuesta.encuesta_img, 
    encuesta.encuesta_descrip, encuesta.encuesta_codigo, encuesta.encuesta_msjefin, 
    encuesta.encuesta_activo, encuesta.encuesta_eliminado, 
    encuesta.cuenta_id, encuesta.compania_id, 
    
    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre,
    encuestaseccion.encuestaseccion_id, encuestaseccion.encuesta_id, 
    encuestaseccion.encuestaseccion_nombre, encuestaseccion.encuestaseccion_descrip,
    encuestaseccion.encuestaseccion_img,
    encuestaseccion.encuestaseccion_orden, 
    encuestaseccion.encuestaseccion_activo, encuestaseccion.encuestaseccion_eliminado,
    DATE_FORMAT(encuestaseccion.encuestaseccion_fechareg,'%d/%m/%Y %H:%i:%s') as encuestaseccion_fechareg

    ",
    "encuesta
        inner join usuario cuenta on cuenta.usuario_id = encuesta.cuenta_id
        inner join compania on compania.compania_id = encuesta.compania_id 
        inner join encuestaseccion on encuestaseccion.encuesta_id = encuesta.encuesta_id         
    ",
    "encuesta_eliminado = '0' and encuestaseccion_eliminado = '0' $where ", null, "encuestaseccion.encuestaseccion_id desc");

  if ($idseleccionado!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $encuestaseccion_id = utf8_encode($valor["encuestaseccion_id"]);
    $encuestaseccion_nombre = utf8_encode($valor["encuestaseccion_nombre"]);
    $encuestaseccion_img = utf8_encode($valor["encuestaseccion_img"]);
    $encuestaseccion_descrip = utf8_encode($valor["encuestaseccion_descrip"]);
    $encuestaseccion_orden = utf8_encode($valor["encuestaseccion_orden"]);
    $encuestaseccion_fechareg = utf8_encode($valor["encuestaseccion_fechareg"]);
    $encuestaseccion_activo = utf8_encode($valor["encuestaseccion_activo"]);


    $encuesta_id = utf8_encode($valor["encuesta_id"]);
    $encuesta_nombre = utf8_encode($valor["encuesta_nombre"]);
    $encuesta_img = utf8_encode($valor["encuesta_img"]);
    $encuesta_descrip = utf8_encode($valor["encuesta_descrip"]);
    $encuesta_codigo = utf8_encode($valor["encuesta_codigo"]);
    $encuesta_msjefin = utf8_encode($valor["encuesta_msjefin"]);
    $encuesta_activo = utf8_encode($valor["encuesta_activo"]);
    $encuesta_eliminado = utf8_encode($valor["encuesta_eliminado"]);
    $encuesta_fechareg = utf8_encode($valor["encuesta_fechareg"]);    
   
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    

    if ($encuestaseccion_activo=="0"){
      $activo = "<i onclick='cambiarestatusencuestaseccion(\"".$encuestaseccion_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusencuestaseccion(\"".$encuestaseccion_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarencuestaseccion(\"".$encuestaseccion_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='modificarencuestaseccion?id=$encuestaseccion_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $imagen = "
    <a href='modificarencuestaseccion?id=$encuesta_id'>
      <img src='arch//$encuestaseccion_img' style='height: 50px; width: 50ox' />
    </a>";  
    
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
          <tr style='font-size: 14px'>            
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
            <td>$encuesta_nombre</td>  
            <td>$encuestaseccion_img</td>  
            <td>$imagen</td>             
            <td>$encuestaseccion_fechareg</td>                          
            <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}

function ListadoEncuestas($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null, $getestatus=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and encuesta.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and encuesta.cuenta_id = '$_COOKIE[idcuenta]' and encuesta.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if ($idseleccionado!=""){
    $where .=" and encuesta.encuesta_id = '$idseleccionado' ";
    $wherefecha = "";
  }


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("

    encuesta.encuesta_id, encuesta.encuesta_nombre, encuesta.encuesta_img, 
    encuesta.encuesta_descrip, encuesta.encuesta_codigo, encuesta.encuesta_msjefin, 
    encuesta.encuesta_activo, encuesta.encuesta_eliminado, 
    encuesta.cuenta_id, encuesta.compania_id, 
    DATE_FORMAT(encuesta.encuesta_fechareg,'%d/%m/%Y %H:%i:%s') as encuesta_fechareg,
    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre

    ",
    "encuesta
        inner join usuario cuenta on cuenta.usuario_id = encuesta.cuenta_id
        inner join compania on compania.compania_id = encuesta.compania_id         
    ",
    "encuesta_eliminado = '0' $where ", null, "encuesta.encuesta_id desc");

  if ($idseleccionado!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $encuesta_id = utf8_encode($valor["encuesta_id"]);
    $encuesta_nombre = utf8_encode($valor["encuesta_nombre"]);
    $encuesta_img = utf8_encode($valor["encuesta_img"]);
    $encuesta_descrip = utf8_encode($valor["encuesta_descrip"]);
    $encuesta_codigo = utf8_encode($valor["encuesta_codigo"]);
    $encuesta_msjefin = utf8_encode($valor["encuesta_msjefin"]);
    $encuesta_activo = utf8_encode($valor["encuesta_activo"]);
    $encuesta_eliminado = utf8_encode($valor["encuesta_eliminado"]);
    $encuesta_fechareg = utf8_encode($valor["encuesta_fechareg"]);    
   
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    

    if ($encuesta_activo=="0"){
      $activo = "<i onclick='cambiarestatusencuesta(\"".$encuesta_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusencuesta(\"".$encuesta_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarencuesta(\"".$encuesta_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='modificarencuesta?id=$encuesta_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $imagen = "
    <a href='modificarencuesta?id=$encuesta_id'>
      <img src='arch//$encuesta_img' style='height: 50px; width: 50ox' />
    </a>";  

    $resultados = "
    <a href='encuestaresultados?id=$encuesta_id'>
      Resultados
    </a>"; 

    $secciones = "
    <a href='encuestaseccion?id=$encuesta_id'>
      Secciones
    </a>";  

    $preguntas = "
    <a href='encuestapregunta?id=$encuesta_id'>
      Preguntas
    </a>";  

    
    
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
          <tr style='font-size: 14px'>            
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
            <td>$encuesta_id</td>  
            <td>$encuesta_nombre</td>  
            <td>$imagen</td> 
            <td>$preguntas</td> 
            <td>$resultados</td>  
            <td>$encuesta_fechareg</td>                          
            <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}

function ListadoDiagnosticos($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $getdate=null, $diagnostico_id=null, $cita_id=null, $getestatus=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (diagnostico.diagnostico_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (diagnostico.diagnostico_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (diagnostico.diagnostico_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (diagnostico.diagnostico_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and cita.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and cita.cuenta_id = '$_COOKIE[idcuenta]' and cita.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if ($cita_id!=""){
    $where .=" and cita.cita_id = '$cita_id' ";
    $wherefecha = "";
  }

  if ($getestatus!=""){
    $where .=" and cita.l_estatuscita_id = '$getestatus' ";    
  }

  


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("
    diagnostico.diagnostico_id, diagnostico.cita_id, diagnostico.usuario_id as usuario_iddiagnostico, 
    diagnostico.diagnostico_descrip,
    diagnostico.diagnostico_activo, diagnostico.diagnostico_eliminado,
    DATE_FORMAT(diagnostico.diagnostico_fechareg,'%d/%m/%Y %H:%i:%s') as diagnostico_fechareg,
    cita.cita_id, cita.cita_descrip, cita.usuario_id, cita.cliente_id, 
    cita.l_estatuscita_id, cita.cita_siguiente, 
    cita.cita_programada, cita.cita_activo, 
    cita.cita_eliminado, cita.cuenta_id, cita.compania_id, cita.sucursal_id,
    DATE_FORMAT(cita.cita_fecha,'%d/%m/%Y') as cita_fecha,    
    DATE_FORMAT(cita.cita_fechareg,'%d/%m/%Y %H:%i:%s') as cita_fechareg,
    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre, sucursal_nombre,         
    estatus.lista_nombre as estatus_nombre,
    cliente.usuario_nombre as cliente_nombre, cliente.usuario_apellido as cliente_apellido,
    medico.usuario_nombre as medico_nombre, medico.usuario_apellido as medico_apellido

    ",
    "diagnostico
        inner join cita on cita.cita_id = diagnostico.cita_id
        inner join usuario cuenta on cuenta.usuario_id = cita.cuenta_id
        inner join compania on compania.compania_id = cita.compania_id 
        inner join sucursal on sucursal.sucursal_id = cita.sucursal_id
        inner join lista estatus on estatus.lista_id = cita.l_estatuscita_id
        inner join usuario cliente on cliente.usuario_id = cita.cliente_id
        inner join usuario medico on medico.usuario_id = cita.usuario_id        
    ",
    "diagnostico_eliminado = '0' and cita_eliminado = '0' $where $wherefecha ", null, "cita.cita_id desc");

  if ($diagnostico_id!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $diagnostico_id = utf8_encode($valor["diagnostico_id"]);
    $usuario_id = utf8_encode($valor["usuario_id"]);
    $diagnostico_descrip = utf8_encode($valor["diagnostico_descrip"]);
    $diagnostico_activo = utf8_encode($valor["diagnostico_activo"]);
    $diagnostico_fechareg = utf8_encode($valor["diagnostico_fechareg"]);    

    $cita_id = utf8_encode($valor["cita_id"]);
    $cita_descrip = utf8_encode($valor["cita_descrip"]);
    $usuario_id = utf8_encode($valor["usuario_id"]);
    $cliente_id = utf8_encode($valor["cliente_id"]);
    $l_estatuscita_id = utf8_encode($valor["l_estatuscita_id"]);
    $cita_siguiente = utf8_encode($valor["cita_siguiente"]);
    $cita_programada = utf8_encode($valor["cita_programada"]);
    $cita_fecha = utf8_encode($valor["cita_fecha"]);
    $cita_activo = utf8_encode($valor["cita_activo"]);
    $cita_fechareg = utf8_encode($valor["cita_fechareg"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
    $t_sucursal_id = utf8_encode($valor["sucursal_id"]);


    $cliente_nombre = utf8_encode($valor["cliente_nombre"]);
    $cliente_apellido = utf8_encode($valor["cliente_apellido"]);
    $cliente = $cliente_nombre." ".$cliente_apellido." ";

    $medico_nombre = utf8_encode($valor["medico_nombre"]);
    $medico_apellido = utf8_encode($valor["medico_apellido"]);
    $medico = $medico_nombre." ".$medico_apellido." ";

    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    $sucursal_nombre = utf8_encode($valor["sucursal_nombre"]);



    if ($diagnostico_activo=="0"){
      $activo = "<i onclick='cambiarestatusdiagnostico(\"".$cita_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusdiagnostico(\"".$cita_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminardiagnostico(\"".$cita_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='gestionarcita?id=$cita_id&p=diagnostico&did=$diagnostico_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
          <tr style='font-size: 14px'>            
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
            <td>$cita_id</td>  
            <td>$gestionarcitatexto</td>  
            <td>$cliente</td>  
            <td>$medico</td>  
            <td>$sucursal_nombre</td>  
            <td>$cita_fecha</td>  
            <td>$estatus_nombre</td>  
            <td style='text-align: center'>$cita_fechareg</td>   
            <td style='text-align: center'>$gestionarcita &nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}

function ObtenerListaMedicamentosAlergias($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and medicamento.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and medicamento.cuenta_id = '$_COOKIE[idcuenta]' and medicamento.compania_id = '$_COOKIE[idcompania]' ";

  } 


  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("
    medicamento.medicamento_id, medicamento.medicamento_nombre, alergiamedrel_id
    ",
    "medicamento
        inner join usuario cuenta on cuenta.usuario_id = medicamento.cuenta_id
        inner join compania on compania.compania_id = medicamento.compania_id     
        left join alergiamedicamentorel on alergiamedicamentorel.medicamento_id = medicamento.medicamento_id and
             alergiamedicamentorel.alergiamed_id = '$idseleccionado' and alergiamedrel_activo = '1'
    ",
    "medicamento_eliminado = '0' $where  ", null, "medicamento.medicamento_nombre asc");

    //$option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $medicamento_id = utf8_encode($valor["medicamento_id"]);
      $medicamento_nombre = utf8_encode($valor["medicamento_nombre"]);
      $alergiamedrel_id = utf8_encode($valor["alergiamedrel_id"]);      

       if ($alergiamedrel_id!=""){
          $option .= "<option selected='selected' value='$medicamento_id'>$medicamento_nombre</option>";
      }else{
          $option .= "<option value='$medicamento_id'>$medicamento_nombre</option>";
      }
    }


    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN CAMPOS</option>";
    }

  return $option;

}

function ObtenerListaFamilia($cuenta=null, $compania=null, $elementoid=null){

  if ($ordenar=="entero"){
    $orderby = "CAST(lista_nombre AS UNSIGNED)";
  }else{
    $orderby = "listacuenta_nombre";
  }

  $tipolista_id = "235";

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $option = "<option value=''>-- Seleccione --</option>";
  
  if ($cuenta!="" ){
    
      $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
        listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
            "lista                
                left join listacuenta on listacuenta.lista_id = lista.lista_id 
            ",
            "lista_activo = '1' and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");
      /*
      if (count($arrresultado)==0){

         $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
          listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
            "lista                 
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 
            ",
            "lista_activo = '1' $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");


      }
      */

    
    foreach($arrresultado as $i=>$valor){
      
      $lista_id = utf8_encode($valor["lista_id"]);  
      $lista_nombre = utf8_encode($valor["lista_nombre"]);  
      $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
      $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
      $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
      $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  

      if ($elementoid==$lista_id){        
        $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";        
      }else{       
        $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
      }  
    }
  }

  if (count($arrresultado)==0 && $compania==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }else if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN VALORES</option>";
  }

  
 
  return $option;

}

function ListadoAlergias($cuentaseleccionada=null, $companiaseleccionada=null, $alergiamed_id=null){

  $fechaactual = formatoFechaHoraBd(1);    


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and alergiamedicamento.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and alergiamedicamento.cuenta_id = '$_COOKIE[idcuenta]' and alergiamedicamento.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if ($alergiamed_id!=""){
    $where .=" and alergiamedicamento.alergiamed_id = '$alergiamed_id' ";
    $wherefecha = "";
  }

  


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("

   alergiamedicamento.alergiamed_id, alergiamedicamento.alergiamed_nombre, 
   alergiamedicamento.l_familiamed_id,
   alergiamedicamento.alergiamed_activo, alergiamedicamento.alergiamed_eliminado, 
   alergiamedicamento.cuenta_id, alergiamedicamento.compania_id,
    DATE_FORMAT(alergiamedicamento.alergiamed_fechareg,'%d/%m/%Y %H:%i:%s') as alergiamed_fechareg,

    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre,

    familiamedicamento.lista_nombre as familiamedicamento_nombre
    ",
    "alergiamedicamento
        inner join usuario cuenta on cuenta.usuario_id = alergiamedicamento.cuenta_id
        inner join compania on compania.compania_id = alergiamedicamento.compania_id  
        left join lista familiamedicamento on familiamedicamento.lista_id = alergiamedicamento.l_familiamed_id
    ",
    "alergiamed_eliminado = '0' $where ", null, "alergiamedicamento.alergiamed_nombre asc");

  if ($alergiamed_id!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $familiamedicamento_nombre = utf8_encode($valor["familiamedicamento_nombre"]);

    $alergiamed_id = utf8_encode($valor["alergiamed_id"]);
    $alergiamed_nombre = utf8_encode($valor["alergiamed_nombre"]);
    $l_familiamed_id = utf8_encode($valor["l_familiamed_id"]);
    $alergiamed_activo = utf8_encode($valor["alergiamed_activo"]);
    $alergiamed_fechareg = utf8_encode($valor["alergiamed_fechareg"]);    
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    

    if ($alergiamed_activo=="0"){
      $activo = "<i onclick='cambiarestatusalergiamedicamento(\"".$alergiamed_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusalergiamedicamento(\"".$alergiamed_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminaralergiamedicamento(\"".$alergiamed_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='modificaralergiamedicamento?id=$alergiamed_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    
    
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
          <tr style='font-size: 14px'>            
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
            <td>$alergiamed_id</td>  
            <td>$alergiamed_nombre</td>  
            <td>$familiamedicamento_nombre</td>  
            <td>$alergiamed_fechareg</td>              
            <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}

function ObtenerListaFamiliaMedicamnetos($tipolista_id=null, $cuenta=null, $compania=null, $medicamento_id=null){

    if ($ordenar=="entero"){
      $orderby = "CAST(lista.lista_nombre AS UNSIGNED)";
    }else{
      $orderby = "lista.lista_orden, lista_nombre";
    }



    $conexion = new ConexionBd();  

    session_start();
    $_COOKIE[perfil] = $_COOKIE[perfil];
    $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
    $_COOKIE[idcompania] = $_COOKIE[idcompania];

    //$option = "<option value=''>-- Seleccione --</option>";

    if ($listaid_rel!=""){
      $wherelistarel = " and lista.lista_idrel = '$listaid_rel' ";
    }

    /*
       inner join listacuentarel on listacuentarel.lista_id = lista.lista_id and listacuentarel.cuenta_id ='$cuenta' 
                  and listacuentarel.compania_id = '$compania' and listacuentarel.tipolista_id = '$tipolista_id' 
                  and listacuentarel_activo = '1'
    */

    if ($_COOKIE[perfil]=="1"){

    }else if ($_COOKIE[perfil]=="2"){

    }else{ 

      
    }

    $innerjoin = "
        
      ";

    /*
    SELECT medicamentoefecto_id, medicamento_id, medicamentoefecto_frecuente, medicamentoefecto_ocasional, medicamentoefecto_raro, medicamentoefecto_fechareg, medicamentoefecto_activo, medicamentoefecto_eliminado, l_tipo_id FROM medicamentoefectos WHERE 1
*/


    if ($cuenta!="" ){

      
        $arrresultado = $conexion->doSelect("lista.lista_id, lista.lista_nombre, listacuenta_id, lista.lista_activo, 
          listacuenta_activo, listacuenta_nombre, listacuenta_nombredos, familiamedrel_id ",
              "lista            



                  left join familiamedicamentorel on familiamedicamentorel.familiamed_id = lista.lista_id and familiamedrel_activo = '1' and familiamedicamentorel.medicamento_id = '$medicamento_id'


                  left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                  and listacuenta.compania_id = '$compania'  and listacuenta_activo = '1'




              ",
              "lista.lista_activo = '1' $wherelistabuscar and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista.lista_ppal = '1') or (lista.lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "$orderby asc");
     

        if (count($arrresultado)==0){

           $arrresultado = $conexion->doSelect("lista.lista_id, lista.lista_nombre, listacuenta_id, 
            listacuenta_activo, listacuenta_nombre, listacuenta_nombredos, familiamedrel_id",
              "lista             

                  left join familiamedicamentorel on familiamedicamentorel.familiamed_id = lista.lista_id and familiamedrel_activo = '1' and familiamedicamentorel.medicamento_id = '$medicamento_id'

                  left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                  and listacuenta.compania_id = '$compania' and listacuenta_activo = '1'

              ",
              "lista.lista_activo = '1' $wherelistabuscar $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista.lista_ppal = '1') or (lista.lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "$orderby asc");


        }

      
      foreach($arrresultado as $i=>$valor){

        $familiamedrel_id = utf8_encode($valor["familiamedrel_id"]);  
        $lista_id = utf8_encode($valor["lista_id"]);  
        $lista_nombre = utf8_encode($valor["lista_nombre"]);  
        $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
        $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
        $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
        $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  

        if ($listacuenta_id!=""){
          if ($listacuenta_activo=="1"){
            if ($familiamedrel_id!=""){
                $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
            }else{
                $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
            }    
          }
        }else{
          if ($familiamedrel_id!=""){
              $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
          }else{
              $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
          }    
        }  
      }
    }
    
    if (count($arrresultado)==0 && $compania==""){
      $option = "<option  value=''>Seleccione Primero la Compañia</option>";
    }else if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN VALORES</option>";
    }
    /*

    if (count($arrresultado)==1 && $nomarcardefecto!="1"){
      $option = "<option selected='selected' value='$lista_id'>$lista_nombre $agregardespues</option>";
    }*/

   

    /*
    
    $arrresultado = $conexion->doSelect("lista_id, lista_nombre","lista ",
              "lista_activo = '1' and tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and cuenta_id ='$cuenta' and compania_id = '$compania'))  ", null, "lista_nombre asc");

    $option = "<option value='0'>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $lista_id = utf8_encode($valor["lista_id"]);  
      $lista_nombre = utf8_encode($valor["lista_nombre"]);  

      if ($elementoid==$lista_id){
          $option .= "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
      }else{
          $option .= "<option value='$lista_id'>$lista_nombre</option>";
      }
    }

    if (count($arrresultado)==1){
      $option = "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
    }

    */

    return $option;

}

function ObtenerListaPatologiaCondicionante($cuentaseleccionada=null, $companiaseleccionada=null, $patologia_id=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and patologia.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and patologia.cuenta_id = '$_COOKIE[idcuenta]' and patologia.compania_id = '$_COOKIE[idcompania]' ";

  } 


  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($patologia_id!=""){
    $where .= " and patologia.patologia_id = '$patologia_id' ";
  }


  $arrresultado = $conexion->doSelect("

    patologia.patologia_id, patologia.patologia_nombre, patologia.patologia_descrip, 
    patologia.patologia_observ, 
    patologia.patologia_medicasnofarm, patologia.patologia_fechareg, 
    patologia.patologia_activo, patologia.patologia_eliminado, 
    patologia.cuenta_id, patologia.compania_id,

    patologiacondicion.patologiacond_id, patologiacondicion.patologiacond_nombre, 
    patologiacondicion.patologiacond_edadmin, patologiacondicion.patologiacond_edadmax, 
    patologiacondicion.patologiacond_activo, 
    patologiacondicion.patologiacond_eliminado, 
    DATE_FORMAT(patologiacondicion.patologiacond_fechareg,'%d/%m/%Y %H:%i:%s') as patologiacond_fechareg,

    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre
    ",
    "patologia
        inner join usuario cuenta on cuenta.usuario_id = patologia.cuenta_id
        inner join compania on compania.compania_id = patologia.compania_id                 
        inner join patologiacondicion on patologiacondicion.patologia_id = patologia.patologia_id 
        and patologiacond_activo = '1'       
    ",
    "patologia_eliminado = '0' $where", null, "patologia.patologia_nombre asc");

    //and patologia.patologia_id = '$patologia_id'

    $option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $patologiacond_id = utf8_encode($valor["patologiacond_id"]);
      $patologiacond_nombre = utf8_encode($valor["patologiacond_nombre"]);      

       if ($idseleccionado==$patologiacond_id){
          $option .= "<option selected='selected' value='$patologiacond_id'>$patologiacond_nombre</option>";
      }else{
          $option .= "<option value='$patologiacond_id'>$patologiacond_nombre</option>";
      }
    }


    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN CAMPOS</option>";
    }

  return $option;

}


function ObtenerListaMedicamentos($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and medicamento.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and medicamento.cuenta_id = '$_COOKIE[idcuenta]' and medicamento.compania_id = '$_COOKIE[idcompania]' ";

  } 


  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("
    medicamento_id, medicamento_nombre
    ",
    "medicamento
        inner join usuario cuenta on cuenta.usuario_id = medicamento.cuenta_id
        inner join compania on compania.compania_id = medicamento.compania_id         
    ",
    "medicamento_eliminado = '0' $where  ", null, "medicamento.medicamento_nombre asc");

    $option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $medicamento_id = utf8_encode($valor["medicamento_id"]);
      $medicamento_nombre = utf8_encode($valor["medicamento_nombre"]);      

       if ($idseleccionado==$medicamento_id){
          $option .= "<option selected='selected' value='$medicamento_id'>$medicamento_nombre</option>";
      }else{
          $option .= "<option value='$medicamento_id'>$medicamento_nombre</option>";
      }
    }


    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN CAMPOS</option>";
    }

  return $option;

}


function ListadoPatologiasTratamiento($cuentaseleccionada=null, $companiaseleccionada=null, $patologia_id=null, $patologiatrata_id=null){

  $fechaactual = formatoFechaHoraBd(1);    


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and patologia.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and patologia.cuenta_id = '$_COOKIE[idcuenta]' and patologia.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if ($patologiatrata_id!=""){
    $where .=" and patologiatratamiento.patologiatrata_id = '$patologiatrata_id' ";
  }


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("

    patologia.patologia_id, patologia.patologia_nombre, patologia.patologia_descrip, 
    patologia.patologia_observ, 
    patologia.patologia_medicasnofarm, patologia.patologia_fechareg, 
    patologia.patologia_activo, patologia.patologia_eliminado, 
    patologia.cuenta_id, patologia.compania_id,

    patologiacondicion.patologiacond_id, patologiacondicion.patologiacond_nombre, 
    patologiacondicion.patologiacond_edadmin, patologiacondicion.patologiacond_edadmax, 
    patologiacondicion.patologiacond_activo, 
    patologiacondicion.patologiacond_eliminado, 
    DATE_FORMAT(patologiacondicion.patologiacond_fechareg,'%d/%m/%Y %H:%i:%s') as patologiacond_fechareg,

    patologiatratamiento.patologiatrata_id, patologiatratamiento.patologia_id, patologiatratamiento.medicamento_id,
    patologiatratamiento.patologiatrata_pauta, patologiatratamiento.patologiatrata_gr,     
    patologiatratamiento.patologiatrata_activo, patologiatratamiento.patologiatrata_eliminado,     
    DATE_FORMAT(patologiatratamiento.patologiatrata_fechareg,'%d/%m/%Y %H:%i:%s') as patologiatrata_fechareg,

    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre,

    medicamento_nombre
    ",
    "patologia
        inner join usuario cuenta on cuenta.usuario_id = patologia.cuenta_id
        inner join compania on compania.compania_id = patologia.compania_id         
        inner join patologiatratamiento on patologiatratamiento.patologia_id = patologia.patologia_id
        left join patologiacondicion on patologiacondicion.patologiacond_id = patologiatratamiento.patologiacond_id
        left join medicamento on medicamento.medicamento_id = patologiatratamiento.medicamento_id
    ",
    "patologia_eliminado = '0' and patologia.patologia_id = '$patologia_id' and patologiatrata_eliminado = '0' $where", null, "patologia.patologia_nombre asc");

  if ($patologiatrata_id!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $medicamento_nombre = utf8_encode($valor["medicamento_nombre"]);

    $patologiatrata_id = utf8_encode($valor["patologiatrata_id"]);
    $medicamento_id = utf8_encode($valor["medicamento_id"]);
    $patologiatrata_pauta = utf8_encode($valor["patologiatrata_pauta"]);
    $patologiatrata_gr = utf8_encode($valor["patologiatrata_gr"]);
    $patologiacondicion_id = utf8_encode($valor["patologiacondicion_id"]);
    $patologiatrata_activo = utf8_encode($valor["patologiatrata_activo"]);
    $patologiatrata_fechareg = utf8_encode($valor["patologiatrata_fechareg"]);

    $patologiacond_nombre = utf8_encode($valor["patologiacond_nombre"]);
    $patologiacond_edadmin = utf8_encode($valor["patologiacond_edadmin"]);
    $patologiacond_edadmax = utf8_encode($valor["patologiacond_edadmax"]);
    $patologiacond_fechareg = utf8_encode($valor["patologiacond_fechareg"]);
    $patologiacond_activo = utf8_encode($valor["patologiacond_activo"]);    

    $patologia_id = utf8_encode($valor["patologia_id"]);
    $patologia_nombre = utf8_encode($valor["patologia_nombre"]);
    $patologia_descrip = utf8_encode($valor["patologia_descrip"]);
    $patologia_observ = utf8_encode($valor["patologia_observ"]);
    $patologia_medicasnofarm = utf8_encode($valor["patologia_medicasnofarm"]);
    $patologia_fechareg = utf8_encode($valor["patologia_fechareg"]);
    $patologia_activo = utf8_encode($valor["patologia_activo"]);
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    

    if ($patologiatrata_activo=="0"){
      $activo = "<i onclick='cambiarestatuspatologiatratamiento(\"".$patologiatrata_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspatologiatratamiento(\"".$patologiatrata_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpatologiatratamiento(\"".$patologiatrata_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='modificarpatologiatratamiento?p=$patologia_id&id=$patologiatrata_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    
    
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
          <tr style='font-size: 14px'>            
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
            <td>$patologiatrata_id</td>  
            <td>$patologia_nombre</td>  
            <td>$medicamento_nombre</td>  
            <td>$patologiacond_nombre</td>  
            <td>$patologiatrata_pauta</td>              
            <td>$patologiatrata_fechareg</td>              
            <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}

function ObtenerListaPatologia($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and patologia.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and patologia.cuenta_id = '$_COOKIE[idcuenta]' and patologia.compania_id = '$_COOKIE[idcompania]' ";

  } 


  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("

    patologia.patologia_id, patologia.patologia_nombre
    ",
    "patologia
        inner join usuario cuenta on cuenta.usuario_id = patologia.cuenta_id
        inner join compania on compania.compania_id = patologia.compania_id         
    ",
    "patologia_eliminado = '0' $where  ", null, "patologia.patologia_nombre asc");

    $option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $patologia_id = utf8_encode($valor["patologia_id"]);
      $patologia_nombre = utf8_encode($valor["patologia_nombre"]);      

       if ($idseleccionado==$patologia_id){
          $option .= "<option selected='selected' value='$patologia_id'>$patologia_nombre</option>";
      }else{
          $option .= "<option value='$patologia_id'>$patologia_nombre</option>";
      }
    }


    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN CAMPOS</option>";
    }

  return $option;

}


function ListadoPatologiasCondicion($cuentaseleccionada=null, $companiaseleccionada=null, $patologia_id=null, $patologiacond_id=null){

  $fechaactual = formatoFechaHoraBd(1);    


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and patologia.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and patologia.cuenta_id = '$_COOKIE[idcuenta]' and patologia.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if ($patologiacond_id!=""){
    $where .=" and patologiacondicion.patologiacond_id = '$patologiacond_id' ";
    $wherefecha = "";
  }

  

  


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("

    patologia.patologia_id, patologia.patologia_nombre, patologia.patologia_descrip, 
    patologia.patologia_observ, 
    patologia.patologia_medicasnofarm, patologia.patologia_fechareg, 
    patologia.patologia_activo, patologia.patologia_eliminado, 
    patologia.cuenta_id, patologia.compania_id,

    patologiacondicion.patologiacond_id, patologiacondicion.patologiacond_nombre, 
    patologiacondicion.patologiacond_edadmin, patologiacondicion.patologiacond_edadmax, 
    patologiacondicion.patologiacond_activo, 
    patologiacondicion.patologiacond_eliminado, 
    DATE_FORMAT(patologiacondicion.patologiacond_fechareg,'%d/%m/%Y %H:%i:%s') as patologiacond_fechareg,

    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre
    ",
    "patologia
        inner join usuario cuenta on cuenta.usuario_id = patologia.cuenta_id
        inner join compania on compania.compania_id = patologia.compania_id         
        inner join patologiacondicion on patologiacondicion.patologia_id = patologia.patologia_id
    ",
    "patologia_eliminado = '0' and patologia.patologia_id = '$patologia_id' and patologiacond_eliminado = '0' $where", null, "patologia.patologia_nombre asc");

  if ($patologiacond_id!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $patologiacond_id = utf8_encode($valor["patologiacond_id"]);
    $patologiacond_nombre = utf8_encode($valor["patologiacond_nombre"]);
    $patologiacond_edadmin = utf8_encode($valor["patologiacond_edadmin"]);
    $patologiacond_edadmax = utf8_encode($valor["patologiacond_edadmax"]);
    $patologiacond_fechareg = utf8_encode($valor["patologiacond_fechareg"]);
    $patologiacond_activo = utf8_encode($valor["patologiacond_activo"]);
    

    $patologia_id = utf8_encode($valor["patologia_id"]);
    $patologia_nombre = utf8_encode($valor["patologia_nombre"]);
    $patologia_descrip = utf8_encode($valor["patologia_descrip"]);
    $patologia_observ = utf8_encode($valor["patologia_observ"]);
    $patologia_medicasnofarm = utf8_encode($valor["patologia_medicasnofarm"]);
    $patologia_fechareg = utf8_encode($valor["patologia_fechareg"]);
    $patologia_activo = utf8_encode($valor["patologia_activo"]);
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    

    if ($patologiacond_activo=="0"){
      $activo = "<i onclick='cambiarestatuspatologiacondicion(\"".$patologiacond_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspatologiacondicion(\"".$patologiacond_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpatologiacondicion(\"".$patologiacond_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='modificarpatologiacondicion?p=$patologia_id&id=$patologiacond_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    
    
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
          <tr style='font-size: 14px'>            
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
            <td>$patologiacond_id</td>  
            <td>$patologia_nombre</td>  
            <td>$patologiacond_nombre</td>  
            <td>$patologiacond_edadmin / $patologiacond_edadmax</td>              
            <td>$patologiacond_fechareg</td>              
            <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}

function ObtenerGrupoPatologia($tipolista_id=null, $cuenta=null, $compania=null, $elementoid=null){

    if ($ordenar=="entero"){
      $orderby = "CAST(lista.lista_nombre AS UNSIGNED)";
    }else{
      $orderby = "lista.lista_orden, lista_nombre";
    }

    $conexion = new ConexionBd();  

    session_start();
    $_COOKIE[perfil] = $_COOKIE[perfil];
    $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
    $_COOKIE[idcompania] = $_COOKIE[idcompania];

    //$option = "<option value=''>-- Seleccione --</option>";

    if ($listaid_rel!=""){
      $wherelistarel = " and lista.lista_idrel = '$listaid_rel' ";
    }

    /*
       inner join listacuentarel on listacuentarel.lista_id = lista.lista_id and listacuentarel.cuenta_id ='$cuenta' 
                  and listacuentarel.compania_id = '$compania' and listacuentarel.tipolista_id = '$tipolista_id' 
                  and listacuentarel_activo = '1'
    */

    if ($_COOKIE[perfil]=="1"){

    }else if ($_COOKIE[perfil]=="2"){

    }else{ 

      
    }

    $innerjoin = "
        
      ";

    /*
    SELECT medicamentoefecto_id, medicamento_id, medicamentoefecto_frecuente, medicamentoefecto_ocasional, medicamentoefecto_raro, medicamentoefecto_fechareg, medicamentoefecto_activo, medicamentoefecto_eliminado, l_tipo_id FROM medicamentoefectos WHERE 1
*/


    if ($cuenta!="" ){

      
        $arrresultado = $conexion->doSelect("lista.lista_id, lista.lista_nombre, listacuenta_id, lista.lista_activo, 
          listacuenta_activo, listacuenta_nombre, listacuenta_nombredos, patologiagruporel_id ",
              "lista            
                
                  left join patologiagruporel on patologiagruporel.patologiagrupo_id = lista.lista_id and patologiagruporel_activo = '1' and patologiagruporel.patologia_id = '$elementoid'


                  left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                  and listacuenta.compania_id = '$compania'  and listacuenta_activo = '1'




              ",
              "lista.lista_activo = '1' $wherelistabuscar and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista.lista_ppal = '1') or (lista.lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "$orderby asc");
     

        if (count($arrresultado)==0){

           $arrresultado = $conexion->doSelect("lista.lista_id, lista.lista_nombre, listacuenta_id, 
            listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
              "lista                 

                  left join patologiagruporel on patologiagruporel.patologiagrupo_id = lista.lista_id and patologiagruporel_activo = '1'  and patologiagruporel.patologia_id = '$elementoid'

                  left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                  and listacuenta.compania_id = '$compania' and listacuenta_activo = '1'

              ",
              "lista.lista_activo = '1' $wherelistabuscar $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista.lista_ppal = '1') or (lista.lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "$orderby asc");


        }

      
      foreach($arrresultado as $i=>$valor){

        $patologiagruporel_id = utf8_encode($valor["patologiagruporel_id"]);  

        $lista_id = utf8_encode($valor["lista_id"]);  
        $lista_nombre = utf8_encode($valor["lista_nombre"]);  
        $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
        $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
        $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
        $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  

        if ($listacuenta_id!=""){
          if ($listacuenta_activo=="1"){
            if ($patologiagruporel_id!=""){
                $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
            }else{
                $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
            }    
          }
        }else{
          if ($patologiagruporel_id!=""){
              $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
          }else{
              $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
          }    
        }  
      }
    }
    
    if (count($arrresultado)==0 && $compania==""){
      $option = "<option  value=''>Seleccione Primero la Compañia</option>";
    }else if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN VALORES</option>";
    }
    /*
    if (count($arrresultado)==1 && $nomarcardefecto!="1"){
      $option = "<option selected='selected' value='$lista_id'>$lista_nombre $agregardespues</option>";
    }
*/
   

    /*
    
    $arrresultado = $conexion->doSelect("lista_id, lista_nombre","lista ",
              "lista_activo = '1' and tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and cuenta_id ='$cuenta' and compania_id = '$compania'))  ", null, "lista_nombre asc");

    $option = "<option value='0'>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $lista_id = utf8_encode($valor["lista_id"]);  
      $lista_nombre = utf8_encode($valor["lista_nombre"]);  

      if ($elementoid==$lista_id){
          $option .= "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
      }else{
          $option .= "<option value='$lista_id'>$lista_nombre</option>";
      }
    }

    if (count($arrresultado)==1){
      $option = "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
    }

    */

    return $option;

  }


function ListadoPatologias($cuentaseleccionada=null, $companiaseleccionada=null, $patologia_id=null){

  $fechaactual = formatoFechaHoraBd(1);    


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and patologia.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and patologia.cuenta_id = '$_COOKIE[idcuenta]' and patologia.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if ($patologia_id!=""){
    $where .=" and patologia.patologia_id = '$patologia_id' ";
    $wherefecha = "";
  }

  


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("

    patologia.patologia_id, patologia.patologia_nombre, patologia.patologia_descrip, 
    patologia.patologia_observ, 
    patologia.patologia_medicasnofarm, 
    patologia.patologia_activo, patologia.patologia_eliminado, 
    patologia.cuenta_id, patologia.compania_id,
    DATE_FORMAT(patologia.patologia_fechareg,'%d/%m/%Y %H:%i:%s') as patologia_fechareg,

    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre
    ",
    "patologia
        inner join usuario cuenta on cuenta.usuario_id = patologia.cuenta_id
        inner join compania on compania.compania_id = patologia.compania_id         
    ",
    "patologia_eliminado = '0' $where $wherefecha ", null, "patologia.patologia_nombre asc");

  if ($patologia_id!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $patologia_id = utf8_encode($valor["patologia_id"]);
    $patologia_nombre = utf8_encode($valor["patologia_nombre"]);
    $patologia_descrip = utf8_encode($valor["patologia_descrip"]);
    $patologia_observ = utf8_encode($valor["patologia_observ"]);
    $patologia_medicasnofarm = utf8_encode($valor["patologia_medicasnofarm"]);
    $patologia_fechareg = utf8_encode($valor["patologia_fechareg"]);
    $patologia_activo = utf8_encode($valor["patologia_activo"]);
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    

    if ($patologia_activo=="0"){
      $activo = "<i onclick='cambiarestatuspatologia(\"".$patologia_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspatologia(\"".$patologia_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpatologia(\"".$patologia_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='modificarpatologia?id=$patologia_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $condicionantes = "<a href='patologiacondicion?id=$patologia_id'>Ver</a>";

    $tratamientos = "<a href='patologiatratamiento?id=$patologia_id'>Ver</a>";

    
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
          <tr style='font-size: 14px'>            
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
            <td>$patologia_id</td>  
            <td>$patologia_nombre</td>  
            <td style='text-align: center'>$condicionantes</td>  
            <td style='text-align: center'>$tratamientos</td>  
            <td>$patologia_fechareg</td>              
            <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}

function ObtenerListaEfectosSecundarios($tipolista_id=null, $cuenta=null, $compania=null, $elementoid=null, $tipocodigo=null){

    if ($ordenar=="entero"){
      $orderby = "CAST(lista.lista_nombre AS UNSIGNED)";
    }else{
      $orderby = "lista.lista_orden, lista_nombre";
    }



    $conexion = new ConexionBd();  

    session_start();
    $_COOKIE[perfil] = $_COOKIE[perfil];
    $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
    $_COOKIE[idcompania] = $_COOKIE[idcompania];

    //$option = "<option value=''>-- Seleccione --</option>";

    if ($listaid_rel!=""){
      $wherelistarel = " and lista.lista_idrel = '$listaid_rel' ";
    }

    /*
       inner join listacuentarel on listacuentarel.lista_id = lista.lista_id and listacuentarel.cuenta_id ='$cuenta' 
                  and listacuentarel.compania_id = '$compania' and listacuentarel.tipolista_id = '$tipolista_id' 
                  and listacuentarel_activo = '1'
    */

    if ($_COOKIE[perfil]=="1"){

    }else if ($_COOKIE[perfil]=="2"){

    }else{ 

      
    }

    $innerjoin = "
        
      ";

    /*
    SELECT medicamentoefecto_id, medicamento_id, medicamentoefecto_frecuente, medicamentoefecto_ocasional, medicamentoefecto_raro, medicamentoefecto_fechareg, medicamentoefecto_activo, medicamentoefecto_eliminado, l_tipo_id FROM medicamentoefectos WHERE 1
*/


    if ($cuenta!="" ){

      
        $arrresultado = $conexion->doSelect("lista.lista_id, lista.lista_nombre, listacuenta_id, lista.lista_activo, 
          listacuenta_activo, listacuenta_nombre, listacuenta_nombredos, medicamentoefecto_id, listacuenta_eliminado ",
              "lista            


                  inner join listaefectomedicamento on listaefectomedicamento.lista_id = lista.lista_id
                  and listaefectomedicamento_activo = '1' 

                  inner join lista tipoefectomedicamento on tipoefectomedicamento.lista_id = listaefectomedicamento.l_tipo_id
                  and tipoefectomedicamento.lista_cod = '$tipocodigo'

                  left join medicamentoefectos on medicamentoefectos.lista_id = lista.lista_id and medicamentoefecto_activo = '1'
                  and medicamentoefectos.medicamento_id = '$elementoid'


                  left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                  and listacuenta.compania_id = '$compania'  and listacuenta_activo = '1'




              ",
              "lista.lista_activo = '1' $wherelistabuscar and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista.lista_ppal = '1') or (lista.lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "$orderby asc");
/*
        if ($tipolista_id=="231"){

          echo "<pre>";
          print_r($arrresultado);
          echo "</pre>";
          exit();

        }*/
     
        /*
        if (count($arrresultado)==0){

           $arrresultado = $conexion->doSelect("lista.lista_id, lista.lista_nombre, listacuenta_id, 
            listacuenta_activo, listacuenta_nombre, listacuenta_nombredos, listacuenta_eliminado",
              "lista             

                  inner join listaefectomedicamento on listaefectomedicamento.lista_id = lista.lista_id
                  and listaefectomedicamento_activo = '1' 

                  inner join lista tipoefectomedicamento on tipoefectomedicamento.lista_id = listaefectomedicamento.l_tipo_id
                  and tipoefectomedicamento.lista_cod = '$tipocodigo'

                  left join medicamentoefectos on medicamentoefectos.lista_id = lista.lista_id and medicamentoefecto_activo = '1'
                  and medicamentoefectos.medicamento_id = '$elementoid'

                  left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                  and listacuenta.compania_id = '$compania' and listacuenta_activo = '1'

              ",
              "lista.lista_activo = '1' $wherelistabuscar $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista.lista_ppal = '1') or (lista.lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "$orderby asc");


        }
      */
      
      foreach($arrresultado as $i=>$valor){

        $medicamentoefecto_id = utf8_encode($valor["medicamentoefecto_id"]);  
        $lista_id = utf8_encode($valor["lista_id"]);  
        $lista_nombre = utf8_encode($valor["lista_nombre"]);  
        $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
        $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
        $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
        $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  
        $listacuenta_eliminado = utf8_encode($valor["listacuenta_eliminado"]);  

        if ($listacuenta_eliminado=="1"){
          continue;
        }

        if ($listacuenta_id!=""){
          if ($listacuenta_activo=="1"){
            if ($medicamentoefecto_id!=""){
                $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
            }else{
                $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
            }    
          }
        }else{
          if ($medicamentoefecto_id!=""){
              $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
          }else{
              $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
          }    
        }  
      }
    }
    
    if (count($arrresultado)==0 && $compania==""){
      $option = "<option  value=''>Seleccione Primero la Compañia</option>";
    }else if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN VALORES</option>";
    }
    /*

    if (count($arrresultado)==1 && $nomarcardefecto!="1"){
      $option = "<option selected='selected' value='$lista_id'>$lista_nombre $agregardespues</option>";
    }*/

   

    /*
    
    $arrresultado = $conexion->doSelect("lista_id, lista_nombre","lista ",
              "lista_activo = '1' and tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and cuenta_id ='$cuenta' and compania_id = '$compania'))  ", null, "lista_nombre asc");

    $option = "<option value='0'>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $lista_id = utf8_encode($valor["lista_id"]);  
      $lista_nombre = utf8_encode($valor["lista_nombre"]);  

      if ($elementoid==$lista_id){
          $option .= "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
      }else{
          $option .= "<option value='$lista_id'>$lista_nombre</option>";
      }
    }

    if (count($arrresultado)==1){
      $option = "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
    }

    */

    return $option;

  }

function ObtenerListaMedicamentosEfectos($cuentaseleccionada=null, $companiaseleccionada=null, $proceso_id=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];


    $arrresultado = $conexion->doSelect("



      medicamentoefecto_id, medicamento_id, medicamentoefecto_frecuente, 
      medicamentoefecto_ocasional, medicamentoefecto_raro, 
      medicamentoefecto_fechareg, medicamentoefecto_activo, medicamentoefecto_eliminado, l_tipo_id
      ",
      "medicamentoefectos            
        inner join usuario cuenta on cuenta.usuario_id = proceso.cuenta_id
        inner join compania on compania.compania_id = proceso.compania_id    
        inner join procesocampo on procesocampo.proceso_id = proceso.proceso_id       
      ",
      "proceso.proceso_eliminado = '0' and (procesocampo_idrel is null or procesocampo_idrel ='0')  and procesocampo_eliminado = '0' and proceso.proceso_id = '$proceso_id' and compania.compania_eliminado = '0' $where ", null, "procesocampo.procesocampo_nombre asc");

    $option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $procesocampo_id = utf8_encode($valor["procesocampo_id"]);
      $procesocampo_nombre = utf8_encode($valor["procesocampo_nombre"]);      

       if ($idseleccionado==$procesocampo_id){
          $option .= "<option selected='selected' value='$procesocampo_id'>$procesocampo_nombre</option>";
      }else{
          $option .= "<option value='$procesocampo_id'>$procesocampo_nombre</option>";
      }
    }

 
    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN CAMPOS</option>";
    }

    if (count($arrresultado)==1){
      $option = "<option selected='selected' value='$proceso_id'>$proceso_nombre</option>";
    } 
  
  

  return $option;

}


function ListadoMedicamentos($cuentaseleccionada=null, $companiaseleccionada=null, $medicamento_id=null, $getestatus=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and medicamento.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and medicamento.cuenta_id = '$_COOKIE[idcuenta]' and medicamento.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if ($medicamento_id!=""){
    $where .=" and medicamento.medicamento_id = '$medicamento_id' ";
    $wherefecha = "";
  }


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("

    medicamento.medicamento_id, medicamento.medicamento_nombre, 
    medicamento.l_tipoviamedicamento_id, medicamento.medicamento_descrip, 
    medicamento.medicamento_recomendacion, medicamento.medicamento_precaucion, 
    medicamento.medicamento_interaccion, medicamento.medicamento_monitorizacion, 
    medicamento.medicamento_criterio, medicamento.medicamento_activo, 
    medicamento.medicamento_eliminado, 
    DATE_FORMAT(medicamento.medicamento_fechareg,'%d/%m/%Y %H:%i:%s') as medicamento_fechareg,
    medicamento.cuenta_id, medicamento.compania_id, medicamento.medicamento_img,
    tipotomamedicamento.lista_nombre as tipotomamedicamento_nombre,
    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre

    ",
    "medicamento
        inner join usuario cuenta on cuenta.usuario_id = medicamento.cuenta_id
        inner join compania on compania.compania_id = medicamento.compania_id         
        inner join lista tipotomamedicamento on tipotomamedicamento.lista_id = medicamento.l_tipoviamedicamento_id
        
    ",
    "medicamento_eliminado = '0' $where ", null, "medicamento.medicamento_nombre asc");

  if ($medicamento_id!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $medicamento_img = utf8_encode($valor["medicamento_img"]);
    $medicamento_id = utf8_encode($valor["medicamento_id"]);
    $medicamento_nombre = utf8_encode($valor["medicamento_nombre"]);
    $l_tipoviamedicamento_id = utf8_encode($valor["l_tipoviamedicamento_id"]);
    $medicamento_descrip = utf8_encode($valor["medicamento_descrip"]);
    $medicamento_recomendacion = utf8_encode($valor["medicamento_recomendacion"]);
    $medicamento_precaucion = utf8_encode($valor["medicamento_precaucion"]);
    $medicamento_interaccion = utf8_encode($valor["medicamento_interaccion"]);
    $medicamento_monitorizacion = utf8_encode($valor["medicamento_monitorizacion"]);
    $medicamento_criterio = utf8_encode($valor["medicamento_criterio"]);
    $medicamento_activo = utf8_encode($valor["medicamento_activo"]);
    $medicamento_fechareg = utf8_encode($valor["medicamento_fechareg"]);
    $tipotomamedicamento_nombre = utf8_encode($valor["tipotomamedicamento_nombre"]);
   
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    

    if ($medicamento_activo=="0"){
      $activo = "<i onclick='cambiarestatusmedicamento(\"".$medicamento_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusmedicamento(\"".$medicamento_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarmedicamento(\"".$medicamento_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='modificarmedicamento?id=$medicamento_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

     $imagen = "
    <a href='modificarmedicamento?id=$medicamento_id'>
      <img src='arch//$medicamento_img' style='height: 50px; width: 50ox' />
    </a>";

    $efectos = "
    <a href='medicamentoefectos?id=$medicamento_id'>
      Ver
    </a>";

    $contraindicaciones = "
    <a href='medicamentocontraindicaciones?id=$medicamento_id'>
      Ver
    </a>";
    

    

    
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
          <tr style='font-size: 14px'>            
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
            <td>$medicamento_id</td>  
            <td>$medicamento_nombre</td>  
            <td>$imagen</td>  
            <td>$tipotomamedicamento_nombre</td>              
            <td style='text-align: center'>$medicamento_fechareg</td>   
            <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}

function ListadoCitas($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $getdate=null, $cita_id=null, $getestatus=null, $paciente_id=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (cita.cita_fecha BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (cita.cita_fecha BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (cita.cita_fecha > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (cita.cita_fecha BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and cita.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and cita.cuenta_id = '$_COOKIE[idcuenta]' and cita.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if ($cita_id!=""){
    $where .=" and cita.cita_id = '$cita_id' ";
    $wherefecha = "";
  }

  if ($getestatus!=""){
    $where .=" and cita.l_estatuscita_id = '$getestatus' ";    
  }

  if ($paciente_id!=""){
    $where .=" and cita.cliente_id = '$paciente_id' ";
    $wherefecha = "";
  }

  

  


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("

    cita.cita_id, cita.cita_descrip, cita.usuario_id, cita.cliente_id, 
    cita.l_estatuscita_id, cita.cita_siguiente, 
    cita.cita_programada, cita.cita_activo, 
    cita.cita_eliminado, cita.cuenta_id, cita.compania_id, cita.sucursal_id,
    DATE_FORMAT(cita.cita_fecha,'%d/%m/%Y') as cita_fecha,    
    DATE_FORMAT(cita.cita_fechareg,'%d/%m/%Y %H:%i:%s') as cita_fechareg,
    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre, sucursal_nombre,         
    estatus.lista_nombre as estatus_nombre,
    cliente.usuario_nombre as cliente_nombre, cliente.usuario_apellido as cliente_apellido,
    medico.usuario_nombre as medico_nombre, medico.usuario_apellido as medico_apellido

    ",
    "cita
        inner join usuario cuenta on cuenta.usuario_id = cita.cuenta_id
        inner join compania on compania.compania_id = cita.compania_id 
        inner join sucursal on sucursal.sucursal_id = cita.sucursal_id
        inner join lista estatus on estatus.lista_id = cita.l_estatuscita_id
        inner join usuario cliente on cliente.usuario_id = cita.cliente_id
        inner join usuario medico on medico.usuario_id = cita.usuario_id        
    ",
    "cita_eliminado = '0' $where $wherefecha ", null, "cita.cita_id desc");

  if ($cita_id!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $cita_id = utf8_encode($valor["cita_id"]);
    $cita_descrip = utf8_encode($valor["cita_descrip"]);
    $usuario_id = utf8_encode($valor["usuario_id"]);
    $cliente_id = utf8_encode($valor["cliente_id"]);
    $l_estatuscita_id = utf8_encode($valor["l_estatuscita_id"]);
    $cita_siguiente = utf8_encode($valor["cita_siguiente"]);
    $cita_programada = utf8_encode($valor["cita_programada"]);
    $cita_fecha = utf8_encode($valor["cita_fecha"]);
    $cita_activo = utf8_encode($valor["cita_activo"]);
    $cita_fechareg = utf8_encode($valor["cita_fechareg"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
    $t_sucursal_id = utf8_encode($valor["sucursal_id"]);


    $cliente_nombre = utf8_encode($valor["cliente_nombre"]);
    $cliente_apellido = utf8_encode($valor["cliente_apellido"]);
    $cliente = $cliente_nombre." ".$cliente_apellido." ";

    $medico_nombre = utf8_encode($valor["medico_nombre"]);
    $medico_apellido = utf8_encode($valor["medico_apellido"]);
    $medico = $medico_nombre." ".$medico_apellido." ";

    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    $sucursal_nombre = utf8_encode($valor["sucursal_nombre"]);



    if ($cita_activo=="0"){
      $activo = "<i onclick='cambiarestatuscita(\"".$cita_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuscita(\"".$cita_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarcita(\"".$cita_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='modificarcita?id=$cita_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $gestionarcita = "<a href='gestionarcita?id=$cita_id'><i title='Gestionar Cita' class='fa fa-play btn-modificar'></i></a>";

    $gestionarcitatexto = "<a href='gestionarcita?id=$cita_id'>Gestionar Cita</a>";

    
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
          <tr style='font-size: 14px'>            
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
            <td>$cita_id</td>  
            <td>$gestionarcitatexto</td>  
            <td>$cliente</td>  
            <td>$medico</td>  
            <td>$sucursal_nombre</td>  
            <td>$cita_fecha</td>  
            <td>$estatus_nombre</td>  
            <td style='text-align: center'>$cita_fechareg</td>   
            <td style='text-align: center'>$gestionarcita &nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}

function unirCategorias($categ_nombre=null, $subcateg_nombre=null, $subcategdos_nombre=null){

  if ($categ_nombre!=""){
    $resultado = $categ_nombre;
  }

  if ($subcateg_nombre!=""){
    $resultado .= " / ". $subcateg_nombre;
  }

  if ($subcategdos_nombre!=""){
    $resultado .= " / ". $subcategdos_nombre;
  }

  return $resultado;

}

function verificarAlertaStockProductoML($prod_id=nul, $venta_idget=null){

  $fechaactual = formatoFechaHoraBd(1); 

  $instancialista = new Lista();
        
  $obtenerIdLista = 1;
  $obtenerTipoLista = 225;
  $stockaceptable = $instancialista->ObtenerIdLista($obtenerIdLista, $obtenerTipoLista);   

  $obtenerIdLista = 2;
  $obtenerTipoLista = 225;
  $faltastock = $instancialista->ObtenerIdLista($obtenerIdLista, $obtenerTipoLista);   

  $conexion = new ConexionBd(); 

  $arrresultado = $conexion->doSelect("producto.prod_id, producto.prod_stockmin, venta.venta_stock",
    "producto              
        inner join venta on venta.prod_id = producto.prod_id
    ",
    "producto.prod_eliminado = '0' and venta.venta_activo = '1' and producto.prod_id = '$prod_id'");

  foreach($arrresultado as $i=>$valor){

    $prod_id = utf8_encode($valor["prod_id"]);
    $prod_stockmin = utf8_encode($valor["prod_stockmin"]);
    $venta_stock = utf8_encode($valor["venta_stock"]);
    
    $stockcolocar = $stockaceptable;

    if ($venta_stock<=$prod_stockmin && $prod_stockmin>0){
      $stockcolocar = $faltastock;  
    }

    $resultado = $conexion->doUpdate("producto", "l_estatusprodstock_id = '$stockcolocar'", "prod_id='$prod_id'");

  } 


  $obtenerIdLista = 1;
  $obtenerTipoLista = 226;
  $dentrodelrango = $instancialista->ObtenerIdLista($obtenerIdLista, $obtenerTipoLista);   

  $obtenerIdLista = 2;
  $obtenerTipoLista = 226;
  $sobreventa = $instancialista->ObtenerIdLista($obtenerIdLista, $obtenerTipoLista);  
/*
  echo "prod_id:$prod_id";
    echo "<br>";
    echo "venta_idget:$venta_idget";
    echo "<br>";
     echo "venta_cantidad:$venta_cantidad";
    echo "<br>";
    echo "prod_ventasmaxalerta:$prod_ventasmaxalerta";
    echo "<br>";
    exit(); 

*/
  $arrresultado = $conexion->doSelect("prod_ventasmaxalerta, venta_cantidad",
    "producto              
        inner join venta on venta.prod_id = producto.prod_id
    ",
    "producto.prod_eliminado = '0' and venta.venta_activo = '1' and producto.prod_id = '$prod_id' and venta.venta_id = '$venta_idget'");

  foreach($arrresultado as $i=>$valor){

    $venta_cantidad = utf8_encode($valor["venta_cantidad"]);
    $prod_ventasmaxalerta = utf8_encode($valor["prod_ventasmaxalerta"]);
    
    $estatuscolocar = $dentrodelrango;

    if ($venta_cantidad>=$prod_ventasmaxalerta && $prod_ventasmaxalerta>0){
      $estatuscolocar = $sobreventa;  
    }



    $resultado = $conexion->doUpdate("venta", "l_estatusventamax_id = '$estatuscolocar'", "venta_id='$venta_idget'");

  } 




  return $resultado;  
}

function guardarPagoTransaccionPrestamoCuota($pago_id=null, $pagotransprestamo_id=null, $trans_id=null, $pagotransprestamocuota_monto =null, $transprestamocuota_id=null){

  $fechaactual = formatoFechaHoraBd(1);    

  $conexion = new ConexionBd(); 

  $resultado = $conexion->doInsert("
         pagotransaccionprestamocuota
         (pago_id, pagotransprestamo_id, trans_id, 
         pagotransprestamocuota_monto, transprestamocuota_id)
          ",
          "'$pago_id', '$pagotransprestamo_id', '$trans_id', 
          '$pagotransprestamocuota_monto', '$transprestamocuota_id'");

  return $resultado;  
}


function obtenerPrestamosDetalle($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $trans_id=null, $tipocod=null, $whelistabuscar=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($tipocod==""){$tipocod=2;}


  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (transaccion.trans_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($sinfiltrofecha=="1"){
    $wherefecha = "";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if($trans_id!=""){
    $where .= " and transaccion.trans_id = '$trans_id' ";
    $wherefecha = "";
  }

  if($getestatus!=""){
    $whereestatus = " and transaccion.l_estatus_id in ('$getestatus') ";
  }

  if($whelistabuscar!=""){
    $whelistabuscar = " and estatus.lista_cod in ($whelistabuscar) ";
  }







  $conexion = new ConexionBd(); 

  $arrresultado = $conexion->doSelect("transaccion.trans_id, trans_montototal, trans_codigo, 
      transaccion.compania_id, transaccion.l_moneda_id,  
      transaccion.l_formapago_id, transaccion.cliente_id,
      DATE_FORMAT(trans_fechareg,'%d/%m/%Y %H:%i:%s') as trans_fechareg, usuario_nombre, usuario_apellido, 
      compania_nombre, compania_cedula, compania_telf, 
      compania_email, compania_direccion, compania_razonsocial, 
      transaccion.sucursal_id, transaccion.cuenta_id, 
      transaccion.l_estatus_id, DATE_FORMAT(trans_fecha,'%d/%m/%Y') as trans_fecha, 
      transaccion.vendedor_id,      
      transprestamo.transprestamo_id, transprestamo.trans_id, transprestamo.l_tiposolicitud_id, 
      transprestamo.l_tipoprestamo_id, transprestamo.l_porcdescuento_id, 
      transprestamo.transprestamo_montodesc, transprestamo.l_plazovenc_id, 
      transprestamo.transprestamo_plazovalor, transprestamo.l_periodocobro_id, 
      transprestamo.transprestamo_periodovalor, transprestamo.l_tipocliente_id, 
      transprestamo.transprestamo_montodeseacliente, transprestamo.transprestamo_porc, 
      transprestamo.transprestamo_montoavaluo,
      DATE_FORMAT(transaccion.trans_fechavenc,'%d/%m/%Y') as trans_fechavenc,
      estatus.lista_nombre as estatus_nombre,
      estatus.lista_cod as estatus_cod,
      moneda.lista_nombredos as moneda_siglas,
      transprestamo.prodprestamo_id,
      productoprestamo.prodprestamo_id, productoprestamo.prodprestamo_nombre, 
      productoprestamo.prodprestamo_porc, productoprestamo.l_periodocobro_id, 
      productoprestamo.prodprestamo_cantidad, productoprestamo.prodprestamo_interes, 
      productoprestamo.prodprestamo_custodia, productoprestamo.prodprestamo_seguro, 
      productoprestamo.prodprestamo_comision, productoprestamo.prodprestamo_moradiario, 
      productoprestamo.prodprestamo_cat,
      moneda.lista_nombredos as moneda_siglas,
      periodocobro.lista_nombre as periodocobro_nombre,
      sucursal_nombre,
      tipoprenda.lista_nombre as tipoprenda_nombre,
      kilataje.lista_nombre as kilataje_nombre,
      transdetprestamo_gramo

    ",
    "transaccion      
        
        inner join transprestamo on transprestamo.trans_id = transaccion.trans_id    
        inner join transdetprestamo on transdetprestamo.transprestamo_id = transprestamo.transprestamo_id    

        inner join lista tipotransaccion on tipotransaccion.lista_id = transprestamo.l_tiposolicitud_id
        inner join compania on transaccion.compania_id = compania.compania_id
        inner join usuario on transaccion.cliente_id = usuario.usuario_id
        inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id
        inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
        inner join sucursal on sucursal.sucursal_id = transaccion.sucursal_id
        inner join lista tipoprenda on tipoprenda.lista_id = transdetprestamo.l_tipoprenda_id
        inner join lista kilataje on kilataje.lista_id = transdetprestamo.l_kilataje_id


        left join productoprestamo on productoprestamo.prodprestamo_id = transprestamo.prodprestamo_id
        left join lista periodocobro on periodocobro.lista_id = productoprestamo.l_periodocobro_id
        

    ",
    "trans_eliminado = '0' and tipotransaccion.lista_cod = '$tipocod' $wherefecha $where $whereestatus $whelistabuscar ", null, "transaccion.trans_id desc");

  if ($trans_id!=""){    
    return $arrresultado;
  }

  //prodprestamo_porc

  foreach($arrresultado as $i=>$valor){

    $tipoprenda_nombre = utf8_encode($valor["tipoprenda_nombre"]);
    $kilataje_nombre = utf8_encode($valor["kilataje_nombre"]);
    $transdetprestamo_gramo = utf8_encode($valor["transdetprestamo_gramo"]);
    $sucursal_nombre = utf8_encode($valor["sucursal_nombre"]);
    $estatus_cod = utf8_encode($valor["estatus_cod"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
    $trans_fechavenc = utf8_encode($valor["trans_fechavenc"]);
    $transprestamo_id = utf8_encode($valor["transprestamo_id"]);
    $l_tiposolicitud_id = utf8_encode($valor["l_tiposolicitud_id"]);
    $l_tipoprestamo_id = utf8_encode($valor["l_tipoprestamo_id"]);
    $l_porcdescuento_id = utf8_encode($valor["l_porcdescuento_id"]);
    $transprestamo_montodesc = utf8_encode($valor["transprestamo_montodesc"]);
    $l_plazovenc_id = utf8_encode($valor["l_plazovenc_id"]);
    $transprestamo_plazovalor = utf8_encode($valor["transprestamo_plazovalor"]);
    $l_periodocobro_id = utf8_encode($valor["l_periodocobro_id"]);
    $transprestamo_periodovalor = utf8_encode($valor["transprestamo_periodovalor"]);
    $l_tipocliente_id = utf8_encode($valor["l_tipocliente_id"]);
    $transprestamo_montodeseacliente = utf8_encode($valor["transprestamo_montodeseacliente"]);
    $transprestamo_porc = utf8_encode($valor["transprestamo_porc"]);
    $transprestamo_montoavaluo = utf8_encode($valor["transprestamo_montoavaluo"]);
      $trans_id = utf8_encode($valor["trans_id"]);
      $trans_montototal = utf8_encode($valor["trans_montototal"]);
      $trans_codigo = utf8_encode($valor["trans_codigo"]);
      $compania_id = utf8_encode($valor["compania_id"]);
      $l_moneda_id = utf8_encode($valor["l_moneda_id"]);
      $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
      $cliente_id = utf8_encode($valor["cliente_id"]);
      $trans_fechareg = utf8_encode($valor["trans_fechareg"]);
      $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
      $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
      $compania_nombre = utf8_encode($valor["compania_nombre"]);
      $compania_cedula = utf8_encode($valor["compania_cedula"]);
      $compania_telf = utf8_encode($valor["compania_telf"]);
      $compania_email = utf8_encode($valor["compania_email"]);
      $compania_direccion = utf8_encode($valor["compania_direccion"]);      
      $compania_razonsocial = utf8_encode($valor["compania_razonsocial"]);
      $sucursal_id = utf8_encode($valor["sucursal_id"]);
      $cuenta_id = utf8_encode($valor["cuenta_id"]);
      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $trans_fecha = utf8_encode($valor["trans_fecha"]);
      $vendedor_id = utf8_encode($valor["vendedor_id"]);  
      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);  

      $prodprestamo_id = utf8_encode($valor["prodprestamo_id"]);
      $prodprestamo_nombre = utf8_encode($valor["prodprestamo_nombre"]);
      $prodprestamo_porc = utf8_encode($valor["prodprestamo_porc"])."%";
      $l_periodocobro_id = utf8_encode($valor["l_periodocobro_id"]);
      $prodprestamo_cantidad = utf8_encode($valor["prodprestamo_cantidad"]);
      $prodprestamo_interes = utf8_encode($valor["prodprestamo_interes"])."%";
      $prodprestamo_custodia = utf8_encode($valor["prodprestamo_custodia"]."%");
      $prodprestamo_seguro = utf8_encode($valor["prodprestamo_seguro"])."%";
      $prodprestamo_comision = utf8_encode($valor["prodprestamo_comision"])."%";
      $prodprestamo_moradiario = utf8_encode($valor["prodprestamo_moradiario"])."%";
      $prodprestamo_cat = utf8_encode($valor["prodprestamo_cat"])."%";
      $prodprestamo_activo = utf8_encode($valor["prodprestamo_activo"]);
      $prodprestamo_fechareg = utf8_encode($valor["prodprestamo_fechareg"]);
      $prodprestamo_fechamod = utf8_encode($valor["prodprestamo_fechamod"]);


      $transprestamo_montoavaluo = number_format($transprestamo_montoavaluo, 2, ',', '.');   

        if ($trans_activo=="0"){
        $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
      }else{
        $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
      }
      
      $accioneliminar = "<i onclick='eliminartransaccion(\"".$trans_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

      
      $modificar = "<a href='registrarprestamo?id=$trans_id&cu=$cuenta_id&co=$compania_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";   
   

    $prestamo = "
        <a href='prestamodetalle?id=$trans_id'>
          Ver Cuotas
        </a>";

      if ($estatus_cod=="1"){

        $estatus_nombre = "<a onclick='consultarcambiosiguienteestatus(\"".$trans_id."\")' style='cursor: pointer' title='Cambio al Siguiente Estatus' >
          $estatus_nombre
        </a>";

      }
      

      $trans_montototal = number_format_personalizado($trans_montototal, $moneda_siglas);

      if (P_Mod!="1"){$modificar = ""; $activo = "";}
      if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

      $mostrarcolumnacuenta = "<td>$cuenta</td>";
      $mostrarcolumnacompania = "<td>$compania_nombre</td>";

      if ($_COOKIE[perfil]=="1"){      
        
      }
      else if ($_COOKIE[perfil]=="2"){       
        $mostrarcolumnacuenta = "";
      }     
      else {
        $columnacuenta = "";
        $mostrarcolumnacuenta = ""; 
        $mostrarcolumnacompania = ""; 
      }



      $textohtml .= "
         <tr>                               
                $mostrarcolumnacuenta
                $mostrarcolumnacompania                 
                <td>$sucursal_nombre</td>
                <td>$trans_codigo</td>                
                <td>$tipoprenda_nombre</td>
                <td>$transdetprestamo_gramo</td>
                <td>$kilataje_nombre</td>
                <td>$transprestamo_montoavaluo</td>
                <td>$usuario_nombre $usuario_apellido</td>
                <td>$trans_fecha</td>                                    
                <td style='text-align: center'>$trans_montototal</td>    
                <td style='text-align: center'>$estatus_nombre</td>                            
                <td style='text-align: center'>$prestamo</td>                            
                <td style='text-align: center'>$trans_fechareg</td>                            
                <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar </td>
            </tr>
      ";

  } 

  return $textohtml;  
}


function TotalPrestamosProductos($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $trans_codigo=null){

      if ($tipocod==""){$tipocod=2;}

      $fechaactual = formatoFechaHoraBd(1);    

      if ($fechadesde=="" && $fechahasta==""){
        //$wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
      } else if ($fechadesde!="" && $fechahasta!=""){
        $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
      } else if ($fechadesde!=""){
        $wherefecha = " and (transaccion.trans_fechareg > '$fechadesde 00:00:00' ) ";  
      } else if ($fechahasta!=""){
        $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
      }

      if ($ultimosregistros!=""){
        $limitregistros =" LIMIT $ultimosregistros";
      }

      if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
        
        $where = "";
        $columnacuenta = "<th>Cuenta</th>";
        $columnacompania = "<th>Compañia</th>";

      } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
          
          $columnacompania = "<th>Compañia</th>";
          $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

      }  else { 

        $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]'  ";

      } 
      $conexion = new ConexionBd();

      if($getestatus!=""){
        $whereestatus = " and transaccion.l_estatus_id in ('$getestatus') ";
      }

      if($trans_codigo!=""){
        $wheretrans_codigo = " and transaccion.trans_codigo = '$trans_codigo' ";
      }



      $conexion = new ConexionBd(); 

      $arrresultado = $conexion->doSelect("count(*) as total

        ",
        "transaccion      
            
            inner join transprestamo on transprestamo.trans_id = transaccion.trans_id        
            inner join lista tipotransaccion on tipotransaccion.lista_id = transprestamo.l_tiposolicitud_id
            inner join compania on transaccion.compania_id = compania.compania_id
            inner join usuario on transaccion.cliente_id = usuario.usuario_id
            inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id
            inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
            left join productoprestamo on productoprestamo.prodprestamo_id = transprestamo.prodprestamo_id
            left join lista periodocobro on periodocobro.lista_id = productoprestamo.l_periodocobro_id
            

        ",
        "trans_eliminado = '0' and tipotransaccion.lista_cod = '$tipocod' $wheretrans_codigo $wherefecha $where $whereestatus ", null, "transaccion.trans_id desc");

      foreach($arrresultado as $i=>$valor){


        $estatus_cod = utf8_encode($valor["estatus_cod"]);
        $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
        $trans_fechavenc = utf8_encode($valor["trans_fechavenc"]);
        $transprestamo_id = utf8_encode($valor["transprestamo_id"]);
        $l_tiposolicitud_id = utf8_encode($valor["l_tiposolicitud_id"]);
        $l_tipoprestamo_id = utf8_encode($valor["l_tipoprestamo_id"]);
        $l_porcdescuento_id = utf8_encode($valor["l_porcdescuento_id"]);
        $transprestamo_montodesc = utf8_encode($valor["transprestamo_montodesc"]);
        $l_plazovenc_id = utf8_encode($valor["l_plazovenc_id"]);
        $transprestamo_plazovalor = utf8_encode($valor["transprestamo_plazovalor"]);
        $l_periodocobro_id = utf8_encode($valor["l_periodocobro_id"]);
        $transprestamo_periodovalor = utf8_encode($valor["transprestamo_periodovalor"]);
        $l_tipocliente_id = utf8_encode($valor["l_tipocliente_id"]);
        $transprestamo_montodeseacliente = utf8_encode($valor["transprestamo_montodeseacliente"]);
        $transprestamo_porc = utf8_encode($valor["transprestamo_porc"]);
        $transprestamo_montoavaluo = utf8_encode($valor["transprestamo_montoavaluo"]);
          $trans_id = utf8_encode($valor["trans_id"]);
          $trans_montototal = utf8_encode($valor["trans_montototal"]);
          $trans_codigo = utf8_encode($valor["trans_codigo"]);
          $compania_id = utf8_encode($valor["compania_id"]);
          $l_moneda_id = utf8_encode($valor["l_moneda_id"]);
          $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
          $cliente_id = utf8_encode($valor["cliente_id"]);
          $trans_fechareg = utf8_encode($valor["trans_fechareg"]);
          $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
          $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
          $compania_nombre = utf8_encode($valor["compania_nombre"]);
          $compania_cedula = utf8_encode($valor["compania_cedula"]);
          $compania_telf = utf8_encode($valor["compania_telf"]);
          $compania_email = utf8_encode($valor["compania_email"]);
          $compania_direccion = utf8_encode($valor["compania_direccion"]);      
          $compania_razonsocial = utf8_encode($valor["compania_razonsocial"]);
          $sucursal_id = utf8_encode($valor["sucursal_id"]);
          $cuenta_id = utf8_encode($valor["cuenta_id"]);
          $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
          $trans_fecha = utf8_encode($valor["trans_fecha"]);
          $vendedor_id = utf8_encode($valor["vendedor_id"]);  
          $estatus_nombre = utf8_encode($valor["estatus_nombre"]);  

          $prodprestamo_id = utf8_encode($valor["prodprestamo_id"]);
          $prodprestamo_nombre = utf8_encode($valor["prodprestamo_nombre"]);
          $prodprestamo_porc = utf8_encode($valor["prodprestamo_porc"])."%";
          $l_periodocobro_id = utf8_encode($valor["l_periodocobro_id"]);
          $prodprestamo_cantidad = utf8_encode($valor["prodprestamo_cantidad"]);
          $prodprestamo_interes = utf8_encode($valor["prodprestamo_interes"])."%";
          $prodprestamo_custodia = utf8_encode($valor["prodprestamo_custodia"]."%");
          $prodprestamo_seguro = utf8_encode($valor["prodprestamo_seguro"])."%";
          $prodprestamo_comision = utf8_encode($valor["prodprestamo_comision"])."%";
          $prodprestamo_moradiario = utf8_encode($valor["prodprestamo_moradiario"])."%";
          $prodprestamo_cat = utf8_encode($valor["prodprestamo_cat"])."%";
          $prodprestamo_activo = utf8_encode($valor["prodprestamo_activo"]);
          $prodprestamo_fechareg = utf8_encode($valor["prodprestamo_fechareg"]);
          $prodprestamo_fechamod = utf8_encode($valor["prodprestamo_fechamod"]);

          $total = utf8_encode($valor["total"]);   


      }   
      if ($total==""){$total=0;} 

      $modulo_url = "prestamos";

     $totalprestamos  .="
          <div class='col-lg-3 col-sm-6 col-xs-12'>      
            <div class='small-box div_accesodirecto' style='background: $moduloresumen_backcolor'>
              <div class='inner'>
                <a href='$modulo_url?date=$getdate&e=$getestatus'><h3 style='font-size: 20px'>$total</h3></a>
                <a href='$modulo_url?date=$getdate&e=$getestatus'><p>Total Garantías </p></a>
              </div>
              <div class='icon'>
                <a href='$modulo_url?date=$getdate&e=$getestatus'>
                  <i class='fa fa-archive'></i>
                </a>
              </div>
              <a href='$modulo_url?date=$getdate&e=$getestatus' class='small-box-footer'>Ver &nbsp <i class='fa fa-arrow-circle-right'></i></a>
            </div>
          </div>
        ";    

      return $totalprestamos;
  } 

  function CantidadPrestamos($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $trans_codigo=null, $diasvencer=null, $gettiposolicitud=null, $getcliente=null){

    if ($tipocod==""){$tipocod=2;}

    $fechaactual = formatoFechaHoraBd(1);    

    if ($fechadesde=="" && $fechahasta==""){
      //$wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
    } else if ($fechadesde!="" && $fechahasta!=""){
      $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
    } else if ($fechadesde!=""){
      $wherefecha = " and (transaccion.trans_fechareg > '$fechadesde 00:00:00' ) ";  
    } else if ($fechahasta!=""){
      $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
    }

    if ($diasvencer>0){
      $fecha2 = date("Y-m-d H:i:s",strtotime($fechaactual." $diasvencer days"));    
      $wherefecha = " and (transprestamo.transprestamo_fechavenc <= '$fecha2 23:59:59' ) "; 
    }

    if ($ultimosregistros!=""){
      $limitregistros =" LIMIT $ultimosregistros";
    }

    if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
      
      $where = "";
      $columnacuenta = "<th>Cuenta</th>";
      $columnacompania = "<th>Compañia</th>";

    } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
        
        $columnacompania = "<th>Compañia</th>";
        $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

    }  else { 

      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]'  ";

    } 
    $conexion = new ConexionBd();

    if($getestatus!=""){
      $whereestatus = " and transaccion.l_estatus_id in ('$getestatus') ";
    }

    if($trans_codigo!=""){
      $wheretrans_codigo = " and transaccion.trans_codigo = '$trans_codigo' ";
    }
    
    if($gettiposolicitud!=""){
      $where .= " and transprestamo.l_tiposolicitud_id = '$gettiposolicitud' ";
    }

    if($getcliente!=""){
      $where .= " and transaccion.cliente_id = '$getcliente' ";
      //$wherefecha = "";
    }


    /*
tipotransaccion.lista_cod as tiposolicitud_cod

        ",
        "transaccion                  
            inner join transprestamo on transprestamo.trans_id = transaccion.trans_id        
            inner join lista tipotransaccion on tipotransaccion.lista_id = transprestamo.l_tiposolicitud_id
            inner join compania on transaccion.compania_id = compania.compania_id
            inner join usuario on transaccion.cliente_id = usuario.usuario_id
            inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id
            inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
            left join productoprestamo on productoprestamo.prodprestamo_id = transprestamo.prodprestamo_id
            left join lista periodocobro on periodocobro.lista_id = productoprestamo.l_periodocobro_id
            

        ",
        "trans_eliminado = '0'  $wheretrans_codigo $wherefecha $where $whereestatus ", null, "transaccion.trans_id desc");

        // and tipotransaccion.lista_cod = '$tipocod'

      foreach($arrresultado as $i=>$valor){

          $tiposolicitud_cod = utf8_encode($valor["tiposolicitud_cod"]);   
          $total = utf8_encode($valor["total"]);   
          if ($total==""){$total=0;} 
          $moneda_siglas = utf8_encode($valor["moneda_siglas"]);   

          $total = number_format_personalizado($total, $moneda_siglas);


      }   

      if ($tiposolicitud_cod=="1"){
        $modulo_url = "prestamos";
        $texto = "Préstamos";
      }

      if ($tiposolicitud_cod=="2"){
        $modulo_url = "prestamosletras";
        $texto = "Letras";
      }

    */


    $conexion = new ConexionBd(); 

    $arrresultado = $conexion->doSelect("count(transaccion.trans_id) as total,
    tipotransaccion.lista_cod as tiposolicitud_cod

      ",
      "transaccion      
          
          inner join transprestamo on transprestamo.trans_id = transaccion.trans_id        
          inner join lista tipotransaccion on tipotransaccion.lista_id = transprestamo.l_tiposolicitud_id
          inner join compania on transaccion.compania_id = compania.compania_id
          inner join usuario on transaccion.cliente_id = usuario.usuario_id
          inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id
          inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
          left join productoprestamo on productoprestamo.prodprestamo_id = transprestamo.prodprestamo_id
          left join lista periodocobro on periodocobro.lista_id = productoprestamo.l_periodocobro_id
          

      ",
      "trans_eliminado = '0'  $wheretrans_codigo $wherefecha $where $whereestatus ", null, "transaccion.trans_id desc");

      // and tipotransaccion.lista_cod = '$tipocod'

    foreach($arrresultado as $i=>$valor){
        $tiposolicitud_cod = utf8_encode($valor["tiposolicitud_cod"]);   
        $total = utf8_encode($valor["total"]);         
    }   

    if ($tiposolicitud_cod==""){
      $arrresultado = $conexion->doSelect("lista_cod as tiposolicitud_cod",
        "lista","lista_id = '$gettiposolicitud' ");  
      foreach($arrresultado as $i=>$valor){
          $tiposolicitud_cod = utf8_encode($valor["tiposolicitud_cod"]);   
      }   
    }

    $vermas = "<a href='$url' class='small-box-footer'>Ver &nbsp <i class='fa fa-arrow-circle-right'></i></a>";

    if ($tiposolicitud_cod=="1"){
      $modulo_url = "prestamos";
      $texto = "Préstamos";
    }

    if ($tiposolicitud_cod=="2"){
      $modulo_url = "prestamosletras";
      $texto = "Letras";
    }

    $url = "$modulo_url?date=$getdate&e=$getestatus";
    $href = " href='$url' ";

    if ($diasvencer>0){        
      $href = " ";
      $vermas = "<a class='small-box-footer'> &nbsp </a>";
    }

    $href = " ";
        $vermas = "<a class='small-box-footer'> &nbsp </a>";

    $totalprestamos  .="
        <div class='col-lg-3 col-sm-6 col-xs-12'>      
          <div class='small-box div_accesodirecto' style='background: $moduloresumen_backcolor'>
            <div class='inner'>
              <a $href><h3 style='font-size: 20px'>$total</h3></a>
              <a $href><p>Total de $texto </p></a>
            </div>
            <div class='icon'>
              <a $href>
                <i class='fa fa-list'></i>
              </a>
            </div>
            $vermas
          </div>
        </div>
      ";    

    return $totalprestamos;
}   


function CantidadPrestamosCuotas($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $trans_codigo=null, $diasvencer=null, $gettiposolicitud=null, $getcliente=null){

  if ($tipocod==""){$tipocod=2;}

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    //$wherefecha = " and (transprestamocuota.transprestamocuota_fechavenc BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (transprestamocuota.transprestamocuota_fechavenc BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (transprestamocuota.transprestamocuota_fechavenc > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (transprestamocuota.transprestamocuota_fechavenc BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($diasvencer>0){
    $fecha2 = date("Y-m-d H:i:s",strtotime($fechaactual." $diasvencer days"));    
    $wherefecha = " and (transprestamocuota.transprestamocuota_fechavenc <= '$fecha2 23:59:59' ) "; 
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]'  ";

  } 
  $conexion = new ConexionBd();

  if($getestatus!=""){
    $whereestatus = " and transaccion.l_estatus_id in ('$getestatus') ";
  }

  if($trans_codigo!=""){
    $wheretrans_codigo = " and transaccion.trans_codigo = '$trans_codigo' ";
  }
  
  if($gettiposolicitud!=""){
    $where .= " and transprestamo.l_tiposolicitud_id = '$gettiposolicitud' ";
  }

  if($getcliente!=""){
    $where .= " and transaccion.cliente_id = '$getcliente' ";
    //$wherefecha = "";
  }



  $conexion = new ConexionBd(); 

  $arrresultado = $conexion->doSelect("count(transprestamocuota.transprestamocuota_id) as total

    ",
    "transaccion      
        
        inner join transprestamo on transprestamo.trans_id = transaccion.trans_id        
        inner join transprestamocuota on transprestamocuota.transprestamo_id = transprestamo.transprestamo_id and transprestamocuota_activo = '1'     
        inner join lista tipotransaccion on tipotransaccion.lista_id = transprestamo.l_tiposolicitud_id
        inner join compania on transaccion.compania_id = compania.compania_id
        inner join usuario on transaccion.cliente_id = usuario.usuario_id
        inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id
        inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
        left join productoprestamo on productoprestamo.prodprestamo_id = transprestamo.prodprestamo_id
        left join lista periodocobro on periodocobro.lista_id = productoprestamo.l_periodocobro_id
        

    ",
    "trans_eliminado = '0'  $wheretrans_codigo $wherefecha $where $whereestatus ", null, "transaccion.trans_id desc");

    // and tipotransaccion.lista_cod = '$tipocod'

  foreach($arrresultado as $i=>$valor){

      $total = utf8_encode($valor["total"]);         
  }   

  $vermas = "<a href='$url' class='small-box-footer'>Ver &nbsp <i class='fa fa-arrow-circle-right'></i></a>";

  $modulo_url = "prestamos";
  $url = "$modulo_url?date=$getdate&e=$getestatus";
  $href = " href='$url' ";

  if ($diasvencer>0){        
    $href = " ";
    $vermas = "<a class='small-box-footer'> &nbsp </a>";
  }

  $href = " ";
      $vermas = "<a class='small-box-footer'> &nbsp </a>";

  $totalprestamos  .="
      <div class='col-lg-3 col-sm-6 col-xs-12'>      
        <div class='small-box div_accesodirecto' style='background: $moduloresumen_backcolor'>
          <div class='inner'>
            <a $href><h3 style='font-size: 20px'>$total</h3></a>
            <a $href><p>Total de Cuotas </p></a>
          </div>
          <div class='icon'>
            <a $href>
              <i class='fa fa-list'></i>
            </a>
          </div>
          $vermas
        </div>
      </div>
    ";    

  return $totalprestamos;
}   

function TotalPrestamos($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $trans_codigo=null, $diasvencer=null, $gettiposolicitud=null, $getcliente=null){

      if ($tipocod==""){$tipocod=2;}

      $fechaactual = formatoFechaHoraBd(1);    

      if ($fechadesde=="" && $fechahasta==""){
        //$wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
      } else if ($fechadesde!="" && $fechahasta!=""){
        $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
      } else if ($fechadesde!=""){
        $wherefecha = " and (transaccion.trans_fechareg > '$fechadesde 00:00:00' ) ";  
      } else if ($fechahasta!=""){
        $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
      }

      if ($diasvencer>0){
        $fecha2 = date("Y-m-d H:i:s",strtotime($fechaactual." $diasvencer days"));    
        $wherefecha = " and (transprestamo.transprestamo_fechavenc <= '$fecha2 23:59:59' ) "; 
      }

      if ($ultimosregistros!=""){
        $limitregistros =" LIMIT $ultimosregistros";
      }

      if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
        
        $where = "";
        $columnacuenta = "<th>Cuenta</th>";
        $columnacompania = "<th>Compañia</th>";

      } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
          
          $columnacompania = "<th>Compañia</th>";
          $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

      }  else { 

        $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]'  ";

      } 
      $conexion = new ConexionBd();

      if($getestatus!=""){
        $whereestatus = " and transaccion.l_estatus_id in ('$getestatus')";
      }

      if($trans_codigo!=""){
        $wheretrans_codigo = " and transaccion.trans_codigo = '$trans_codigo' ";
      }

      if($gettiposolicitud!=""){
        $where .= " and transprestamo.l_tiposolicitud_id = '$gettiposolicitud' ";
      }

      if($getcliente!=""){
        $where .= " and transaccion.cliente_id = '$getcliente' ";
        //$wherefecha = "";
      }



      $conexion = new ConexionBd(); 

      $arrresultado = $conexion->doSelect("sum(trans_montototal) as total,
        moneda.lista_nombredos as moneda_siglas,
        tipotransaccion.lista_cod as tiposolicitud_cod

        ",
        "transaccion                  
            inner join transprestamo on transprestamo.trans_id = transaccion.trans_id        
            inner join lista tipotransaccion on tipotransaccion.lista_id = transprestamo.l_tiposolicitud_id
            inner join compania on transaccion.compania_id = compania.compania_id
            inner join usuario on transaccion.cliente_id = usuario.usuario_id
            inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id
            inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
            left join productoprestamo on productoprestamo.prodprestamo_id = transprestamo.prodprestamo_id
            left join lista periodocobro on periodocobro.lista_id = productoprestamo.l_periodocobro_id
            

        ",
        "trans_eliminado = '0'  $wheretrans_codigo $wherefecha $where $whereestatus ", null, "transaccion.trans_id desc");

        // and tipotransaccion.lista_cod = '$tipocod'

      foreach($arrresultado as $i=>$valor){

          $tiposolicitud_cod = utf8_encode($valor["tiposolicitud_cod"]);   
          $total = utf8_encode($valor["total"]);   
          if ($total==""){$total=0;} 
          $moneda_siglas = utf8_encode($valor["moneda_siglas"]);   

          $total = number_format_personalizado($total, $moneda_siglas);


      }   

      if ($tiposolicitud_cod==""){
        $arrresultado = $conexion->doSelect("lista_cod as tiposolicitud_cod",
          "lista","lista_id = '$gettiposolicitud' ");  
        foreach($arrresultado as $i=>$valor){
            $tiposolicitud_cod = utf8_encode($valor["tiposolicitud_cod"]);   
        }   
      }

      if ($tiposolicitud_cod=="1"){
        $modulo_url = "prestamos";
        $texto = "Préstamos";
      }

      if ($tiposolicitud_cod=="2"){
        $modulo_url = "prestamosletras";
        $texto = "Letras";
      }

      $vermas = "<a href='$url' class='small-box-footer'>Ver &nbsp <i class='fa fa-arrow-circle-right'></i></a>";

      $url = "$modulo_url?date=$getdate&e=$getestatus";
      $href = " href='$url' ";

      if ($diasvencer>0){        
        $href = " ";
        $vermas = "<a class='small-box-footer'> &nbsp </a>";
      }

      $href = " ";
        $vermas = "<a class='small-box-footer'> &nbsp </a>";

      $totalprestamos  .="
          <div class='col-lg-3 col-sm-6 col-xs-12'>      
            <div class='small-box div_accesodirecto' style='background: $moduloresumen_backcolor'>
              <div class='inner'>
                <a $href><h3 style='font-size: 20px'>$total</h3></a>
                <a $href><p>Suma de $texto </p></a>
              </div>
              <div class='icon'>
                <a $href>
                  <i class='fa fa-money'></i>
                </a>
              </div>
              $vermas
            </div>
          </div>
        ";    

      return $totalprestamos;
  } 

  
function TotalPrestamosCuotas($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $trans_codigo=null, $diasvencer=null, $gettiposolicitud=null, $getcliente=null){

  if ($tipocod==""){$tipocod=2;}

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    //$wherefecha = " and (transprestamocuota.transprestamocuota_fechavenc BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (transprestamocuota.transprestamocuota_fechavenc BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (transprestamocuota.transprestamocuota_fechavenc > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (transprestamocuota.transprestamocuota_fechavenc BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($diasvencer>0){
    $fecha2 = date("Y-m-d H:i:s",strtotime($fechaactual." $diasvencer days"));    
    $wherefecha = " and (transprestamocuota.transprestamocuota_fechavenc <= '$fecha2 23:59:59' ) "; 
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]'  ";

  } 
  $conexion = new ConexionBd();

  if($getestatus!=""){
    $whereestatus = " and transaccion.l_estatus_id in ('$getestatus') ";
  }

  if($trans_codigo!=""){
    $wheretrans_codigo = " and transaccion.trans_codigo = '$trans_codigo' ";
  }

  if($gettiposolicitud!=""){
    $where .= " and transprestamo.l_tiposolicitud_id = '$gettiposolicitud' ";
  }

  if($getcliente!=""){
    $where .= " and transaccion.cliente_id = '$getcliente' ";
    //$wherefecha = "";
  }



  $conexion = new ConexionBd(); 

  $arrresultado = $conexion->doSelect("sum(transprestamocuota.transprestamocuota_monto) as total,
    moneda.lista_nombredos as moneda_siglas

    ",
    "transaccion              
        inner join transprestamo on transprestamo.trans_id = transaccion.trans_id        
        inner join transprestamocuota on transprestamocuota.transprestamo_id = transprestamo.transprestamo_id and transprestamocuota_activo = '1'     
        inner join lista tipotransaccion on tipotransaccion.lista_id = transprestamo.l_tiposolicitud_id
        inner join compania on transaccion.compania_id = compania.compania_id
        inner join usuario on transaccion.cliente_id = usuario.usuario_id
        inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id
        inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
        left join productoprestamo on productoprestamo.prodprestamo_id = transprestamo.prodprestamo_id
        left join lista periodocobro on periodocobro.lista_id = productoprestamo.l_periodocobro_id
        

    ",
    "trans_eliminado = '0'  $wheretrans_codigo $wherefecha $where $whereestatus ", null, "transaccion.trans_id desc");

    // and tipotransaccion.lista_cod = '$tipocod'

  foreach($arrresultado as $i=>$valor){

      $total = utf8_encode($valor["total"]);   
      if ($total==""){$total=0;} 
      $moneda_siglas = utf8_encode($valor["moneda_siglas"]);   

      $total = number_format_personalizado($total, $moneda_siglas);


  }   

  $vermas = "<a href='$url' class='small-box-footer'>Ver &nbsp <i class='fa fa-arrow-circle-right'></i></a>";

  $modulo_url = "prestamos";
  $url = "$modulo_url?date=$getdate&e=$getestatus";
  $href = " href='$url' ";

  if ($diasvencer>0){        
    $href = " ";
    $vermas = "<a class='small-box-footer'> &nbsp </a>";
  }

  $href = " ";
    $vermas = "<a class='small-box-footer'> &nbsp </a>";

  $totalprestamos  .="
      <div class='col-lg-3 col-sm-6 col-xs-12'>      
        <div class='small-box div_accesodirecto' style='background: $moduloresumen_backcolor'>
          <div class='inner'>
            <a $href><h3 style='font-size: 20px'>$total</h3></a>
            <a $href><p>Suma de Cuotas </p></a>
          </div>
          <div class='icon'>
            <a $href>
              <i class='fa fa-money'></i>
            </a>
          </div>
          $vermas
        </div>
      </div>
    ";    

  return $totalprestamos;
} 

  function TotalPrestamosAvaluos($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $trans_codigo=null){

      if ($tipocod==""){$tipocod=2;}

      $fechaactual = formatoFechaHoraBd(1);    

      if ($fechadesde=="" && $fechahasta==""){
        $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
      } else if ($fechadesde!="" && $fechahasta!=""){
        $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
      } else if ($fechadesde!=""){
        $wherefecha = " and (transaccion.trans_fechareg > '$fechadesde 00:00:00' ) ";  
      } else if ($fechahasta!=""){
        $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
      }

      if ($ultimosregistros!=""){
        $limitregistros =" LIMIT $ultimosregistros";
      }

      if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
        
        $where = "";
        $columnacuenta = "<th>Cuenta</th>";
        $columnacompania = "<th>Compañia</th>";

      } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
          
          $columnacompania = "<th>Compañia</th>";
          $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

      }  else { 

        $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]'  ";

      } 
      $conexion = new ConexionBd();

      if($getestatus!=""){
        $whereestatus = " and transaccion.l_estatus_id = '$getestatus' ";
      }

      if($trans_codigo!=""){
        $wheretrans_codigo = " and transaccion.trans_codigo = '$trans_codigo' ";
      }



      $conexion = new ConexionBd(); 

      $arrresultado = $conexion->doSelect("sum(transprestamo.transprestamo_montoavaluo) as total,
        moneda.lista_nombredos as moneda_siglas

        ",
        "transaccion      
            
            inner join transprestamo on transprestamo.trans_id = transaccion.trans_id        
            inner join lista tipotransaccion on tipotransaccion.lista_id = transprestamo.l_tiposolicitud_id
            inner join compania on transaccion.compania_id = compania.compania_id
            inner join usuario on transaccion.cliente_id = usuario.usuario_id
            inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id
            inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
            left join productoprestamo on productoprestamo.prodprestamo_id = transprestamo.prodprestamo_id
            left join lista periodocobro on periodocobro.lista_id = productoprestamo.l_periodocobro_id
            

        ",
        "trans_eliminado = '0' and tipotransaccion.lista_cod = '$tipocod' $wheretrans_codigo $wherefecha $where $whereestatus ", null, "transaccion.trans_id desc");

      foreach($arrresultado as $i=>$valor){

          $total = utf8_encode($valor["total"]);  
          if ($total==""){$total=0;} 
          $moneda_siglas = utf8_encode($valor["moneda_siglas"]);   

          $total = number_format_personalizado($total, $moneda_siglas);


      }   

      $modulo_url = "prestamos";

     $totalprestamos  .="
          <div class='col-lg-3 col-sm-6 col-xs-12'>      
            <div class='small-box div_accesodirecto' style='background: $moduloresumen_backcolor'>
              <div class='inner'>
                <a href='$modulo_url?date=$getdate&e=$getestatus'><h3 style='font-size: 20px'>$total</h3></a>
                <a href='$modulo_url?date=$getdate&e=$getestatus'><p>Total Avalúos </p></a>
              </div>
              <div class='icon'>
                <a href='$modulo_url?date=$getdate&e=$getestatus'>
                  <i class='fa fa-money'></i>
                </a>
              </div>
              <a href='$modulo_url?date=$getdate&e=$getestatus' class='small-box-footer'>Ver &nbsp <i class='fa fa-arrow-circle-right'></i></a>
            </div>
          </div>
        ";    

      return $totalprestamos;
  } 

function ObtenerListaProductosPrestamo($cuenta=null, $compania=null, $l_prodprestamo_id=null, $l_tiposolicitud_id=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $option = "<option value=''>-- Seleccione --</option>";

  $where = " and productoprestamo.compania_id = '$compania' ";

  $where .= " and productoprestamo.l_tiposolicitud_id = '$l_tiposolicitud_id' ";
  

    $arrresultado = $conexion->doSelect("

    productoprestamo.prodprestamo_id, productoprestamo.prodprestamo_nombre, 
    productoprestamo.prodprestamo_porc, productoprestamo.l_periodocobro_id, 
    productoprestamo.prodprestamo_cantidad, productoprestamo.prodprestamo_interes, 
    productoprestamo.prodprestamo_custodia, productoprestamo.prodprestamo_seguro, 
    productoprestamo.prodprestamo_comision, productoprestamo.prodprestamo_moradiario, 
    productoprestamo.prodprestamo_activo, productoprestamo.prodprestamo_eliminado, 
    productoprestamo.usuario_idreg, productoprestamo.usuario_idmod, 
    productoprestamo.cuenta_id, productoprestamo.compania_id, 
    DATE_FORMAT(productoprestamo.prodprestamo_fechareg,'%d/%m/%Y %H:%i:%s') as prodprestamo_fechareg,
    DATE_FORMAT(productoprestamo.prodprestamo_fechamod,'%d/%m/%Y %H:%i:%s') as prodprestamo_fechamod,
    
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
    usuarioregistra.usuario_nombre as usuarioregistra_nombre,
    usuarioregistra.usuario_apellido as usuarioregistra_apellido,
    usuarioomdifica.usuario_nombre as usuarioomdifica_nombre,
    usuarioomdifica.usuario_apellido as usuarioomdifica_apellido
    ",
    "productoprestamo           
        inner join usuario cuenta on cuenta.usuario_id = productoprestamo.cuenta_id
        inner join compania on compania.compania_id = productoprestamo.compania_id  
        inner join usuario usuarioregistra on usuarioregistra.usuario_id = productoprestamo.usuario_idreg
        inner join usuario usuarioomdifica on usuarioomdifica.usuario_id = productoprestamo.usuario_idmod 
    ",
    "prodprestamo_activo = '1' $where ", null, "productoprestamo.prodprestamo_id desc");
  foreach($arrresultado as $i=>$valor){

    $prodprestamo_id = utf8_encode($valor["prodprestamo_id"]);
    $prodprestamo_nombre = utf8_encode($valor["prodprestamo_nombre"]);

    if ($l_prodprestamo_id==$prodprestamo_id){        
      $option .= "<option selected='selected' value='$prodprestamo_id'>$prodprestamo_nombre</option>";        
    }else{       
      $option .= "<option value='$prodprestamo_id'>$prodprestamo_nombre</option>";
    }  
  }

 
  return $option;

}

function obtenerPrestamoCuota($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $trans_id=null, $diasvencer=null, $tiposolicitud=null, $getusuario=null){

  $fechaactual = formatoFechaHoraBd(1);    


  if ($fechadesde=="" && $fechahasta==""){
    //$wherefecha = " and (transprestamocuota.transprestamocuota_fechavenc BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (transprestamocuota.transprestamocuota_fechavenc BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (transprestamocuota.transprestamocuota_fechavenc > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (transprestamocuota.transprestamocuota_fechavenc BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($sinfiltrofecha=="1"){
    $wherefecha = "";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if($trans_id!=""){
    $where .= " and transaccion.trans_id = '$trans_id' ";
    //$wherefecha = "";
  }

  if($getestatus!=""){
    $whereestatus = " and transprestamocuota.l_estadocuota_id in ('$getestatus') ";
  }

  if ($diasvencer>0){
    $fecha2 = date("Y-m-d H:i:s",strtotime($fechaactual." $diasvencer days"));    
    $wherefecha = " and (transprestamocuota.transprestamocuota_fechavenc <= '$fecha2 23:59:59' ) "; 
  }

  if($tiposolicitud!=""){
    $where .= " and transprestamo.l_tiposolicitud_id = '$tiposolicitud' ";
  } 

  if($getusuario!=""){
    $where .= " and transaccion.cliente_id = '$getusuario' ";
  }


  $conexion = new ConexionBd(); 

  $arrresultado = $conexion->doSelect("transaccion.trans_id, trans_montototal, trans_codigo, 
      transaccion.compania_id, transaccion.l_moneda_id,  
      transaccion.l_formapago_id, transaccion.cliente_id,
      DATE_FORMAT(trans_fechareg,'%d/%m/%Y %H:%i:%s') as trans_fechareg, usuario_nombre, usuario_apellido, 
      compania_nombre, compania_cedula, compania_telf, 
      compania_email, compania_direccion, compania_razonsocial, 
      transaccion.sucursal_id, transaccion.cuenta_id, 
      transaccion.l_estatus_id, DATE_FORMAT(trans_fecha,'%d/%m/%Y') as trans_fecha, 
      transaccion.vendedor_id,      
      transprestamo.transprestamo_id, transprestamo.trans_id, transprestamo.l_tiposolicitud_id, 
      transprestamo.l_tipoprestamo_id, transprestamo.l_porcdescuento_id, 
      transprestamo.transprestamo_montodesc, transprestamo.l_plazovenc_id, 
      transprestamo.transprestamo_plazovalor, transprestamo.l_periodocobro_id, 
      transprestamo.transprestamo_periodovalor, transprestamo.l_tipocliente_id, 
      transprestamo.transprestamo_montodeseacliente, transprestamo.transprestamo_porc, 
      transprestamo.transprestamo_montoavaluo,
      DATE_FORMAT(transaccion.trans_fechavenc,'%d/%m/%Y') as trans_fechavenc,
      estatus.lista_nombre as estatus_nombre,
      estatus.lista_cod as estatus_cod,
      moneda.lista_nombredos as moneda_siglas,

      transprestamocuota.transprestamocuota_id, transprestamocuota.trans_id, 
      transprestamocuota.transprestamo_id, transprestamocuota.transprestamocuota_nro, 
      transprestamocuota.transprestamocuota_monto, transprestamocuota.transprestamocuota_montointeres,
      transprestamocuota.transprestamocuota_montoabonado, 
      transprestamocuota.transprestamocuota_montoabonadocapital, 
      transprestamocuota.transprestamocuota_montopendiente, 
      transprestamocuota.transprestamocuota_montomora, 
      transprestamocuota.transprestamocuota_montoadicional, transprestamocuota.l_moneda_id,       
      transprestamocuota.l_estadocuota_id, 
      transprestamocuota.transprestamocuota_montocapitalresta,
      estatuscuota.lista_nombre as estatuscuota_nombre,
      estatuscuota.lista_cod as estatuscuota_cod,
      DATE_FORMAT(transprestamocuota.transprestamocuota_fechavenc,'%d/%m/%Y') as transprestamocuota_fechavenc,
      sucursal_nombre

    ",
    "transaccion      
        inner join lista tipotransaccion on tipotransaccion.lista_id = transaccion.l_tipotrans_id
        inner join transprestamo on transprestamo.trans_id = transaccion.trans_id  
        inner join transprestamocuota on transprestamocuota.transprestamo_id = transprestamo.transprestamo_id and transprestamocuota_activo = '1'     
        inner join compania on transaccion.compania_id = compania.compania_id
        inner join sucursal on sucursal.sucursal_id = transaccion.sucursal_id
        inner join usuario on transaccion.cliente_id = usuario.usuario_id
        inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id
        inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
        inner join lista estatuscuota on estatuscuota.lista_id = transprestamocuota.l_estadocuota_id
        

    ",
    "trans_eliminado = '0'  $wherefecha $where $whereestatus ", null, "transprestamocuota.transprestamocuota_nro asc");
  $cont = 0;
  foreach($arrresultado as $i=>$valor){

    // and tipotransaccion.lista_cod = '7'

      $sucursal_nombre = utf8_encode($valor["sucursal_nombre"]);
      $estatuscuota_nombre = utf8_encode($valor["estatuscuota_nombre"]);
      $estatuscuota_cod = utf8_encode($valor["estatuscuota_cod"]);
      $transprestamocuota_id = utf8_encode($valor["transprestamocuota_id"]);
      $transprestamocuota_nro = utf8_encode($valor["transprestamocuota_nro"]);
      $transprestamocuota_monto = utf8_encode($valor["transprestamocuota_monto"]);
      $transprestamocuota_montointeres = utf8_encode($valor["transprestamocuota_montointeres"]);
      $transprestamocuota_montoabonado = utf8_encode($valor["transprestamocuota_montoabonado"]);
      $transprestamocuota_montoabonadocapital = utf8_encode($valor["transprestamocuota_montoabonadocapital"]);
      $transprestamocuota_montopendiente = utf8_encode($valor["transprestamocuota_montopendiente"]);
      $transprestamocuota_montomora = utf8_encode($valor["transprestamocuota_montomora"]);
      $transprestamocuota_montoadicional = utf8_encode($valor["transprestamocuota_montoadicional"]);
      $transprestamocuota_fechavenc = utf8_encode($valor["transprestamocuota_fechavenc"]);
      $l_estadocuota_id = utf8_encode($valor["l_estadocuota_id"]);
      $transprestamocuota_montocapitalresta = utf8_encode($valor["transprestamocuota_montocapitalresta"]);
      $transdetprestamo_id = utf8_encode($valor["transdetprestamo_id"]);
      $transprestamo_id = utf8_encode($valor["transprestamo_id"]);
      $l_tipometal_id = utf8_encode($valor["l_tipometal_id"]);
      $l_estadoconservacion_id = utf8_encode($valor["l_estadoconservacion_id"]);
      $l_kilataje_id = utf8_encode($valor["l_kilataje_id"]);
      $l_tipoprenda_id = utf8_encode($valor["l_tipoprenda_id"]);
      $transdetprestamo_gramo = utf8_encode($valor["transdetprestamo_gramo"]);
      $transdetprestamo_preciogramo = utf8_encode($valor["transdetprestamo_preciogramo"]);
      $transdetprestamo_monto = utf8_encode($valor["transdetprestamo_monto"]);
      $l_tipomoneda_id = utf8_encode($valor["l_tipomoneda_id"]);
      $l_paisorigen_id = utf8_encode($valor["l_paisorigen_id"]);
      $l_rango_id = utf8_encode($valor["l_rango_id"]);
      $l_tipocreditosuizo_id = utf8_encode($valor["l_tipocreditosuizo_id"]);
      $transdetprestamo_articulo = utf8_encode($valor["transdetprestamo_articulo"]);
      $transdetprestamo_marca = utf8_encode($valor["transdetprestamo_marca"]);
      $transdetprestamo_modelo = utf8_encode($valor["transdetprestamo_modelo"]);
      $l_tipoarticulo_id = utf8_encode($valor["l_tipoarticulo_id"]);
      $transdetprestamo_activo = utf8_encode($valor["transdetprestamo_activo"]);
      $transdetprestamo_fechareg = utf8_encode($valor["transdetprestamo_fechareg"]);
      $tipoprenda_nombre = utf8_encode($valor["tipoprenda_nombre"]);
      $tipometal_nombre = utf8_encode($valor["tipometal_nombre"]);
      $kilataje_nombre = utf8_encode($valor["kilataje_nombre"]);

      $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
      $trans_fechavenc = utf8_encode($valor["trans_fechavenc"]);
      $transprestamo_id = utf8_encode($valor["transprestamo_id"]);
      $l_tiposolicitud_id = utf8_encode($valor["l_tiposolicitud_id"]);
      $l_tipoprestamo_id = utf8_encode($valor["l_tipoprestamo_id"]);
      $l_porcdescuento_id = utf8_encode($valor["l_porcdescuento_id"]);
      $transprestamo_montodesc = utf8_encode($valor["transprestamo_montodesc"]);
      $l_plazovenc_id = utf8_encode($valor["l_plazovenc_id"]);
      $transprestamo_plazovalor = utf8_encode($valor["transprestamo_plazovalor"]);
      $l_periodocobro_id = utf8_encode($valor["l_periodocobro_id"]);
      $transprestamo_periodovalor = utf8_encode($valor["transprestamo_periodovalor"]);
      $l_tipocliente_id = utf8_encode($valor["l_tipocliente_id"]);
      $transprestamo_montodeseacliente = utf8_encode($valor["transprestamo_montodeseacliente"]);
      $transprestamo_porc = utf8_encode($valor["transprestamo_porc"]);
      $transprestamo_montoavaluo = utf8_encode($valor["transprestamo_montoavaluo"]);
      $trans_id = utf8_encode($valor["trans_id"]);
      $trans_montototal = utf8_encode($valor["trans_montototal"]);
      $trans_codigo = utf8_encode($valor["trans_codigo"]);
      $compania_id = utf8_encode($valor["compania_id"]);
      $l_moneda_id = utf8_encode($valor["l_moneda_id"]);
      $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
      $cliente_id = utf8_encode($valor["cliente_id"]);
      $trans_fechareg = utf8_encode($valor["trans_fechareg"]);
      $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
      $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
      $compania_nombre = utf8_encode($valor["compania_nombre"]);
      $compania_cedula = utf8_encode($valor["compania_cedula"]);
      $compania_telf = utf8_encode($valor["compania_telf"]);
      $compania_email = utf8_encode($valor["compania_email"]);
      $compania_direccion = utf8_encode($valor["compania_direccion"]);      
      $compania_razonsocial = utf8_encode($valor["compania_razonsocial"]);
      $sucursal_id = utf8_encode($valor["sucursal_id"]);
      $cuenta_id = utf8_encode($valor["cuenta_id"]);
      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $trans_fecha = utf8_encode($valor["trans_fecha"]);
      $vendedor_id = utf8_encode($valor["vendedor_id"]);  
      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);  
      $estatus_cod = utf8_encode($valor["estatus_cod"]);  
 

        if ($trans_activo=="0"){
        $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
      }else{
        $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
      }
      
      $accioneliminar = "<i onclick='eliminartransaccion(\"".$trans_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

      
      $modificar = "<a href='registrarprestamo?id=$trans_id&cu=$cuenta_id&co=$compania_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";   
   

    $prestamo = "
        <a href='prestamodetalle?id=$trans_id'>
          Ver Cuotas
        </a>";
      

      $transprestamocuota_monto = number_format_personalizado($transprestamocuota_monto, $moneda_siglas);
      $transprestamocuota_montocapitalresta = number_format_personalizado($transprestamocuota_montocapitalresta, $moneda_siglas);
      $transprestamocuota_montoabonado = number_format_personalizado($transprestamocuota_montoabonado, $moneda_siglas);
      $transprestamocuota_montopendiente = number_format_personalizado($transprestamocuota_montopendiente, $moneda_siglas);
      $transprestamocuota_montomora = number_format_personalizado($transprestamocuota_montomora, $moneda_siglas);

      if (P_Mod!="1"){$modificar = ""; $activo = "";}
      if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

      $mostrarcolumnacuenta = "<td>$cuenta</td>";
      $mostrarcolumnacompania = "<td>$compania_nombre</td>";

      if ($_COOKIE[perfil]=="1"){      
        
      }
      else if ($_COOKIE[perfil]=="2"){       
        $mostrarcolumnacuenta = "";
      }     
      else {
        $columnacuenta = "";
        $mostrarcolumnacuenta = ""; 
        $mostrarcolumnacompania = ""; 
      }

      $moduloactual = 1129;
      $formapagoventa = "<a href='pagoformapago?id=$transprestamocuota_id&cu=$cuenta_id&co=$compania_id&m=$moduloactual'>
        <img title='Registrar Pago' style='cursor:pointer; height: 24px; width: 20px' src='dist/img/registrarpago.png'>
      </a>";

      if ($estatuscuota_cod!="1" && $estatuscuota_cod!="3" && $estatuscuota_cod!="4"){
        $formapagoventa = "";
      }else{
        if ($cont==0){
          
          
        }else{
          $formapagoventa = "";
        }

        $cont = $cont + 1;
      }

      $trans_codigo = "
        <a href='prestamodetalle?id=$trans_id'>
          $trans_codigo (Ver Préstamo)
        </a>";

      
      if ($transprestamocuota_id!=""){

        $textohtml .= "
          <tr>                               
                  <td>$trans_codigo</td>
                  <td>$usuario_nombre $usuario_apellido</td>                  
                  <td>$transprestamocuota_nro</td>
                  <td>$transprestamocuota_monto</td>
                  <td>$transprestamocuota_montopendiente</td>
                  <td>$transprestamocuota_montoabonado</td> 
                  <td>$transprestamocuota_montomora</td>                                    
                  <td>$transprestamocuota_fechavenc</td>    
                  <td>$transprestamocuota_montocapitalresta</td>                            
                  <td>$estatuscuota_nombre</td>                                            
                  <td style='text-align: center'>$formapagoventa &nbsp $modificarrr &nbsp $activorrrr &nbsp $accioneliminarrrr </td>
              </tr>
        ";
      }

  }   


  return $textohtml;

}


function obtenerPrestamosPorCliente($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $trans_id=null, $tipocod=null, $trans_codigo=null, $diasvencer=null, $tiposolicitud=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($tipocod==""){$tipocod=2;}


  if ($fechadesde=="" && $fechahasta==""){
    //$wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (transaccion.trans_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($diasvencer>0){
    $fecha2 = date("Y-m-d H:i:s",strtotime($fechaactual." $diasvencer days"));    
    $wherefecha = " and (transprestamo.transprestamo_fechavenc <= '$fecha2 23:59:59' ) "; 
  }

  if ($sinfiltrofecha=="1"){
    $wherefecha = "";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if($trans_id!=""){
    $where .= " and transaccion.trans_id = '$trans_id' ";
    $wherefecha = "";
  }

  if($getestatus!=""){
    $whereestatus = " and transaccion.l_estatus_id in ('$getestatus') ";
  }

  if($trans_codigo!=""){
    $wheretrans_codigo = " and transaccion.trans_codigo = '$trans_codigo' ";
  }

  
  if($tiposolicitud!=""){
    $where .= " and transprestamo.l_tiposolicitud_id = '$tiposolicitud' ";
  }  

  $conexion = new ConexionBd(); 

  $arrresultado = $conexion->doSelect("
      count(transaccion.trans_id) as total,
      sum(transprestamo.transprestamo_montoresta) as suma,
      usuario.usuario_id,
      usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_whatsapp,
      moneda.lista_nombredos as moneda_siglas,
      tipotransaccion.lista_cod as tiposolicitud_cod 
    ",
    "transaccion      
        
        inner join transprestamo on transprestamo.trans_id = transaccion.trans_id        
        inner join lista tipotransaccion on tipotransaccion.lista_id = transprestamo.l_tiposolicitud_id
        inner join compania on transaccion.compania_id = compania.compania_id
        inner join usuario on transaccion.cliente_id = usuario.usuario_id
        inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id
        inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
        inner join sucursal on sucursal.sucursal_id = transaccion.sucursal_id
        left join lista tipoprestamo on tipoprestamo.lista_id = transprestamo.l_tipoprestamo_id
        left join productoprestamo on productoprestamo.prodprestamo_id = transprestamo.prodprestamo_id
        left join lista periodocobro on periodocobro.lista_id = productoprestamo.l_periodocobro_id
    ",
    "trans_eliminado = '0'  $wherefecha $where $whereestatus $wheretrans_codigo ", "usuario.usuario_id, usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_whatsapp, moneda.lista_nombredos  ", "count(transaccion.trans_id) desc");

  foreach($arrresultado as $i=>$valor){

    $total = utf8_encode($valor["total"]);
    $suma = utf8_encode($valor["suma"]);
    $usuario_id = utf8_encode($valor["usuario_id"]);    
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_whatsapp = utf8_encode($valor["usuario_whatsapp"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
    $tiposolicitud_cod = utf8_encode($valor["tiposolicitud_cod"]);

    $suma  = number_format_personalizado($suma, $moneda_siglas);  

    if ($usuario_whatsapp!=""){
      $usuario_whatsapp = "
        $usuario_whatsapp 
        <a href='https://api.whatsapp.com/send?phone=$usuario_whatsapp' target='_blank'>
        <img src='dist/img/whatsapp.png' style='height: 25px'>
        </a>  
      ";  
    }

    $urlir = "prestamos?uid=$usuario_id";

    if($tiposolicitud_cod=="2"){
      $urlir = "prestamosletras?uid=$usuario_id";
    }

      $estadocuenta = "        
        <a href='prestamosestadocuentapdf?id=$usuario_id' target='_blank'>
          Ver Estado de Cuenta
        </a>  
      ";  

      $total = "        
        <a href='$urlir?uid=$usuario_id'>
          $total (Ver Préstamos)
        </a>  
      ";  
    
    
    
    $textohtml .= "
        <tr>                               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
            <td>$usuario_nombre $usuario_apellido</td>            
            <td>$usuario_whatsapp</td>
            <td>$estadocuenta </td>
            <td>$suma</td>
            <td>$total</td>                       
        </tr>
    ";

  }   

  return $textohtml;

}

function obtenerPrestamoDetalle($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $trans_id=null){

  $fechaactual = formatoFechaHoraBd(1);    


  if ($fechadesde=="" && $fechahasta==""){
    //$wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (transaccion.trans_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($sinfiltrofecha=="1"){
    $wherefecha = "";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if($trans_id!=""){
    $where .= " and transaccion.trans_id = '$trans_id' ";
    $wherefecha = "";
  }

  if($getestatus!=""){
    $whereestatus = " and transaccion.l_estatus_id in ('$getestatus') ";
  }

  $conexion = new ConexionBd(); 

  $arrresultado = $conexion->doSelect("transaccion.trans_id, trans_montototal, trans_codigo, 
      transaccion.compania_id, transaccion.l_moneda_id,  
      transaccion.l_formapago_id, transaccion.cliente_id,
      DATE_FORMAT(trans_fechareg,'%d/%m/%Y %H:%i:%s') as trans_fechareg, usuario_nombre, usuario_apellido, 
      compania_nombre, compania_cedula, compania_telf, 
      compania_email, compania_direccion, compania_razonsocial, 
      transaccion.sucursal_id, transaccion.cuenta_id, 
      transaccion.l_estatus_id, DATE_FORMAT(trans_fecha,'%d/%m/%Y') as trans_fecha, 
      transaccion.vendedor_id,      
      transprestamo.transprestamo_id, transprestamo.trans_id, transprestamo.l_tiposolicitud_id, 
      transprestamo.l_tipoprestamo_id, transprestamo.l_porcdescuento_id, 
      transprestamo.transprestamo_montodesc, transprestamo.l_plazovenc_id, 
      transprestamo.transprestamo_plazovalor, transprestamo.l_periodocobro_id, 
      transprestamo.transprestamo_periodovalor, transprestamo.l_tipocliente_id, 
      transprestamo.transprestamo_montodeseacliente, transprestamo.transprestamo_porc, 
      transprestamo.transprestamo_montoavaluo,
      DATE_FORMAT(transaccion.trans_fechavenc,'%d/%m/%Y') as trans_fechavenc,
      estatus.lista_nombre as estatus_nombre,
      moneda.lista_nombredos as moneda_siglas,

      transdetprestamo.transdetprestamo_id, transdetprestamo.transprestamo_id, 
      transdetprestamo.l_tipometal_id, transdetprestamo.l_estadoconservacion_id, 
      transdetprestamo.l_kilataje_id, transdetprestamo.l_tipoprenda_id, 
      transdetprestamo.transdetprestamo_gramo, transdetprestamo.transdetprestamo_preciogramo, 
      transdetprestamo.transdetprestamo_monto, transdetprestamo.l_tipomoneda_id, 
      transdetprestamo.l_paisorigen_id, transdetprestamo.l_rango_id, 
      transdetprestamo.l_tipocreditosuizo_id, transdetprestamo.transdetprestamo_articulo, 
      transdetprestamo.transdetprestamo_marca, transdetprestamo.transdetprestamo_modelo, 
      transdetprestamo.l_tipoarticulo_id, transdetprestamo.transdetprestamo_activo, 
      transdetprestamo.transdetprestamo_eliminado, transdetprestamo_fechareg,

      tipoprenda.lista_nombre as tipoprenda_nombre,
      tipometal.lista_nombre as tipometal_nombre,
      kilataje.lista_nombre as kilataje_nombre,
      sucursal_nombre

    ",
    "transaccion      
        inner join lista tipotransaccion on tipotransaccion.lista_id = transaccion.l_tipotrans_id
        inner join transprestamo on transprestamo.trans_id = transaccion.trans_id  
        inner join transdetprestamo on transdetprestamo.transprestamo_id = transprestamo.transprestamo_id       
        inner join compania on transaccion.compania_id = compania.compania_id
        inner join usuario on transaccion.cliente_id = usuario.usuario_id
        inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id
        inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
        inner join sucursal on sucursal.sucursal_id = transaccion.sucursal_id

        left join lista tipoprenda on tipoprenda.lista_id = transdetprestamo.l_tipoprenda_id
        left join lista tipometal on tipometal.lista_id = transdetprestamo.l_tipometal_id
        left join lista kilataje on kilataje.lista_id = transdetprestamo.l_kilataje_id
        

    ",
    "trans_eliminado = '0' and tipotransaccion.lista_cod = '7' $wherefecha $where $whereestatus ", null, "transaccion.trans_id desc");

  if ($trans_id!=""){    
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

      $sucursal_nombre = utf8_encode($valor["sucursal_nombre"]);
      $transdetprestamo_id = utf8_encode($valor["transdetprestamo_id"]);
      $transprestamo_id = utf8_encode($valor["transprestamo_id"]);
      $l_tipometal_id = utf8_encode($valor["l_tipometal_id"]);
      $l_estadoconservacion_id = utf8_encode($valor["l_estadoconservacion_id"]);
      $l_kilataje_id = utf8_encode($valor["l_kilataje_id"]);
      $l_tipoprenda_id = utf8_encode($valor["l_tipoprenda_id"]);
      $transdetprestamo_gramo = utf8_encode($valor["transdetprestamo_gramo"]);
      $transdetprestamo_preciogramo = utf8_encode($valor["transdetprestamo_preciogramo"]);
      $transdetprestamo_monto = utf8_encode($valor["transdetprestamo_monto"]);
      $l_tipomoneda_id = utf8_encode($valor["l_tipomoneda_id"]);
      $l_paisorigen_id = utf8_encode($valor["l_paisorigen_id"]);
      $l_rango_id = utf8_encode($valor["l_rango_id"]);
      $l_tipocreditosuizo_id = utf8_encode($valor["l_tipocreditosuizo_id"]);
      $transdetprestamo_articulo = utf8_encode($valor["transdetprestamo_articulo"]);
      $transdetprestamo_marca = utf8_encode($valor["transdetprestamo_marca"]);
      $transdetprestamo_modelo = utf8_encode($valor["transdetprestamo_modelo"]);
      $l_tipoarticulo_id = utf8_encode($valor["l_tipoarticulo_id"]);
      $transdetprestamo_activo = utf8_encode($valor["transdetprestamo_activo"]);
      $transdetprestamo_fechareg = utf8_encode($valor["transdetprestamo_fechareg"]);
      $tipoprenda_nombre = utf8_encode($valor["tipoprenda_nombre"]);
      $tipometal_nombre = utf8_encode($valor["tipometal_nombre"]);
      $kilataje_nombre = utf8_encode($valor["kilataje_nombre"]);

      $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
      $trans_fechavenc = utf8_encode($valor["trans_fechavenc"]);
      $transprestamo_id = utf8_encode($valor["transprestamo_id"]);
      $l_tiposolicitud_id = utf8_encode($valor["l_tiposolicitud_id"]);
      $l_tipoprestamo_id = utf8_encode($valor["l_tipoprestamo_id"]);
      $l_porcdescuento_id = utf8_encode($valor["l_porcdescuento_id"]);
      $transprestamo_montodesc = utf8_encode($valor["transprestamo_montodesc"]);
      $l_plazovenc_id = utf8_encode($valor["l_plazovenc_id"]);
      $transprestamo_plazovalor = utf8_encode($valor["transprestamo_plazovalor"]);
      $l_periodocobro_id = utf8_encode($valor["l_periodocobro_id"]);
      $transprestamo_periodovalor = utf8_encode($valor["transprestamo_periodovalor"]);
      $l_tipocliente_id = utf8_encode($valor["l_tipocliente_id"]);
      $transprestamo_montodeseacliente = utf8_encode($valor["transprestamo_montodeseacliente"]);
      $transprestamo_porc = utf8_encode($valor["transprestamo_porc"]);
      $transprestamo_montoavaluo = utf8_encode($valor["transprestamo_montoavaluo"]);
      $trans_id = utf8_encode($valor["trans_id"]);
      $trans_montototal = utf8_encode($valor["trans_montototal"]);
      $trans_codigo = utf8_encode($valor["trans_codigo"]);
      $compania_id = utf8_encode($valor["compania_id"]);
      $l_moneda_id = utf8_encode($valor["l_moneda_id"]);
      $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
      $cliente_id = utf8_encode($valor["cliente_id"]);
      $trans_fechareg = utf8_encode($valor["trans_fechareg"]);
      $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
      $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
      $compania_nombre = utf8_encode($valor["compania_nombre"]);
      $compania_cedula = utf8_encode($valor["compania_cedula"]);
      $compania_telf = utf8_encode($valor["compania_telf"]);
      $compania_email = utf8_encode($valor["compania_email"]);
      $compania_direccion = utf8_encode($valor["compania_direccion"]);      
      $compania_razonsocial = utf8_encode($valor["compania_razonsocial"]);
      $sucursal_id = utf8_encode($valor["sucursal_id"]);
      $cuenta_id = utf8_encode($valor["cuenta_id"]);
      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $trans_fecha = utf8_encode($valor["trans_fecha"]);
      $vendedor_id = utf8_encode($valor["vendedor_id"]);  
      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);  
      $transdetprestamo_preciogramo = number_format($transdetprestamo_preciogramo, 2, ',', '.');
      $transdetprestamo_monto = number_format($transdetprestamo_monto, 2, ',', '.');    
      $transdetprestamo_gramo = number_format($transdetprestamo_gramo, 2, ',', '.');              


      $transprestamo_montoavaluo = number_format($transprestamo_montoavaluo, 2, ',', '.');   

        if ($trans_activo=="0"){
        $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
      }else{
        $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
      }
      
      $accioneliminar = "<i onclick='eliminartransaccion(\"".$trans_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

      
      $modificar = "<a href='registrarprestamo?id=$trans_id&cu=$cuenta_id&co=$compania_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";   
   

    $prestamo = "
        <a href='prestamodetalle?id=$trans_id'>
          Ver Cuotas
        </a>";
      

      $trans_montototal = number_format_personalizado($trans_montototal, $moneda_siglas);

      if (P_Mod!="1"){$modificar = ""; $activo = "";}
      if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

      $mostrarcolumnacuenta = "<td>$cuenta</td>";
      $mostrarcolumnacompania = "<td>$compania_nombre</td>";

      if ($_COOKIE[perfil]=="1"){      
        
      }
      else if ($_COOKIE[perfil]=="2"){       
        $mostrarcolumnacuenta = "";
      }     
      else {
        $columnacuenta = "";
        $mostrarcolumnacuenta = ""; 
        $mostrarcolumnacompania = ""; 
      }
      

      $textohtml .= "
         <tr>                               
                $mostrarcolumnacuenta
                $mostrarcolumnacompania                 
                <td>$sucursal_nombre</td>
                <td>$trans_codigo</td>                
                <td>$usuario_nombre $usuario_apellido</td>
                <td>$trans_fecha</td>                                    
                <td style='text-align: center'>$trans_montototal</td>    
                <td style='text-align: center'>$estatus_nombre</td>                            
                <td style='text-align: center'>$prestamo</td>                            
                <td style='text-align: center'>$trans_fechareg</td>                            
                <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar </td>
            </tr>
      ";

  }   


  return $textohtml;

}

function obtenerPrestamosPorProducto($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $trans_id=null, $tipocod=null, $trans_codigo=null, $diasvencer=null, $tiposolicitud=null, $getusuario=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($tipocod==""){$tipocod=2;}


  if ($fechadesde=="" && $fechahasta==""){
    //$wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (transaccion.trans_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }



  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if($getestatus!=""){
    $whereestatus = " and transaccion.l_estatus_id in ('$getestatus') ";
  }

  if($tiposolicitud!=""){
    $where .= " and transprestamo.l_tiposolicitud_id = '$tiposolicitud' ";
  }

  if($getusuario!=""){
    $where .= " and transaccion.cliente_id = '$getusuario' ";
    //$wherefecha = "";
  }

  


  $conexion = new ConexionBd(); 

  $arrresultado = $conexion->doSelect("sum(transaccion.trans_montototal) as trans_montototal,
  count(transaccion.trans_id) as total,  
  productoprestamo.prodprestamo_nombre,
  moneda.lista_nombredos as moneda_siglas

    ",
    "transaccion      
        
        inner join transprestamo on transprestamo.trans_id = transaccion.trans_id        
        inner join productoprestamo on productoprestamo.prodprestamo_id = transprestamo.prodprestamo_id
        inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
        left join lista tipotransaccion on tipotransaccion.lista_id = transprestamo.l_tiposolicitud_id
        left join compania on transaccion.compania_id = compania.compania_id
        left join usuario on transaccion.cliente_id = usuario.usuario_id
        left join lista estatus on estatus.lista_id = transaccion.l_estatus_id
        
        left join sucursal on sucursal.sucursal_id = transaccion.sucursal_id
        left join lista tipoprestamo on tipoprestamo.lista_id = transprestamo.l_tipoprestamo_id
        
        left join lista periodocobro on periodocobro.lista_id = productoprestamo.l_periodocobro_id
        

    ",
    "trans_activo = '1'  $wherefecha $where $whereestatus $wheretrans_codigo ", "prodprestamo_nombre", "count(transaccion.trans_id) desc");


  foreach($arrresultado as $i=>$valor){
    
    $trans_montototal = utf8_encode($valor["trans_montototal"]);
    $total = utf8_encode($valor["total"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
    $prodprestamo_nombre = utf8_encode($valor["prodprestamo_nombre"]);

    $trans_montototal = number_format_personalizado($trans_montototal, $moneda_siglas);
    

    $textohtml .= "
      <tr>                               
          <td>$total</td>
          <td>$trans_montototal</td>
          <td>$prodprestamo_nombre</td>          
      </tr>
    ";
  }

  return $textohtml;

}  


function obtenerPrestamos($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $trans_id=null, $tipocod=null, $trans_codigo=null, $diasvencer=null, $tiposolicitud=null, $getcliente=null, $pdf=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($tipocod==""){$tipocod=2;}


  if ($fechadesde=="" && $fechahasta==""){
    //$wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (transaccion.trans_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (transaccion.trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($diasvencer>0){
    $fecha2 = date("Y-m-d H:i:s",strtotime($fechaactual." $diasvencer days"));    
    $wherefecha = " and (transprestamo.transprestamo_fechavenc <= '$fecha2 23:59:59' ) "; 
  }

  if ($sinfiltrofecha=="1"){
    $wherefecha = "";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if($trans_id!=""){
    $where .= " and transaccion.trans_id = '$trans_id' ";
    $wherefecha = "";
  }

  if($getestatus!=""){
    $whereestatus = " and transaccion.l_estatus_id in ('$getestatus') ";
  }

  if($trans_codigo!=""){
    $wheretrans_codigo = " and transaccion.trans_codigo = '$trans_codigo' ";
  }

  
  if($tiposolicitud!="" && $pdf!="1"){
    $where .= " and transprestamo.l_tiposolicitud_id = '$tiposolicitud' ";
  }

  if($getcliente!=""){
    $where .= " and transaccion.cliente_id = '$getcliente' ";
    //$wherefecha = "";
  }



  
  


  $conexion = new ConexionBd(); 

  $arrresultado = $conexion->doSelect("transaccion.trans_id, trans_montototal, trans_codigo, 
      transaccion.compania_id, transaccion.l_moneda_id,  
      transaccion.l_formapago_id, transaccion.cliente_id,
      DATE_FORMAT(trans_fechareg,'%d/%m/%Y %H:%i:%s') as trans_fechareg, usuario_nombre, usuario_apellido, 
      usuario_whatsapp,
      compania_nombre, compania_cedula, compania_telf, 
      compania_email, compania_direccion, compania_razonsocial, 
      transaccion.sucursal_id, transaccion.cuenta_id, 
      transaccion.l_estatus_id, DATE_FORMAT(trans_fecha,'%d/%m/%Y') as trans_fecha, 
      transaccion.vendedor_id, transprestamo_montoresta,
      transprestamo.transprestamo_id, transprestamo.trans_id, transprestamo.l_tiposolicitud_id, 
      transprestamo.l_tipoprestamo_id, transprestamo.l_porcdescuento_id, 
      transprestamo.transprestamo_montodesc, transprestamo.l_plazovenc_id, 
      transprestamo.transprestamo_plazovalor, transprestamo.l_periodocobro_id, 
      transprestamo.transprestamo_periodovalor, transprestamo.l_tipocliente_id, 
      transprestamo.transprestamo_montodeseacliente, transprestamo.transprestamo_porc, 
      transprestamo.transprestamo_montoavaluo, 
      transprestamo_montoentregar, transprestamo_montoletra,

      DATE_FORMAT(transaccion.trans_fechavenc,'%d/%m/%Y') as trans_fechavenc,
      DATE_FORMAT(transprestamo.transprestamo_fechavenc,'%d/%m/%Y') as transprestamo_fechavenc,
      DATE_FORMAT(transprestamo.transprestamo_fechaletra,'%d/%m/%Y') as transprestamo_fechaletra,

      estatus.lista_nombre as estatus_nombre,
      estatus.lista_cod as estatus_cod,
      moneda.lista_nombredos as moneda_siglas,
      transprestamo.prodprestamo_id,
      productoprestamo.prodprestamo_id, productoprestamo.prodprestamo_nombre, 
      productoprestamo.prodprestamo_porc, productoprestamo.l_periodocobro_id, 
      productoprestamo.prodprestamo_cantidad, productoprestamo.prodprestamo_interes, 
      productoprestamo.prodprestamo_custodia, productoprestamo.prodprestamo_seguro, 
      productoprestamo.prodprestamo_comision, productoprestamo.prodprestamo_moradiario, 
      productoprestamo.prodprestamo_cat,
      moneda.lista_nombredos as moneda_siglas,
      periodocobro.lista_nombre as periodocobro_nombre,
      sucursal_nombre,
      tipoprestamo.lista_nombre as tipoprestamo_nombre,
      tipotransaccion.lista_cod as tiposolicitud_cod

    ",
    "transaccion      
        
        inner join transprestamo on transprestamo.trans_id = transaccion.trans_id        
        inner join lista tipotransaccion on tipotransaccion.lista_id = transprestamo.l_tiposolicitud_id
        inner join compania on transaccion.compania_id = compania.compania_id
        inner join usuario on transaccion.cliente_id = usuario.usuario_id
        inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id
        inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
        inner join sucursal on sucursal.sucursal_id = transaccion.sucursal_id
        left join lista tipoprestamo on tipoprestamo.lista_id = transprestamo.l_tipoprestamo_id
        left join productoprestamo on productoprestamo.prodprestamo_id = transprestamo.prodprestamo_id
        left join lista periodocobro on periodocobro.lista_id = productoprestamo.l_periodocobro_id
        

    ",
    "trans_eliminado = '0'  $wherefecha $where $whereestatus $wheretrans_codigo ", null, "transaccion.trans_id desc");

    // and tipotransaccion.lista_cod = '$tipocod'

  if ($trans_id!=""){    
    return $arrresultado;
  }

  //prodprestamo_porc

  foreach($arrresultado as $i=>$valor){

    $transprestamo_montoentregar = utf8_encode($valor["transprestamo_montoentregar"]);
    $transprestamo_fechaletra = utf8_encode($valor["transprestamo_fechaletra"]);
    $transprestamo_montoletra = utf8_encode($valor["transprestamo_montoletra"]);
    $transprestamo_montoresta = utf8_encode($valor["transprestamo_montoresta"]);
    
    $tiposolicitud_cod = utf8_encode($valor["tiposolicitud_cod"]);

    
    
    $usuario_whatsapp = utf8_encode($valor["usuario_whatsapp"]);
    $transprestamo_fechavenc = utf8_encode($valor["transprestamo_fechavenc"]);
    $tipoprestamo_nombre = utf8_encode($valor["tipoprestamo_nombre"]);
    $sucursal_nombre = utf8_encode($valor["sucursal_nombre"]);
    $estatus_cod = utf8_encode($valor["estatus_cod"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
    $trans_fechavenc = utf8_encode($valor["trans_fechavenc"]);
    $transprestamo_id = utf8_encode($valor["transprestamo_id"]);
    $l_tiposolicitud_id = utf8_encode($valor["l_tiposolicitud_id"]);
    $l_tipoprestamo_id = utf8_encode($valor["l_tipoprestamo_id"]);
    $l_porcdescuento_id = utf8_encode($valor["l_porcdescuento_id"]);
    $transprestamo_montodesc = utf8_encode($valor["transprestamo_montodesc"]);
    $l_plazovenc_id = utf8_encode($valor["l_plazovenc_id"]);
    $transprestamo_plazovalor = utf8_encode($valor["transprestamo_plazovalor"]);
    $l_periodocobro_id = utf8_encode($valor["l_periodocobro_id"]);
    $transprestamo_periodovalor = utf8_encode($valor["transprestamo_periodovalor"]);
    $l_tipocliente_id = utf8_encode($valor["l_tipocliente_id"]);
    $transprestamo_montodeseacliente = utf8_encode($valor["transprestamo_montodeseacliente"]);
    $transprestamo_porc = utf8_encode($valor["transprestamo_porc"]);
    $transprestamo_montoavaluo = utf8_encode($valor["transprestamo_montoavaluo"]);
      $trans_id = utf8_encode($valor["trans_id"]);
      $trans_montototal = utf8_encode($valor["trans_montototal"]);
      $trans_codigo = utf8_encode($valor["trans_codigo"]);
      $compania_id = utf8_encode($valor["compania_id"]);
      $l_moneda_id = utf8_encode($valor["l_moneda_id"]);
      $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
      $cliente_id = utf8_encode($valor["cliente_id"]);
      $trans_fechareg = utf8_encode($valor["trans_fechareg"]);
      $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
      $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
      $compania_nombre = utf8_encode($valor["compania_nombre"]);
      $compania_cedula = utf8_encode($valor["compania_cedula"]);
      $compania_telf = utf8_encode($valor["compania_telf"]);
      $compania_email = utf8_encode($valor["compania_email"]);
      $compania_direccion = utf8_encode($valor["compania_direccion"]);      
      $compania_razonsocial = utf8_encode($valor["compania_razonsocial"]);
      $sucursal_id = utf8_encode($valor["sucursal_id"]);
      $cuenta_id = utf8_encode($valor["cuenta_id"]);
      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $trans_fecha = utf8_encode($valor["trans_fecha"]);
      $vendedor_id = utf8_encode($valor["vendedor_id"]);  
      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);  

      $prodprestamo_id = utf8_encode($valor["prodprestamo_id"]);
      $prodprestamo_nombre = utf8_encode($valor["prodprestamo_nombre"]);
      $prodprestamo_porc = utf8_encode($valor["prodprestamo_porc"])."%";
      $l_periodocobro_id = utf8_encode($valor["l_periodocobro_id"]);
      $prodprestamo_cantidad = utf8_encode($valor["prodprestamo_cantidad"]);
      $prodprestamo_interes = utf8_encode($valor["prodprestamo_interes"])."%";
      $prodprestamo_custodia = utf8_encode($valor["prodprestamo_custodia"]."%");
      $prodprestamo_seguro = utf8_encode($valor["prodprestamo_seguro"])."%";
      $prodprestamo_comision = utf8_encode($valor["prodprestamo_comision"])."%";
      $prodprestamo_moradiario = utf8_encode($valor["prodprestamo_moradiario"])."%";
      $prodprestamo_cat = utf8_encode($valor["prodprestamo_cat"])."%";
      $prodprestamo_activo = utf8_encode($valor["prodprestamo_activo"]);
      $prodprestamo_fechareg = utf8_encode($valor["prodprestamo_fechareg"]);
      $prodprestamo_fechamod = utf8_encode($valor["prodprestamo_fechamod"]);


      $transprestamo_montoavaluo = number_format($transprestamo_montoavaluo, 2, ',', '.');   

        if ($trans_activo=="0"){
        $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
      }else{
        $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
      }
      
      $accioneliminar = "<i onclick='eliminartransaccion(\"".$trans_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

      $urlregistrar = "registrarprestamo?id=$trans_id&cu=$cuenta_id&co=$compania_id";
      
      if ($tiposolicitud_cod=="2"){
        $urlregistrar = "registrarprestamoletra?id=$trans_id&cu=$cuenta_id&co=$compania_id";
      }
      
      $modificar = "<a href='$urlregistrar'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";   
   

      $prestamo = "
        <a href='prestamodetalle?id=$trans_id'>
          Ver Cuotas
        </a>";

      

      

      $mostrarcolumnacuenta = "<td>$cuenta</td>";
      $mostrarcolumnacompania = "<td>$compania_nombre</td>";

      if ($_COOKIE[perfil]=="1"){      
        
      }
      else if ($_COOKIE[perfil]=="2"){       
        $mostrarcolumnacuenta = "";
      }
      else {      
        $mostrarcolumnacuenta = "";
        $mostrarcolumnacompania = ""; 
      }
      

      $trans_montototal = number_format_personalizado($trans_montototal, $moneda_siglas);
      $transprestamo_montoresta = number_format_personalizado($transprestamo_montoresta, $moneda_siglas);
      $transprestamo_montoentregar = number_format_personalizado($transprestamo_montoentregar, $moneda_siglas);
      

      if($pdf!=""){

        $texto = "Prestamo";

        if ($tiposolicitud_cod=="2"){
          $texto = "Letra";
        }
        

        $textohtml .= "
         <tr style='border: 1px solid #EBEAE9; padding-top: 15px; padding-bottom: 5px;'>
            <td>$texto</td>   
            <td>#$trans_codigo</td>
            <td>$trans_fecha</td>            
            <td>$trans_montototal</td>            
            <td>$transprestamo_montoresta</td>                                    
            <td style='text-align: center'>$transprestamo_fechavenc</td>    
        </tr>
      ";

      }else{

        if ($estatus_cod=="1"){

          $prestamo = "";

          $trans_codigo = "
          <a href='$urlregistrar'>
            $trans_codigo (Ver)
          </a>";
  
        }else{
          
          $trans_codigo = "
          <a href='prestamodetalle?id=$trans_id'>
            $trans_codigo (Ver)
          </a>";
        }

        

        if ($usuario_whatsapp!=""){
          $usuario_whatsapp = "
            $usuario_whatsapp 
            <a href='https://api.whatsapp.com/send?phone=$usuario_whatsapp'  target='_blank'>
              <img src='dist/img/whatsapp.png' style='height: 25px'>
            </a>  
          ";  
        }

        $textohtml .= "
         <tr>                               

            
            <td>$tipoprestamo_nombre</td>
            <td>$trans_codigo</td>
            <td>$usuario_nombre $usuario_apellido $usuario_whatsapp</td>
            <td>$trans_fecha</td>            
            <td>$transprestamo_fechavenc</td>                                    
            <td style='text-align: center'>$transprestamo_montoentregar</td>    
            <td style='text-align: center'>$estatus_nombre</td>                            
            <td style='text-align: center'>$prestamo</td>                            
            <td style='text-align: center'>$trans_fechareg</td>                            
            <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar </td>
        </tr>
      ";

      }
      

  }   

  return $textohtml;

}

function asignarPrestamoCuotas($trans_id=null, $compania_id=null, $sucursal_id=null, $reprocesar=null){

  $conexion = new ConexionBd();    

  $instancialista = new Lista();
        
  $obtenerIdLista = 1;
  $obtenerTipoLista = 224;
  $idestatuspendiente = $instancialista->ObtenerIdLista($obtenerIdLista, $obtenerTipoLista);

  $arrresultado = $conexion->doSelect("transaccion.trans_id, trans_montototal, trans_codigo, 
      transaccion.compania_id, transaccion.l_moneda_id,  
      transaccion.l_formapago_id, transaccion.cliente_id,
      DATE_FORMAT(trans_fechareg,'%d/%m/%Y %H:%i:%s') as trans_fechareg, usuario_nombre, usuario_apellido, 
      compania_nombre, compania_cedula, compania_telf, 
      compania_email, compania_direccion, compania_razonsocial, 
      transaccion.sucursal_id, transaccion.cuenta_id, 
      transaccion.l_estatus_id, DATE_FORMAT(trans_fecha,'%d/%m/%Y') as trans_fecha, 
      DATE_FORMAT(trans_fecha,'%Y-%m-%d') as trans_fechadate, 
      transaccion.vendedor_id,      
      transprestamo.transprestamo_id, transprestamo.trans_id, transprestamo.l_tiposolicitud_id, 
      transprestamo.l_tipoprestamo_id, transprestamo.l_porcdescuento_id, 
      transprestamo.transprestamo_montodesc, transprestamo.l_plazovenc_id, 
      transprestamo.transprestamo_plazovalor, transprestamo.l_periodocobro_id, 
      transprestamo.transprestamo_periodovalor, transprestamo.l_tipocliente_id, 
      transprestamo.transprestamo_montodeseacliente, transprestamo.transprestamo_porc, 
      transprestamo.transprestamo_montoavaluo, transprestamo_montoresta,
      DATE_FORMAT(transaccion.trans_fechavenc,'%d/%m/%Y') as trans_fechavenc,      
      periodocobro.lista_cod as periodocobro_cod,
      estatus.lista_cod as estatus_cod,
      trans_procesado,
      transprestamo.prodprestamo_id,
      productoprestamo.prodprestamo_id, productoprestamo.prodprestamo_nombre, 
      productoprestamo.prodprestamo_porc, productoprestamo.l_periodocobro_id, 
      productoprestamo.prodprestamo_cantidad, productoprestamo.prodprestamo_interes, 
      productoprestamo.prodprestamo_custodia, productoprestamo.prodprestamo_seguro, 
      productoprestamo.prodprestamo_comision, productoprestamo.prodprestamo_moradiario, 
      productoprestamo.prodprestamo_cat,      
      periodocobro.lista_nombre as periodocobro_nombre,
      tiposolicitud.lista_cod as tiposolicitud_cod,
      transprestamo_montoentregar

    ",
    "transaccion      
        inner join lista tipotransaccion on tipotransaccion.lista_id = transaccion.l_tipotrans_id        
        inner join transprestamo on transprestamo.trans_id = transaccion.trans_id        
        inner join lista tiposolicitud on tiposolicitud.lista_id = transprestamo.l_tiposolicitud_id
        inner join compania on transaccion.compania_id = compania.compania_id
        inner join usuario on transaccion.cliente_id = usuario.usuario_id
        
        inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id

        left join productoprestamo on productoprestamo.prodprestamo_id = transprestamo.prodprestamo_id
        left join lista periodocobro on periodocobro.lista_id = productoprestamo.l_periodocobro_id        

    ",
    "trans_eliminado = '0'  and transaccion.trans_id = '$trans_id' ", null, "transaccion.trans_id asc");
  foreach($arrresultado as $i=>$valor){

    // and tipotransaccion.lista_cod = '7'
    
    $transprestamo_montoentregar = utf8_encode($valor["transprestamo_montoentregar"]);
    $tiposolicitud_cod = utf8_encode($valor["tiposolicitud_cod"]);
    $trans_procesado = utf8_encode($valor["trans_procesado"]);
    $estatus_cod = utf8_encode($valor["estatus_cod"]);
    $periodocobro_cod = utf8_encode($valor["periodocobro_cod"]);
    $trans_fechavenc = utf8_encode($valor["trans_fechavenc"]);
    $transprestamo_id = utf8_encode($valor["transprestamo_id"]);
    $l_tiposolicitud_id = utf8_encode($valor["l_tiposolicitud_id"]);
    $l_tipoprestamo_id = utf8_encode($valor["l_tipoprestamo_id"]);
    $l_porcdescuento_id = utf8_encode($valor["l_porcdescuento_id"]);
    $transprestamo_montodesc = utf8_encode($valor["transprestamo_montodesc"]);
    $l_plazovenc_id = utf8_encode($valor["l_plazovenc_id"]);
    $transprestamo_plazovalor = utf8_encode($valor["transprestamo_plazovalor"]);
    $l_periodocobro_id = utf8_encode($valor["l_periodocobro_id"]);
    $transprestamo_periodovalor = utf8_encode($valor["transprestamo_periodovalor"]);
    $l_tipocliente_id = utf8_encode($valor["l_tipocliente_id"]);
    $transprestamo_montodeseacliente = utf8_encode($valor["transprestamo_montodeseacliente"]);
    $transprestamo_porc = utf8_encode($valor["transprestamo_porc"]);
    $transprestamo_montoavaluo = utf8_encode($valor["transprestamo_montoavaluo"]);
    $trans_id = utf8_encode($valor["trans_id"]);
    $trans_montototal = utf8_encode($valor["trans_montototal"]);
    $transprestamo_montoresta = utf8_encode($valor["transprestamo_montoresta"]);
    
    $trans_codigo = utf8_encode($valor["trans_codigo"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_moneda_id = utf8_encode($valor["l_moneda_id"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $cliente_id = utf8_encode($valor["cliente_id"]);
    $trans_fechareg = utf8_encode($valor["trans_fechareg"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    $compania_cedula = utf8_encode($valor["compania_cedula"]);
    $compania_telf = utf8_encode($valor["compania_telf"]);
    $compania_email = utf8_encode($valor["compania_email"]);
    $compania_direccion = utf8_encode($valor["compania_direccion"]);      
    $compania_razonsocial = utf8_encode($valor["compania_razonsocial"]);
    $sucursal_id = utf8_encode($valor["sucursal_id"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $trans_fecha = utf8_encode($valor["trans_fecha"]);
    $vendedor_id = utf8_encode($valor["vendedor_id"]);  
    $trans_fechadate = utf8_encode($valor["trans_fechadate"]);  

    $prodprestamo_id = utf8_encode($valor["prodprestamo_id"]);
    $prodprestamo_nombre = utf8_encode($valor["prodprestamo_nombre"]);
    $prodprestamo_porc = utf8_encode($valor["prodprestamo_porc"])."%";
    $l_periodocobro_id = utf8_encode($valor["l_periodocobro_id"]);
    $prodprestamo_cantidad = utf8_encode($valor["prodprestamo_cantidad"]);
    $prodprestamo_interes = utf8_encode($valor["prodprestamo_interes"])."%";
    $prodprestamo_custodia = utf8_encode($valor["prodprestamo_custodia"]."%");
    $prodprestamo_seguro = utf8_encode($valor["prodprestamo_seguro"])."%";
    $prodprestamo_comision = utf8_encode($valor["prodprestamo_comision"])."%";
    $prodprestamo_moradiario = utf8_encode($valor["prodprestamo_moradiario"])."%";
    $prodprestamo_cat = utf8_encode($valor["prodprestamo_cat"])."%";
    $prodprestamo_activo = utf8_encode($valor["prodprestamo_activo"]);
    $prodprestamo_fechareg = utf8_encode($valor["prodprestamo_fechareg"]);
    $prodprestamo_fechamod = utf8_encode($valor["prodprestamo_fechamod"]);


    $transprestamo_montoavaluo = number_format($transprestamo_montoavaluo, 2, ',', '.');     
      
  }

  //
  if ($reprocesar==1){// Genera nuevo cuotas de las ya generadas
    $trans_procesado = 0;
  }

  if ($trans_procesado!="1" && $estatus_cod=="2"){

    $caja_id = VerificarCajaAbierta(null, $compania_id, null, $sucursal_id);
    
    if ($caja_id=="0"){      
      return 0;
    }
    

    $diasentrecuotas = 0;

    if ($periodocobro_cod==1){$diasentrecuotas = 1;}
    if ($periodocobro_cod==2){$diasentrecuotas = 7;}
    if ($periodocobro_cod==3){$diasentrecuotas = 15;}
    if ($periodocobro_cod==4){$diasentrecuotas = 30;}
    if ($periodocobro_cod==5){$diasentrecuotas = 45;}

    //$prodprestamo_cantidad= 6;

    $cuota = 0;

    //$tiposolicitud_cod == 1 // Préstamo
    //$tiposolicitud_cod == 2; // Letra

    

    if ($prodprestamo_cantidad>0){

      $tipoprestamoafectacapital = 0;

      if ($tiposolicitud_cod=="2"){// Letra

        if ($periodocobro_cod==4){
          $trans_fechadate = date("Y-m-d H:i:s",strtotime($trans_fechadate." 1 months"));          
        }else{
          $trans_fechadate = date("Y-m-d H:i:s",strtotime($trans_fechadate." $diasentrecuotas days"));          
        }
        
        $cuota = 1;
        $valorcuotapagar = $transprestamo_montoresta;
        $valorinterescuota = 0;
        $valorcuotapagar_abonado = 0;
        $montoabonadocapital = 0;
        $capitalresta = $transprestamo_montoresta;

        $resultado = $conexion->doInsert("
          transprestamocuota
            (trans_id, transprestamo_id, transprestamocuota_nro, transprestamocuota_monto, 
            transprestamocuota_montointeres, transprestamocuota_montoabonado, transprestamocuota_montoabonadocapital,
            transprestamocuota_montopendiente,
            transprestamocuota_montoadicional, l_moneda_id, transprestamocuota_fechavenc, l_estadocuota_id,
            transprestamocuota_montocapitalresta, transprestamocuota_montomora, transprestamocuota_activo)
          ",
          "'$trans_id', '$transprestamo_id', '$cuota', '$valorcuotapagar',
          '$valorinterescuota', '$valorcuotapagar_abonado', '$montoabonadocapital',
          '$valorcuotapagar',
          '0', '$l_moneda_id', '$trans_fechadate', '$idestatuspendiente',
          '$capitalresta', '0', '1'");

          $tipomovimiento = 3; // Salida de Dinero
          $observacion= "Letra #$trans_codigo";
          $idelemento = $trans_id; // Id Elemento
          RegistrarValorCaja($cuenta_id, $compania_id, $tipomovimiento, $transprestamo_montoentregar, $observacion, $idelemento, $formadepago);
  
  
          $resultado = $conexion->doUpdate("transaccion", 
          "trans_procesado = '1'", 
          "trans_id='$trans_id'");
  
          $resultado = $conexion->doUpdate("transprestamo", 
          "transprestamo_fechavenc = '$trans_fechadate'",         
          "trans_id='$trans_id'");

          

      }      
      else if ($tipoprestamoafectacapital==0){


        if ($transprestamo_montoresta!=$trans_montototal){// Es del monto restante y no comenzando

          $trans_montototal = $transprestamo_montoresta;
          $trans_fechadate = formatoFechaHoraBd(1); 

          // Cuento cuotas ya habia pagado anteriormente
          $arrresultado = $conexion->doSelect("count(transprestamocuota.trans_id) as total",
							"transprestamocuota
								inner join lista estatus on estatus.lista_id = transprestamocuota.l_estadocuota_id
							",
							"transprestamocuota.trans_id = '$trans_id'  and estatus.lista_cod in (2) ");

						$total = 0;

						if (count($arrresultado)>0){	    
							foreach($arrresultado as $i=>$valor){       
								$total = utf8_encode($valor["total"]);
							}
						}

          $cuota = $total + 1;
          
          $prodprestamo_cantidad = $prodprestamo_cantidad - $total - 1;

        }else{ // Nueva asignación



        }
          
        $interespagar = round((($trans_montototal * $prodprestamo_porc)/100),2);
        
        $valorcuotapagar = $interespagar;
        $fecha = $trans_fechadate;
        $valorcuotapagar_abonado= 0;
        $montoabonadocapital= 0;
        $capitalresta = $trans_montototal;

        // cantidad de cuotas
        
        for($n=0;$n<$prodprestamo_cantidad;$n++){

          if ($periodocobro_cod==4){
            $trans_fechadate = date("Y-m-d H:i:s",strtotime($trans_fechadate." 1 months"));          
          }else{
            $trans_fechadate = date("Y-m-d H:i:s",strtotime($trans_fechadate." $diasentrecuotas days"));          
          }
          
          $cuota = $cuota + 1;


          // interes por cuota, sacar el interes por cada cuota y NOrestar para tomar lo cbonado a capital

          $capitalrestaverificar = $trans_montototal;

          if ($capitalrestaverificar<0){          
            //$valorcuotapagar = $capitalresta;
            $valorcuotapagar_abonado = 0;
            $montoabonadocapital = 0;
            $abonocapital = 0;
            $capitalresta = $capitalrestaverificar;

          }else{
            //$valorcuotapagar = $capitalresta;
            $valorcuotapagar_abonado = 0;
            $montoabonadocapital = 0;
            $abonocapital = 0;
            $capitalresta = $capitalrestaverificar;
          }
          
          $valorinterescuota = 0;

          $resultado = $conexion->doInsert("
            transprestamocuota
              (trans_id, transprestamo_id, transprestamocuota_nro, transprestamocuota_monto, 
              transprestamocuota_montointeres, transprestamocuota_montoabonado, transprestamocuota_montoabonadocapital,
              transprestamocuota_montopendiente,
              transprestamocuota_montoadicional, l_moneda_id, transprestamocuota_fechavenc, l_estadocuota_id,
              transprestamocuota_montocapitalresta, transprestamocuota_montomora, transprestamocuota_activo)
            ",
            "'$trans_id', '$transprestamo_id', '$cuota', '$valorcuotapagar',
            '$valorinterescuota', '$valorcuotapagar_abonado', '$montoabonadocapital',
            '$valorcuotapagar',
            '0', '$l_moneda_id', '$trans_fechadate', '$idestatuspendiente',
            '$capitalresta', '0', '1'");

        }
        

        $tipomovimiento = 3; // Salida de Dinero
        $observacion= "Prestamo #$trans_codigo";
        $idelemento = $trans_id; // Id Elemento
        RegistrarValorCaja($cuenta_id, $compania_id, $tipomovimiento, $trans_montototal, $observacion, $idelemento, $formadepago);


        $resultado = $conexion->doUpdate("transaccion", 
        "trans_procesado = '1'", 
        "trans_id='$trans_id'");

        $resultado = $conexion->doUpdate("transprestamo", 
        "transprestamo_fechavenc = '$trans_fechadate'",         
        "trans_id='$trans_id'");

      }
      else if ($tipoprestamoafectacapital==1){

        $cuotasininteres = round(($trans_montototal / $prodprestamo_cantidad),2);
        $valorinterescuota = round((($trans_montototal * $prodprestamo_porc)/100),2);
        $valorcuotasininteres = round(($trans_montototal / $prodprestamo_cantidad),2);

        

        $valorcuotapagar = $valorcuotasininteres + $valorinterescuota;

        

        $fecha = $trans_fechadate;
        $valorcuotapagar_abonado= 0;
        $montoabonadocapital= 0;
        $capitalresta = $trans_montototal;
        // cantidad de cuotas
        $cuota = 0;
        for($n=0;$n<$prodprestamo_cantidad;$n++){

          if ($periodocobro_cod==4){
            $trans_fechadate = date("Y-m-d H:i:s",strtotime($trans_fechadate." 1 months"));          
          }else{
            $trans_fechadate = date("Y-m-d H:i:s",strtotime($trans_fechadate." $diasentrecuotas days"));          
          }
          
          $cuota = $cuota + 1;

          
          


          // interes por cuota, sacar el interes por cada cuota y restar para tomar lo cbonado a capital

          $capitalrestaverificar = $capitalresta - $cuotasininteres;

          if ($capitalrestaverificar<0){
          
            $valorcuotapagar = $capitalresta;
            $valorcuotapagar_abonado = $valorcuotapagar_abonado + $valorcuotapagar;
            $montoabonadocapital = $montoabonadocapital + $capitalresta;
            $abonocapital = $valorcuotapagar - $cuotasininteres;
            $capitalresta = 0;

          }else{

            $capitalresta = $capitalresta - $cuotasininteres;
            $montoabonadocapital = $montoabonadocapital + $abonocapital;
            $valorcuotapagar_abonado = $valorcuotapagar_abonado + $valorcuotapagar;
            $abonocapital = $valorcuotapagar - $cuotasininteres;

          }
          
          


          $resultado = $conexion->doInsert("
            transprestamocuota
              (trans_id, transprestamo_id, transprestamocuota_nro, transprestamocuota_monto, 
              transprestamocuota_montointeres, transprestamocuota_montoabonado, transprestamocuota_montoabonadocapital,
              transprestamocuota_montopendiente,
              transprestamocuota_montoadicional, l_moneda_id, transprestamocuota_fechavenc, l_estadocuota_id,
              transprestamocuota_montocapitalresta, transprestamocuota_montomora, transprestamocuota_activo)
            ",
            "'$trans_id', '$transprestamo_id', '$cuota', '$valorcuotapagar',
            '$valorinterescuota', '$valorcuotapagar_abonado', '$montoabonadocapital',
            '$valorcuotapagar',
            '0', '$l_moneda_id', '$trans_fechadate', '$idestatuspendiente',
            '$capitalresta', '0', '1'");


        }
        

        $tipomovimiento = 3; // Salida de Dinero
        $observacion= "Prestamo #$trans_codigo";
        $idelemento = $trans_id; // Id Elemento
        RegistrarValorCaja($cuenta_id, $compania_id, $tipomovimiento, $trans_montototal, $observacion, $idelemento, $formadepago);


        $resultado = $conexion->doUpdate("transaccion", 
        "                 
        trans_procesado = '1'      
        ", 
        "trans_id='$trans_id'");

        $resultado = $conexion->doUpdate("transprestamo", 
        "transprestamo_fechavenc = '$trans_fechadate'",         
        "trans_id='$trans_id'");


      }else{
          
      }

      return 2;
    }else{
      return 1;
    }

  }

  


  return 3;

}

// este antes de copiar y pegar otro igual pero para sin descontar del capital
function old_aasignarPrestamoCuotaas($trans_id=null, $compania_id=null, $sucursal_id=null){

  $conexion = new ConexionBd();    

  $instancialista = new Lista();
        
  $obtenerIdLista = 1;
  $obtenerTipoLista = 224;
  $idestatuspendiente = $instancialista->ObtenerIdLista($obtenerIdLista, $obtenerTipoLista);

  $arrresultado = $conexion->doSelect("transaccion.trans_id, trans_montototal, trans_codigo, 
      transaccion.compania_id, transaccion.l_moneda_id,  
      transaccion.l_formapago_id, transaccion.cliente_id,
      DATE_FORMAT(trans_fechareg,'%d/%m/%Y %H:%i:%s') as trans_fechareg, usuario_nombre, usuario_apellido, 
      compania_nombre, compania_cedula, compania_telf, 
      compania_email, compania_direccion, compania_razonsocial, 
      transaccion.sucursal_id, transaccion.cuenta_id, 
      transaccion.l_estatus_id, DATE_FORMAT(trans_fecha,'%d/%m/%Y') as trans_fecha, 
      DATE_FORMAT(trans_fecha,'%Y-%m-%d') as trans_fechadate, 
      transaccion.vendedor_id,      
      transprestamo.transprestamo_id, transprestamo.trans_id, transprestamo.l_tiposolicitud_id, 
      transprestamo.l_tipoprestamo_id, transprestamo.l_porcdescuento_id, 
      transprestamo.transprestamo_montodesc, transprestamo.l_plazovenc_id, 
      transprestamo.transprestamo_plazovalor, transprestamo.l_periodocobro_id, 
      transprestamo.transprestamo_periodovalor, transprestamo.l_tipocliente_id, 
      transprestamo.transprestamo_montodeseacliente, transprestamo.transprestamo_porc, 
      transprestamo.transprestamo_montoavaluo,
      DATE_FORMAT(transaccion.trans_fechavenc,'%d/%m/%Y') as trans_fechavenc,      
      periodocobro.lista_cod as periodocobro_cod,
      estatus.lista_cod as estatus_cod,
      trans_procesado,
      transprestamo.prodprestamo_id,
      productoprestamo.prodprestamo_id, productoprestamo.prodprestamo_nombre, 
      productoprestamo.prodprestamo_porc, productoprestamo.l_periodocobro_id, 
      productoprestamo.prodprestamo_cantidad, productoprestamo.prodprestamo_interes, 
      productoprestamo.prodprestamo_custodia, productoprestamo.prodprestamo_seguro, 
      productoprestamo.prodprestamo_comision, productoprestamo.prodprestamo_moradiario, 
      productoprestamo.prodprestamo_cat,      
      periodocobro.lista_nombre as periodocobro_nombre

    ",
    "transaccion      
        inner join lista tipotransaccion on tipotransaccion.lista_id = transaccion.l_tipotrans_id
        inner join transprestamo on transprestamo.trans_id = transaccion.trans_id        
        inner join compania on transaccion.compania_id = compania.compania_id
        inner join usuario on transaccion.cliente_id = usuario.usuario_id
        
        inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id

        left join productoprestamo on productoprestamo.prodprestamo_id = transprestamo.prodprestamo_id
        left join lista periodocobro on periodocobro.lista_id = productoprestamo.l_periodocobro_id        

    ",
    "trans_eliminado = '0'  and transaccion.trans_id = '$trans_id' ", null, "transaccion.trans_id asc");
  foreach($arrresultado as $i=>$valor){

    // and tipotransaccion.lista_cod = '7'

    $trans_procesado = utf8_encode($valor["trans_procesado"]);
    $estatus_cod = utf8_encode($valor["estatus_cod"]);
    $periodocobro_cod = utf8_encode($valor["periodocobro_cod"]);
    $trans_fechavenc = utf8_encode($valor["trans_fechavenc"]);
    $transprestamo_id = utf8_encode($valor["transprestamo_id"]);
    $l_tiposolicitud_id = utf8_encode($valor["l_tiposolicitud_id"]);
    $l_tipoprestamo_id = utf8_encode($valor["l_tipoprestamo_id"]);
    $l_porcdescuento_id = utf8_encode($valor["l_porcdescuento_id"]);
    $transprestamo_montodesc = utf8_encode($valor["transprestamo_montodesc"]);
    $l_plazovenc_id = utf8_encode($valor["l_plazovenc_id"]);
    $transprestamo_plazovalor = utf8_encode($valor["transprestamo_plazovalor"]);
    $l_periodocobro_id = utf8_encode($valor["l_periodocobro_id"]);
    $transprestamo_periodovalor = utf8_encode($valor["transprestamo_periodovalor"]);
    $l_tipocliente_id = utf8_encode($valor["l_tipocliente_id"]);
    $transprestamo_montodeseacliente = utf8_encode($valor["transprestamo_montodeseacliente"]);
    $transprestamo_porc = utf8_encode($valor["transprestamo_porc"]);
    $transprestamo_montoavaluo = utf8_encode($valor["transprestamo_montoavaluo"]);
    $trans_id = utf8_encode($valor["trans_id"]);
    $trans_montototal = utf8_encode($valor["trans_montototal"]);
    $trans_codigo = utf8_encode($valor["trans_codigo"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_moneda_id = utf8_encode($valor["l_moneda_id"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $cliente_id = utf8_encode($valor["cliente_id"]);
    $trans_fechareg = utf8_encode($valor["trans_fechareg"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    $compania_cedula = utf8_encode($valor["compania_cedula"]);
    $compania_telf = utf8_encode($valor["compania_telf"]);
    $compania_email = utf8_encode($valor["compania_email"]);
    $compania_direccion = utf8_encode($valor["compania_direccion"]);      
    $compania_razonsocial = utf8_encode($valor["compania_razonsocial"]);
    $sucursal_id = utf8_encode($valor["sucursal_id"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $trans_fecha = utf8_encode($valor["trans_fecha"]);
    $vendedor_id = utf8_encode($valor["vendedor_id"]);  
    $trans_fechadate = utf8_encode($valor["trans_fechadate"]);  

    $prodprestamo_id = utf8_encode($valor["prodprestamo_id"]);
    $prodprestamo_nombre = utf8_encode($valor["prodprestamo_nombre"]);
    $prodprestamo_porc = utf8_encode($valor["prodprestamo_porc"])."%";
    $l_periodocobro_id = utf8_encode($valor["l_periodocobro_id"]);
    $prodprestamo_cantidad = utf8_encode($valor["prodprestamo_cantidad"]);
    $prodprestamo_interes = utf8_encode($valor["prodprestamo_interes"])."%";
    $prodprestamo_custodia = utf8_encode($valor["prodprestamo_custodia"]."%");
    $prodprestamo_seguro = utf8_encode($valor["prodprestamo_seguro"])."%";
    $prodprestamo_comision = utf8_encode($valor["prodprestamo_comision"])."%";
    $prodprestamo_moradiario = utf8_encode($valor["prodprestamo_moradiario"])."%";
    $prodprestamo_cat = utf8_encode($valor["prodprestamo_cat"])."%";
    $prodprestamo_activo = utf8_encode($valor["prodprestamo_activo"]);
    $prodprestamo_fechareg = utf8_encode($valor["prodprestamo_fechareg"]);
    $prodprestamo_fechamod = utf8_encode($valor["prodprestamo_fechamod"]);


    $transprestamo_montoavaluo = number_format($transprestamo_montoavaluo, 2, ',', '.');     
      
  }

  //$trans_procesado = 0;

  if ($trans_procesado!="1" && $estatus_cod=="2"){

    $caja_id = VerificarCajaAbierta(null, $compania_id, null, $sucursal_id);
    
    if ($caja_id=="0"){      
      return 0;
    }
    

  //if ($trans_procesado!="1" ){

    $diasentrecuotas = 0;

    if ($periodocobro_cod==1){$diasentrecuotas = 1;}
    if ($periodocobro_cod==2){$diasentrecuotas = 7;}
    if ($periodocobro_cod==3){$diasentrecuotas = 15;}
    if ($periodocobro_cod==4){$diasentrecuotas = 30;}

    $prodprestamo_cantidad= 6;

    if ($prodprestamo_cantidad>0){

      /*

      // 20.000 en 3 cuotas

      // al 10% mensual

      // 2.000

      // 20.0000 100
      // 20$

      6.666

      8.666



      */

      $cuotasininteres = round(($trans_montototal / $prodprestamo_cantidad),2);
      $valorinterescuota = round((($trans_montototal * $prodprestamo_porc)/100),2);
      $valorcuotasininteres = round(($trans_montototal / $prodprestamo_cantidad),2);

      

      $valorcuotapagar = $valorcuotasininteres + $valorinterescuota;

      

      $fecha = $trans_fechadate;
      $valorcuotapagar_abonado= 0;
      $montoabonadocapital= 0;
      $capitalresta = $trans_montototal;
      // cantidad de cuotas
      $cuota = 0;
      for($n=0;$n<$prodprestamo_cantidad;$n++){

        if ($periodocobro_cod==4){
          $trans_fechadate = date("Y-m-d H:i:s",strtotime($trans_fechadate." 1 months"));          
        }else{
          $trans_fechadate = date("Y-m-d H:i:s",strtotime($trans_fechadate." $diasentrecuotas days"));          
        }
        
        $cuota = $cuota + 1;

        
        


        // interes por cuota, sacar el interes por cada cuota y restar para tomar lo cbonado a capital

        $capitalrestaverificar = $capitalresta - $cuotasininteres;

        if ($capitalrestaverificar<0){
        
          $valorcuotapagar = $capitalresta;
          $valorcuotapagar_abonado = $valorcuotapagar_abonado + $valorcuotapagar;
          $montoabonadocapital = $montoabonadocapital + $capitalresta;
          $abonocapital = $valorcuotapagar - $cuotasininteres;
          $capitalresta = 0;

        }else{

          $capitalresta = $capitalresta - $cuotasininteres;
          $montoabonadocapital = $montoabonadocapital + $abonocapital;
          $valorcuotapagar_abonado = $valorcuotapagar_abonado + $valorcuotapagar;
          $abonocapital = $valorcuotapagar - $cuotasininteres;

        }
        
        


        $resultado = $conexion->doInsert("
          transprestamocuota
            (trans_id, transprestamo_id, transprestamocuota_nro, transprestamocuota_monto, 
            transprestamocuota_montointeres, transprestamocuota_montoabonado, transprestamocuota_montoabonadocapital,
            transprestamocuota_montopendiente,
             transprestamocuota_montoadicional, l_moneda_id, transprestamocuota_fechavenc, l_estadocuota_id,
             transprestamocuota_montocapitalresta, transprestamocuota_montomora)
          ",
          "'$trans_id', '$transprestamo_id', '$cuota', '$valorcuotapagar',
          '$valorinterescuota', '$valorcuotapagar_abonado', '$montoabonadocapital',
          '$valorcuotapagar',
          '0', '$l_moneda_id', '$trans_fechadate', '$idestatuspendiente',
          '$capitalresta', '0'");


      }
      

      $tipomovimiento = 3; // Salida de Dinero
      $observacion= "Prestamo #$trans_codigo";
      $idelemento = $trans_id; // Id Elemento
      RegistrarValorCaja($cuenta_id, $compania_id, $tipomovimiento, $trans_montototal, $observacion, $idelemento, $formadepago);


      $resultado = $conexion->doUpdate("transaccion", 
      "                 
      trans_procesado = '1'      
      ", 
      "trans_id='$trans_id'");

      return 2;
    }else{
      return 1;
    }

  }

  


  return 3;

}

function ListadoUsuarioGanancia($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $usuarioganancia_idget=null, $sinfiltrofecha=null){

  $fechaactual = formatoFechaHoraBd(1);    


  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (usuarioganancia.usuarioganancia_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (usuarioganancia.usuarioganancia_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (usuarioganancia.usuarioganancia_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (usuarioganancia.usuarioganancia_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($sinfiltrofecha=="1"){
    $wherefecha = "";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and usuarioganancia.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and usuarioganancia.cuenta_id = '$_COOKIE[idcuenta]' and usuarioganancia.compania_id = '$_COOKIE[idcompania]' and usuarioganancia.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($usuarioganancia_idget!=""){
    $whereusuarioganancia = " and usuarioganancia.usuarioganancia_id = '$usuarioganancia_idget' ";
    $wherefecha = "";
  }

  if($getestatus!=""){
    $whereestatus = " and usuarioganancia.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    



  $arrresultado = $conexion->doSelect("

    usuarioganancia.usuarioganancia_id, usuarioganancia.usuario_id, usuarioganancia.usuarioganancia_monto, 
    usuarioganancia.l_moneda_id, usuarioganancia.l_estatus_id, 
    usuarioganancia.usuarioganancia_activo, usuarioganancia.usuarioganancia_eliminado, 
    usuarioganancia.cuenta_id, usuarioganancia.compania_id, 
    usuarioganancia.elemento_id, usuarioganancia.modulo_id,  
    DATE_FORMAT(usuarioganancia_fechareg,'%d/%m/%Y %H:%i:%s') as usuarioganancia_fechareg,  
    
    usuario.usuario_nombre, usuario.usuario_apellido,     
    moneda.lista_nombredos as moneda_siglas,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre    
    ",
    "usuarioganancia 
        inner join usuario on usuarioganancia.usuario_id = usuario.usuario_id and usuarioganancia_eliminado = '0'        
        inner join lista moneda on moneda.lista_id = usuarioganancia.l_moneda_id
        inner join usuario cuenta on cuenta.usuario_id = usuarioganancia.cuenta_id
        inner join compania on compania.compania_id = usuarioganancia.compania_id        
    ",
    "usuarioganancia.usuarioganancia_eliminado = '0' $where $whereestatus $whereusuarioganancia $wherefecha ", null, "usuarioganancia_id desc");

 if ($usuarioganancia_idget!=""){    
    return $arrresultado;
  }

foreach($arrresultado as $i=>$valor){

    $usuarioganancia_id = utf8_encode($valor["usuarioganancia_id"]);
    $usuario_id = utf8_encode($valor["usuario_id"]);
    $usuarioganancia_monto = utf8_encode($valor["usuarioganancia_monto"]);
    $l_moneda_id = utf8_encode($valor["l_moneda_id"]);
    $usuarioganancia_activo = utf8_encode($valor["usuarioganancia_activo"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $elemento_id = utf8_encode($valor["elemento_id"]);
    $modulo_id = utf8_encode($valor["modulo_id"]);
    $usuarioganancia_fechareg = utf8_encode($valor["usuarioganancia_fechareg"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";    

    if ($usuarioganancia_monto==""){$usuarioganancia_monto=0;}    

    $usuarioganancia_monto  = number_format_personalizado($usuarioganancia_monto, $moneda_siglas);
  
    if ($usuarioganancia_activo=="0"){
      $activo = "<i onclick='cambiarestatususuarioganancia(\"".$usuarioganancia_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatususuarioganancia(\"".$usuarioganancia_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarusuarioganancia(\"".$usuarioganancia_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verusuarioganancia?id=$usuarioganancia_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verusuarioganancia?id=$usuarioganancia_id'>#$usuarioganancia_id (Ver)</a>";

    $textohtml .= "
          <tr>                           
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td style='text-align: center'>$verid</td>    
            <td>$usuario</td>            
            <td>$usuarioganancia_monto</td>     
            <td>$usuarioganancia_fechareg</td>                           
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}

function asignarVehiculosAnuncio($anuncio_id=null, $estatus=null, $anuncio_fechaini=null, $cuenta=null, $compania=null){ 

  $conexion = new ConexionBd();  

  $fechaactual = formatoFechaHoraBd();
  
  $obtenerIdLista = $estatus;
  $obtenerTipoLista = 200;
  $codigoestatus = ObtenerIdCodigo($obtenerIdLista, $obtenerTipoLista); 

  if ($codigoestatus==1 || $codigoestatus==4){

    $resultado = $conexion->doUpdate("anunciovehiculo", 
      "                 
      anunciovehiculo_activo = '0', 
      anunciovehiculo_eliminado = '1'
      ", 
      "anuncio_id='$anuncio_id'");

  }

  if ($codigoestatus==2){

    $instancialista = new Lista();
    /*
    $arrresultado = $conexion->doSelect("
      anuncio.anuncio_id, anuncio.anuncio_nombre, anuncio.usuario_id, anuncio.cuenta_id, anuncio.compania_id,
      anuncio.l_plan_id, anuncio.l_estatus_id, anuncio.anuncio_activo, anuncio.anuncio_eliminado,     
      DATE_FORMAT(anuncio.anuncio_fechareg,'%d/%m/%Y %H:%i:%s') as anuncio_fechareg,  
      DATE_FORMAT(anuncio_fechaini,'%d/%m/%Y') as anuncio_fechaini, 
      DATE_FORMAT(anuncio_fechafin,'%d/%m/%Y') as anuncio_fechafin, 
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
      cliente.usuario_nombre as cliente_nombre, 
      cliente.usuario_apellido as cliente_apellido,
      estatus.lista_nombre as estatus_nombre,
      anunciovehiculo.anunciovehiculo_id, anunciovehiculo.anuncio_id, 
      anunciovehiculo.anunciovehiculo_fecha, anunciovehiculo.anunciovehiculo_duracion, 
      anunciovehiculo.l_estatus_id as l_estatus_idanunciovehiculo, anunciovehiculo.anunciovehiculo_activo, 
      anunciovehiculo.anunciovehiculo_eliminado, anunciovehiculo.anunciovehiculo_fechareg,
      vehiculo.vehiculo_id, vehiculo.vehiculo_patente, vehiculo.vehiculo_marca, vehiculo.vehiculo_modelo,
      estatusanunciovehiculo.lista_nombre as estatusanunciovehiculo_nombre
    
      ",
      "anuncio            
          inner join usuario cuenta on cuenta.usuario_id = anuncio.cuenta_id
          inner join compania on compania.compania_id = anuncio.compania_id   
          inner join usuario cliente on cliente.usuario_id = anuncio.usuario_id
          inner join lista estatus on estatus.lista_id = anuncio.l_estatus_id 
          inner join anunciovehiculo on anunciovehiculo.anuncio_id = anuncio.anuncio_id  and anunciovehiculo_activo = '1'
          inner join vehiculo on vehiculo.vehiculo_id = anunciovehiculo.vehiculo_id
          inner join lista estatusanunciovehiculo on estatusanunciovehiculo.lista_id = anunciovehiculo.l_estatus_id 
           
      ",
      "anuncio_eliminado = '0' and anuncio.cuenta_id = '$cuenta' and anuncio.compania_id = '$compania' and anuncio.anuncio_id = '$anuncio_id' and estatusanunciovehiculo.lista_cod = '$codigoestatus'"); 
      */ 

    $arrresultado = $conexion->doSelect("
      anuncio.usuario_id, anuncio.anuncio_id, DATE_FORMAT(anuncio_fechaini,'%Y-%m-%d') as anuncio_fechaini    
      ",
      "anuncio            
          inner join usuario cuenta on cuenta.usuario_id = anuncio.cuenta_id
          inner join compania on compania.compania_id = anuncio.compania_id   
          inner join usuario cliente on cliente.usuario_id = anuncio.usuario_id
          inner join lista estatus on estatus.lista_id = anuncio.l_estatus_id           
           
      ",
      "anuncio_eliminado = '0' and anuncio.cuenta_id = '$cuenta' and anuncio.compania_id = '$compania' and anuncio.anuncio_id = '$anuncio_id' ");

    if (count($arrresultado)>0){

        foreach($arrresultado as $i=>$valor){
          $usuario_id = utf8_encode($valor["usuario_id"]);
          $anuncio_id = utf8_encode($valor["anuncio_id"]);
          $anuncio_fechaini = utf8_encode($valor["anuncio_fechaini"]);

        }

        $anuncio_fechainioriginal = $anuncio_fechaini;

        // Verifico el plan que tiene activo para utilizar
       $arrresultado = $conexion->doSelect("usuariobalanceplan_id,
        listaplan_habiltarminutos as cantidadunidades
        ",
        "usuario
          inner join usuariobalance on usuariobalance.usuario_id = usuario.usuario_id
          inner join usuariobalanceplan on usuariobalanceplan.usuario_id = usuario.usuario_id
          inner join lista plan on plan.lista_id = usuariobalanceplan.l_plan_id            
          inner join listaplan on listaplan.l_plan_id = plan.lista_id             
        ",
        "usuario.usuario_eliminado = '0' and usuario.usuario_id = '$usuario_id' and usuariobalanceplan_estatus = '0' ", "usuariobalanceplan_id asc LIMIT 1");
      foreach($arrresultado as $i=>$valor){
        $usuariobalanceplan_id = utf8_encode($valor["usuariobalanceplan_id"]);
        $cantidadunidades = utf8_encode($valor["cantidadunidades"]);
      }

      //return $cantidadunidades;
      //return $usuario_id;
      //return count($arrresultado);

      if ($cantidadunidades==0){
        return 0;
      }

     
      $duracionsegundos = 30;

      $obtenerCodigoLista = 1; 
      $obtenerTipoLista = 201;
      $idestatuspendiente = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);


      $resultado = $conexion->doUpdate("anunciovehiculo", 
      "                 
      anunciovehiculo_activo = '0', 
      anunciovehiculo_eliminado = '1'
      ", 
      "anuncio_id='$anuncio_id'");

      for($m=0; $m<$cantidadunidades;$m++){ // Segun el plan

          $anuncio_fechaini = $anuncio_fechainioriginal;

          for($n=1;$n<=30;$n++){

             $vehiculo_idasignar = 0;

             $arrresultado = $conexion->doSelect("vehiculo.vehiculo_id, anunciovehiculo_id",
              "
              vehiculo 
                inner join usuario cuenta on cuenta.usuario_id = vehiculo.cuenta_id
                inner join compania on compania.compania_id = vehiculo.compania_id 
                left join anunciovehiculo on anunciovehiculo.vehiculo_id = vehiculo.vehiculo_id                         
                and (anunciovehiculo.anunciovehiculo_fecha BETWEEN '$anuncio_fechaini 00:00:00' and '$anuncio_fechaini 23:59:59' ) 
                and anunciovehiculo.anuncio_id = '$anuncio_id'
              ",
              " vehiculo.vehiculo_activo = '1' and vehiculo.cuenta_id = '$cuenta' and vehiculo.compania_id = '$compania'", null, "vehiculo.vehiculo_id asc");


            foreach($arrresultado as $i=>$valor){
              $vehiculo_id = utf8_encode($valor["vehiculo_id"]);  
              $anunciovehiculo_id = utf8_encode($valor["anunciovehiculo_id"]);

              if ($anunciovehiculo_id==""){
                $vehiculo_idasignar = $vehiculo_id;
                break;
              }
            }

            if($vehiculo_idasignar==0){

              $n = $n - 1;

            }else{

              $resultado = $conexion->doInsert("
              anunciovehiculo
                (anuncio_id, vehiculo_id, anunciovehiculo_fecha, anunciovehiculo_duracion, 
                l_estatus_id, anunciovehiculo_activo, anunciovehiculo_eliminado, anunciovehiculo_fechareg)
              ",
              "'$anuncio_id', '$vehiculo_idasignar', '$anuncio_fechaini', '$duracionsegundos',
              '$idestatuspendiente', '1', '0', '$fechaactual'");

              $asignado = 1;

            }
            
            $anuncio_fechaini = date("Y-m-d H:i:s",strtotime($anuncio_fechaini." 1 days"));          

          }

      }


    }

  }

  if ($asignado==1){

      $resultado = $conexion->doUpdate("usuariobalanceplan", 
      "                 
      usuariobalanceplan_estatus = '1'
      ", 
      "usuariobalanceplan_id='$usuariobalanceplan_id'");


      return $asignado;
  }

}

function ObtenerListaCiudad($cuenta=null, $compania=null, $ciudad_id=null){

  if ($ordenar=="entero"){
    $orderby = "CAST(lista_nombre AS UNSIGNED)";
  }else{
    $orderby = "listacuenta_nombre";
  }

  $tipolista_id = "92";

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $option = "<option value=''>-- Seleccione --</option>";
  
  if ($cuenta!="" ){
    
      $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
        listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
            "lista                
                inner join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania'                 
            ",
            "lista_activo = '1' and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");
      /*
      if (count($arrresultado)==0){

         $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
          listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
            "lista                 
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 
            ",
            "lista_activo = '1' $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");


      }
      */

    
    foreach($arrresultado as $i=>$valor){
      
      $lista_id = utf8_encode($valor["lista_id"]);  
      $lista_nombre = utf8_encode($valor["lista_nombre"]);  
      $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
      $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
      $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
      $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  

      if ($ciudad_id==$lista_id){        
        $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";        
      }else{       
        $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
      }  
    }
  }

  if (count($arrresultado)==0 && $compania==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }else if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN CIUDADES</option>";
  }

  
 
  return $option;

}

function ObtenerListaCiudadVehiculos($cuenta=null, $compania=null, $vehiculo_id=null){

  if ($ordenar=="entero"){
    $orderby = "CAST(lista_nombre AS UNSIGNED)";
  }else{
    $orderby = "listacuenta_nombre";
  }

  $tipolista_id = "92";

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $option = "<option value=''>-- Seleccione --</option>";
  
  if ($cuenta!="" ){
    
      $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
        listacuenta_activo, listacuenta_nombre, listacuenta_nombredos, vehiculociudad_id",
            "lista                
                inner join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 
                left join vehiculociudad on vehiculociudad.l_ciudad_id = lista.lista_id AND vehiculociudad_activo = '1' and vehiculo_id = '$vehiculo_id'
            ",
            "lista_activo = '1' and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");
      /*
      if (count($arrresultado)==0){

         $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
          listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
            "lista                 
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 
            ",
            "lista_activo = '1' $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");


      }
      */

    
    foreach($arrresultado as $i=>$valor){

      $vehiculociudad_id = utf8_encode($valor["vehiculociudad_id"]);  
      $lista_id = utf8_encode($valor["lista_id"]);  
      $lista_nombre = utf8_encode($valor["lista_nombre"]);  
      $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
      $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
      $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
      $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  

      if ($vehiculociudad_id!=""){        
        $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";        
      }else{       
        $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
      }  
    }
  }

  if (count($arrresultado)==0 && $compania==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }else if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN CIUDADES</option>";
  }

  
 
  return $option;

}

function ListadoGestion($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (gestion_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (gestion_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (gestion_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (gestion_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($estatusseleccionado!=""){
    $whereestatus =" and gestion.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }

  $urlgestion = "agendagestionar";

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and gestion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

     $where = " and gestion.cuenta_id = '$_COOKIE[idcuenta]' and gestion.compania_id = '$_COOKIE[idcompania]' and gestion_eliminado = '0' and gestion.usuario_id = '$_COOKIE[iniuser]'  ";

  } 

  
  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("
    gestion.gestion_id, gestion.gestion_nombre, gestion.gestion_telf, 
    gestion.gestion_email, gestion.gestion_img, gestion.gestion_url, 
    gestion.gestion_whatsapp, gestion.gestion_urlperfil, gestion.gestion_observ, 
    gestion.gestion_cv, gestion.usuario_id, gestion.l_estatus_id,
    gestion.cuenta_id, gestion.compania_id,
    DATE_FORMAT(gestion.gestion_fechareg,'%d/%m/%Y %H:%i:%s') as gestion_fechareg,
    gestion.gestion_activo, gestion.gestion_eliminado,
    usuariooperador.usuario_nombre as usuariooperador_nombre, usuariooperador.usuario_apellido as usuariooperador_apellido,

    estatus.lista_nombre as estatus_nombre, 
    estatus.lista_color as estatus_color, 

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre            
    ",
    "
    gestion            
      inner join usuario usuariooperador on usuariooperador.usuario_id = gestion.usuario_id      
      inner join usuario cuenta on cuenta.usuario_id = gestion.cuenta_id
      inner join compania on compania.compania_id = gestion.compania_id 
      left join lista estatus on estatus.lista_id = gestion.l_estatus_id                   
    ",
    "gestion.gestion_eliminado = '0' $where $whereestatus $wherefecha  ", null, "gestion.gestion_id desc");
  foreach($arrresultado as $i=>$valor){

    $gestion_id = utf8_encode($valor["gestion_id"]);
    $gestion_nombre = utf8_encode($valor["gestion_nombre"]);
    $gestion_telf = utf8_encode($valor["gestion_telf"]);
    $gestion_email = utf8_encode($valor["gestion_email"]);
    $gestion_img = utf8_encode($valor["gestion_img"]);
    $gestion_url = utf8_encode($valor["gestion_url"]);
    $gestion_whatsapp = utf8_encode($valor["gestion_whatsapp"]);
    $gestion_urlperfil = utf8_encode($valor["gestion_urlperfil"]);
    $gestion_observ = utf8_encode($valor["gestion_observ"]);
    $gestion_cv = utf8_encode($valor["gestion_cv"]);
    $usuario_id = utf8_encode($valor["usuario_id"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $gestion_fechareg = utf8_encode($valor["gestion_fechareg"]);
    $gestion_activo = utf8_encode($valor["gestion_activo"]);

    $usuariooperador_nombre = utf8_encode($valor["usuariooperador_nombre"]);
    $usuariooperador_apellido = utf8_encode($valor["usuariooperador_apellido"]);

    $usuariooperador = $usuariooperador_nombre." ".$usuariooperador_apellido;

    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
    $estatus_color = utf8_encode($valor["estatus_color"]);

    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $t_compania_id = utf8_encode($valor["compania_id"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
       
    
    if ($gestion_activo=="0"){
      $activo = "<i onclick='cambiarestatusgestion(\"".$gestion_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusgestion(\"".$gestion_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminargestion(\"".$gestion_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
    $modificar = "<a href='modificargestion?id=$gestion_id&cu=$t_cuenta_id&co=$t_compania_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    //$gestionar = "<a href='$urlgestion?id=$agenda_id'>Gestionar <br><i title='Gestionar Prostpecto' class='fa fa-play btn-realizar-tarea'></i></a>";

    //$historial = "<a href='agendahistorial?id=$agenda_id'>Historial</a>";
  

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {
      $columnacuenta = "";
      $mostrarcolumnacuenta = ""; 
      $mostrarcolumnacompania = ""; 
    }

    $estatusaaaaa = "
      <button type='button' class='btn btn-block btn-primary btn-xs' style='background: $estatus_color; border: 1px solid $estatus_color'>$estatus_nombre</button>
    ";

    $gestion_observ .=" <br><a href='$gestion_url' target='_blank'>$gestion_url</a>";

    /*
   

    
    */

    //$agenda_telfwhatsapp = str_replace("+", "", $agenda_telf);

    $gestion_whatsappmostrar = "";
    if ($gestion_whatsapp!=""){
      $gestion_whatsappmostrar = "
        $gestion_whatsapp 
        <a href='https://api.whatsapp.com/send?phone=$gestion_whatsapp'  target='_blank'>
          <img src='dist/img/whatsapp.png' style='height: 25px'>
        </a>  
      ";  
    }
    
    $gestion_emailmostrar = "";
    if ($gestion_email!=""){
      $gestion_emailmostrar = "
        $gestion_email 
        <a href='mailto:$gestion_email'>
          <img src='dist/img/email2.png' style='height: 18px; width: 22px'>
        </a>  
      ";
    }


    $textohtml .= "
           <tr>               
                  $mostrarcolumnacuentaaaa
                  $mostrarcolumnacompaniaaaa                                                     
                  <td style='text-align: center'>$gestion_whatsappmostrar</td>  
                  <td style='text-align: center'>$gestion_emailmostrar</td>    
                                                                    
                  <td style='text-align: center'>$estatus_nombre</td> 
                  <td style='text-align: center'>$usuariooperador</td>                                                       
                  <td style='text-align: center'>$gestion_fechareg</td>                                                   
                  
                  <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar </td>
              </tr>
        ";

  }

  return $textohtml;

}

function obtenerAccesosDirectosModulo($modulo_id=null){

  $conexion = new ConexionBd();  

  $arrresultado = $conexion->doSelect("distinct menusistema.menu_id, menusistema.menu_nombre, menusistema.menu_icono, menu.menu_url, menusistema.menu_ppal, menusistema.menu_submenu,
    menusistema.menu_idrel, menurel.menu_nombre as menurel_nombre, menurel.menu_icono as menurel_icono, menurel.menu_url  as menurel_url, menurel.menu_submenu as menurel_submenu,
    menu.modulo_id, modulo_url, 
    menusistema.menu_backcolor, menusistema.menu_bordercolor
    ",
      "
      menu 
        inner join menusistema on menusistema.menu_id = menu.menu_id
        inner join modulo on modulo.modulo_id = menu.modulo_id           
        inner join perfilpermiso on perfilpermiso.modulo_id = modulo.modulo_id       
        left join menu menurel on menurel.menu_id = menu.menu_idrel
      ",
      "menusistema.menu_activo = '1' and modulo.modulo_relmodulo in ($modulo_id)  and modulo_activo = '1' and perfilpermiso_activo = '1'  and perfilpermiso.perfil_id = '$_COOKIE[perfilactual]' and menu.menu_accesodirecto = '1'  ", null, "menu.menu_orden asc");
     
    $armandosubmenu = 0; 
    foreach($arrresultado as $i=>$valor){
    
      $menu_id = utf8_encode($valor["menu_id"]);
      $menu_nombre = utf8_encode($valor["menu_nombre"]);
      $menu_icono = utf8_encode($valor["menu_icono"]);
      $menu_url = utf8_encode($valor["menu_url"]);    
      $menu_submenu = utf8_encode($valor["menu_submenu"]);    
      $menu_ppal = utf8_encode($valor["menu_ppal"]);
      $menu_idrel = utf8_encode($valor["menu_idrel"]);
      $menurel_nombre = utf8_encode($valor["menurel_nombre"]);
      $menurel_icono = utf8_encode($valor["menurel_icono"]);
      $menurel_url = utf8_encode($valor["menurel_url"]);    
      $menurel_submenu = utf8_encode($valor["menurel_submenu"]);
      $modulo_idconsulta = utf8_encode($valor["modulo_id"]);
      $modulo_url = utf8_encode($valor["modulo_url"]);
      $menu_bordercolor = utf8_encode($valor["menu_bordercolor"]);
      $menu_backcolor = utf8_encode($valor["menu_backcolor"]);

      $modulo_url = str_replace(".php","",$modulo_url);
      //style='background: $menu_backcolor !important; border-color: $menu_bordercolor'
      $menusaccesosdirectos  .="
        <div class='col-md-4 col-sm-6 col-xs-12'>
            <div class='callout callout-info' >
              <div class='row'>
                  <a href='$modulo_url' >
                    <div class='col-xs-5 col-md-4'>
                        <center>                  
                          <i class='fa $menu_icono' style='font-size: 60px'></i>
                        </center>
                    </div>
                    <div class='col-xs-7 col-md-8' style='padding-left: 0px; padding-top: 18px'>                    
                      <h4 style='text-align: left'>$menu_nombre</h4>                                  
                      
                    </div>
                  </a>                
              </div>           
            </div>    
          </div>
      ";    

  }

  if ($menusaccesosdirectos!=""){  
    $paneldivinfo .= "
        <div class='row'>
            <div class='col-md-12'>
              <div class='box box-primary' style='border-top-color: #FFF'>                            
                  <div class='box-body'>
                    $menusaccesosdirectos
                  </div>
              </div>  
            </div>
        </div>      
    ";
  }

  return $paneldivinfo;


}

function ObtenerListaProcesoCampo($cuentaseleccionada=null, $companiaseleccionada=null, $proceso_id=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

    $arrresultado = $conexion->doSelect("proceso.proceso_id, proceso.proceso_nombre, 
      proceso.proceso_descrip, proceso.proceso_img, 
      proceso.proceso_activo, proceso.proceso_eliminado, proceso.proceso_orden, 
      proceso.cuenta_id, proceso.compania_id, proceso.usuario_idreg,
      DATE_FORMAT(proceso.proceso_fechareg,'%d/%m/%Y %H:%i:%s') as proceso_fechareg,
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania.compania_nombre,
      procesocampo.procesocampo_nombre, procesocampo.procesocampo_id
      ",
      "proceso            
        inner join usuario cuenta on cuenta.usuario_id = proceso.cuenta_id
        inner join compania on compania.compania_id = proceso.compania_id    
        inner join procesocampo on procesocampo.proceso_id = proceso.proceso_id       
      ",
      "proceso.proceso_eliminado = '0' and (procesocampo_idrel is null or procesocampo_idrel ='0')  and procesocampo_eliminado = '0' and proceso.proceso_id = '$proceso_id' and compania.compania_eliminado = '0' $where ", null, "procesocampo.procesocampo_nombre asc");

    $option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $procesocampo_id = utf8_encode($valor["procesocampo_id"]);
      $procesocampo_nombre = utf8_encode($valor["procesocampo_nombre"]);      

       if ($idseleccionado==$procesocampo_id){
          $option .= "<option selected='selected' value='$procesocampo_id'>$procesocampo_nombre</option>";
      }else{
          $option .= "<option value='$procesocampo_id'>$procesocampo_nombre</option>";
      }
    }

 
    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN CAMPOS</option>";
    }

    if (count($arrresultado)==1){
      $option = "<option selected='selected' value='$proceso_id'>$proceso_nombre</option>";
    } 
  }
  

  return $option;

}

function capturarInfoElemento($cuentaseleccionada=null, $companiaseleccionada=null, $modulo_id=null, $elementoid=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  

  if ($modulo_id=="1081"){

    $where = " and compania.cuenta_id = '$cuentaseleccionada' and compania.compania_id = '$companiaseleccionada' ";

    $arrresultado = $conexion->doSelect("
      herraje.herraje_id, herraje.herraje_nombre, herraje.herraje_provincia, herraje.herraje_cliente, 
      herraje.herraje_industria, herraje.herraje_url, herraje.herraje_linkurl, herraje.herraje_img, 
      herraje.herraje_fechareg, herraje.herraje_orden, herraje.herraje_activo, herraje.herraje_eliminado, 
      herraje.cuenta_id, herraje.compania_id, herraje.usuario_idreg,
      herraje.herraje_codigo, herraje.herraje_material, herraje.herraje_color, 
      herraje.herraje_complemento, herraje.categ_id, herraje.subcateg_id, herraje.herraje_ubicacion,
      herraje.herraje_descrip,

      DATE_FORMAT(herraje.herraje_fechareg,'%d/%m/%Y %H:%i:%s') as herraje_fechareg,
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania.compania_nombre,

      categoria.lista_nombre as categ_nombre,
      subcategoria.lista_nombre as subcateg_nombre
      ",
      "herraje            
        inner join usuario cuenta on cuenta.usuario_id = herraje.cuenta_id
          inner join compania on compania.compania_id = herraje.compania_id       
          left join lista categoria on categoria.lista_id = herraje.categ_id
          left join lista subcategoria on subcategoria.lista_id = herraje.subcateg_id
      ",
      "herraje.herraje_eliminado = '0' and herraje.herraje_id = '$elementoid' ");
    foreach($arrresultado as $i=>$valor){
      $herraje_id = utf8_encode($valor["herraje_id"]);
      $herraje_nombre = utf8_encode($valor["herraje_nombre"]);   
    }


    $arr = array(    
      'elemento_id' => $herraje_id,
      'modulo_id' => $modulo_id,
      'elemento_nombre' => $herraje_nombre,
      'modulo_nombre' => 'Herraje',
      
    );
    $resultados [] = $arr;  

  }else if ($modulo_id=="188"){

    $where = " and compania.cuenta_id = '$cuentaseleccionada' and compania.compania_id = '$companiaseleccionada' ";

    $arrresultado = $conexion->doSelect("
      portafolio.portafolio_id, portafolio.portafolio_nombre, portafolio.portafolio_descrip, portafolio.portafolio_img, 
      portafolio.cuenta_id, portafolio.compania_id, 
      portafolio.portafolio_urlenlace,
      portafolio.portafolio_activo, portafolio.portafolio_eliminado, portafolio.portafolio_orden, portafolio.usuario_idreg,
      DATE_FORMAT(portafolio.portafolio_fechareg,'%d/%m/%Y %H:%i:%s') as portafolio_fechareg,
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre, 
      portafolio.l_categserv_id, portafolio.l_subcategserv_id
      ",
      "portafolio           
          inner join usuario cuenta on cuenta.usuario_id = portafolio.cuenta_id
          inner join compania on compania.compania_id = portafolio.compania_id        
      ",
      "portafolio_eliminado = '0' and  portafolio_id = '$elementoid' $whereee ");
    foreach($arrresultado as $i=>$valor){

      $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
      $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
      $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
      $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
      $compania_nombre = utf8_encode($valor["compania_nombre"]);

      $portafolio_urlenlace = utf8_encode($valor["portafolio_urlenlace"]);
      $portafolio_id = utf8_encode($valor["portafolio_id"]);
      $portafolio_nombre = utf8_encode($valor["portafolio_nombre"]);
      $portafolio_descrip = utf8_encode($valor["portafolio_descrip"]);
      $portafolio_img = utf8_encode($valor["portafolio_img"]);
      $portafolio_activo = utf8_encode($valor["portafolio_activo"]);
      $portafolio_orden = utf8_encode($valor["portafolio_orden"]);
      $portafolio_fechareg = utf8_encode($valor["portafolio_fechareg"]);    

      $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
      $t_compania_id = utf8_encode($valor["compania_id"]);  
      $l_categserv_id = utf8_encode($valor["l_categserv_id"]);
      $l_subcategserv_id = utf8_encode($valor["l_subcategserv_id"]);
    }


    $arr = array(    
      'elemento_id' => $portafolio_id,
      'modulo_id' => $modulo_id,
      'elemento_nombre' => $portafolio_nombre,
      'modulo_nombre' => 'Portafolio',
      
    );
    $resultados [] = $arr;  

  }else if ($modulo_id=="1114"){

    $where = " and compania.cuenta_id = '$cuentaseleccionada' and compania.compania_id = '$companiaseleccionada' ";

    $arrresultado = $conexion->doSelect("
      anuncio.anuncio_id, anuncio.anuncio_nombre, anuncio.usuario_id, anuncio.cuenta_id, anuncio.compania_id,
      anuncio.l_plan_id, anuncio.l_estatus_id, anuncio.anuncio_activo, anuncio.anuncio_eliminado,     
      DATE_FORMAT(anuncio.anuncio_fechareg,'%d/%m/%Y %H:%i:%s') as anuncio_fechareg,  
      DATE_FORMAT(anuncio_fechaini,'%d/%m/%Y') as anuncio_fechaini, 
      DATE_FORMAT(anuncio_fechafin,'%d/%m/%Y') as anuncio_fechafin, 
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
      cliente.usuario_nombre as cliente_nombre, 
      cliente.usuario_apellido as cliente_apellido,
      estatus.lista_nombre as estatus_nombre
    
      ",
      "anuncio            
        inner join usuario cuenta on cuenta.usuario_id = anuncio.cuenta_id
        inner join compania on compania.compania_id = anuncio.compania_id   
        inner join usuario cliente on cliente.usuario_id = anuncio.usuario_id
        inner join lista estatus on estatus.lista_id = anuncio.l_estatus_id 
           
      ",
      "anuncio_eliminado = '0' and anuncio.anuncio_id = '$elementoid' ", null, "anuncio_id desc");
    foreach($arrresultado as $i=>$valor){

      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

      $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
      $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
      $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
      $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
      $compania_nombre = utf8_encode($valor["compania_nombre"]);
      $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
      $t_compania_id = utf8_encode($valor["compania_id"]);

      $anuncio_id = utf8_encode($valor["anuncio_id"]);
      $anuncio_nombre = utf8_encode($valor["anuncio_nombre"]);
      $usuario_id = utf8_encode($valor["usuario_id"]);
      $l_plan_id = utf8_encode($valor["l_plan_id"]);
      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $anuncio_activo = utf8_encode($valor["anuncio_activo"]);
      $anuncio_fechareg = utf8_encode($valor["anuncio_fechareg"]);
      $anuncio_fechaini = utf8_encode($valor["anuncio_fechaini"]);
      $anuncio_fechafin = utf8_encode($valor["anuncio_fechafin"]);

      $cliente_nombre = utf8_encode($valor["cliente_nombre"]);
      $cliente_apellido = utf8_encode($valor["cliente_apellido"]);    
      $cliente = $cliente_nombre." ".$cliente_apellido." ";

    }


    $arr = array(    
      'elemento_id' => $anuncio_id,
      'modulo_id' => $modulo_id,
      'elemento_nombre' => $anuncio_nombre,
      'modulo_nombre' => 'Anuncio',
      
    );
    $resultados [] = $arr;  

  }else if ($modulo_id=="35"){// Productos

    //$where = " and compania.cuenta_id = '$cuentaseleccionada' and compania.compania_id = '$companiaseleccionada' ";

    $arrresultado = $conexion->doSelect("prod_id, prod_nombre","producto","producto.prod_id = '$elementoid'");

    foreach($arrresultado as $i=>$valor){
      $prod_id = utf8_encode($valor["prod_id"]);
      $prod_nombre = utf8_encode($valor["prod_nombre"]);        
    }
    
    $arr = array(    
      'elemento_id' => $prod_id,
      'modulo_id' => $modulo_id,
      'elemento_nombre' => $prod_nombre,
      'modulo_nombre' => 'Producto',
      
    );
    $resultados [] = $arr;  

  }
  else if ($modulo_id=="1114"){

    $where = " and compania.cuenta_id = '$cuentaseleccionada' and compania.compania_id = '$companiaseleccionada' ";

    $arrresultado = $conexion->doSelect("
      anuncio.anuncio_id, anuncio.anuncio_nombre, anuncio.usuario_id, anuncio.cuenta_id, anuncio.compania_id,
      anuncio.l_plan_id, anuncio.l_estatus_id, anuncio.anuncio_activo, anuncio.anuncio_eliminado,     
      DATE_FORMAT(anuncio.anuncio_fechareg,'%d/%m/%Y %H:%i:%s') as anuncio_fechareg,  
      DATE_FORMAT(anuncio_fechaini,'%d/%m/%Y') as anuncio_fechaini, 
      DATE_FORMAT(anuncio_fechafin,'%d/%m/%Y') as anuncio_fechafin, 
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
      cliente.usuario_nombre as cliente_nombre, 
      cliente.usuario_apellido as cliente_apellido,
      estatus.lista_nombre as estatus_nombre
    
      ",
      "anuncio            
        inner join usuario cuenta on cuenta.usuario_id = anuncio.cuenta_id
        inner join compania on compania.compania_id = anuncio.compania_id   
        inner join usuario cliente on cliente.usuario_id = anuncio.usuario_id
        inner join lista estatus on estatus.lista_id = anuncio.l_estatus_id 
           
      ",
      "anuncio_eliminado = '0' and anuncio.anuncio_id = '$elementoid' ", null, "anuncio_id desc");
    foreach($arrresultado as $i=>$valor){

      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

      $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
      $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
      $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
      $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
      $compania_nombre = utf8_encode($valor["compania_nombre"]);
      $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
      $t_compania_id = utf8_encode($valor["compania_id"]);

      $anuncio_id = utf8_encode($valor["anuncio_id"]);
      $anuncio_nombre = utf8_encode($valor["anuncio_nombre"]);
      $usuario_id = utf8_encode($valor["usuario_id"]);
      $l_plan_id = utf8_encode($valor["l_plan_id"]);
      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $anuncio_activo = utf8_encode($valor["anuncio_activo"]);
      $anuncio_fechareg = utf8_encode($valor["anuncio_fechareg"]);
      $anuncio_fechaini = utf8_encode($valor["anuncio_fechaini"]);
      $anuncio_fechafin = utf8_encode($valor["anuncio_fechafin"]);

      $cliente_nombre = utf8_encode($valor["cliente_nombre"]);
      $cliente_apellido = utf8_encode($valor["cliente_apellido"]);    
      $cliente = $cliente_nombre." ".$cliente_apellido." ";

    }


    $arr = array(    
      'elemento_id' => $anuncio_id,
      'modulo_id' => $modulo_id,
      'elemento_nombre' => $anuncio_nombre,
      'modulo_nombre' => 'Anuncio',
      
    );
    $resultados [] = $arr;  

  }

  /*
    
  
$arrresultado = $conexion->doSelect("
  portafolio.portafolio_id, portafolio.portafolio_nombre, portafolio.portafolio_descrip, portafolio.portafolio_img, 
  portafolio.cuenta_id, portafolio.compania_id, 
  portafolio.portafolio_urlenlace,
  portafolio.portafolio_activo, portafolio.portafolio_eliminado, portafolio.portafolio_orden, portafolio.usuario_idreg,
  DATE_FORMAT(portafolio.portafolio_fechareg,'%d/%m/%Y %H:%i:%s') as portafolio_fechareg,
  cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
  cuenta.usuario_apellido as cuenta_apellido, compania_nombre, 
  portafolio.l_categserv_id, portafolio.l_subcategserv_id
  ",
  "portafolio           
    inner join usuario cuenta on cuenta.usuario_id = portafolio.cuenta_id
      inner join compania on compania.compania_id = portafolio.compania_id        
  ",
  "portafolio_eliminado = '0' and  portafolio_id = '$get_id' $where ", null, "portafolio_id desc");
foreach($arrresultado as $i=>$valor){

  $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
  $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
  $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
  $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
  $compania_nombre = utf8_encode($valor["compania_nombre"]);

  $portafolio_urlenlace = utf8_encode($valor["portafolio_urlenlace"]);
  $portafolio_id = utf8_encode($valor["portafolio_id"]);
  $portafolio_nombre = utf8_encode($valor["portafolio_nombre"]);
  $portafolio_descrip = utf8_encode($valor["portafolio_descrip"]);
  $portafolio_img = utf8_encode($valor["portafolio_img"]);
  $portafolio_activo = utf8_encode($valor["portafolio_activo"]);
  $portafolio_orden = utf8_encode($valor["portafolio_orden"]);
  $portafolio_fechareg = utf8_encode($valor["portafolio_fechareg"]);    

  $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
  $t_compania_id = utf8_encode($valor["compania_id"]);  
  $l_categserv_id = utf8_encode($valor["l_categserv_id"]);
  $l_subcategserv_id = utf8_encode($valor["l_subcategserv_id"]);

  */

  return $resultados;

}

function ObtenerListaHerrajeProducto($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

    $where = " and producto.cuenta_id = '$cuentaseleccionada' and producto.compania_id = '$companiaseleccionada' ";

   $arrresultado = $conexion->doSelect("producto.prod_id, producto.prod_nombre, 
    herrajeproducto.herrajeprod_id
    ",
    "producto            
        inner join usuario cuenta on cuenta.usuario_id = producto.cuenta_id
        inner join compania on compania.compania_id = producto.compania_id 
        left join herrajeproducto on herrajeproducto.prod_id = producto.prod_id and herrajeproducto.herraje_id = '$idseleccionado' and herrajeprod_activo = '1'
    ",
    "producto.prod_eliminado = '0' and compania.compania_eliminado = '0' $where ", null, "producto.prod_nombre asc");

    //$option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $prod_id = utf8_encode($valor["prod_id"]);
      $prod_nombre = utf8_encode($valor["prod_nombre"]);
      $herrajeprod_id = utf8_encode($valor["herrajeprod_id"]);
      

       if ($herrajeprod_id != ""){
          $option .= "<option selected='selected' value='$prod_id'>$prod_nombre</option>";
      }else{
          $option .= "<option value='$prod_id'>$prod_nombre</option>";
      }
    }

 
    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN PRODUCTOS</option>";
    }

  }
  

  return $option;

}

function ObtenerListaObraRelacionadas($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

    $where = " and obra.cuenta_id = '$cuentaseleccionada' and obra.compania_id = '$companiaseleccionada' ";

   $arrresultado = $conexion->doSelect("obra.obra_id, obra.obra_nombre, 
    obrarelotras.obrarel_id
    ",
    "obra            
        inner join usuario cuenta on cuenta.usuario_id = obra.cuenta_id
        inner join compania on compania.compania_id = obra.compania_id 
        left join obrarelotras on obrarelotras.obra_idrel = obra.obra_id and obrarelotras.obra_id = '$idseleccionado' and obrarel_activo = '1'

    ",
    "obra.obra_eliminado = '0' and compania.compania_eliminado = '0' $where ", null, "obra.obra_nombre asc");

    //$option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $obra_id = utf8_encode($valor["obra_id"]);
      $obra_nombre = utf8_encode($valor["obra_nombre"]);
      $obrarel_id = utf8_encode($valor["obrarel_id"]);
      

       if ($obrarel_id!=""){
          $option .= "<option selected='selected' value='$obra_id'>$obra_nombre</option>";
      }else{
          $option .= "<option value='$obra_id'>$obra_nombre</option>";
      }
    }

 
    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN OBRAS</option>";
    }
   
  }
  

  return $option;

}


function ObtenerListaObraSolucion($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

    $where = " and solucion.cuenta_id = '$cuentaseleccionada' and solucion.compania_id = '$companiaseleccionada' ";

   $arrresultado = $conexion->doSelect("solucion.solucion_id, solucion.solucion_nombre, 
    obrasolucion.obrasolucion_id
    ",
    "solucion            
        inner join usuario cuenta on cuenta.usuario_id = solucion.cuenta_id
        inner join compania on compania.compania_id = solucion.compania_id 
        left join obrasolucion on obrasolucion.solucion_id = solucion.solucion_id and obrasolucion.obra_id = '$idseleccionado' and obrasolucion_activo = '1'
    ",
    "solucion.solucion_eliminado = '0' and compania.compania_eliminado = '0' $where ", null, "solucion.solucion_nombre asc");

    //$option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $solucion_id = utf8_encode($valor["solucion_id"]);
      $solucion_nombre = utf8_encode($valor["solucion_nombre"]);
      $obrasolucion_id = utf8_encode($valor["obrasolucion_id"]);
      

       if ($obrasolucion_id!=""){
          $option .= "<option selected='selected' value='$solucion_id'>$solucion_nombre</option>";
      }else{
          $option .= "<option value='$solucion_id'>$solucion_nombre</option>";
      }
    }

 
    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN SOLUCIONES</option>";
    }
   
  }
  

  return $option;

}

function ObtenerListaObraIndustria($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

    $where = " and industria.cuenta_id = '$cuentaseleccionada' and industria.compania_id = '$companiaseleccionada' ";

   $arrresultado = $conexion->doSelect("industria.industria_id, industria.industria_nombre, 
    obraindustria.obraindustria_id
    ",
    "industria            
        inner join usuario cuenta on cuenta.usuario_id = industria.cuenta_id
        inner join compania on compania.compania_id = industria.compania_id 
        left join obraindustria on obraindustria.industria_id = industria.industria_id and obraindustria.obra_id = '$idseleccionado' and obraindustria_activo = '1'
    ",
    "industria.industria_eliminado = '0' and compania.compania_eliminado = '0' $where ", null, "industria.industria_nombre asc");

    //$option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $industria_id = utf8_encode($valor["industria_id"]);
      $industria_nombre = utf8_encode($valor["industria_nombre"]);
      $obraindustria_id = utf8_encode($valor["obraindustria_id"]);
      

       if ($obraindustria_id!=""){
          $option .= "<option selected='selected' value='$industria_id'>$industria_nombre</option>";
      }else{
          $option .= "<option value='$industria_id'>$industria_nombre</option>";
      }
    }

 
    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN INDUSTRIAS</option>";
    }
   
  }
  

  return $option;

}

function ObtenerListaObraProducto($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

    $where = " and producto.cuenta_id = '$cuentaseleccionada' and producto.compania_id = '$companiaseleccionada' ";

   $arrresultado = $conexion->doSelect("producto.prod_id, producto.prod_nombre, 
    obraproducto.obraprod_id
    ",
    "producto            
        inner join usuario cuenta on cuenta.usuario_id = producto.cuenta_id
        inner join compania on compania.compania_id = producto.compania_id 
        left join obraproducto on obraproducto.prod_id = producto.prod_id and obraproducto.obra_id = '$idseleccionado' and obraprod_activo = '1'
    ",
    "producto.prod_eliminado = '0' and compania.compania_eliminado = '0' $where ", null, "producto.prod_nombre asc");

    //$option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $prod_id = utf8_encode($valor["prod_id"]);
      $prod_nombre = utf8_encode($valor["prod_nombre"]);
      $obraprod_id = utf8_encode($valor["obraprod_id"]);
      

       if ($obraprod_id != ""){
          $option .= "<option selected='selected' value='$prod_id'>$prod_nombre</option>";
      }else{
          $option .= "<option value='$prod_id'>$prod_nombre</option>";
      }
    }

 
    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN PRODUCTOS</option>";
    }

  }
  

  return $option;

}

function ObtenerTipoLista($tipolista_idlistarel=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

 
$arrresultado = $conexion->doSelect("tipolista_id, tipolista_nombre","tipolista ",
  "tipolista_activo = '1' and tipolista_idlistarel = '$tipolista_idlistarel'", null, "tipolista_nombre asc");

  $option = "<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

    $tipolista_id = utf8_encode($valor["tipolista_id"]);
    $tipolista_nombre = utf8_encode($valor["tipolista_nombre"]);    

     if ($idseleccionado==$tipolista_id){
        $option .= "<option selected='selected' value='$tipolista_id'>$tipolista_nombre</option>";
    }else{
        $option .= "<option value='$tipolista_id'>$tipolista_nombre</option>";
    }
  }


  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN TIPOS DE LISTAS</option>";
  }

  if (count($arrresultado)==1){
    $option = "<option selected='selected' value='$tipolista_id'>$tipolista_nombre</option>";
  } 


  return $option;

}

function ObtenerTipoDato($idseleccionado=null, $tipodatobuscar=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($tipodatobuscar!=""){
    $wherebuscar = " and tipodato_id in ($tipodatobuscar) ";
  }

  
 $arrresultado = $conexion->doSelect("tipodato_id, tipodato_nombre, tipodato_descrip, tipodato_fechareg, tipodato_activo, tipodato_eliminado
  ",
  "tipodato",
  "tipodato_activo = '1'  $wherebuscar", null, "tipodato_nombre asc");

  $option = "<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

    $tipodato_id = utf8_encode($valor["tipodato_id"]);
    $tipodato_nombre = utf8_encode($valor["tipodato_nombre"]);
    $tipodato_descrip = utf8_encode($valor["tipodato_descrip"]);

     if ($idseleccionado==$tipodato_id){
        $option .= "<option selected='selected' value='$tipodato_id'>$tipodato_descrip</option>";
    }else{
        $option .= "<option value='$tipodato_id'>$tipodato_descrip</option>";
    }
  }


  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN TIPOS DE DATOS</option>";
  }

  if (count($arrresultado)==1){
    $option = "<option selected='selected' value='$tipodato_id'>$tipodato_descrip</option>";
  } 


  return $option;

}

function ObtenerListaProcesoSeccion($cuentaseleccionada=null, $companiaseleccionada=null, $proceso_id=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

   $arrresultado = $conexion->doSelect("proceso.proceso_id, proceso.proceso_nombre, 
    proceso.proceso_descrip, proceso.proceso_img, 
    proceso.proceso_activo, proceso.proceso_eliminado, proceso.proceso_orden, 
    proceso.cuenta_id, proceso.compania_id, proceso.usuario_idreg,
    DATE_FORMAT(proceso.proceso_fechareg,'%d/%m/%Y %H:%i:%s') as proceso_fechareg,
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania.compania_nombre,
    procesoseccion.procesoseccion_id,
    procesoseccion.procesoseccion_nombre, procesoseccion.procesoseccion_img,
    procesoseccion.procesoseccion_orden,  procesoseccion.procesoseccion_activo,
    procesoseccion.procesoseccion_fechareg
    ",
    "proceso            
      inner join usuario cuenta on cuenta.usuario_id = proceso.cuenta_id
        inner join compania on compania.compania_id = proceso.compania_id 
        inner join procesoseccion on procesoseccion.proceso_id = proceso.proceso_id     
    ",
    "proceso.proceso_eliminado = '0' and procesoseccion.procesoseccion_eliminado = '0' and proceso.proceso_id = '$proceso_id' and compania.compania_eliminado = '0' $where ", null, "proceso.proceso_id desc");

    $option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $procesoseccion_id = utf8_encode($valor["procesoseccion_id"]);
      $procesoseccion_nombre = utf8_encode($valor["procesoseccion_nombre"]);

       if ($idseleccionado==$procesoseccion_id){
          $option .= "<option selected='selected' value='$procesoseccion_id'>$procesoseccion_nombre</option>";
      }else{
          $option .= "<option value='$procesoseccion_id'>$procesoseccion_nombre</option>";
      }
    }

 
    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN SECCIONES</option>";
    }

    if (count($arrresultado)==1){
      $option = "<option selected='selected' value='$procesoseccion_id'>$procesoseccion_nombre</option>";
    } 
  }
  

  return $option;

}

function ObtenerListaProceso($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

    $arrresultado = $conexion->doSelect("proceso.proceso_id, proceso.proceso_nombre, 
      proceso.proceso_descrip, proceso.proceso_img, 
      proceso.proceso_activo, proceso.proceso_eliminado, proceso.proceso_orden, 
      proceso.cuenta_id, proceso.compania_id, proceso.usuario_idreg,
      DATE_FORMAT(proceso.proceso_fechareg,'%d/%m/%Y %H:%i:%s') as proceso_fechareg,
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania.compania_nombre
      ",
      "proceso            
        inner join usuario cuenta on cuenta.usuario_id = proceso.cuenta_id
          inner join compania on compania.compania_id = proceso.compania_id       
      ",
      "proceso.proceso_eliminado = '0' and compania.compania_eliminado = '0' $where ", null, "proceso.proceso_nombre asc");

    $option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

      $proceso_id = utf8_encode($valor["proceso_id"]);
      $proceso_nombre = utf8_encode($valor["proceso_nombre"]);
      $proceso_descrip = utf8_encode($valor["proceso_descrip"]);

       if ($idseleccionado==$proceso_id){
          $option .= "<option selected='selected' value='$proceso_id'>$proceso_nombre</option>";
      }else{
          $option .= "<option value='$proceso_id'>$proceso_nombre</option>";
      }
    }

 
    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN PROCESOS DE ELABORACION</option>";
    }

    if (count($arrresultado)==1){
      $option = "<option selected='selected' value='$proceso_id'>$proceso_nombre</option>";
    } 
  }
  

  return $option;

}

function VerificaListaDefecto($lista_id=null){

  $conexion = new ConexionBd();  
 
  $arrresultado = $conexion->doSelect("lista_id","lista","lista_id = '$lista_id' and lista_defecto = '1'");
  if (count($arrresultado)>0){
    return true;
  }

  return false;

}


function VerificaSucursalDefecto($sucursal_id=null){

  $conexion = new ConexionBd();  
 
  $arrresultado = $conexion->doSelect("sucursal_id","sucursal","sucursal_id = '$sucursal_id' and sucursal_defecto = '1'");
  if (count($arrresultado)>0){
    return true;
  }

  return false;

}


function VerificaCompaniaDefecto($compania_id=null){

  $conexion = new ConexionBd();  
 
  $arrresultado = $conexion->doSelect("compania_id","compania","compania_id = '$compania_id' and compania_defecto = '1'");
  if (count($arrresultado)>0){
    return true;
  }

  return false;

}


function VerificaProductoDefecto($prod_id=null){

  $conexion = new ConexionBd();  
 
  $arrresultado = $conexion->doSelect("prod_id","producto","prod_id = '$prod_id' and prod_defecto = '1'");
  if (count($arrresultado)>0){
    return true;
  }

  return false;

}

function VerificaUsuarioDefecto($usuario_id=null){

  $conexion = new ConexionBd();  
 
  $arrresultado = $conexion->doSelect("usuario_id","usuario","usuario_id = '$usuario_id' and usuario_defecto = '1' and compania_id = '10'");
  if (count($arrresultado)>0){
    return true;
  }

  return false;

}


function ObtenerListaModulos($idseleccionado=null){

  $conexion = new ConexionBd();  

 $arrresultado = $conexion->doSelect("modulo_id, modulo_nombre",
    "modulo",
    "modulo_activo = '1' and modulo_padre = '1'", null, "modulo_nombre asc");

  $option = "<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

      $modulo_id  = utf8_encode($valor["modulo_id"]);
      $modulo_nombre = utf8_encode($valor["modulo_nombre"]);
      
      if($modulo_id == $idseleccionado){
        $option .= "<option selected='selected' value='$modulo_id'>$modulo_nombre</option>";
      }else{
        $option .= "<option value='$modulo_id'>$modulo_nombre</option>";
       }

  }

   if (count($arrresultado)==0){
     $option = "<option  value=''>NO EXISTEN MODULOS</option>";
   }

  
  return $option;

}


function ObtenerMenuPrincipalManual($idseleccionado=null){

  $conexion = new ConexionBd();  

   $arrresultado = $conexion->doSelect("manualsistema.manualsistema_id,manualsistema.manualsistema_nombre",
      "manualsistema",
      "manualsistema_eliminado = '0' and manualsistematipomenu_id  = '1'", null, "manualsistema_nombre asc");

  $option = "<option value=''>-- Seleccione --</option>";

  foreach($arrresultado as $i=>$valor){

      $manualsistema_id = utf8_encode($valor["manualsistema_id"]);
      $manualsistema_nombre = utf8_encode($valor["manualsistema_nombre"]);

      if($manualsistema_id == $idseleccionado){
        $option .= "<option selected='selected' value='$manualsistema_id'>$manualsistema_nombre</option>";
      }else{
        $option .= "<option value='$manualsistema_id'>$manualsistema_nombre</option>";
       }

  }

   if (count($arrresultado)==0){
     $option = "<option  value=''>NO EXISTEN MENUS PRINCIPALES</option>";
   }

  
  return $option;

}

function ObtenerManualTipoMenu($idseleccionado=null){

  $conexion = new ConexionBd();  

 $arrresultado = $conexion->doSelect("manualsistematipomenu_id, manualsistematipomenu_nombre, 
  manualsistematipomenu_activo, manualsistematipomenu_elimnado, manualsistematipomenu_orden ",
    "manualsistematipomenu",
    "manualsistematipomenu_activo = '1'", null, "manualsistematipomenu_orden asc");

  $option = "<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

      $manualsistematipomenu_id  = utf8_encode($valor["manualsistematipomenu_id"]);
      $manualsistematipomenu_nombre = utf8_encode($valor["manualsistematipomenu_nombre"]);
      
      if($manualsistematipomenu_id == $idseleccionado){
        $option .= "<option selected='selected' value='$manualsistematipomenu_id'>$manualsistematipomenu_nombre</option>";
      }else{
        $option .= "<option value='$manualsistematipomenu_id'>$manualsistematipomenu_nombre</option>";
       }

  }

   if (count($arrresultado)==0){
     $option = "<option  value=''>NO EXISTEN MENUS</option>";
   }

  
  return $option;

}

function obtenerFormaPagoPagar($modulo_id=null, $elemento_id=null, $t_cuenta_id=null, $t_compania_id=null, $getformapago_id=null, $total=null, $getcodigo=null){

    $conexion = new ConexionBd();

    $existe = 0;
    

    if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
          
      $whereformapago = " and listacuenta.cuenta_id = '$t_cuenta_id' and listacuenta.compania_id = '$t_compania_id' ";
      $wherecuentaformapago = " and listacuenta.cuenta_id = '$t_cuenta_id' ";
      $wherecompaniaformapago = " and listacuenta.compania_id = '$t_compania_id' ";   
      $wherelistacuentaformapago = " and listacuenta.cuenta_id = '$t_cuenta_id' and listacuenta.compania_id = '$t_compania_id'  ";
      $wherelistaactivoformapago = " and lista.lista_activo = '1' ";

    } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $whereformapago = " and listacuenta.cuenta_id = '$t_cuenta_id'   ";
      $wherecuentaformapago = " and listacuenta.cuenta_id = '$t_cuenta_id' ";
      //$wherecompaniaformapago = " and listacuenta.compania_id = '$t_compania_id' ";   
      $wherelistacuentaformapago = " and listacuenta.cuenta_id = '$t_cuenta_id' and listacuenta.compania_id = '$t_compania_id'  ";
      $wherelistaactivoformapago = " and lista.lista_activo = '1' ";

      if ($t_cuenta_id=="2179"){
        $whereformapago = " and listacuenta.cuenta_id = '$t_cuenta_id'   ";
        $wherecompaniaformapago  ="";
        $wherelistacuentaformapago = " and listacuenta.cuenta_id = '$t_cuenta_id'  ";
      }

    } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
      $whereformapago = " and listacuenta.cuenta_id = '$t_cuenta_id'  and listacuenta.compania_id = '$t_compania_id' ";
      $wherecuentaformapago = " and listacuenta.cuenta_id = '$t_cuenta_id' ";
      $wherecompaniaformapago = " and listacuenta.compania_id = '$t_compania_id' ";   
      $wherelistacuentaformapago = " and listacuenta.cuenta_id = '$t_cuenta_id' and listacuenta.compania_id = '$t_compania_id'  ";
      $wherelistaactivoformapago = " and lista.lista_activo = '1' ";

      if ($t_cuenta_id=="2179"){
        $whereformapago = " and listacuenta.cuenta_id = '$t_cuenta_id'   ";
        $wherecompaniaformapago  ="";
        $wherelistacuentaformapago = " and listacuenta.cuenta_id = '$t_cuenta_id'  ";
      }

    }  else {   

      $whereformapago = " and listacuenta.cuenta_id = '$t_cuenta_id' and listacuenta.compania_id = '$t_compania_id' ";
      $wherecuentaformapago = " and listacuenta.cuenta_id = '$t_cuenta_id' ";
      $wherecompaniaformapago = " and listacuenta.compania_id = '$t_compania_id' ";   
      $wherelistacuentaformapago = " and listacuenta.cuenta_id = '$t_cuenta_id' and listacuenta.compania_id = '$t_compania_id'  ";
      $wherelistaactivoformapago = " and lista.lista_activo = '1' ";

      if ($t_cuenta_id=="2179"){
        $whereformapago = " and listacuenta.cuenta_id = '$t_cuenta_id'   ";
        $wherecompaniaformapago  ="";
        $wherelistacuentaformapago = " and listacuenta.cuenta_id = '$t_cuenta_id'  ";
      }


    } 

    if ($getformapago_id!=""){
      $whereformapago2 = " and lista.lista_id = '$getformapago_id' ";
    }

    if ($t_cuenta_id=="2179"){
      $whereformapago = " and listacuenta.cuenta_id = '$t_cuenta_id'   ";
      $wherecompaniaformapago  ="";
      $wherelistacuentaformapago = " and listacuenta.cuenta_id = '$t_cuenta_id'  ";

      $whereformapago .= " and lista.lista_id = '2201'";
    }


    $arrresultado = $conexion->doSelect("

        lista.lista_id, lista.lista_nombre, lista.lista_img, lista.lista_orden, lista.lista_activo, lista.lista_ppal,     
        lista.cuenta_id as cuenta_idsistema, lista.compania_id as compania_idsistema, lista.lista_cod,
            
        cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
          cuenta.usuario_apellido as cuenta_apellido, compania.compania_nombre as compania_nombre,
          cuenta.usuario_codigo as cuentasistema_codigo, cuenta.usuario_nombre as cuentasistema_nombre,
          cuenta.usuario_apellido as cuentasistema_apellido, companiasistema.compania_nombre as companiasistema_nombre,

          listacuenta.cuenta_id, listacuenta.compania_id,
          listacuenta.listacuenta_id, listacuenta.listacuenta_activo, listacuenta.listacuenta_eliminado, 
          listacuenta.listacuenta_img, listacuenta.listacuenta_orden,
        listacuenta.listacuenta_nombre,
        lista.tipolista_id,

        listaformapago.listaformapago_id, listaformapago.l_formapago_id, listaformapago.listaformapago_titular,
        listaformapago.listaformapago_documento, listaformapago.listaformapago_email, 
        listaformapago.listaformapago_banco, listaformapago.listaformapago_tipocuenta, 
        listaformapago.listaformapago_nrocuenta, listaformapago.listaformapago_otros, 
        listaformapago.usuario_idreg,
        DATE_FORMAT(listaformapago_fechareg,'%d/%m/%Y %H:%i:%s') as listaformapago_fechareg

          ",
        "
        lista 

          inner join usuario cuentasistema on cuentasistema.usuario_id = lista.cuenta_id
            inner join compania companiasistema on companiasistema.compania_id = lista.compania_id              

          inner join listacuenta on listacuenta.lista_id = lista.lista_id
          $wherelistacuentaformapago

          inner join listaformapago on listaformapago.l_formapago_id = lista.lista_id
                and listaformapago.listacuenta_id = listacuenta.listacuenta_id
                
          left join usuario cuenta on cuenta.usuario_id = listacuenta.cuenta_id
            left join compania on compania.compania_id = listacuenta.compania_id              

            $wherecuentaformapago
            $wherecompaniaformapago

            inner join listacuentarel on listacuentarel.lista_id = lista.lista_id and listacuentarel.tipolista_id = '118' and listacuentarel_activo = '1'

        ",
        "lista.lista_eliminado = '0' and lista.tipolista_id = '21' $whereformapago2 and ((lista.lista_ppal = '1' $wherelistaactivoformapago) or (lista.lista_ppal = '0' ))  ", null, "lista.lista_orden asc");


      foreach($arrresultado as $i=>$valor){

        $existe = 1;

        $cuenta_idsistema = utf8_encode($valor["cuenta_idsistema"]);  
        $compania_idsistema = utf8_encode($valor["compania_idsistema"]);      

        $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
        $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
        $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  
        $listacuenta_eliminado = utf8_encode($valor["listacuenta_eliminado"]);  

        if ($listacuenta_eliminado=="1"){
          continue;
        }
       

        $listacuenta_orden = utf8_encode($valor["listacuenta_orden"]); 
        $listacuenta_img = utf8_encode($valor["listacuenta_img"]); 

        $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
        $t_compania_id = utf8_encode($valor["compania_id"]);    
        
        $lista_id = utf8_encode($valor["lista_id"]);
        $lista_nombre = utf8_encode($valor["lista_nombre"]);
        $lista_img = utf8_encode($valor["lista_img"]);  
        $lista_orden = utf8_encode($valor["lista_orden"]);  
        $lista_activo = utf8_encode($valor["lista_activo"]);      
        $lista_ppal = utf8_encode($valor["lista_ppal"]);      
        $lista_cod = utf8_encode($valor["lista_cod"]);     
          
        /* if ($lista_id!="2217"){
          continue;
        } */

       

     
        $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
        $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
        $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
        $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
        $compania_nombre = utf8_encode($valor["compania_nombre"]);


        $cuentasistema_nombre = utf8_encode($valor["cuentasistema_nombre"]);
        $cuentasistema_apellido = utf8_encode($valor["cuentasistema_apellido"]);
        $cuentasistema_codigo = utf8_encode($valor["cuentasistema_codigo"]);
        $cuentasistema = $cuentasistema_nombre." ".$cuentasistema_apellido." ";
        $companiasistema_nombre = utf8_encode($valor["companiasistema_nombre"]);

        $lista_activooriginal = $lista_activo;

        $listaformapago_id = utf8_encode($valor["listaformapago_id"]);
        $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
        $listaformapago_titular = utf8_encode($valor["listaformapago_titular"]);
        $listaformapago_documento = utf8_encode($valor["listaformapago_documento"]);
        $listaformapago_email = utf8_encode($valor["listaformapago_email"]);
        $listaformapago_banco = utf8_encode($valor["listaformapago_banco"]);
        $listaformapago_tipocuenta = utf8_encode($valor["listaformapago_tipocuenta"]);
        $listaformapago_nrocuenta = utf8_encode($valor["listaformapago_nrocuenta"]);
        $listaformapago_otros = utf8_encode($valor["listaformapago_otros"]);
        $listaformapago_fechareg = utf8_encode($valor["listaformapago_fechareg"]);



        if ($listacuenta_id!=""){
          $lista_nombre = $listacuenta_nombre;
          $lista_orden = $listacuenta_orden;
          $lista_img = $listacuenta_img;
          $lista_activo = $listacuenta_activo;
        }

        if ($lista_ppal=="1" && $t_cuenta_id==""){ // Es porque no esta personalizado por la empresa
          $cuenta = $cuentasistema;
          $compania_nombre = $companiasistema_nombre;
        }
      
     
        $imagen = "arch/$lista_img";
       

        $irurl = "pagopagar?id=$elemento_id&fid=$lista_id&t=$get_reenvio&m=$modulo_id&cod=$getcodigo";


        $instancialista = new Lista();
        
        $obtenerIdLista = 2;
        $obtenerTipoLista = 191; // Tipo de Pago completo
        $idtipopagocompleto = $instancialista->ObtenerIdLista($obtenerIdLista, $obtenerTipoLista);


        $optiontipopago = $instancialista->ObtenerListaRel('191', $t_cuenta_id, $t_compania_id, $idtipopagocompleto); 

        $divformapago  ="";
        
        //if ($formapago_descrip!=""){$divformapago .= " <strong>Dirección:</strong> $formapago_descrip <br>";}
        if ($listaformapago_email!=""){$divformapago .= " <strong>Email:</strong> $listaformapago_email <br>";}
        if ($listaformapago_banco!=""){$divformapago .= " <strong>Banco:</strong> $listaformapago_banco <br>";}
        if ($listaformapago_titular!=""){$divformapago .= " <strong>Titular:</strong> $listaformapago_titular <br>";}
        if ($listaformapago_tipocuenta!=""){$divformapago .= " <strong>Tipo de Cuenta:</strong> $listaformapago_tipocuenta <br>";}
        if ($listaformapago_nrocuenta!=""){$divformapago .= " <strong>Nro de Cuenta:</strong> $listaformapago_nrocuenta <br>";}
        if ($listaformapago_documento!=""){$divformapago .= " <strong>Nro de Documento:</strong> $listaformapago_documento <br>";}
        if ($listaformapago_otros!=""){$divformapago .= " <strong>Observaciones:</strong> $listaformapago_otros <br>";}
              

        

        $formapagodetalles = "
            <div id='div_formapago$formapago_id' style='font-size: 16px; padding-top: 10px'>          
                $divformapago
            </div>
          ";
          

        $formapagoimg = "
            <center>
                <a>
                  <img src='arch/$lista_img' style='max-height: 80px; max-width:100%' />             
                </a>
             </center>
             <br>
          ";
        

        $formapagohtml .= "
          <div class='col-lg-4 col-md-6' style='margin-bottom: 15px;'>
              <div class='package-content bg-light border text-center p-2 my-2 my-lg-0' style='background: #FFF; padding: 20px'>
                  <div class='package-content-heading border-bottom'>
                      <a href='$irurl'>
                        <center>
                            <img src='$imagen' class='img-responsive' style='height:90px' />
                        </center>                         
                      </a>
                      <h4>
                        $lista_nombre
                      </h4>                  
                  </div>            
                  <a href='$irurl' class='btn btn-primary' style='margin-top: 5px'>Seleccionar</a>
                  
              </div>
          </div>
        ";


    }


    if ($formapagohtml==""){
      $formapagohtml  = "
          <div class='col-md-12'>
            <div class='alert alert-danger' style='text-align: center; font-weight: normal;'>
                <a style='color: #FFF; font-size: 14px; text-decoration: none;' href='formapago'>
                    No posee formas de pagos configuradas.
                    <br>
                    Por favor seleccione y edite los datos dándole click aquí
                </a><br>
            </div>
          </div>
      ";
    }

    $arr = array(
      'existe' => $existe,
      'elemento_id' => $elemento_id,
      'modulo_id' => $modulo_id,
      'montopagar' => $montopagar,
      'montopagarmostrar' => $montopagarmostrar,
      'titulopago' => $titulopago,
      'divformapago' => $formapagohtml,
      'formapagoimg' => $formapagoimg,
      'formapagodetalles' => $formapagodetalles,
      'optiontipopago' => $optiontipopago,
      'formapagonombre' => $lista_nombre,
      'formapago_id' => $lista_id,
      'formapago_cod' => $lista_cod
    );
    $resultados [] = $arr;  

    return $resultados;

}


function obtenerMontoPago($modulo_id=null, $elemento_id=null, $montototal=null, $getestatus_cod=null){

    $conexion = new ConexionBd();   


    $montopagar = 0;
    $montopagarmostrar = 0;
    $existe = 0;

  if ($modulo_id=="1"){

       if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
        
            $where = "";    

        } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta    
                
            $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

        }  else { 

            $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]'  ";

        }

      $arrresultado = $conexion->doSelect("transaccion.trans_id, trans_montototal, 
        moneda.lista_nombredos as moneda_siglas, trans_codigo, transaccion.cuenta_id, transaccion.compania_id,
        transaccion.l_moneda_id      
        ",
        "transaccion    
        inner join transaccionventa on transaccionventa.trans_id = transaccion.trans_id
        left join compania on transaccion.compania_id = compania.compania_id
        left join usuario on transaccion.cliente_id = usuario.usuario_id
        left join lista estatus on estatus.lista_id = transaccion.l_estatus_id 
        left join lista moneda on moneda.lista_id = transaccion.l_moneda_id
        left join lista tipoventa on tipoventa.lista_id = transaccionventa.l_tipoventa_id

        ",
        "trans_eliminado = '0' and transaccion.l_tipotrans_id = '15' and transaccion.trans_id = '$elemento_id' $wheree ");
      foreach($arrresultado as $i=>$valor){
        $existe = 1;

        $cuenta_id = utf8_encode($valor["cuenta_id"]);
        $compania_id = utf8_encode($valor["compania_id"]);
        $montopagar = utf8_encode($valor["trans_montototal"]);
        $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
        $trans_codigo = utf8_encode($valor["trans_codigo"]);
        $l_moneda_id = utf8_encode($valor["l_moneda_id"]);

        $montopagarmostrar = number_format_personalizado($montopagar, $moneda_siglas);

        $titulopago = "
          <h4><strong>Id Venta:</strong> #$trans_codigo</h4>   
        ";
      }
  }

  if ($modulo_id=="939"){

      if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
        $where = "";    
      } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta              
        $where = " and listaplan.cuenta_id = '$_COOKIE[idcuenta]' ";
      }  else { 
        $where = " and listaplan.cuenta_id = '$_COOKIE[idcuenta]' and listaplan.compania_id = '$_COOKIE[idcompania]'  ";
      }
            
      $arrresultado = $conexion->doSelect("

        listaplan.listaplan_id, listaplan.l_plan_id, 
        listaplan.l_moneda_id, listaplan.listaplan_precio, 
        listaplan.listaplan_porccomision, listaplan.listaplan_contactos, 
        listaplan.listaplan_diasduracion, 
        listaplan.listaplan_habiltarminutos, listaplan.listaplan_notifwhatsapp, 
        listaplan.cuenta_id, listaplan.compania_id, 
        listaplan.listaplan_fechareg, listaplan.usuario_idreg, 
        listaplan.listaplan_url,

        plan.lista_id as plan_id, plan.lista_nombre as plan_nombre, plan.lista_img as plan_img,
        plan.lista_orden as plan_orden, plan.lista_activo as plan_activo,

        cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
        cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

        listaplandet_id, listaplandet_descrip, listaplandet_orden, listaplandet_activo,

        moneda.lista_nombredos as moneda_siglas

          ",
        "
        listaplan
            inner join lista plan on plan.lista_id = listaplan.l_plan_id          
            inner join usuario cuenta on cuenta.usuario_id = listaplan.cuenta_id
            inner join compania on compania.compania_id = listaplan.compania_id  

            left join lista moneda on moneda.lista_id = listaplan.l_moneda_id       
            left join listaplandetalle on listaplandetalle.l_plan_id = plan.lista_id 
              and listaplandet_activo = '1'
        ",
        " plan.lista_activo = '1' and plan.lista_id = '$elemento_id' $whereeeee  $wherelistaactivoooo", null, "plan.lista_orden, plan.lista_id, listaplandetalle.listaplandet_orden  asc");

      $cont = 0;
      foreach($arrresultado as $i=>$valor){

        $existe = 1;

        $cuenta_id = utf8_encode($valor["cuenta_id"]);
        $compania_id = utf8_encode($valor["compania_id"]);
        $montopagar = utf8_encode($valor["listaplan_precio"]);
        $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
        $plan_id = utf8_encode($valor["plan_id"]);
        $l_moneda_id = utf8_encode($valor["l_moneda_id"]);



        $montopagarmostrar = number_format_personalizado($montopagar, $moneda_siglas);

        $titulopago = "
          <h4><strong>Id Plan:</strong> #$plan_id</h4>   
        ";
      }
  }    

  if ($modulo_id=="1129"){ // Préstamos

      if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
       
           $where = "";    

       } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta    
               
           $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

       }  else { 

           $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]'  ";

       }

      $arrresultado = $conexion->doSelect("transaccion.trans_id, trans_montototal, 
        moneda.lista_nombredos as moneda_siglas, trans_codigo, transaccion.cuenta_id, transaccion.compania_id,
        transaccion.l_moneda_id, transprestamocuota_monto, transprestamocuota_montopendiente
        ",
        "transaccion            
        inner join transprestamocuota on transprestamocuota.trans_id = transaccion.trans_id
        inner join compania on transaccion.compania_id = compania.compania_id
        inner join usuario on transaccion.cliente_id = usuario.usuario_id
        inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id 
        inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
        ",
        "trans_eliminado = '0' and transprestamocuota.transprestamocuota_id = '$elemento_id' $wheree ");
      foreach($arrresultado as $i=>$valor){
        $existe = 1;

        $cuenta_id = utf8_encode($valor["cuenta_id"]);
        $compania_id = utf8_encode($valor["compania_id"]);
        $montopagar = utf8_encode($valor["transprestamocuota_montopendiente"]);
        $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
        $trans_codigo = utf8_encode($valor["trans_codigo"]);
        $l_moneda_id = utf8_encode($valor["l_moneda_id"]);


        $montopagarmostrar = number_format_personalizado($montopagar, $moneda_siglas);

        $titulopago = "
          <h4><strong>Id Préstamo:</strong> #$trans_codigo</h4>   
        ";
      }
    
  }

  if ($modulo_id=="1130"){ // Total del Préstamos Capital

    if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
     
         $where = "";    

     } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta    
             
         $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

     }  else { 

         $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]'  ";

     }


      $arrresultado = $conexion->doSelect("transaccion.trans_id, transprestamo_montoresta, 
        moneda.lista_nombredos as moneda_siglas, trans_codigo, transaccion.cuenta_id, transaccion.compania_id,
        transaccion.l_moneda_id
        ",
        "transaccion            
        inner join transprestamo on transprestamo.trans_id = transaccion.trans_id
        inner join compania on transaccion.compania_id = compania.compania_id
        inner join usuario on transaccion.cliente_id = usuario.usuario_id
        inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id 
        inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
        ",
        "trans_eliminado = '0' and transprestamo.trans_id = '$elemento_id' $wheree ");
      foreach($arrresultado as $i=>$valor){
        $existe = 1;

        $cuenta_id = utf8_encode($valor["cuenta_id"]);
        $compania_id = utf8_encode($valor["compania_id"]);
        $montopagar = utf8_encode($valor["transprestamo_montoresta"]);
        $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
        $trans_codigo = utf8_encode($valor["trans_codigo"]);
        $l_moneda_id = utf8_encode($valor["l_moneda_id"]);


        $montopagarmostrar = number_format_personalizado($montopagar, $moneda_siglas);

        $titulopago = "
          <h4><strong>Id Préstamo:</strong> #$trans_codigo</h4>   
        ";
      }
     
  }
  

  if ($modulo_id=="1222"){ // Cuotas Usuario

    if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
        $where = "";    

    } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta    
            
        $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

    }  else { 

        $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]'  ";

    }

    $arrresultado = $conexion->doSelect("
    cuota.cuota_id, cuota.cuota_nombre, cuota.cuota_codigo, cuota.cuota_monto, 
    cuota.l_moneda_id, cuota.cuota_usuarios, cuota.cuotaperiodo_id, cuota.cuota_activo, cuota.cuota_eliminado, 
    cuota.usuario_idreg, cuota.cuenta_id, cuota.compania_id,
    DATE_FORMAT(cuota.cuota_fechareg,'%d/%m/%Y %H:%i:%s') as cuota_fechareg,
    moneda.lista_nombredos as moneda_siglas,
    cuotaperiodo.cuotaperiodo_nombre,

    cuotausuario_id, cuotausuario_fechareg, cuotausuario_activo, 
    cuotausuario.l_estatus_id,
    estatus.lista_nombre as estatus_nombre,

    socio.usuario_nombre as socio_nombre,
    socio.usuario_apellido as socio_apellido,

    
    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre
    ",
    "cuota
      inner join usuario cuenta on cuenta.usuario_id = cuota.cuenta_id
      inner join compania on compania.compania_id = cuota.compania_id  
      inner join cuotausuario on cuotausuario.cuota_id = cuota.cuota_id
      inner join lista moneda on moneda.lista_id = cuota.l_moneda_id    
      inner join cuotaperiodo on cuotaperiodo.cuotaperiodo_id = cuota.cuotaperiodo_id   
      
      inner join lista estatus on estatus.lista_id = cuotausuario.l_estatus_id
      inner join usuario socio on socio.usuario_id = cuotausuario.usuario_id
      
    ",
    "cuota_eliminado = '0' and cuotausuario_eliminado = '0' and cuotausuario.cuotausuario_id = '$elemento_id' $wheree ", null, "cuota.cuota_id asc");

    foreach($arrresultado as $i=>$valor){
    
      $cuotausuario_id = utf8_encode($valor["cuotausuario_id"]);
      $cuotausuario_fechareg = utf8_encode($valor["cuotausuario_fechareg"]);
      $cuotausuario_activo = utf8_encode($valor["cuotausuario_activo"]);
      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      

      $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
      $cuotaperiodo_nombre = utf8_encode($valor["cuotaperiodo_nombre"]);

      $cuota_id = utf8_encode($valor["cuota_id"]);
      $cuota_nombre = utf8_encode($valor["cuota_nombre"]);
      $cuota_codigo = utf8_encode($valor["cuota_codigo"]);
      $montopagar = utf8_encode($valor["cuota_monto"]);
      $l_moneda_id = utf8_encode($valor["l_moneda_id"]);
      $cuota_usuarios = utf8_encode($valor["cuota_usuarios"]);
      $cuotaperiodo_id = utf8_encode($valor["cuotaperiodo_id"]);
      $cuota_activo = utf8_encode($valor["cuota_activo"]);
      $cuota_fechareg = utf8_encode($valor["cuota_fechareg"]);

      $socio_nombre = utf8_encode($valor["socio_nombre"]);
      $socio_apellido = utf8_encode($valor["socio_apellido"]);    
      $socio = $socio_nombre." ".$socio_apellido." ";

      $cuota_monto = number_format_personalizado($cuota_monto, $moneda_siglas);

      $cuenta_id = utf8_encode($valor["cuenta_id"]);
      $compania_id = utf8_encode($valor["compania_id"]);
      $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
      $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
      $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
      $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
      $compania_nombre = utf8_encode($valor["compania_nombre"]);
      
      $existe = 1;

      $montopagarmostrar = number_format_personalizado($montopagar, $moneda_siglas);

      $titulopago = "
        <h4><strong>Cuota:</strong> #$cuota_nombre</h4>   
      ";
      
    }
  }

  if ($modulo_id=="1464"){ // Reservas de Viaje

    if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
     
         $where = "";    

     } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta    
             
         $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

     }  else { 

         $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]'  ";

     }

   $arrresultado = $conexion->doSelect("transaccion.trans_id, trans_montototal, 
     moneda.lista_nombredos as moneda_siglas, trans_codigo, transaccion.cuenta_id, transaccion.compania_id, transaccion.l_moneda_id      
     ",
     "transaccion          
      left join compania on transaccion.compania_id = compania.compania_id
      left join usuario on transaccion.cliente_id = usuario.usuario_id
      left join lista estatus on estatus.lista_id = transaccion.l_estatus_id 
      left join lista moneda on moneda.lista_id = transaccion.l_moneda_id

     ",
     "trans_eliminado = '0'  and transaccion.trans_id = '$elemento_id' $wheree ");
   foreach($arrresultado as $i=>$valor){
     $existe = 1;

     $cuenta_id = utf8_encode($valor["cuenta_id"]);
     $compania_id = utf8_encode($valor["compania_id"]);
     $montopagar = utf8_encode($valor["trans_montototal"]);
     $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
     $trans_codigo = utf8_encode($valor["trans_codigo"]);
     $l_moneda_id = utf8_encode($valor["l_moneda_id"]);

     $montopagarmostrar = number_format_personalizado($montopagar, $moneda_siglas);

     $titulopago = "
       <h4><strong>Pago de reserva:</strong> #$trans_codigo</h4>   
     ";
    }
  }

  if ($modulo_id=="1467"){ // Envios

      if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
     
         $where = "";    

     } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta    
             
         $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

     }  else { 

         $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]'  ";

     }

   $arrresultado = $conexion->doSelect("transaccion.trans_id, trans_montototal, 
     moneda.lista_nombredos as moneda_siglas, trans_codigo, transaccion.cuenta_id, transaccion.compania_id,
     transaccion.l_moneda_id      
     ",
     "transaccion    
     inner join lista tipotransaccion on tipotransaccion.lista_id = transaccion.l_tipotrans_id
     left join compania on transaccion.compania_id = compania.compania_id
     left join usuario on transaccion.cliente_id = usuario.usuario_id
     left join lista estatus on estatus.lista_id = transaccion.l_estatus_id 
     left join lista moneda on moneda.lista_id = transaccion.l_moneda_id

     ",
     "trans_eliminado = '0' and tipotransaccion.lista_cod = '29' and transaccion.trans_id = '$elemento_id' $wheree ");
   foreach($arrresultado as $i=>$valor){
     $existe = 1;

     $cuenta_id = utf8_encode($valor["cuenta_id"]);
     $compania_id = utf8_encode($valor["compania_id"]);
     $montopagar = utf8_encode($valor["trans_montototal"]);
     $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
     $trans_codigo = utf8_encode($valor["trans_codigo"]);
     $l_moneda_id = utf8_encode($valor["l_moneda_id"]);

     $montopagarmostrar = number_format_personalizado($montopagar, $moneda_siglas);

     $titulopago = "
       <h4><strong>Id Venta:</strong> #$trans_codigo</h4>   
     ";
    }
  }

  if ($modulo_id=="1476"){ // Pago de Remesas

    if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
     
         $where = "";    

     } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta    
             
         $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

     }  else { 

         $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]'  ";

     }

    $arrresultado = $conexion->doSelect("transaccion.trans_id, 
     trans_codigo, transaccion.cuenta_id, transaccion.compania_id, 

     transaccionremesa.transremesa_montoorigenpagar,
     transaccionremesa.transremesa_montodestinopagar,

     transaccionremesa.l_moneda_idorigen,
     transaccionremesa.l_moneda_iddestino,

     monedaorigen.lista_nombredos as monedaorigen_siglas, 
     monedadestino.lista_nombredos as monedadestino_siglas

     ",
     "transaccion     
      inner join transaccionremesa on transaccion.trans_id = transaccionremesa.trans_id     
      inner join lista monedaorigen on monedaorigen.lista_id = transaccionremesa.l_moneda_idorigen
      inner join lista monedadestino on monedadestino.lista_id = transaccionremesa.l_moneda_iddestino

      left join compania on transaccion.compania_id = compania.compania_id
      left join usuario on transaccion.cliente_id = usuario.usuario_id
      left join lista estatus on estatus.lista_id = transaccion.l_estatus_id 
      

     ",
     "trans_eliminado = '0'  and transaccion.trans_id = '$elemento_id' $wheree ");
   foreach($arrresultado as $i=>$valor){
     $existe = 1;

     // getestatus_cod

     $cuenta_id = utf8_encode($valor["cuenta_id"]);
     $compania_id = utf8_encode($valor["compania_id"]);
     $transremesa_montoorigenpagar = utf8_encode($valor["transremesa_montoorigenpagar"]);
     $transremesa_montodestinopagar = utf8_encode($valor["transremesa_montodestinopagar"]);

     $monedaorigen_siglas = utf8_encode($valor["monedaorigen_siglas"]);
     $monedadestino_siglas = utf8_encode($valor["monedadestino_siglas"]);

     $trans_codigo = utf8_encode($valor["trans_codigo"]);
     
     $l_moneda_idorigen = utf8_encode($valor["l_moneda_idorigen"]);
     $l_moneda_iddestino = utf8_encode($valor["l_moneda_iddestino"]);

     if ($getestatus_cod=="3"){// Pendiente de pago del cliente
      $montopagar = $transremesa_montoorigenpagar;
      $montopagarmostrar = number_format_personalizado($montopagar, $monedaorigen_siglas);
      $l_moneda_id = $l_moneda_idorigen;      
     }else{
      $montopagar = $transremesa_montodestinopagar;
      $montopagarmostrar = number_format_personalizado($montopagar, $monedadestino_siglas);
      $l_moneda_id = $l_moneda_iddestino;      
     }

     $titulopago = "
       <h4><strong>Pago de remesa:</strong> #$trans_codigo</h4>   
     ";
    }
  }
    
  $arr = array(
    'existe' => $existe,
    'elemento_id' => $elemento_id,
    'modulo_id' => $modulo_id,
    'montopagar' => $montopagar,
    'montopagarmostrar' => $montopagarmostrar,
    'titulopago' => $titulopago,
    'l_moneda_id' => $l_moneda_id,
    'cuenta_id' => $cuenta_id,
    'compania_id' => $compania_id
  );
  $resultados [] = $arr;  

  return $resultados;

}

function obtenerCodigoSiguienteTransaccion($cuenta_id=null, $compania_id=null, $tipolista_id=null, $lista_id=null){

  $l_estatus_idfinal= 0;
  
  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("
    listarelacioncambio.listarelacioncambio_id, listarelacioncambio.l_estatus_idinicial, 
    listarelacioncambio.l_estatus_idfinal, listarelacioncambio.tipolista_id, listarelacioncambio.cuenta_id, 
    listarelacioncambio.compania_id, listarelacioncambio.listarelacioncambio_activo, 
    listarelacioncambio.listarelacioncambio_eliminado, 
    DATE_FORMAT(listarelacioncambio.listarelacioncambio_fechareg,'%d/%m/%Y %H:%i:%s') as listarelacioncambio_fechareg,    
    listarelacioncambio.usuario_idreg,
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
    estatusinicial.lista_nombre as estatusinicial_nombre,
    estatusinicial.lista_cod as estatusinicial_cod,
    estatusfinal.lista_nombre as estatusfinal_nombre,
    estatusfinal.lista_cod as estatusfinal_cod,
    tipolista.tipolista_nombre 
    ",
    "listarelacioncambio
      inner join lista estatusinicial on estatusinicial.lista_id = listarelacioncambio.l_estatus_idinicial
      inner join lista estatusfinal on estatusfinal.lista_id = listarelacioncambio.l_estatus_idfinal
      inner join tipolista on tipolista.tipolista_id = listarelacioncambio.tipolista_id
      inner join usuario cuenta on cuenta.usuario_id = listarelacioncambio.cuenta_id
        inner join compania on compania.compania_id = listarelacioncambio.compania_id       
    ",
    "listarelacioncambio_activo = '1' and listarelacioncambio.cuenta_id = '$cuenta_id' and listarelacioncambio.compania_id = '$compania_id' and listarelacioncambio.tipolista_id = '$tipolista_id' and listarelacioncambio.l_estatus_idinicial = '$lista_id' ");
  foreach($arrresultado as $i=>$valor){

    $listarelacioncambio_id = utf8_encode($valor["listarelacioncambio_id"]);
    $l_estatus_idinicial = utf8_encode($valor["l_estatus_idinicial"]);
    $l_estatus_idfinal = utf8_encode($valor["l_estatus_idfinal"]);
    $tipolista_id = utf8_encode($valor["tipolista_id"]);
    $listarelacioncambio_activo = utf8_encode($valor["listarelacioncambio_activo"]);
    $listarelacioncambio_fechareg = utf8_encode($valor["listarelacioncambio_fechareg"]);
    $estatusinicial_nombre = utf8_encode($valor["estatusinicial_nombre"]);
    $estatusfinal_nombre = utf8_encode($valor["estatusfinal_nombre"]);
    $tipolista_nombre = utf8_encode($valor["tipolista_nombre"]);

    $estatusinicial_cod = utf8_encode($valor["estatusinicial_cod"]);
    $estatusfinal_cod = utf8_encode($valor["estatusfinal_cod"]);
    
  }  
  
  return $l_estatus_idfinal;
}


function obtenerEstatusPermitidos($tipolista_id=null, $perfil_id=null){

    $conexion = new ConexionBd();

    $arrresultado = $conexion->doSelect("

      perfillistado.perfillista_id, perfillistado.perfil_id, 
      perfillistado.tipolista_id, perfillistado.lista_id, perfillistado.cuenta_id, 
      perfillistado.compania_id, perfillistado.perfillista_activo, 
      perfillistado.perfillista_eliminado, 
      perfillistado.perfillista_fechareg, perfillistado.usuario_idreg,
      perfil.perfil_nombre,
      tipolista_nombre, lista_nombre,
      
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre
    
      ",
      "perfillistado    
        inner join perfil on perfil.perfil_id = perfillistado.perfil_id       
        inner join tipolista on tipolista.tipolista_id = perfillistado.tipolista_id       
        inner join lista on lista.lista_id = perfillistado.lista_id       
        inner join usuario cuenta on cuenta.usuario_id = perfillistado.cuenta_id
          inner join compania on compania.compania_id = perfillistado.compania_id   
           
      ",
      "perfillista_activo = '1' and perfillistado.tipolista_id = '$tipolista_id' and perfil.perfil_id = '$_COOKIE[perfilactual]' ");
    $wherelista = "";
    foreach($arrresultado as $i=>$valor){
      $lista_id = utf8_encode($valor["lista_id"]);
      if ($wherelista==""){
        $wherelista .= $lista_id;
      }else{
        $wherelista .= ",".$lista_id;
      }
    }

    

    return $wherelista;

}

function obtenerCodigoSiguienteProducto($cuenta=null,$compania=null){

    $conexion = new ConexionBd();

    $arrresultado = $conexion->doSelect("max(prod_codigoint) as prod_codigoint","producto",
        "cuenta_id = '$cuenta' and compania_id='$compania'");
    foreach($arrresultado as $i=>$valor){
      $prod_codigoint = utf8_encode($valor["prod_codigoint"]);
    }

    if ($prod_codigoint==""){$prod_codigoint = 0;}
    $prod_codigoint = $prod_codigoint + 1;

    return $prod_codigoint;

}

function obtenerCodigoSiguienteUsuario($cuenta=null,$compania=null, $perfil=null){

    $conexion = new ConexionBd();

    $arrresultado = $conexion->doSelect("max(usuario_codigoint) as usuario_codigoint","usuario",
        "cuenta_id = '$cuenta' and compania_id='$compania' and perfil_id = '$perfil' ");
    foreach($arrresultado as $i=>$valor){
      $usuario_codigoint = utf8_encode($valor["usuario_codigoint"]);
    }

    if ($usuario_codigoint==""){$usuario_codigoint = 0;}
    $usuario_codigoint = $usuario_codigoint + 1;

    return $usuario_codigoint;

}

function verificarPermisoModuloUsuarioRegistro($modulo_id){

    $conexion = new ConexionBd();

    $arrresultado = $conexion->doSelect("perfilpermiso_id, perfilpermiso.perfil_id, perfilpermiso.modulo_id, 
      perfilpermiso.cuenta_id, perfilpermiso.compania_id, perfilpermiso_create, perfilpermiso_read, 
      perfilpermiso_update, perfilpermiso_delete, perfilpermiso_all, perfilpermiso_usuario, perfilpermiso_activo, 
      perfilpermiso_eliminado, perfilpermiso_fechareg, perfilpermiso.usuario_idreg, perfilpermiso.tipopermiso_id, 
      modulo_padre, modulo_defecto, modulo_sistema, modulo_relmodulo
      ",
      "perfilpermiso 
        inner join modulo on perfilpermiso.modulo_id = modulo.modulo_id      
      ",
      "perfilpermiso_activo = '1' and modulo.modulo_id = '$modulo_id' 
      and perfilpermiso.perfil_id = '$_COOKIE[perfilactual]'       
    ");   

    if (count($arrresultado)>0){
      foreach($arrresultado as $i=>$valor){
        $perfilpermiso_usuario = utf8_encode($valor["perfilpermiso_usuario"]);
      } 

      if ($perfilpermiso_usuario=="1"){
        return true;
      }
    }

    return false;

}

function verificarPermisoModulo($modulo_id){

    $conexion = new ConexionBd();

    $arrresultado = $conexion->doSelect("perfilpermiso_id, perfilpermiso.perfil_id, perfilpermiso.modulo_id, 
      perfilpermiso.cuenta_id, perfilpermiso.compania_id, perfilpermiso_create, perfilpermiso_read, 
      perfilpermiso_update, perfilpermiso_delete, perfilpermiso_all, perfilpermiso_usuario, perfilpermiso_activo, 
      perfilpermiso_eliminado, perfilpermiso_fechareg, perfilpermiso.usuario_idreg, perfilpermiso.tipopermiso_id, 
      modulo_padre, modulo_defecto, modulo_sistema, modulo_relmodulo
      ",
      "perfilpermiso 
        inner join modulo on perfilpermiso.modulo_id = modulo.modulo_id      
      ",
      "perfilpermiso_activo = '1' and modulo.modulo_id = '$modulo_id' 
      and perfilpermiso.perfil_id = '$_COOKIE[perfilactual]'       
    ");   

    return $arrresultado;

}

function ResumenUsuariosCliente($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $getdate=null, $moduloresumen_id=null, $estatus=null){

  $arrresultado = ListaModulosResumenPorId($cuentaseleccionada, $companiaseleccionada, $moduloresumen_id);
  foreach($arrresultado as $i=>$valor){  
    $modulo_url = utf8_encode($valor["modulo_url"]);    
    $moduloresumen_titulo = utf8_encode($valor["moduloresumen_titulo"]);
    $moduloresumen_backcolor = utf8_encode($valor["moduloresumen_backcolor"]);
    $moduloresumen_bordercolor = utf8_encode($valor["moduloresumen_bordercolor"]);
    $moduloresumen_icono = utf8_encode($valor["moduloresumen_icono"]);   

    $modulo_url = str_replace(".php","",$modulo_url);
  }


  if ($moduloresumen_titulo!=""){


    $fechaactual = formatoFechaHoraBd(1);    

    if ($fechadesde=="" && $fechahasta==""){
      $wherefecha = " and (usuario.usuario_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
    } else if ($fechadesde!="" && $fechahasta!=""){
      $wherefecha = " and (usuario.usuario_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
    } else if ($fechadesde!=""){
      $wherefecha = " and (usuario.usuario_fechareg > '$fechadesde 00:00:00' ) ";  
    } else if ($fechahasta!=""){
      $wherefecha = " and (usuario.usuario_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
    }

    if ($ultimosregistros!=""){
      $limitregistros =" LIMIT $ultimosregistros";
    }


    if ($_SESSION[perfil]=="1"){ // Administrador del Sistema
      
      $where = "";
      $columnacuenta = "<th>Cuenta</th>";
      $columnacompania = "<th>Compañia</th>";

    } else if ($_SESSION[perfil]=="2"){ // Administrador de Cuenta  
        
        $columnacompania = "<th>Compañia</th>";
        $where = " and usuario.cuenta_id = '$_SESSION[idcuenta]' ";

    }  else { 

      $where = " and usuario.cuenta_id = '$_SESSION[idcuenta]' and usuario.compania_id = '$_SESSION[idcompania]'  ";

    } 

    
    $conexion = new ConexionBd();

    $arrresultado = $conexion->doSelect("count(usuario.usuario_id) as total, lista_nombre, estatus.lista_id, lista_color, lista_icono",
    "
    lista estatus 
      left join usuario on usuario.l_estatus_id = estatus.lista_id  and usuario.usuario_eliminado = '0'   
      left join usuario cuenta on cuenta.usuario_id = usuario.cuenta_id
      left join compania on compania.compania_id = usuario.compania_id            
    ",
    "estatus.lista_activo = '1'  and estatus.tipolista_id = '98'", "lista_nombre, estatus.lista_id, lista_color, lista_icono", "estatus.lista_cod asc");

    foreach($arrresultado as $i=>$valor){
      
        $total = utf8_encode($valor["total"]);  
        $lista_nombre = utf8_encode($valor["lista_nombre"]);  
        $lista_id = utf8_encode($valor["lista_id"]);  
        $lista_color = utf8_encode($valor["lista_color"]);  
        $lista_icono = utf8_encode($valor["lista_icono"]);

        if ($lista_color==""){
          $lista_color = "#3c8dbc";
        }

        $lista_color = " style='background-color: $lista_color'";
        


        $url = "$modulo_url?e=$lista_id&date=$getdate";

        $divresumen  .="
          <div class='col-lg-3 col-sm-6 col-xs-12'>      
            <div class='small-box div_accesodirecto' $lista_color>
              <div class='inner'>
                <a href='$url'><h3>$total</h3></a>
                <a href='$url'><p>$lista_nombre</p></a>
              </div>
              <div class='icon'>
                <a href='$url'>
                  <i class='$lista_icono'></i>
                </a>
              </div>
              <a href='$url' class='small-box-footer'>Ver &nbsp <i class='fa fa-arrow-circle-right'></i></a>
            </div>
          </div>
        "; 



    }

  }


  return $divresumen;

}

function ListadoUsuariosCliente($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_SESSION[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_SESSION[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where2 = " and usuarioperfil.cuenta_id = '$_SESSION[idcuenta]' ";

  }  else { 

    $where = " and usuarioperfil.cuenta_id = '$_SESSION[idcuenta]' and usuarioperfil.compania_id = '$_SESSION[idcompania]' ";

  } 

  if($getestatus!=""){
    $whereestatus = " and usuarioperfil.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("usuarioperfil.usuario_id, usuarioperfil.usuario_codigo, usuarioperfil.usuario_email, usuarioperfil.usuario_clave, 
      usuarioperfil.usuario_nombre, usuarioperfil.usuario_apellido, usuarioperfil.usuario_telf,  usuarioperfil.usuario_activo, 
      usuarioperfil.usuario_eliminado, usuarioperfil.usuario_documento, usuarioperfil.usuario_img, usuarioperfil.perfil_id,
      usuarioperfil.usuario_direccion, usuarioperfil.usuario_localidad, usuarioperfil.usuario_actividad, usuarioperfil.nacionalidad_id,
      usuarioperfil.sexo_id, usuarioperfil.e_estadocivil_id, usuarioperfil.usuario_conyugenombre, usuarioperfil.usuario_conyugetelf,
      usuarioperfil.usuario_pariente, usuarioperfil.usuario_parientetelf, usuarioperfil.e_parentesco_id, usuarioperfil.usuario_telfdos, 
      usuarioperfil.usuario_notas, usuarioperfil.usuario_porcentajecolocador, usuarioperfil.usuario_balance, usuarioperfil.usuario_comentarios, 
      DATE_FORMAT(usuarioperfil.usuario_fechanac,'%d/%m/%Y') as usuario_fechanac, usuarioperfil.nivelriesgo_id,
      usuarioperfil.l_tipodocumento_id,
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre, compania_urlweb,
      DATE_FORMAT(usuarioperfil.usuario_fechareg,'%d/%m/%Y %H:%i:%s') as usuario_fechareg,
      perfil_nombre,       
      usuarioperfil.l_estatus_id, estatus.lista_nombre as estatus_nombre, 
      estatus.lista_cod as estatus_cod

      ",
    "usuario usuarioperfil
        inner join usuario cuenta on usuarioperfil.cuenta_id = cuenta.usuario_id
        inner join compania on compania.compania_id = usuarioperfil.compania_id
        inner join perfil on usuarioperfil.perfil_id = perfil.perfil_id
        
        left join lista estatus on estatus.lista_id = usuarioperfil.l_estatus_id
    ",
    "usuarioperfil.usuario_eliminado = '0' and usuarioperfil.perfil_id = '77'  $whereestatus $whereestatus $whereperfil  $wherefecha ", null, "usuarioperfil.usuario_id desc");
  foreach($arrresultado as $i=>$valor){

    $estatus_cod = utf8_encode($valor["estatus_cod"]);
    $tipousuarioservicio_nombre = utf8_encode($valor["tipousuarioservicio_nombre"]);

    $t_perfil_id = utf8_encode($valor["perfil_id"]);
    $perfil_nombre = utf8_encode($valor["perfil_nombre"]);

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_codigo = utf8_encode($valor["usuario_codigo"]);
    $usuario_email = utf8_encode($valor["usuario_email"]);
    $usuario_clave = utf8_encode($valor["usuario_clave"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_telf = utf8_encode($valor["usuario_telf"]);
    $usuario_fechareg = utf8_encode($valor["usuario_fechareg"]);
    $usuario_activo = utf8_encode($valor["usuario_activo"]);
    $usuario_documento = utf8_encode($valor["usuario_documento"]);  
    
    $usuario_direccion = utf8_encode($valor["usuario_direccion"]);
    $usuario_localidad = utf8_encode($valor["usuario_localidad"]);
    $usuario_actividad = utf8_encode($valor["usuario_actividad"]);
    $t_nacionalidad_id = utf8_encode($valor["nacionalidad_id"]);
    $t_sexo_id = utf8_encode($valor["sexo_id"]);
    $e_estadocivil_id = utf8_encode($valor["e_estadocivil_id"]);  
    $usuario_conyugenombre = utf8_encode($valor["usuario_conyugenombre"]);
    $usuario_conyugetelf = utf8_encode($valor["usuario_conyugetelf"]);
    $usuario_pariente = utf8_encode($valor["usuario_pariente"]);
    $usuario_parientetelf = utf8_encode($valor["usuario_parientetelf"]);
    $e_parentesco_id = utf8_encode($valor["e_parentesco_id"]);
    $usuario_telfdos = utf8_encode($valor["usuario_telfdos"]);
    $usuario_notas = utf8_encode($valor["usuario_notas"]);
    $usuario_porcentajecolocador = utf8_encode($valor["usuario_porcentajecolocador"]);
    $usuario_balance = utf8_encode($valor["usuario_balance"]);
    $usuario_comentarios = utf8_encode($valor["usuario_comentarios"]);
    $usuario_tasapref = utf8_encode($valor["usuario_tasapref"]);
    $usuario_fechanac = utf8_encode($valor["usuario_fechanac"]);
    $t_nivelriesgo_id = utf8_encode($valor["nivelriesgo_id"]);
    
      $compania_nombre = utf8_encode($valor["compania_nombre"]);
      $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    if ($usuario_id!= "1"){
      if ($usuario_activo=="0"){
        $activo = "<i onclick='cambiarestatususuario(\"".$usuario_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
      }else{
        $activo = "<i onclick='cambiarestatususuario(\"".$usuario_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
      }
      
      $accioneliminar = "<i onclick='eliminarusuario(\"".$usuario_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    }

    $verperfil = "<a href='modificarusuarioafiliado?id=$usuario_id'>
      <span style='color: #000'>$usuario_nombre $usuario_apellido</span>
    </a>";
    
    
    $modificar = "<a href='modificarusuariocliente?id=$usuario_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    if ($estatus_cod!="2"){
      $qrver  =""; 
    }

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_SESSION[perfil]=="1"){      
      
    }
    else if ($_SESSION[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }


    $textohtml .= "
           <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania            
            <td>$verperfil</td>            
            <td>$usuario_email</td>
            
            <td>$usuario_telf</td>
            
            <td>$estatus_nombre</td>  
            <td>$usuario_fechareg</td>  
            <td style='text-align: center'>$qrver &nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
              </tr>
        ";

  }

  return $textohtml;

}

function ObtenerListaVotacion($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

      
     $arrresultado = $conexion->doSelect("votacion_id, votacion_nombre",
        "votacion
          
        ",
        "votacion_activo = '1'  and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada' ", null, "votacion_nombre asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

        $votacion_id = utf8_encode($valor["votacion_id"]);
        $votacion_nombre = utf8_encode($valor["votacion_nombre"]);

        if ($idseleccionado==$votacion_id){
              $option .= "<option selected='selected' value='$votacion_id'>$votacion_nombre</option>";
          }else{
              $option .= "<option value='$votacion_id'>$votacion_nombre</option>";
          }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN VOTACIONES</option>";
      }

      if (count($arrresultado)==1){
        $option = "<option selected='selected' value='$votacion_id'>$votacion_nombre</option>";
      } 
  }
  

  return $option;

}


function registrarIngresoProveedor($codigoProveedor =null, $email=null, $idcuenta=null, $idcompania=null, 
$nombre=null, $apellido=null, $urlimagen = null, $code=null, $tokenValor=null){

  $conexion = new ConexionBd(); 
  
  $instancialista = new Lista();

  $obtenerIdLista = $codigoProveedor;
  $obtenerTipoLista = 24;
  $idcorreoproveedor = $instancialista->ObtenerIdLista($obtenerIdLista, $obtenerTipoLista);

  $fechaactual = formatoFechaHoraBd();    

    $arrresultado = $conexion->doSelect("usuario.usuario_id, usuario.usuario_nombre, usuario.usuario_email",
    "usuario",
    "usuario_email = '$email' and usuario_eliminado = '0' and cuenta_id = '$idcuenta' and compania_id  ='$idcompania'");
    if (count($arrresultado)>0){
    foreach($arrresultado as $i=>$valor){
      $usuario_id = utf8_encode($valor["usuario_id"]);
    }
  }else{    

    $resultado = $conexion->doInsert("
    usuario
      (usuario_email, usuario_clave, usuario_nombre, usuario_apellido, 
      usuario_fechareg, usuario_activo, usuario_eliminado, usuario_img, perfil_id,
      cuenta_id, compania_id, tipoinicses_id) 
    ",
    "'$email', '', '$nombre', '$apellido', 
    '$fechaactual', '1', '0', '$urlimagen', '4', 
    '$idcuenta', '$idcompania','$idcorreoproveedor'");

    $arrresultado2 = $conexion->doSelect("max(usuario_id) as usuario_id","usuario");
    if (count($arrresultado2)>0){
      foreach($arrresultado2 as $i=>$valor){
        $usuario_id = strtoupper($valor["usuario_id"]);
      }
    }

  }

  $resultado = $conexion->doInsert("
    usuarioconexiontoken
      (usuario_id, usuarioconextokenaccess_code, usuarioconextokenaccess_token, 
      usuarioconextokenid_token, usuarioconextokenscope, usuarioconextokenexpires_in,
       usuarioconextokenfirst_issued_at, usuarioconextokenexpires_at, 
       usuarioconextoken_fechareg, usuarioconextoken_activo, usuarioconextoken_eliminado) 
    ",
    "'$usuario_id', '$code', '$tokenValor',
    '$tokenValor', '','', 
    '', '',
    '$fechaactual','1','0'
    ");

  //echo "<script language='JavaScript'>window.location = 'clientecorreo?uid=$usuario_id'; </script>";
  //exit();

  return $usuario_id; 
}

function pmlmdaConsultaGraficoZonaCargaAno($fechadesde =null, $fechahasta=null, $pasarzonacarga=null, $getaccion=null){

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (fecha BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (fecha BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (fecha > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (fecha BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($pasarzonacarga!=""){
    $wherezonacarga = " and id_zona_carga  in ($pasarzonacarga) ";
  }


  $conexion = new ConexionBd(); 


  $arrresultado = $conexion->doSelect("DATE_FORMAT(fecha,'%Y') as fecha_ano, 
      DATE_FORMAT(fecha,'%m') as fecha_mes,
      AVG(pml) as pmlmda",
      "pend_mda",
      "1=1 and DATE_FORMAT(fecha,'%Y') in ('2019','2020','2021') $wherezonacarga", 
      "DATE_FORMAT(fecha,'%Y'), DATE_FORMAT(fecha,'%m')", 
      "DATE_FORMAT(fecha,'%Y'), DATE_FORMAT(fecha,'%m') asc ");

  $cont = 0;

  if ($getaccion=="tabla"){
    return $arrresultado;
  }

  $final_array = array ();
  foreach($arrresultado as $i=>$valor){
      $fecha_ano = utf8_encode($valor["fecha_ano"]); 
      $fecha_mes = utf8_encode($valor["fecha_mes"]);      
      $pmlmda = utf8_encode($valor["pmlmda"]);

      $fecha_mes = $fecha_mes - 1;

      $valorunico = " '$fecha_ano': $pmlmda, ";

      //new Date(2000, $fecha_mes, 1)
      //'date': new Date(2000, $fecha_mes, 1).getMonth(),

      $valores .= "
          {
            'date': new Date(1900, $fecha_mes, 1),
            $valorunico
          },
        ";
  }
/*

  echo "<pre>";
  print_r($valores);
  echo "</pre>";
  exit();
*/
  return $valores; 

}

function pmlmdaConsultaGraficoZonaCarga($fechadesde =null, $fechahasta=null, $pasarzonacarga=null){

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (fecha BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (fecha BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (fecha > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (fecha BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($pasarzonacarga!=""){
    $wherezonacarga = " and id_zona_carga  in ($pasarzonacarga) ";
  }

  $conexion = new ConexionBd(); 

  $arrresultado = $conexion->doSelect("
    DATE_FORMAT(fecha,'%Y-%m-%d %H:%i:%s') as fecha, 
    DATE_FORMAT(fecha,'%Y') as fecha_ano, 
    DATE_FORMAT(fecha,'%m') as fecha_mes, 
    DATE_FORMAT(fecha,'%d') as fecha_dia, 
    DATE_FORMAT(fecha,'%H') as fecha_hora, 
    DATE_FORMAT(fecha,'%i') as fecha_minutos, 
    DATE_FORMAT(fecha,'%s') as fecha_segundos, 
    pml as pmlmda, id_zona_carga
      ",
      "pend_mda
      ",
      "1=1 $wherefecha $wherezonacarga", 
      null, 
      "fecha asc");

  $cont = 0;
/*
  echo "<pre>";
  print_r($arrresultado);
  echo "</pre>";
  exit();
  */
  $final_array = array ();
  foreach($arrresultado as $i=>$valor){
      $fechamda = utf8_encode($valor["fecha"]);
      $fecha_ano = intval(utf8_encode($valor["fecha_ano"]));
      $fecha_mes = intval(utf8_encode($valor["fecha_mes"]));
      $fecha_dia = intval(utf8_encode($valor["fecha_dia"]));
      $fecha_hora = intval(utf8_encode($valor["fecha_hora"]));
      $fecha_minutos = intval(utf8_encode($valor["fecha_minutos"]));
      $fecha_segundos = intval(utf8_encode($valor["fecha_segundos"]));
      
      $pmlmda = utf8_encode($valor["pmlmda"]);
      $id_zona_carga = utf8_encode($valor["id_zona_carga"]);

      $valorunico .= " '$id_zona_carga': $pmlmda, ";

      $valores .= "
          {
            'date': new Date($fecha_ano, $fecha_mes, $fecha_dia, $fecha_hora, $fecha_minutos, $fecha_segundos),
            $valorunico
          },
        ";
      
  }
  /*
  $arrresultado = $conexion->doSelect("
    DATE_FORMAT(fecha,'%Y-%m-%d') as fecha, 
    DATE_FORMAT(fecha,'%Y') as fecha_ano, 
    DATE_FORMAT(fecha,'%m') as fecha_mes, 
    DATE_FORMAT(fecha,'%d') as fecha_dia, 

    sum(pml) as pmlmda, id_zona_carga
      ",
      "pend_mda
      ",
      "1=1 $wherefecha $wherezonacarga", 
      "DATE_FORMAT(fecha,'%Y-%m-%d'), id_zona_carga", 
      "fecha asc");

  $cont = 0;

  $final_array = array ();
  foreach($arrresultado as $i=>$valor){
      $fechamda = utf8_encode($valor["fecha"]);
      
      $pmlmda = utf8_encode($valor["pmlmda"]);
      $id_zona_carga = utf8_encode($valor["id_zona_carga"]);
      

      if ($cont>0){

        if ($fechamda!=$fechamdaold){

          $valores .= "
          {
            'date': new Date($fecha_ano, $fecha_mes, $fecha_dia),
            $valorunico
          },
        ";

        $valorunico = "";

        }


      }

      $fecha_ano = utf8_encode($valor["fecha_ano"]);
      $fecha_mes = utf8_encode($valor["fecha_mes"]);
      $fecha_dia = utf8_encode($valor["fecha_dia"]);

      $fecha_mes = $fecha_mes;

      $valorunico .= " '$id_zona_carga': $pmlmda, ";

     
      $cont = $cont + 1;


      $fechamdaold = $fechamda;
  }

  */
  /*
  echo "<pre>";
  print_r($valores);
  echo "</pre>";
  */

  return $valores; 

}

function pmlmdaConsultaResumen($fechadesde =null, $fechahasta=null, $pasarzonacarga=null){

  $conexion = new ConexionBd(); 

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (fecha BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (fecha BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (fecha > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (fecha BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($pasarzonacarga!=""){
    $wherezonacarga = " and id_zona_carga  in ($pasarzonacarga) ";
  }

  $resultados = array ();

  // Minimo Diario
  $arrresultado = $conexion->doSelect("min(pml) as minimodiario",
      "pend_mda",
      "1=1 $wherefecha $wherezonacarga");
  
  foreach($arrresultado as $i=>$valor){
      $minimodiario = utf8_encode($valor["minimodiario"]);      
      $arr = array('minimodiario' =>$minimodiario);
      $resultados [] = $arr;
  }

  // Maximo Diario
  $arrresultado = $conexion->doSelect("max(pml) as maximodiario",
      "pend_mda",
      "1=1 $wherefecha $wherezonacarga");
  
  foreach($arrresultado as $i=>$valor){
      $maximodiario = utf8_encode($valor["maximodiario"]);      
      $arr = array('maximodiario' =>$maximodiario);
      $resultados [] = $arr;
  }

  return $resultados;

}

function pmlmdaZonaCarga($zonacarga=null){

 
  if ($zonacarga!=""){    
    $valoresconcantzonacarga = explode(",", $zonacarga);   
  }


  $conexion = new ConexionBd(); 
  $arrresultado = $conexion->doSelect("id_zona_carga 
      ",
      "pend_mda_zona
      ",
      "1=1 ", "id_zona_carga asc ");

  $option  ="";
  foreach($arrresultado as $i=>$valor){
      $id_zona_carga = utf8_encode($valor["id_zona_carga"]);

      $colocoselected = 0;

      foreach($valoresconcantzonacarga as $v=>$zonacargaid){        
        if ($zonacargaid==$id_zona_carga){
          $option .= "<option selected='selected' value='$id_zona_carga'>$id_zona_carga</option>";  
          $colocoselected = 1;
        }        
      }

      if ($colocoselected=="0"){
        $option .= "<option value='$id_zona_carga'>$id_zona_carga</option>";  
      }
     
  }

  return $option;

}


function pmlmdaConsulta($fechadesde =null, $fechahasta=null, $pasarzonacarga=null, $getaccion=null){

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (fecha BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (fecha BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (fecha > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (fecha BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($pasarzonacarga!=""){
    $wherezonacarga = " and id_zona_carga  in ($pasarzonacarga) ";
  }

  if ($getaccion=="descarga"){
    $agregar=", id_zona_carga";
  }

  if ($getaccion=="tabla"){
    $agregar=", id_zona_carga";
  }

  $conexion = new ConexionBd(); 
  $arrresultado = $conexion->doSelect("fecha, sum(pml) as pmlmda $agregar
      ",
      "pend_mda
      ",
      "1=1 $wherefecha $wherezonacarga", "fecha $agregar");

  if ($getaccion=="descarga" || $getaccion=="tabla" ){
    return $arrresultado;
  }

  $final_array = array ();
  foreach($arrresultado as $i=>$valor){
      $fechamda = utf8_encode($valor["fecha"]);
      $pmlmda = utf8_encode($valor["pmlmda"]);

      $arr = array(
              'fechamda'   =>$fechamda ,
              'pmlmda' =>$pmlmda
            );
      $final_array [] = $arr;
  }

  $resultadojson = json_encode ($final_array);

  return $resultadojson;

}

function NotificaRetiro($usuariobalanceretiro_id=null){

    $conexion = new ConexionBd(); 
    $arrresultado = $conexion->doSelect("usuario.usuario_id, usuario.usuario_codigo, usuario.usuario_email, 
      usuario.usuario_clave, usuario.usuario_nombre, usuario.usuario_apellido, 
      usuario.usuario_telf, usuario.usuario_activo, usuario.usuario_eliminado, 
      usuario.usuario_documento, usuario.usuario_img, usuario.perfil_id,     
      DATE_FORMAT(usuario.usuario_fechanac,'%d/%m/%Y') as usuario_fechanac, usuario.nivelriesgo_id,
      DATE_FORMAT(usuario.usuario_fechareg,'%d/%m/%Y') as usuario_fechareg, usuario.usuario_alias, usuario.l_tipousuarioserv_id,
    
      usuariobalance_cantidad, usuariobalance_disponible, 
      moneda.lista_nombredos as moneda_siglas,

      usuariobalanceretiro.usuariobalanceretiro_id, usuariobalanceretiro.usuario_id, 
      usuariobalanceretiro.usuarioretiro_id, usuariobalanceretiro.usuariobalanceretiro_monto,     
      usuariobalanceretiro.l_estatus_id, usuariobalanceretiro.usuariobalanceretiro_activo, 
      usuariobalanceretiro.usuariobalanceretiro_eliminado, usuariobalanceretiro.usuariobalanceretiro_observ, 
      usuariobalanceretiro.usuariobalanceretiro_procesado, usuariobalanceretiro.cuenta_id, 
      usuariobalanceretiro.compania_id, usuariobalanceretiro.usuariobalanceretiro_cod, 
      usuariobalanceretiro.l_moneda_id,
      formapago.lista_nombre as formapago_nombre,
      estatus.lista_nombre as estatus_nombre,
      DATE_FORMAT(usuariobalanceretiro_fechareg,'%d/%m/%Y %H:%i:%s') as usuariobalanceretiro_fechareg,
      
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

      usuarioretiro.usuarioretiro_id, usuarioretiro.usuarioretiro_descripcion, 
      usuarioretiro.usuarioretiro_email, 
      usuarioretiro.usuarioretiro_activo, usuarioretiro.usuarioretiro_eliminado, 
      usuarioretiro.usuario_id, usuarioretiro.l_formapago_id, 
      usuarioretiro.usuarioretiro_banco, usuarioretiro.usuarioretiro_titular, 
      usuarioretiro.usuarioretiro_tipocuenta, usuarioretiro.usuarioretiro_documento, 
      usuarioretiro.usuarioretiro_nrocuenta, 

      usuariobalance_id
      ",
      "usuario
          inner join usuariobalanceretiro on usuariobalanceretiro.usuario_id = usuario.usuario_id and usuariobalanceretiro_eliminado = '0'
          inner join usuarioretiro on usuarioretiro.usuario_id = usuario.usuario_id and usuarioretiro_activo = '1'
          inner join lista formapago on formapago.lista_id = usuarioretiro.l_formapago_id
          inner join lista estatus on estatus.lista_id = usuariobalanceretiro.l_estatus_id
          inner join usuariobalance on usuariobalance.usuario_id = usuario.usuario_id        
          inner join lista moneda on moneda.lista_id = usuariobalance.l_moneda_id
          inner join usuario cuenta on cuenta.usuario_id = usuario.cuenta_id
          inner join compania on compania.compania_id = usuario.compania_id
      ",
      "usuario.usuario_activo = '1' and usuariobalanceretiro_id = '$usuariobalanceretiro_id'", null, "usuariobalanceretiro_id desc");

  foreach($arrresultado as $i=>$valor){

      $usuario_id = utf8_encode($valor["usuario_id"]);
      $usuarioretiro_id = utf8_encode($valor["usuarioretiro_id"]);
      $usuarioretiro_descripcion = utf8_encode($valor["usuarioretiro_descripcion"]);
      $usuarioretiro_email = utf8_encode($valor["usuarioretiro_email"]);
      $usuarioretiro_fechareg = utf8_encode($valor["usuarioretiro_fechareg"]);
      $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
      $usuarioretiro_banco = utf8_encode($valor["usuarioretiro_banco"]);
      $usuarioretiro_titular = utf8_encode($valor["usuarioretiro_titular"]);
      $usuarioretiro_tipocuenta = utf8_encode($valor["usuarioretiro_tipocuenta"]);
      $usuarioretiro_documento = utf8_encode($valor["usuarioretiro_documento"]);
      $usuarioretiro_nrocuenta = utf8_encode($valor["usuarioretiro_nrocuenta"]);    

      $usuariobalanceretiro_id = utf8_encode($valor["usuariobalanceretiro_id"]);
      $usuario_id = utf8_encode($valor["usuario_id"]);
      $usuarioretiro_id = utf8_encode($valor["usuarioretiro_id"]);
      $usuariobalanceretiro_monto = utf8_encode($valor["usuariobalanceretiro_monto"]);
      $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
      $usuariobalanceretiro_fechareg = utf8_encode($valor["usuariobalanceretiro_fechareg"]);
      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $usuariobalanceretiro_activo = utf8_encode($valor["usuariobalanceretiro_activo"]);
      $usuariobalanceretiro_observ = utf8_encode($valor["usuariobalanceretiro_observ"]);
      $usuariobalanceretiro_procesado = utf8_encode($valor["usuariobalanceretiro_procesado"]);
      $cuenta_id = utf8_encode($valor["cuenta_id"]);
      $compania_id = utf8_encode($valor["compania_id"]);
      $usuariobalanceretiro_cod = utf8_encode($valor["usuariobalanceretiro_cod"]);
      $l_moneda_id = utf8_encode($valor["l_moneda_id"]);

      $formapago_nombre = utf8_encode($valor["formapago_nombre"]);
      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
     

      $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
      $usuariobalance_cantidad = utf8_encode($valor["usuariobalance_cantidad"]);
      $usuariobalance_disponible = utf8_encode($valor["usuariobalance_disponible"]);

      if ($usuariobalance_cantidad==""){$usuariobalance_cantidad=0;}
      if ($usuariobalance_disponible==""){$usuariobalance_disponible=0;}

      $usuariobalanceretiro_monto  = number_format_personalizado($usuariobalanceretiro_monto, $moneda_siglas);

      $l_plan_id = utf8_encode($valor["l_plan_id"]);
      $plan_nombre = utf8_encode($valor["plan_nombre"]);
      $plan_img = utf8_encode($valor["plan_img"]);
      $usuarioplan_fechaini = utf8_encode($valor["usuarioplan_fechaini"]);
      $usuarioplan_fechafin = utf8_encode($valor["usuarioplan_fechafin"]);

      $usuario_alias = utf8_encode($valor["usuario_alias"]);

      $usuario_id = utf8_encode($valor["usuario_id"]);
      $usuario_codigo = utf8_encode($valor["usuario_codigo"]);
      $usuario_email = utf8_encode($valor["usuario_email"]);
      $usuario_clave = utf8_encode($valor["usuario_clave"]);
      $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
      $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
      $usuario_telf = utf8_encode($valor["usuario_telf"]);
      $usuario_fechareg = utf8_encode($valor["usuario_fechareg"]);
      $usuario_activo = utf8_encode($valor["usuario_activo"]);
      $usuario_documento = utf8_encode($valor["usuario_documento"]);
      $t_perfil_id = utf8_encode($valor["perfil_id"]);    
      $usuario_fechanac = utf8_encode($valor["usuario_fechanac"]);    
      $usuario_fechareg = utf8_encode($valor["usuario_fechareg"]);
      $l_tipousuarioserv_id = utf8_encode($valor["l_tipousuarioserv_id"]);

      $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
      $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
      $usuario_img = utf8_encode($valor["usuario_img"]);
      $compania_nombre = utf8_encode($valor["compania_nombre"]);

      $usuario = $usuario_nombre." ".$usuario_apellido." ";

      $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
      $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
      $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
      $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
        
      
      $Asunto = "Retiro: $estatus_nombre - $compania_nombre";
      $mensaje = "
      Buenas $usuario, se informa fue cambiado el estatus de su retiro realizado a la plataforma.
      <br>
      <br>    
      Monto de Retiro: $usuariobalanceretiro_monto      
      <br>
      Forma de Solicitud de Retiro: $usuariobalanceretiro_fechareg
      <br>
      Estatus: $estatus_nombre
      <br>
      Cliente: $usuario
      <br><br><br>
      ";
      $texto = "
        
              <table border='0' width='100%' cellpadding='0' cellspacing='0' bgcolor='ffffff' class='bg_color'>

                  <tr>
                      <td align='center'>
                          <table border='0' align='center' width='590' cellpadding='0' cellspacing='0' class='container590'>
                              
                              <tr>
                                  <td align='left' style='color: #343434; font-size: 16px; font-family: Calibri, sans-serif; font-weight:normal;letter-spacing: 2px; line-height: 35px;' class='main-header'>
                                      <div style='line-height: 35px'>

                                          $mensaje

                                      </div>
                                  </td>
                              </tr>

                              <tr>
                                  <td height='10' style='font-size: 10px; line-height: 10px;'>&nbsp;</td>
                              </tr>

                              <tr>
                                  <td align='center'>
                                      <table border='0' width='40' align='center' cellpadding='0' cellspacing='0' bgcolor='eeeeee'>
                                          <tr>
                                              <td height='2' style='font-size: 2px; line-height: 2px;'>&nbsp;</td>
                                          </tr>
                                      </table>
                                  </td>
                              </tr>
                          </table>
                      </td>
                  </tr>         
              </table>              
          ";

      $libemail = new LibEmail();          


      if ($usuario_email!=""){$resultado = $libemail->enviarcorreo($usuario_email, $Asunto, $texto, $compania_id);}
      if ($companiacuenta_email!=""){$resultado = $libemail->enviarcorreo($companiacuenta_email, $Asunto, $texto, $compania_id);}

      $notif_visible = 1;
      $tiponotificacion = 103; // 103 = Email  104 = Sistema     

      $instancianotificacion = new Notificacion();
      $resultadonotificacion = $instancianotificacion->InsertarNotificacion("976", "retiro", $usuariobalanceretiro_id, $Asunto, $mensaje, $usuario_id, $usuario_id, $cuenta_id, $compania_id, $usuario_email, $usuario_telf, $notif_visible, $tiponotificacion);



  }
}

function ProcesarPagoPlanSolicitudPaquete($pago_id=null){

  $instancialista = new Lista();

  $fechaactual = formatoFechaHoraBd(1); 
  $fechaactualreg = formatoFechaHoraBd();     

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("pago.pago_id,   
    pago.usuario_id,
    pago.cuenta_id, pago.compania_id, pago.pago_procesado,
    pago.l_moneda_id, pago_monto, usuariobalance_id, 
    usuariobalance_total, usuariobalance_disponible, usuariobalance_cantidad, usuariobalance_sucursales,
    pagoplan.l_plan_id, listaplan_diasduracion,
    listaplan_contactos, listaplan_habiltarminutos, usuario_idreferido, listaplan_sucursales,
    tipopagoplan.lista_cod as tipopagoplan_cod,
    plan.lista_id, plan.lista_nombre as plan_nombre, plan.lista_descrip as plan_descrip,
    listacategoria.l_categ_id, listacategoria.l_subcateg_id, listacategoria.l_idioma_id,
    listacategoria.usuario_id as usuario_idprestador,
    listacategoria.listacateg_fecha

    ",
    "pago     
    inner join usuario on usuario.usuario_id = pago.usuario_id        
    left join pagoplan on pagoplan.pago_id = pago.pago_id
    left join lista plan on plan.lista_id = pagoplan.l_plan_id            
    left join listaplan on listaplan.l_plan_id = plan.lista_id
    left join usuariobalance on usuariobalance.usuario_id = usuario.usuario_id
    left join lista tipopagoplan on tipopagoplan.lista_id = pagoplan.l_tipoplan_id

    left join listacategoria on listacategoria.l_subcategdos_id = plan.lista_id 
    and listacategoria.listacateg_activo = '1'

    ",
    "pago.pago_eliminado = '0' and pago.pago_id = '$pago_id'");

    if (count($arrresultado)>0){

      foreach($arrresultado as $i=>$valor){       

        $listacateg_fecha = utf8_encode($valor["listacateg_fecha"]);
        $usuario_idprestador = utf8_encode($valor["usuario_idprestador"]);
        $l_plan_id = utf8_encode($valor["lista_id"]);
        $usuario_id = utf8_encode($valor["usuario_id"]);
        $plan_nombre = utf8_encode($valor["plan_nombre"]);
        $plan_descrip = utf8_encode($valor["plan_descrip"]);
        $cuenta_id = utf8_encode($valor["cuenta_id"]);
        $compania_id = utf8_encode($valor["compania_id"]);
        $categ_id = utf8_encode($valor["l_categ_id"]);
        $subcateg_id = utf8_encode($valor["l_subcateg_id"]);
        $l_idioma_id = utf8_encode($valor["l_idioma_id"]);

      }




      $iniuser = $usuario_id;
      $titulo = $plan_nombre;
      $descripcion = $plan_descrip;
      $infolatitud = 0;
      $infolongitud = 0;
      $ubicacion = $plan_nombre;
      $infocalle = "";
      $infocodpostal= "";
      $infociudad= "";
      $infociudad2= "";
      $infosublocalidad= "";
      $inforegion= "";
      $infocountry= "";
      $SistemaCuentaId = $cuenta_id;
      $SistemaCompaniaId = $compania_id;
      $idioma = $l_idioma_id;


      $arrresultado = $conexion->doSelect("max(solicitudserv_codigoint) as solicitudserv_codigoint","solicitudservicio",
        "cuenta_id = '$SistemaCuentaId' and compania_id='$SistemaCompaniaId'");
      foreach($arrresultado as $i=>$valor){
        $solicitudserv_codigoint = utf8_encode($valor["solicitudserv_codigoint"]);
      }

      if ($solicitudserv_codigoint==""){$solicitudserv_codigoint = 0;}
      $solicitudserv_codigoint = $solicitudserv_codigoint + 1;


      //Creo Solicitud
      $obtenerCodigoLista = 5;
      $obtenerTipoLista = 43;
      $estatusid = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

      $obtenerCodigoLista = 2;
      $obtenerTipoLista = 171;
      $tiposolicitud = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

      $fechafinrecibir = date('Y-m-d H:i:s', strtotime("$fechaactual + 1 day"));


      $resultado = $conexion->doInsert("
        solicitudservicio
        (
          usuario_id, solicitudserv_titulo, solicitudserv_descrip, solicitudserv_latitud, 
          solicitudserv_longitud, solicitudserv_dircompleta, solicitudserv_infodir, solicitudserv_infocalle, 
          solicitudserv_infocodpostal, solicitudserv_infociudad, solicitudserv_infociudad2, 
          solicitudserv_infosublocalidad, solicitudserv_inforegion, solicitudserv_infocountry, 
          cuenta_id, compania_id, solicitudserv_activo, solicitudserv_eliminado, solicitudserv_fechareg, usuario_idreg, 
          solicitudserv_codigo, solicitudserv_codigoint, l_estatus_id,
          l_categ_id, l_subcateg_id, solicitudserv_leidos, solicitudserv_contactados, solicitudserv_notif, 
          solicitudserv_fechafinrecibir, l_idioma_id, l_tiposolicitud_id, l_paquete_id, solicitudserv_fecha,
          solicitudserv_notificados
        )
        ",
        " 
        '$iniuser', '$titulo', '$descripcion', '$infolatitud',
        '$infolongitud', '$ubicacion', '$ubicacion', '$infocalle',
        '$infocodpostal', '$infociudad', '$infociudad2', 
        '$infosublocalidad', '$inforegion', '$infocountry', 
        '$SistemaCuentaId', '$SistemaCompaniaId', '1', '0', '$fechaactualreg','$iniuser',
        '$solicitudserv_codigoint', '$solicitudserv_codigoint', '$estatusid',
        '$categ_id', '$subcateg_id','0','0', '0',
        '$fechafinrecibir','$idioma','$tiposolicitud','$l_plan_id','$listacateg_fecha',
        '1'
        ");
      
      $arrresultado2 = $conexion->doSelect("max(solicitudserv_id) as solicitudserv_id","solicitudservicio");
      if (count($arrresultado2)>0){
        foreach($arrresultado2 as $i=>$valor){
          $solicitudserv_id = strtoupper($valor["solicitudserv_id"]);
        }


        $obtenerCodigoLista = 4;
        $obtenerTipoLista = 45;
        $estatuscontratado = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);
        
        // creo la solicitudservicioprestador        
        $resultado = $conexion->doInsert("
          solicitudservicioprestador
          (solicitudserv_id, usuario_id, l_estatus_id, solicitudservpresta_fechareg, 
          cuenta_id, compania_id, solicitudservpresta_activo, solicitudservpresta_eliminado, usuario_idreg, solicitudservpresta_leido)
        ",
        " 
          '$solicitudserv_id', '$usuario_idprestador', '$estatuscontratado', '$fechaactual', 
          '$cuenta_id', '$compania_id','1','0', '$iniuser', '0'
        "); 



      }

      NotificarCambioEstatusPago($pago_id);      

    }

}


function ObtenerListaUsuariosServicios($cuentaseleccionada=null, $companiaseleccionada=null, $tipo=null, $getusuario_id =null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and usuarioperfil.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and usuarioperfil.cuenta_id = '$_COOKIE[idcuenta]' and usuarioperfil.compania_id = '$_COOKIE[idcompania]' ";

  } 

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("usuarioperfil.usuario_id, usuarioperfil.usuario_codigo, usuarioperfil.usuario_email, usuarioperfil.usuario_clave, 
      usuarioperfil.usuario_nombre, usuarioperfil.usuario_apellido, usuarioperfil.usuario_telf,  usuarioperfil.usuario_activo, 
      usuarioperfil.usuario_eliminado, usuarioperfil.usuario_documento, usuarioperfil.usuario_img, usuarioperfil.perfil_id,
      usuarioperfil.usuario_direccion, usuarioperfil.usuario_localidad, usuarioperfil.usuario_actividad, usuarioperfil.nacionalidad_id,
      usuarioperfil.sexo_id, usuarioperfil.e_estadocivil_id, usuarioperfil.usuario_conyugenombre, usuarioperfil.usuario_conyugetelf,
      usuarioperfil.usuario_pariente, usuarioperfil.usuario_parientetelf, usuarioperfil.e_parentesco_id, usuarioperfil.usuario_telfdos, 
      usuarioperfil.usuario_notas, usuarioperfil.usuario_porcentajecolocador, usuarioperfil.usuario_balance, usuarioperfil.usuario_comentarios, 
      DATE_FORMAT(usuarioperfil.usuario_fechanac,'%d/%m/%Y') as usuario_fechanac, usuarioperfil.nivelriesgo_id,
      usuarioperfil.l_tipodocumento_id,
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre, compania_urlweb,
      DATE_FORMAT(usuarioperfil.usuario_fechareg,'%d/%m/%Y %H:%i:%s') as usuario_fechareg,
      perfil_nombre, 
      tipousuarioservicio.lista_nombre as tipousuarioservicio_nombre,
      usuarioperfil.l_estatus_id, estatus.lista_nombre as estatus_nombre

      ",
    "usuario usuarioperfil
        inner join usuario cuenta on usuarioperfil.cuenta_id = cuenta.usuario_id
        inner join compania on compania.compania_id = usuarioperfil.compania_id
        inner join perfil on usuarioperfil.perfil_id = perfil.perfil_id
        inner join lista tipousuarioservicio on tipousuarioservicio.lista_id = usuarioperfil.l_tipousuarioserv_id
        left join lista estatus on estatus.lista_id = usuarioperfil.l_estatus_id
    ",
    "usuarioperfil.usuario_eliminado = '0' and usuarioperfil.perfil_id = '4' and tipousuarioservicio.lista_cod in ($tipo) $where ", null, "usuarioperfil.usuario_id desc");

  $optionusuario .="<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

    $usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    if ($getusuario_id==$usuario_id){
      $optionusuario .="<option value='$usuario_id' selected='selected'>$usuario</option>";
    }else{
      $optionusuario .="<option value='$usuario_id'>$usuario</option>";  
    }

    

  }

  return $optionusuario;

}


function NotificarCambioEstatusPago($pago_id=null){

  $conexion = new ConexionBd(); 
  $arrresultado = $conexion->doSelect("     
    pago.pago_id, pago.pago_monto, pago.pago_referencia, 
    pago.pago_banco, pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, 
    pago.usuario_idreg, pago.pago_activo, pago.pago_eliminado, 
    pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id, pago.l_moneda_id, 
    pago.l_estatus_id, pago.pago_procesado, pago.pago_archoriginal,

    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,
    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,

    formapago.lista_nombre as formapago_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, usuario.usuario_email,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania.compania_nombre, compania.compania_email,

    estatus.lista_nombre as estatus_nombre,
    estatus.lista_cod as estatus_cod,  

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas,

    tipoarchivo.lista_nombre as tipoarchivo_nombre, 
    companiacuenta.compania_email as companiacuenta_email

      ",
      "pago
        inner join lista formapago on formapago.lista_id = pago.l_formapago_id
        inner join usuario on usuario.usuario_id = pago.usuario_id

        inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
        inner join compania companiacuenta on companiacuenta.compania_id = cuenta.compania_id
        inner join compania on compania.compania_id = pago.compania_id

        inner join lista estatus on estatus.lista_id = pago.l_estatus_id
        left join lista moneda on moneda.lista_id = pago.l_moneda_id

        left join lista tipoarchivo on tipoarchivo.lista_id = pago.l_tipoarchivo_id
        
      ",
      "pago.pago_activo = '1' and pago.pago_id = '$pago_id'");
  foreach($arrresultado as $i=>$valor){

      $companiacuenta_email = utf8_encode($valor["companiacuenta_email"]);
      $compania_email = utf8_encode($valor["compania_email"]);
      $usuario_email = utf8_encode($valor["usuario_email"]);

      $pago_id = utf8_encode($valor["pago_id"]);
      $pago_monto = utf8_encode($valor["pago_monto"]);
      $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
      $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
      
      $pago_monto  = number_format_personalizado($pago_monto, $moneda_siglas);      

      $pago_fecha = utf8_encode($valor["pago_fecha"]);
      $pago_referencia = utf8_encode($valor["pago_referencia"]);
      $pago_banco = utf8_encode($valor["pago_banco"]);
      $pago_comentario = utf8_encode($valor["pago_comentario"]);
      $pago_img = utf8_encode($valor["pago_img"]);
      $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
      $usuario_id = utf8_encode($valor["usuario_id"]);
      $pago_activo = utf8_encode($valor["pago_activo"]);
      $cuenta_id = utf8_encode($valor["cuenta_id"]);
      $compania_id = utf8_encode($valor["compania_id"]);
      $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);
      $l_moneda_id = utf8_encode($valor["l_moneda_id"]);
      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $pago_procesado = utf8_encode($valor["pago_procesado"]);
      $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
      $pago_archoriginal = utf8_encode($valor["pago_archoriginal"]);

      $formapago_nombre = utf8_encode($valor["formapago_nombre"]);

      $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
      $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
      $usuario_img = utf8_encode($valor["usuario_img"]);

      $usuario = $usuario_nombre." ".$usuario_apellido;

      $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
      $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
      $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
      $compania_nombre = utf8_encode($valor["compania_nombre"]);

      $cuenta = $cuenta_nombre." ".$cuenta_apellido;

      $estatus_cod = utf8_encode($valor["estatus_cod"]);
      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
      
      $tipoarchivo_nombre = utf8_encode($valor["tipoarchivo_nombre"]);      

      $urlarchivo = "arch/$pago_img";
      

      
      $Asunto = "Pago: $estatus_nombre - $compania_nombre";
      $mensaje = "
      Buenas $usuario, se informa fue cambiado el estatus de su pago realizado a la plataforma.
      <br>
      <br>    
      Monto de Pago: $pago_monto      
      <br>
      Forma de Pago: $formapago_nombre
      <br>
      Estatus: $estatus_nombre
      <br>
      Fecha: $pago_fecha
      <br><br><br>
      ";
      $texto = "
        
              <table border='0' width='100%' cellpadding='0' cellspacing='0' bgcolor='ffffff' class='bg_color'>

                  <tr>
                      <td align='center'>
                          <table border='0' align='center' width='590' cellpadding='0' cellspacing='0' class='container590'>
                              
                              <tr>
                                  <td align='left' style='color: #343434; font-size: 16px; font-family: Calibri, sans-serif; font-weight:normal;letter-spacing: 2px; line-height: 35px;' class='main-header'>
                                      <div style='line-height: 35px'>

                                          $mensaje

                                      </div>
                                  </td>
                              </tr>

                              <tr>
                                  <td height='10' style='font-size: 10px; line-height: 10px;'>&nbsp;</td>
                              </tr>

                              <tr>
                                  <td align='center'>
                                      <table border='0' width='40' align='center' cellpadding='0' cellspacing='0' bgcolor='eeeeee'>
                                          <tr>
                                              <td height='2' style='font-size: 2px; line-height: 2px;'>&nbsp;</td>
                                          </tr>
                                      </table>
                                  </td>
                              </tr>
                          </table>
                      </td>
                  </tr>         
              </table>              
          ";

      $libemail = new LibEmail();          


      if ($usuario_email!=""){$resultado = $libemail->enviarcorreo($usuario_email, $Asunto, $texto, $compania_id);}
      if ($companiacuenta_email!=""){$resultado = $libemail->enviarcorreo($companiacuenta_email, $Asunto, $texto, $compania_id);}

      $notif_visible = 1;
      $tiponotificacion = 103; // 103 = Email  104 = Sistema     

      $instancianotificacion = new Notificacion();
      $resultadonotificacion = $instancianotificacion->InsertarNotificacion("936", "pago", $pago_id, $Asunto, $mensaje, $usuario_id, $usuario_id, $cuenta_id, $compania_id, $usuario_email, $usuario_telf, $notif_visible, $tiponotificacion);



  }
}

function CambiarEstatusPlanPago($pago_id=null, $estatus=null){

  $conexion = new ConexionBd();  

  $fechaactual = formatoFechaHoraBd(1); 
  $fechaactualreg = formatoFechaHoraBd();     

  $arrresultado = $conexion->doSelect("pago.pago_id,   
       pago.usuario_id,
      pago.cuenta_id, pago.compania_id, pago.pago_procesado,
      pago.l_moneda_id, pago_monto, usuariobalance_id, 
      usuariobalance_total, usuariobalance_disponible, usuariobalance_cantidad, usuariobalance_sucursales,
      pagoplan.l_plan_id, listaplan_diasduracion,
      listaplan_contactos, listaplan_habiltarminutos, usuario_idreferido, listaplan_sucursales,
      tipopagoplan.lista_cod as tipopagoplan_cod      
     
      ",
    "pago     
      inner join usuario on usuario.usuario_id = pago.usuario_id        
      left join pagoplan on pagoplan.pago_id = pago.pago_id
      left join lista plan on plan.lista_id = pagoplan.l_plan_id            
      left join listaplan on listaplan.l_plan_id = plan.lista_id
      left join usuariobalance on usuariobalance.usuario_id = usuario.usuario_id
      left join lista tipopagoplan on tipopagoplan.lista_id = pagoplan.l_tipoplan_id
    ",
    "pago.pago_eliminado = '0' and pago.pago_id = '$pago_id'");

    if (count($arrresultado)>0){
        
      foreach($arrresultado as $i=>$valor){       

        $cuenta_id = utf8_encode($valor["cuenta_id"]);
        $l_plan_id = utf8_encode($valor["l_plan_id"]);
        $tipopagoplan_cod = utf8_encode($valor["tipopagoplan_cod"]);        
        $listaplan_diasduracion = utf8_encode($valor["listaplan_diasduracion"]);
        $listaplan_contactos = utf8_encode($valor["listaplan_contactos"]);
        $listaplan_habiltarminutos = utf8_encode($valor["listaplan_habiltarminutos"]);
        $listaplan_sucursales = utf8_encode($valor["listaplan_sucursales"]);

        if ($listaplan_diasduracion==""){
          $listaplan_diasduracion=0;
        }

        if ($listaplan_contactos==""){
          $listaplan_contactos=0;
        }

        if ($listaplan_habiltarminutos==""){
          $listaplan_habiltarminutos=0;
        }

        $usuariobalance_id = utf8_encode($valor["usuariobalance_id"]);
        $usuariobalance_total = utf8_encode($valor["usuariobalance_total"]);
        $usuariobalance_disponible = utf8_encode($valor["usuariobalance_disponible"]);
        $usuariobalance_cantidad = utf8_encode($valor["usuariobalance_cantidad"]);
        $usuariobalance_sucursales = utf8_encode($valor["usuariobalance_sucursales"]);

        if ($usuariobalance_sucursales==""){
          $usuariobalance_sucursales=0;
        }


        $pago_monto = utf8_encode($valor["pago_monto"]);
        $pago_id = utf8_encode($valor["pago_id"]);
        $trans_id = utf8_encode($valor["trans_id"]);
        $pago_procesado = utf8_encode($valor["pago_procesado"]);          
        $usuario_id = utf8_encode($valor["usuario_id"]);
        $cuenta_id = utf8_encode($valor["cuenta_id"]);
        $compania_id = utf8_encode($valor["compania_id"]);
        $usuario_idreferido = utf8_encode($valor["usuario_idreferido"]);
        $l_moneda_id = utf8_encode($valor["l_moneda_id"]);


    }   

    if ($cuenta_id=="2104"){ //
      $listaplan_habiltarminutos= 1;
    }

    $instancialista = new Lista();

    $obtenerIdLista = 2;
    $obtenerTipoLista = 55;
    $idestatusaprobado = $instancialista->ObtenerIdLista($obtenerIdLista, $obtenerTipoLista);


    $obtenerIdLista = 1;
    $obtenerTipoLista = 105;
    $idestatusactivo = $instancialista->ObtenerIdLista($obtenerIdLista, $obtenerTipoLista);

    //$pago_procesado = 0;

    if ($pago_procesado!="1" && $estatus==$idestatusaprobado){       

        $resultado = $conexion->doUpdate("pago", "         
        pago_procesado = '1'
        ", "pago_id='$pago_id'"); 

        $texresp ="Cambiado el Estatus Correctamente";   

        if ($tipopagoplan_cod=="1"){// Si es un Paquete de Solicitud de Servicio

          ProcesarPagoPlanSolicitudPaquete($pago_id);

        }else{


          $resultado = $conexion->doUpdate("usuarioplan", "          
          usuarioplan_activo = '0',
          usuarioplan_eliminado = '1'
          ", "usuario_id='$usuario_id'"); 

          $fechafin = date('Y-m-d', strtotime("$fechaactual + $listaplan_diasduracion day"));

          $resultado = $conexion->doInsert("
          usuarioplan
            (usuario_id, plan_id, estatus_id, usuarioplan_fechaini, usuarioplan_fechafin, 
            usuarioplan_activo, usuarioplan_eliminado, usuarioplan_fechareg, cuenta_id, compania_id)
          ",
          "'$usuario_id', '$l_plan_id', '$idestatusactivo', '$fechaactual', '$fechafin',        
          '1', '0','$fechaactualreg', '$cuenta_id','$compania_id'");


          $usuariobalance_cantidadtotal = $usuariobalance_cantidad + $listaplan_habiltarminutos;
          $usuariobalance_sucursales = $usuariobalance_sucursales + $listaplan_sucursales; 

          if ($usuariobalance_id==""){

            $resultado = $conexion->doInsert("
            usuariobalance
            (usuario_id, usuariobalance_total, usuariobalance_bloqueado, 
            usuariobalance_disponible, usuariobalance_pendiente, usuariobalance_fechareg, 
            usuariobalance_activo, usuariobalance_eliminado, cuenta_id, compania_id, l_moneda_id,usuariobalance_cantidad, usuariobalance_sucursales)
          ",
          "'$usuario_id', '0', '0', 
          '0', '0', '$fechaactualreg',
          '1', '0','$cuenta_id','$compania_id', '$l_moneda_id','$usuariobalance_cantidadtotal','$usuariobalance_sucursales'");

          }else{

             $resultado = $conexion->doUpdate("usuariobalance", "          
              usuariobalance_cantidad = '$usuariobalance_cantidadtotal',
              usuariobalance_sucursales = '$usuariobalance_sucursales'                    
            ", "usuario_id='$usuario_id' and usuariobalance_activo = '1'"); 

          }
          

          if($usuario_idreferido!="0" && $usuario_idreferido!=""){



              $arrresultado = $conexion->doSelect("usuarioporcentaje.usuarioporcentaje_id,   
               usuarioporcentaje.usuarioporcentaje_valor, usuarioporcentaje.usuario_id      
              ",
              "usuarioporcentaje         
              ",
            "usuarioporcentaje.usuarioporcentaje_activo = '1' and usuario_id='$usuario_idreferido'");
              foreach($arrresultado as $i=>$valor){ 
                $usuarioporcentaje_valor = utf8_encode($valor["usuarioporcentaje_valor"]);
              }

              $porcentajeventa = ($usuarioporcentaje_valor * 100) / $pago_monto;

              if ($cuenta_id=="2104"){ 

                $instancialista = new Lista();

                $obtenerIdLista = 2;
                $obtenerTipoLista = 19;
                $idestatusabonadas = $instancialista->ObtenerIdLista($obtenerIdLista, $obtenerTipoLista);

                 $resultado = $conexion->doInsert("
                  usuarioganancia
                    (usuario_id, usuarioganancia_monto, l_moneda_id, l_estatus_id, usuarioganancia_activo,
                    usuarioganancia_eliminado, cuenta_id, compania_id, elemento_id, modulo_id, usuarioganancia_fechareg)
                ",
                "'$usuario_idreferido', '$porcentajeventa', '$l_moneda_id', '$idestatusabonadas', '1',
                '0', '$cuenta_id', '$compania_id','$pago_id','0','$fechaactualreg'");




                $arrresultado = $conexion->doSelect("usuariobalance_disponible, usuariobalance_id",
                  "usuariobalance",
                  "usuariobalance_activo = '1' and usuariobalance.usuario_id = '$usuario_idreferido'");

                if (count($arrresultado)>0){                    
                  foreach($arrresultado as $i=>$valor){       
                    $usuariobalance_disponible = utf8_encode($valor["usuariobalance_disponible"]);                    
                    $usuariobalance_id = utf8_encode($valor["usuariobalance_id"]);                    
                  }

                  if ($usuariobalance_disponible==""){$usuariobalance_disponible=0;}

                  $usuariobalance_disponible = $usuariobalance_disponible + $porcentajeventa;

                  $resultado = $conexion->doUpdate("usuariobalance", "          
                    usuariobalance_disponible = '$usuariobalance_disponible'
                  ", "usuariobalance_id='$usuariobalance_id'"); 



                }else{
                  $resultado = $conexion->doInsert("
                  usuariobalance
                    (usuario_id, usuariobalance_total, usuariobalance_bloqueado, 
                    usuariobalance_disponible, usuariobalance_pendiente, usuariobalance_fechareg, 
                    usuariobalance_activo, usuariobalance_eliminado, cuenta_id, compania_id, 
                    l_moneda_id,usuariobalance_cantidad, usuariobalance_sucursales)
                ",
                "'$usuario_idreferido', '0', '0', 
                '$porcentajeventa', '0', '$fechaactualreg',
                '1', '0','$cuenta_id','$compania_id', 
                '$l_moneda_id','0','0'");

                }


              }


              /*

              $resultado = $conexion->doUpdate("gananciausuario", "          
              gananciausuario_montototal = '$porcentajeventa'                    
              ", "usuario_id='$usuario_idreferido' and compania_id = '$compania_id' and gananciausuario_activo = '1'"); 

              */

          }


          if ($cuenta_id=="2104"){ //

              $resultado = $conexion->doInsert("
                usuariobalanceplan
                  (usuario_id, l_plan_id, usuariobalanceplan_estatus, usuariobalanceplan_fechareg, 
                  usuariobalanceplan_activo, usuariobalanceplan_eliminado) 
              ",
              "'$usuario_id', '$l_plan_id', '0', '$fechaactualreg',
              '1', '0'");
              
          }


        }

    }else{
      $texresp ="Cambiado el Estatus Correctamente";
    }


    $resultado = $conexion->doUpdate("pago", "
      l_estatus_id = '$estatus'     
      ", "pago_id='$pago_id'");


    //NotificarCambioEstatusPago($pago_id);

  }
  else{
    $texresp ="Error: El pago no pudo ser actualizado. por favor informe al administrador del sistema";
  }

  return $texresp;


}


function NotificacionRequisitoArchivo($requisito_id=null){

  $libemail = new LibEmail();

  $SistemaCuentaId = SistemaCuentaId;
  $SistemaCompaniaId = SistemaCompaniaId;

  $conexion = new ConexionBd();  

  $arrresultado = $conexion->doSelect("
    requisito.requisito_id, requisito.l_requisitolista_id, requisito_descrip, requisito_arch, 
    requisito_archnombre, requisito_cantarchivos, requisito.cuenta_id, requisito.compania_id,
    requisito_activo, requisito_eliminado,  
    requisito.usuario_idreg, requisito.l_estatus_id, requisito.usuario_id,
    usuario.usuario_id, usuario.usuario_codigo, usuario.usuario_email, usuario.usuario_nombre, usuario.usuario_apellido, 
    usuario.usuario_telf, usuario.usuario_activo, usuario.usuario_eliminado, 
    usuario.usuario_documento, usuario.usuario_img, usuario.perfil_id, 

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre, compania_email,
    listarequisito.lista_id as requisitolista_id,
    listarequisito.lista_nombre as requisitolista_nombre,
    estatus.lista_nombre as estatus_nombre,
    tipoarchivo.lista_nombre as tipoarchivo_nombre,
    tipoarchivo.lista_img as tipoarchivo_img,
    
    compania_urlweb,
    DATE_FORMAT(requisito_fechareg,'%d/%m/%Y %H:%i:%s') as requisito_fechareg

    ",
    "lista listarequisito
        inner join requisito on requisito.l_requisitolista_id = listarequisito.lista_id        
        left join lista tipoarchivo on tipoarchivo.lista_id = requisito.l_tipoarchivo_id
        left join lista estatus on estatus.lista_id = requisito.l_estatus_id
        left join usuario on usuario.usuario_id = requisito.usuario_id
        left join usuario cuenta on cuenta.usuario_id = usuario.cuenta_id
        left join compania on compania.compania_id = usuario.compania_id

    ",
    "listarequisito.lista_activo = '1' and requisito_activo = '1' and listarequisito.tipolista_id  ='49' and requisito.requisito_id = '$requisito_id'", null, "listarequisito.lista_orden asc");


  foreach($arrresultado as $i=>$valor){

      $requisito_id = utf8_encode($valor["requisito_id"]);
      $l_requisitolista_id = utf8_encode($valor["l_requisitolista_id"]);
      $requisito_descrip = utf8_encode($valor["requisito_descrip"]);
      $requisito_arch = utf8_encode($valor["requisito_arch"]);
      $requisito_archnombre = utf8_encode($valor["requisito_archnombre"]);
      $requisito_cantarchivos = utf8_encode($valor["requisito_cantarchivos"]);
      $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
      $compania_id = utf8_encode($valor["compania_id"]);
      $requisito_activo = utf8_encode($valor["requisito_activo"]);
      $requisito_fechareg = utf8_encode($valor["requisito_fechareg"]);
      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $usuario_id = utf8_encode($valor["usuario_id"]);
      $usuario_codigo = utf8_encode($valor["usuario_codigo"]);
      $usuario_email = utf8_encode($valor["usuario_email"]);
      
      $requisitolista_id = utf8_encode($valor["requisitolista_id"]);
      $requisitolista_nombre = utf8_encode($valor["requisitolista_nombre"]);
      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
      $tipoarchivo_nombre = utf8_encode($valor["tipoarchivo_nombre"]);
      $tipoarchivo_img = utf8_encode($valor["tipoarchivo_img"]);

      $compania_nombre = utf8_encode($valor["compania_nombre"]);
      $compania_email = utf8_encode($valor["compania_email"]);

      $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

      $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
      $usuario_apellido = utf8_encode($valor["usuario_apellido"]);

      $usuario = $usuario_nombre." ".$usuario_apellido;

      $resul_titulonotificacion = "Requisito: $requisitolista_nombre - Estatus: $estatus_nombre - $usuario";

      $link = $compania_urlweb."iniciar-sesion?r=1";

      $mensaje = "
        Buenas <strong>".$usuario.",</strong> le informamos que cambio el estatus a: ".$estatus_nombre." del requisito cargado. Igualmente puede ingresar a la plataforma para observar el estatus de la misma.
        <br><br>
        <br><strong>Cliente:</strong> ".$usuario."
        <br><strong>Requisito:</strong> ".$requisitolista_nombre."
        <br><strong>Estatus:</strong> ".$estatus_nombre."
        <br><strong>Fecha de Carga:</strong> ".$requisito_fechareg."         
         
        ";


        $texto = "
    
          <table border='0' width='100%' cellpadding='0' cellspacing='0' bgcolor='ffffff' class='bg_color'>

              <tr>
                  <td align='center'>
                      <table border='0' align='center' width='590' cellpadding='0' cellspacing='0' class='container590'>
                          
                          <tr>
                              <td align='left' style='color: #343434; font-size: 16px; font-family: Calibri, sans-serif; font-weight:normal;letter-spacing: 2px; line-height: 35px;' class='main-header'>
                                  <div style='line-height: 35px'>

                                      $mensaje

                                  </div>
                              </td>
                          </tr>

                          <tr>
                              <td height='10' style='font-size: 10px; line-height: 10px;'>&nbsp;</td>
                          </tr>

                          <tr>
                              <td align='center'>
                                  <table border='0' width='40' align='center' cellpadding='0' cellspacing='0' bgcolor='eeeeee'>
                                      <tr>
                                          <td height='2' style='font-size: 2px; line-height: 2px;'>&nbsp;</td>
                                      </tr>
                                  </table>
                              </td>
                          </tr>

                          

                          <tr>
                              <td height='25' style='font-size: 25px; line-height: 25px;'>&nbsp;</td>
                          </tr>

                          <tr>
                              <td align='center'>
                                  <table border='0' align='center' width='160' cellpadding='0' cellspacing='0' bgcolor='0EB521' style=''>

                                      <tr>
                                          <td height='10' style='font-size: 10px; line-height: 10px;'>&nbsp;</td>
                                      </tr>

                                      <tr>
                                          <td align='center' style='color: #ffffff; font-size: 14px; font-family: Calibri, sans-serif; line-height: 26px;'>


                                              <div style='line-height: 26px;'>
                                                  <a href='$link' style='color: #ffffff; text-decoration: none;'>Ingresar</a>
                                              </div>
                                          </td>
                                      </tr>

                                      <tr>
                                          <td height='10' style='font-size: 10px; line-height: 10px;'>&nbsp;</td>
                                      </tr>

                                  </table>
                              </td>
                          </tr>
                          <tr>
                              <td height='20' style='font-size: 20px; line-height: 20px;'>&nbsp;</td>
                          </tr>

                          <tr>
                              <td align='center'>
                                  <table border='0' width='500' align='center' cellpadding='0' cellspacing='0' class='container590'>
                                      <tr>
                                          <td align='center' style='color: #444444; font-size: 16px; font-family: Calibri, sans-serif; line-height: 24px;'>


                                              <div style='line-height: 24px'>                                                  
                                                  <br><br> Puede copiar y pegar el siguiente enlace<br>
                                                  <a href='$link'>
                                                      $link
                                                  </a>
                                                  <br><br>
                                              </div>
                                          </td>
                                      </tr>
                                  </table>
                              </td>
                          </tr>


                      </table>

                  </td>
              </tr>         
          </table>
          
              </td>
          </tr>

      </table>
      <!-- end section -->

      
      ";

      $notif_visible = 1;
      $tiponotificacion = 103; // 103 = Email  104 = Sistema      

      if ($tiponotificacion=="103"){ // Email, enviar de una vez

        if ($compania_email=="info@sistemasgo.com"){
          $compania_email = "info@sistemasgo.com";
        }           
        
        $resultadoEmail = $libemail->enviarcorreo($usuario_email, $resul_titulonotificacion, $texto, $compania_id);
        //$resultado = $libemail->enviarcorreo($compania_email, $resul_titulonotificacion, $texto, $compania_id);
      }
      

      $resul_descripcionnotificacion = utf8_decode($texto);

      $resul_descripcionnotificacion = addslashes($resul_descripcionnotificacion);

      $instancianotificacion = new Notificacion();
      $resultadonotificacion = $instancianotificacion->InsertarNotificacion("182", "requisito", $requisito_id, $resul_titulonotificacion, $resul_descripcionnotificacion, $usuariocliente_id, $iniuser, $t_cuenta_id, $t_compania_id, $usuario_email, $usuario_telf, $notif_visible, $tiponotificacion);

          
  }



  return true;


}

function ObtenerListaTarifa($cuentaseleccionada=null, $companiaseleccionada=null, $tarifa_idseleccionado=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($companiaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

      
     $arrresultado = $conexion->doSelect("tarifa_id, tarifa_nombre",
        "tarifa",
        "tarifa_activo = '1' and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada' ", null, "tarifa_nombre asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

          $tarifa_id  = utf8_encode($valor["tarifa_id"]);
          $tarifa_nombre = utf8_encode($valor["tarifa_nombre"]);
          
          if($tarifa_id == $tarifa_idseleccionado){
            $option .= "<option selected='selected' value='$tarifa_id'>$tarifa_nombre</option>";
          }else{
            $option .= "<option value='$tarifa_id'>$tarifa_nombre</option>";
           }

      }

       if (count($arrresultado)==0){
         $option = "<option  value=''>NO EXISTEN TARIFAS</option>";
       }

  }
  
  return $option;

}

function VerificarCajaAbierta($cuentaseleccionada=null, $companiaseleccionada=null, $formadepago=null, $sucursal_id=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($sucursal_id!=""){
    $wheresucursal = " and caja.sucursal_id = '$sucursal_id' ";
  }
  

  $obtenerIdLista = $formadepago;
  $obtenerTipoLista = 136;
  $codformapago = ObtenerIdCodigo($obtenerIdLista, $obtenerTipoLista);
  
  $arrresultado = $GLOBALS[conexion]->doSelect("caja_id",
    "caja   
      left join lista estatus on estatus.lista_id = caja.l_estatus_id     
    ",
    "caja_activo = '1' and estatus.lista_cod = '1' and caja.compania_id = '$companiaseleccionada' $wheresucursal ");
  foreach($arrresultado as $i=>$valor){
    $existecajaabierta = 1;
    $caja_id = utf8_encode($valor["caja_id"]);
  } 

  if ($codformapago=="1" && $existecajaabierta!=1){      
    return 0;
  }

  if ($caja_id==""){$caja_id=0;}


  
  return $caja_id;

}


function ObtenerUsuarioServicioReservar($cuentaseleccionada=null, $companiaseleccionada=null, $prod_id=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

      
     $arrresultado = $conexion->doSelect("usuario.usuario_id, usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, productousuario.produsuario_id",
        "usuario
          inner join productousuario on productousuario.usuario_id  = usuario.usuario_id 
          and produsuario_activo = '1' and prod_id = '$prod_id'
        ",
        "usuario_activo = '1' and usuario.perfil_id  = '7' and usuario.cuenta_id = '$cuentaseleccionada' and usuario.compania_id = '$companiaseleccionada'", null, "usuario_nombre, usuario_apellido asc");

      $option .= "
            <div class='form-group col-md-4' style='margin-bottom: 0px'>
              <div style='text-align: center;'>
                <a style='cursor: pointer;' onclick='agregarproductoreserva(\"".$prod_id."\",0)' title='Agregar?'>
                  <img src='arch/1.png' style='height: 100px; width: 100px; border-radius: 20px'>
                  <h4 style='font-size: 16px'>
                    Sin Preferencia
                  </h4>
                </a>
              </div>                          
            </div>   
          ";

      foreach($arrresultado as $i=>$valor){

          $usuario_id  = utf8_encode($valor["usuario_id"]);
          $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
          $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
          $usuario_img = utf8_encode($valor["usuario_img"]);

          $usuario = $usuario_nombre." ".$usuario_apellido;

          $produsuario_id  = utf8_encode($valor["produsuario_id"]);

          $option .= "
            <div class='form-group col-md-4' style='margin-bottom: 0px'>
              <div style='text-align: center;'>
                <a style='cursor: pointer;' onclick='agregarproductoreserva(\"".$prod_id."\",\"".$usuario_id."\")' title='Agregar?'>
                  <img src='arch/$usuario_img' style='height: 100px; width: 100px; border-radius: 20px'>
                  <h4 style='font-size: 16px'>
                    $usuario
                  </h4>
                </a>
              </div>                          
            </div>   
          ";

      }

  }
  
  return $option;

}

function ObtenerUsuarioServicio($cuentaseleccionada=null, $companiaseleccionada=null, $prod_id=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

      
     $arrresultado = $conexion->doSelect("usuario.usuario_id, usuario.usuario_nombre, usuario.usuario_apellido, productousuario.produsuario_id",
        "usuario
          left join productousuario on productousuario.usuario_id  = usuario.usuario_id 
          and produsuario_activo = '1' and prod_id = '$prod_id'
        ",
        "usuario_activo = '1' and usuario.perfil_id  = '7' and usuario.cuenta_id = '$_COOKIE[idcuenta]' and usuario.compania_id = '$_COOKIE[idcompania]'", null, "usuario_nombre, usuario_apellido asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

          $usuario_id  = utf8_encode($valor["usuario_id"]);
          $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
          $usuario_apellido = utf8_encode($valor["usuario_apellido"]);

          $usuario = $usuario_nombre." ".$usuario_apellido;

          $produsuario_id  = utf8_encode($valor["produsuario_id"]);


        if($produsuario_id != ""){
          $option .= "<option selected='selected' value='$usuario_id'>$usuario</option>";
        }else{
           $option .= "<option value='$usuario_id'>$usuario</option>";
        }

      }

       if (count($arrresultado)==0){
         $option = "<option  value=''>NO EXISTEN EMPLEADOS</option>";
       }

  }
  
  return $option;

}
    
function ListadoSolicitudServiciosPrestador($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null, $getsolicitudservicio=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (solicitudserv_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
    $titulo = "Ventas del Día";
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (solicitudserv_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (solicitudserv_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (solicitudserv_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($estatusseleccionado!=""){
    $whereestatus =" and solicitudservicio.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($getsolicitudservicio!=""){
    $wheresolicitud =" and solicitudservicio.solicitudserv_id = '$getsolicitudservicio' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
  
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and solicitudservicio.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and solicitudservicio.cuenta_id = '$_COOKIE[idcuenta]' and solicitudservicio.compania_id = '$_COOKIE[idcompania]'  ";

  } 

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("
    solicitudservicio.solicitudserv_id, solicitudservicio.usuario_id, solicitudservicio.solicitudserv_titulo, 
    solicitudservicio.solicitudserv_descrip, solicitudservicio.solicitudserv_latitud, solicitudservicio.solicitudserv_longitud,
    solicitudservicio.solicitudserv_dircompleta, solicitudservicio.solicitudserv_infodir, solicitudservicio.solicitudserv_infocalle,
    solicitudservicio.solicitudserv_infocodpostal, solicitudservicio.solicitudserv_infociudad, 
    solicitudservicio.solicitudserv_infociudad2, solicitudservicio.solicitudserv_infosublocalidad, 
    solicitudservicio.solicitudserv_inforegion, solicitudservicio.solicitudserv_infocountry, 
    solicitudservicio.cuenta_id, solicitudservicio.compania_id, solicitudservicio.solicitudserv_activo,
    solicitudservicio.solicitudserv_eliminado,
    solicitudservicio.usuario_idreg, 
    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre, 

    solicitudserv_codigo, solicitudserv_codigoint, solicitudservicio.l_estatus_id, 
    
    solicitudservicio.l_categ_id, solicitudservicio.l_subcateg_id,
    categoria.lista_nombre as categ_nombre, categoria.lista_img as categ_img,
    subcategoria.lista_nombre as subcateg_nombre, subcategoria.lista_img as subcateg_img,
    DATE_FORMAT(solicitudservicio.solicitudserv_fechareg,'%d/%m/%Y %H:%i:%s') as solicitudserv_fechareg, 
    solicitudserv_leidos, solicitudserv_notificados,

    solicitudservicioprestador.solicitudservpresta_id,  
    solicitudservicioprestador.usuario_id, solicitudservicioprestador.l_estatus_id, 
    DATE_FORMAT(solicitudservicioprestador.solicitudservpresta_utlfecha,'%d/%m/%Y %H:%i:%s') as solicitudservpresta_utlfecha, 

    solicitudservicioprestador.cuenta_id, 
    solicitudservicioprestador.compania_id, solicitudservicioprestador.solicitudservpresta_activo, 
    solicitudservicioprestador.solicitudservpresta_eliminado, solicitudservicioprestador.usuario_idreg,
    
    estatusservicioprestador.lista_cod as estatusservicioprestador_cod,
    estatusservicioprestador.lista_nombre as estatusservicioprestador_nombre,

    usuarioprestador.usuario_id as usuarioprestador_id,
    usuarioprestador.usuario_nombre as usuarioprestador_nombre, usuarioprestador.usuario_apellido as usuarioprestador_apellido, 
    usuarioprestador.usuario_img as usuarioprestador_img

    ",
    "solicitudservicio
      inner join lista categoria on categoria.lista_id = solicitudservicio.l_categ_id
      inner join lista subcategoria on subcategoria.lista_id = solicitudservicio.l_subcateg_id

      inner join usuario on usuario.usuario_id = solicitudservicio.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = solicitudservicio.cuenta_id
      inner join compania on compania.compania_id = solicitudservicio.compania_id
      

      inner join solicitudservicioprestador on solicitudservicioprestador.solicitudserv_id = solicitudservicio.solicitudserv_id
              and solicitudservpresta_activo = '1'

      inner join lista estatusservicioprestador on estatusservicioprestador.lista_id = solicitudservicioprestador.l_estatus_id      
      inner join usuario usuarioprestador on usuarioprestador.usuario_id = solicitudservicioprestador.usuario_id

    ",
    "solicitudserv_eliminado = '0' $where $whereestatus $wherefecha $wheresolicitud", null, "solicitudservicio.solicitudserv_id desc"); 

  foreach($arrresultado as $i=>$valor){

    $usuarioprestador_id = utf8_encode($valor["usuarioprestador_id"]);
    $usuarioprestador_nombre = utf8_encode($valor["usuarioprestador_nombre"]);
    $usuarioprestador_apellido = utf8_encode($valor["usuarioprestador_apellido"]);
    $usuarioprestador_img = utf8_encode($valor["usuarioprestador_img"]);  

    $usuarioprestador = $usuarioprestador_nombre." ".$usuarioprestador_apellido." ";

    $solicitudservpresta_id = utf8_encode($valor["solicitudservpresta_id"]);
    $s_l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $solicitudservpresta_fechareg = utf8_encode($valor["solicitudservpresta_fechareg"]);

    $estatusservicioprestador_cod = utf8_encode($valor["estatusservicioprestador_cod"]);
    $estatusservicioprestador_nombre = utf8_encode($valor["estatusservicioprestador_nombre"]);
    $solicitudservpresta_utlfecha = utf8_encode($valor["solicitudservpresta_utlfecha"]);


    $categ_nombre = utf8_encode($valor["categ_nombre"]);
    $categ_img = utf8_encode($valor["categ_img"]);
    $subcateg_nombre = utf8_encode($valor["subcateg_nombre"]);
    $subcateg_img = utf8_encode($valor["subcateg_img"]);

    $solicitudserv_codigo = utf8_encode($valor["solicitudserv_codigo"]);
    $solicitudserv_leidos = utf8_encode($valor["solicitudserv_leidos"]);
    $solicitudserv_notificados = utf8_encode($valor["solicitudserv_notificados"]);
    $solicitudserv_codigoint = utf8_encode($valor["solicitudserv_codigoint"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    $solicitudserv_id = utf8_encode($valor["solicitudserv_id"]);
    $t_usuario_id = utf8_encode($valor["usuario_id"]);
    $solicitudserv_titulo = utf8_encode($valor["solicitudserv_titulo"]);
    $solicitudserv_descrip = utf8_encode($valor["solicitudserv_descrip"]);
    $solicitudserv_latitud = utf8_encode($valor["solicitudserv_latitud"]);
    $solicitudserv_longitud = utf8_encode($valor["solicitudserv_longitud"]);
    $solicitudserv_dircompleta = utf8_encode($valor["solicitudserv_dircompleta"]);
    $solicitudserv_infodir = utf8_encode($valor["solicitudserv_infodir"]);
    $solicitudserv_infocalle = utf8_encode($valor["solicitudserv_infocalle"]);
    $solicitudserv_infocodpostal = utf8_encode($valor["solicitudserv_infocodpostal"]);
    $solicitudserv_infociudad = utf8_encode($valor["solicitudserv_infociudad"]);
    $solicitudserv_infociudad2 = utf8_encode($valor["solicitudserv_infociudad2"]);
    $solicitudserv_infosublocalidad = utf8_encode($valor["solicitudserv_infosublocalidad"]);
    $solicitudserv_inforegion = utf8_encode($valor["solicitudserv_inforegion"]);
    $solicitudserv_infocountry = utf8_encode($valor["solicitudserv_infocountry"]);
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $solicitudserv_activo = utf8_encode($valor["solicitudserv_activo"]);
    $solicitudserv_fechareg = utf8_encode($valor["solicitudserv_fechareg"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";


    $titulo = "#$solicitudserv_codigo";  

    $solicitudserv_titulo = "<a href='versolicitudservicio?id=$solicitudserv_id' style='color: #0B787A'>$solicitudserv_titulo (Ver)</a>";

    $idsolicitud = "<a href='versolicitudservicio?id=$solicitudserv_id'>$titulo (Ver)</a>";


    if ($solicitudserv_leidos>0){
      $solicitudserv_leidos = "<a href='panelusuario-solicitudes-recibidas?id=$solicitudserv_id' style='color: #0B787A'>$solicitudserv_leidos (Ver)</a>";    
    }else{
      $solicitudserv_leidos = "0";
    }
    /*
    if ($solicitudserv_notificados>0){
      $solicitudserv_notificados = "<a href='panelusuario-solicitudes-recibidas?id=$solicitudserv_id' style='color: #0B787A'>$solicitudserv_notificados (Ver)</a>";    
    }else{
      $solicitudserv_notificados = "0";
    }*/



    if ($solicitudserv_activo=="0"){
      $activo = "<i onclick='cambiarestatussolicitudservicio(\"".$solicitudserv_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatussolicitudservicio(\"".$solicitudserv_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarsolicitudservicio(\"".$solicitudserv_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
    $modificar_old = "<a href='modificarsolicitudservicio?id=$solicitudserv_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $chatsolicitud = "<a href='mensajes?id=$solicitudservpresta_id'><i title='Mensajes' class='fa fa-envelope btn-mensajes'></i></a>";

    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    

    $solicitudservpresta_id = "<a href='versolicitudservicio?id=$solicitudserv_id' style='color: #0B787A'>#$solicitudservpresta_id (Ver)</a>";

    $enviarsolicitud = "<a href='versolicitudservicio?id=$solicitudserv_id&s=1' target='_blank' title='Enviar Solicitud'><i class='fa fa-paper-plane'></i></a>";

    $solicitudservicioprestador = "
      <a href='solicitudservicioprestador?id=$solicitudserv_id' title='Ver Notificados'>
        ($solicitudserv_notificados)<br>
        Notificados
      </a>";

    $btnjitsi = "";

    if ($lista_cod=="5" ){ // Contratado

      if ($l_paquete_id!=""){
        $urljitsi = "https://meet.jit.si/xxippo_paquete_$l_paquete_id";  
      }else{
        $urljitsi = "https://meet.jit.si/xxippo_$solicitudserv_id";  
      }

      $btnjitsi = "&nbsp
        <a href='$urljitsi' target='_blank' style='color: #000' title='Abrir Link'>
         <i class='fa fa-video-camera'></i> 
        </a>      
        <br>
      ";

    }

    $textohtml .= "
         <tr>               
          $mostrarcolumnacuenta
          $mostrarcolumnacompania
          <td>$solicitudservpresta_id</td>
          <td>$usuarioprestador</td>
          <td>$estatusservicioprestador_nombre </td>
          <td>$solicitudservpresta_utlfecha</td>                  
          <td style='text-align: center'>$btnjitsi &nbsp $chatsolicitud &nbsp  $activo &nbsp $accioneliminar</td>
            </tr>
      ";

  }

  return $textohtml;

}


function ObtenerSucursalServicio($cuentaseleccionada=null, $companiaseleccionada=null, $prod_id=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

      
     $arrresultado = $conexion->doSelect("sucursal.sucursal_id, sucursal.sucursal_nombre, productosucursal.prodsucursal_id",
        "sucursal
          left join productosucursal on productosucursal.sucursal_id  = sucursal.sucursal_id 
          and prodsucursal_activo = '1' and prod_id = '$prod_id'
        ",
        "sucursal_activo = '1' and sucursal.cuenta_id = '$_COOKIE[idcuenta]' and sucursal.compania_id = '$_COOKIE[idcompania]'", null, "sucursal_nombre asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

          $sucursal_id  = utf8_encode($valor["sucursal_id"]);
          $sucursal_nombre = utf8_encode($valor["sucursal_nombre"]);
          $prodsucursal_id  = utf8_encode($valor["prodsucursal_id"]);


        if($prodsucursal_id != ""){
              $option .= "<option selected='selected' value='$sucursal_id'>$sucursal_nombre</option>";
        }else{
               $option .= "<option value='$sucursal_id'>$sucursal_nombre</option>";
             }

      }

       if (count($arrresultado)==0){
         $option = "<option  value=''>NO EXISTEN SUCURSALES DISPONIBLES</option>";
       }

  }
  
  return $option;

}

function ListadoRetiros($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $retiroidget=null, $sinfiltrofecha=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (usuariobalanceretiro.usuariobalanceretiro_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (usuariobalanceretiro.usuariobalanceretiro_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (usuariobalanceretiro.usuariobalanceretiro_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (usuariobalanceretiro.usuariobalanceretiro_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($sinfiltrofecha=="1"){
    $wherefecha = "";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and usuariobalanceretiro.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and usuariobalanceretiro.cuenta_id = '$_COOKIE[idcuenta]' and usuariobalanceretiro.compania_id = '$_COOKIE[idcompania]' ";

  } else { 

    $where = " and usuariobalanceretiro.cuenta_id = '$_COOKIE[idcuenta]' and usuariobalanceretiro.compania_id = '$_COOKIE[idcompania]' and usuariobalanceretiro.usuario_id = '$_COOKIE[iniuser]' ";

  } 


  if($retiroidget!=""){
    $whereretiro = " and usuariobalanceretiro.usuariobalanceretiro_id = '$retiroidget' ";
    $wherefecha = "";
  }

  if($getestatus!=""){
    $whereestatus = " and usuariobalanceretiro.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    



  $arrresultado = $conexion->doSelect("usuario.usuario_id, usuario.usuario_codigo, usuario.usuario_email, 
    usuario.usuario_clave, usuario.usuario_nombre, usuario.usuario_apellido, 
    usuario.usuario_telf, usuario.usuario_activo, usuario.usuario_eliminado, 
    usuario.usuario_documento, usuario.usuario_img, usuario.perfil_id,     
    DATE_FORMAT(usuario.usuario_fechanac,'%d/%m/%Y') as usuario_fechanac, usuario.nivelriesgo_id,
    DATE_FORMAT(usuario.usuario_fechareg,'%d/%m/%Y') as usuario_fechareg, usuario.usuario_alias, usuario.l_tipousuarioserv_id,
    
    usuariobalance_cantidad, usuariobalance_disponible, usuariobalance_bloqueado, 
    moneda.lista_nombredos as moneda_siglas,

    usuariobalanceretiro.usuariobalanceretiro_id, usuariobalanceretiro.usuario_id, 
    usuariobalanceretiro.usuarioretiro_id, usuariobalanceretiro.usuariobalanceretiro_monto,     
    usuariobalanceretiro.l_estatus_id, usuariobalanceretiro.usuariobalanceretiro_activo, 
    usuariobalanceretiro.usuariobalanceretiro_eliminado, usuariobalanceretiro.usuariobalanceretiro_observ, 
    usuariobalanceretiro.usuariobalanceretiro_procesado, usuariobalanceretiro.cuenta_id, 
    usuariobalanceretiro.compania_id, usuariobalanceretiro.usuariobalanceretiro_cod, 
    usuariobalanceretiro.l_moneda_id,
    formapago.lista_nombre as formapago_nombre,
    estatus.lista_nombre as estatus_nombre,
    DATE_FORMAT(usuariobalanceretiro_fechareg,'%d/%m/%Y %H:%i:%s') as usuariobalanceretiro_fechareg,
    
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    usuarioretiro.usuarioretiro_id, usuarioretiro.usuarioretiro_descripcion, 
    usuarioretiro.usuarioretiro_email, 
    usuarioretiro.usuarioretiro_activo, usuarioretiro.usuarioretiro_eliminado, 
    usuarioretiro.usuario_id, usuarioretiro.l_formapago_id, 
    usuarioretiro.usuarioretiro_banco, usuarioretiro.usuarioretiro_titular, 
    usuarioretiro.usuarioretiro_tipocuenta, usuarioretiro.usuarioretiro_documento, 
    usuarioretiro.usuarioretiro_nrocuenta, 

    usuariobalance_id
    ",
    "usuario
        inner join usuariobalanceretiro on usuariobalanceretiro.usuario_id = usuario.usuario_id and usuariobalanceretiro_eliminado = '0'
        inner join usuarioretiro on usuarioretiro.usuarioretiro_id = usuariobalanceretiro.usuarioretiro_id and usuarioretiro_activo = '1'
        inner join lista formapago on formapago.lista_id = usuarioretiro.l_formapago_id
        inner join lista estatus on estatus.lista_id = usuariobalanceretiro.l_estatus_id
        inner join usuariobalance on usuariobalance.usuario_id = usuario.usuario_id        
        inner join lista moneda on moneda.lista_id = usuariobalance.l_moneda_id
        inner join usuario cuenta on cuenta.usuario_id = usuario.cuenta_id
        inner join compania on compania.compania_id = usuario.compania_id
    ",
    "usuario.usuario_activo = '1' $where $whereestatus $whereretiro ", null, "usuariobalanceretiro_id desc");

 if ($retiroidget!=""){    
    return $arrresultado;
  }

foreach($arrresultado as $i=>$valor){

    $usuario_id = utf8_encode($valor["usuario_id"]);
    $usuarioretiro_id = utf8_encode($valor["usuarioretiro_id"]);
    $usuarioretiro_descripcion = utf8_encode($valor["usuarioretiro_descripcion"]);
    $usuarioretiro_email = utf8_encode($valor["usuarioretiro_email"]);
    $usuarioretiro_fechareg = utf8_encode($valor["usuarioretiro_fechareg"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $usuarioretiro_banco = utf8_encode($valor["usuarioretiro_banco"]);
    $usuarioretiro_titular = utf8_encode($valor["usuarioretiro_titular"]);
    $usuarioretiro_tipocuenta = utf8_encode($valor["usuarioretiro_tipocuenta"]);
    $usuarioretiro_documento = utf8_encode($valor["usuarioretiro_documento"]);
    $usuarioretiro_nrocuenta = utf8_encode($valor["usuarioretiro_nrocuenta"]);    

    $usuariobalanceretiro_id = utf8_encode($valor["usuariobalanceretiro_id"]);
    $usuario_id = utf8_encode($valor["usuario_id"]);
    $usuarioretiro_id = utf8_encode($valor["usuarioretiro_id"]);
    $usuariobalanceretiro_monto = utf8_encode($valor["usuariobalanceretiro_monto"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $usuariobalanceretiro_fechareg = utf8_encode($valor["usuariobalanceretiro_fechareg"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $usuariobalanceretiro_activo = utf8_encode($valor["usuariobalanceretiro_activo"]);
    $usuariobalanceretiro_observ = utf8_encode($valor["usuariobalanceretiro_observ"]);
    $usuariobalanceretiro_procesado = utf8_encode($valor["usuariobalanceretiro_procesado"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $usuariobalanceretiro_cod = utf8_encode($valor["usuariobalanceretiro_cod"]);
    $l_moneda_id = utf8_encode($valor["l_moneda_id"]);

    $formapago_nombre = utf8_encode($valor["formapago_nombre"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
   

    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
    $usuariobalance_cantidad = utf8_encode($valor["usuariobalance_cantidad"]);
    $usuariobalance_disponible = utf8_encode($valor["usuariobalance_disponible"]);

    if ($usuariobalance_cantidad==""){$usuariobalance_cantidad=0;}
    if ($usuariobalance_disponible==""){$usuariobalance_disponible=0;}

    $usuariobalanceretiro_monto  = number_format_personalizado($usuariobalanceretiro_monto, $moneda_siglas);

    $l_plan_id = utf8_encode($valor["l_plan_id"]);
    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $plan_img = utf8_encode($valor["plan_img"]);
    $usuarioplan_fechaini = utf8_encode($valor["usuarioplan_fechaini"]);
    $usuarioplan_fechafin = utf8_encode($valor["usuarioplan_fechafin"]);

    $usuario_alias = utf8_encode($valor["usuario_alias"]);

    $usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_codigo = utf8_encode($valor["usuario_codigo"]);
    $usuario_email = utf8_encode($valor["usuario_email"]);
    $usuario_clave = utf8_encode($valor["usuario_clave"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_telf = utf8_encode($valor["usuario_telf"]);
    $usuario_fechareg = utf8_encode($valor["usuario_fechareg"]);
    $usuario_activo = utf8_encode($valor["usuario_activo"]);
    $usuario_documento = utf8_encode($valor["usuario_documento"]);
    $t_perfil_id = utf8_encode($valor["perfil_id"]);    
    $usuario_fechanac = utf8_encode($valor["usuario_fechanac"]);    
    $usuario_fechareg = utf8_encode($valor["usuario_fechareg"]);
    $l_tipousuarioserv_id = utf8_encode($valor["l_tipousuarioserv_id"]);

    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";


    if ($usuariobalanceretiro_activo=="0"){
      $activo = "<i onclick='cambiarestatusretiro(\"".$usuariobalanceretiro_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusretiro(\"".$usuariobalanceretiro_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarretiro(\"".$usuariobalanceretiro_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verretiro?id=$usuariobalanceretiro_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verretiro?id=$usuariobalanceretiro_id'>#$usuariobalanceretiro_id (Ver Retiro)</a>";

    $textohtml .= "
          <tr>               
            <td>$usuariobalanceretiro_id</td>   
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td style='text-align: center'>$verid</td>    
            <td>$usuario</td>            
            <td>$usuariobalanceretiro_monto</td>     
            <td>$formapago_nombre</td>     
            
            <td>$estatus_nombre</td>               
            <td>$usuariobalanceretiro_fechareg</td>                     
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}

function ListadoPagoUsuarioPlanGeneral($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]'  and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,    

    plan.lista_nombre as plan_nombre, estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb,
    formapago.lista_nombre as formapago_nombre

    ",
    "pago
      inner join pagoplan on pagoplan.pago_id = pago.pago_id
      left join lista moneda on moneda.lista_id = pago.l_moneda_id
      inner join lista plan on plan.lista_id = pagoplan.l_plan_id
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id
      inner join lista formapago on formapago.lista_id = pago.l_formapago_id

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 



  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $formapago_nombre = utf8_encode($valor["formapago_nombre"]);
    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);
    $pagoplanmultinivel_id = utf8_encode($valor["pagoplanmultinivel_id"]);  
    $l_plan_id = utf8_encode($valor["l_plan_id"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $pagoplanmultinivel_fechareg = utf8_encode($valor["pagoplanmultinivel_fechareg"]);
    $pagoplanmultinivel_observacion = utf8_encode($valor["pagoplanmultinivel_observacion"]);

    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    

    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $moneda_siglas); 

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verpagoplan?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verpagoplan?id=$pago_id'>#$pago_id (Ver)</a>";


    $textohtml .= "
          <tr>               
            <td>$pago_id</td> 
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>            
            <td>$usuario $aa $bb</td>     
            <td>$plan_nombre</td>               
            <td>$pago_monto</td>   
            <td>$formapago_nombre</td>         
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}

function ObtenerListaPlanes($cuentaseleccionada=null, $companiaseleccionada=null, $usuario_idget =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  $_COOKIE[idcompaniarel] = $_COOKIE[idcompaniarel];

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and listaplan.cuenta_id = '$_COOKIE[idcuenta]' ";          


  }  else { 

    if ($_COOKIE[idcompaniarel]!=""){
      $idcompaniacolocar =$_COOKIE[idcompaniarel];
    }else{
      $idcompaniacolocar =$_COOKIE[idcompania];
    }

    $where = " and listaplan.cuenta_id = '$_COOKIE[idcuenta]' and listaplan.compania_id = '$idcompaniacolocar' ";  
        
    $wherelistaactivo = " and plan.lista_activo = '1' ";

  } 

  if ($companiaseleccionada!=""){
    $where = " and listaplan.cuenta_id = '$cuentaseleccionada' and listaplan.compania_id = '$companiaseleccionada' ";  
  }


  $arrresultado = $conexion->doSelect("

    listaplan.listaplan_id, listaplan.l_plan_id, 
    listaplan.l_moneda_id, listaplan.listaplan_precio, 
    listaplan.listaplan_porccomision, listaplan.listaplan_contactos, 
    listaplan.listaplan_diasduracion, 
    listaplan.listaplan_habiltarminutos, listaplan.listaplan_notifwhatsapp, 
    listaplan.cuenta_id, listaplan.compania_id, 
    listaplan.listaplan_fechareg, listaplan.usuario_idreg, 
    listaplan.listaplan_url,

    plan.lista_id as plan_id, plan.lista_nombre as plan_nombre, plan.lista_img as plan_img,
    plan.lista_orden as plan_orden, plan.lista_activo as plan_activo,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    listaplandet_id, listaplandet_descrip, listaplandet_orden, listaplandet_activo,

    moneda.lista_nombredos as moneda_siglas

      ",
    "
    listaplan
        inner join lista plan on plan.lista_id = listaplan.l_plan_id          
        inner join usuario cuenta on cuenta.usuario_id = listaplan.cuenta_id
        inner join compania on compania.compania_id = listaplan.compania_id  
        left join lista moneda on moneda.lista_id = listaplan.l_moneda_id       
        left join listaplandetalle on listaplandetalle.l_plan_id = plan.lista_id 
        and listaplandet_activo = '1'
    ",
    " plan.lista_activo = '1' $where  $wherelistaactivo", null, "plan.lista_orden, plan.lista_id, listaplandetalle.listaplandet_orden  asc");

  $cont = 0;
  foreach($arrresultado as $i=>$valor){

    $plan_id = utf8_encode($valor["plan_id"]);

    if ($plan_id_old!=$plan_id && $cont!="0"){   

      $planeshtml .= "
        <div class='col-lg-4 col-md-6' style='margin-bottom: 15px;'>
            <div class='package-content bg-light border text-center p-2 my-2 my-lg-0 packagediv' >
                <div class='package-content-heading border-bottom'>
                    <a href='pagoformapago?id=$plan_id_old&cu=$t_cuenta_id&co=$t_compania_id&m=939'>
                      <center>
                          <img src='$urlimgPlan' class='img-responsive' style='height:140px' />
                      </center>
                      <h2 style='padding-top: 10px; padding-bottom: 4px'>$plan_nombre</h2>
                      $divprecio
                      $divminutos
                    </a>
                </div>
                <ul style='padding-left: 0px; list-style:none'>
                    $plandetallehtml
                </ul>
                <a href='pagoformapago?id=$plan_id_old&cu=$t_cuenta_id&co=$t_compania_id&m=939' class='btn btn-primary' style='margin-top: 5px'>Adquirir</a>
                
            </div>
        </div>
       
      ";

       $plandetallehtml ="";

    }

    $listaplan_id = utf8_encode($valor["listaplan_id"]);
    $l_plan_id = utf8_encode($valor["l_plan_id"]);
    $listaplan_precio = utf8_encode($valor["listaplan_precio"]);
    $listaplan_porccomision = utf8_encode($valor["listaplan_porccomision"]);
    $listaplan_contactos = utf8_encode($valor["listaplan_contactos"]);
    $listaplan_diasduracion = utf8_encode($valor["listaplan_diasduracion"]);
    $listaplan_habiltarminutos = utf8_encode($valor["listaplan_habiltarminutos"]);
    $listaplan_notifwhatsapp = utf8_encode($valor["listaplan_notifwhatsapp"]);
    $listaplan_url = utf8_encode($valor["listaplan_url"]);
    $listaplan_id = utf8_encode($valor["listaplan_id"]);

    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);    

    $listaplandet_id = utf8_encode($valor["listaplandet_id"]);
    $listaplandet_descrip = utf8_encode($valor["listaplandet_descrip"]);
    $listaplandet_orden = utf8_encode($valor["listaplandet_orden"]);
    $listaplandet_activo = utf8_encode($valor["listaplandet_activo"]);
    
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);        
    
    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $plan_img = utf8_encode($valor["plan_img"]);  
    $plan_orden = utf8_encode($valor["plan_orden"]);  
    $plan_activo = utf8_encode($valor["plan_activo"]);  

    $urlimgPlan = "arch/$plan_img";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $divminutos = "";
    $textominutos = "Minutos";

    if ($_COOKIE[idcuenta]=="1924"){
      $textominutos = "Puntos";
    }
    if ($_COOKIE[idcuenta]=="2096"){
      $textominutos = "Tickets";
    }
    if ($_COOKIE[idcuenta]=="2104"){
      $textominutos = "Vehiculos Asignados";
    }

    if ($listaplan_habiltarminutos>0){
      $divminutos = "
        <h4 class='py-0' style='font-size: 20px; line-height: 30px'> 
          <span style='font-size: 20px; font-weight: bold'>$listaplan_habiltarminutos $textominutos</span> <br>
        </h4>
      ";  
    }

    

    $listaplan_precioorig = $listaplan_precio;

    if ($listaplan_precio==""){$listaplan_precio=0;}

    $listaplan_precio = number_format_personalizado($listaplan_precio,$moneda_siglas);
    
    if ($listaplan_precioorig=="0" || $listaplan_precioorig==""){
      $divprecio = "
        <h4 class='py-0' style='font-size: 20px; line-height: 30px'>         
          
        </h4>
      ";
      $divcontratar = "
        
      ";
    }else{
      $divprecio = "
        <h4 class='py-0' style='font-size: 20px; line-height: 30px'> 
          <span style='font-size: 20px'>$listaplan_precio $moneda_siglas /$listaplan_diasduracion días</span> <br>
        </h4>
      ";

      $divcontratar = "
        <a href='plan-forma-pago?id=$plan_id' class='btn btn-success' style='margin-top: 5px'>Contratar</a>
      ";
    }

    $plandetallehtml .= "
          <li class='my-4' style='font-size: 16px'> $listaplandet_descrip</li>
      ";

    $plan_id_old = $plan_id;

    $cont = $cont +1;

  }


  if ($plandetallehtml!=""){
    $planeshtml .= "
        <div class='col-lg-4 col-md-6' style='margin-bottom: 15px;'>
            <div class='package-content bg-light border text-center p-2 my-2 my-lg-0 packagediv'>
                <div class='package-content-heading border-bottom'>
                    <a href='pagoformapago?id=$plan_id&cu=$t_cuenta_id&co=$t_compania_id&m=939'>
                      <center>
                          <img src='$urlimgPlan' class='img-responsive' style='height:140px' />
                      </center>
                      <h2 style='padding-top: 10px; padding-bottom: 4px'>$plan_nombre</h2>
                      $divprecio
                      $divminutos
                    </a>
                </div>
                <ul style='padding-left: 0px; list-style:none'>
                    $plandetallehtml
                </ul>
                <a href='pagoformapago?id=$plan_id&cu=$t_cuenta_id&co=$t_compania_id&m=939' class='btn btn-primary' style='margin-top: 5px'>Adquirir</a>
                
            </div>
        </div>
      ";
  }

  if ($planeshtml!=""){

    $titulo = "Seleccione el plan que desea ";

    if ($_COOKIE[idcuenta]=="2104"){
      $titulo = "Seleccione el plan que desea para poder anunciar en nuestras unidades";
    }

    $planeshtml = "

    <div class='col-md-12'>
        <h4 class='titulotop'  style='font-size: 24px'> $titulo</h3> 
        <hr> 
    </div>    

    $planeshtml
    ";
  }

  return $planeshtml;

}

function ListadoCorreosMasivos($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $getdate=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (correomasivo.correomasivo_fechaprog BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (correomasivo.correomasivo_fechaprog BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (correomasivo.correomasivo_fechaprog > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (correomasivo.correomasivo_fechaprog BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and correomasivo.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and correomasivo.cuenta_id = '$_COOKIE[idcuenta]' and correomasivo.compania_id = '$_COOKIE[idcompania]' ";

  } 


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("
    correomasivo_nombre,
    correomasivo.correomasivo_id, correomasivo.correomasivocampana_id,    
    correomasivo.correomasivo_activo, correomasivo.correomasivo_eliminado, 
    correomasivo.l_estatus_id,  correomasivo_cantidad,
    correomasivo.cuenta_id, correomasivo.compania_id, correomasivo.usuario_idreg,
    DATE_FORMAT(correomasivo_fechaenvio,'%d/%m/%Y %H:%i') as correomasivo_fechaenvio, 
    DATE_FORMAT(correomasivo_fechaprog,'%d/%m/%Y %H:%i') as correomasivo_fechaprog, 
    DATE_FORMAT(correomasivo_fechareg,'%d/%m/%Y %H:%i:%s') as correomasivo_fechareg, 
    correomasivocampana_nombre,   
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
    estatus.lista_nombre as estatus_nombre, estatus.lista_cod as estatus_cod,
    correomasivocampana.correomasivocampana_titulo,
    correomasivocampana.correomasivocampana_descripcorta,
    tiponotificacion.lista_nombre as tiponotificacion_nombre,
    tiponotificacionenvio.lista_nombre as tiponotificacionenvio_nombre

    ",
    "correomasivo           
        inner join usuario cuenta on cuenta.usuario_id = correomasivo.cuenta_id
        inner join compania on compania.compania_id = correomasivo.compania_id            
        inner join lista estatus on estatus.lista_id = correomasivo.l_estatus_id
        inner join correomasivocampana on correomasivocampana.correomasivocampana_id = correomasivo.correomasivocampana_id 
        inner join lista tiponotificacion on tiponotificacion.lista_id = correomasivo.l_tiponotificaciondestino_id
        inner join lista tiponotificacionenvio on tiponotificacionenvio.lista_id = correomasivo.l_tiponotificacionenvio_id

    ",
    "correomasivo_eliminado = '0' $where $wherefecha ", null, "correomasivo_id desc");
  foreach($arrresultado as $i=>$valor){
    
    $tiponotificacion_nombre = utf8_encode($valor["tiponotificacion_nombre"]);
    $correomasivo_cantidad = utf8_encode($valor["correomasivo_cantidad"]);
    $correomasivocampana_titulo = utf8_encode($valor["correomasivocampana_titulo"]);
    $correomasivocampana_descripcorta = utf8_encode($valor["correomasivocampana_descripcorta"]);

    $l_tiponotificacionenvio_id = utf8_encode($valor["l_tiponotificacionenvio_id"]);
    $tiponotificacionenvio_nombre = utf8_encode($valor["tiponotificacionenvio_nombre"]);
    

    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
    $estatus_cod = utf8_encode($valor["estatus_cod"]);

    $correomasivo_nombre = utf8_encode($valor["correomasivo_nombre"]);
    $correomasivo_id = utf8_encode($valor["correomasivo_id"]);
    $correomasivocampana_id = utf8_encode($valor["correomasivocampana_id"]);
    $correomasivo_activo = utf8_encode($valor["correomasivo_activo"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $correomasivo_fechaenvio = utf8_encode($valor["correomasivo_fechaenvio"]);
    $correomasivo_fechaprog = utf8_encode($valor["correomasivo_fechaprog"]);
    $correomasivo_fechareg = utf8_encode($valor["correomasivo_fechareg"]);
    $correomasivocampana_nombre = utf8_encode($valor["correomasivocampana_nombre"]);    

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);  

    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);

    if ($correomasivo_activo=="0"){
      $activo = "<i onclick='cambiarestatuscorreomasivo\"".$correomasivo_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuscorreomasivo(\"".$correomasivo_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarcorreomasivo(\"".$correomasivo_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='modificarnotificacionmensaje?id=$correomasivo_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";    

    $enviarcorreomasivo = "<a href='notificacionmensajeprocesar?id=$correomasivo_id' target='_blank'><i title='Enviar Notificación' class='fa fa-paper-plane btn-modificar'></i></a>";    

    $grupos = "<a href='notificacionmensajegrupo?id=$correomasivo_id'>$tiponotificacion_nombre (Ver)</a>";  

    if ($estatus_cod=="2"){
      $estatus_nombre = "<a href='notificacionmensajeresultado?id=$correomasivo_id' style='font-weight: 700'>$estatus_nombre<br>($correomasivo_cantidad) Ver Detalles</a>"; 
    }
    
    if (P_Mod!="1"){$modificar = ""; $activo = ""; $enviarcorreomasivo="";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = ""; $enviarcorreomasivo="";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
           <tr>
            <td>$correomasivo_id</td>
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
                          
                <td style='text-align: center'>$correomasivocampana_nombre</td> 
                <td style='text-align: center'>$correomasivocampana_titulo</td>
                <td style='text-align: center'>$tiponotificacionenvio_nombre</td>                  
                <td style='text-align: center'>$grupos</td>                 
                <td style='text-align: center'>$correomasivo_fechaprog</td>                                 
                <td style='text-align: center'>$estatus_nombre</td>                 
                <td style='text-align: center'>$correomasivo_fechareg</td>                  
                <td style='text-align: center'>$enviarcorreomasivo &nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
              </tr>
        ";

  }

  return $textohtml;

}


function ListadoGastos($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $getdate=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (gasto.gasto_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (gasto.gasto_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (gasto.gasto_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (gasto.gasto_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and gasto.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and gasto.cuenta_id = '$_COOKIE[idcuenta]' and gasto.compania_id = '$_COOKIE[idcompania]' ";

  } 


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("

    gasto.gasto_id, gasto.gasto_nombre, gasto.gasto_descrip, gasto.gasto_monto, 
    gasto.gasto_activo, gasto.gasto_eliminado, 
    gasto.estatus_id, gasto.cuenta_id, gasto.compania_id, gasto.usuario_idreg, gasto.l_tipogasto_id,
    DATE_FORMAT(gasto.gasto_fechaini,'%d/%m/%Y') as gasto_fechaini,
    DATE_FORMAT(gasto.gasto_fechafin,'%d/%m/%Y') as gasto_fechafin,
    DATE_FORMAT(gasto.gasto_fechareg,'%d/%m/%Y %H:%i:%s') as gasto_fechareg,
  
    cuenta.usuario_codigo as cuenta_codigo, 
    cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania_nombre, 
        
    tipogasto.lista_nombre as tipogasto_nombre,   
    estatus.lista_nombre as estatus_nombre, 
    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas

    ",
    "gasto
      inner join usuario cuenta on cuenta.usuario_id = gasto.cuenta_id
        inner join compania on compania.compania_id = gasto.compania_id 
        left join lista estatus on estatus.lista_id = gasto.estatus_id
        left join lista tipogasto on tipogasto.lista_id = gasto.l_tipogasto_id
        left join lista moneda on moneda.lista_id = gasto.l_moneda_id
        
    ",
    "gasto_eliminado = '0' $where $wherefecha ", null, "gasto.gasto_id desc");
  foreach($arrresultado as $i=>$valor){
    
    $gasto_id = utf8_encode($valor["gasto_id"]);
    $gasto_nombre = utf8_encode($valor["gasto_nombre"]);
    $gasto_descrip = utf8_encode($valor["gasto_descrip"]);
    $gasto_monto = utf8_encode($valor["gasto_monto"]);
    $gasto_activo = utf8_encode($valor["gasto_activo"]);
    $t_estatus_id = utf8_encode($valor["estatus_id"]);
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $l_tipogasto_id = utf8_encode($valor["l_tipogasto_id"]);
    $tipogasto_nombre = utf8_encode($valor["tipogasto_nombre"]);

    $gasto_fechaini = utf8_encode($valor["gasto_fechaini"]);
    $gasto_fechafin = utf8_encode($valor["gasto_fechafin"]);
    $gasto_fechareg = utf8_encode($valor["gasto_fechareg"]);    

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $gasto_monto = number_format_personalizado($gasto_monto, $moneda_siglas); 

    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);

    if ($gasto_activo=="0"){
      $activo = "<i onclick='cambiarestatusgasto(\"".$gasto_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusgasto(\"".$gasto_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminargasto(\"".$gasto_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    
    $modificar = "<a href='modificargasto?id=$gasto_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){       
      
    }
    else if ($_COOKIE[perfil]=="2"){      
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
          <tr>
            <td>$gasto_id</td>  
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
            <td>$gasto_nombre</td>  
            <td>$gasto_monto</td>                 
            <td>$tipogasto_nombre</td>            
            <td style='text-align: center'>$gasto_fechareg</td>   
            <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}

function RegistrarValorCaja($cuentaseleccionada=null, $companiaseleccionada=null, $tipomovimiento=null, $monto=null, $observacion=null, $idelemento=null, $formadepago=null){

  $conexion = new ConexionBd();  

  $fechaactual = formatoFechaHoraBd(); 

  $arrresultado = $conexion->doSelect("
    caja_id, caja_saldoinicial, caja_saldoentrada, caja_saldosalida, 
    caja_saldoimporteteorico, caja_saldoimportereal, caja_saldodescuadre, 
    caja_activo, caja_eliminado, l_estatus_id,
    estatus.lista_nombre as estatus_nombre,
    DATE_FORMAT(caja_fecha,'%d/%m/%Y') as caja_fecha,     
    DATE_FORMAT(caja_fechaabierto,'%d/%m/%Y %H:%i:%s') as caja_fechaabierto
      ",
    "caja   
      left join lista estatus on estatus.lista_id = caja.l_estatus_id      
    ",
    "caja_activo = '1' and estatus.lista_cod = '1' and caja.cuenta_id = '$cuentaseleccionada' and caja.compania_id = '$companiaseleccionada' ");
  foreach($arrresultado as $i=>$valor){
    $existecajaabierta = 1;
    $caja_id = utf8_encode($valor["caja_id"]);
  } 

  $obtenerIdLista = $formadepago;
  $obtenerTipoLista = 136;
  $codformapago = ObtenerIdCodigo($obtenerIdLista, $obtenerTipoLista);
  
  $existecajaabierta = 1;
  $codformapago = 1;

  if ($existecajaabierta==1 && $codformapago=="1"){ // Solo Efectivo

      $arrresultado = $conexion->doSelect("
        caja_id, caja_saldoinicial, caja_saldoentrada, caja_saldosalida, 
        caja_saldoimporteteorico, caja_saldoimportereal, caja_saldodescuadre, 
        caja_activo, caja_eliminado, l_estatus_id,
        estatus.lista_nombre as estatus_nombre,
        DATE_FORMAT(caja_fecha,'%d/%m/%Y') as caja_fecha,     
        DATE_FORMAT(caja_fechaabierto,'%d/%m/%Y %H:%i:%s') as caja_fechaabierto
          ",
        "caja   
          left join lista estatus on estatus.lista_id = caja.l_estatus_id      
        ",
        "caja_activo = '1' and caja_id = '$caja_id' ");
      foreach($arrresultado as $i=>$valor){

        $caja_id = utf8_encode($valor["caja_id"]);
        $caja_saldoinicial = utf8_encode($valor["caja_saldoinicial"]);
        $caja_saldoentrada = utf8_encode($valor["caja_saldoentrada"]);
        $caja_saldosalida = utf8_encode($valor["caja_saldosalida"]);
        $caja_saldoimporteteorico = utf8_encode($valor["caja_saldoimporteteorico"]);
        $caja_saldoimportereal = utf8_encode($valor["caja_saldoimportereal"]);
        $caja_saldodescuadre = utf8_encode($valor["caja_saldodescuadre"]);
        $caja_activo = utf8_encode($valor["caja_activo"]);
        $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
        $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
        $caja_fecha = utf8_encode($valor["caja_fecha"]);
        $caja_fechaabierto = utf8_encode($valor["caja_fechaabierto"]);
              
      }

      if ($caja_id==""){$caja_id=0;}

      if ($caja_saldoimporteteorico==""){$caja_saldoimporteteorico=0;}
      if ($caja_saldoentrada==""){$caja_saldoentrada=0;}
      if ($caja_saldosalida==""){$caja_saldosalida=0;}

      if ($tipomovimiento=="1"){
        $caja_saldoentrada = $caja_saldoentrada + $monto;
        $caja_saldoimporteteorico = $caja_saldoimporteteorico + $monto;
      }

      if ($tipomovimiento=="2"){
        $caja_saldoentrada = $caja_saldoentrada + $monto;
        $caja_saldoimporteteorico = $caja_saldoimporteteorico + $monto;
      }

      if ($tipomovimiento=="3"){
        $caja_saldosalida = $caja_saldosalida + $monto;
        $caja_saldoimporteteorico = $caja_saldoimporteteorico - $monto;
      }

      $resultado = $conexion->doUpdate("caja", 
        "
        caja_saldoimporteteorico  ='$caja_saldoimporteteorico',
        caja_saldoentrada  ='$caja_saldoentrada',
        caja_saldosalida ='$caja_saldosalida'", 
        "caja_id = '$caja_id'");

      $resultado = $conexion->doInsert("
      cajahistorial
        (caja_id, tipomovimientocaja_id, cajahistorial_saldo, cajahistorial_comentario, 
        cajahistorial_fechareg, cajahistorial_activo, cajahistorial_eliminado, trans_id)
      ",
      "'$caja_id', '$tipomovimiento', '$monto', '$observacion', 
      '$fechaactual', '1', '0','$idelemento'");
    
  }
 
  return true;

}

function ObtenerListaCorreoMasivoCampana($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else { 

      
     $arrresultado = $conexion->doSelect("correomasivocampana_id, correomasivocampana_nombre",
        "correomasivocampana",
        "correomasivocampana_activo = '1' and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada'", null, "correomasivocampana_nombre asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

        $correomasivocampana_id = utf8_encode($valor["correomasivocampana_id"]);
        $correomasivocampana_nombre = utf8_encode($valor["correomasivocampana_nombre"]);        

        if ($idseleccionado==$correomasivocampana_id){
              $option .= "<option selected='selected' value='$correomasivocampana_id'>$correomasivocampana_nombre</option>";
          }else{
              $option .= "<option value='$correomasivocampana_id'>$correomasivocampana_nombre</option>";
          }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN CAMPAÑAS CREADAS</option>";
      }

      if ($companiaseleccionada==""){
        $option = "<option  value=''>-- Primero seleccione la Compañia --</option>"; 
      }

  }
  

  return $option;

}

function ObtenerListaGruposCorreoMasivo($cuentaseleccionada=null, $companiaseleccionada=null, $correomasivo_id=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {
      
     $arrresultado = $conexion->doSelect("grupo.grupo_id, grupo.grupo_nombre, correomasivogrupo_id",
        "grupo
          left join correomasivogrupo on correomasivogrupo.grupo_id = grupo.grupo_id
          and correomasivogrupo_activo = '1' and correomasivogrupo.correomasivo_id = '$correomasivo_id'
        ",
        "grupo_activo = '1' and grupo.cuenta_id = '$cuentaseleccionada' and grupo.compania_id = '$companiaseleccionada' ", null, "grupo_nombre asc");

      foreach($arrresultado as $i=>$valor){

          $grupo_id = utf8_encode($valor["grupo_id"]);
          $grupo_nombre = utf8_encode($valor["grupo_nombre"]);
          $correomasivogrupo_id = utf8_encode($valor["correomasivogrupo_id"]);


        if($correomasivogrupo_id != ""){
          $option .= "<option selected='selected' value='$grupo_id'>$grupo_nombre</option>";
        }else{
           $option .= "<option value='$grupo_id'>$grupo_nombre</option>";
         }

      }

       if (count($arrresultado)==0){
         $option = "<option  value=''>NO EXISTEN GRUPOS CREADOS</option>";
       }

  }
  
  return $option;

}

function ObtenerListaTipoMovimiento($idSeleccionado = null){    

    $option = "<option value=''>-- Seleccione --</option>";

    $conexion = new ConexionBd();

    $arrresultado = $conexion->doSelect("tipomovimientocaja_id, tipomovimientocaja_nombre
        ","tipomovimientocaja","tipomovimientocaja_activo = '1' and tipomovimientocaja_id in (2,3)", null, "tipomovimientocaja_id asc ");

    if (count($arrresultado)>0){
      foreach($arrresultado as $i=>$valor){
          $tipomovimientocaja_id = utf8_encode($valor["tipomovimientocaja_id"]);
          $tipomovimientocaja_nombre = utf8_encode($valor["tipomovimientocaja_nombre"]);  

          $selected = "";
          if ($idSeleccionado==$tipomovimientocaja_id){           
            $selected = " selected = 'selected' ";
          }     

          $option .= "<option value='$tipomovimientocaja_id' $selected>$tipomovimientocaja_nombre</option>";

      }
    }

    return $option;
}

function ListadoPagoUsuariosReservas($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Cuenta  
        
        $columnacompania = "<th>Compañia</th>";
        $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' ";

  } else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,
    pago.l_estatus_id, 

    pagotransaccion.pagotrans_id, pagotransaccion.trans_id, 
    pagotransaccion.pagotrans_fechareg,
    estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb, 
    transaccion.trans_codigo

    ",
    "pago
      inner join pagotransaccion on pagotransaccion.pago_id = pago.pago_id
      inner join transaccion on transaccion.trans_id = pagotransaccion.trans_id
      inner join lista moneda on moneda.lista_id = pago.l_moneda_id      
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 



  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $trans_codigo = utf8_encode($valor["trans_codigo"]);
    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);

    $pagotrans_id = utf8_encode($valor["pagotrans_id"]);      
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]); 
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);


    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $aaa); 

    $pedido = "#$trans_codigo";

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verpagoreserva?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verpagoreserva?id=$pago_id'>#$pago_id (Ver)</a>";


    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>            
            <td>$usuario</td>     
            <td>$pedido</td>               
            <td>$pago_monto $moneda_siglas</td>         
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}

function TipoDato_InputareaHora($valor=null, $elementoid=null, $colocarelementoarrayupload=null, $placeholder=null, $requerido=null, $deshabilitado=null){

  if ($colocarelementoarrayupload=="1"){
    $agregararray = "[$elementoid]";
  }

  if ($placeholder==""){
    $placeholder = "hh:mm";
  }

  if ($requerido=="1"){$requeridocolocar = "required='required'";}
  if ($deshabilitado=="1"){$deshabilitadocolocar = " disabled ";}

  $valorretorno = "<input type='text' class='form-control timepicker' value='$valor' name='valores$agregararray' id='$elementoid' autocomplete='off' placeholder='$placeholder' style='text-align: left' $requeridocolocar $deshabilitado/>";
  
  return $valorretorno;
}



function ObtenerListaGrupos($cuentaseleccionada=null, $companiaseleccionada=null, $usuario_id=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

      
     $arrresultado = $conexion->doSelect("grupo.grupo_id, grupo.grupo_nombre, usuariogrupo.usuariogrupo_id",
        "grupo
          left join usuariogrupo on usuariogrupo.grupo_id = grupo.grupo_id
          and usuariogrupo_activo = '1' and usuario_id = '$usuario_id'
        ",
        "grupo_activo = '1' and grupo.cuenta_id = '$cuentaseleccionada' and grupo.compania_id = '$companiaseleccionada' ", null, "grupo_nombre asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

          $grupo_id = utf8_encode($valor["grupo_id"]);
          $grupo_nombre = utf8_encode($valor["grupo_nombre"]);
          $usuariogrupo_id = utf8_encode($valor["usuariogrupo_id"]);


        if($usuariogrupo_id != ""){
          $option .= "<option selected='selected' value='$grupo_id'>$grupo_nombre</option>";
        }else{
           $option .= "<option value='$grupo_id'>$grupo_nombre</option>";
         }

      }

       if (count($arrresultado)==0){
         $option = "<option  value=''>NO EXISTEN GRUPOS CREADOS</option>";
       }

  }
  
  return $option;

}

function ObtenerListaTurnos($cuentaseleccionada=null, $companiaseleccionada=null, $usuario_id=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

      
     $arrresultado = $conexion->doSelect("turno.turno_id, turno.turno_nombre, turnousuario.turnousuario_id",
        "turno
          left join turnousuario on turnousuario.turno_id = turno.turno_id
          and turnousuario_activo = '1' and usuario_id = '$usuario_id'
        ",
        "turno_activo = '1' and turno.cuenta_id = '$cuentaseleccionada' and turno.compania_id = '$companiaseleccionada' ", null, "turno_nombre asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

          $turno_id = utf8_encode($valor["turno_id"]);
          $turno_nombre = utf8_encode($valor["turno_nombre"]);
          $turnousuario_id = utf8_encode($valor["turnousuario_id"]);


        if($turnousuario_id != ""){
              $option .= "<option selected='selected' value='$turno_id'>$turno_nombre</option>";
        }else{
               $option .= "<option value='$turno_id'>$turno_nombre</option>";
             }

      }

       if (count($arrresultado)==0){
         $option = "<option  value=''>NO EXISTEN PROYECTOS DISPONIBLES</option>";
       }

  }
  
  return $option;

}


function ObtenerListaProyecto($cuentaseleccionada=null, $companiaseleccionada=null, $usuario_id=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

      
     $arrresultado = $conexion->doSelect("proyecto.proyecto_id, proyecto.proyecto_nombre, proyectousuario.proyectousuario_id",
        "proyecto
          left join proyectousuario on proyectousuario.proyecto_id = proyecto.proyecto_id
          and proyectousuario_activo = '1' and proyectousuario.usuario_id = '$usuario_id'
        ",
        "proyecto_activo = '1'  and proyecto.cuenta_id = '$cuentaseleccionada' and proyecto.compania_id = '$companiaseleccionada' ", null, "proyecto_nombre asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

          $proyecto_id = utf8_encode($valor["proyecto_id"]);
          $proyecto_nombre = utf8_encode($valor["proyecto_nombre"]);
          $proyectousuario_id = utf8_encode($valor["proyectousuario_id"]);


        if($proyectousuario_id != ""){
              $option .= "<option selected='selected' value='$proyecto_id'>$proyecto_nombre</option>";
        }else{
               $option .= "<option value='$proyecto_id'>$proyecto_nombre</option>";
             }

      }

       if (count($arrresultado)==0){
         $option = "<option  value=''>NO EXISTEN PROYECTOS DISPONIBLES</option>";
       }

  }
  
  return $option;

}



function ObtenerListaDepartamento($cuentaseleccionada=null, $companiaseleccionada=null, $departamentoseleccionado=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

      
     $arrresultado = $conexion->doSelect("departamento.departamento_id  , departamento.departamento_nombre",
        "departamento
          
        ",
        "departamento_activo = '1'  and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada' ", null, "departamento_nombre asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

        $departamento_id = utf8_encode($valor["departamento_id"]);
        $departamento_nombre = utf8_encode($valor["departamento_nombre"]);

        if ($departamentoseleccionado==$departamento_id){
              $option .= "<option selected='selected' value='$departamento_id'>$departamento_nombre $usuario_apellido</option>";
          }else{
              $option .= "<option value='$departamento_id'>$departamento_nombre</option>";
          }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN SINDICATOS DISPONIBLES</option>";
      }

      if (count($arrresultado)==1){
        $option = "<option selected='selected' value='$departamento_id'>$departamento_nombre</option>";
      } 
  }
  

  return $option;

}



function ObtenerListaSindicato($cuentaseleccionada=null, $companiaseleccionada=null, $sindicatoseleccionado=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

      
     $arrresultado = $conexion->doSelect("sindicato.sindicato_id , sindicato.sindicato_nombre",
        "sindicato
          
        ",
        "sindicato_activo = '1'  and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada' ", null, "sindicato_nombre asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

        $sindicato_id = utf8_encode($valor["sindicato_id"]);
        $sindicato_nombre = utf8_encode($valor["sindicato_nombre"]);

        if ($sindicatoseleccionado==$sindicato_id){
              $option .= "<option selected='selected' value='$sindicato_id'>$sindicato_nombre $usuario_apellido</option>";
          }else{
              $option .= "<option value='$sindicato_id'>$sindicato_nombre</option>";
          }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN SINDICATOS DISPONIBLES</option>";
      }

      if (count($arrresultado)==1){
        $option = "<option selected='selected' value='$sindicato_id'>$sindicato_nombre</option>";
      } 
  }
  

  return $option;

}




function ObtenerListaCargo($cuentaseleccionada=null, $companiaseleccionada=null, $cargo=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

      
     $arrresultado = $conexion->doSelect("cargo.cargo_id, cargo.cargo_nombre",
        "cargo
          
        ",
        "cargo_activo = '1'  and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada' ", null, "cargo_nombre asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

        $cargo_id = utf8_encode($valor["cargo_id"]);
        $cargo_nombre = utf8_encode($valor["cargo_nombre"]);

        if ($cargo==$cargo_id){
              $option .= "<option selected='selected' value='$cargo_id'>$cargo_nombre $usuario_apellido</option>";
          }else{
              $option .= "<option value='$cargo_id'>$cargo_nombre</option>";
          }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN CARGOS DISPONIBLES</option>";
      }

      if (count($arrresultado)==1){
        $option = "<option selected='selected' value='$cargo_id'>$cargo_nombre</option>";
      } 
  }
  

  return $option;

}

function convertirFechaBd($fecha=null){

  if ($fecha==""){$fecha="01/01/1900";}

  $dia = substr($fecha,0,2);
  $mes = substr($fecha,3,2);
  $ano = substr($fecha,6,4);
  $fecha = $ano."-".$mes."-".$dia;

  return $fecha;

}

function ObtenerListaReciboPagoPeriodo($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else { 

      
     $arrresultado = $conexion->doSelect("recibopagoperiodo_id, recibopagoperiodo_nombre",
        "recibopagoperiodo",
        "recibopagoperiodo_activo = '1' and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada'", null, "recibopagoperiodo_nombre asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

        $recibopagoperiodo_id = utf8_encode($valor["recibopagoperiodo_id"]);
        $recibopagoperiodo_nombre = utf8_encode($valor["recibopagoperiodo_nombre"]);        

        if ($idseleccionado==$recibopagoperiodo_id){
              $option .= "<option selected='selected' value='$recibopagoperiodo_id'>$recibopagoperiodo_nombre</option>";
          }else{
              $option .= "<option value='$recibopagoperiodo_id'>$recibopagoperiodo_nombre</option>";
          }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN PERIODOS</option>";
      }

      if ($companiaseleccionada==""){
        $option = "<option  value=''>-- Primero seleccione la Compañia --</option>"; 
      }

  }
  

  return $option;

}


function ObtenerCodigoTransaccionVenta($numero=null, $codigo=null){  

  $numerico = str_pad($numero, 4, "0", STR_PAD_LEFT);  

  $codigo = $codigo."-".$numerico;

  return $codigo;

}


function ListadoPagoUsuarioVentasCategoria($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,
    pago.l_estatus_id, 

    pagotransaccion.pagotrans_id, pagotransaccion.trans_id, 
    pagotransaccion.pagotrans_fechareg,
    estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb, 
    transaccion.trans_codigo

    ",
    "pago
      inner join pagotransaccion on pagotransaccion.pago_id = pago.pago_id
      inner join transaccion on transaccion.trans_id = pagotransaccion.trans_id
      inner join lista moneda on moneda.lista_id = pago.l_moneda_id      
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 



  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $trans_codigo = utf8_encode($valor["trans_codigo"]);
    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);

    $pagotrans_id = utf8_encode($valor["pagotrans_id"]);      
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]); 
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);


    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $aaa); 

    $pedido = "#$trans_codigo";

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verpagoventacategoria?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verpagoventacategoria?id=$pago_id'>#$pago_id (Ver)</a>";


    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>            
            <td>$usuario</td>     
            <td>$pedido</td>               
            <td>$pago_monto $moneda_siglas</td>         
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}

function ObtenerListaUsuariosPerfiles($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado =null, $paraperfiles=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else { 

    if ($paraperfiles!=""){
      $paraperfiles = " and perfil_id in ($paraperfiles)";
    }
      
     $arrresultado = $conexion->doSelect("usuario_id, usuario_nombre, usuario_apellido",
        "usuario",
        "usuario_activo = '1' and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada' $paraperfiles", null, "usuario_nombre, usuario_apellido asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

        $usuario_id = utf8_encode($valor["usuario_id"]);
        $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
        $usuario_apellido = utf8_encode($valor["usuario_apellido"]);

        if ($idseleccionado==$usuario_id){
              $option .= "<option selected='selected' value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
          }else{
              $option .= "<option value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
          }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN USUARIOS</option>";
      }

      if ($companiaseleccionada==""){
        $option = "<option  value=''>-- Primero seleccione la Compañia --</option>"; 
      }

  }
  

  return $option;

}

function ObtenerListaPropietariosAplicacion($cuentaseleccionada=null, $companiaseleccionada=null, $condominio =null, $propietarioseleccionado=null, $solopropietario=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

    if ($solopropietario=="1"){
      $wherepropietario = " and usuario.usuario_id = '$propietarioseleccionado' ";
    }
      
     $arrresultado = $conexion->doSelect("usuario.usuario_id, usuario_nombre, usuario_apellido",
        "usuario
          inner join perfil on perfil.perfil_id = usuario.perfil_id
        ",
        "usuario_activo = '1'  $wherepropietario and perfil.perfil_idorig = '94' and usuario.cuenta_id = '$cuentaseleccionada' and usuario.compania_id = '$companiaseleccionada'", null, "usuario_nombre, usuario_apellido asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

        $usuario_id = utf8_encode($valor["usuario_id"]);
        $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
        $usuario_apellido = utf8_encode($valor["usuario_apellido"]);

        if ($propietarioseleccionado==$usuario_id){
              $option .= "<option selected='selected' value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
          }else{
              $option .= "<option value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
          }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN PROPIETARIOS</option>";
      }

      if (count($arrresultado)==1){
        $option = "<option selected='selected' value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
      } 
  }
  

  return $option;

}

function ObtenerListaAplicaciones($cuenta=null, $compania=null, $elementoid=null){

 
  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $option = "<option value=''>-- Seleccione --</option>";

  $arrresultado = $conexion->doSelect("
      aplicacion_id, aplicacion_nombre, aplicacion_fechareg, 
      aplicacion_activo, aplicacion_eliminado, cuenta_id, compania_id
      ",
      "aplicacion",
      "aplicacion_activo = '1' ", null, "aplicacion_nombre asc");

  //and aplicacion.cuenta_id = '$cuenta' and aplicacion.compania_id = '$compania'

  foreach($arrresultado as $i=>$valor){

    $aplicacion_id = utf8_encode($valor["aplicacion_id"]);  
    $aplicacion_nombre = utf8_encode($valor["aplicacion_nombre"]);  
   
    $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  

    if ($elementoid==$aplicacion_id){
        $option .= "<option selected='selected' value='$aplicacion_id'>$aplicacion_nombre</option>";
    }else{
        $option .= "<option value='$aplicacion_id'>$aplicacion_nombre</option>";
    }    

  }
    

  if (count($arrresultado)==0 && $compania==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }else if (count($arrresultado)==1){
    $option = "<option  value=''>NO EXISTEN APLICACIONES</option>";
  }

 
  return $option;

}

function ProcesoVerificacionCondominio(){  

  $fechaactual = formatoFechaHoraBd(1);
  $instancialista = new Lista();

  $obtenerIdLista = 2;
  $obtenerTipoLista = 115;
  $idestatusmoroso = $instancialista->ObtenerIdLista($obtenerIdLista, $obtenerTipoLista);

  $obtenerIdLista = 5;
  $obtenerTipoLista = 110;
  $idestatuspendienterecibo = $instancialista->ObtenerIdLista($obtenerIdLista, $obtenerTipoLista);

  $conexion = new ConexionBd();
  $arrresultado = $conexion->doSelect("
      propietario.usuario_id as propietario_id, condominiorecibousuario_monto, 
      condominiorecibo_fechavenc, condominiorecibousuario_id
      ",
      "condominiorecibo           
        inner join usuario cuenta on cuenta.usuario_id = condominiorecibo.cuenta_id
        inner join compania on compania.compania_id = condominiorecibo.compania_id    
        inner join condominio on condominio.condominio_id = condominiorecibo.condominio_id
        inner join condominiorecibousuario on condominiorecibousuario.condominiorecibo_id = condominiorecibo.condominiorecibo_id

        inner join lista estatus on estatus.lista_id = condominiorecibousuario.l_estatus_id

        left join vivienda on vivienda.vivienda_id = condominiorecibousuario.vivienda_id
        left join edificio on edificio.edificio_id = condominiorecibo.edificio_id
        left join lista tiporecibo on tiporecibo.lista_id = condominiorecibo.l_tiporecibocondominio_id
        left join lista categoria on categoria.lista_id = condominiorecibo.l_categoria_id
        
        
        
        left join viviendausuario on viviendausuario.vivienda_id = vivienda.vivienda_id
        left join usuario propietario on propietario.usuario_id = viviendausuario.usuario_id
        left join lista moneda on moneda.lista_id = condominiorecibousuario.l_moneda_id

      ",
      "condominiorecibo_activo = '1' and condominiorecibousuario_activo = '1' and estatus.lista_cod = '1' and DATE_FORMAT(condominiorecibo_fechavenc,'%Y-%m-%d') and condominiorecibo_fechavenc < '$fechaactual'
      ");
    foreach($arrresultado as $i=>$valor){
      $propietario_id  = utf8_encode($valor["propietario_id"]);
      $condominiorecibousuario_id  = utf8_encode($valor["condominiorecibousuario_id"]);

      $resultado = $conexion->doUpdate("usuario", "         
          l_estatus_id = '$idestatusmoroso'
          ", "usuario_id='$propietario_id'"); 


      $resultado = $conexion->doUpdate("condominiorecibousuario", "         
          l_estatus_id = '$idestatuspendienterecibo'
          ", "condominiorecibousuario_id='$condominiorecibousuario_id'"); 

    }

    return true;

}

function obtenerExtensionArchivo($extension=null){

  $tipocodigo = 0;

  if ($extension=="xls" || $extension=="xlsx" || $extension=="csv" ){
    $tipocodigo = 1;
  }

  if ($extension=="jpg" || $extension=="jpeg" || $extension=="png" || $extension=="bmp" || $extension=="gif"  || $extension=="webp"){
    $tipocodigo = 2;
  }

  if ($extension=="pdf" ){
    $tipocodigo = 3;
  }

  if ($extension=="doc" || $extension=="docx" ){
    $tipocodigo = 4;
  }

  if ($extension=="txt" ){
    $tipocodigo = 5;
  }
  
  return $tipocodigo;

}

function TipoDato_InputareaColor($valor=null, $elementoid=null){

  $valorretorno = "<input type='text' class='form-control colorpicker' value='$valor' name='valores' id='$elementoid' autocomplete='off' />";
  
  return $valorretorno;
}

function number_format_personalizado($monto=null, $siglas=null, $montodecimalesforzar=null, $compania_id=null){

  session_start();
  $montoscondecimales = $_SESSION[montoscondecimales];

  if ($monto==""){
    $monto = 0;
  }

  if ($montoscondecimales==""){
    $montoscondecimales = 0;

    $idcuenta = $_COOKIE[idcuenta];

    $conexion = new ConexionBd();
    $arrresultado = $conexion->doSelect("listaconfig_valoruno","listaconfig",
      "tipolista_id = '119'  and cuenta_id= '$idcuenta' and listaconfig_activo = '1' ");
    foreach($arrresultado as $i=>$valor){   
      $montoscondecimales = utf8_encode($valor["listaconfig_valoruno"]);   
    }
    if ($montoscondecimales=="1"){
      $montoscondecimales= "1";
    }

    $_SESSION[montoscondecimales] = $montoscondecimales;

  }
/* 
  if ($montodecimalesforzar>0){
    $numero = number_format($monto, $montodecimalesforzar, ',', '.')." ".$siglas;
  }else{
    if ($montoscondecimales>0){
      $numero = number_format($monto, 2, ',', '.')." ".$siglas;
    }else if ($monto<1 && $monto>0){
      $numero = number_format($monto, 2, ',', '.')." ".$siglas;
    }else{
      $numero = number_format($monto, 0, ',', '.')." ".$siglas;
    }
  }
 */
  if ($montodecimalesforzar>0){
    $numero = $siglas." ".number_format($monto, $montodecimalesforzar, ',', '.');
  }else{
    if ($montoscondecimales>0){
      $numero = $siglas." ".number_format($monto, 2, ',', '.');
    }else{
      $numero = $siglas." ".number_format($monto, 2, ',', '.');
    }
  }

  if ($siglas=="Monedas"){
    $numero = number_format($monto, 2, ',', '.');
  }

  if ($montodecimalesforzar=="0"){
    $numero = $siglas." ".number_format($monto, 0, ',', '.');
  }

  if ($compania_id=="447"){
    $numero = $siglas." ".number_format($monto, 2, '.', ',');
  }

  return $numero;
}

function ListadoMessages($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $getdate=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (chat.chat_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (chat.chat_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (chat.chat_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (chat.chat_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and chat.cuenta_id = '$_COOKIE[idcuenta]' ";

      //$where .= " and chat.usuario_idpropietario = '$_COOKIE[iniuser]' ";

  } else if ($_COOKIE[perfil]=="85" || $_COOKIE[perfil]=="80"){ // Administrador de Condominio  
      
      //$columnacompania = "<th>Compañia</th>";
      //$where = " and chat.cuenta_id = '$_COOKIE[idcuenta]' ";

      $where .= " and chat.cuenta_id = '$_COOKIE[idcuenta]' and chat.compania_id = '$_COOKIE[idcompania]' and chat.usuario_idpropietario = '$_COOKIE[iniuser]' ";

  } else if ($_COOKIE[perfil]=="82" || $_COOKIE[perfil]=="84"){ // Propietario de Condominio  
      
      //$columnacompania = "<th>Compañia</th>";
      //$where = " and chat.cuenta_id = '$_COOKIE[idcuenta]' ";

      $where .= " and chat.cuenta_id = '$_COOKIE[idcuenta]' and chat.compania_id = '$_COOKIE[idcompania]' and chat.usuario_idcliente = '$_COOKIE[iniuser]' ";

  }   else { 

    $where = " and chat.cuenta_id = '$_COOKIE[idcuenta]' and chat.compania_id = '$_COOKIE[idcompania]' 
    and (chat.usuario_idcliente = '$_COOKIE[iniuser]'  or chat.usuario_idpropietario = '$_COOKIE[iniuser]' )  ";

  } 


  $conexion = new ConexionBd();

  
  $arrresultado = $conexion->doSelect("
      chat.chat_id, chat.chat_titulo, chat.chat_ultmsje, chat.usuario_idorigen, chat.usuario_iddestino, 
      chat.chat_leido, chat.modulo_id, chat.elemento_id, chat.cuenta_id, chat.compania_id, 
      chat.chat_activo, chat.chat_eliminado, chat.usuario_idcliente, chat.usuario_idpropietario, chat.chat_msjes,
      usuarioorigen.usuario_nombre, usuarioorigen.usuario_apellido, usuarioorigen.usuario_img,
      DATE_FORMAT(chat.chat_fechareg,'%d/%m/%Y %H:%i:%s') as chat_fechareg,
      DATE_FORMAT(chat.chat_ultfecha,'%d/%m/%Y %H:%i:%s') as chat_ultfecha,
      modulo_url, modulo_nombreunico,
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre
      ",
    "chat 
        inner join usuario usuarioorigen on usuarioorigen.usuario_id = chat.usuario_idorigen
        left join modulo on modulo.modulo_id = chat.modulo_id
        inner join usuario cuenta on cuenta.usuario_id = chat.cuenta_id
        inner join compania on compania.compania_id = chat.compania_id 

    ",
    "chat.chat_eliminado = '0' $where $wherefecha ", null, "chat.chat_ultfecha desc");
  foreach($arrresultado as $i=>$valor){

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $chat_id = utf8_encode($valor["chat_id"]);
    $chat_titulo = utf8_encode($valor["chat_titulo"]);
    $chat_activo = utf8_encode($valor["chat_activo"]);
    $chat_ultmsje = utf8_encode($valor["chat_ultmsje"]);
    $usuario_idorigen = utf8_encode($valor["usuario_idorigen"]);
    $usuario_iddestino = utf8_encode($valor["usuario_iddestino"]);
    $chat_leido = utf8_encode($valor["chat_leido"]);
    $t_modulo_id = utf8_encode($valor["modulo_id"]);
    $elemento_id = utf8_encode($valor["elemento_id"]);
    $usuario_idcliente = utf8_encode($valor["usuario_idcliente"]);
    $usuario_idpropietario = utf8_encode($valor["usuario_idpropietario"]);
    $chat_msjes = utf8_encode($valor["chat_msjes"]);
    $chat_fechareg = utf8_encode($valor["chat_fechareg"]);
    $chat_ultfecha = utf8_encode($valor["chat_ultfecha"]);
    $modulo_url = utf8_encode($valor["modulo_url"]);
    $modulo_nombreunico = utf8_encode($valor["modulo_nombreunico"]);    

    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $usuario = $usuario_nombre." ".$usuario_apellido;

  
    if ($chat_activo=="0"){
      $activo = "<i onclick='cambiarestatuschat(\"".$chat_id."\",1)' title='Disabled' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuschat(\"".$chat_id."\",0)' title='Enabled' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarchat(\"".$chat_id."\",0)' title='Delete?' class='fa fa-trash btn-eliminar'></i>";
         

    //$moduloidchat = "88";
    $mensajes = "<a href='support?mid=$t_modulo_id&id=$elemento_id&chid=$chat_id'><i title='Send Message' class='fa fa-envelope btn-mensajes'></i></a>";


    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    } 

    $titulo = "";  

    if ($modulo_url =="" ){
      $modulo_url="support?mid=$t_modulo_id&id=$elemento_id&chid=$chat_id";
    } 

    if ($modulo_url !="" ){
      $titulo = "
      <a href='$modulo_url'>
        $chat_titulo
      </a>
      ";
    }

    $textohtml .= "
           <tr>               
              $mostrarcolumnacuenta
              $mostrarcolumnacompania
              <td>$titulo</td>
              <td>$usuario</td>            
              <td>$chat_ultmsje</td>            
              <td>$chat_ultfecha</td>  
              <td style='text-align: center'>$mensajes &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}

function ObtenerListaViviendasDad($cuentaseleccionada=null, $companiaseleccionada=null,  $getcondominio=null, $condominiorecibo_id=null, $edificio_id=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($_COOKIE[perfil]=="1"){  
    
    
    if ($cuentaseleccionada!=""){
      $where = " and vivienda.cuenta_id = '$cuentaseleccionada' ";     
    } 
    
  } else if ($_COOKIE[perfil]=="2"){   // Administrador
  
    $where = " and vivienda.cuenta_id = '$_COOKIE[idcuenta]' ";     
    
  } else if ($_COOKIE[perfil]=="82"){   // Propietario
  
    $where = " and vivienda.cuenta_id = '$_COOKIE[idcuenta]' and viviendausuario.usuario_id = '$_COOKIE[iniuser]' ";     
    
  } else if ($_COOKIE[perfil]=="89"){   // Empleado
  
    $where = " and vivienda.cuenta_id = '$_COOKIE[idcuenta]' and vivienda.compania_id = '$_COOKIE[idcompania]' ";     
    
  } else {
  
    $where = " and vivienda.cuenta_id = '$_COOKIE[idcuenta]' and vivienda.usuario_id = '$_COOKIE[iniuser]' ";     
    
  }

  if ($getcondominio!=""){
    //$where .= " and vivienda.condominio_id = '$getcondominio' ";
  }

  if ($edificio_id!=""){
    $where .= " and vivienda.edificio_id = '$edificio_id' ";
  }
  
  $arrresultado = $conexion->doSelect("vivienda.vivienda_id, vivienda_numero, condominiorecibousuario_id",
    "vivienda
      inner join viviendausuario on viviendausuario.vivienda_id = vivienda.vivienda_id
      left join condominiorecibousuario on condominiorecibousuario.vivienda_id = vivienda.vivienda_id
      and condominiorecibousuario_activo = '1' and condominiorecibo_id = '$condominiorecibo_id'
    ",
    "vivienda_activo = '1' and viviendausuario_activo = '1' $where", null, "vivienda_numero asc");

  $option = "<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

      $condominiorecibousuario_id = utf8_encode($valor["condominiorecibousuario_id"]);  
      $vivienda_id = utf8_encode($valor["vivienda_id"]);  
      $vivienda_numero = utf8_encode($valor["vivienda_numero"]);        

      if ($condominiorecibousuario_id!=""){
        $option .= "<option selected='selected' value='$vivienda_id'>$vivienda_numero</option>";
      }else{
        $option .= "<option value='$vivienda_id'>$vivienda_numero</option>";
      }
     
  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN VIVIENDAS</option>";
  }


  if (count($arrresultado)==1){
    $option = "<option  value='$vivienda_id'>$vivienda_numero</option>";
  }

  return $option;

}

function ListadoPagousuarioPlan($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="89"){   // Empleado
  
    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' ";     
    
  } else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,    

    plan.lista_nombre as plan_nombre, estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb,
    pagomoney.pagomoney_id

    ",
    "pago
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id

      left join pagoplancondominio on pagoplancondominio.pago_id = pago.pago_id
      left join pagomoney on pagomoney.pago_id = pago.pago_id
      left join lista moneda on moneda.lista_id = pago.l_moneda_id
      left join lista plan on plan.lista_id = pagoplancondominio.l_plan_id
      

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 



  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

    $pagomoney_id = utf8_encode($valor["pagomoney_id"]);
    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);
    $pagoplanmultinivel_id = utf8_encode($valor["pagoplanmultinivel_id"]);  
    $l_plan_id = utf8_encode($valor["l_plan_id"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $pagoplanmultinivel_fechareg = utf8_encode($valor["pagoplanmultinivel_fechareg"]);
    $pagoplanmultinivel_observacion = utf8_encode($valor["pagoplanmultinivel_observacion"]);

    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    

    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $aaa); 

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verpagoplan?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verpagoplan?id=$pago_id'>#$pago_id (More)</a>";

    if ($pagomoney_id!=""){
      $plan_nombre = "(Add Money)";
    }

    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>            
            <td>$usuario</td>     
            <td>$plan_nombre</td>               
            <td>$pago_monto $moneda_siglas</td>         
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}

function ObtenerListaPlans($cuentaseleccionada=null, $companiaseleccionada=null, $usuario_idget =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and listaplancondominio.cuenta_id = '$_COOKIE[idcuenta]' ";          


  }  else { 

    $where = " and listaplancondominio.cuenta_id = '$_COOKIE[idcuenta]' and listaplancondominio.compania_id = '$_COOKIE[idcompania]' ";
    $wherelistaactivo = " and plan.lista_activo = '1' ";
  } 


  $arrresultado = $conexion->doSelect("

    listaplancondominio.listaplancond_id, listaplancondominio.l_plancond_id, 
    listaplancondominio.l_moneda_id, listaplancondominio.listaplancond_precio, 
    listaplancondominio.listaplancond_porccomision, listaplancondominio.listaplancond_contactos, 
    listaplancondominio.listaplancond_diasduracion, 
    listaplancondominio.listaplancond_habiltarminutos, listaplancondominio.listaplancond_notifwhatsapp, 
    listaplancondominio.cuenta_id, listaplancondominio.compania_id, 
    listaplancondominio.listaplancond_fechareg, listaplancondominio.usuario_idreg, 
    listaplancondominio.listaplancond_url,

    plan.lista_id as plan_id, plan.lista_nombre as plan_nombre, plan.lista_img as plan_img,
    plan.lista_orden as plan_orden, plan.lista_activo as plan_activo,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    listaplanconddet_id, listaplanconddet_descrip, listaplanconddet_orden, listaplanconddet_activo,

    moneda.lista_nombredos as moneda_siglas

      ",
    "
    listaplancondominio
        inner join lista plan on plan.lista_id = listaplancondominio.l_plancond_id          
        inner join usuario cuenta on cuenta.usuario_id = listaplancondominio.cuenta_id
        inner join compania on compania.compania_id = listaplancondominio.compania_id  


        left join lista moneda on moneda.lista_id = listaplancondominio.l_moneda_id       
        left join listaplancondominiodetalle on listaplancondominiodetalle.l_plan_id = plan.lista_id 
        and listaplanconddet_activo = '1'
    ",
    " plan.lista_activo = '1' $where  $wherelistaactivo", null, "plan.lista_orden, plan.lista_id, listaplancondominiodetalle.listaplanconddet_orden  asc");

  $cont = 0;
  foreach($arrresultado as $i=>$valor){

    $plan_id = utf8_encode($valor["plan_id"]);

    if ($plan_id_old!=$plan_id && $cont!="0"){   

      $planeshtml .= "
        <div class='col-lg-4 col-md-6' style='margin-bottom: 15px;'>
            <div class='package-content bg-light border text-center p-2 my-2 my-lg-0' style='background: #FFF; padding: 20px'>
                <div class='package-content-heading border-bottom'>
                    <a href='addplanformapago?id=$plan_id_old'>
                      <center>
                          <img src='$urlimgPlan' class='img-responsive' style='height:140px' />
                      </center>
                      <h2 style='padding-top: 10px; padding-bottom: 4px'>$plan_nombre</h2>
                      $divprecio
                    </a>
                </div>
                <ul style='padding-left: 0px; list-style:none'>
                    $plandetallehtml
                </ul>
                <a href='addplanformapago?id=$plan_id_old' class='btn btn-primary' style='margin-top: 5px'>Select</a>
                
            </div>
        </div>
       
      ";

       $plandetallehtml ="";

    }

    $listaplancond_id = utf8_encode($valor["listaplancond_id"]);
    $l_plancond_id = utf8_encode($valor["l_plancond_id"]);
    $listaplancond_precio = utf8_encode($valor["listaplancond_precio"]);
    $listaplancond_porccomision = utf8_encode($valor["listaplancond_porccomision"]);
    $listaplancond_contactos = utf8_encode($valor["listaplancond_contactos"]);
    $listaplancond_diasduracion = utf8_encode($valor["listaplancond_diasduracion"]);
    $listaplancond_habiltarminutos = utf8_encode($valor["listaplancond_habiltarminutos"]);
    $listaplancond_notifwhatsapp = utf8_encode($valor["listaplancond_notifwhatsapp"]);
    $listaplancond_url = utf8_encode($valor["listaplancond_url"]);
    $listaplancond_id = utf8_encode($valor["listaplancond_id"]);

    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);    

    $listaplanconddet_id = utf8_encode($valor["listaplanconddet_id"]);
    $listaplanconddet_descrip = utf8_encode($valor["listaplanconddet_descrip"]);
    $listaplanconddet_orden = utf8_encode($valor["listaplanconddet_orden"]);
    $listaplanconddet_activo = utf8_encode($valor["listaplanconddet_activo"]);
    
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);        
    
    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $plan_img = utf8_encode($valor["plan_img"]);  
    $plan_orden = utf8_encode($valor["plan_orden"]);  
    $plan_activo = utf8_encode($valor["plan_activo"]);  

    $urlimgPlan = "arch/$plan_img";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $listaplancond_precioorig = $listaplancond_precio;

    if ($listaplancond_precio==""){$listaplancond_precio=0;}
    
    $listaplancond_precio = number_format_personalizado($listaplancond_precio,$moneda_siglas);

    if ($listaplancond_precioorig=="0" || $listaplancond_precioorig==""){
      $divprecio = "
        <h4 class='py-0' style='font-size: 20px; line-height: 30px'>         
          
        </h4>
      ";
      $divcontratar = "
        
      ";
    }else{
      $divprecio = "
        <h4 class='py-0' style='font-size: 20px; line-height: 30px'> 
          <span style='font-size: 20px'>$listaplancond_precio $moneda_siglas </span> <br>
        </h4>
      ";

      $divcontratar = "
        <a href='plan-forma-pago?id=$plan_id' class='btn btn-success' style='margin-top: 5px'>Contratar</a>
      ";
    }

    $plandetallehtml .= "
          <li class='my-4'> $listaplanservdet_descrip</li>
      ";

    $plan_id_old = $plan_id;

    $cont = $cont +1;

  }


  if ($plandetallehtml!=""){
    $planeshtml .= "
        <div class='col-lg-4 col-md-6' style='margin-bottom: 15px;'>
            <div class='package-content bg-light border text-center p-2 my-2 my-lg-0' style='background: #FFF; padding: 20px'>
                <div class='package-content-heading border-bottom'>
                    <a href='addplanformapago?id=$plan_id'>
                      <center>
                          <img src='$urlimgPlan' class='img-responsive' style='height:140px' />
                      </center>
                      <h2 style='padding-top: 10px; padding-bottom: 4px'>$plan_nombre</h2>
                      $divprecio
                    </a>
                </div>
                <ul style='padding-left: 0px; list-style:none'>
                    $plandetallehtml
                </ul>
                <a href='addplanformapago?id=$plan_id' class='btn btn-primary' style='margin-top: 5px'>Select</a>
                
            </div>
        </div>
      ";
  }

  if ($planeshtml!=""){

    $planeshtml = "

    <div class='col-md-12'>
        <h3>Select the plan you want</h3>  
    </div>    

    $planeshtml
    ";
  }

  return $planeshtml;

}

function ListadoPagousuarioBills($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistemawasw
    

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else if ($_COOKIE[perfil]=="89"){ // Empleados
            
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' ";

  }    else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,        

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb, 
    pagocondominiorecibo.condominiorecibo_id, 
    estatus.lista_nombre as estatus_nombre
    ",
    "pago
      inner join pagocondominio on pagocondominio.pago_id = pago.pago_id
      inner join pagocondominiorecibo on pagocondominiorecibo.pagocondominio_id = pagocondominio.pagocondominio_id
      inner join lista moneda on moneda.lista_id = pago.l_moneda_id      
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 



  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);
    $condominiorecibo_id = utf8_encode($valor["condominiorecibo_id"]);


    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);
    $pagoplanmultinivel_id = utf8_encode($valor["pagoplanmultinivel_id"]);  
    $l_plan_id = utf8_encode($valor["l_plan_id"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $pagoplanmultinivel_fechareg = utf8_encode($valor["pagoplanmultinivel_fechareg"]);
    $pagoplanmultinivel_observacion = utf8_encode($valor["pagoplanmultinivel_observacion"]);

    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);    
  

    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $aaa)." ".$moneda_siglas; 

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verpaymentbills?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verpaymentbills?id=$pago_id'>#$pago_id (Details)</a>";


    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>            
            <td>$usuario</td>     
            <td>#$condominiorecibo_id</td>               
            <td>$pago_monto</td>         
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}

function PlanActual($verificarcrear=null){

  session_start();

  $perfil = $_COOKIE[perfil];
  $usuario_idactual = $_COOKIE[iniuser];
  $login = $_COOKIE[login];

  $conexion = new ConexionBd();

  $arrresultadoplanes = $conexion->doSelect("usuario.usuario_id, usuario.usuario_codigo, usuario.usuario_email, usuario.usuario_clave, usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_telf, usuario.usuario_activo, usuario.usuario_eliminado, usuario.usuario_documento, usuario.usuario_img, usuario.perfil_id, usuario.usuario_whatsapp,
    DATE_FORMAT(usuario.usuario_fechareg,'%d/%m/%Y %H:%i:%s') as usuario_fechareg, usuario.usuario_alias,
    usuario.cuenta_id,
    compania.compania_urlweb, compania_nombre, compania.compania_id, compania_email,

    referido.usuario_id as referido_id, referido.usuario_nombre as referido_nombre,
    referido.usuario_apellido as referido_apellido, referido.usuario_email as referido_email,
    referido.usuario_alias as referido_alias,

    usuariobalance_total, 
    usuariobalance_bloqueado, 
    usuariobalance_disponible, 
    usuariobalance_pendiente,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas,

    DATE_FORMAT(usuarioplan.usuarioplan_fechaini,'%d/%m/%Y') as usuarioplan_fechaini,
    DATE_FORMAT(usuarioplan.usuarioplan_fechafin,'%d/%m/%Y') as usuarioplan_fechafin,

    plan.lista_nombre as  plan_nombre
    ",
    "usuario
      inner join usuarioplan on usuarioplan.usuario_id =  usuario.usuario_id and usuarioplan_activo = '1'
      left join compania on usuario.compania_id = compania.compania_id
      left join usuario referido on referido.usuario_id = usuario.usuario_idreferido
      left join usuariobalance on usuariobalance.usuario_id = usuario.usuario_id
      left join lista moneda on moneda.lista_id = usuariobalance.l_moneda_id
      
      left join lista plan  on plan.lista_id = usuarioplan.plan_id


    ",
    "usuario.usuario_eliminado = '0' and usuario.usuario_id = '$usuario_idactual' ");
  

  $arrresultadocondominios = $conexion->doSelect("condominio.condominio_id, condominio_nombre, condominio_razonsocial, condominio_img, condominio_activo, condominio_eliminado, condominio.cuenta_id, condominio_cedula, condominio_email, condominio_telf, condominio_direccion,  condominio_whatsapp, condominio_terminos, condominio_tipo, condominio_utilizar,
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido,
    DATE_FORMAT(condominio_fechareg,'%d/%m/%Y %H:%i:%s') as condominio_fechareg,
    compania_nombre, 

    admincondominio.usuario_nombre as admincondominio_nombre, 
    admincondominio.usuario_apellido as admincondominio_apellido
  ",
    "condominio
      inner join compania on compania.compania_id = condominio.compania_id
      inner join usuario cuenta on cuenta.usuario_id = condominio.cuenta_id

      inner join usuariocondominio on usuariocondominio.condominio_id = condominio.condominio_id
       and usuariocondominio_activo = '1'

      inner join usuario admincondominio on admincondominio.usuario_id = usuariocondominio.usuario_id
      inner join perfil on perfil.perfil_id = admincondominio.perfil_id and perfil.perfil_idorig = '80'
    ",
    "condominio_eliminado = '0' and condominio.condominio_idrel is null  and admincondominio.usuario_id = '$usuario_idactual' ");  

  $totalcondominiocreados = count($arrresultadocondominios);

  $totalplanes = count($arrresultadoplanes);

  if ($verificarcrear=="1"){
    if ($totalplanes<=$totalcondominiocreados){
      $retornoexiste = 0;
    }
    
  }else{
    if ($totalplanes>=$totalcondominiocreados){    
      $retornoexiste = 1;
    }else{
      $retornoexiste = 0; 
    }  

    if ($totalplanes==0){
      $retornoexiste=0;
    }
  }

  

  if ($perfil=="82" || $perfil=="1" || $perfil=="2" || $login=="Demo" || $perfil=="89" ){
    $retornoexiste = 1;
  }



  




  $retornoexiste = 1;


  return $retornoexiste;

  /*

  foreach($arrresultado as $i=>$valor){

    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $usuarioplan_fechaini = utf8_encode($valor["usuarioplan_fechaini"]);
    $usuarioplan_fechafin = utf8_encode($valor["usuarioplan_fechafin"]);

    if ($plan_nombre!=""){
      $infoplan = $plan_nombre."<br>Desde: $usuarioplan_fechaini al $usuarioplan_fechafin";
    }

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $usuariobalance_total = utf8_encode($valor["usuariobalance_total"]);
    $usuariobalance_bloqueado = utf8_encode($valor["usuariobalance_bloqueado"]);
    $usuariobalance_disponible = utf8_encode($valor["usuariobalance_disponible"]);
    $usuariobalance_pendiente = utf8_encode($valor["usuariobalance_pendiente"]);

    if ($usuariobalance_total==""){$usuariobalance_total=0;}
    if ($usuariobalance_bloqueado==""){$usuariobalance_bloqueado=0;}
    if ($usuariobalance_disponible==""){$usuariobalance_disponible=0;}
    if ($usuariobalance_pendiente==""){$usuariobalance_pendiente=0;}

    $usuariobalance_total = number_format($usuariobalance_total,2,",",".");
    $usuariobalance_bloqueado = number_format($usuariobalance_bloqueado,2,",",".");
    $usuariobalance_disponible = number_format($usuariobalance_disponible,2,",",".");
    $usuariobalance_pendiente = number_format($usuariobalance_pendiente,2,",",".");

    $usuariobalance_bloqueado = $usuariobalance_bloqueado." ".$moneda_siglas;
    $usuariobalance_disponible = $usuariobalance_disponible." ".$moneda_siglas;

    $referido_id = utf8_encode($valor["referido_id"]);
    $referido_nombre = utf8_encode($valor["referido_nombre"]);
    $referido_apellido = utf8_encode($valor["referido_apellido"]);
    $referido_email = utf8_encode($valor["referido_email"]);
    $referido_alias = utf8_encode($valor["referido_alias"]);  

    $referido = $referido_nombre." ".$referido_apellido;

    $usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_codigo = utf8_encode($valor["usuario_codigo"]);
    $usuario_email = utf8_encode($valor["usuario_email"]);
    $usuario_clave = utf8_encode($valor["usuario_clave"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_telf = utf8_encode($valor["usuario_telf"]);
    $usuario_whatsapp = utf8_encode($valor["usuario_whatsapp"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $usuario_alias = utf8_encode($valor["usuario_alias"]);
    
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);
    $compania_email = utf8_encode($valor["compania_email"]);
    
    $usuario_fechareg = utf8_encode($valor["usuario_fechareg"]);
    $usuario_activo = utf8_encode($valor["usuario_activo"]);    
    $t_perfil_id = utf8_encode($valor["perfil_id"]);    

    $usuario = $usuario_nombre." ".$usuario_apellido;

    $urlreferido = $compania_urlweb."registro?referido=$usuario_alias";

    if ($usuario_id==$cuenta_id){
       $referidopor  ="
        
      ";
    }else {
      $referidopor  ="
        <h5 style='font-size: 18px'>
            Referido por <a href='perfilnegocio?id=$referido_id' style='font-weight: 600'>
            $referido_alias
          </a>
        </h5>        
      ";
    }
  }

  */

}

function VerificarPermisosPorModdulo($modulo=null){

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("modulo_relmodulo, modulo_padre, modulo_defecto, modulo_sistema, tipomodulo_id, modulo_id, modulo_multiplemenu","modulo","modulo_activo = '1' and modulo_id = '$modulo' ");  
  foreach($arrresultado as $i=>$valor){

    $modulo_id = utf8_encode($valor["modulo_id"]);
    $modulo_relmodulo = utf8_encode($valor["modulo_relmodulo"]);
    $modulo_defecto = utf8_encode($valor["modulo_defecto"]);
    $modulo_sistema = utf8_encode($valor["modulo_sistema"]);
    $tipomodulo_id = utf8_encode($valor["tipomodulo_id"]);
    $modulo_multiplemenu = utf8_encode($valor["modulo_multiplemenu"]);
    $modulo_padre = utf8_encode($valor["modulo_padre"]);

    if ($modulo_padre=="1"){
      $modulo_relmodulo = "";
    }
 
    if ($modulo_multiplemenu=="1"){
      if ($tipomodulo_id=="1"){     
        $_COOKIE[urlmodulo2] = $urlmodulo;    
      }          
    } 
    if ($tipomodulo_id=="1"){     
      $_COOKIE[urlmodulo2] = $urlmodulo;    
    }

    if ($tipomodulo_id=="5"){
       $_COOKIE[urlmodulo2] = "";
    }   
  }  

  if (($modulo_defecto=="1" || $modulo_sistema == "1") && ($_COOKIE[perfil]=="1") ){
    

    //echo 4;
    //exit();

    
  }
  else{
    //echo 5;
    //exit();
    $tienepermisos = 0;

    if ($_COOKIE[perfil]>"2"){
      $wherecompaniacolocar = " and perfilpermiso.compania_id = '$_COOKIE[idcompania]' ";
    }



    $arrresultado = $conexion->doSelect("count(perfilpermiso_id) as total",
      "perfilpermiso",
      "perfilpermiso.perfil_id = '$_COOKIE[perfilactual]' and perfilpermiso.cuenta_id = '$_COOKIE[idcuenta]' $wherecompaniacolocar ");
    $total = 0;
    foreach($arrresultado as $i=>$valor){  
      $total = utf8_encode($valor["total"]);
    }


    if ($total==0){ // Si NO tiene permisos personalizados la empresa para ese perfil se toma en cuenta los principales
      $cuentaidcolocar = "2";
      $companiaidcolocar = "1";
    }else{
      $cuentaidcolocar = $_COOKIE[idcuenta];
      $companiaidcolocar = $_COOKIE[idcompania];
    }

    if ($_COOKIE[perfil]>2){
      $wherecompania = " and perfilpermiso.compania_id = '$companiaidcolocar' ";
    }

    //echo $modulo_id;
    //echo "modulo2_id:".$modulo_id;
    //exit();

    $arrresultado = $conexion->doSelect("perfilpermiso_id, perfilpermiso.perfil_id, perfilpermiso.modulo_id, 
      perfilpermiso.cuenta_id, perfilpermiso.compania_id, perfilpermiso_create, perfilpermiso_read, 
      perfilpermiso_update, perfilpermiso_delete, perfilpermiso_usuario perfilpermiso_all, perfilpermiso_activo, 
      perfilpermiso_eliminado, perfilpermiso_fechareg, perfilpermiso.usuario_idreg, perfilpermiso.tipopermiso_id, 
      modulo_padre, modulo_defecto, modulo_sistema, modulo_relmodulo
      ",
      "perfilpermiso 
        inner join modulo on perfilpermiso.modulo_id = modulo.modulo_id      
      ",
      "perfilpermiso_activo = '1' and modulo.modulo_id = '$modulo_id' 
      and perfilpermiso.perfil_id = '$_COOKIE[perfilactual]' 
      
    ");

    /*
    and perfilpermiso.cuenta_id = '$cuentaidcolocar'
      $wherecompania

    */

    $tienepermiso = 0;

  
  //echo "cuentaidcolocar: $cuentaidcolocar";    
    foreach($arrresultado as $i=>$valor){

      //echo "entra";

      $perfilpermiso_create = utf8_encode($valor["perfilpermiso_create"]);  
      $perfilpermiso_read = utf8_encode($valor["perfilpermiso_read"]);  
      $perfilpermiso_update = utf8_encode($valor["perfilpermiso_update"]);  
      $perfilpermiso_delete = utf8_encode($valor["perfilpermiso_delete"]);  
      $perfilpermiso_all = utf8_encode($valor["perfilpermiso_all"]);
      $perfilpermiso_usuario = utf8_encode($valor["perfilpermiso_usuario"]);

      $modulo_padre = utf8_encode($valor["modulo_padre"]);
      $modulo_defecto = utf8_encode($valor["modulo_defecto"]); 
      $modulo_sistema = utf8_encode($valor["modulo_sistema"]);
      $modulo_relmodulo = utf8_encode($valor["modulo_relmodulo"]);

      $GLOBALS['P_Tod'] = $perfilpermiso_all;

      if ($perfilpermiso_all=="1"){
        $tienepermiso = "1";        
        
      }else{

        if ($perfilpermiso_read =="1"){
          $tienepermiso = "1";
        }      
      }      
      
    }    

   
    }

    return $tienepermiso;
    

  }

function ObtenerListaCiudadesEnvio($cuenta=null, $compania=null, $elementoid=null){
  if ($ordenar=="entero"){
    $orderby = "CAST(lista_nombre AS UNSIGNED)";
  }else{
    $orderby = "listacuenta_nombre";
  }

  $tipolista_id = "92";

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  //$option = "<option value=''>-- Seleccione --</option>";

  if ($listaid_rel!=""){
    $wherelistarel = " and lista.lista_idrel = '$listaid_rel' ";
  }


  if ($cuenta!="" ){
    
      $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
        listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
            "lista                
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 
            ",
            "lista_activo = '1' and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "lista_nombre asc");

      if (count($arrresultado)==0){

         $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
          listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
            "lista                 
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 
            ",
            "lista_activo = '1' $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "lista_nombre asc");


      }

      
    
    foreach($arrresultado as $i=>$valor){

      $lista_id = utf8_encode($valor["lista_id"]);  
      $lista_nombre = utf8_encode($valor["lista_nombre"]);  
      $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
      $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
      $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
      $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  
      $listaciudadenvio_id = utf8_encode($valor["listaciudadenvio_id"]); 

      if ($lista_id==$elementoid){
          $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
      }else{
          $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
      } 

      /*

      if ($listacuenta_id!=""){
        if ($listacuenta_activo=="1"){
          if ($listaciudadenvio_id==$elementoid){
              $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
          }else{
              $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
          }    
        }
      }else{
        if ($listaciudadenvio_id==$elementoid){
            $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
        }else{
            $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
        }    
      }  

      */
    }
  }
  
  if (count($arrresultado)==0 && $compania==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }else if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN VALORES</option>";
  }
 
  return $option;

}


function ListadoPagousuarioCondominioRecibo($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistemawasw
    

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,        

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb, 
    pagocondominiorecibo.condominiorecibo_id, 
    estatus.lista_nombre as estatus_nombre
    ",
    "pago
      inner join pagocondominio on pagocondominio.pago_id = pago.pago_id
      inner join pagocondominiorecibo on pagocondominiorecibo.pagocondominio_id = pagocondominio.pagocondominio_id
      inner join lista moneda on moneda.lista_id = pago.l_moneda_id      
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 



  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);
    $condominiorecibo_id = utf8_encode($valor["condominiorecibo_id"]);


    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);
    $pagoplanmultinivel_id = utf8_encode($valor["pagoplanmultinivel_id"]);  
    $l_plan_id = utf8_encode($valor["l_plan_id"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $pagoplanmultinivel_fechareg = utf8_encode($valor["pagoplanmultinivel_fechareg"]);
    $pagoplanmultinivel_observacion = utf8_encode($valor["pagoplanmultinivel_observacion"]);

    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);    
  

    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $aaa)." ".$moneda_siglas; 

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verpagorecibousuario?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verpagorecibousuario?id=$pago_id'>#$pago_id (Ver)</a>";


    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>            
            <td>$usuario</td>     
            <td>#$condominiorecibo_id</td>               
            <td>$pago_monto</td>         
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}

function ObtenerListaViviendasRecibos($cuentaseleccionada=null, $companiaseleccionada=null,  $getcondominio=null, $condominiorecibo_id=null, $edificio_id=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($_COOKIE[perfil]=="1"){  
    
    
    if ($cuentaseleccionada!=""){
      $where = " and vivienda.cuenta_id = '$cuentaseleccionada' ";     
    } 
    
  } else if ($_COOKIE[perfil]=="2"){   
  
    $where = " and vivienda.cuenta_id = '$_COOKIE[idcuenta]' ";     
    
  } else {
  
    $where = " and vivienda.cuenta_id = '$_COOKIE[idcuenta]' and vivienda.compania_id = '$_COOKIE[idcompania]' ";     
    
  }

  if ($getcondominio!=""){
    $where .= " and vivienda.condominio_id = '$getcondominio' ";
  }

  if ($edificio_id!=""){
    $where .= " and vivienda.edificio_id = '$edificio_id' ";
  }

  
  $arrresultado = $conexion->doSelect("vivienda.vivienda_id, vivienda_numero, condominiorecibousuario_id",
    "vivienda
      left join condominiorecibousuario on condominiorecibousuario.vivienda_id = vivienda.vivienda_id
      and condominiorecibousuario_activo = '1' and condominiorecibo_id = '$condominiorecibo_id'
    ",
    "vivienda_activo = '1' $whereeee", null, "vivienda_numero asc");

  $option = "<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

      $condominiorecibousuario_id = utf8_encode($valor["condominiorecibousuario_id"]);  
      $vivienda_id = utf8_encode($valor["vivienda_id"]);  
      $vivienda_numero = utf8_encode($valor["vivienda_numero"]);        

      if ($condominiorecibousuario_id!=""){
        $option .= "<option selected='selected' value='$vivienda_id'>$vivienda_numero</option>";
      }else{
        $option .= "<option value='$vivienda_id'>$vivienda_numero</option>";
      }
     
  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN VIVIENDAS</option>";
  } 

  return $option;

}

function ResumenPagosUsuariosCondominio($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $getdate=null, $moduloresumen_id=null, $estatus=null){

  $arrresultado = ListaModulosResumenPorId($cuentaseleccionada, $companiaseleccionada, $moduloresumen_id);
  foreach($arrresultado as $i=>$valor){  
    $modulo_url = utf8_encode($valor["modulo_url"]);    
    $moduloresumen_titulo = utf8_encode($valor["moduloresumen_titulo"]);
    $moduloresumen_backcolor = utf8_encode($valor["moduloresumen_backcolor"]);
    $moduloresumen_bordercolor = utf8_encode($valor["moduloresumen_bordercolor"]);
    $moduloresumen_icono = utf8_encode($valor["moduloresumen_icono"]);   

    $modulo_url = str_replace(".php","",$modulo_url);

  }


  if ($moduloresumen_titulo!=""){

    $fechaactual = formatoFechaHoraBd(1);    

    if ($fechadesde=="" && $fechahasta==""){
      $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
    } else if ($fechadesde!="" && $fechahasta!=""){
      $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
    } else if ($fechadesde!=""){
      $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
    } else if ($fechahasta!=""){
      $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
    }


  if ($estatus!=""){
    $whereestatus =" and pago.l_estatus_id = '$estatus' ";
    $agregarurlir="&e=$estatus";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]'  ";

  } 


  $conexion = new ConexionBd();

   $arrresultado = $conexion->doSelect("count(*) as total
    ",
    "pago
      inner join pagoplancondominio on pagoplancondominio.pago_id = pago.pago_id
      left join lista moneda on moneda.lista_id = pago.l_moneda_id
      inner join lista plan on plan.lista_id = pagoplancondominio.l_plan_id
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id

    ",
    "pago_eliminado = '0' $whereestatus $wherefecha $where "); 

    foreach($arrresultado as $i=>$valor){  
        $total = utf8_encode($valor["total"]); 
    }

    $stylebackground = "";
    if($moduloresumen_backcolor!="" && $moduloresumen_backcolor!="0"){
      $stylebackground = " style='background: $moduloresumen_backcolor' ";
    }                                   

  $divresumen  .="
      <div class='col-lg-3 col-sm-6 col-xs-12'>      
        <div class='small-box div_accesodirecto' $stylebackground>
          <div class='inner'>
            <a href='$modulo_url?date=$getdate$agregarurlir'><h3>$total</h3></a>
            <a href='$modulo_url?date=$getdate$agregarurlir'><p>$moduloresumen_titulo $moduloresumen_backcolor </p></a>
          </div>
          <div class='icon'>
            <a href='$modulo_url?date=$getdate$agregarurlir'>
              <i class='$moduloresumen_icono'></i>
            </a>
          </div>
          <a href='$modulo_url?date=$getdate$agregarurlir' class='small-box-footer'>Ver &nbsp <i class='fa fa-arrow-circle-right'></i></a>
        </div>
      </div>
    ";   

  }


  return $divresumen;

}



function ListadoPagousuarioCondominio($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,    

    plan.lista_nombre as plan_nombre, estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb

    ",
    "pago
      inner join pagoplancondominio on pagoplancondominio.pago_id = pago.pago_id
      left join lista moneda on moneda.lista_id = pago.l_moneda_id
      inner join lista plan on plan.lista_id = pagoplancondominio.l_plan_id
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 



  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);
    $pagoplanmultinivel_id = utf8_encode($valor["pagoplanmultinivel_id"]);  
    $l_plan_id = utf8_encode($valor["l_plan_id"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $pagoplanmultinivel_fechareg = utf8_encode($valor["pagoplanmultinivel_fechareg"]);
    $pagoplanmultinivel_observacion = utf8_encode($valor["pagoplanmultinivel_observacion"]);

    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    

    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $aaa); 

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verpagocondominio?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verpagocondominio?id=$pago_id'>#$pago_id (Ver)</a>";


    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>            
            <td>$usuario</td>     
            <td>$plan_nombre</td>               
            <td>$pago_monto $moneda_siglas</td>         
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}

function ObtenerListaPlanesCondominios($cuentaseleccionada=null, $companiaseleccionada=null, $usuario_idget =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and listaplancondominio.cuenta_id = '$_COOKIE[idcuenta]' ";          


  }  else { 

    $where = " and listaplancondominio.cuenta_id = '$_COOKIE[idcuenta]' and listaplancondominio.compania_id = '$_COOKIE[idcompania]' ";
    $wherelistaactivo = " and plan.lista_activo = '1' ";
  } 


  $arrresultado = $conexion->doSelect("

    listaplancondominio.listaplancond_id, listaplancondominio.l_plancond_id, 
    listaplancondominio.l_moneda_id, listaplancondominio.listaplancond_precio, 
    listaplancondominio.listaplancond_porccomision, listaplancondominio.listaplancond_contactos, 
    listaplancondominio.listaplancond_diasduracion, 
    listaplancondominio.listaplancond_habiltarminutos, listaplancondominio.listaplancond_notifwhatsapp, 
    listaplancondominio.cuenta_id, listaplancondominio.compania_id, 
    listaplancondominio.listaplancond_fechareg, listaplancondominio.usuario_idreg, 
    listaplancondominio.listaplancond_url,

    plan.lista_id as plan_id, plan.lista_nombre as plan_nombre, plan.lista_img as plan_img,
    plan.lista_orden as plan_orden, plan.lista_activo as plan_activo,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    listaplanconddet_id, listaplanconddet_descrip, listaplanconddet_orden, listaplanconddet_activo,

    moneda.lista_nombredos as moneda_siglas

      ",
    "
    listaplancondominio
        inner join lista plan on plan.lista_id = listaplancondominio.l_plancond_id          
        inner join usuario cuenta on cuenta.usuario_id = listaplancondominio.cuenta_id
        inner join compania on compania.compania_id = listaplancondominio.compania_id  


        left join lista moneda on moneda.lista_id = listaplancondominio.l_moneda_id       
        left join listaplancondominiodetalle on listaplancondominiodetalle.l_plan_id = plan.lista_id 
        and listaplanconddet_activo = '1'
    ",
    " plan.lista_activo = '1' $where  $wherelistaactivo", null, "plan.lista_orden, plan.lista_id, listaplancondominiodetalle.listaplanconddet_orden  asc");

  $cont = 0;
  foreach($arrresultado as $i=>$valor){

    $plan_id = utf8_encode($valor["plan_id"]);

    if ($plan_id_old!=$plan_id && $cont!="0"){   

      $planeshtml .= "
        <div class='col-lg-4 col-md-6' style='margin-bottom: 15px;'>
            <div class='package-content bg-light border text-center p-2 my-2 my-lg-0' style='background: #FFF; padding: 20px'>
                <div class='package-content-heading border-bottom'>
                    <a href='adquirirplancondominioformapago?id=$plan_id_old'>
                      <center>
                          <img src='$urlimgPlan' class='img-responsive' style='height:140px' />
                      </center>
                      <h2 style='padding-top: 10px; padding-bottom: 4px'>$plan_nombre</h2>
                      $divprecio
                    </a>
                </div>
                <ul style='padding-left: 0px; list-style:none'>
                    $plandetallehtml
                </ul>
                <a href='adquirirplancondominioformapago?id=$plan_id_old' class='btn btn-primary' style='margin-top: 5px'>Adquirir</a>
                
            </div>
        </div>
       
      ";

       $plandetallehtml ="";

    }

    $listaplancond_id = utf8_encode($valor["listaplancond_id"]);
    $l_plancond_id = utf8_encode($valor["l_plancond_id"]);
    $listaplancond_precio = utf8_encode($valor["listaplancond_precio"]);
    $listaplancond_porccomision = utf8_encode($valor["listaplancond_porccomision"]);
    $listaplancond_contactos = utf8_encode($valor["listaplancond_contactos"]);
    $listaplancond_diasduracion = utf8_encode($valor["listaplancond_diasduracion"]);
    $listaplancond_habiltarminutos = utf8_encode($valor["listaplancond_habiltarminutos"]);
    $listaplancond_notifwhatsapp = utf8_encode($valor["listaplancond_notifwhatsapp"]);
    $listaplancond_url = utf8_encode($valor["listaplancond_url"]);
    $listaplancond_id = utf8_encode($valor["listaplancond_id"]);

    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);    

    $listaplanconddet_id = utf8_encode($valor["listaplanconddet_id"]);
    $listaplanconddet_descrip = utf8_encode($valor["listaplanconddet_descrip"]);
    $listaplanconddet_orden = utf8_encode($valor["listaplanconddet_orden"]);
    $listaplanconddet_activo = utf8_encode($valor["listaplanconddet_activo"]);
    
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);        
    
    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $plan_img = utf8_encode($valor["plan_img"]);  
    $plan_orden = utf8_encode($valor["plan_orden"]);  
    $plan_activo = utf8_encode($valor["plan_activo"]);  

    $urlimgPlan = "arch/$plan_img";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $listaplancond_precioorig = $listaplancond_precio;

    if ($listaplancond_precio==""){$listaplancond_precio=0;}
    
    $listaplancond_precio = number_format_personalizado($listaplancond_precio,$moneda_siglas);

    if ($listaplancond_precioorig=="0" || $listaplancond_precioorig==""){
      $divprecio = "
        <h4 class='py-0' style='font-size: 20px; line-height: 30px'>         
          
        </h4>
      ";
      $divcontratar = "
        
      ";
    }else{
      $divprecio = "
        <h4 class='py-0' style='font-size: 20px; line-height: 30px'> 
          <span style='font-size: 20px'>$listaplancond_precio $moneda_siglas /$listaplanmultinivel_diasduracion días</span> <br>
        </h4>
      ";

      $divcontratar = "
        <a href='plan-forma-pago?id=$plan_id' class='btn btn-success' style='margin-top: 5px'>Contratar</a>
      ";
    }

    $plandetallehtml .= "
          <li class='my-4'> $listaplanservdet_descrip</li>
      ";

    $plan_id_old = $plan_id;

    $cont = $cont +1;

  }


  if ($plandetallehtml!=""){
    $planeshtml .= "
        <div class='col-lg-4 col-md-6' style='margin-bottom: 15px;'>
            <div class='package-content bg-light border text-center p-2 my-2 my-lg-0' style='background: #FFF; padding: 20px'>
                <div class='package-content-heading border-bottom'>
                    <a href='adquirirplancondominioformapago?id=$plan_id'>
                      <center>
                          <img src='$urlimgPlan' class='img-responsive' style='height:140px' />
                      </center>
                      <h2 style='padding-top: 10px; padding-bottom: 4px'>$plan_nombre</h2>
                      $divprecio
                    </a>
                </div>
                <ul style='padding-left: 0px; list-style:none'>
                    $plandetallehtml
                </ul>
                <a href='adquirirplancondominioformapago?id=$plan_id' class='btn btn-primary' style='margin-top: 5px'>Adquirir</a>
                
            </div>
        </div>
      ";
  }

  if ($planeshtml!=""){

    $planeshtml = "

    <div class='col-md-12'>
        <h3>Seleccione el plan que desea </h3>  
    </div>    

    $planeshtml
    ";
  }

  return $planeshtml;

}

function ObtenerMonedaPrincipalId($cuentaseleccionada=null, $companiaseleccionada=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    $where = " and listaconfig.cuenta_id = '$cuentaseleccionada'";
  } else {
    $where = " and listaconfig.cuenta_id = '$cuentaseleccionada' and listaconfig.compania_id = '$companiaseleccionada' ";
  }

  
    
  $arrresultado = $conexion->doSelect("listaconfig_valoruno",
    "
    listaconfig
    ",
    "listaconfig_activo = '1' and tipolista_id = '12' $where");
      
  foreach($arrresultado as $i=>$valor){

    $listaconfig_valoruno = utf8_encode($valor["listaconfig_valoruno"]);  

    if ($listaconfig_valoruno!=""){
      $lista_id = $listaconfig_valoruno;
    }
  }

  if ($lista_id==""){
    $lista_id = "0";
  }

  

  return $lista_id;

}

function ObtenerListaPropietarios($cuentaseleccionada=null, $companiaseleccionada=null, $condominio =null, $propietarioseleccionado=null, $solopropietario=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

    if ($solopropietario=="1"){
      $wherepropietario = " and usuario.usuario_id = '$propietarioseleccionado' ";
    }
      
     $arrresultado = $conexion->doSelect("usuario.usuario_id, usuario_nombre, usuario_apellido",
        "usuario
          inner join perfil on perfil.perfil_id = usuario.perfil_id
        ",
        "usuario_activo = '1'  $wherepropietario and perfil.perfil_idorig = '82' and usuario.cuenta_id = '$cuentaseleccionada' and usuario.compania_id = '$companiaseleccionada'", null, "usuario_nombre, usuario_apellido asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

        $usuario_id = utf8_encode($valor["usuario_id"]);
        $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
        $usuario_apellido = utf8_encode($valor["usuario_apellido"]);

        if ($propietarioseleccionado==$usuario_id){
              $option .= "<option selected='selected' value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
          }else{
              $option .= "<option value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
          }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN PROPIETARIOS</option>";
      }

      if (count($arrresultado)==1){
        $option = "<option selected='selected' value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
      } 
  }
  

  return $option;

}

function ObtenerListaViviendas($cuentaseleccionada=null, $companiaseleccionada=null,  $getcondominio=null, $getelemento=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($_COOKIE[perfil]=="1"){  
    
    
    if ($cuentaseleccionada!=""){
      $where = " and vivienda.cuenta_id = '$cuentaseleccionada' ";     
    } 
    
  } else if ($_COOKIE[perfil]=="2"){   
  
    $where = " and vivienda.cuenta_id = '$_COOKIE[idcuenta]' ";     
    
  } else {
  
    $where = " and vivienda.cuenta_id = '$_COOKIE[idcuenta]' and vivienda.compania_id = '$_COOKIE[idcompania]' ";     
    
  }

  if ($getcondominio!=""){
    $where .= " and vivienda.condominio_id = '$getcondominio' ";
  }

  
  $arrresultado = $conexion->doSelect("vivienda_id, vivienda_numero",
    "vivienda",
    "vivienda_activo = '1' $where", null, "vivienda_numero asc");

  $option = "<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

      $vivienda_id = utf8_encode($valor["vivienda_id"]);  
      $vivienda_numero = utf8_encode($valor["vivienda_numero"]);        

      if ($getelemento==$vivienda_id){
        $option .= "<option selected='selected' value='$vivienda_id'>$vivienda_numero</option>";
      }else{
        $option .= "<option value='$vivienda_id'>$vivienda_numero</option>";
      }
     
  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN VIVIENDAS</option>";
  }

  return $option;

}

function ObtenerListaEdificios($cuentaseleccionada=null, $companiaseleccionada=null, $getelemento=null, $getcondominio=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($_COOKIE[perfil]=="1"){  
    
    
    if ($cuentaseleccionada!=""){
      $where = " and edificio.cuenta_id = '$cuentaseleccionada' ";     
    } 
    
  } else if ($_COOKIE[perfil]=="2"){   
  
    $where = " and edificio.cuenta_id = '$_COOKIE[idcuenta]' ";     
    
  } else {
  
    $where = " and edificio.cuenta_id = '$_COOKIE[idcuenta]' and edificio.compania_id = '$_COOKIE[idcompania]' ";     
    
  }

  if ($getcondominio!=""){
    $where .= " and edificio.condominio_id = '$getcondominio' ";
  }

  
  $arrresultado = $conexion->doSelect("edificio_id, edificio_nombre",
    "edificio",
    "edificio_activo = '1' $where", null, "edificio_nombre asc");

  $option = "<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

      $edificio_id = utf8_encode($valor["edificio_id"]);  
      $edificio_nombre = utf8_encode($valor["edificio_nombre"]);        

      if ($getelemento==$edificio_id){
        $option .= "<option selected='selected' value='$edificio_id'>$edificio_nombre</option>";
      }else{
        $option .= "<option value='$edificio_id'>$edificio_nombre</option>";
      }
     
  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN EDIFICIOS</option>";
  }

  return $option;

}

function ObtenerListaCondominios($cuentaseleccionada=null, $companiaseleccionada=null, $getelemento=null, $marcarunico = null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];


  
  if ($_COOKIE[perfil]=="1"){  
    
    
    if ($cuentaseleccionada!=""){
      $where = " and condominio.cuenta_id = '$cuentaseleccionada' ";     
    } 
    
  } else if ($_COOKIE[perfil]=="2"){   
  
    $where = " and condominio.cuenta_id = '$_COOKIE[idcuenta]' ";     
    
  } else if ($_COOKIE[perfil]=="3"){   
  
    $where = " and condominio.cuenta_id = '$_COOKIE[idcuenta]' and condominio.compania_id = '$_COOKIE[idcompania]' ";     
    
  } else if ($_COOKIE[perfil]=="80"){   
  
    $where = " and condominio.cuenta_id = '$_COOKIE[idcuenta]' ";     

    $innerjoin ="
      inner join usuariocondominio on usuariocondominio.condominio_id = condominio.condominio_id
      and usuariocondominio.usuario_id = '$_COOKIE[iniuser]' and usuariocondominio_activo = '1'
    ";

    
  } else if ($_COOKIE[perfil]=="82"){   // Propietario


  
    $where = " and condominio.cuenta_id = '$_COOKIE[idcuenta]' and condominio.compania_id = '$_COOKIE[idcompania]'  ";     

    $innerjoin ="
      inner join usuariocondominio on usuariocondominio.condominio_id = condominio.condominio_id
      and usuariocondominio.usuario_id = '$_COOKIE[iniuser]' and usuariocondominio_activo = '1'
    ";

    


    
  } else {
  
    $where = " and condominio.cuenta_id = '$_COOKIE[idcuenta]' and condominio.compania_id = '$_COOKIE[idcompania]'  ";     

    $innerjoin ="
      inner join usuariocondominio on usuariocondominio.condominio_id = condominio.condominio_id
      and usuariocondominio.usuario_id = '$_COOKIE[iniuser]' and usuariocondominio_activo = '1'
    ";
    
  }

  $marcarunico = 1;

  
  $arrresultado = $conexion->doSelect("condominio.condominio_id, condominio_nombre",
    "condominio
      $innerjoinn
    ",
    "condominio_activo = '1' $where", null, "condominio_nombre asc");

  $option = "<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

      $condominio_id = utf8_encode($valor["condominio_id"]);  
      $condominio_nombre = utf8_encode($valor["condominio_nombre"]);  
      $tipolistarel_id = utf8_encode($valor["tipolistarel_id"]);  

      if ($getelemento==$condominio_id){
        $option .= "<option selected='selected' value='$condominio_id'>$condominio_nombre</option>";
      }else{
        $option .= "<option value='$condominio_id'>$condominio_nombre</option>";
      }
     
  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN CONDOMINIOS</option>";
  }

  if ($marcarunico==1){
    if (count($arrresultado)==1){
      $option = "<option  value='$condominio_id' selected='selected'>$condominio_nombre</option>"; 
    }
    
  }

  return $option;

}

function ListadoDominios($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (dominio_fechaconsulta BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (dominio_fechaconsulta BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (dominio_fechaconsulta > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (dominio_fechaconsulta BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  //echo $wherefecha;
  //exit();

  if ($estatusseleccionado!=""){
    $whereestatus =" and dominio.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and dominio.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and dominio.cuenta_id = '$_COOKIE[idcuenta]' and dominio.compania_id = '$_COOKIE[idcompania]'  ";

  } 

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("

    dominio.dominio_id, dominio.dominio_url, 
    dominio.l_estatus_id, dominio.dominio_activo, 
    dominio.dominio_eliminado, 
    dominio.dominio_fechareg, dominio.cuenta_id, dominio.compania_id,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, 
    compania.compania_nombre as compania_nombre,

    estatus.lista_nombre as estatus_nombre,

    DATE_FORMAT(dominio_fechaconsulta,'%d/%m/%Y %H:%i') as dominio_fechaconsulta,
    DATE_FORMAT(dominio_fechaexpiracion,'%d/%m/%Y %H:%i') as dominio_fechaexpiracion

      ",
    "
    dominio 

      inner join usuario cuenta on cuenta.usuario_id = dominio.cuenta_id
      inner join compania on compania.compania_id = dominio.compania_id
      inner join lista estatus on estatus.lista_id = dominio.l_estatus_id
    ",
    "dominio_eliminado = '0' $where $whereestatus $wherefecha", null, "dominio.dominio_id desc");


  foreach($arrresultado as $i=>$valor){
  
    $dominio_id = utf8_encode($valor["dominio_id"]);  
    $dominio_url = utf8_encode($valor["dominio_url"]);  
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);  
    $dominio_activo = utf8_encode($valor["dominio_activo"]);  
    $dominio_fechaconsulta = utf8_encode($valor["dominio_fechaconsulta"]);
    $dominio_fechaexpiracion = utf8_encode($valor["dominio_fechaexpiracion"]);  
    
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);  
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);  
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);  

    $cuenta = $cuenta_nombre." ".$cuenta_apellido;
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);  

  
    if ($dominio_activo=="0"){
      $activo = "<i onclick='cambiarestatusdominio(\"".$dominio_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusdominio(\"".$dominio_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminardominio(\"".$dominio_id."\")' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";  

  
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }


    $textohtml .= "
           <tr>               
              $mostrarcolumnacuenta
              $mostrarcolumnacompania           
              <td>$dominio_url </td>           
              <td>$estatus_nombre </td>           
              <td>$dominio_fechaexpiracion </td>           
              <td>$dominio_fechaconsulta </td>                             
              <td style='text-align: center'>$accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}
  

function ListadoUsuariosAfiliado($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and usuarioperfil.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and usuarioperfil.cuenta_id = '$_COOKIE[idcuenta]' and usuarioperfil.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if($getestatus!=""){
    $whereestatus = " and usuarioperfil.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("usuarioperfil.usuario_id, usuarioperfil.usuario_codigo, usuarioperfil.usuario_email, usuarioperfil.usuario_clave, 
      usuarioperfil.usuario_nombre, usuarioperfil.usuario_apellido, usuarioperfil.usuario_telf,  usuarioperfil.usuario_activo, 
      usuarioperfil.usuario_eliminado, usuarioperfil.usuario_documento, usuarioperfil.usuario_img, usuarioperfil.perfil_id,
      usuarioperfil.usuario_direccion, usuarioperfil.usuario_localidad, usuarioperfil.usuario_actividad, usuarioperfil.nacionalidad_id,
      usuarioperfil.sexo_id, usuarioperfil.e_estadocivil_id, usuarioperfil.usuario_conyugenombre, usuarioperfil.usuario_conyugetelf,
      usuarioperfil.usuario_pariente, usuarioperfil.usuario_parientetelf, usuarioperfil.e_parentesco_id, usuarioperfil.usuario_telfdos, 
      usuarioperfil.usuario_notas, usuarioperfil.usuario_porcentajecolocador, usuarioperfil.usuario_balance, usuarioperfil.usuario_comentarios, 
      DATE_FORMAT(usuarioperfil.usuario_fechanac,'%d/%m/%Y') as usuario_fechanac, usuarioperfil.nivelriesgo_id,
      usuarioperfil.l_tipodocumento_id,
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre, compania_urlweb,
      DATE_FORMAT(usuarioperfil.usuario_fechareg,'%d/%m/%Y %H:%i:%s') as usuario_fechareg,
      perfil_nombre,       
      usuarioperfil.l_estatus_id, estatus.lista_nombre as estatus_nombre

      ",
    "usuario usuarioperfil
        inner join usuario cuenta on usuarioperfil.cuenta_id = cuenta.usuario_id
        inner join compania on compania.compania_id = usuarioperfil.compania_id
        inner join perfil on usuarioperfil.perfil_id = perfil.perfil_id
        
        left join lista estatus on estatus.lista_id = usuarioperfil.l_estatus_id
    ",
    "usuarioperfil.usuario_eliminado = '0' and usuarioperfil.perfil_id = '75'  $where $whereestatus $whereperfil  $wherefecha ", null, "usuarioperfil.usuario_id desc");
  foreach($arrresultado as $i=>$valor){

    $tipousuarioservicio_nombre = utf8_encode($valor["tipousuarioservicio_nombre"]);

    $t_perfil_id = utf8_encode($valor["perfil_id"]);
    $perfil_nombre = utf8_encode($valor["perfil_nombre"]);

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_codigo = utf8_encode($valor["usuario_codigo"]);
    $usuario_email = utf8_encode($valor["usuario_email"]);
    $usuario_clave = utf8_encode($valor["usuario_clave"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_telf = utf8_encode($valor["usuario_telf"]);
    $usuario_fechareg = utf8_encode($valor["usuario_fechareg"]);
    $usuario_activo = utf8_encode($valor["usuario_activo"]);
    $usuario_documento = utf8_encode($valor["usuario_documento"]);  
    
    $usuario_direccion = utf8_encode($valor["usuario_direccion"]);
    $usuario_localidad = utf8_encode($valor["usuario_localidad"]);
    $usuario_actividad = utf8_encode($valor["usuario_actividad"]);
    $t_nacionalidad_id = utf8_encode($valor["nacionalidad_id"]);
    $t_sexo_id = utf8_encode($valor["sexo_id"]);
    $e_estadocivil_id = utf8_encode($valor["e_estadocivil_id"]);  
    $usuario_conyugenombre = utf8_encode($valor["usuario_conyugenombre"]);
    $usuario_conyugetelf = utf8_encode($valor["usuario_conyugetelf"]);
    $usuario_pariente = utf8_encode($valor["usuario_pariente"]);
    $usuario_parientetelf = utf8_encode($valor["usuario_parientetelf"]);
    $e_parentesco_id = utf8_encode($valor["e_parentesco_id"]);
    $usuario_telfdos = utf8_encode($valor["usuario_telfdos"]);
    $usuario_notas = utf8_encode($valor["usuario_notas"]);
    $usuario_porcentajecolocador = utf8_encode($valor["usuario_porcentajecolocador"]);
    $usuario_balance = utf8_encode($valor["usuario_balance"]);
    $usuario_comentarios = utf8_encode($valor["usuario_comentarios"]);
    $usuario_tasapref = utf8_encode($valor["usuario_tasapref"]);
    $usuario_fechanac = utf8_encode($valor["usuario_fechanac"]);
    $t_nivelriesgo_id = utf8_encode($valor["nivelriesgo_id"]);
    
      $compania_nombre = utf8_encode($valor["compania_nombre"]);
      $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    if ($usuario_id!= "1"){
      if ($usuario_activo=="0"){
        $activo = "<i onclick='cambiarestatususuario(\"".$usuario_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
      }else{
        $activo = "<i onclick='cambiarestatususuario(\"".$usuario_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
      }
      
      $accioneliminar = "<i onclick='eliminarusuario(\"".$usuario_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    }

    $verperfil = "<a href='modificarusuarioafiliado?id=$usuario_id'>
      <span style='color: #000'>$usuario_nombre $usuario_apellido</span>
    </a>";
    
    
    $modificar = "<a href='modificarusuarioafiliado?id=$usuario_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }


    $textohtml .= "
           <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania            
            <td>$verperfil</td>            
            <td>$usuario_email</td>
            <td>$usuario_documento</td>
            <td>$usuario_telf</td>
            <td>$usuario_direccion</td>  
            <td>$estatus_nombre</td>  
            <td>$usuario_fechareg</td>  
            <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
              </tr>
        ";

  }

  return $textohtml;

}

function ListadoAlquilerResumenCantidad($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null, $sucursales=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (trans_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  //echo $wherefecha;
  //exit();

  if ($estatusseleccionado!=""){
    $whereestatus =" and transaccion.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' and trans_activo = '1' ";

  } 


  if ($sucursales!=""){
    $wheresucursal = " and transaccion.sucursal_id in ($sucursales)";
  }

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("count(*) as total, prod_nombre
    ",
    "transaccion    
      inner join transaccionalquiler on transaccionalquiler.trans_id = transaccion.trans_id
      inner join transacciondetalle on transacciondetalle.trans_id = transaccion.trans_id
      inner join producto on transacciondetalle.prod_id =  producto.prod_id                    
      inner join usuario on transaccion.cliente_id = usuario.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = transaccion.cuenta_id
      inner join compania on compania.compania_id = transaccion.compania_id 
      inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id 
      inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
      inner join sucursal on sucursal.sucursal_id = transaccion.sucursal_id
      left join lista formadepago on formadepago.lista_id = transaccion.l_formapago_id 
    ",
    "trans_eliminado = '0'  $where $whereestatus $wherefecha $wheresucursal ", "prod_nombre", "total desc");
  foreach($arrresultado as $i=>$valor){

    $total = utf8_encode($valor["total"]);
    $prod_nombre = utf8_encode($valor["prod_nombre"]);

    $divtotales .="
    <tr>
      <td  style='text-align: center;'>$total</td>
      <td>$prod_nombre</td>                        
    </tr>
    ";

  }


  return $divtotales;

}


function ListadoAlquilerResumenHora($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null, $sucursales=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (trans_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  //echo $wherefecha;
  //exit();

  if ($estatusseleccionado!=""){
    $whereestatus =" and transaccion.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' and trans_activo = '1' ";

  } 


  if ($sucursales!=""){
    $wheresucursal = " and transaccion.sucursal_id in ($sucursales)";
  }

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("sum(transalquiler_hora) as totalhoras, prod_nombre
    ",
    "transaccion    
      inner join transaccionalquiler on transaccionalquiler.trans_id = transaccion.trans_id
      inner join transacciondetalle on transacciondetalle.trans_id = transaccion.trans_id
      inner join producto on transacciondetalle.prod_id =  producto.prod_id                    
      inner join usuario on transaccion.cliente_id = usuario.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = transaccion.cuenta_id
      inner join compania on compania.compania_id = transaccion.compania_id 
      inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id 
      inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
      inner join sucursal on sucursal.sucursal_id = transaccion.sucursal_id
      left join lista formadepago on formadepago.lista_id = transaccion.l_formapago_id 
    ",
    "trans_eliminado = '0'  $where $whereestatus $wherefecha $wheresucursal ", "prod_nombre", "totalhoras desc");
  foreach($arrresultado as $i=>$valor){

    $totalhoras = utf8_encode($valor["totalhoras"]);
    $prod_nombre = utf8_encode($valor["prod_nombre"]);

    $divtotales .="
    <tr>
      <td  style='text-align: center;'>$totalhoras</td>
      <td>$prod_nombre</td>                        
    </tr>
    ";

  }


  return $divtotales;

}



// function ListadoAlquiler($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null, $sucursales=null){

//   $fechaactual = formatoFechaHoraBd(1);    

//   if ($fechadesde=="" && $fechahasta==""){
//     $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
//   } else if ($fechadesde!="" && $fechahasta!=""){
//     $wherefecha = " and (trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
//   } else if ($fechadesde!=""){
//     $wherefecha = " and (trans_fechareg > '$fechadesde 00:00:00' ) ";  
//   } else if ($fechahasta!=""){
//     $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
//   }


//   if ($estatusseleccionado!=""){
//     $whereestatus =" and transaccion.l_estatus_id = '$estatusseleccionado' ";
//   }

//   if ($ultimosregistros!=""){
//     $limitregistros =" LIMIT $ultimosregistros";
//   }

//   if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
//     $where = "";
//     $columnacuenta = "<th>Cuenta</th>";
//     $columnacompania = "<th>Compañia</th>";

//   } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
//       $columnacompania = "<th>Compañia</th>";
//       $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

//   }  else { 

//     $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' and trans_activo = '1' ";

//   } 


//   if ($sucursales!=""){
//     $wheresucursal = " and transaccion.sucursal_id in ($sucursales)";
//   }

//   $conexion = new ConexionBd();

//   $arrresultado = $conexion->doSelect("transaccion.trans_id, trans_montosub, trans_montoiva, trans_montototal, trans_codigo, 
//     trans_observ, trans_fechavenc, transaccion.compania_id, transaccion.l_moneda_id, trans_tipocambio, 
//     transaccion.l_formapago_id, transaccion.cliente_id, 
//     DATE_FORMAT(trans_fechareg,'%d/%m/%Y %H:%i:%s') as trans_fechareg, usuario.usuario_nombre, usuario.usuario_apellido, 
//     trans_activo, transaccion.cuenta_id,
//     cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
//       cuenta.usuario_apellido as cuenta_apellido, compania_nombre, 
//       estatus.lista_nombre as estatus_nombre, transaccion.l_estatus_id, 
//         formadepago.lista_nombre as formadepago_nombre, DATE_FORMAT(trans_fecha,'%d/%m/%Y') as trans_fecha, trans_montoganancia,
//         moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas,
//         estatus.lista_cod as estatus_codigo, estatus.lista_color as estatus_color, 
//         DATE_FORMAT(transalquiler_fechaini,'%H:%i:%s') as transalquiler_fechaini,
//         DATE_FORMAT(transalquiler_fechafin,'%H:%i:%s') as transalquiler_fechafin,       

//         DATE_FORMAT(transalquiler_fechaini,'%Y-%m-%d %H:%i:%s') as transalquiler_fechainicompleta,
//         DATE_FORMAT(transalquiler_fechafin,'%Y-%m-%d %H:%i:%s') as transalquiler_fechafincompleta,       


//         transalquiler_hora, 
//         prod_nombre, prod_img, 
//         transacciondetalle.transdet_id, 
//         sucursal_nombre
//     ",
//     "transaccion    
//       inner join transaccionalquiler on transaccionalquiler.trans_id = transaccion.trans_id
//       inner join transacciondetalle on transacciondetalle.trans_id = transaccion.trans_id
//       inner join producto on transacciondetalle.prod_id =  producto.prod_id                    
//       inner join usuario on transaccion.cliente_id = usuario.usuario_id
//       inner join usuario cuenta on cuenta.usuario_id = transaccion.cuenta_id
//       inner join compania on compania.compania_id = transaccion.compania_id 
//       inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id 
//       inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id
//       inner join sucursal on sucursal.sucursal_id = transaccion.sucursal_id
//       left join lista formadepago on formadepago.lista_id = transaccion.l_formapago_id 
      
      
      
//     ",
//     "trans_eliminado = '0'  $where $whereestatus $wherefecha $wheresucursal ", null, "transaccion.trans_id desc");
//   foreach($arrresultado as $i=>$valor){

//     $sucursal_nombre = utf8_encode($valor["sucursal_nombre"]);

//     $transdet_id = utf8_encode($valor["transdet_id"]);
//     $prod_nombre = utf8_encode($valor["prod_nombre"]);
//     $prod_img = utf8_encode($valor["prod_img"]);
//     $transalquiler_fechaini = utf8_encode($valor["transalquiler_fechaini"]);
//     $transalquiler_fechafin = utf8_encode($valor["transalquiler_fechafin"]);
//     $transalquiler_fechainicompleta = utf8_encode($valor["transalquiler_fechainicompleta"]);
//     $transalquiler_fechafincompleta = utf8_encode($valor["transalquiler_fechafincompleta"]);
//     $transalquiler_hora = utf8_encode($valor["transalquiler_hora"]);

//     $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
//     $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

//       $formadepago_nombre = utf8_encode($valor["formadepago_nombre"]);
//       $trans_montoganancia = utf8_encode($valor["trans_montoganancia"]);
//     $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
//     $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
//     $estatus_codigo = utf8_encode($valor["estatus_codigo"]);
//     $estatus_color = utf8_encode($valor["estatus_color"]);

//     $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
//     $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
//     $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

//     $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

//     $compania_nombre = utf8_encode($valor["compania_nombre"]);

//     $trans_id = utf8_encode($valor["trans_id"]);
//     $trans_montosub = utf8_encode($valor["trans_montosub"]);
//       $transventa_porciva = utf8_encode($valor["transventa_porciva"]);
//     $trans_montoiva = utf8_encode($valor["trans_montoiva"]);
//     $trans_montototal = utf8_encode($valor["trans_montototal"]);
//     $trans_codigo = utf8_encode($valor["trans_codigo"]);
//     $trans_observ = utf8_encode($valor["trans_observ"]);
//     $trans_fechavenc = utf8_encode($valor["trans_fechavenc"]);
//     $t_usuario_id = utf8_encode($valor["usuario_id"]);
//     $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
//     $t_compania_id = utf8_encode($valor["compania_id"]);
//     $t_l_moneda_id = utf8_encode($valor["l_moneda_id"]);
//     $trans_tipocambio = utf8_encode($valor["trans_tipocambio"]);
//     $t_formapago_id = utf8_encode($valor["formapago_id"]);
//     $t_cliente_id = utf8_encode($valor["cliente_id"]);
//     $t_l_tipofactura_id = utf8_encode($valor["l_tipofactura_id"]);
//     $trans_fechareg = utf8_encode($valor["trans_fechareg"]);
//     $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
//     $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
//     $trans_activo = utf8_encode($valor["trans_activo"]);
//     $trans_fecha = utf8_encode($valor["trans_fecha"]);

    
//     if ($trans_activo=="0"){
//       $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
//     }else{
//       $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
//     }
    
//     $accioneliminar = "<i onclick='eliminartransaccion(\"".$trans_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
//     $modificar = "<a href='registraralquiler?id=$trans_id&cu=$t_cuenta_id&co=$t_compania_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

//     $moduloidchat = "51";
//     $mensajes = "<a href='mensajedetalle?mid=$moduloidchat&id=$trans_id&cu=$t_cuenta_id&co=$t_compania_id'><i title='Enviar Mensaje' class='fa fa-envelope btn-mensajes'></i></a>";
    

//     $verfacturapdf = "<a href='transaccionventapdf?id=$trans_id&cu=$t_cuenta_id&co=$t_compania_id' target='_blank'>
//     <img title='Ver Venta' style='cursor:pointer; height: 24px; width: 20px' src='dist/img/pdf.png'>
//     </a>";

//     $formapagoventa = "";

//     if ($estatus_codigo=="2" || $estatus_codigo=="1"){
// /*
//       $estatus_nombre = "<a href='transaccionventaformapago?id=$trans_id&cu=$t_cuenta_id&co=$t_compania_id'>
//         $estatus_nombre
//       </a>";*/

//       $formapagoventa = "<a href='transaccionventaformapago?id=$trans_id&cu=$t_cuenta_id&co=$t_compania_id'>
//         <img title='Registrar Pago' style='cursor:pointer; height: 24px; width: 20px' src='dist/img/registrarpago.png'>
//       </a>";
//     }

//     $trans_montosub = number_format_personalizado($trans_montosub, $moneda_siglas);
//     $trans_montoiva = number_format_personalizado($trans_montoiva, $moneda_siglas);
//     $trans_montototal = number_format_personalizado($trans_montototal, $moneda_siglas);
//     $trans_montoganancia = number_format_personalizado($trans_montoganancia, $moneda_siglas);


//     $trans_codigo = "
//     <a href='vertransaccionventa?id=$trans_id'>
//       $trans_codigo (Ver Venta)
//     </a>";

//     if (P_Mod!="1"){$modificar = ""; $activo = "";}
//     if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

//     $mostrarcolumnacuenta = "<td>$cuenta</td>";
//     $mostrarcolumnacompania = "<td>$compania_nombre</td>";

//     if ($_COOKIE[perfil]=="1"){      
      
//     }
//     else if ($_COOKIE[perfil]=="2"){       
//       $mostrarcolumnacuenta = "";
//     }
//     else if ($_COOKIE[perfil]=="3"){       
//       $mostrarcolumnacuenta = "";
//       $mostrarcolumnacompania = ""; 
//     }
//     else if ($_COOKIE[perfil]=="4"){       
//       $mostrarcolumnacuenta = "";
//       $mostrarcolumnacompania = ""; 
//     }
//     else if ($_COOKIE[perfil]=="5"){       
//       $mostrarcolumnacuenta = "";
//       $mostrarcolumnacompania = ""; 
//     }
//     else {
//       $columnacuenta = "";
//       $mostrarcolumnacuenta = ""; 
//       $mostrarcolumnacompania = ""; 
//     }

//     $contadorminutos = "";

//     $segundos = "";
//     if ($estatus_codigo=="2" || $estatus_codigo=="5"){


//       $horaInicio = new DateTime();
//       $horaTermino = new DateTime($transalquiler_fechafincompleta);

//       $interval = $horaInicio->diff($horaTermino);
//       $totalhoraminseg =  $interval->format('%H:%I:%S');
//       $horas =  $interval->format('%H');
//       $minutos =  $interval->format('%I');
//       $segundos =  $interval->format('%S'); 

//       $result = $interval->invert;


//       if ($result!=1){

//         if ($horas<=0 && $minutos <=5){

//           $instancialista = new Lista();

//           $obtenerCodigoLista = 5;
//           $obtenerTipoLista = 96;
//           $idestatusporvencer = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);


//            $resultado = $conexion->doUpdate("transaccion", 
//             "           
//               l_estatus_id = '$idestatusporvencer'
//             ", 
//               "trans_id='$trans_id'");

//            $estatus_nombre = "Por Finalizar Tiempo";
//            $estatus_color = "#e4950f";

//         }

//       }

//       if ($result==1){

          

//           $obtenerCodigoLista = 3;
//           $obtenerTipoLista = 96;
//           $idestatusfinalizado = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);


//            $resultado = $conexion->doUpdate("transaccion", 
//             "           
//               l_estatus_id = '$idestatusfinalizado'
//             ", 
//               "trans_id='$trans_id'");

//            $estatus_nombre = "Finalizado el Tiempo";
//            $estatus_color = "#ff0000";

      

//       }else{

//         $contadorminutos = "<i class='fa fa-clock-o' style='font-weight: bold; font-size: 20px'></i> <span id='actual_$transdet_id' style='font-weight: bold; font-size: 20px'>$totalhoraminseg</span> <br>";

//         if ($valoresrecoorrerhora==""){
//           $valoresrecoorrerhora = $transdet_id;
//         }else{
//           $valoresrecoorrerhora .= "_".$transdet_id;
//         }  

//       }


//     }

//     $estatus_nombre = "<a href='vertransaccionalquiler?id=$trans_id&cu=$t_cuenta_id&co=$t_compania_id'><small class='label' style='font-size: 14px; font-weight: normal; background-color: $estatus_color'>$estatus_nombre</small></a>";
    
// /*
//     $estatus_nombre = "<a href='vertransaccionalquiler?id=$trans_id&cu=$t_cuenta_id&co=$t_compania_id'>
//         $estatus_nombre <br>(Ver)
//       </a>";
//   */
    
    

//     $textohtml .= "
//            <tr>               
//                   $mostrarcolumnacuenta
//                   $mostrarcolumnacompania 
//                   <td style='text-align: center'>$sucursal_nombre</td>
//                   <td style='text-align: center'>$usuario_nombre $usuario_apellido</td>
//                   <td style='text-align: center'>
//                     $prod_nombre <br>
//                     <img src='arch/$prod_img' style='height: 80px'> 
//                   </td>
//                   <td style='text-align: center'>
                     
//                       $contadorminutos

//                     $estatus_nombre
//                   </td>                                    
//                   <td style='text-align: center'>$trans_montototal</td>                 
//                       <td style='text-align: center' id='ini_$transdet_id'>$transalquiler_fechaini</td>
//                       <td style='text-align: center' id='fin_$transdet_id'>$transalquiler_fechafin</td>
//                       <td id='fecharegistro_$transdet_id'>$trans_fechareg</td>
                      
                  
//                   <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar </td>
//               </tr>
//         ";

//   }

//   $textohtml .=" <input type='hiddenn' value='$valoresrecoorrerhora' id='valoresrecoorrerhora' style='color:#fff; border: 0px solid white' />";

//   return $textohtml;ObtenerSucursalCompanias

// }


function ObtenerListaCategoriasNegocio($cuenta=null, $compania=null, $elementoid=null){
  if ($ordenar=="entero"){
    $orderby = "CAST(lista_nombre AS UNSIGNED)";
  }else{
    $orderby = "listacuenta_nombre";
  }

  $tipolista_id = "39";

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  //$option = "<option value=''>-- Seleccione --</option>";

  if ($listaid_rel!=""){
    $wherelistarel = " and lista.lista_idrel = '$listaid_rel' ";
  }


  if ($cuenta!="" ){
    
      $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
        listacuenta_activo, listacuenta_nombre, listacuenta_nombredos, companiacateg_id",
            "lista                
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 

                left join companiacategoria on companiacategoria.l_categ_id = lista.lista_id and companiacateg_activo = '1' and companiacategoria.compania_id = '$elementoid'
            ",
            "lista_activo = '1' and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");

      if (count($arrresultado)==0){

         $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
          listacuenta_activo, listacuenta_nombre, listacuenta_nombredos, companiacateg_id",
            "lista                 
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 

                left join companiacategoria on companiacategoria.l_categ_id = lista.lista_id and companiacateg_activo = '1' and companiaciudad.compania_id = '$elementoid'
            ",
            "lista_activo = '1' $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");


      }

      
    
    foreach($arrresultado as $i=>$valor){

      $lista_id = utf8_encode($valor["lista_id"]);  
      $lista_nombre = utf8_encode($valor["lista_nombre"]);  
      $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
      $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
      $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
      $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  
      $companiacateg_id = utf8_encode($valor["companiacateg_id"]);  

      if ($listacuenta_id!=""){
        if ($listacuenta_activo=="1"){
          if ($companiacateg_id!=""){
              $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
          }else{
              $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
          }    
        }
      }else{
        if ($companiacateg_id!=""){
            $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
        }else{
            $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
        }    
      }  
    }
  }
  
  if (count($arrresultado)==0 && $compania==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }else if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN CATEGORIAS</option>";
  }
 
  return $option;

}



function ObtenerListaCiudadesNegocio($cuenta=null, $compania=null, $elementoid=null){
  if ($ordenar=="entero"){
    $orderby = "CAST(lista_nombre AS UNSIGNED)";
  }else{
    $orderby = "listacuenta_nombre";
  }

  $tipolista_id = "92";

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  //$option = "<option value=''>-- Seleccione --</option>";

  if ($listaid_rel!=""){
    $wherelistarel = " and lista.lista_idrel = '$listaid_rel' ";
  }


  if ($cuenta!="" ){
    
      $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
        listacuenta_activo, listacuenta_nombre, listacuenta_nombredos, companiaciudad_id",
            "lista                
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 

                left join companiaciudad on companiaciudad.l_ciudad_id = lista.lista_id and companiaciudad_activo = '1' and companiaciudad.compania_id = '$elementoid'
            ",
            "lista_activo = '1' and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");

      if (count($arrresultado)==0){

         $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
          listacuenta_activo, listacuenta_nombre, listacuenta_nombredos, companiaciudad_id",
            "lista                 
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 

                left join companiaciudad on companiaciudad.l_ciudad_id = lista.lista_id and companiaciudad_activo = '1' and companiaciudad.compania_id = '$elementoid'
            ",
            "lista_activo = '1' $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");


      }

      
    
    foreach($arrresultado as $i=>$valor){

      $lista_id = utf8_encode($valor["lista_id"]);  
      $lista_nombre = utf8_encode($valor["lista_nombre"]);  
      $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
      $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
      $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
      $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  
      $companiaciudad_id = utf8_encode($valor["companiaciudad_id"]);  

      if ($listacuenta_id!=""){
        if ($listacuenta_activo=="1"){
          if ($companiaciudad_id!=""){
              $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
          }else{
              $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
          }    
        }
      }else{
        if ($companiaciudad_id!=""){
            $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
        }else{
            $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
        }    
      }  
    }
  }
  
  if (count($arrresultado)==0 && $compania==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }else if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN VALORES</option>";
  }
 
  return $option;

}


// function ObtenerListaClasificacionProducto($cuenta=null, $compania=null, $elementoid=null){
//   if ($ordenar=="entero"){
//     $orderby = "CAST(lista_nombre AS UNSIGNED)";
//   }else{
//     $orderby = "listacuenta_nombre";
//   }

//   $tipolista_id = "91";

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];

//   //$option = "<option value=''>-- Seleccione --</option>";

//   if ($listaid_rel!=""){
//     $wherelistarel = " and lista.lista_idrel = '$listaid_rel' ";
//   }


//   if ($cuenta!="" ){
    
//       $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
//         listacuenta_activo, listacuenta_nombre, listacuenta_nombredos, prodclasif_id",
//             "lista                
//                 left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
//                 and listacuenta.compania_id = '$compania' 
//                 left join productoclasificacion on productoclasificacion.l_prodclasif_id = lista.lista_id and prodclasif_activo = '1' and productoclasificacion.prod_id = '$elementoid'
//             ",
//             "lista_activo = '1' and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");

//       if (count($arrresultado)==0){

//          $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
//           listacuenta_activo, listacuenta_nombre, listacuenta_nombredos, prodclasif_id",
//             "lista                 
//                 left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
//                 and listacuenta.compania_id = '$compania' 
//                 left join productoclasificacion on productoclasificacion.l_prodclasif_id = lista.lista_id and prodclasif_activo = '1' and productoclasificacion.prod_id = '$elementoid'
//             ",
//             "lista_activo = '1' $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");


//       }

      
    
//     foreach($arrresultado as $i=>$valor){

//       $lista_id = utf8_encode($valor["lista_id"]);  
//       $lista_nombre = utf8_encode($valor["lista_nombre"]);  
//       $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
//       $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
//       $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
//       $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  
//       $prodclasif_id = utf8_encode($valor["prodclasif_id"]);  

//       if ($listacuenta_id!=""){
//         if ($listacuenta_activo=="1"){
//           if ($prodclasif_id!=""){
//               $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
//           }else{
//               $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
//           }    
//         }
//       }else{
//         if ($prodclasif_id!=""){
//             $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
//         }else{
//             $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
//         }    
//       }  
//     }
//   }
  
//   if (count($arrresultado)==0 && $compania==""){
//     $option = "<option  value=''>Seleccione Primero la Compañia</option>";
//   }else if (count($arrresultado)==0){
//     $option = "<option  value=''>NO EXISTEN VALORES</option>";
//   }
 
//   return $option;

// }

function ObtenerListaEstatusAbogados($tipolista_id=null, $cuenta=null, $compania=null, $elementoid=null, $ordenar=null, $agregardespues=null, $listaid_rel=null){

  if ($ordenar=="entero"){
    $orderby = "CAST(lista_nombre AS UNSIGNED)";
  }else{
    $orderby = "listacuenta_nombre";
  }



  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $option = "<option value=''>-- Seleccione --</option>";

  if ($listaid_rel!=""){
    $wherelistarel = " and lista.lista_idrel = '$listaid_rel' ";
  }

  /*
     inner join listacuentarel on listacuentarel.lista_id = lista.lista_id and listacuentarel.cuenta_id ='$cuenta' 
                and listacuentarel.compania_id = '$compania' and listacuentarel.tipolista_id = '$tipolista_id' 
                and listacuentarel_activo = '1'
  */


  if ($cuenta!="" ){
    
      $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, lista_activo, 
        listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
            "lista                
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 
            ",
            "lista_activo = '1' and lista_cod in (3,4,6) and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "$orderby asc");
   

      if (count($arrresultado)==0){

         $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
          listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
            "lista                 
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 
            ",
            "lista_activo = '1' and lista_cod in (3,4,6)  $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "$orderby asc");


      }

    
    foreach($arrresultado as $i=>$valor){

      $lista_id = utf8_encode($valor["lista_id"]);  
      $lista_nombre = utf8_encode($valor["lista_nombre"]);  
      $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
      $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
      $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
      $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  

      if ($listacuenta_id!=""){
        if ($listacuenta_activo=="1"){
          if ($elementoid==$lista_id){
              $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
          }else{
              $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
          }    
        }
      }else{
        if ($elementoid==$lista_id){
            $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
        }else{
            $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
        }    
      }  
    }
  }
  
  if (count($arrresultado)==0 && $compania==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }else if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN VALORES</option>";
  }

  if (count($arrresultado)==1){
    $option = "<option selected='selected' value='$lista_id'>$lista_nombre $agregardespues</option>";
  }

 

  /*
  
  $arrresultado = $conexion->doSelect("lista_id, lista_nombre","lista ",
            "lista_activo = '1' and tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and cuenta_id ='$cuenta' and compania_id = '$compania'))  ", null, "lista_nombre asc");

  $option = "<option value='0'>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

    $lista_id = utf8_encode($valor["lista_id"]);  
    $lista_nombre = utf8_encode($valor["lista_nombre"]);  

    if ($elementoid==$lista_id){
        $option .= "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
    }else{
        $option .= "<option value='$lista_id'>$lista_nombre</option>";
    }
  }

  if (count($arrresultado)==1){
    $option = "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
  }

  */

  return $option;

}

function ObtenerListaEstatusAgendadora($tipolista_id=null, $cuenta=null, $compania=null, $elementoid=null, $ordenar=null, $agregardespues=null, $listaid_rel=null){

  if ($ordenar=="entero"){
    $orderby = "CAST(lista_nombre AS UNSIGNED)";
  }else{
    $orderby = "listacuenta_nombre";
  }



  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $option = "<option value=''>-- Seleccione --</option>";

  if ($listaid_rel!=""){
    $wherelistarel = " and lista.lista_idrel = '$listaid_rel' ";
  }

  /*
     inner join listacuentarel on listacuentarel.lista_id = lista.lista_id and listacuentarel.cuenta_id ='$cuenta' 
                and listacuentarel.compania_id = '$compania' and listacuentarel.tipolista_id = '$tipolista_id' 
                and listacuentarel_activo = '1'
  */


  if ($cuenta!="" ){
    
      $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, lista_activo, 
        listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
            "lista                
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 
            ",
            "lista_activo = '1' and lista_cod not in (4) and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "$orderby asc");
   

      if (count($arrresultado)==0){

         $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
          listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
            "lista                 
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 
            ",
            "lista_activo = '1' and lista_cod not in (4)  $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "$orderby asc");


      }

    
    foreach($arrresultado as $i=>$valor){

      $lista_id = utf8_encode($valor["lista_id"]);  
      $lista_nombre = utf8_encode($valor["lista_nombre"]);  
      $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
      $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
      $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
      $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  

      if ($listacuenta_id!=""){
        if ($listacuenta_activo=="1"){
          if ($elementoid==$lista_id){
              $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
          }else{
              $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
          }    
        }
      }else{
        if ($elementoid==$lista_id){
            $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
        }else{
            $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
        }    
      }  
    }
  }
  
  if (count($arrresultado)==0 && $compania==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }else if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN VALORES</option>";
  }

  if (count($arrresultado)==1){
    $option = "<option selected='selected' value='$lista_id'>$lista_nombre $agregardespues</option>";
  }

 

  /*
  
  $arrresultado = $conexion->doSelect("lista_id, lista_nombre","lista ",
            "lista_activo = '1' and tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and cuenta_id ='$cuenta' and compania_id = '$compania'))  ", null, "lista_nombre asc");

  $option = "<option value='0'>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

    $lista_id = utf8_encode($valor["lista_id"]);  
    $lista_nombre = utf8_encode($valor["lista_nombre"]);  

    if ($elementoid==$lista_id){
        $option .= "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
    }else{
        $option .= "<option value='$lista_id'>$lista_nombre</option>";
    }
  }

  if (count($arrresultado)==1){
    $option = "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
  }

  */

  return $option;

}


function ListaOpcionAgendaCampana($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {
      
    
    $arrresultado = $conexion->doSelect("agendacampana_id, agendacampana_nombre, agendacampana_descrip, agendacampana_img, agendacampana_activo, agendacampana_eliminado, agendacampana.cuenta_id, cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre, cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
       DATE_FORMAT(agendacampana_fechareg,'%d/%m/%Y %H:%i:%s') as agendacampana_fechareg
          ",
      "agendacampana
        inner join usuario cuenta on cuenta.usuario_id = agendacampana.cuenta_id
          inner join compania on compania.compania_id = agendacampana.compania_id
      ",
      "agendacampana_activo = '1' and agendacampana.cuenta_id = '$cuentaseleccionada' and agendacampana.compania_id = '$companiaseleccionada'", null, "agendacampana_id  desc");
      foreach($arrresultado as $i=>$valor){

        $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
        $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
        $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

        $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

        $compania_nombre = utf8_encode($valor["compania_nombre"]);
        
        $agendacampana_id = utf8_encode($valor["agendacampana_id"]);
        $agendacampana_nombre = utf8_encode($valor["agendacampana_nombre"]);
        $agendacampana_descrip = utf8_encode($valor["agendacampana_descrip"]);
        $agendacampana_img = utf8_encode($valor["agendacampana_img"]);
        $agendacampana_activo = utf8_encode($valor["agendacampana_activo"]);
        $agendacampana_fechareg = utf8_encode($valor["agendacampana_fechareg"]);

        if ($idseleccionado==$agendacampana_id){
            $option .= "<option selected='selected' value='$agendacampana_id'>$agendacampana_nombre</option>";
        }else{
            $option .= "<option value='$agendacampana_id'>$agendacampana_nombre</option>";
        }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN ORIGENES ACTIVOS</option>";
      }

      if (count($arrresultado)==1){
        $option = "<option selected='selected' value='$agendacampana_id'>$agendacampana_nombre</option>";
      } 
  }
  

  return $option;

}

function ListaOpcionAgendaOrigen($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {
      
    
    $arrresultado = $conexion->doSelect("agendaorigen_id, agendaorigen_nombre, agendaorigen_descrip, agendaorigen_img, agendaorigen_activo, agendaorigen_eliminado, agendaorigen.cuenta_id, cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre, cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
       DATE_FORMAT(agendaorigen_fechareg,'%d/%m/%Y %H:%i:%s') as agendaorigen_fechareg
          ",
      "agendaorigen
        inner join usuario cuenta on cuenta.usuario_id = agendaorigen.cuenta_id
          inner join compania on compania.compania_id = agendaorigen.compania_id
      ",
      "agendaorigen_activo = '1' and agendaorigen.cuenta_id = '$cuentaseleccionada' and agendaorigen.compania_id = '$companiaseleccionada'", null, "agendaorigen_id  desc");
      foreach($arrresultado as $i=>$valor){

        $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
        $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
        $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

        $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

        $compania_nombre = utf8_encode($valor["compania_nombre"]);
        
        $agendaorigen_id = utf8_encode($valor["agendaorigen_id"]);
        $agendaorigen_nombre = utf8_encode($valor["agendaorigen_nombre"]);
        $agendaorigen_descrip = utf8_encode($valor["agendaorigen_descrip"]);
        $agendaorigen_img = utf8_encode($valor["agendaorigen_img"]);
        $agendaorigen_activo = utf8_encode($valor["agendaorigen_activo"]);
        $agendaorigen_fechareg = utf8_encode($valor["agendaorigen_fechareg"]);

        if ($idseleccionado==$agendaorigen_id){
            $option .= "<option selected='selected' value='$agendaorigen_id'>$agendaorigen_nombre</option>";
        }else{
            $option .= "<option value='$agendaorigen_id'>$agendaorigen_nombre</option>";
        }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN ORIGENES ACTIVOS</option>";
      }

      if (count($arrresultado)==1){
        $option = "<option selected='selected' value='$agendaorigen_id'>$agendaorigen_nombre</option>";
      } 
  }
  

  return $option;

}


function ListadoAgendaCampanas($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (agendacampana_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
    $titulo = "Ventas del Día";
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (agendacampana_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (agendacampana_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (agendacampana_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($estatusseleccionado!=""){
    $whereestatus =" and agendacampana.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and agendacampana.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and agendacampana.cuenta_id = '$_COOKIE[idcuenta]' and agendacampana.compania_id = '$_COOKIE[idcompania]' and agendacampana_activo = '1' ";

  } 

  $conexion = new ConexionBd();

  
  $arrresultado = $conexion->doSelect("agendacampana_id, agendacampana_nombre, agendacampana_descrip, agendacampana_img, agendacampana_activo, agendacampana_eliminado, agendacampana.cuenta_id, cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre, cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
     DATE_FORMAT(agendacampana_fechareg,'%d/%m/%Y %H:%i:%s') as agendacampana_fechareg
        ",
    "agendacampana
      inner join usuario cuenta on cuenta.usuario_id = agendacampana.cuenta_id
        inner join compania on compania.compania_id = agendacampana.compania_id
    ",
    "agendacampana_eliminado = '0' $where $wherefecha $whereestatus", null, "agendacampana_id  desc");
  foreach($arrresultado as $i=>$valor){

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    
    $agendacampana_id = utf8_encode($valor["agendacampana_id"]);
    $agendacampana_nombre = utf8_encode($valor["agendacampana_nombre"]);
    $agendacampana_descrip = utf8_encode($valor["agendacampana_descrip"]);
    $agendacampana_img = utf8_encode($valor["agendacampana_img"]);
    $agendacampana_activo = utf8_encode($valor["agendacampana_activo"]);
    $agendacampana_fechareg = utf8_encode($valor["agendacampana_fechareg"]);
    

    if ($agendacampana_activo=="0"){
      $activo = "<i onclick='cambiarestatusagendacampana(\"".$agendacampana_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusagendacampana(\"".$agendacampana_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminaragendacampana(\"".$agendacampana_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
    $modificar = "<a href='modificaragendacampana?id=$agendacampana_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";



    if (P_Mod!="1"){$modificar = ""; $activo = ""; $configuraragendacampana="";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = ""; $configuraragendacampana = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $textohtml .= "
           <tr>
              $mostrarcolumnacuenta
              $mostrarcolumnacompania                 
              <td>$agendacampana_nombre</td>                  
              <td>$agendacampana_fechareg</td>   
              <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
              </tr>
        ";

  }

  return $textohtml;

}

function ListadoAgendaOrigen($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (agendaorigen_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
    $titulo = "Ventas del Día";
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (agendaorigen_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (agendaorigen_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (agendaorigen_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($estatusseleccionado!=""){
    $whereestatus =" and agendaorigen.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and agendaorigen.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and agendaorigen.cuenta_id = '$_COOKIE[idcuenta]' and agendaorigen.compania_id = '$_COOKIE[idcompania]' and agendaorigen_activo = '1' ";

  } 

  $conexion = new ConexionBd();

  
  $arrresultado = $conexion->doSelect("agendaorigen_id, agendaorigen_nombre, agendaorigen_descrip, agendaorigen_img, agendaorigen_activo, agendaorigen_eliminado, agendaorigen.cuenta_id, cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre, cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
     DATE_FORMAT(agendaorigen_fechareg,'%d/%m/%Y %H:%i:%s') as agendaorigen_fechareg
        ",
    "agendaorigen
      inner join usuario cuenta on cuenta.usuario_id = agendaorigen.cuenta_id
        inner join compania on compania.compania_id = agendaorigen.compania_id
    ",
    "agendaorigen_eliminado = '0' $where $wherefecha $whereestatus", null, "agendaorigen_id  desc");
  foreach($arrresultado as $i=>$valor){

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    
    $agendaorigen_id = utf8_encode($valor["agendaorigen_id"]);
    $agendaorigen_nombre = utf8_encode($valor["agendaorigen_nombre"]);
    $agendaorigen_descrip = utf8_encode($valor["agendaorigen_descrip"]);
    $agendaorigen_img = utf8_encode($valor["agendaorigen_img"]);
    $agendaorigen_activo = utf8_encode($valor["agendaorigen_activo"]);
    $agendaorigen_fechareg = utf8_encode($valor["agendaorigen_fechareg"]);
    

    if ($agendaorigen_activo=="0"){
      $activo = "<i onclick='cambiarestatusagendaorigen(\"".$agendaorigen_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusagendaorigen(\"".$agendaorigen_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminaragendaorigen(\"".$agendaorigen_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
    $modificar = "<a href='modificaragendaorigen?id=$agendaorigen_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";



    if (P_Mod!="1"){$modificar = ""; $activo = ""; $configuraragendaorigen="";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = ""; $configuraragendaorigen = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $textohtml .= "
           <tr>
              $mostrarcolumnacuenta
              $mostrarcolumnacompania                 
              <td>$agendaorigen_nombre</td>                  
              <td>$agendaorigen_fechareg</td>   
              <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
              </tr>
        ";

  }

  return $textohtml;

}


function ObtenerListaUsuariosPorPerfil($cuentaseleccionada=null, $companiaseleccionada=null, $perfilget=null, $idseleccionado =null, $nounico=true, $miusuario=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {

    //echo $perfilget;

    if ($miusuario!=""){
      $where = " and usuario.usuario_id = '$_COOKIE[iniuser]'";
    }


    if ($_COOKIE[perfil]=="7"){
      $where .= " and usuario.usuario_id = '$_COOKIE[iniuser]'";
    }

    if ($perfilget!="7"){
      $whereperfilempleados = " and (usuario.perfil_id = '$perfilget' or perfil.perfil_idorig = '$perfilget') ";
    }else{
      $whereperfilempleados = " and  (usuario.perfil_id in (2,3,7) or perfil.perfil_idorig in (2,3,7) ) ";
    }


     $arrresultado = $conexion->doSelect("usuario.usuario_id, usuario.usuario_nombre, 
      usuario.usuario_apellido, usuario.usuario_empresa, usuario.perfil_id",
        "usuario
          inner join perfil on perfil.perfil_id = usuario.perfil_id
        ",
        "usuario.usuario_activo = '1' $whereperfilempleados and usuario.cuenta_id = '$cuentaseleccionada' and usuario.compania_id = '$companiaseleccionada' $where", null, "usuario.usuario_nombre, usuario.usuario_apellido asc");

     //"usuario.usuario_activo = '1' and (usuario.perfil_id = '$perfilget' or perfil.perfil_idorig = '$perfilget'  or perfil.perfil_personalizado = '1')  and usuario.cuenta_id = '$cuentaseleccionada' and usuario.compania_id = '$companiaseleccionada' $where", null, "usuario.usuario_nombre, usuario.usuario_apellido asc");

     /*if ($perfilget=="60"){
      print_r($arrresultado);
      exit();
     }
     
*/

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

        $usuario_id = utf8_encode($valor["usuario_id"]);
        $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
        $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
        $usuario_empresa = utf8_encode($valor["usuario_empresa"]);
        $perfil_id = utf8_encode($valor["perfil_id"]);

        $usuario = $usuario_nombre." ".$usuario_apellido;

        if ($idseleccionado==$usuario_id){
              $option .= "<option selected='selected' value='$usuario_id'>$usuario</option>";
          }else{
              $option .= "<option value='$usuario_id'>$usuario</option>";
          }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN USUARIOS</option>";
      }

      if (count($arrresultado)==1 && $nounico!="1"){
        $option = "<option selected='selected' value='$usuario_id'>$usuario</option>";
      } 
  }
  

  return $option;

}

function ObtenerVehiculos($cuentaseleccionada=null, $companiaseleccionada=null, $vehiculoseleccionado=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>NO EXISTEN VEHICULOS (CUENTA NO SELECCIONADA)</option>";
  }else {
    
    if ($_COOKIE[perfil]=="1"){  
  
      if ($cuentaseleccionada!=""){
        $where = " and vehiculo.cuenta_id = '$cuentaseleccionada' ";     
      }

      if ($companiaseleccionada!=""){
        $where = " and vehiculo.cuenta_id = '$cuentaseleccionada' and vehiculo.compania_id = '$companiaseleccionada' ";     
      }
  
    } else {  

      $where = " and vehiculo.cuenta_id = '$cuentaseleccionada' and vehiculo.compania_id = '$companiaseleccionada' ";     
  
    } 

    
    $arrresultado = $conexion->doSelect("

    vehiculo.vehiculo_id, vehiculo.l_marca_id, vehiculo.l_modelo_id, vehiculo.u_proveedor_id, 
    vehiculo.vehiculo_patente
      ",
    "
    vehiculo 
      inner join usuario cuenta on cuenta.usuario_id = vehiculo.cuenta_id
      inner join compania on compania.compania_id = vehiculo.compania_id              
      left join lista marca on marca.lista_id = vehiculo.l_marca_id
      left join lista modelo on modelo.lista_id = vehiculo.l_modelo_id
      left join usuario proveedor on proveedor.usuario_id = vehiculo.u_proveedor_id

    ",
    "vehiculo.vehiculo_activo = '1' $where ", null, "vehiculo_patente asc");

    $option = "<option value=''>-- Seleccione --</option>";
    foreach($arrresultado as $i=>$valor){

        $vehiculo_id = utf8_encode($valor["vehiculo_id"]);  
        $vehiculo_patente = utf8_encode($valor["vehiculo_patente"]);  

        if ($vehiculoseleccionado==$vehiculo_id) {
            $option .= "<option selected='selected' value='$vehiculo_id'>$vehiculo_patente</option>";
        }else{
            $option .= "<option value='$vehiculo_id'>$vehiculo_patente</option>";
        }
    }
      
    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN VEHICULOS</option>";
    }

    if (count($arrresultado)==1){
      $option = "<option selected='selected' value='$vehiculo_id'>$vehiculo_patente</option>";
    } 

  }

  return $option;

}

function ObtenerListaMarcas($cuenta=null, $compania=null, $elementoid=null){
  if ($ordenar=="entero"){
    $orderby = "CAST(lista_nombre AS UNSIGNED)";
  }else{
    $orderby = "listacuenta_nombre";
  }

  $tipolista_id = "79";

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $option = "<option value=''>-- Seleccione --</option>";

  if ($listaid_rel!=""){
    $wherelistarel = " and lista.lista_idrel = '$listaid_rel' ";
  }


  if ($cuenta!="" ){
    
      $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
        listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
            "lista                
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 
            ",
            "lista_activo = '1' and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");

      if (count($arrresultado)==0){

         $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
          listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
            "lista                 
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 
            ",
            "lista_activo = '1' $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");


      }

    
    foreach($arrresultado as $i=>$valor){

      $lista_id = utf8_encode($valor["lista_id"]);  
      $lista_nombre = utf8_encode($valor["lista_nombre"]);  
      $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
      $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
      $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
      $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  

      if ($listacuenta_id!=""){
        if ($listacuenta_activo=="1"){
          if ($elementoid==$lista_id){
              $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
          }else{
              $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
          }    
        }
      }else{
        if ($elementoid==$lista_id){
            $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
        }else{
            $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
        }    
      }  
    }
  }
  
  if (count($arrresultado)==0 && $compania==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }else if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN VALORES</option>";
  }
 
  return $option;

}

function ObtenerListaModelos($cuenta=null, $compania=null, $lista_idrel=null, $elementoid=null){
  if ($ordenar=="entero"){
    $orderby = "CAST(lista_nombre AS UNSIGNED)";
  }else{
    $orderby = "listacuenta_nombre";
  }

  $tipolista_id = "80";

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $option = "<option value=''>-- Seleccione --</option>";

  if ($lista_idrel!=""){
    $wherelistarel = " and lista.lista_idrel = '$lista_idrel' ";
  
    if ($cuenta!="" ){
      
        $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
          listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
              "lista                
                  left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                  and listacuenta.compania_id = '$compania' 
              ",
              "lista_activo = '1' and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");

        if (count($arrresultado)==0){

           $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
            listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
              "lista                 
                  left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                  and listacuenta.compania_id = '$compania' 
              ",
              "lista_activo = '1' $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");


        }

      
      foreach($arrresultado as $i=>$valor){

        $lista_id = utf8_encode($valor["lista_id"]);  
        $lista_nombre = utf8_encode($valor["lista_nombre"]);  
        $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
        $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
        $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
        $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  

        if ($listacuenta_id!=""){
          if ($listacuenta_activo=="1"){
            if ($elementoid==$lista_id){
                $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
            }else{
                $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
            }    
          }
        }else{
          if ($elementoid==$lista_id){
              $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
          }else{
              $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
          }    
        }  
      }
    }

    if (count($arrresultado)==0 && $compania==""){
      $option = "<option  value=''>Seleccione Primero la Compañia</option>";
    }else if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN MODELOS</option>";
    }

  }else{
    $option = "<option  value=''>Seleccione Primero la Marca</option>";
  }
  
  
 
  return $option;

}

function ListadoTraslados($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (traslado_fechaini BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (traslado_fechaini BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (traslado_fechaini > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (traslado_fechaini BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  //echo $wherefecha;
  //exit();

  if ($estatusseleccionado!=""){
    $whereestatus =" and traslado.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and traslado.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and traslado.cuenta_id = '$_COOKIE[idcuenta]' and traslado.compania_id = '$_COOKIE[idcompania]' and traslado_activo = '1' ";

  } 

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("

    traslado.traslado_id, traslado.traslado_nro, 
    traslado.u_proveedor_id, traslado.vehiculo_id, traslado.l_tipotraslado_id, traslado.u_chofer_id,
    traslado.l_estatus_id, traslado.traslado_montocosto, traslado.traslado_montoventa, 
    traslado.traslado_activo, traslado.traslado_eliminado, traslado.traslado_fechareg, traslado.u_operativo_id, 
    traslado.u_facturacion_id, traslado.cuenta_id, traslado.compania_id, traslado.traslado_dirorigen, 
    traslado.traslado_dirdestino, traslado.traslado_dirorigenlat, traslado.traslado_dirorigenlon,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania.compania_nombre as compania_nombre,

    proveedor.usuario_nombre as proveedor_nombre, proveedor.usuario_apellido as proveedor_apellido,
    proveedor.usuario_empresa as proveedor_empresa,
    chofer.usuario_nombre as chofer_nombre, chofer.usuario_apellido as chofer_apellido,
    usuariooperativo.usuario_nombre as usuariooperativo_nombre, usuariooperativo.usuario_apellido as usuariooperativo_apellido,
    usuariofacturacion.usuario_nombre as usuariofacturacion_nombre, usuariofacturacion.usuario_apellido as usuariofacturacion_apellido,

    estatus.lista_nombre as estatus_nombre,

    DATE_FORMAT(traslado_fechaini,'%d/%m/%Y %H:%i') as traslado_fechaini,
    DATE_FORMAT(traslado_fechafin,'%d/%m/%Y %H:%i') as traslado_fechafin

      ",
    "
    traslado 

      inner join usuario cuenta on cuenta.usuario_id = traslado.cuenta_id
      inner join compania on compania.compania_id = traslado.compania_id

      left join usuario proveedor on proveedor.usuario_id = traslado.u_proveedor_id
      left join usuario chofer on chofer.usuario_id = traslado.u_chofer_id   
      left join usuario usuariooperativo on usuariooperativo.usuario_id = traslado.u_operativo_id         
      left join usuario usuariofacturacion on usuariofacturacion.usuario_id = traslado.u_facturacion_id         

      left join vehiculo on vehiculo.vehiculo_id = traslado.vehiculo_id              
      left join lista tipotraslado on tipotraslado.lista_id = traslado.l_tipotraslado_id 
      left join lista estatus on estatus.lista_id = traslado.l_estatus_id              


    ",
    "traslado_eliminado = '0' $where $whereestatus $wherefecha", null, "traslado.traslado_id desc");


  foreach($arrresultado as $i=>$valor){
  
    $traslado_id = utf8_encode($valor["traslado_id"]);  
    $traslado_nro = utf8_encode($valor["traslado_nro"]);  
    $traslado_fechaini = utf8_encode($valor["traslado_fechaini"]);  
    $traslado_fechafin = utf8_encode($valor["traslado_fechafin"]);  
    $u_proveedor_id = utf8_encode($valor["u_proveedor_id"]);
    $vehiculo_id = utf8_encode($valor["vehiculo_id"]);  
    $l_tipotraslado_id = utf8_encode($valor["l_tipotraslado_id"]);  
    $u_chofer_id = utf8_encode($valor["u_chofer_id"]);  
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);  
    $traslado_montocosto = utf8_encode($valor["traslado_montocosto"]);
    $traslado_montoventa = utf8_encode($valor["traslado_montoventa"]);  
    $traslado_activo = utf8_encode($valor["traslado_activo"]);  
    $traslado_fechareg = utf8_encode($valor["traslado_fechareg"]);  
    $u_operativo_id = utf8_encode($valor["u_operativo_id"]);  
    $u_facturacion_id = utf8_encode($valor["u_facturacion_id"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);  
    $compania_id = utf8_encode($valor["compania_id"]);  
    $traslado_dirorigen = utf8_encode($valor["traslado_dirorigen"]);  
    $traslado_dirdestino = utf8_encode($valor["traslado_dirdestino"]);  
    $traslado_dirorigenlat = utf8_encode($valor["traslado_dirorigenlat"]);
    $traslado_dirorigenlon = utf8_encode($valor["traslado_dirorigenlon"]); 

    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);  
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);  
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);  

    $cuenta = $cuenta_nombre." ".$cuenta_apellido;
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $proveedor_nombre = utf8_encode($valor["proveedor_nombre"]);  
    $proveedor_apellido = utf8_encode($valor["proveedor_apellido"]);  
    $proveedor_empresa = utf8_encode($valor["proveedor_empresa"]);  

    $proveedor = $proveedor_nombre." ".$proveedor_apellido;

    $chofer_nombre = utf8_encode($valor["chofer_nombre"]);  
    $chofer_apellido = utf8_encode($valor["chofer_apellido"]);  
    $chofer = $chofer_nombre." ".$chofer_apellido;

    $usuariooperativo_nombre = utf8_encode($valor["usuariooperativo_nombre"]);  
    $usuariooperativo_apellido = utf8_encode($valor["usuariooperativo_apellido"]);  
    $usuariooperativo = $usuariooperativo_nombre." ".$usuariooperativo_apellido;

    $usuariofacturacion_nombre = utf8_encode($valor["usuariofacturacion_nombre"]);  
    $usuariofacturacion_apellido = utf8_encode($valor["usuariofacturacion_apellido"]);  
    $usuariofacturacion = $usuariofacturacion_nombre." ".$usuariofacturacion_apellido;

    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);  

  
    if ($traslado_activo=="0"){
      $activo = "<i onclick='cambiarestatustraslado(\"".$traslado_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatustraslado(\"".$traslado_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminartraslado(\"".$traslado_id."\")' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";  

    $modificar = "<a href='modificartraslado?id=$traslado_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";


  
    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else if ($_COOKIE[perfil]=="3"){       
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    else if ($_COOKIE[perfil]=="4"){       
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    else if ($_COOKIE[perfil]=="5"){       
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    else {
      $columnacuenta = "";
      $mostrarcolumnacuenta = ""; 
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
           <tr>               
              $mostrarcolumnacuenta
              $mostrarcolumnacompania           
              <td>$traslado_nro </td>           
              <td>$traslado_dirorigen </td>           
              <td>$traslado_dirdestino </td>           
              <td>$traslado_fechaini </td>           
              <td>$estatus_nombre </td>           
              <td>$proveedor_empresa </td>                       
              <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}

function ObtenerMonedaPrincipal($cuentaseleccionada=null, $companiaseleccionada=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    $where = " and listaconfig.cuenta_id = '$cuentaseleccionada'";
  } else {
    $where = " and listaconfig.cuenta_id = '$cuentaseleccionada' and listaconfig.compania_id = '$companiaseleccionada' ";
  }

  $where = " and listaconfig.compania_id = '$companiaseleccionada' ";

  $tipolista_id = 16;

  $arrresultado = $conexion->doSelect("lista.lista_nombredos",
    "
    lista 
      inner join listaconfig on lista.lista_id = listaconfig.listaconfig_valoruno
    ",
    "listaconfig_activo = '1' and lista.tipolista_id = '$tipolista_id' $where");
      
  foreach($arrresultado as $i=>$valor){

    $lista_nombredoscolocar = utf8_encode($valor["lista_nombredos"]);  

    if ($lista_nombredoscolocar!=""){
      $moneda_siglas = $lista_nombredoscolocar;
    }
  }

  if ($moneda_siglas==""){
    $moneda_siglas = "$";
  }

  

  return $moneda_siglas;

}

function ObtenerListaCarreras($cuentaseleccionada=null, $companiaseleccionada=null, $usuario_idget =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and evento.cuenta_id = '$_COOKIE[idcuenta]' ";          

  }  else { 
    $where = " and evento.cuenta_id = '$_COOKIE[idcuenta]' and evento.compania_id = '$_COOKIE[idcompania]' ";    
  } 



 $arrresultado = $conexion->doSelect("

    evento_fecha,
    DATE_FORMAT(evento.evento_fechareg,'%d/%m/%Y %H:%i:%s') as evento_fechareg, 
    DATE_FORMAT(evento.evento_fechavenc,'%d/%m/%Y') as evento_fechavenc,  

    evento.evento_id, evento.evento_nombre, evento.evento_nombredos, 
    evento.evento_ubicacion, evento_img,
    evento.evento_fechareg, evento.evento_activo, evento.evento_eliminado, evento.cuenta_id, 
    evento.compania_id,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre
    
    ",
    "evento           
      inner join usuario cuenta on cuenta.usuario_id = evento.cuenta_id
        inner join compania on compania.compania_id = evento.compania_id            
    ",
    "evento_activo = '1' $where ", null, "evento_fecha asc");
  foreach($arrresultado as $i=>$valor){

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $evento_id = utf8_encode($valor["evento_id"]);
    $evento_fecha = utf8_encode($valor["evento_fecha"]);
    $evento_fechareg = utf8_encode($valor["evento_fechareg"]);
    $evento_fechavenc = utf8_encode($valor["evento_fechavenc"]);
    $evento_nombre = utf8_encode($valor["evento_nombre"]);
    $evento_nombredos = utf8_encode($valor["evento_nombredos"]);
    $evento_ubicacion = utf8_encode($valor["evento_ubicacion"]);
    $evento_activo = utf8_encode($valor["evento_activo"]);
    $evento_img = utf8_encode($valor["evento_img"]);    

    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]); 

    $urlimgCarrera = "arch/$evento_img"; 

    $carrerashtml .= "
      <div class='col-lg-3 col-md-6' style='margin-bottom: 15px'>
          <div class='package-content bg-light border text-center p-2 my-2 my-lg-0' style='background: #FFF; padding: 20px'>
              <div class='package-content-heading border-bottom'>
                  <a href='adquirirplanevento?e=$evento_id'>
                    <center>
                        <img src='$urlimgCarrera' class='img-responsive' style='height:100px' />
                    </center>
                    <h2 style='padding-top: 10px; padding-bottom: 4px'>$evento_nombre</h2>                    
                  </a>
              </div>              
              <a href='adquirirplanevento?e=$evento_id' class='btn btn-primary' style='margin-top: 5px'>Seleccionar</a>
              
          </div>
      </div>
    ";

  }

  if ($carrerashtml!=""){

    $carrerashtml = "

    <div class='col-md-12'>
        <h3>Seleccione el Evento </h3>  
    </div>    

    $carrerashtml
    ";
  }

  return $carrerashtml;

}


function GuardarListaCategoriaProv($listaprovcateg_id=null, $lista_id=null, $listaprovcateg_url=null, $fechaactual=null, $cuenta_id=null, $compania_id=null, $listacuenta_id=null){

  // Guarda la ListaFormaPago

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($listaprovcateg_id==""){
    $resultado = $conexion->doInsert("
     listaprovcategoria
      (l_provcateg_id, listaprovcateg_url, listaprovcateg_ultimaact, usuario_idreg, cuenta_id, compania_id, listacuenta_id) 
      ",
      "'$lista_id', '$listaprovcateg_url', null,'$_COOKIE[iniuser]','$cuenta_id', '$compania_id','$listacuenta_id'");
  }else{

       $resultado = $conexion->doUpdate("listaprovcategoria", 
        "           
          listaprovcateg_url = '$listaprovcateg_url'
        ", 
          "listaprovcateg_id='$listaprovcateg_id'");

  }

  return $resultado;
}


function GuardarListaNivelUsuario($listanivelusuario_id=null, $lista_id=null, $listanivelusuario_rangomin=null, $listanivelusuario_rangomax=null, $fechaactual=null, $cuenta_id=null, $compania_id=null, $listacuenta_id=null){

  // Guarda la ListaFormaPago

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($listanivelusuario_id==""){
    $resultado = $conexion->doInsert("
      listanivelusuario
        (l_nivelusuario_id, listanivelusuario_rangomin, listanivelusuario_rangomax, usuario_idreg, 
        cuenta_id, compania_id, listacuenta_id)         
      ",
      "'$lista_id', '$listanivelusuario_rangomin', '$listanivelusuario_rangomax','$_COOKIE[iniuser]',
      '$cuenta_id', '$compania_id','$listacuenta_id'");
  }else{

       $resultado = $conexion->doUpdate("listanivelusuario", 
        "           
          listanivelusuario_rangomin = '$listanivelusuario_rangomin', 
          listanivelusuario_rangomax = '$listanivelusuario_rangomax'
        ", 
          "listanivelusuario_id='$listanivelusuario_id'");

  }

  return $resultado;
}



function ObtenerListaOperadoresInversion($cuentaseleccionada=null, $companiaseleccionada=null, $usuario_idget =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and listaplaninversion.cuenta_id = '$_COOKIE[idcuenta]' ";          


  }  else { 

    $where = " and listaplaninversion.cuenta_id = '$_COOKIE[idcuenta]' and listaplaninversion.compania_id = '$_COOKIE[idcompania]' ";
    $wherelistaactivo = " and plan.lista_activo = '1' ";
  } 



  $arrresultado = $conexion->doSelect("

    listaplaninversion.listaplaninversion_id, listaplaninversion.l_planinversion_id,
    listaplaninversion.l_moneda_id,
    listaplaninversion.listaplaninversion_precio, listaplaninversion.listaplaninversion_ganancia, 
    listaplaninversion.listaplaninversion_diasduracion, listaplaninversion.listaplaninversion_fechareg, 
    listaplaninversion.listaplaninversion_url,

    plan.lista_id as plan_id, plan.lista_nombre as plan_nombre, plan.lista_img as plan_img,
    plan.lista_orden as plan_orden, plan.lista_activo as plan_activo,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    listaplanservdet_id, listaplanservdet_descrip, listaplanservdet_orden, listaplanservdet_activo,

    moneda.lista_nombredos as moneda_siglas

      ",
    "
    listaplaninversion
        inner join lista plan on plan.lista_id = listaplaninversion.l_planinversion_id          
        inner join usuario cuenta on cuenta.usuario_id = listaplaninversion.cuenta_id
        inner join compania on compania.compania_id = listaplaninversion.compania_id  


        left join lista moneda on moneda.lista_id = listaplaninversion.l_moneda_id       
        left join listaplanserviciodetalle on listaplanserviciodetalle.l_plan_id = plan.lista_id 
        and listaplanservdet_activo = '1'
    ",
    " plan.lista_activo = '1' $where  $wherelistaactivo", null, "plan.lista_orden, plan.lista_id, listaplanserviciodetalle.listaplanservdet_orden  asc");

  $cont = 0;
  foreach($arrresultado as $i=>$valor){

    $plan_id = utf8_encode($valor["plan_id"]);

    if ($plan_id_old!=$plan_id && $cont!="0"){   

      $planeshtml .= "
        <div class='col-lg-4 col-md-6' style='margin-bottom: 15px'>
            <div class='package-content bg-light border text-center p-2 my-2 my-lg-0' style='background: #FFF; padding: 20px'>
                <div class='package-content-heading border-bottom'>
                    <a href='plan-detalle?id=$plan_id_old'>
                      <center>
                          <img src='$urlimgPlan' class='img-responsive' style='height:140px' />
                      </center>
                      <h2 style='padding-top: 10px; padding-bottom: 4px'>$plan_nombre</h2>
                      $divprecio
                    </a>
                </div>
                <ul>
                    $plandetallehtml
                </ul>
                <a href='plan-detalle?id=$plan_id_old' class='btn btn-primary' style='margin-top: 5px'>Conocer Más</a>
                
            </div>
        </div>
      ";

       $plandetallehtml ="";

    }

    $listaplanservdet_id = utf8_encode($valor["listaplanservdet_id"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
    $listaplanservdet_descrip = utf8_encode($valor["listaplanservdet_descrip"]);
    $listaplanservdet_orden = utf8_encode($valor["listaplanservdet_orden"]);
    $listaplanservdet_activo = utf8_encode($valor["listaplanservdet_activo"]);

    $listaplanserv_id = utf8_encode($valor["listaplanserv_id"]);
    $l_planserv_id = utf8_encode($valor["l_planserv_id"]);
    $listaplaninversion_precio = utf8_encode($valor["listaplaninversion_precio"]);
    $listaplaninversion_ganancia = utf8_encode($valor["listaplaninversion_ganancia"]);  
    $listaplaninversion_diasduracion = utf8_encode($valor["listaplaninversion_diasduracion"]);  
    $listaplaninversion_url = utf8_encode($valor["listaplaninversion_url"]);
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);    
    $listaplanserv_fechareg = utf8_encode($valor["listaplanserv_fechareg"]);
    
    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $plan_img = utf8_encode($valor["plan_img"]);  
    $plan_orden = utf8_encode($valor["plan_orden"]);  
    $plan_activo = utf8_encode($valor["plan_activo"]);  

    $urlimgPlan = "arch/$plan_img";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $listaplaninversion_precioorig = $listaplaninversion_precio;

    if ($listaplaninversion_precio==""){$listaplaninversion_precio=0;}
    
    $listaplaninversion_precio = number_format_personalizado($listaplaninversion_precio,$moneda_siglas);

    if ($listaplaninversion_precioorig=="0" || $listaplaninversion_precioorig==""){
      $divprecio = "
        <h4 class='py-0' style='font-size: 20px; line-height: 30px'>         
          
        </h4>
      ";
      $divcontratar = "
        
      ";
    }else{
      $divprecio = "
        <h4 class='py-0' style='font-size: 20px; line-height: 30px'> 
          <span style='font-size: 20px'>$listaplaninversion_precio $moneda_siglas /$listaplaninversion_diasduracion días</span> <br>
        </h4>
      ";

      $divcontratar = "
        <a href='plan-forma-pago?id=$plan_id' class='btn btn-success' style='margin-top: 5px'>Contratar</a>
      ";
    }

    if ($listaplanservdet_descrip!=""){
      $plandetallehtml .= "
          <li class='my-4'> $listaplanservdet_descrip</li>
      ";  
    }
    

    $plan_id_old = $plan_id;

    $cont = $cont +1;

  }


  if ($plandetallehtml!=""){
    $planeshtml .= "
        <div class='col-lg-4 col-md-6' style='margin-bottom: 15px;'>
            <div class='package-content bg-light border text-center p-2 my-2 my-lg-0' style='background: #FFF; padding: 20px'>
                <div class='package-content-heading border-bottom'>
                    <a href='adquirirplaninversionformapago?id=$plan_id'>
                      <center>
                          <img src='$urlimgPlan' class='img-responsive' style='height:140px' />
                      </center>
                      <h2 style='padding-top: 10px; padding-bottom: 4px'>$plan_nombre</h2>
                      $divprecio
                    </a>
                </div>
                <ul style='padding-left: 0px; list-style:none'>
                    $plandetallehtml
                </ul>
                <a href='adquirirplaninversionformapago?id=$plan_id' class='btn btn-primary' style='margin-top: 5px'>Adquirir</a>
                
            </div>
        </div>
      ";
  }

  if ($planeshtml!=""){

    $planeshtml = "

    <div class='col-md-12'>
        <h3>Seleccione el plan que desea </h3>  
    </div>    

    $planeshtml
    ";
  }

  return $planeshtml;

}


function ListadoAgendaAbogado($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (agenda_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (agenda_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (agenda_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (agenda_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($estatusseleccionado!=""){
    $whereestatus =" and agenda.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and agenda.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and agenda.cuenta_id = '$_COOKIE[idcuenta]' and agenda.compania_id = '$_COOKIE[idcompania]' and agenda_activo = '1' and agenda.usuario_iddestino = '$_COOKIE[iniuser]'  ";

  } 

  
  $where .=" and estatus.lista_cod in (3,4) ";
  $urlgestion = "agendagestionarabogado";


  $conexion = new ConexionBd();

  
$arrresultado = $conexion->doSelect("
    agenda_nombre, agenda_email, agenda_telf, agenda_ciudad,
    agenda.agenda_id, agenda.usuario_idorigen, agenda.usuario_iddestino, 
    DATE_FORMAT(agenda_fechaagenda,'%d/%m/%Y %H:%i') as agenda_fechaagenda,
    DATE_FORMAT(agenda_fechareg,'%d/%m/%Y %H:%i:%s') as agenda_fechareg,
    agenda_observ,
    agenda.agenda_activo, agenda.agenda_eliminado, 
    agenda.cuenta_id, agenda.compania_id, agenda.l_estatus_id,     

    estatus.lista_nombre as estatus_nombre, estatus.lista_color as estatus_color,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre, 
            
    usuarioorigen.usuario_nombre as usuarioorigen_nombre, usuarioorigen.usuario_apellido as usuarioorigen_apellido,
    usuariodestino.usuario_nombre as usuariodestino_nombre, usuariodestino.usuario_apellido as usuariodestino_apellido
    ",
    "
    agenda      
      inner join usuario usuariodestino on usuariodestino.usuario_id = agenda.usuario_iddestino
      inner join usuario usuarioorigen on usuarioorigen.usuario_id = agenda.usuario_idorigen      
      inner join usuario cuenta on cuenta.usuario_id = agenda.cuenta_id
      inner join compania on compania.compania_id = agenda.compania_id 
      inner join lista estatus on estatus.lista_id = agenda.l_estatus_id             
      inner join agendacampana on agendacampana.agendacampana_id  = agenda.agendacampana_id
      
    ",
    "agenda.agenda_eliminado = '0' $where $whereestatus $wherefecha  ", null, "agenda.agenda_id asc");
  foreach($arrresultado as $i=>$valor){

    $agenda_nombre = utf8_encode($valor["agenda_nombre"]);
    $agenda_email = utf8_encode($valor["agenda_email"]);
    $agenda_telf = utf8_encode($valor["agenda_telf"]);
    $agenda_ciudad = utf8_encode($valor["agenda_ciudad"]);

    $agenda_id = utf8_encode($valor["agenda_id"]);
    $agenda_fechaagenda = utf8_encode($valor["agenda_fechaagenda"]);
    $agenda_fechareg = utf8_encode($valor["agenda_fechareg"]);
    $agenda_observ = utf8_encode($valor["agenda_observ"]);
    $agenda_activo = utf8_encode($valor["agenda_activo"]);    
    
    $usuario_idorigen = utf8_encode($valor["usuario_idorigen"]);
    $usuario_iddestino = utf8_encode($valor["usuario_iddestino"]);
        
    $usuarioorigen_nombre = utf8_encode($valor["usuarioorigen_nombre"]);
    $usuarioorigen_apellido = utf8_encode($valor["usuarioorigen_apellido"]);
    $usuariodestino_nombre = utf8_encode($valor["usuariodestino_nombre"]);
    $usuariodestino_apellido = utf8_encode($valor["usuariodestino_apellido"]);

    $usuarioorigen = $usuarioorigen_nombre." ".$usuarioorigen_apellido;
    $usuariodestino = $usuariodestino_nombre." ".$usuariodestino_apellido;
 
    $usuario_idorigen = utf8_encode($valor["usuario_idorigen"]);
    $usuario_iddestino = utf8_encode($valor["usuario_iddestino"]);    

    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
    $estatus_color = utf8_encode($valor["estatus_color"]);

    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $t_compania_id = utf8_encode($valor["compania_id"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $estatus = "
      <button type='button' class='btn btn-block btn-primary btn-xs' style='background: $estatus_color; border: 1px solid $estatus_color'>$estatus_nombre</button>
    ";
       
    
    if ($agenda_activo=="0"){
      $activo = "<i onclick='cambiarestatusagenda(\"".$agenda_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusagenda(\"".$agenda_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminaragenda(\"".$agenda_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
    $modificar = "<a href='modificaragenda?id=$agenda_id&cu=$t_cuenta_id&co=$t_compania_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $gestionar = "<a href='$urlgestion?id=$agenda_id'>Gestionar <br><i title='Gestionar Prostpecto' class='fa fa-play btn-realizar-tarea'></i></a>";

    $historial = "<a href='agendahistorial?id=$agenda_id'>Historial</a>";
  

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {
      $columnacuenta = "";
      $mostrarcolumnacuenta = ""; 
      $mostrarcolumnacompania = ""; 
    }

    $agenda_telfwhatsapp = str_replace("+", "", $agenda_telf);

    $agenda_telfwhatsapp = "
      $agenda_telf 
      <a href='https://api.whatsapp.com/send?phone=$agenda_telfwhatsapp'>
        <img src='dist/img/whatsapp.png' style='height: 25px'>
      </a>  
    ";

    $textohtml .= "
           <tr>               
                  $mostrarcolumnacuenta
                  $mostrarcolumnacompania                                     
                  <td style='text-align: center'>$gestionar</td>
                  <td style='text-align: center'>$historial</td>
                  <td>$estatus</td>
                  <td>$agenda_fechaagenda</td>
                    
                  <td>$usuariodestino</td>                                    
                  <td>$usuarioorigen</td>                                    
                  <td>$agenda_nombre</td>                                    
                  <td>$agenda_email</td> 
                  <td>$agenda_telfwhatsapp</td> 
                  <td>$agenda_ciudad</td> 
                  <td>$agenda_fechareg</td>                                                       
                                                   
                  
                  <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar </td>
              </tr>
        ";

  }

  return $textohtml;

}

function ListadoAgenda($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (agenda_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (agenda_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (agenda_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (agenda_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($estatusseleccionado!=""){
    $whereestatus =" and agenda.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }

  $urlgestion = "agendagestionar";

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and agenda.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

     if ($_COOKIE[perfil]=="60"){
        $urlgestion = "agendagestionarabogado";
        $where = " and agenda.cuenta_id = '$_COOKIE[idcuenta]' and agenda.compania_id = '$_COOKIE[idcompania]' and agenda_activo = '1' and agenda.usuario_iddestino = '$_COOKIE[iniuser]' ";
     }else{
        $where = " and agenda.cuenta_id = '$_COOKIE[idcuenta]' and agenda.compania_id = '$_COOKIE[idcompania]' and agenda_activo = '1' and agenda.usuario_idorigen = '$_COOKIE[iniuser]' ";  
     }

    

  } 

  

  $conexion = new ConexionBd();

  
$arrresultado = $conexion->doSelect("
    agenda_nombre, agenda_email, agenda_telf, agenda_ciudad,
    agenda.agenda_id, agenda.usuario_idorigen, agenda.usuario_iddestino, 
    DATE_FORMAT(agenda_fechaagenda,'%d/%m/%Y') as agenda_fechaagenda,
    DATE_FORMAT(agenda_fechareg,'%d/%m/%Y %H:%i:%s') as agenda_fechareg,
    agenda_observ,
    agenda.agenda_activo, agenda.agenda_eliminado, 
    agenda.cuenta_id, agenda.compania_id, agenda.l_estatus_id,     

    estatus.lista_nombre as estatus_nombre, 
    estatus.lista_color as estatus_color, 

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre, 
            
    usuarioorigen.usuario_nombre as usuarioorigen_nombre, usuarioorigen.usuario_apellido as usuarioorigen_apellido,
    usuariodestino.usuario_nombre as usuariodestino_nombre, usuariodestino.usuario_apellido as usuariodestino_apellido
    ",
    "
    agenda      
      left join usuario usuariodestino on usuariodestino.usuario_id = agenda.usuario_iddestino
      inner join usuario usuarioorigen on usuarioorigen.usuario_id = agenda.usuario_idorigen      
      inner join usuario cuenta on cuenta.usuario_id = agenda.cuenta_id
      inner join compania on compania.compania_id = agenda.compania_id 
      inner join lista estatus on estatus.lista_id = agenda.l_estatus_id             
      inner join agendacampana on agendacampana.agendacampana_id  = agenda.agendacampana_id
      
    ",
    "agenda.agenda_eliminado = '0' $where $whereestatus $wherefecha  ", null, "agenda.agenda_id asc");
  foreach($arrresultado as $i=>$valor){

    $agenda_nombre = utf8_encode($valor["agenda_nombre"]);
    $agenda_email = utf8_encode($valor["agenda_email"]);
    $agenda_telf = utf8_encode($valor["agenda_telf"]);
    $agenda_ciudad = utf8_encode($valor["agenda_ciudad"]);

    $agenda_id = utf8_encode($valor["agenda_id"]);
    $agenda_fechaagenda = utf8_encode($valor["agenda_fechaagenda"]);
    $agenda_fechareg = utf8_encode($valor["agenda_fechareg"]);
    $agenda_observ = utf8_encode($valor["agenda_observ"]);
    $agenda_activo = utf8_encode($valor["agenda_activo"]);    
    
    $usuario_idorigen = utf8_encode($valor["usuario_idorigen"]);
    $usuario_iddestino = utf8_encode($valor["usuario_iddestino"]);
        
    $usuarioorigen_nombre = utf8_encode($valor["usuarioorigen_nombre"]);
    $usuarioorigen_apellido = utf8_encode($valor["usuarioorigen_apellido"]);
    $usuariodestino_nombre = utf8_encode($valor["usuariodestino_nombre"]);
    $usuariodestino_apellido = utf8_encode($valor["usuariodestino_apellido"]);

    $usuarioorigen = $usuarioorigen_nombre." ".$usuarioorigen_apellido;
    $usuariodestino = $usuariodestino_nombre." ".$usuariodestino_apellido;
 
    $usuario_idorigen = utf8_encode($valor["usuario_idorigen"]);
    $usuario_iddestino = utf8_encode($valor["usuario_iddestino"]);    

    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
    $estatus_color = utf8_encode($valor["estatus_color"]);


    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $t_compania_id = utf8_encode($valor["compania_id"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
       
    
    if ($agenda_activo=="0"){
      $activo = "<i onclick='cambiarestatusagenda(\"".$agenda_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusagenda(\"".$agenda_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminaragenda(\"".$agenda_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
    $modificar = "<a href='modificaragenda?id=$agenda_id&cu=$t_cuenta_id&co=$t_compania_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $gestionar = "<a href='$urlgestion?id=$agenda_id'>Gestionar <br><i title='Gestionar Prostpecto' class='fa fa-play btn-realizar-tarea'></i></a>";

    $historial = "<a href='agendahistorial?id=$agenda_id'>Historial</a>";
  

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {
      $columnacuenta = "";
      $mostrarcolumnacuenta = ""; 
      $mostrarcolumnacompania = ""; 
    }

    $estatus = "
      <button type='button' class='btn btn-block btn-primary btn-xs' style='background: $estatus_color; border: 1px solid $estatus_color'>$estatus_nombre</button>
    ";

    $agenda_telfwhatsapp = str_replace("+", "", $agenda_telf);

    $agenda_telfwhatsapp = "
      $agenda_telf 
      <a href='https://api.whatsapp.com/send?phone=$agenda_telfwhatsapp'>
        <img src='dist/img/whatsapp.png' style='height: 25px'>
      </a>  
    ";

    $agenda_email = "
      $agenda_email 
      <a href='mailto:$agenda_email'>
        <img src='dist/img/email2.png' style='height: 18px; width: 22px'>
      </a>  
    ";


    $textohtml .= "
           <tr>               
                  $mostrarcolumnacuenta
                  $mostrarcolumnacompania                                     
                  <td style='text-align: center'>$gestionar</td>
                  <td style='text-align: center'>$historial</td>
                  <td>$estatus</td>  
                  <td>$usuarioorigen</td>                                    
                  <td>$agenda_nombre</td>                                    
                  <td>$agenda_email</td> 
                  <td>$agenda_telfwhatsapp</td> 
                  <td>$agenda_ciudad</td> 
                  <td>$agenda_fechareg</td>                                                       
                                                   
                  
                  <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar </td>
              </tr>
        ";

  }

  return $textohtml;

}

function ListadoContratos($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null, $retornaroption=null, $idseleccionado=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (doc_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (doc_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (doc_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (doc_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($estatusseleccionado!=""){
    $whereestatus =" and documento.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and documento.cuenta_id = '$_COOKIE[idcuenta]' ";

      if ($companiaseleccionada!=""){
        $where = " and documento.cuenta_id = '$_COOKIE[idcuenta]' and documento.compania_id = '$companiaseleccionada' and doc_activo = '1' ";              
      }

  }  else { 

    $where = " and documento.cuenta_id = '$_COOKIE[idcuenta]' and documento.compania_id = '$_COOKIE[idcompania]' and doc_activo = '1' ";

  } 

  if ($retornaroption=="1"){
    $option = "<option value=''>-- Seleccione --</option>";
    $wherefecha = "";
    $whereestatus = "";
  }

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("
    documento.doc_id, documento.l_tipodoc_id, documento.doc_codigo, documento.doc_nombre, documento.doc_descrip, 
    documento.doc_activo, documento.doc_eliminado, documento.cuenta_id, documento.compania_id,
    documentocontrato.l_moneda_id,
    documentocontrato.doccontrato_id, documentocontrato.doc_id, documentocontrato.usuario_idorigen, 
    documentocontrato.usuario_iddestino, documentocontrato.doccontrato_montopagar, 
    documentocontrato.doccontrato_cuotas, documentocontrato.doccontrato_montocuota, documentocontrato.doccontrato_diascuota,     
    documentocontrato.doccontrato_activo, documentocontrato.doccontrato_eliminado, documentocontrato.cuenta_id, 
    documentocontrato.compania_id, documento.l_estatus_id,

    estatus.lista_nombre as estatus_nombre,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre, 

    DATE_FORMAT(doc_fechareg,'%d/%m/%Y %H:%i:%s') as doc_fechareg,
    DATE_FORMAT(doccontrato_fechaini,'%d/%m/%Y') as doccontrato_fechaini,
    DATE_FORMAT(doccontrato_fechafin,'%d/%m/%Y') as doccontrato_fechafin,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas,

    usuarioorigen.usuario_nombre as usuarioorigen_nombre, usuarioorigen.usuario_apellido as usuarioorigen_apellido,
    usuariodestino.usuario_nombre as usuariodestino_nombre, usuariodestino.usuario_apellido as usuariodestino_apellido
    ",
    "documento    
      inner join documentocontrato on documentocontrato.doc_id = documento.doc_id
      inner join usuario usuarioorigen on usuarioorigen.usuario_id = documentocontrato.usuario_idorigen
      inner join usuario usuariodestino on usuariodestino.usuario_id = documentocontrato.usuario_iddestino
      inner join usuario cuenta on cuenta.usuario_id = documento.cuenta_id
      inner join compania on compania.compania_id = documento.compania_id 
      left join lista estatus on estatus.lista_id = documento.l_estatus_id       
      left join lista moneda on moneda.lista_id = documentocontrato.l_moneda_id
      
    ",
    "documento.doc_eliminado = '0' $where $whereestatus $wherefecha ", null, "documento.doc_id asc");
  foreach($arrresultado as $i=>$valor){

    $doc_fechareg = utf8_encode($valor["doc_fechareg"]);
    $doccontrato_fechaini = utf8_encode($valor["doccontrato_fechaini"]);
    $doccontrato_fechafin = utf8_encode($valor["doccontrato_fechafin"]);
    $usuarioorigen_nombre = utf8_encode($valor["usuarioorigen_nombre"]);
    $usuarioorigen_apellido = utf8_encode($valor["usuarioorigen_apellido"]);
    $usuariodestino_nombre = utf8_encode($valor["usuariodestino_nombre"]);
    $usuariodestino_apellido = utf8_encode($valor["usuariodestino_apellido"]);

    $usuarioorigen = $usuarioorigen_nombre." ".$usuarioorigen_apellido;
    $usuariodestino = $usuariodestino_nombre." ".$usuariodestino_apellido;

    $doc_id = utf8_encode($valor["doc_id"]);
    $l_tipodoc_id = utf8_encode($valor["l_tipodoc_id"]);
    $doc_codigo = utf8_encode($valor["doc_codigo"]);
    $doc_nombre = utf8_encode($valor["doc_nombre"]);
    $doc_descrip = utf8_encode($valor["doc_descrip"]);
    $doc_activo = utf8_encode($valor["doc_activo"]);


    if ($retornaroption=="1"){
      $existeunoption = 1;
      if ($doc_id==$idseleccionado){
        $option = "<option value='$doc_id' selected= 'selected'>#$doc_codigo $usuariodestino</option>";    
      }else{
        $option = "<option value='$doc_id'>#$doc_codigo $usuariodestino</option>";    
      }
    }
    
    
    $doccontrato_id = utf8_encode($valor["doccontrato_id"]);
    $usuario_idorigen = utf8_encode($valor["usuario_idorigen"]);
    $usuario_iddestino = utf8_encode($valor["usuario_iddestino"]);    
    $doccontrato_montopagar = utf8_encode($valor["doccontrato_montopagar"]);
    $doccontrato_cuotas = utf8_encode($valor["doccontrato_cuotas"]);
    $doccontrato_montocuota = utf8_encode($valor["doccontrato_montocuota"]);
    $doccontrato_diascuota = utf8_encode($valor["doccontrato_diascuota"]);
    $doccontrato_activo = utf8_encode($valor["doccontrato_activo"]);    

    $l_moneda_id = utf8_encode($valor["l_moneda_id"]);
    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $t_compania_id = utf8_encode($valor["compania_id"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    
    if ($doc_activo=="0"){
      $activo = "<i onclick='cambiarestatusdocumento(\"".$doc_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusdocumento(\"".$doc_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminardocumento(\"".$doc_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
    $modificar = "<a href='modificarcontrato?id=$doc_id&cu=$t_cuenta_id&co=$t_compania_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $vercontratopdf = "<a href='contratopdf?id=$doc_id' target='_blank'>
    <img title='Ver Contrato' style='cursor:pointer; height: 24px; width: 20px' src='dist/img/pdf.png'>
    </a>";
  

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {
      $columnacuenta = "";
      $mostrarcolumnacuenta = ""; 
      $mostrarcolumnacompania = ""; 
    }
    

    $textohtml .= "
           <tr>               
                  $mostrarcolumnacuenta
                  $mostrarcolumnacompania 
                  <td>$doc_nombre</td>
                  <td>$doc_codigo</td>
                  <td>$usuarioorigen</td>                                    
                  <td>$usuariodestino</td> 
                  <td>$estatus_nombre</td>                                   
                  <td>$doc_fechareg</td>                                                       
                  <td style='text-align: center'>$vercontratopdf  &nbsp $modificar &nbsp $verdocumentopdf &nbsp $activo &nbsp $accioneliminar </td>
              </tr>
        ";


  }

  if ($retornaroption=="1"){
    if ($existeunoption!="1"){
      $option = "<option  value=''>NO EXISTEN CONTRATOS EN COMPAÑIA</option>";
    }

    if ($companiaseleccionada==""){
      $option = "<option  value=''>-- Primero seleccione la Compañia --</option>"; 
    }



    return $option;
  }

  return $textohtml;

}


function ObtenerListaTipoListaProducto($cuentaseleccionada=null, $companiaseleccionada=null, $getelemento=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($_COOKIE[perfil]=="1"){  
    
    
    if ($cuentaseleccionada!=""){
      $wherecompania = " and tipolistarel.cuenta_id = '$cuentaseleccionada' ";     
    } 
    
  } else if ($_COOKIE[perfil]=="2"){   
  
    $wherecompania = " and tipolistarel.cuenta_id = '$_COOKIE[idcuenta]' ";     
    
  } else {
  
    $wherecompania = " and tipolistarel.cuenta_id = '$_COOKIE[idcuenta]' and tipolistarel.compania_id = '$_COOKIE[idcompania]' ";     
    
  }

  
  $arrresultado = $conexion->doSelect("tipolista.tipolista_id, tipolista.tipolista_nombre, tipolistarel_id
    ",
    "
    tipolista
      inner join tipolistarel on tipolista.tipolista_id = tipolistarel.tipolista_id and tipolistarel_activo = '1'

    ",
    "tipolista_activo = '1' $wherecompania", null, "tipolista_nombre asc");

  $option = "<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

      $tipolista_id = utf8_encode($valor["tipolista_id"]);  
      $tipolista_nombre = utf8_encode($valor["tipolista_nombre"]);  
      $tipolistarel_id = utf8_encode($valor["tipolistarel_id"]);  

      if ($tipolistarel_id!=""){
        $option .= "<option selected='selected' value='$tipolista_id'>$tipolista_nombre</option>";
      }else{
        $option .= "<option value='$tipolista_id'>$tipolista_nombre</option>";
      }
     
  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN LISTAS PARA PRECIOS</option>";
  }

  return $option;

}


function ObtenerTipoListaMultiple($tipolista_id=null, $cuenta=null, $compania=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $arrresultado = $conexion->doSelect("tipolista.tipolista_id, tipolista_nombre, tipolista_prod, tipolistarel_id",
      "tipolista
        left join tipolistarel on tipolistarel.tipolista_id = tipolista.tipolista_id and tipolistarel.cuenta_id ='$cuenta' 
        and tipolistarel.compania_id = '$compania' and tipolistarel_activo = '1'
      ",
      "tipolista_prod = '1'", null, "tipolista_nombre asc");

  foreach($arrresultado as $i=>$valor){

    $tipolista_id = utf8_encode($valor["tipolista_id"]);  
    $tipolista_nombre = utf8_encode($valor["tipolista_nombre"]);  
    $tipolistarel_id = utf8_encode($valor["tipolistarel_id"]);    

    $nombrecolocar = $lista_nombre;

    if ($tipolistarel_id!=""){
      $option .= "<option selected='selected' value='$tipolista_id'>$tipolista_nombre</option>";
    }else{
      $option .= "<option value='$tipolista_id'>$tipolista_nombre</option>";
    }
  }

  $option = "
    <select class='form-control select2' id='$tipolista_id' name='valoresmultipletipolista[]' multiple='multiple' style='width:100%' >
      $option
    </select>
  ";


  return $option;


}



function ListadoPagoUsuarioServicios($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,
    pago.l_estatus_id, 

    pagotransaccion.pagotrans_id, pagotransaccion.trans_id, 
    pagotransaccion.pagotrans_fechareg,
    estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania.compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania.compania_urlweb, 
    transaccion.trans_codigo,
    companiacliente.compania_nombre as companiacliente_nombre

    ",
    "pago
      inner join pagotransaccion on pagotransaccion.pago_id = pago.pago_id
      inner join transaccion on transaccion.trans_id = pagotransaccion.trans_id
      inner join lista moneda on moneda.lista_id = pago.l_moneda_id      
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id
      left join compania companiacliente on companiacliente.compania_id = usuario.compania_idrel

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 



  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){
    $companiacliente_nombre = utf8_encode($valor["companiacliente_nombre"]);
    $trans_codigo = utf8_encode($valor["trans_codigo"]);
    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);

    $pagotrans_id = utf8_encode($valor["pagotrans_id"]);      
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]); 
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);


    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $aaa); 

    $pedido = "#$trans_codigo";

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verpagoservicio?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verpagoservicio?id=$pago_id'>#$pago_id (Ver)</a>";


    $textohtml .= "
          <tr>                           
            <td>$verid</td>            
            <td>$companiacliente_nombre</td>     
            <td>$usuario</td>     
            <td>$pedido</td>               
            <td>$pago_monto $moneda_siglas</td>         
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}


function ListadoPagoUsuarios($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  } else if ($_COOKIE[perfil]=="3"){ // Administrador de Compañia  
      
    $columnacompania = "<th>Compañia</th>";
    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]'";

}  else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,
    pago.l_estatus_id, 

    estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb, 
    formapago.lista_nombre as formapago_nombre,
    pago_codexterno, pago.modulo_id, pago.elemento_id,
    modulo_nombreunico, tipopago.lista_cod as tipopago_cod,
    pago_codint,
    estatus.lista_cod as estatus_cod

    ",
    "pago      
      inner join lista moneda on moneda.lista_id = pago.l_moneda_id      
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id
      inner join lista formapago on formapago.lista_id = pago.l_formapago_id
      left join modulo on modulo.modulo_id = pago.modulo_id
      left join lista tipopago on tipopago.lista_id = pago.l_tipopago_id

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 

  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){
    $tipopago_cod = utf8_encode($valor["tipopago_cod"]);
    $pago_codint = utf8_encode($valor["pago_codint"]);
    $estatus_cod = utf8_encode($valor["estatus_cod"]);
    

    $modulo_id = utf8_encode($valor["modulo_id"]);
    $modulo_nombreunico = utf8_encode($valor["modulo_nombreunico"]);
    $elemento_id = utf8_encode($valor["elemento_id"]);
    $pago_codexterno = utf8_encode($valor["pago_codexterno"]);

    $formapago_nombre = utf8_encode($valor["formapago_nombre"]);

    $trans_codigo = utf8_encode($valor["trans_codigo"]);
    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);

    $pagotrans_id = utf8_encode($valor["pagotrans_id"]);      
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]); 
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);


    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $aaa); 

    $pedido = "#$pago_codexterno";

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $urlir = "";
    $verid = "";

    if ($modulo_id=="1"){
      $urlir = "verpagoventa?id=$pago_id";
      $verid = "<a href='$urlir'>#$pago_codint (Ver Pago $modulo_nombreunico)</a>";
    }
    else if ($modulo_id=="1129"){
      $urlir = "verpagoprestamo?id=$pago_id";
      $verid = "<a href='$urlir'>#$pago_codint (Ver Pago $modulo_nombreunico)</a>";
    }
    else if ($modulo_id=="1464"){
      $urlir = "verpagoreservaviaje?id=$pago_id";
      $verid = "<a href='$urlir'>#$pago_codexterno (Ver Pago $modulo_nombreunico)</a>";
    }else if ($modulo_id=="1467"){
      $urlir = "verpagoenvio?id=$pago_id";
      $verid = "<a href='$urlir'>#$pago_codexterno (Ver Pago $modulo_nombreunico)</a>";
    }else if ($modulo_id=="1476"){// Pago de Remesas
      $urlir = "verpagoremesa?id=$pago_id";
      $verid = "<a href='$urlir'>#$pago_codexterno (Ver Pago $modulo_nombreunico)</a>";
    }else if ($modulo_id=="1130"){
      $urlir = "verpagoprestamo?id=$pago_id";
      $verid = "<a href='$urlir'>#$pago_codint (Ver Pago $modulo_nombreunico)</a>";

      if ($estatus_cod=="2"){
        $verenpdf = "<a href='verpagoprestamopdf?id=$pago_id' target='_blank'>
          <img title='Ver Pago en PDF' style='cursor:pointer; height: 24px; width: 20px' src='dist/img/pdf.png'>
        </a>";
      }
      
    }
    else if ($modulo_id=="1222"){
      $urlir = "verpagocuotausuario?id=$pago_id";
      $verid = "<a href='$urlir'>#$pago_codint (Ver Pago $modulo_nombreunico)</a>";
    }else if ($tipopago_cod=="1"){// Deposito
      $urlir = "verpagodeposito?id=$pago_id";
      $verid = "<a href='$urlir'>#$pago_codint (Ver Depósito)</a>";
      $modulo_nombreunico = "Depósito";
    }

    $modificar = "<a href='$urlir'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verenpdf ="";

    

    


    $textohtml .= "
          <tr>               
            <td>$pago_id</td>  
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>   
            <td>$modulo_nombreunico</td>            
            <td>$usuario</td>                 
            <td>$pago_monto $moneda_siglas</td>    
            <td>$formapago_nombre</td>   
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>$verenpdf &nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}


function ListadoInversionUsuario($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $usuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (usuarioinversion.usuarioinversion_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (usuarioinversion.usuarioinversion_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (usuarioinversion.usuarioinversion_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (usuarioinversion.usuarioinversion_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and usuarioinversion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and usuarioinversion.cuenta_id = '$_COOKIE[idcuenta]' and usuarioinversion.compania_id = '$_COOKIE[idcompania]' and usuarioinversion.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($getestatus!=""){
    $whereestatus = " and usuarioinversion.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    



  $arrresultado = $conexion->doSelect("

    usuarioinversion.usuarioinversion_id,
    usuarioinversion.usuario_id, usuarioinversion.l_plan_id, usuarioinversion.l_estatus_id,     
    usuarioinversion.usuarioinversion_activo, usuarioinversion.usuarioinversion_eliminado, 
    usuarioinversion.cuenta_id, usuarioinversion.compania_id,

    usuarioinversion.usuarioinversion_codglobal,

    DATE_FORMAT(usuarioinversion.usuarioinversion_fechareg,'%d/%m/%Y %H:%i:%s') as usuarioinversion_fechareg,
    DATE_FORMAT(usuarioinversion.usuarioinversion_fechaini,'%d/%m/%Y') as usuarioinversion_fechaini,
    DATE_FORMAT(usuarioinversion.usuarioinversion_fechafin,'%d/%m/%Y') as usuarioinversion_fechafin,

    plan.lista_nombre as plan_nombre, estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    pago.pago_codglobal, pago.pago_id

    ",
    "usuarioinversion      
      inner join lista plan on plan.lista_id = usuarioinversion.l_plan_id
      inner join lista estatus on estatus.lista_id = usuarioinversion.l_estatus_id
      
      inner join usuario on usuario.usuario_id = usuarioinversion.usuario_id

      inner join usuario cuenta on cuenta.usuario_id = usuarioinversion.cuenta_id
      inner join compania on compania.compania_id = usuarioinversion.compania_id     

      inner join pago on pago.pago_id = usuarioinversion.pago_id       

    ",
    "usuarioinversion_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "usuarioinversion.usuarioinversion_id desc"); 

  foreach($arrresultado as $i=>$valor){
    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_codglobal = utf8_encode($valor["pago_codglobal"]);    

    $usuarioinversion_id = utf8_encode($valor["usuarioinversion_id"]);
    $usuarioinversion_codglobal = utf8_encode($valor["usuarioinversion_codglobal"]);    
    $usuario_idorigen = utf8_encode($valor["usuario_idorigen"]);
    $usuario_id = utf8_encode($valor["usuario_id"]);
    $l_plan_id = utf8_encode($valor["l_plan_id"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $usuarioinversion_activo = utf8_encode($valor["usuarioinversion_activo"]);
    $usuarioinversion_fechareg = utf8_encode($valor["usuarioinversion_fechareg"]);
    $usuarioinversion_fechaini = utf8_encode($valor["usuarioinversion_fechaini"]);
    $usuarioinversion_fechafin = utf8_encode($valor["usuarioinversion_fechafin"]);

    
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);

    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
    

    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);  

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";    

    if ($usuarioinversion_activo=="0"){
      $activo = "<i onclick='cambiarestatusafiliacioninversion(\"".$usuarioinversion_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusafiliacioninversion(\"".$usuarioinversion_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarafiliacioninversion(\"".$usuarioinversion_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    //$modificar = "<a href='verpagoinversion?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verafiliacion = "Inversión #$usuarioinversion_codglobal";

    $verpago = "<a href='verpagoinversion?id=$pago_id'>Pago #$pago_codglobal (Ver)</a>";


    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania    
            <td>$verafiliacion</td>              
            <td>$usuario</td>     
            <td>$plan_nombre</td>               
            <td>$estatus_nombre</td>                  
            <td>$usuarioinversion_fechaini</td>         
            <td>$usuarioinversion_fechafin</td>                       
            <td>$verpago</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}





function ListadoPagoUsuarioInversion($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,

    pagoplaninversion.pagoplaninversion_id, pagoplaninversion.pago_id, pagoplaninversion.l_plan_id, pago.l_estatus_id, 
    pagoplaninversion.pagoplaninversion_fechareg,
    pagoplaninversion.pagoplaninversion_observacion, pagoplaninversion.usuario_idreg,

    plan.lista_nombre as plan_nombre, estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb

    ",
    "pago
      inner join pagoplaninversion on pagoplaninversion.pago_id = pago.pago_id
      inner join lista moneda on moneda.lista_id = pago.l_moneda_id
      inner join lista plan on plan.lista_id = pagoplaninversion.l_plan_id
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 



  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);
    $pagoplaninversion_id = utf8_encode($valor["pagoplaninversion_id"]);  
    $l_plan_id = utf8_encode($valor["l_plan_id"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $pagoplaninversion_fechareg = utf8_encode($valor["pagoplaninversion_fechareg"]);
    $pagoplaninversion_observacion = utf8_encode($valor["pagoplaninversion_observacion"]);

    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    

    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $aaa); 

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verpagoinversion?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verpagoinversion?id=$pago_id'>#$pago_id (Ver)</a>";


    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>            
            <td>$usuario</td>     
            <td>$plan_nombre</td>               
            <td>$pago_monto $moneda_siglas</td>         
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}


// function ObtenerListaSubCategoriaDos($cuenta=null, $compania=null, $lista_idreldos=null, $lista_idrel=null,  $elementoid=null){
//   if ($ordenar=="entero"){
//     $orderby = "CAST(lista_nombre AS UNSIGNED)";
//   }else{
//     $orderby = "listacuenta_nombre";
//   }

//   $tipolista_id = "68";

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];

//   $option = "<option value=''>-- Seleccione --</option>";

//   if ($lista_idrel!="" && $lista_idreldos!=""){
//     $wherelistarel = " and lista.lista_idrel = '$lista_idrel' and  lista.lista_idreldos = '$lista_idreldos' ";
  
//     if ($cuenta!="" ){
      
//         $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
//           listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
//               "lista                
//                   left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
//                   and listacuenta.compania_id = '$compania' 
//               ",
//               "lista_activo = '1' and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");

//         if (count($arrresultado)==0){

//            $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
//             listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
//               "lista                 
//                   left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
//                   and listacuenta.compania_id = '$compania' 
//               ",
//               "lista_activo = '1' $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");


//         }

      
//       foreach($arrresultado as $i=>$valor){

//         $lista_id = utf8_encode($valor["lista_id"]);  
//         $lista_nombre = utf8_encode($valor["lista_nombre"]);  
//         $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
//         $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
//         $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
//         $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  

//         if ($listacuenta_id!=""){
//           if ($listacuenta_activo=="1"){
//             if ($elementoid==$lista_id){
//                 $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
//             }else{
//                 $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
//             }    
//           }
//         }else{
//           if ($elementoid==$lista_id){
//               $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
//           }else{
//               $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
//           }    
//         }  
//       }
//     }

//     if (count($arrresultado)==0 && $compania==""){
//       $option = "<option  value=''>Seleccione Primero la Compañia</option>";
//     }else if (count($arrresultado)==0){
//       $option = "<option  value=''>NO EXISTEN SUB CATEGORIAS DOS</option>";
//     }

//   }else{
//     $option = "<option  value=''>Seleccione Primero la Sub Categoria</option>";
//   }
  
  
 
//   return $option;

// }


// function ObtenerListaSubCategoria($cuenta=null, $compania=null, $lista_idrel=null, $elementoid=null){
//   if ($ordenar=="entero"){
//     $orderby = "CAST(lista_nombre AS UNSIGNED)";
//   }else{
//     $orderby = "listacuenta_nombre";
//   }

//   $tipolista_id = "40";

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];

//   $option = "<option value=''>-- Seleccione --</option>";

//   if ($lista_idrel!=""){
//     $wherelistarel = " and lista.lista_idrel = '$lista_idrel' ";
  
//     if ($cuenta!="" ){
      
//         $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
//           listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
//               "lista                
//                   left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
//                   and listacuenta.compania_id = '$compania' 
//               ",
//               "lista_activo = '1' and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");

//         if (count($arrresultado)==0){

//            $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
//             listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
//               "lista                 
//                   left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
//                   and listacuenta.compania_id = '$compania' 
//               ",
//               "lista_activo = '1' $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");


//         }

      
//       foreach($arrresultado as $i=>$valor){

//         $lista_id = utf8_encode($valor["lista_id"]);  
//         $lista_nombre = utf8_encode($valor["lista_nombre"]);  
//         $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
//         $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
//         $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
//         $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  

//         if ($listacuenta_id!=""){
//           if ($listacuenta_activo=="1"){
//             if ($elementoid==$lista_id){
//                 $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
//             }else{
//                 $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
//             }    
//           }
//         }else{
//           if ($elementoid==$lista_id){
//               $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
//           }else{
//               $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
//           }    
//         }  
//       }
//     }

//     if (count($arrresultado)==0 && $compania==""){
//       $option = "<option  value=''>Seleccione Primero la Compañia</option>";
//     }else if (count($arrresultado)==0){
//       $option = "<option  value=''>NO EXISTEN SUB CATEGORIAS</option>";
//     }

//   }else{
//     $option = "<option  value=''>Seleccione Primero la Categoria</option>";
//   }
  
  
 
//   return $option;

// }


// function ObtenerListaCategoria($cuenta=null, $compania=null, $elementoid=null){
//   if ($ordenar=="entero"){
//     $orderby = "CAST(lista_nombre AS UNSIGNED)";
//   }else{
//     $orderby = "listacuenta_nombre";
//   }

//   $tipolista_id = "39";

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];

//   $option = "<option value=''>-- Seleccione --</option>";

//   if ($listaid_rel!=""){
//     $wherelistarel = " and lista.lista_idrel = '$listaid_rel' ";
//   }


//   if ($cuenta!="" ){
    
//       $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
//         listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
//             "lista                
//                 left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
//                 and listacuenta.compania_id = '$compania' 
//             ",
//             "lista_activo = '1' and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");

//       if (count($arrresultado)==0){

//          $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
//           listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
//             "lista                 
//                 left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
//                 and listacuenta.compania_id = '$compania' 
//             ",
//             "lista_activo = '1' $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "CAST(lista_nombre AS UNSIGNED) asc");


//       }

    
//     foreach($arrresultado as $i=>$valor){

//       $lista_id = utf8_encode($valor["lista_id"]);  
//       $lista_nombre = utf8_encode($valor["lista_nombre"]);  
//       $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
//       $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
//       $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
//       $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  

//       if ($listacuenta_id!=""){
//         if ($listacuenta_activo=="1"){
//           if ($elementoid==$lista_id){
//               $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
//           }else{
//               $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
//           }    
//         }
//       }else{
//         if ($elementoid==$lista_id){
//             $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
//         }else{
//             $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
//         }    
//       }  
//     }
//   }
  
//   if (count($arrresultado)==0 && $compania==""){
//     $option = "<option  value=''>Seleccione Primero la Compañia</option>";
//   }else if (count($arrresultado)==0){
//     $option = "<option  value=''>NO EXISTEN VALORES</option>";
//   }
 
//   return $option;

// }


function ObtenerListaPlanesEvento($cuentaseleccionada=null, $companiaseleccionada=null, $usuario_idget =null, $getevento_id =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and listaplanevento.cuenta_id = '$_COOKIE[idcuenta]' ";          


  }  else { 

    $where = " and listaplanevento.cuenta_id = '$_COOKIE[idcuenta]' and listaplanevento.compania_id = '$_COOKIE[idcompania]' ";
    $wherelistaactivo = " and plan.lista_activo = '1' ";
  } 



  $arrresultado = $conexion->doSelect("
   
    listaplanevento_id, listaplanevento.l_planevento_id, listaplanevento.l_moneda_id, listaplanevento.evento_id, 
    listaplanevento.eventocateg_id, listaplanevento.listaplanevento_precio, 
    listaplanevento.cuenta_id, listaplanevento.compania_id, 
    listaplanevento.listaplanevento_fechareg, listaplanevento.usuario_idreg, listaplanevento.listaplanevento_url, 

    plan.lista_id as plan_id, plan.lista_nombre as plan_nombre, plan.lista_img as plan_img,
    plan.lista_orden as plan_orden, plan.lista_activo as plan_activo,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    listaplanservdet_id, listaplanservdet_descrip, listaplanservdet_orden, listaplanservdet_activo,

    moneda.lista_nombredos as moneda_siglas, 

    evento_nombre, evento.evento_id
      ",
    "
    listaplanevento
        inner join lista plan on plan.lista_id = listaplanevento.l_planevento_id          
        inner join usuario cuenta on cuenta.usuario_id = listaplanevento.cuenta_id
        inner join compania on compania.compania_id = listaplanevento.compania_id  
        inner join evento on evento.evento_id = listaplanevento.evento_id


        left join lista moneda on moneda.lista_id = listaplanevento.l_moneda_id       
        left join listaplanserviciodetalle on listaplanserviciodetalle.l_plan_id = plan.lista_id 
        and listaplanservdet_activo = '1'
    ",
    " plan.lista_activo = '1' and listaplanevento.evento_id = '$getevento_id' $where  $wherelistaactivo", null, "plan.lista_orden, plan.lista_id, listaplanserviciodetalle.listaplanservdet_orden  asc");

  $cont = 0;
  foreach($arrresultado as $i=>$valor){

    $plan_id = utf8_encode($valor["plan_id"]);
    $evento_nombre = utf8_encode($valor["evento_nombre"]);
    $evento_id = utf8_encode($valor["evento_id"]);

    if ($plan_id_old!=$plan_id && $cont!="0"){   

      $planeshtml .= "
        <div class='col-lg-3 col-md-6' style='margin-bottom: 15px'>
            <div class='package-content bg-light border text-center p-2 my-2 my-lg-0' style='background: #FFF; padding: 20px'>
                <div class='package-content-heading border-bottom'>
                    <a href='adquirirplaneventoformapago?e=$evento_id&id=$plan_id_old'>
                      <center>
                          <img src='$urlimgPlan' class='img-responsive' style='height:100px' />
                      </center>
                      <h2 style='padding-top: 10px; padding-bottom: 4px'>$plan_nombre</h2>
                      $divprecio
                    </a>
                </div>
                <ul>
                    $plandetallehtml
                </ul>
                <a href='adquirirplaneventoformapago?id=$plan_id_old' class='btn btn-primary' style='margin-top: 5px'>Adquirir</a>
                
            </div>
        </div>
      ";

       $plandetallehtml ="";

    }

    $listaplanservdet_id = utf8_encode($valor["listaplanservdet_id"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
    $listaplanservdet_descrip = utf8_encode($valor["listaplanservdet_descrip"]);
    $listaplanservdet_orden = utf8_encode($valor["listaplanservdet_orden"]);
    $listaplanservdet_activo = utf8_encode($valor["listaplanservdet_activo"]);

    $listaplanevento_id = utf8_encode($valor["listaplanevento_id"]);
    $l_planevento_id = utf8_encode($valor["l_planevento_id"]);
    $l_moneda_id = utf8_encode($valor["l_moneda_id"]);
    $l_evento_id = utf8_encode($valor["evento_id"]);
    $l_eventocateg_id = utf8_encode($valor["eventocateg_id"]);
    $listaplanevento_precio = utf8_encode($valor["listaplanevento_precio"]);    
    $listaplanevento_fechareg = utf8_encode($valor["listaplanevento_fechareg"]);
    $listaplanevento_url = utf8_encode($valor["listaplanevento_url"]);
    
    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $plan_img = utf8_encode($valor["plan_img"]);  
    $plan_orden = utf8_encode($valor["plan_orden"]);  
    $plan_activo = utf8_encode($valor["plan_activo"]);  

    $urlimgPlan = "arch/$plan_img";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $listaplanevento_precioorig = $listaplanevento_precio;

    if ($listaplanevento_precio==""){$listaplanevento_precio=0;}
    
    $listaplanevento_precio = number_format_personalizado($listaplanevento_precio,$moneda_siglas);

    if ($listaplanevento_precioorig=="0" || $listaplanevento_precioorig==""){
      $divprecio = "
        <h4 class='py-0' style='font-size: 20px; line-height: 30px'>         
          
        </h4>
      ";
      $divcontratar = "
        
      ";
    }else{
      $divprecio = "
        <h4 class='py-0' style='font-size: 20px; line-height: 30px'> 
          <span style='font-size: 20px'>$listaplanevento_precio $moneda_siglas </span> <br>
        </h4>
      ";

      $divcontratar = "
        <a href='plan-forma-pago?id=$plan_id' class='btn btn-success' style='margin-top: 5px'>Contratar</a>
      ";
    }

    $plandetallehtml .= "
          <li class='my-4'> $listaplanservdet_descrip</li>
      ";

    $plan_id_old = $plan_id;

    $cont = $cont +1;

  }


  if ($plandetallehtml!=""){
    $planeshtml .= "
       <div class='col-lg-3 col-md-6' style='margin-bottom: 15px'>
            <div class='package-content bg-light border text-center p-2 my-2 my-lg-0' style='background: #FFF; padding: 20px'>
                <div class='package-content-heading border-bottom'>
                    <a href='adquirirplaneventoformapago?e=$evento_id&id=$plan_id_old'>
                      <center>
                          <img src='$urlimgPlan' class='img-responsive' style='height:100px' />
                      </center>
                      <h2 style='padding-top: 10px; padding-bottom: 4px'>$plan_nombre</h2>
                      $divprecio
                    </a>
                </div>
                <ul>
                    $plandetallehtml
                </ul>
                <a href='adquirirplaneventoformapago?id=$plan_id_old' class='btn btn-primary' style='margin-top: 5px'>Adquirir</a>
                
            </div>
        </div>  
      ";
  }

  if ($planeshtml!=""){

    $planeshtml = "

    <div class='col-md-12'>
        <h3>Evento: $evento_nombre</h3>  
        <h3>Seleccione su Categoría </h3>  
    </div>    

    $planeshtml
    ";
  }else{

    $planeshtml = "

      <div class='col-md-12'>          
          <div class='alert alert-danger' style='text-align: center; font-weight: normal;'>
              <a style='color: #FFF; font-size: 14px; text-decoration: none;'>
                  No existen categorias cargadas para este evento.
              </a><br>
          </div>
      </div>    
    ";
  }

  return $planeshtml;

}

function TransformaEnteroDecimales($valor=null){

  $valor = number_format($valor, 2, ',', '.');

  return $valor;
}

function ObtenerListaOpcionesRetiro($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    $where = "";
  }else if ($_COOKIE[perfil]=="2"){ // Administrador del Sistema
    $where = " and usuario.cuenta_id = '$cuentaseleccionada'";
  } else {
    $where = " and usuario.cuenta_id = '$cuentaseleccionada' and usuario.compania_id = '$companiaseleccionada' ";
  }


  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>No tiene Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>No tiene Compañia</option>";
  }  
  else {
      
    $arrresultado = $conexion->doSelect("usuario.usuario_id, usuario.usuario_codigo, usuario.usuario_email, usuario.usuario_clave, usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_telf, usuario.usuario_fechareg, usuario.usuario_activo, usuario.usuario_eliminado, usuario.usuario_documento, usuario.usuario_img, usuario.perfil_id, usuario.usuario_direccion, 
      DATE_FORMAT(usuario.usuario_fechanac,'%d/%m/%Y') as usuario_fechanac,
      usuario.l_tipodocumento_id, usuario.cuenta_id, usuario.compania_id, usuario.perfil_id, 
      usuario.usuario_whatsapp, usuario.l_estatus_id,

      usuarioretiro.usuarioretiro_id, usuarioretiro.usuarioretiro_descripcion, usuarioretiro.usuarioretiro_email, 
      usuarioretiro.usuarioretiro_fechareg, usuarioretiro.usuarioretiro_activo, 
      usuarioretiro.usuarioretiro_eliminado, usuarioretiro.l_formapago_id, usuarioretiro.usuarioretiro_banco, 
      usuarioretiro.usuarioretiro_titular, usuarioretiro.usuarioretiro_tipocuenta, usuarioretiro.usuarioretiro_documento, 
      usuarioretiro.usuarioretiro_nrocuenta,

      lista_nombre as formapago_nombre,

      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre

      ",
    "usuario  
      inner join usuarioretiro on usuarioretiro.usuario_id = usuario.usuario_id
      inner join lista formapago on formapago.lista_id = usuarioretiro.l_formapago_id
      inner join usuario cuenta on cuenta.usuario_id = usuario.cuenta_id
      inner join compania on compania.compania_id = usuario.compania_id

    ",
    "usuario.usuario_eliminado = '0' and usuarioretiro_activo = '1' and usuarioretiro.usuario_id = '$_COOKIE[iniuser]'  $where ", null, "usuario.usuario_id asc");

    $option = "<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

      $usuarioretiro_id = utf8_encode($valor["usuarioretiro_id"]);
      $usuarioretiro_descripcion = utf8_encode($valor["usuarioretiro_descripcion"]);
      $usuarioretiro_email = utf8_encode($valor["usuarioretiro_email"]);
      $usuarioretiro_fechareg = utf8_encode($valor["usuarioretiro_fechareg"]);
      $usuarioretiro_activo = utf8_encode($valor["usuarioretiro_activo"]);    
      $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
      $usuarioretiro_banco = utf8_encode($valor["usuarioretiro_banco"]);
      $usuarioretiro_titular = utf8_encode($valor["usuarioretiro_titular"]);
      $usuarioretiro_tipocuenta = utf8_encode($valor["usuarioretiro_tipocuenta"]);
      $usuarioretiro_documento = utf8_encode($valor["usuarioretiro_documento"]);
      $usuarioretiro_nrocuenta = utf8_encode($valor["usuarioretiro_nrocuenta"]);    

      $formapago_nombre = utf8_encode($valor["formapago_nombre"]);    

      if ($idseleccionado==$usuarioretiro_id){
          $option .= "<option selected='selected' value='$usuarioretiro_id'>$formapago_nombre</option>";
      }else{
          $option .= "<option value='$usuarioretiro_id'>$formapago_nombre</option>";
      }          
    }

    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN OPCIONES DE RETIRO CONFIGURADOS</option>";
    }

    if (count($arrresultado)==1){
      $option = "<option  value='$usuarioretiro_id'>$formapago_nombre</option>";
    }

  }
  

  return $option;

}



function ObtenerListaPlanesMultiNivel($cuentaseleccionada=null, $companiaseleccionada=null, $usuario_idget =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and listaplanmultinivel.cuenta_id = '$_COOKIE[idcuenta]' ";          


  }  else { 

    $where = " and listaplanmultinivel.cuenta_id = '$_COOKIE[idcuenta]' and listaplanmultinivel.compania_id = '$_COOKIE[idcompania]' ";
    $wherelistaactivo = " and plan.lista_activo = '1' ";
  } 



  $arrresultado = $conexion->doSelect("

    listaplanmultinivel.listaplanmultinivel_id, listaplanmultinivel.l_planmultinivel_id,
    listaplanmultinivel.l_moneda_id,
    listaplanmultinivel.listaplanmultinivel_precio, listaplanmultinivel.listaplanmultinivel_ganancia, 
    listaplanmultinivel.listaplanmultinivel_diasduracion, listaplanmultinivel.listaplanmultinivel_fechareg, 
    listaplanmultinivel.listaplanmultinivel_url,

    plan.lista_id as plan_id, plan.lista_nombre as plan_nombre, plan.lista_img as plan_img,
    plan.lista_orden as plan_orden, plan.lista_activo as plan_activo,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    listaplanservdet_id, listaplanservdet_descrip, listaplanservdet_orden, listaplanservdet_activo,

    moneda.lista_nombredos as moneda_siglas

      ",
    "
    listaplanmultinivel
        inner join lista plan on plan.lista_id = listaplanmultinivel.l_planmultinivel_id          
        inner join usuario cuenta on cuenta.usuario_id = listaplanmultinivel.cuenta_id
        inner join compania on compania.compania_id = listaplanmultinivel.compania_id  


        left join lista moneda on moneda.lista_id = listaplanmultinivel.l_moneda_id       
        left join listaplanserviciodetalle on listaplanserviciodetalle.l_plan_id = plan.lista_id 
        and listaplanservdet_activo = '1'
    ",
    " plan.lista_activo = '1' $where  $wherelistaactivo", null, "plan.lista_orden, plan.lista_id, listaplanserviciodetalle.listaplanservdet_orden  asc");

  $cont = 0;
  foreach($arrresultado as $i=>$valor){

    $plan_id = utf8_encode($valor["plan_id"]);

    if ($plan_id_old!=$plan_id && $cont!="0"){   

      $planeshtml .= "
        <div class='col-lg-4 col-md-6' style='margin-bottom: 15px'>
            <div class='package-content bg-light border text-center p-2 my-2 my-lg-0'>
                <div class='package-content-heading border-bottom'>
                    <a href='plan-detalle?id=$plan_id_old'>
                      <center>
                          <img src='$urlimgPlan' class='img-responsive' style='height:140px' />
                      </center>
                      <h2 style='padding-top: 10px; padding-bottom: 4px'>$plan_nombre</h2>
                      $divprecio
                    </a>
                </div>
                <ul>
                    $plandetallehtml
                </ul>
                <a href='plan-detalle?id=$plan_id_old' class='btn btn-primary' style='margin-top: 5px'>Conocer Más</a>
                
            </div>
        </div>
      ";

       $plandetallehtml ="";

    }

    $listaplanservdet_id = utf8_encode($valor["listaplanservdet_id"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
    $listaplanservdet_descrip = utf8_encode($valor["listaplanservdet_descrip"]);
    $listaplanservdet_orden = utf8_encode($valor["listaplanservdet_orden"]);
    $listaplanservdet_activo = utf8_encode($valor["listaplanservdet_activo"]);

    $listaplanserv_id = utf8_encode($valor["listaplanserv_id"]);
    $l_planserv_id = utf8_encode($valor["l_planserv_id"]);
    $listaplanmultinivel_precio = utf8_encode($valor["listaplanmultinivel_precio"]);
    $listaplanmultinivel_ganancia = utf8_encode($valor["listaplanmultinivel_ganancia"]);  
    $listaplanmultinivel_diasduracion = utf8_encode($valor["listaplanmultinivel_diasduracion"]);  
    $listaplanmultinivel_url = utf8_encode($valor["listaplanmultinivel_url"]);
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);    
    $listaplanserv_fechareg = utf8_encode($valor["listaplanserv_fechareg"]);
    
    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $plan_img = utf8_encode($valor["plan_img"]);  
    $plan_orden = utf8_encode($valor["plan_orden"]);  
    $plan_activo = utf8_encode($valor["plan_activo"]);  

    $urlimgPlan = "arch/$plan_img";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $listaplanmultinivel_precioorig = $listaplanmultinivel_precio;

    if ($listaplanmultinivel_precio==""){$listaplanmultinivel_precio=0;}
    
    $listaplanmultinivel_precio = number_format_personalizado($listaplanmultinivel_precio,$moneda_siglas);

    if ($listaplanmultinivel_precioorig=="0" || $listaplanmultinivel_precioorig==""){
      $divprecio = "
        <h4 class='py-0' style='font-size: 20px; line-height: 30px'>         
          
        </h4>
      ";
      $divcontratar = "
        
      ";
    }else{
      $divprecio = "
        <h4 class='py-0' style='font-size: 20px; line-height: 30px'> 
          <span style='font-size: 20px'>$listaplanmultinivel_precio $moneda_siglas /$listaplanmultinivel_diasduracion días</span> <br>
        </h4>
      ";

      $divcontratar = "
        <a href='plan-forma-pago?id=$plan_id' class='btn btn-success' style='margin-top: 5px'>Contratar</a>
      ";
    }

    $plandetallehtml .= "
          <li class='my-4'> $listaplanservdet_descrip</li>
      ";

    $plan_id_old = $plan_id;

    $cont = $cont +1;

  }


  if ($plandetallehtml!=""){
    $planeshtml .= "
        <div class='col-lg-4 col-md-6' style='margin-bottom: 15px;'>
            <div class='package-content bg-light border text-center p-2 my-2 my-lg-0' style='background: #FFF; padding: 20px'>
                <div class='package-content-heading border-bottom'>
                    <a href='adquirirplannegocioformapago?id=$plan_id'>
                      <center>
                          <img src='$urlimgPlan' class='img-responsive' style='height:140px' />
                      </center>
                      <h2 style='padding-top: 10px; padding-bottom: 4px'>$plan_nombre</h2>
                      $divprecio
                    </a>
                </div>
                <ul style='padding-left: 0px; list-style:none'>
                    $plandetallehtml
                </ul>
                <a href='adquirirplannegocioformapago?id=$plan_id' class='btn btn-primary' style='margin-top: 5px'>Adquirir</a>
                
            </div>
        </div>
      ";
  }

  if ($planeshtml!=""){

    $planeshtml = "

    <div class='col-md-12'>
        <h3>Seleccione el plan que desea </h3>  
    </div>    

    $planeshtml
    ";
  }

  return $planeshtml;

}

function ObtenerListaNiveles($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    $where = "";
  }else if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    $where = " and multinivelmatrizdetalle.cuenta_id = '$cuentaseleccionada'";
  } else {
    $where = " and multinivelmatrizdetalle.cuenta_id = '$cuentaseleccionada' and multinivelmatrizdetalle.compania_id = '$companiaseleccionada' ";
  }


  
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>No tiene Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>No tiene Compañia</option>";
  }  
  else {
      
    $arrresultado = $conexion->doSelect("

      listamultinivelmatriz_id, listamultinivelmatriz_cantniveles, 
      listamultinivelmatriz_fechareg, listamultinivelmatriz_activo, 
      listamultinivelmatriz_eliminado, listamultinivelmatriz.cuenta_id, listamultinivelmatriz.compania_id, 
      listamultinivelmatriz.listacuenta_id,

      multinivel.lista_id as multinivel_id, multinivel.lista_nombre as multinivel_nombre, 
      multinivel.lista_img as multinivel_img,
      multinivel.lista_orden as multinivel_orden, 
      multinivel.lista_activo as multinivel_activo,   

      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

      multinivelmatrizdet_id, multinivelmatrizdetalle.l_multinivelmatriz_id, 
      multinivelmatrizdet_nivel, multinivelmatrizdet_nombre,
      multinivelmatrizdet_orden, multinivelmatrizdet_activo, multinivelmatrizdet_cantidad,
      multinivelmatrizdet_canttotal

        ",
      "
      listamultinivelmatriz
        inner join lista multinivel on multinivel.lista_id = listamultinivelmatriz.l_multinivelmatriz_id          
        inner join usuario cuenta on listamultinivelmatriz.cuenta_id = cuenta.usuario_id
        inner join compania on compania.compania_id = listamultinivelmatriz.compania_id       
        inner join multinivelmatrizdetalle on multinivelmatrizdetalle.l_multinivelmatriz_id = multinivel.lista_id
      ",
      "multinivelmatrizdet_eliminado = '0' and multinivel.lista_eliminado = '0' ", null, "multinivelmatrizdetalle.multinivelmatrizdet_nivel asc");
    
    $option = "<option value=''>TODOS</option>";
    foreach($arrresultado as $i=>$valor){

      $multinivelmatrizdet_id = utf8_encode($valor["multinivelmatrizdet_id"]);
      $l_multinivelmatriz_id = utf8_encode($valor["l_multinivelmatriz_id"]);
      $multinivelmatrizdet_nivel = utf8_encode($valor["multinivelmatrizdet_nivel"]);
      $multinivelmatrizdet_nombre = utf8_encode($valor["multinivelmatrizdet_nombre"]);
      $multinivelmatrizdet_orden = utf8_encode($valor["multinivelmatrizdet_orden"]);    
      $multinivelmatrizdet_activo = utf8_encode($valor["multinivelmatrizdet_activo"]);
      $multinivelmatrizdet_cantidad = utf8_encode($valor["multinivelmatrizdet_cantidad"]);
      $multinivelmatrizdet_canttotal = utf8_encode($valor["multinivelmatrizdet_canttotal"]);
      

      if ($idseleccionado==$multinivelmatrizdet_id){
          $option .= "<option selected='selected' value='$multinivelmatrizdet_id'>$multinivelmatrizdet_nombre</option>";
      }else{
          $option .= "<option value='$multinivelmatrizdet_id'>$multinivelmatrizdet_nombre</option>";
      }          
    }

    if (count($arrresultado)==0){
      $option = "<option  value=''>NO EXISTEN NIVELES</option>";
    }
  }
  

  return $option;

}


function ListadoUsuariosMultiNivelPerfil($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $usuario_idget=null, $getnivel=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (multinivelmatrizdetalle.usuariomultinivel_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (multinivelmatrizdetalle.usuariomultinivel_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (multinivelmatrizdetalle.usuariomultinivel_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (multinivelmatrizdetalle.usuariomultinivel_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and multinivelmatrizdetalle.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and multinivelmatrizdetalle.cuenta_id = '$_COOKIE[idcuenta]' and multinivelmatrizdetalle.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if($getestatus!=""){
    $whereestatus = " and multinivelmatrizdetalle.l_estatus_id = '$getestatus' ";
  }

  if($getnivel!=""){
    $wherenivel = " and usuariomultiniveldetalle.multinivelmatrizdet_id = '$getnivel' ";
  }

  if ($usuario_idget==""){
    $usuario_idget = $_COOKIE[iniuser];
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("multinivelmatrizdetalle.multinivelmatrizdet_id,
    multinivelmatrizdetalle.l_multinivelmatriz_id,  multinivelmatrizdet_nivel,
    multinivelmatrizdetalle.multinivelmatrizdet_color, multinivelmatrizdet_nombre, multinivelmatrizdet_canttotal,

    usuarioorigen.usuario_nombre as usuarioorigen_nombre, usuarioorigen.usuario_apellido as usuarioorigen_apellido, 
    usuarioorigen.usuario_img as usuarioorigen_img, usuarioorigen.usuario_id as usuarioorigen_id,

    usuariodestino.usuario_nombre as usuariodestino_nombre, usuariodestino.usuario_apellido as usuariodestino_apellido, 
    usuariodestino.usuario_img as usuariodestino_img, usuariodestino.usuario_id as usuariodestino_id,

    usuariomultiniveldetalle.usuariomultiniveldet_id, usuariomultiniveldetalle.usuariomultinivel_id, 
    usuariomultiniveldetalle.l_multinivel_id, 
    usuariomultiniveldetalle.multinivelmatrizdet_id, usuariomultiniveldetalle.usuario_idorigen, 
    usuariomultiniveldetalle.usuario_iddestino,  
    usuariomultiniveldetalle.usuariomultiniveldet_orden,  
    usuariomultiniveldetalle.usuariomultiniveldet_activo, usuariomultiniveldetalle.usuariomultiniveldet_eliminado, 
    usuariomultiniveldetalle.cuenta_id, usuariomultiniveldetalle.compania_id,
    DATE_FORMAT(usuariomultiniveldetalle.usuariomultiniveldet_fechareg,'%d/%m/%Y %H:%i:%s') as usuariomultiniveldet_fechareg,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    multinivelmatrizdetrelorden_origen,
    multinivelmatrizdetrelorden_destino,

    listamultinivelmatriz_gananciareferido, 

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas

    ",
    "
    multinivelmatrizdetalle    
      inner join listamultinivelmatriz on listamultinivelmatriz.l_multinivelmatriz_id = multinivelmatrizdetalle.l_multinivelmatriz_id   

      inner join lista moneda on moneda.lista_id = listamultinivelmatriz.l_monedappal_id

      inner join multinivelmatrizdetallerelorden on multinivelmatrizdetallerelorden.multinivelmatrizdet_id = multinivelmatrizdetalle.multinivelmatrizdet_id   

      inner join usuariomultiniveldetalle on usuariomultiniveldetalle.usuariomultiniveldet_orden = multinivelmatrizdetallerelorden.multinivelmatrizdetrelorden_origen and multinivelmatrizdetrelorden_ppal = '1'
    

      inner join usuario usuarioorigen on usuarioorigen.usuario_id = usuariomultiniveldetalle.usuario_idorigen
      inner join usuario usuariodestino on usuariodestino.usuario_id = usuariomultiniveldetalle.usuario_iddestino

      inner join usuario cuenta on cuenta.usuario_id = usuariomultiniveldetalle.cuenta_id
      inner join compania on compania.compania_id = usuariomultiniveldetalle.compania_id      
      
      ",
    "multinivelmatrizdet_activo = '1' and usuariomultiniveldetalle.usuario_idorigen = '$usuario_idget' $wherenivel", null, "usuariomultiniveldet_id desc"); 

  foreach($arrresultado as $i=>$valor){

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
    
    $multinivelmatrizdet_id = utf8_encode($valor["multinivelmatrizdet_id"]);    
    $l_multinivelmatriz_id = utf8_encode($valor["l_multinivelmatriz_id"]);    
    $multinivelmatrizdet_color = utf8_encode($valor["multinivelmatrizdet_color"]);    
    $multinivelmatrizdet_nombre = utf8_encode($valor["multinivelmatrizdet_nombre"]);    
    $multinivelmatrizdet_canttotal = utf8_encode($valor["multinivelmatrizdet_canttotal"]);  
    $multinivelmatrizdet_nivel = utf8_encode($valor["multinivelmatrizdet_nivel"]);  
    $listamultinivelmatriz_gananciareferido = utf8_encode($valor["listamultinivelmatriz_gananciareferido"]);  
    
    $listamultinivelmatriz_gananciareferido = number_format_personalizado($listamultinivelmatriz_gananciareferido,$moneda_siglas);

    $usuariomultiniveldet_id = utf8_encode($valor["usuariomultiniveldet_id"]);    
    $usuariomultinivel_id = utf8_encode($valor["usuariomultinivel_id"]);    
    $l_multinivel_id = utf8_encode($valor["l_multinivel_id"]);    
    $usuario_idorigen = utf8_encode($valor["usuario_idorigen"]);    
    $usuario_iddestino = utf8_encode($valor["usuario_iddestino"]);    
    $usuariomultiniveldet_orden = utf8_encode($valor["usuariomultiniveldet_orden"]);    
    $usuariomultiniveldet_fechareg = utf8_encode($valor["usuariomultiniveldet_fechareg"]);    
    $usuariomultiniveldet_activo = utf8_encode($valor["usuariomultiniveldet_activo"]);    

    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);    

    $usuarioorigen_nombre = utf8_encode($valor["usuarioorigen_nombre"]);
    $usuarioorigen_apellido = utf8_encode($valor["usuarioorigen_apellido"]);
    $usuarioorigen_img = utf8_encode($valor["usuarioorigen_img"]);  

    $usuarioorigen = $usuarioorigen_nombre." ".$usuarioorigen_apellido." ";


    $usuariodestino_nombre = utf8_encode($valor["usuariodestino_nombre"]);
    $usuariodestino_apellido = utf8_encode($valor["usuariodestino_apellido"]);
    $usuariodestino_img = utf8_encode($valor["usuariodestino_img"]);  

    $usuariodestino = $usuariodestino_nombre." ".$usuariodestino_apellido." ";

    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";    

    if ($usuariomultiniveldet_activo=="0"){
      $activo = "<i onclick='cambiarestatususuariomultiniveldetalle(\"".$usuariomultiniveldet_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatususuariomultiniveldetalle(\"".$usuariomultiniveldet_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarusuariomultiniveldetalle(\"".$usuariomultiniveldet_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    //$modificar = "<a href='verpagomultinivel?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
      $activo =""; $accioneliminar = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
      $activo =""; $accioneliminar = "";
    }

    $usuariodestino = "<a href='perfilnegocio?id=$usuario_iddestino'> <span style='color: #000'>$usuariodestino</span> (Ver)</a>";    

    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania    
            <td>$usuarioorigen</td>     
            <td>$usuariodestino</td>     
            <td>$multinivelmatrizdet_nombre</td>     
            <td>$usuariomultiniveldet_fechareg</td>                                       
            <td>$listamultinivelmatriz_gananciareferido</td>                                       
            <td style='text-align: center'>&nbsp $modificar  &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}


function MultiplicarElevado($cantidad=null, $elevadoa=null){

  $valor = 1;
  for ($n=1;$n<=$elevadoa;$n++){

    $valor = $valor * $cantidad;
  }

  return $valor;
}


function Listadoafiliacionnegocio($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $usuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (usuariomultinivel.usuariomultinivel_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (usuariomultinivel.usuariomultinivel_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (usuariomultinivel.usuariomultinivel_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (usuariomultinivel.usuariomultinivel_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and usuariomultinivel.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and usuariomultinivel.cuenta_id = '$_COOKIE[idcuenta]' and usuariomultinivel.compania_id = '$_COOKIE[idcompania]' and usuariomultinivel.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($getestatus!=""){
    $whereestatus = " and usuariomultinivel.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    



  $arrresultado = $conexion->doSelect("

    usuariomultinivel.usuariomultinivel_id, usuariomultinivel.l_multinivelmatriz_id, usuariomultinivel.usuario_idorigen, 
    usuariomultinivel.usuario_id, usuariomultinivel.l_plan_id, usuariomultinivel.l_estatus_id,     
    usuariomultinivel.usuariomultinivel_activo, usuariomultinivel.usuariomultinivel_eliminado, 
    usuariomultinivel.cuenta_id, usuariomultinivel.compania_id,

    usuariomultinivel.usuariomultinivel_codglobal,

    DATE_FORMAT(usuariomultinivel.usuariomultinivel_fechareg,'%d/%m/%Y %H:%i:%s') as usuariomultinivel_fechareg,
    DATE_FORMAT(usuariomultinivel.usuariomultinivel_fechaini,'%d/%m/%Y') as usuariomultinivel_fechaini,
    DATE_FORMAT(usuariomultinivel.usuariomultinivel_fechafin,'%d/%m/%Y') as usuariomultinivel_fechafin,

    plan.lista_nombre as plan_nombre, estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img,

    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    multinivel.lista_nombre as multinivel_nombre,

    pago.pago_codglobal, pago.pago_id

    ",
    "usuariomultinivel
      inner join lista multinivel on multinivel.lista_id = usuariomultinivel.l_multinivelmatriz_id      
      inner join lista plan on plan.lista_id = usuariomultinivel.l_plan_id
      inner join lista estatus on estatus.lista_id = usuariomultinivel.l_estatus_id
      
      inner join usuario on usuario.usuario_id = usuariomultinivel.usuario_id

      inner join usuario cuenta on cuenta.usuario_id = usuariomultinivel.cuenta_id
      inner join compania on compania.compania_id = usuariomultinivel.compania_id     

      inner join pago on pago.pago_id = usuariomultinivel.pago_id       

    ",
    "usuariomultinivel_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "usuariomultinivel.usuariomultinivel_id desc"); 

  foreach($arrresultado as $i=>$valor){
    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_codglobal = utf8_encode($valor["pago_codglobal"]);
    $multinivel_nombre = utf8_encode($valor["multinivel_nombre"]);

    $usuariomultinivel_id = utf8_encode($valor["usuariomultinivel_id"]);
    $usuariomultinivel_codglobal = utf8_encode($valor["usuariomultinivel_codglobal"]);
    $l_multinivelmatriz_id = utf8_encode($valor["l_multinivelmatriz_id"]);
    $usuario_idorigen = utf8_encode($valor["usuario_idorigen"]);
    $usuario_id = utf8_encode($valor["usuario_id"]);
    $l_plan_id = utf8_encode($valor["l_plan_id"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $usuariomultinivel_activo = utf8_encode($valor["usuariomultinivel_activo"]);
    $usuariomultinivel_fechareg = utf8_encode($valor["usuariomultinivel_fechareg"]);
    $usuariomultinivel_fechaini = utf8_encode($valor["usuariomultinivel_fechaini"]);
    $usuariomultinivel_fechafin = utf8_encode($valor["usuariomultinivel_fechafin"]);

    
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);

    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
    

    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);  

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";    

    if ($usuariomultinivel_activo=="0"){
      $activo = "<i onclick='cambiarestatusafiliacionnegocio(\"".$usuariomultinivel_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusafiliacionnegocio(\"".$usuariomultinivel_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarafiliacionnegocio(\"".$usuariomultinivel_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    //$modificar = "<a href='verpagomultinivel?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verafiliacion = "Afiliación #$usuariomultinivel_codglobal";

    $verpago = "<a href='verpagomultinivel?id=$pago_id'>Pago #$pago_codglobal (Ver)</a>";


    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania    
            <td>$verafiliacion</td>  
            <td>$multinivel_nombre</td>     
            <td>$usuario</td>     
            <td>$plan_nombre</td>               
            <td>$estatus_nombre</td>                  
            <td>$usuariomultinivel_fechaini</td>         
            <td>$usuariomultinivel_fechareg</td>    
            <td>$verpago</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}


function ListadoPagoUsuarioEvento($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,

    pagoplanevento.pagoplanevento_id, pagoplanevento.pago_id, pagoplanevento.l_plan_id, pago.l_estatus_id, 
    pagoplanevento.pagoplanevento_fechareg,
    pagoplanevento.pagoplanevento_observacion, pagoplanevento.usuario_idreg,

    plan.lista_nombre as plan_nombre, estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb,
    evento_nombre

    ",
    "pago
      inner join pagoplanevento on pagoplanevento.pago_id = pago.pago_id
      inner join evento on evento.evento_id = pagoplanevento.evento_id
      inner join lista moneda on moneda.lista_id = pago.l_moneda_id
      inner join lista plan on plan.lista_id = pagoplanevento.l_plan_id
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 


  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);
    $evento_nombre = utf8_encode($valor["evento_nombre"]);

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);
    $pagoplanevento_id = utf8_encode($valor["pagoplanevento_id"]);  
    $l_plan_id = utf8_encode($valor["l_plan_id"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $pagoplanevento_fechareg = utf8_encode($valor["pagoplanevento_fechareg"]);
    $pagoplanevento_observacion = utf8_encode($valor["pagoplanevento_observacion"]);

    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    

    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $aaa); 

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verpagoevento?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verpagoevento?id=$pago_id'>#$pago_id (Ver)</a>";


    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>            
            <td>$usuario</td>     
            <td>$evento_nombre</td>
            <td>$plan_nombre</td>               
            <td>$pago_monto $moneda_siglas</td>         
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}



function ListadoPagousuariomultinivel($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' and pago.usuario_id = '$_COOKIE[iniuser]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,

    pagoplanmultinivel.pagoplanmultinivel_id, pagoplanmultinivel.pago_id, pagoplanmultinivel.l_plan_id, pago.l_estatus_id, 
    pagoplanmultinivel.pagoplanmultinivel_fechareg,
    pagoplanmultinivel.pagoplanmultinivel_observacion, pagoplanmultinivel.usuario_idreg,

    plan.lista_nombre as plan_nombre, estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb

    ",
    "pago
      inner join pagoplanmultinivel on pagoplanmultinivel.pago_id = pago.pago_id
      inner join lista moneda on moneda.lista_id = pago.l_moneda_id
      inner join lista plan on plan.lista_id = pagoplanmultinivel.l_plan_id
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha ", null, "pago.pago_id desc"); 



  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);
    $pagoplanmultinivel_id = utf8_encode($valor["pagoplanmultinivel_id"]);  
    $l_plan_id = utf8_encode($valor["l_plan_id"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $pagoplanmultinivel_fechareg = utf8_encode($valor["pagoplanmultinivel_fechareg"]);
    $pagoplanmultinivel_observacion = utf8_encode($valor["pagoplanmultinivel_observacion"]);

    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    

    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $aaa); 

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verpagonegocio?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verpagonegocio?id=$pago_id'>#$pago_id (Ver)</a>";


    $textohtml .= "
          <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>            
            <td>$usuario</td>     
            <td>$plan_nombre</td>               
            <td>$pago_monto $moneda_siglas</td>         
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}


function ObtenerIdCodigo($idlista=null, $tipolista=null){  

  $conexion = new ConexionBd(); 

  $formapagooriginal_cod = 0;
  $lista_cod = 0;

  $arrresultado2 = $conexion->doSelect("formapagooriginal.lista_cod as formapagooriginal_cod, lista.lista_cod as lista_cod",
  "lista
    left join lista formapagooriginal on formapagooriginal.lista_id = lista.lista_idrel and formapagooriginal.lista_activo = '1'
  ", 
  "lista.tipolista_id = '$tipolista' and lista.lista_id = '$idlista' and lista.lista_activo = '1' ");
  if (count($arrresultado2)>0){
    foreach($arrresultado2 as $i=>$valor){
      $formapagooriginal_cod = $valor["formapagooriginal_cod"];
      $lista_cod = $valor["lista_cod"];
    }
  }

  if ($formapagooriginal_cod!="" && $formapagooriginal_cod!="0"){
    $lista_cod = $formapagooriginal_cod;
  }

  return $lista_cod;

}

function ObtenerListaNombreDos($idlista=null, $tipolista=null){  

  $conexion = new ConexionBd(); 

  $lista_nombredos = "";

  $arrresultado2 = $conexion->doSelect("lista_nombredos","lista", "tipolista_id = '$tipolista' and lista_id = '$idlista'");
  if (count($arrresultado2)>0){
    foreach($arrresultado2 as $i=>$valor){
      $lista_nombredos = $valor["lista_nombredos"];
    }
  }

  return $lista_nombredos;

}

// function ObtenerIdLista($codigo=null, $tipolista=null){  

//   $conexion = new ConexionBd(); 

//   $lista_id = 0;

//   $arrresultado2 = $conexion->doSelect("lista_id","lista", "tipolista_id = '$tipolista' and lista_cod = '$codigo'");
//   if (count($arrresultado2)>0){
//     foreach($arrresultado2 as $i=>$valor){
//       $lista_id = $valor["lista_id"];
//     }
//   }

//   return $lista_id;

// }

function ObtenerCodigoYouTube($url=null){

  $buscar   = 'v=';

  //Capturo posicion inicial donde se consiguio
  $posicioninicial = strpos($url, $buscar);

  if ($posicioninicial === false) { // No esta
      $videocodigo = "";
   }else{
      $videocodigo = substr($url,$posicioninicial+2, 11);        
  }

  return $videocodigo;

}



function ListadoPagoUsuario($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $pagousuario_idget=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (pago.pago_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (pago.pago_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and pago.cuenta_id = '$_COOKIE[idcuenta]' and pago.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if($pagousuario_idget!=""){
    $wherepago = " and pago.pago_id = '$pagousuario_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and pago.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
    pago.pago_id, pago.pago_monto, pago.pago_referencia, pago.pago_banco, 
    pago.pago_comentario, pago.pago_img, pago.l_formapago_id, pago.usuario_id, pago.usuario_idreg, pago.pago_activo, 
    pago.pago_eliminado, pago.cuenta_id, pago.compania_id, pago.l_tipoarchivo_id,

    pagoplan.pagoplan_id, pagoplan.pago_id, pagoplan.l_plan_id, pago.l_estatus_id, pagoplan.pagoplan_fechareg,
    pagoplan.pagoplan_observacion, pagoplan.usuario_idreg,

    plan.lista_nombre as plan_nombre, estatus.lista_nombre as estatus_nombre,

    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

    DATE_FORMAT(pago.pago_fechareg,'%d/%m/%Y %H:%i:%s') as pago_fechareg,
    DATE_FORMAT(pago.pago_fecha,'%d/%m/%Y') as pago_fecha,

    moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas, 
    compania_urlweb

    ",
    "pago
      inner join pagoplan on pagoplan.pago_id = pago.pago_id
      inner join lista moneda on moneda.lista_id = pago.l_moneda_id
      inner join lista plan on plan.lista_id = pagoplan.l_plan_id
      inner join usuario on usuario.usuario_id = pago.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = pago.cuenta_id
      inner join compania on compania.compania_id = pago.compania_id
      inner join lista estatus on estatus.lista_id = pago.l_estatus_id

    ",
    "pago_eliminado = '0' $where $whereestatus $wherepago $wherefecha", null, "pago.pago_id desc"); 


  if ($pagousuario_idget!=""){
    return $arrresultado;
  }

  foreach($arrresultado as $i=>$valor){

    $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

    $pago_id = utf8_encode($valor["pago_id"]);
    $pago_monto = utf8_encode($valor["pago_monto"]);
    $pago_fechareg = utf8_encode($valor["pago_fechareg"]);
    $pago_fecha = utf8_encode($valor["pago_fecha"]);
    $pago_referencia = utf8_encode($valor["pago_referencia"]);
    $pago_banco = utf8_encode($valor["pago_banco"]);
    $pago_comentario = utf8_encode($valor["pago_comentario"]);
    $pago_img = utf8_encode($valor["pago_img"]);
    $l_formapago_id = utf8_encode($valor["l_formapago_id"]);
    $panelpago_usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_idreg = utf8_encode($valor["usuario_idreg"]);
    $pago_activo = utf8_encode($valor["pago_activo"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);
    $pagoplan_id = utf8_encode($valor["pagoplan_id"]);  
    $l_plan_id = utf8_encode($valor["l_plan_id"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $pagoplan_fechareg = utf8_encode($valor["pagoplan_fechareg"]);
    $pagoplan_observacion = utf8_encode($valor["pagoplan_observacion"]);

    $plan_nombre = utf8_encode($valor["plan_nombre"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    

    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $pago_monto = number_format_personalizado($pago_monto, $aaa); 

    if ($pago_activo=="0"){
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuspago(\"".$pago_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarpago(\"".$pago_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    $modificar = "<a href='verpagousuario?id=$pago_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $verid = "<a href='verpagousuario?id=$pago_id'>#$pago_id (Ver)</a>";


    $textohtml .= "
          <tr>               
            <td>$pago_id</td>   
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$verid</td>            
            <td>$usuario</td>     
            <td>$plan_nombre</td>               
            <td>$pago_monto $moneda_siglas</td>         
            <td>$pago_fechareg</td>      
            <td>$estatus_nombre</td>                  
            <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
          </tr>
      ";

  }

  return $textohtml;

}

function ListadoRequisitoUsuario($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null, $requisito_idget=null, $devolverresultado=null, $usuario_id=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and requisito.cuenta_id = '$cuentaseleccionada' ";

  }  else { 

    $where = " and requisito.cuenta_id = '$cuentaseleccionada' and requisito.compania_id = '$companiaseleccionada' ";

  } 

  if($requisito_idget!=""){
    $whererequisito = " and requisito.requisito_id = '$requisito_idget' ";
  }

  if($getestatus!=""){
    $whereestatus = " and requisito.l_estatus_id = '$getestatus' ";
  }

  if($usuario_id!=""){
    $where .= " and requisito.usuario_id = '$usuario_id' ";
  }
  

  $conexion = new ConexionBd();    

  $arrresultado = $conexion->doSelect("
      requisito.requisito_id, requisito.l_requisitolista_id, requisito_descrip, requisito.l_tipoarchivo_id, requisito_arch, 
      requisito_archnombre, requisito_cantarchivos, requisito.cuenta_id, requisito.compania_id,
      requisito_activo, requisito_eliminado,  
      requisito.usuario_idreg, requisito.l_estatus_id, requisito.usuario_id,
      usuario.usuario_id, usuario.usuario_codigo, usuario.usuario_email, usuario.usuario_nombre, usuario.usuario_apellido, 
      usuario.usuario_telf, usuario.usuario_activo, usuario.usuario_eliminado, 
      usuario.usuario_documento, usuario.usuario_img, usuario.perfil_id, 

      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre, 
      listarequisito.lista_id as requisitolista_id,
      listarequisito.lista_cod as requisitolista_cod,
      listarequisito.lista_nombre as requisitolista_nombre,
      listarequisito.lista_descrip as requisitolista_descrip,
      listarequisito.lista_img as requisitolista_img,
      estatus.lista_cod as estatus_cod,
      estatus.lista_nombre as estatus_nombre,
      estatus.lista_color as estatus_color,
      tipoarchivo.lista_nombre as tipoarchivo_nombre,
      tipoarchivo.lista_img as tipoarchivo_img,
      DATE_FORMAT(requisito.requisito_fechareg,'%d/%m/%Y %H:%i:%s') as requisito_fechareg,
      perfilrequisito.perfil_nombre as perfilrequisito_nombre


      ",
      "
      requisito
        inner join lista listarequisito on requisito.l_requisitolista_id = listarequisito.lista_id 
        inner join usuario on usuario.usuario_id = requisito.usuario_id 

        left join usuario cuenta on cuenta.usuario_id = usuario.cuenta_id
        left join compania on compania.compania_id = usuario.compania_id
        
        left join lista tipoarchivo on tipoarchivo.lista_id = requisito.l_tipoarchivo_id
        left join lista estatus on estatus.lista_id = requisito.l_estatus_id

        left join listarequisitoperfil on listarequisitoperfil.l_requisitolista_id = listarequisito.lista_id
        left join perfil perfilrequisito on perfilrequisito.perfil_id = listarequisitoperfil.perfil_id
          
      ",
      "listarequisito.lista_eliminado = '0'  and listarequisito.tipolista_id  ='49' and requisito_eliminado = '0' $where $whererequisito $whereestatus  ", null, "listarequisito.lista_orden asc");

  if ($requisito_idget!=""){
    return $arrresultado;
  }

  if ($devolverresultado=="1"){
    return $arrresultado;
  }

  // and listarequisitotipousuarioserv.l_tipousuarioserv_id = usuario.l_tipousuarioserv_id
  
  foreach($arrresultado as $i=>$valor){

      $requisito_id = utf8_encode($valor["requisito_id"]);
      $l_requisitolista_id = utf8_encode($valor["l_requisitolista_id"]);
      $requisito_descrip = utf8_encode($valor["requisito_descrip"]);
      $l_tipoarchivo_id = utf8_encode($valor["l_tipoarchivo_id"]);
      $requisito_arch = utf8_encode($valor["requisito_arch"]);
      $requisito_archnombre = utf8_encode($valor["requisito_archnombre"]);
      $requisito_cantarchivos = utf8_encode($valor["requisito_cantarchivos"]);
      $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
      $t_compania_id = utf8_encode($valor["compania_id"]);
      $requisito_activo = utf8_encode($valor["requisito_activo"]);
      $requisito_fechareg = utf8_encode($valor["requisito_fechareg"]);
      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $usuario_id = utf8_encode($valor["usuario_id"]);
      $usuario_codigo = utf8_encode($valor["usuario_codigo"]);
      $usuario_email = utf8_encode($valor["usuario_email"]);
      $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
      $usuario_apellido = utf8_encode($valor["usuario_apellido"]);

      $usuario = $usuario_nombre." ".$usuario_apellido." ";
      
      $requisitolista_id = utf8_encode($valor["requisitolista_id"]);
      $requisitolista_nombre = utf8_encode($valor["requisitolista_nombre"]);
      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
      $tipoarchivo_nombre = utf8_encode($valor["tipoarchivo_nombre"]);
      $tipoarchivo_img = utf8_encode($valor["tipoarchivo_img"]);

      $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
      $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
      $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
      $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

      $compania_nombre = utf8_encode($valor["compania_nombre"]);

      if ($estatus_nombre==""){
        $estatus_nombre = "Pendiente";
      }

      if ($requisitolista_id=="162"){
          if ($l_estatus_id=="165"){
            $urlrequisito = $estatus_nombre;        
          }else {
            $urlrequisito = "<a href='panelreenviar-email'><i class='fa fa-envelope'></i> Reenviar Confirmación</a>";        
          }
          

      }else{

          if ($l_estatus_id=="165"){
            $urlrequisito = "<a href='panel-cargarrequisito?id=$requisitolista_id'><i class='fa fa-file'></i> Ver</a>";        
          }else{
            $urlrequisito = "<a href='panel-cargarrequisito?id=$requisitolista_id'><i class='fa fa-file'></i> Ver / Cargar</a>";        
          }
          
      }

      if ($requisito_activo=="0"){
        $activo = "<i onclick='cambiarestatusrequisito(\"".$requisito_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
      }else{
        $activo = "<i onclick='cambiarestatusrequisito(\"".$requisito_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
      }
      
      $accioneliminar = "<i onclick='eliminarrequisito(\"".$requisito_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

      $modificar = "<a href='verrequisitousuario?id=$requisito_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

      $verrequisito = "<a href='verrequisitousuario?id=$requisito_id'>Ver Documentos Cargados</a>";
      

      if (P_Mod!="1"){$modificar = ""; $activo = "";}
      if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

      $mostrarcolumnacuenta = "<td>$cuenta</td>";
      $mostrarcolumnacompania = "<td>$compania_nombre</td>";

      if ($_COOKIE[perfil]=="1"){      
        
      }
      else if ($_COOKIE[perfil]=="2"){       
        $mostrarcolumnacuenta = "";
      }
      else {      
        $mostrarcolumnacuenta = "";
        $mostrarcolumnacompania = ""; 
      }
    

      $textohtml .= "
            <tr>               
              <td>$requisito_id</td>   
              <td>$requisito_fechareg</td>   
              $mostrarcolumnacuenta
              $mostrarcolumnacompania
              <td>$usuario</td>
              <td>$requisitolista_nombre</td>
              

              <td>$estatus_nombre</td>            
              <td style='text-align: center'>$verrequisito</td> 
              <td style='text-align: center'>&nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}


function ListadoUsuariosEvento($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (usuarioevento.usuarioevento_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (usuarioevento.usuarioevento_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (usuarioevento.usuarioevento_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (usuarioevento.usuarioevento_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and usuarioperfil.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and usuarioperfil.cuenta_id = '$_COOKIE[idcuenta]' and usuarioperfil.compania_id = '$_COOKIE[idcompania]'  ";

  } 

  if($getestatus!=""){
    $whereestatus = " and usuarioperfil.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("usuarioperfil.usuario_id, usuarioperfil.usuario_codigo, 
      usuarioperfil.usuario_email, usuarioperfil.usuario_clave, 
      usuarioperfil.usuario_nombre, usuarioperfil.usuario_apellido, usuarioperfil.usuario_telf,  usuarioperfil.usuario_activo, 
      usuarioperfil.usuario_eliminado, usuarioperfil.usuario_documento, usuarioperfil.usuario_img, usuarioperfil.perfil_id,
      usuarioperfil.usuario_direccion, usuarioperfil.usuario_localidad, usuarioperfil.usuario_actividad, 
      usuarioperfil.nacionalidad_id,
      usuarioperfil.sexo_id, usuarioperfil.e_estadocivil_id, usuarioperfil.usuario_conyugenombre, usuarioperfil.usuario_conyugetelf,
      usuarioperfil.usuario_pariente, usuarioperfil.usuario_parientetelf, usuarioperfil.e_parentesco_id,
      usuarioperfil.usuario_telfdos, 
      usuarioperfil.usuario_notas, usuarioperfil.usuario_porcentajecolocador, usuarioperfil.usuario_balance,
      usuarioperfil.usuario_comentarios, 
      DATE_FORMAT(usuarioperfil.usuario_fechanac,'%d/%m/%Y') as usuario_fechanac, usuarioperfil.nivelriesgo_id,
      usuarioperfil.l_tipodocumento_id,
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre, compania_urlweb,
      DATE_FORMAT(usuarioperfil.usuario_fechareg,'%d/%m/%Y %H:%i:%s') as usuario_fechareg,
      perfil_nombre,       
      usuarioperfil.l_estatus_id, estatus.lista_nombre as estatus_nombre,
      usuarioevento_id, 
      DATE_FORMAT(usuarioevento.usuarioevento_fechareg,'%d/%m/%Y %H:%i:%s') as usuarioevento_fechareg,
      evento.evento_id, evento.evento_nombre,
      eventocategoria.eventocateg_id, eventocategoria.eventocateg_nombre, 
      usuarioevento_cod, usuarioevento_activo

      ",
    "usuario usuarioperfil
        inner join usuario cuenta on usuarioperfil.cuenta_id = cuenta.usuario_id
        inner join compania on compania.compania_id = usuarioperfil.compania_id
        inner join perfil on usuarioperfil.perfil_id = perfil.perfil_id
        inner join usuarioevento on usuarioevento.usuario_id = usuarioperfil.usuario_id
        inner join evento on evento.evento_id = usuarioevento.evento_id
        inner join eventocategoria on eventocategoria.eventocateg_id = usuarioevento.eventocateg_id

        left join lista estatus on estatus.lista_id = usuarioperfil.l_estatus_id
        

    ",
    "usuarioperfil.usuario_eliminado = '0' and usuarioevento_eliminado = '0'   $where $whereestatus $whereperfil  $wherefecha ", null, "usuarioperfil.usuario_id desc");
  foreach($arrresultado as $i=>$valor){    

    $t_perfil_id = utf8_encode($valor["perfil_id"]);
    $perfil_nombre = utf8_encode($valor["perfil_nombre"]);

    $usuarioevento_id = utf8_encode($valor["usuarioevento_id"]);
    $evento_id = utf8_encode($valor["evento_id"]);
    $evento_nombre = utf8_encode($valor["evento_nombre"]);
    $eventocateg_id = utf8_encode($valor["eventocateg_id"]);
    $eventocateg_nombre = utf8_encode($valor["eventocateg_nombre"]);
    $usuarioevento_fechareg = utf8_encode($valor["usuarioevento_fechareg"]);
    $usuarioevento_cod = utf8_encode($valor["usuarioevento_cod"]);
    $usuarioevento_activo = utf8_encode($valor["usuarioevento_activo"]);



    $referido_nombre = utf8_encode($valor["referido_nombre"]);
    $referido_apellido = utf8_encode($valor["referido_apellido"]);   
    $referido_codigo = utf8_encode($valor["referido_codigo"]);    
    $referido = "#$referido_codigo ".$referido_nombre." ".$referido_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_codigo = utf8_encode($valor["usuario_codigo"]);
    $usuario_email = utf8_encode($valor["usuario_email"]);
    $usuario_clave = utf8_encode($valor["usuario_clave"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_telf = utf8_encode($valor["usuario_telf"]);
    $usuario_fechareg = utf8_encode($valor["usuario_fechareg"]);
    $usuario_activo = utf8_encode($valor["usuario_activo"]);
    $usuario_documento = utf8_encode($valor["usuario_documento"]);  
    
    $usuario_direccion = utf8_encode($valor["usuario_direccion"]);
    $usuario_localidad = utf8_encode($valor["usuario_localidad"]);
    $usuario_actividad = utf8_encode($valor["usuario_actividad"]);
    $t_nacionalidad_id = utf8_encode($valor["nacionalidad_id"]);
    $t_sexo_id = utf8_encode($valor["sexo_id"]);
    $e_estadocivil_id = utf8_encode($valor["e_estadocivil_id"]);  
    $usuario_conyugenombre = utf8_encode($valor["usuario_conyugenombre"]);
    $usuario_conyugetelf = utf8_encode($valor["usuario_conyugetelf"]);
    $usuario_pariente = utf8_encode($valor["usuario_pariente"]);
    $usuario_parientetelf = utf8_encode($valor["usuario_parientetelf"]);
    $e_parentesco_id = utf8_encode($valor["e_parentesco_id"]);
    $usuario_telfdos = utf8_encode($valor["usuario_telfdos"]);
    $usuario_notas = utf8_encode($valor["usuario_notas"]);
    $usuario_porcentajecolocador = utf8_encode($valor["usuario_porcentajecolocador"]);
    $usuario_balance = utf8_encode($valor["usuario_balance"]);
    $usuario_comentarios = utf8_encode($valor["usuario_comentarios"]);
    $usuario_tasapref = utf8_encode($valor["usuario_tasapref"]);
    $usuario_fechanac = utf8_encode($valor["usuario_fechanac"]);
    $t_nivelriesgo_id = utf8_encode($valor["nivelriesgo_id"]);
    
      $compania_nombre = utf8_encode($valor["compania_nombre"]);
      $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    if ($usuario_id!= "1"){
      if ($usuarioevento_activo=="0"){
        $activo = "<i onclick='cambiarestatususuarioevento(\"".$usuarioevento_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
      }else{
        $activo = "<i onclick='cambiarestatususuarioevento(\"".$usuarioevento_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
      }
      
      $accioneliminar = "<i onclick='eliminarusuarioevento(\"".$usuarioevento_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    }

    $urlmodificar = "";
    if ($t_perfil_id=="2"){$urlmodificar = "modificarcuenta?id=$usuario_id";}
    if ($t_perfil_id=="3"){$urlmodificar = "modificaradmincompania?id=$usuario_id";}
    if ($t_perfil_id=="4"){$urlmodificar = "modificarcliente?id=$usuario_id";}
    if ($t_perfil_id=="5"){$urlmodificar = "modificarvendedor?id=$usuario_id";}
    if ($t_perfil_id=="6"){$urlmodificar = "modificarproveedor?id=$usuario_id";}
    if ($t_perfil_id=="7"){$urlmodificar = "modificarempleado?id=$usuario_id";}
    if ($t_perfil_id=="8"){$urlmodificar = "modificarcliente?id=$usuario_id";}
    if ($t_perfil_id=="9"){$urlmodificar = "modificarcliente?id=$usuario_id";}


    //$urlmodificar = "modificarcliente?id=$usuario_id";

    if ($_COOKIE[perfil]=="1" || $_COOKIE[perfil] =="2"){
      $urlperfil = "modificarcliente?id=$usuario_id";

      $verperfil = "<a href='$urlperfil'>
        <span style='color: #000'>$usuario_nombre $usuario_apellido</span> (Ver Perfil)
      </a>";
    }else{
      $urlperfil = "micuenta";

      $verperfil = "<a href='$urlperfil'>
        <span style='color: #000'>$usuario_nombre $usuario_apellido</span>
      </a>";
    }

    

    
    $modificar = "<a href='$urlmodificar'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    if ($urlmodificar==""){$modificar = "";}

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    
    $simularusuario = "<img onclick='simularusuario(\"".$usuario_id."\")' title='Simular a Usuario' style='cursor:pointer; height: 25px; width: 29px' src='dist/img/usuario1.png'>";
    if ($_COOKIE[perfil]!="1"){$simularusuario="";}

    $textohtml .= "
           <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania            
            <td>$usuarioevento_cod</td>
            <td>$verperfil</td>            
            <td>$evento_nombre</td>            
            <td>$eventocateg_nombre</td>                                  
            <td>$usuarioevento_fechareg</td>              
            <td style='text-align: center'>$simularusuario &nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
              </tr>
        ";

  }

  return $textohtml;

}


function ListadoUsuariosMultiNivel($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and usuarioperfil.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and usuarioperfil.cuenta_id = '$_COOKIE[idcuenta]' and usuarioperfil.compania_id = '$_COOKIE[idcompania]' and usuarioperfil.usuario_idreferido = '$_COOKIE[iniuser]' ";

  } 

  if($getestatus!=""){
    $whereestatus = " and usuarioperfil.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("usuarioperfil.usuario_id, usuarioperfil.usuario_codigo, usuarioperfil.usuario_email, usuarioperfil.usuario_clave, 
      usuarioperfil.usuario_nombre, usuarioperfil.usuario_apellido, usuarioperfil.usuario_telf,  usuarioperfil.usuario_activo, 
      usuarioperfil.usuario_eliminado, usuarioperfil.usuario_documento, usuarioperfil.usuario_img, usuarioperfil.perfil_id,
      usuarioperfil.usuario_direccion, usuarioperfil.usuario_localidad, usuarioperfil.usuario_actividad, usuarioperfil.nacionalidad_id,
      usuarioperfil.sexo_id, usuarioperfil.e_estadocivil_id, usuarioperfil.usuario_conyugenombre, usuarioperfil.usuario_conyugetelf,
      usuarioperfil.usuario_pariente, usuarioperfil.usuario_parientetelf, usuarioperfil.e_parentesco_id, usuarioperfil.usuario_telfdos, 
      usuarioperfil.usuario_notas, usuarioperfil.usuario_porcentajecolocador, usuarioperfil.usuario_balance, usuarioperfil.usuario_comentarios, 
      DATE_FORMAT(usuarioperfil.usuario_fechanac,'%d/%m/%Y') as usuario_fechanac, usuarioperfil.nivelriesgo_id,
      usuarioperfil.l_tipodocumento_id,
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre, compania_urlweb,
      DATE_FORMAT(usuarioperfil.usuario_fechareg,'%d/%m/%Y %H:%i:%s') as usuario_fechareg,
      perfil_nombre, 
      tipousuarioservicio.lista_nombre as tipousuarioservicio_nombre,
      usuarioperfil.l_estatus_id, estatus.lista_nombre as estatus_nombre,

      referido.usuario_nombre as referido_nombre, 
      referido.usuario_apellido as referido_apellido,
      referido.usuario_id as referido_id,
      referido.usuario_codigo as referido_codigo

      ",
    "usuario usuarioperfil
        inner join usuario cuenta on usuarioperfil.cuenta_id = cuenta.usuario_id
        inner join compania on compania.compania_id = usuarioperfil.compania_id
        inner join perfil on usuarioperfil.perfil_id = perfil.perfil_id
        inner join lista tipousuarioservicio on tipousuarioservicio.lista_id = usuarioperfil.l_tipousuarioserv_id
        left join lista estatus on estatus.lista_id = usuarioperfil.l_estatus_id

        left join usuario referido on referido.usuario_id = usuarioperfil.usuario_idreferido

    ",
    "usuarioperfil.usuario_eliminado = '0' and usuarioperfil.perfil_id = '28' and tipousuarioservicio.lista_cod in (3) $where $whereestatus $whereperfil  $wherefecha ", null, "usuarioperfil.usuario_id desc");
  foreach($arrresultado as $i=>$valor){

    $tipousuarioservicio_nombre = utf8_encode($valor["tipousuarioservicio_nombre"]);

    $t_perfil_id = utf8_encode($valor["perfil_id"]);
    $perfil_nombre = utf8_encode($valor["perfil_nombre"]);

    $referido_nombre = utf8_encode($valor["referido_nombre"]);
    $referido_apellido = utf8_encode($valor["referido_apellido"]);   
    $referido_codigo = utf8_encode($valor["referido_codigo"]);    
    $referido = "#$referido_codigo ".$referido_nombre." ".$referido_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_codigo = utf8_encode($valor["usuario_codigo"]);
    $usuario_email = utf8_encode($valor["usuario_email"]);
    $usuario_clave = utf8_encode($valor["usuario_clave"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_telf = utf8_encode($valor["usuario_telf"]);
    $usuario_fechareg = utf8_encode($valor["usuario_fechareg"]);
    $usuario_activo = utf8_encode($valor["usuario_activo"]);
    $usuario_documento = utf8_encode($valor["usuario_documento"]);  
    
    $usuario_direccion = utf8_encode($valor["usuario_direccion"]);
    $usuario_localidad = utf8_encode($valor["usuario_localidad"]);
    $usuario_actividad = utf8_encode($valor["usuario_actividad"]);
    $t_nacionalidad_id = utf8_encode($valor["nacionalidad_id"]);
    $t_sexo_id = utf8_encode($valor["sexo_id"]);
    $e_estadocivil_id = utf8_encode($valor["e_estadocivil_id"]);  
    $usuario_conyugenombre = utf8_encode($valor["usuario_conyugenombre"]);
    $usuario_conyugetelf = utf8_encode($valor["usuario_conyugetelf"]);
    $usuario_pariente = utf8_encode($valor["usuario_pariente"]);
    $usuario_parientetelf = utf8_encode($valor["usuario_parientetelf"]);
    $e_parentesco_id = utf8_encode($valor["e_parentesco_id"]);
    $usuario_telfdos = utf8_encode($valor["usuario_telfdos"]);
    $usuario_notas = utf8_encode($valor["usuario_notas"]);
    $usuario_porcentajecolocador = utf8_encode($valor["usuario_porcentajecolocador"]);
    $usuario_balance = utf8_encode($valor["usuario_balance"]);
    $usuario_comentarios = utf8_encode($valor["usuario_comentarios"]);
    $usuario_tasapref = utf8_encode($valor["usuario_tasapref"]);
    $usuario_fechanac = utf8_encode($valor["usuario_fechanac"]);
    $t_nivelriesgo_id = utf8_encode($valor["nivelriesgo_id"]);
    
      $compania_nombre = utf8_encode($valor["compania_nombre"]);
      $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    if ($usuario_id!= "1"){
      if ($usuario_activo=="0"){
        $activo = "<i onclick='cambiarestatususuario(\"".$usuario_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
      }else{
        $activo = "<i onclick='cambiarestatususuario(\"".$usuario_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
      }
      
      $accioneliminar = "<i onclick='eliminarusuariomultinivel(\"".$usuario_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    }

    $urlmodificar = "";
    if ($t_perfil_id=="2"){$urlmodificar = "modificarcuenta?id=$usuario_id";}
    if ($t_perfil_id=="3"){$urlmodificar = "modificaradmincompania?id=$usuario_id";}
    if ($t_perfil_id=="4"){$urlmodificar = "modificarcliente?id=$usuario_id";}
    if ($t_perfil_id=="5"){$urlmodificar = "modificarvendedor?id=$usuario_id";}
    if ($t_perfil_id=="6"){$urlmodificar = "modificarproveedor?id=$usuario_id";}
    if ($t_perfil_id=="7"){$urlmodificar = "modificarempleado?id=$usuario_id";}
    if ($t_perfil_id=="8"){$urlmodificar = "modificarcliente?id=$usuario_id";}
    if ($t_perfil_id=="9"){$urlmodificar = "modificarcliente?id=$usuario_id";}


    //$urlmodificar = "modificarcliente?id=$usuario_id";

    $urlperfil = "perfilnegocio?id=$usuario_id";

    $verperfil = "<a href='$urlperfil'>
      <span style='color: #000'>#$usuario_codigo $usuario_nombre $usuario_apellido</span> (Ver Perfil)
    </a>";

    
    $modificar = "<a href='$urlmodificar'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    if ($urlmodificar==""){$modificar = "";}

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    
    $simularusuario = "<img onclick='simularusuario(\"".$usuario_id."\")' title='Simular a Usuario' style='cursor:pointer; height: 25px; width: 29px' src='dist/img/usuario1.png'>";
    if ($_COOKIE[perfil]!="1"){$simularusuario="";}

    $textohtml .= "
           <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania            
            <td>$verperfil</td>            
            <td>$usuario_email</td>
            <td>$estatus_nombre</td>
            <td>$usuario_fechareg</td>  
            <td>$referido</td>  
            <td style='text-align: center'>$simularusuario &nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
              </tr>
        ";

  }

  return $textohtml;

}

function ListadoUsuariosServicios($cuentaseleccionada=null, $companiaseleccionada=null, $getestatus=null, $fechadesde =null, $fechahasta=null, $getdate=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and usuarioperfil.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and usuarioperfil.cuenta_id = '$_COOKIE[idcuenta]' and usuarioperfil.compania_id = '$_COOKIE[idcompania]' ";

  } 

  if($getestatus!=""){
    $whereestatus = " and usuarioperfil.l_estatus_id = '$getestatus' ";
  }

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("usuarioperfil.usuario_id, usuarioperfil.usuario_codigo, usuarioperfil.usuario_email, usuarioperfil.usuario_clave, 
      usuarioperfil.usuario_nombre, usuarioperfil.usuario_apellido, usuarioperfil.usuario_telf,  usuarioperfil.usuario_activo, 
      usuarioperfil.usuario_eliminado, usuarioperfil.usuario_documento, usuarioperfil.usuario_img, usuarioperfil.perfil_id,
      usuarioperfil.usuario_direccion, usuarioperfil.usuario_localidad, usuarioperfil.usuario_actividad, usuarioperfil.nacionalidad_id,
      usuarioperfil.sexo_id, usuarioperfil.e_estadocivil_id, usuarioperfil.usuario_conyugenombre, usuarioperfil.usuario_conyugetelf,
      usuarioperfil.usuario_pariente, usuarioperfil.usuario_parientetelf, usuarioperfil.e_parentesco_id, usuarioperfil.usuario_telfdos, 
      usuarioperfil.usuario_notas, usuarioperfil.usuario_porcentajecolocador, usuarioperfil.usuario_balance, usuarioperfil.usuario_comentarios, 
      DATE_FORMAT(usuarioperfil.usuario_fechanac,'%d/%m/%Y') as usuario_fechanac, usuarioperfil.nivelriesgo_id,
      usuarioperfil.l_tipodocumento_id,
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre, compania_urlweb,
      DATE_FORMAT(usuarioperfil.usuario_fechareg,'%d/%m/%Y %H:%i:%s') as usuario_fechareg,
      perfil_nombre, 
      tipousuarioservicio.lista_nombre as tipousuarioservicio_nombre,
      usuarioperfil.l_estatus_id, estatus.lista_nombre as estatus_nombre

      ",
    "usuario usuarioperfil
        inner join usuario cuenta on usuarioperfil.cuenta_id = cuenta.usuario_id
        inner join compania on compania.compania_id = usuarioperfil.compania_id
        inner join perfil on usuarioperfil.perfil_id = perfil.perfil_id
        inner join lista tipousuarioservicio on tipousuarioservicio.lista_id = usuarioperfil.l_tipousuarioserv_id
        left join lista estatus on estatus.lista_id = usuarioperfil.l_estatus_id
    ",
    "usuarioperfil.usuario_eliminado = '0' and usuarioperfil.perfil_id = '4' and tipousuarioservicio.lista_cod in (1,2) $where $whereestatus $whereperfil  $wherefecha ", null, "usuarioperfil.usuario_id desc");
  foreach($arrresultado as $i=>$valor){

    $tipousuarioservicio_nombre = utf8_encode($valor["tipousuarioservicio_nombre"]);

    $t_perfil_id = utf8_encode($valor["perfil_id"]);
    $perfil_nombre = utf8_encode($valor["perfil_nombre"]);

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $usuario_id = utf8_encode($valor["usuario_id"]);
    $usuario_codigo = utf8_encode($valor["usuario_codigo"]);
    $usuario_email = utf8_encode($valor["usuario_email"]);
    $usuario_clave = utf8_encode($valor["usuario_clave"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_telf = utf8_encode($valor["usuario_telf"]);
    $usuario_fechareg = utf8_encode($valor["usuario_fechareg"]);
    $usuario_activo = utf8_encode($valor["usuario_activo"]);
    $usuario_documento = utf8_encode($valor["usuario_documento"]);  
    
    $usuario_direccion = utf8_encode($valor["usuario_direccion"]);
    $usuario_localidad = utf8_encode($valor["usuario_localidad"]);
    $usuario_actividad = utf8_encode($valor["usuario_actividad"]);
    $t_nacionalidad_id = utf8_encode($valor["nacionalidad_id"]);
    $t_sexo_id = utf8_encode($valor["sexo_id"]);
    $e_estadocivil_id = utf8_encode($valor["e_estadocivil_id"]);  
    $usuario_conyugenombre = utf8_encode($valor["usuario_conyugenombre"]);
    $usuario_conyugetelf = utf8_encode($valor["usuario_conyugetelf"]);
    $usuario_pariente = utf8_encode($valor["usuario_pariente"]);
    $usuario_parientetelf = utf8_encode($valor["usuario_parientetelf"]);
    $e_parentesco_id = utf8_encode($valor["e_parentesco_id"]);
    $usuario_telfdos = utf8_encode($valor["usuario_telfdos"]);
    $usuario_notas = utf8_encode($valor["usuario_notas"]);
    $usuario_porcentajecolocador = utf8_encode($valor["usuario_porcentajecolocador"]);
    $usuario_balance = utf8_encode($valor["usuario_balance"]);
    $usuario_comentarios = utf8_encode($valor["usuario_comentarios"]);
    $usuario_tasapref = utf8_encode($valor["usuario_tasapref"]);
    $usuario_fechanac = utf8_encode($valor["usuario_fechanac"]);
    $t_nivelriesgo_id = utf8_encode($valor["nivelriesgo_id"]);
    
      $compania_nombre = utf8_encode($valor["compania_nombre"]);
      $compania_urlweb = utf8_encode($valor["compania_urlweb"]);

      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    if ($usuario_id!= "1"){
      if ($usuario_activo=="0"){
        $activo = "<i onclick='cambiarestatususuario(\"".$usuario_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
      }else{
        $activo = "<i onclick='cambiarestatususuario(\"".$usuario_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
      }
      
      $accioneliminar = "<i onclick='eliminarusuario(\"".$usuario_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
    }

    $urlmodificar = "";
    if ($t_perfil_id=="2"){$urlmodificar = "modificarcuenta?id=$usuario_id";}
    if ($t_perfil_id=="3"){$urlmodificar = "modificaradmincompania?id=$usuario_id";}
    if ($t_perfil_id=="4"){$urlmodificar = "modificarcliente?id=$usuario_id";}
    if ($t_perfil_id=="5"){$urlmodificar = "modificarvendedor?id=$usuario_id";}
    if ($t_perfil_id=="6"){$urlmodificar = "modificarproveedor?id=$usuario_id";}
    if ($t_perfil_id=="7"){$urlmodificar = "modificarempleado?id=$usuario_id";}
    if ($t_perfil_id=="8"){$urlmodificar = "modificarcliente?id=$usuario_id";}
    if ($t_perfil_id=="9"){$urlmodificar = "modificarcliente?id=$usuario_id";}


    $urlperfil = $compania_urlweb."yonke?id=$usuario_id";

    $verperfil = "<a href='$urlperfil' target='_blank'>
      <span style='color: #000'>$usuario_nombre $usuario_apellido</span> (Ver Perfil)
    </a>";
    
    
    $modificar = "<a href='$urlmodificar'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    if ($urlmodificar==""){$modificar = "";}

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }
    
    $simularusuario = "<img onclick='simularusuario(\"".$usuario_id."\")' title='Simular a Usuario' style='cursor:pointer; height: 25px; width: 29px' src='dist/img/usuario1.png'>";
    if ($_COOKIE[perfil]!="1"){$simularusuario="";}

    $textohtml .= "
           <tr>               
            $mostrarcolumnacuenta
            $mostrarcolumnacompania
            <td>$tipousuarioservicio_nombre</td>
            <td>$verperfil</td>            
            <td>$usuario_email</td>
            <td>$estatus_nombre</td>
            <td>$usuario_fechareg</td>  
            <td style='text-align: center'>$simularusuario &nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
              </tr>
        ";

  }

  return $textohtml;

}


function ListadoSolicitudServiciosParte($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (solicitudserv_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
    $titulo = "Ventas del Día";
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (solicitudserv_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (solicitudserv_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (solicitudserv_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($estatusseleccionado!=""){
    $whereestatus =" and solicitudservicio.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
  
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and solicitudservicio.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and solicitudservicio.cuenta_id = '$_COOKIE[idcuenta]' and solicitudservicio.compania_id = '$_COOKIE[idcompania]'  ";

  } 

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("
    solicitudservicio.solicitudserv_id, solicitudservicio.usuario_id, solicitudservicio.solicitudserv_titulo, 
    solicitudservicio.solicitudserv_descrip, solicitudservicio.solicitudserv_latitud, solicitudservicio.solicitudserv_longitud,
    solicitudservicio.solicitudserv_dircompleta, solicitudservicio.solicitudserv_infodir, solicitudservicio.solicitudserv_infocalle,
    solicitudservicio.solicitudserv_infocodpostal, solicitudservicio.solicitudserv_infociudad, 
    solicitudservicio.solicitudserv_infociudad2, solicitudservicio.solicitudserv_infosublocalidad, 
    solicitudservicio.solicitudserv_inforegion, solicitudservicio.solicitudserv_infocountry, 
    solicitudservicio.cuenta_id, solicitudservicio.compania_id, solicitudservicio.solicitudserv_activo,
    solicitudservicio.solicitudserv_eliminado,
    solicitudservicio.usuario_idreg, 
    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre, 

    solicitudserv_codigo, solicitudserv_codigoint, solicitudservicio.l_estatus_id, 
    estatus.lista_nombre as estatus_nombre,
    solicitudservicio.l_categ_id, solicitudservicio.l_subcateg_id,
    categoria.lista_nombre as categ_nombre, categoria.lista_img as categ_img,
    subcategoria.lista_nombre as subcateg_nombre, subcategoria.lista_img as subcateg_img,
    DATE_FORMAT(solicitudservicio.solicitudserv_fechareg,'%d/%m/%Y %H:%i:%s') as solicitudserv_fechareg, 
    solicitudserv_leidos, solicitudserv_notificados,
    marca.lista_nombre as marca_nombre, marca.lista_img as marca_img,
    modelo.lista_nombre as modelo_nombre, modelo.lista_img as modelo_img,
    ano.ano_id, ano_texto

    ",
    "solicitudservicio
      inner join lista marca on marca.lista_id = solicitudservicio.l_marca_id
      inner join lista modelo on modelo.lista_id = solicitudservicio.l_modelo_id
      inner join ano on ano.ano_id = solicitudservicio.ano_id

      left join lista categoria on categoria.lista_id = solicitudservicio.l_categ_id
      left join lista subcategoria on subcategoria.lista_id = solicitudservicio.l_subcateg_id

      inner join usuario on usuario.usuario_id = solicitudservicio.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = solicitudservicio.cuenta_id
      inner join compania on compania.compania_id = solicitudservicio.compania_id
      inner join lista estatus on estatus.lista_id = solicitudservicio.l_estatus_id

    ",
    "solicitudserv_eliminado = '0' $where $whereestatus $wherefecha", null, "solicitudservicio.solicitudserv_id desc"); 

  foreach($arrresultado as $i=>$valor){

    $ano_id = utf8_encode($valor["ano_id"]);
    $ano_texto = utf8_encode($valor["ano_texto"]);
    $marca_nombre = utf8_encode($valor["marca_nombre"]);
    $marca_img = utf8_encode($valor["marca_img"]);
    $modelo_nombre = utf8_encode($valor["modelo_nombre"]);
    $modelo_img = utf8_encode($valor["modelo_img"]);

    



    $categ_nombre = utf8_encode($valor["categ_nombre"]);
    $categ_img = utf8_encode($valor["categ_img"]);
    $subcateg_nombre = utf8_encode($valor["subcateg_nombre"]);
    $subcateg_img = utf8_encode($valor["subcateg_img"]);

    $solicitudserv_codigo = utf8_encode($valor["solicitudserv_codigo"]);
    $solicitudserv_leidos = utf8_encode($valor["solicitudserv_leidos"]);
    $solicitudserv_notificados = utf8_encode($valor["solicitudserv_notificados"]);
    $solicitudserv_codigoint = utf8_encode($valor["solicitudserv_codigoint"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    $solicitudserv_id = utf8_encode($valor["solicitudserv_id"]);
    $t_usuario_id = utf8_encode($valor["usuario_id"]);
    $solicitudserv_titulo = utf8_encode($valor["solicitudserv_titulo"]);
    $solicitudserv_descrip = utf8_encode($valor["solicitudserv_descrip"]);
    $solicitudserv_latitud = utf8_encode($valor["solicitudserv_latitud"]);
    $solicitudserv_longitud = utf8_encode($valor["solicitudserv_longitud"]);
    $solicitudserv_dircompleta = utf8_encode($valor["solicitudserv_dircompleta"]);
    $solicitudserv_infodir = utf8_encode($valor["solicitudserv_infodir"]);
    $solicitudserv_infocalle = utf8_encode($valor["solicitudserv_infocalle"]);
    $solicitudserv_infocodpostal = utf8_encode($valor["solicitudserv_infocodpostal"]);
    $solicitudserv_infociudad = utf8_encode($valor["solicitudserv_infociudad"]);
    $solicitudserv_infociudad2 = utf8_encode($valor["solicitudserv_infociudad2"]);
    $solicitudserv_infosublocalidad = utf8_encode($valor["solicitudserv_infosublocalidad"]);
    $solicitudserv_inforegion = utf8_encode($valor["solicitudserv_inforegion"]);
    $solicitudserv_infocountry = utf8_encode($valor["solicitudserv_infocountry"]);
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $solicitudserv_activo = utf8_encode($valor["solicitudserv_activo"]);
    $solicitudserv_fechareg = utf8_encode($valor["solicitudserv_fechareg"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $urlmarca = "arch/$marca_img";
    $urlcateg = "arch/$categ_img";


    $titulo = "#$solicitudserv_codigo";  

    $solicitudserv_titulo = "<a href='versolicitudservicioparte?id=$solicitudserv_id' style='color: #0B787A'>$solicitudserv_titulo (Ver)</a>";

    $idsolicitud = "<a href='versolicitudservicioparte?id=$solicitudserv_id'>$titulo (Ver)</a>";


    if ($solicitudserv_leidos>0){
      $solicitudserv_leidos = "<a href='panelusuario-solicitudes-recibidas?id=$solicitudserv_id' style='color: #0B787A'>$solicitudserv_leidos (Ver)</a>";    
    }else{
      $solicitudserv_leidos = "0";
    }

    if ($solicitudserv_notificados>0){
      $solicitudserv_notificados = "<a href='panelusuario-solicitudes-recibidas?id=$solicitudserv_id' style='color: #0B787A'>$solicitudserv_notificados (Ver)</a>";    
    }else{
      $solicitudserv_notificados = "0";
    }



    if ($solicitudserv_activo=="0"){
      $activo = "<i onclick='cambiarestatussolicitudservicio(\"".$solicitudserv_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatussolicitudservicio(\"".$solicitudserv_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarsolicitudservicio(\"".$solicitudserv_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
    $modificar_old = "<a href='modificarsolicitudservicio?id=$solicitudserv_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    if ($categ_nombre!=""){
      if ($subcateg_nombre!=""){
        $infocateg = "
          $categ_nombre / $subcateg_nombre <br><img src='$urlcateg' class='img-responsive' style='height: 40px' />
        ";
      }else{
        $infocateg = "
          $categ_nombre;?> <br><img src='$urlcateg' class='img-responsive' style='height: 40px' />
        ";
      }   
    }else{
      $infocateg = "(Sin Selección)";
    }

    $infomarca = "$marca_nombre / $modelo_nombre / $ano_texto <br> <img src='$urlmarca' class='img-responsive' style='height: 40px' />";
    

    $solicitudserv_codigo = "<a href='versolicitudservicioparte?id=$solicitudserv_id' style='color: #0B787A'>#$solicitudserv_codigo (Ver)</a>";

    $textohtml .= "
         <tr>               
          $mostrarcolumnacuenta
          $mostrarcolumnacompania
          <td>$solicitudserv_codigo</td>
          <td>$infomarca</td>
          <td>$solicitudserv_titulo</td>
          <td>$solicitudserv_fechareg</td>
          <td>$usuario</td>
          <td>$estatus_nombre</td>        
          <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
      ";

  }

  return $textohtml;

}



function ListadoSolicitudServicios($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (solicitudserv_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
    $titulo = "Ventas del Día";
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (solicitudserv_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (solicitudserv_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (solicitudserv_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($estatusseleccionado!=""){
    $whereestatus =" and solicitudservicio.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
  
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and solicitudservicio.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and solicitudservicio.cuenta_id = '$_COOKIE[idcuenta]' and solicitudservicio.compania_id = '$_COOKIE[idcompania]'  ";

  } 

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("
    solicitudservicio.solicitudserv_id, solicitudservicio.usuario_id, solicitudservicio.solicitudserv_titulo, 
    solicitudservicio.solicitudserv_descrip, solicitudservicio.solicitudserv_latitud, solicitudservicio.solicitudserv_longitud,
    solicitudservicio.solicitudserv_dircompleta, solicitudservicio.solicitudserv_infodir, solicitudservicio.solicitudserv_infocalle,
    solicitudservicio.solicitudserv_infocodpostal, solicitudservicio.solicitudserv_infociudad, 
    solicitudservicio.solicitudserv_infociudad2, solicitudservicio.solicitudserv_infosublocalidad, 
    solicitudservicio.solicitudserv_inforegion, solicitudservicio.solicitudserv_infocountry, 
    solicitudservicio.cuenta_id, solicitudservicio.compania_id, solicitudservicio.solicitudserv_activo,
    solicitudservicio.solicitudserv_eliminado,
    solicitudservicio.usuario_idreg, 
    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_img, 
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
    cuenta.usuario_apellido as cuenta_apellido, compania_nombre, 

    solicitudserv_codigo, solicitudserv_codigoint, solicitudservicio.l_estatus_id, 
    estatus.lista_nombre as estatus_nombre,
    solicitudservicio.l_categ_id, solicitudservicio.l_subcateg_id,
    categoria.lista_nombre as categ_nombre, categoria.lista_img as categ_img,
    subcategoria.lista_nombre as subcateg_nombre, subcategoria.lista_img as subcateg_img,
    DATE_FORMAT(solicitudservicio.solicitudserv_fechareg,'%d/%m/%Y %H:%i:%s') as solicitudserv_fechareg, 
    DATE_FORMAT(solicitudservicio.solicitudserv_fecha,'%d/%m/%Y %H:%i:%s') as solicitudserv_fecha, 
    solicitudserv_leidos, solicitudserv_notificados,
    solicitudservicio.l_paquete_id,
    estatus.lista_cod, 
    tiposolicitud.lista_nombre as tiposolicitud_nombre

    ",
    "solicitudservicio
      left join lista categoria on categoria.lista_id = solicitudservicio.l_categ_id
      left join lista subcategoria on subcategoria.lista_id = solicitudservicio.l_subcateg_id

      inner join usuario on usuario.usuario_id = solicitudservicio.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = solicitudservicio.cuenta_id
      inner join compania on compania.compania_id = solicitudservicio.compania_id
      inner join lista estatus on estatus.lista_id = solicitudservicio.l_estatus_id
      left join lista tiposolicitud on tiposolicitud.lista_id = solicitudservicio.l_tiposolicitud_id

    ",
    "solicitudserv_eliminado = '0' $where $whereestatus $wherefecha", null, "solicitudservicio.solicitudserv_id desc"); 

  foreach($arrresultado as $i=>$valor){

    $tiposolicitud_nombre = utf8_encode($valor["tiposolicitud_nombre"]);
    $lista_cod = utf8_encode($valor["lista_cod"]);
    $l_paquete_id = utf8_encode($valor["l_paquete_id"]);
    $categ_nombre = utf8_encode($valor["categ_nombre"]);
    $categ_img = utf8_encode($valor["categ_img"]);
    $subcateg_nombre = utf8_encode($valor["subcateg_nombre"]);
    $subcateg_img = utf8_encode($valor["subcateg_img"]);

    $solicitudserv_codigo = utf8_encode($valor["solicitudserv_codigo"]);
    $solicitudserv_leidos = utf8_encode($valor["solicitudserv_leidos"]);
    $solicitudserv_notificados = utf8_encode($valor["solicitudserv_notificados"]);
    $solicitudserv_codigoint = utf8_encode($valor["solicitudserv_codigoint"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    $solicitudserv_id = utf8_encode($valor["solicitudserv_id"]);
    $t_usuario_id = utf8_encode($valor["usuario_id"]);
    $solicitudserv_titulo = utf8_encode($valor["solicitudserv_titulo"]);
    $solicitudserv_descrip = utf8_encode($valor["solicitudserv_descrip"]);
    $solicitudserv_latitud = utf8_encode($valor["solicitudserv_latitud"]);
    $solicitudserv_longitud = utf8_encode($valor["solicitudserv_longitud"]);
    $solicitudserv_dircompleta = utf8_encode($valor["solicitudserv_dircompleta"]);
    $solicitudserv_infodir = utf8_encode($valor["solicitudserv_infodir"]);
    $solicitudserv_infocalle = utf8_encode($valor["solicitudserv_infocalle"]);
    $solicitudserv_infocodpostal = utf8_encode($valor["solicitudserv_infocodpostal"]);
    $solicitudserv_infociudad = utf8_encode($valor["solicitudserv_infociudad"]);
    $solicitudserv_infociudad2 = utf8_encode($valor["solicitudserv_infociudad2"]);
    $solicitudserv_infosublocalidad = utf8_encode($valor["solicitudserv_infosublocalidad"]);
    $solicitudserv_inforegion = utf8_encode($valor["solicitudserv_inforegion"]);
    $solicitudserv_infocountry = utf8_encode($valor["solicitudserv_infocountry"]);
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $solicitudserv_activo = utf8_encode($valor["solicitudserv_activo"]);
    $solicitudserv_fecha = utf8_encode($valor["solicitudserv_fecha"]);
    $solicitudserv_fechareg = utf8_encode($valor["solicitudserv_fechareg"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $usuario = $usuario_nombre." ".$usuario_apellido." ";

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";


    $titulo = "#$solicitudserv_codigo";  

    $solicitudserv_titulo = "<a href='versolicitudservicio?id=$solicitudserv_id' style='color: #0B787A'>$solicitudserv_titulo (Ver)</a>";

    $idsolicitud = "<a href='versolicitudservicio?id=$solicitudserv_id'>$titulo (Ver)</a>";


    if ($solicitudserv_leidos>0){
      $solicitudserv_leidos = "<a href='panelusuario-solicitudes-recibidas?id=$solicitudserv_id' style='color: #0B787A'>$solicitudserv_leidos (Ver)</a>";    
    }else{
      $solicitudserv_leidos = "0";
    }
    /*
    if ($solicitudserv_notificados>0){
      $solicitudserv_notificados = "<a href='panelusuario-solicitudes-recibidas?id=$solicitudserv_id' style='color: #0B787A'>$solicitudserv_notificados (Ver)</a>";    
    }else{
      $solicitudserv_notificados = "0";
    }*/



    if ($solicitudserv_activo=="0"){
      $activo = "<i onclick='cambiarestatussolicitudservicio(\"".$solicitudserv_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatussolicitudservicio(\"".$solicitudserv_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarsolicitudservicio(\"".$solicitudserv_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
    $modificar_old = "<a href='modificarsolicitudservicio?id=$solicitudserv_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $btnjitsi = "";

    if ($lista_cod=="5" ){ // Contratado

      if ($l_paquete_id!=""){
        $urljitsi = "https://meet.jit.si/xxippo_paquete_$l_paquete_id";  
      }else{
        $urljitsi = "https://meet.jit.si/xxippo_$solicitudserv_id";  
      }

      $btnjitsi = "&nbsp
        <a href='$urljitsi' target='_blank' style='color: #000' title='Abrir Link'>
         <i class='fa fa-video-camera'></i> 
        </a>      
        <br>
      ";

    }
    

    $solicitudserv_codigo = "<a href='versolicitudservicio?id=$solicitudserv_id' style='color: #0B787A'>#$solicitudserv_codigo (Ver)</a>";

    $enviarsolicitud = "<a href='versolicitudservicio?id=$solicitudserv_id&s=1' target='_blank' title='Enviar Solicitud'><i class='fa fa-paper-plane'></i></a>";

    $solicitudservicioprestador = "
      <a href='solicitudservicioprestador?id=$solicitudserv_id' title='Ver Notificados'>
        ($solicitudserv_notificados)<br>
        Notificados
      </a>";

    $textohtml .= "
         <tr>               
          $mostrarcolumnacuenta
          $mostrarcolumnacompania
          
          <td>$tiposolicitud_nombre</td>
          <td>$solicitudserv_codigo</td>
          <td>$categ_nombre / $subcateg_nombre</td>
          <td>$solicitudserv_titulo</td>
          <td>$solicitudserv_fecha</td>
          <td>$usuario</td>
          <td>$estatus_nombre</td>        
          <td style='text-align: center'>$solicitudservicioprestador</td>        
          <td style='text-align: center'>$btnjitsi &nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
      ";

  }

  return $textohtml;

}

function GuardarProcesoModificarLista($lista_id=null, $lista_nombre=null, $lista_nombredos=null, $lista_descrip=null, $lista_img=null, $lista_ppal=null, $lista_orden=null, $tipolista_id=null, $cuenta_id=null, $compania_id=null, $lista_icono=null, $lista_color=null, $lista_idrel=null, $lista_url=null, $fechaactual=null, $listacuenta_id=null, $lista_mostrarppal=null, $lista_idreldos=null, $lista_cod=null, $lista_resumen=null, $lista_img2=null, $usuario_id=null, $perfil_id=null){  

  if ($lista_mostrarppal==""){$lista_mostrarppal=0;}

  $conexion = new ConexionBd(); 

  $resultadoArray = array();

  $arrresultado2 = $conexion->doSelect("listacuenta_img","listacuenta", "listacuenta_id = '$listacuenta_id'");
  if (count($arrresultado2)>0){
    foreach($arrresultado2 as $i=>$valor){
      $lista_imgoriginalcuenta = $valor["listacuenta_img"];
    }
  }

  $arrresultado2 = $conexion->doSelect("lista_id, lista_ppal, lista_img","lista", "lista_id = '$lista_id'");
  if (count($arrresultado2)>0){
    foreach($arrresultado2 as $i=>$valor){
      $lista_id = $valor["lista_id"];
      $lista_ppal = $valor["lista_ppal"];
      $lista_imgoriginal = $valor["lista_img"];
    }
  }



  if  ($lista_img==""){
    if ($lista_imgoriginalcuenta!=""){
      $lista_img = $lista_imgoriginalcuenta;  
    }else{
      $lista_img = $lista_imgoriginal;
    }
    
  }

  if ($lista_idrel!=""){
    $agregarlistarel = "
      lista_idrel = '$lista_idrel',
    ";
  }

  if ($lista_idreldos!=""){
    $agregarlistareldos = "
      lista_idreldos = '$lista_idreldos',
    ";
  }

  // Si no se pasó perfil_id, intentar obtener de cookie
  if ($perfil_id == "" || $perfil_id == null){
    $perfil_id = $_COOKIE[perfil];
  }

  // Si no se pasó usuario_id, intentar obtener de cookie
  if ($usuario_id == "" || $usuario_id == null){
    $usuario_id = $_COOKIE[iniuser];
  }

  if ($perfil_id=="1"){

/*
     echo "lista_orden:".$lista_orden;
     echo "<br>";
     echo "lista_id:".$lista_id;
     echo "<br>";
     echo "listacuentaaa_id:".$listacuenta_id;
     echo "<br>";
  exit();

  */

    if ($listacuenta_id==""){

      $resultado = $conexion->doInsert("
        listacuenta
          (lista_id, cuenta_id, compania_id, listacuenta_nombre, listacuenta_nombredos, listacuenta_descrip, listacuenta_img,
           listacuenta_fechareg, listacuenta_activo, listacuenta_eliminado, usuario_idreg, listacuenta_orden)
        ",
        "'$lista_id', '$cuenta_id', '$compania_id','$lista_nombre', '','$lista_descrip', '$nombrecolocar2',
        '$fechaactual', '1','0','$usuario_id','$lista_orden'");

      $arrresultado2 = $conexion->doSelect("max(listacuenta_id) as listacuenta_id","listacuenta");
      if (count($arrresultado2)>0){
        foreach($arrresultado2 as $i=>$valor){
          $listacuenta_id = ($valor["listacuenta_id"]);
        }
      }

    }

    


    if ($lista_img==""){$lista_img=$lista_imgoriginal;}

    if ($lista_id!=""){

      $resultado = $conexion->doUpdate("lista", 
      "           
        $agregarlistarel
        $agregarlistareldos

        lista_nombre = '$lista_nombre',  
        lista_cod = '$lista_cod',
        lista_mostrarppal = '$lista_mostrarppal',
        lista_nombredos = '$lista_nombredos', 
        lista_descrip = '$lista_descrip', 
        lista_orden = '$lista_orden',
        lista_url = '$lista_url',
        lista_img = '$lista_img',  
        lista_img2 = '$lista_img2',       
        tipolista_id = '$tipolista_id',
        cuenta_id = '$cuenta_id',
        compania_id = '$compania_id',
        lista_resumen = '$lista_resumen'
      ", 
      "lista_id='$lista_id'");

    }


      $resultado = $conexion->doUpdate("listacuenta", 
      "           
        listacuenta_nombre = '$lista_nombre',           
        listacuenta_descrip = '$lista_descrip',  
        listacuenta_orden = '$lista_orden',
        listacuenta_fechareg = '$fechaactual',
        listacuenta_img = '$lista_img'
      ", 
      "listacuenta_id='$listacuenta_id'"); 
    

    }else{

      /*
     echo "lista_orden:".$lista_orden;
     echo "<br>";
     echo "lista_id:".$lista_id;
     echo "<br>";
     echo "listacuentaaa_id:".$listacuenta_id;
     echo "<br>";
  exit();


*/  

    $arrresultado2 = $conexion->doSelect("lista_ppal","lista", "lista_id = '$lista_id' and cuenta_id = '2' and compania_id = '1'");
      if (count($arrresultado2)>0){
        foreach($arrresultado2 as $i=>$valor){
          $lista_ppal = $valor["lista_ppal"];       
        }
      }
    if ($lista_ppal!="1"){

      $resultado = $conexion->doUpdate("lista", 
      "           
        $agregarlistarel
        $agregarlistareldos

        lista_nombre = '$lista_nombre',   
        lista_cod = '$lista_cod',
        lista_mostrarppal = '$lista_mostrarppal',
        lista_nombredos = '$lista_nombredos', 
        lista_descrip = '$lista_descrip', 
        lista_orden = '$lista_orden',
        lista_url = '$lista_url',
        lista_img = '$lista_img',   
        lista_img2 = '$lista_img2',        
        tipolista_id = '$tipolista_id',
        cuenta_id = '$cuenta_id',
        compania_id = '$compania_id',
        lista_resumen = '$lista_resumen'
      ", 
      "lista_id='$lista_id'");

      $resultado = $conexion->doUpdate("listacuenta", 
      "           
        listacuenta_nombre = '$lista_nombre',           
        listacuenta_descrip = '$lista_descrip',  
        listacuenta_orden = '$lista_orden',
        listacuenta_fechareg = '$fechaactual',
        listacuenta_img = '$lista_img'
      ", 
      "listacuenta_id='$listacuenta_id'"); 

    }


    $nombrecolocar2 = $lista_img;

    if ($lista_img==""){
      $arrresultado2 = $conexion->doSelect("lista_img","lista", "lista_id = '$lista_id' and cuenta_id = '2' and compania_id = '1'");
      if (count($arrresultado2)>0){
        foreach($arrresultado2 as $i=>$valor){
          $lista_img = $valor["lista_img"];       
        }
      }

       $arrresultado2 = $conexion->doSelect("listacuenta_img","listacuenta", "lista_id = '$lista_id' and cuenta_id = '$cuenta_id' and compania_id = '$compania_id' and listacuenta_id = '$listacuenta_id'");
      if (count($arrresultado2)>0){
        foreach($arrresultado2 as $i=>$valor){
          $listacuenta_img = $valor["listacuenta_img"];       
        }
      }


      if ($nombrecolocar==""){
        if ($listacuenta_img==""){
          $nombrecolocar2 = $lista_img; 
        }else{
          $nombrecolocar2 = $listacuenta_img; 
        }       
      }else{
        $nombrecolocar2 = $nombrecolocar;       
      }
    }

   


    if ($listacuenta_id==""){

      $resultado = $conexion->doInsert("
        listacuenta
          (lista_id, cuenta_id, compania_id, listacuenta_nombre, listacuenta_nombredos, listacuenta_descrip, listacuenta_img,
           listacuenta_fechareg, listacuenta_activo, listacuenta_eliminado, usuario_idreg, listacuenta_orden)
        ",
        "'$lista_id', '$cuenta_id', '$compania_id','$lista_nombre', '','$lista_descrip', '$nombrecolocar2',
        '$fechaactual', '1','0','$usuario_id','$lista_orden'");

      $arrresultado2 = $conexion->doSelect("max(listacuenta_id) as listacuenta_id","listacuenta");
      if (count($arrresultado2)>0){
        foreach($arrresultado2 as $i=>$valor){
          $listacuenta_id = utf8_encode($valor["listacuenta_id"]);
        }
      }

    }else{




        $resultado = $conexion->doUpdate("listacuenta", 
        "           
          listacuenta_nombre = '$lista_nombre', 
          listacuenta_descrip = '$lista_descrip', 
          listacuenta_img ='$nombrecolocar2',
          listacuenta_fechareg ='$fechaactual',
          listacuenta_orden = '$lista_orden'        
        ", 
        "listacuenta_id='$listacuenta_id'");

    }


    

  }

  $resultadoArray = array(     
  'lista_id' => $lista_id,
  'listacuenta_id'  => $listacuenta_id
  );

  return $resultadoArray;

}

function GuardarProcesoLista($lista_nombre=null, $lista_nombredos=null, $lista_descrip=null, $lista_img=null, $lista_ppal=null, $lista_orden=null, $tipolista_id=null, $cuenta_id=null, $compania_id=null, $lista_icono=null, $lista_color=null, $lista_idrel=null, $lista_url=null, $fechaactual=null, $lista_mostrarppal=null, $lista_idreldos=null, $lista_cod=null, $lista_resumen=null, $lista_img2=null, $usuario_id=null){  


  $resultadoArray = array();

  // GuardoLista en tabla lista
  $resultadolista_id = GuardarLista($lista_nombre, $lista_nombredos, $lista_descrip, $lista_img, $lista_ppal, $lista_orden, $tipolista_id, $cuenta_id, $compania_id, $fechaactual, $lista_icono, $lista_color, $lista_idrel, $lista_url, $lista_mostrarppal, $lista_idreldos, $lista_cod, $lista_resumen, $lista_img2);

  //Guaro en ListaCuenta
  $resultadolistacuenta_id = GuardarListaCuenta($resultadolista_id, $cuenta_id, $compania_id, $lista_nombre, $lista_nombredos, $lista_descrip, $lista_img, $fechaactual, $lista_orden, $usuario_id);

  $resultadoArray = array(     
  'lista_id' => $resultadolista_id,
  'listacuenta_id'  => $resultadolistacuenta_id
  );

  return $resultadoArray;

}


function GuardarListaFormaPago($listaformapago_id=null, $lista_id=null, $listaformapago_titular=null, $listaformapago_documento=null, $listaformapago_email=null, $listaformapago_banco=null,  $listaformapago_tipocuenta=null, $listaformapago_nrocuenta=null, $listaformapago_otros=null, $fechaactual=null, $cuenta_id=null, $compania_id=null, $listacuenta_id=null, $listaformapago_token=null, $listaformapago_clavepublica=null, $usuario_id=null){

  // Guarda la ListaFormaPago

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  if ($listaformapago_id==""){
    $arrresultado2 = $conexion->doSelect("listaformapago_id","listaformapago", "listacuenta_id = '$listacuenta_id'");

    if (count($arrresultado2)>0){
      foreach($arrresultado2 as $i=>$valor){
        $listaformapago_idorig = ($valor["listaformapago_id"]);
      }
    }
  }

  if ($usuario_id==""){
    $usuario_id = $_COOKIE[iniuser]; 
  }


  
  /*
  echo "listacuenta_id:".$listacuenta_id;
  echo "<br>";
  echo "listaformapago_idorig:".$listaformapago_id;
  echo "<br>";
  echo "listaformapago_id:".$listaformapago_id;
  exit();

  */


  if ($listaformapago_id==""){
    $resultado = $conexion->doInsert("
      listaformapago
      (l_formapago_id, listaformapago_titular, listaformapago_documento, listaformapago_email, listaformapago_banco,
      listaformapago_tipocuenta, listaformapago_nrocuenta, listaformapago_otros, listaformapago_fechareg, usuario_idreg, 
      cuenta_id, compania_id, listacuenta_id, listaformapago_token, listaformapago_clavepublica, usuario_id) 

      ",
      "'$lista_id', '$listaformapago_titular', '$listaformapago_documento','$listaformapago_email','$listaformapago_banco',
      '$listaformapago_tipocuenta', '$listaformapago_nrocuenta', '$listaformapago_otros','$fechaactual','$usuario_id',
      '$cuenta_id', '$compania_id','$listacuenta_id','$listaformapago_token','$listaformapago_clavepublica', '$usuario_id'");
  }else{

       $resultado = $conexion->doUpdate("listaformapago", 
        "           
          listaformapago_titular = '$listaformapago_titular', 
          listaformapago_documento = '$listaformapago_documento', 
          listaformapago_email = '$listaformapago_email',
          l_formapago_id = '$lista_id',
          listaformapago_banco = '$listaformapago_banco',           
          listaformapago_tipocuenta = '$listaformapago_tipocuenta',
          listaformapago_nrocuenta = '$listaformapago_nrocuenta',
          listaformapago_token = '$listaformapago_token',
          listaformapago_clavepublica = '$listaformapago_clavepublica',
          listaformapago_otros = '$listaformapago_otros',
          usuario_id = '$usuario_id'
        ", 
          "listaformapago_id='$listaformapago_id'");

  }

  return $resultado;
}


function GuardarListaCuenta($lista_id=null, $cuenta_id=null, $compania_id=null, $listacuenta_nombre=null, $listacuenta_nombredos=null,  $listacuenta_descrip=null, $listacuenta_img=null, $fechaactual=null, $listacuenta_orden=null, $usuario_id=null){

  if ($listacuenta_orden==""){$listacuenta_orden=0;}
  if ($lista_orden==""){$lista_orden=0;}
  if ($lista_idrel==""){$lista_idrel=0;}

  $conexion = new ConexionBd();

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  // Si no se pasa usuario_id, intentar obtener de cookie/session
  if ($usuario_id == "" || $usuario_id == null){
    $iniuser = $_COOKIE[iniuser];
    if ($iniuser==""){
      $iniuser = $_SESSION[iniuser];
      if ($iniuser==""){
        $iniuser = 0;
      }
    }
    $usuario_id = $iniuser;
  }

  $resultado = $conexion->doInsert("
    listacuenta
      (lista_id, cuenta_id, compania_id, listacuenta_nombre, listacuenta_nombredos, listacuenta_descrip, listacuenta_img,
       listacuenta_fechareg, listacuenta_activo, listacuenta_eliminado, usuario_idreg, listacuenta_orden)
    ",
    "'$lista_id', '$cuenta_id', '$compania_id','$listacuenta_nombre', '$listacuenta_nombredos','$listacuenta_descrip', '$listacuenta_img',
    '$fechaactual', '1','0','$usuario_id','$listacuenta_orden'");

  $arrresultado2 = $conexion->doSelect("max(listacuenta_id) as listacuenta_id","listacuenta");
  if (count($arrresultado2)>0){
    foreach($arrresultado2 as $i=>$valor){
      $listacuenta_id = ($valor["listacuenta_id"]);
    }
  }

  return $listacuenta_id;
}



function GuardarLista($lista_nombre=null, $lista_nombredos=null, $lista_descrip=null, $lista_img=null, $lista_ppal=null, $lista_orden=null, $tipolista_id=null, $cuenta_id=null, $compania_id=null, $lista_fechareg=null, $lista_icono=null, $lista_color=null, $lista_idrel=null, $lista_url=null, $lista_mostrarppal=null, $lista_idreldos=null, $lista_cod=null, $lista_resumen=null, $lista_img2=null){

  if ($lista_ppal==""){$lista_ppal=0;}
  if ($lista_orden==""){$lista_orden=0;}
  if ($lista_idrel==""){$lista_idrel=0;}
  if ($lista_idreldos==""){$lista_idreldos=0;}
  if ($lista_mostrarppal==""){$lista_mostrarppal=0;}

  $conexion = new ConexionBd();  

  $fechaactual = formatoFechaHoraBd(); 

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
/*
  echo "cuenta_id:".$cuenta_id;
  echo "<br>";
  echo "compania_id:".$compania_id;
  exit();
*/  

  $iniuser = $_COOKIE[iniuser];

  if ($iniuser==""){
    $iniuser = $_SESSION[iniuser];
    if ($iniuser==""){
      $iniuser = 0;
    }
  }

  $resultado = $conexion->doInsert("
      lista
        (lista_nombre, lista_nombredos, lista_descrip, lista_img, lista_ppal, lista_cod,
        lista_orden, tipolista_id, cuenta_id, compania_id, 
        lista_fechareg, lista_activo, lista_eliminado, usuario_idreg, 
        lista_icono, lista_color, lista_idrel, lista_url, lista_mostrarppal, lista_idreldos,
        lista_resumen, lista_img2)
      ",
      "'$lista_nombre', '$lista_nombredos', '$lista_descrip','$lista_img','$lista_ppal', '$lista_cod',
      '$lista_orden','$tipolista_id', '$cuenta_id','$compania_id',
      '$fechaactual', '1','0','$iniuser',
      '$lista_icono', '$lista_color','$lista_idrel','$lista_url','$lista_mostrarppal', '$lista_idreldos',
      '$lista_resumen', '$lista_img2'");

  $arrresultado2 = $conexion->doSelect("max(lista_id) as lista_id","lista");
  if (count($arrresultado2)>0){
    foreach($arrresultado2 as $i=>$valor){
      $lista_id = ($valor["lista_id"]);
    }
  }

  return $lista_id;
}


function ObtenerListaUsuarioServicio($tipolista_id=null, $cuenta=null, $compania=null, $elementoid=null, $ordenar=null, $agregardespues=null, $listaid_rel=null){

  if ($ordenar=="entero"){
    $orderby = "CAST(lista_nombre AS UNSIGNED)";
  }else{
    $orderby = "lista_orden";
  }

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $option = "<option value=''>-- Seleccione --</option>";

  if ($listaid_rel!=""){
    $wherelistarel = " and lista.lista_idrel = '$listaid_rel' ";
  }

  if ($cuenta!="" ){
    
      $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
        listacuenta_activo, listacuenta_nombre, listacuenta_nombredos, usuarioservicio_id",
            "lista 
                inner join listacuentarel on listacuentarel.lista_id = lista.lista_id and listacuentarel.cuenta_id ='$cuenta' 
                and listacuentarel.compania_id = '$compania' and listacuentarel.tipolista_id = '$tipolista_id' 
                and listacuentarel_activo = '1'

                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 

                left join usuarioservicio on usuarioservicio.l_subcategservicio_id = lista.lista_id and usuarioservicio.usuario_id = '$_COOKIE[iniuser]'  and usuarioservicio_activo = '1'
            ",
            "lista_activo = '1' and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "$orderby asc");

      if (count($arrresultado)==0){

         $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
          listacuenta_activo, listacuenta_nombre, listacuenta_nombredos, usuarioservicio_id",
            "lista                 
                left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
                and listacuenta.compania_id = '$compania' 

                left join usuarioservicio on usuarioservicio.l_subcategservicio_id = lista.lista_id and usuarioservicio.usuario_id = '$_COOKIE[iniuser]' and usuarioservicio_activo = '1'
            ",
            "lista_activo = '1' $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "$orderby asc");


      }

    
    foreach($arrresultado as $i=>$valor){

      
      $lista_id = utf8_encode($valor["lista_id"]); 
      $usuarioservicio_id = utf8_encode($valor["usuarioservicio_id"]);  
      $lista_nombre = utf8_encode($valor["lista_nombre"]);  
      $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
      $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
      $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
      $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  

      if ($usuarioservicio_id!=""){
        $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
      }else{
        $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
      }
    }
  }
  
  if (count($arrresultado)==0 && $compania==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }else if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN VALORES</option>";
  }


 

  /*
  
  $arrresultado = $conexion->doSelect("lista_id, lista_nombre","lista ",
            "lista_activo = '1' and tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and cuenta_id ='$cuenta' and compania_id = '$compania'))  ", null, "lista_nombre asc");

  $option = "<option value='0'>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

    $lista_id = utf8_encode($valor["lista_id"]);  
    $lista_nombre = utf8_encode($valor["lista_nombre"]);  

    if ($elementoid==$lista_id){
        $option .= "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
    }else{
        $option .= "<option value='$lista_id'>$lista_nombre</option>";
    }
  }

  if (count($arrresultado)==1){
    $option = "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
  }

  */

  return $option;

}


function capturarVideoCodigoYouTube($url=null){  

  $buscar   = 'v=';

  //Capturo posicion inicial donde se consiguio
  $posicioninicial = strpos($url, $buscar);

  if ($posicioninicial === false) { // No esta
      $codigo = "";
   }else{

      $codigo = substr($url,$posicioninicial+2, 11);        
  }

  return $codigo;
}

function urls_amigables($url) {

  $find = array('á', 'é', 'í', 'ó', 'ú', 'ñ');
  $repl = array('a', 'e', 'i', 'o', 'u', 'n');
  $url = str_replace($find, $repl, $url);

  // Tranformamos todo a minusculas

  $url = strtolower($url);

  //Rememplazamos caracteres especiales latinos

  $find = array('á', 'é', 'í', 'ó', 'ú', 'ñ');

  $repl = array('a', 'e', 'i', 'o', 'u', 'n');

  $url = str_replace ($find, $repl, $url);

  // Añadimos los guiones

  $find = array(' ', '&', '\r\n', '\n', '+');
  $url = str_replace ($find, '-', $url);

  // Eliminamos y Reemplazamos otros carácteres especiales

  $find = array('/[^a-z0-9\-<>]/', '/[\-]+/', '/<[^>]*>/');

  $repl = array('', '-', '');

  $url = preg_replace ($find, $repl, $url);

  if (substr($url, 0,1)=="-"){
    $url = substr($url, 1,999999999999);
  }

  $ultimoCaracter = substr($url, -1);
  if($ultimoCaracter=="-"){
    $longitudactual = strlen($url);
    $url = substr($url, 0,$longitudactual-1);
  }

  $url = substr($url, 0, 50);

  return $url;
 
}




function VerificarUsuarioEstatus($usuario_id=null){

  $conexion = new ConexionBd();  

  $arrresultado = $conexion->doSelect("usuario.l_tipousuarioserv_id, usuario_id, usuario_emailverif",
      "usuario",
      "usuario.usuario_id = '$usuario_id'");

  foreach($arrresultado as $i=>$valor){
      $usuario_id = utf8_encode($valor["usuario_id"]);
      $l_tipousuarioserv_id = utf8_encode($valor["l_tipousuarioserv_id"]);
      $usuario_emailverif = utf8_encode($valor["usuario_emailverif"]);
    }

    $arrresultado = $conexion->doSelect("
        requisito.requisito_id, requisito.l_requisitolista_id, requisito_descrip, requisito.l_tipoarchivo_id, requisito_arch, 
        requisito_archnombre, requisito_cantarchivos, requisito.cuenta_id, requisito.compania_id,
        requisito_activo, requisito_eliminado, requisito_fechareg, 
        requisito.usuario_idreg, requisito.l_estatus_id, requisito.usuario_id,
        usuario.usuario_id, usuario.usuario_codigo, usuario.usuario_email, usuario.usuario_nombre, usuario.usuario_apellido, 
        usuario.usuario_telf, usuario.usuario_activo, usuario.usuario_eliminado, 
        usuario.usuario_documento, usuario.usuario_img, usuario.perfil_id, 

        cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
        cuenta.usuario_apellido as cuenta_apellido, compania_nombre, 
        listarequisito.lista_id as requisitolista_id,
        listarequisito.lista_nombre as requisitolista_nombre,
        estatus.lista_nombre as estatus_nombre,
        tipoarchivo.lista_nombre as tipoarchivo_nombre,
        tipoarchivo.lista_img as tipoarchivo_img

        ",
        "lista listarequisito
            inner join listarequisitotipousuarioserv on listarequisitotipousuarioserv.l_requisitolista_id = listarequisito.lista_id
            left join requisito on requisito.l_requisitolista_id = listarequisito.lista_id and requisito.usuario_id = '$usuario_id'  and requisito_activo = '1'
            left join lista tipoarchivo on tipoarchivo.lista_id = requisito.l_tipoarchivo_id
            left join lista estatus on estatus.lista_id = requisito.l_estatus_id
            left join usuario on usuario.usuario_id = requisito.usuario_id
            left join usuario cuenta on cuenta.usuario_id = requisito.cuenta_id
            left join compania on compania.compania_id = requisito.compania_id

        ",
        "listarequisito.lista_activo = '1' and listarequisitotipousuarioserv.l_tipousuarioserv_id = '$l_tipousuarioserv_id' and listarequisito.tipolista_id  ='49'  ");

    $requisitoenrevision = 0;
    $requisitorechazado = 0;
    $requisitoconfirmado = 0;
    $requisitopendiente = 0;


    foreach($arrresultado as $i=>$valor){
        $requisito_id = utf8_encode($valor["requisito_id"]);
        $l_estatus_id = utf8_encode($valor["l_estatus_id"]);

        if ($l_estatus_id==""){
          $requisitopendiente = 1;
        }

        if ($l_estatus_id==165){
          $requisitoconfirmado = 1;
        } 
        if ($l_estatus_id==166){
          $requisitorechazado = 1;
        } 

        if ($l_estatus_id==167){
          $requisitoenrevision = 1;
        } 

    }

    $estatuscolocar= 189;

    if ($requisitopendiente == 1 ){
      $estatuscolocar= 190;
    } else if ($requisitorechazado == 1 ){
      $estatuscolocar= 190;
    } else if ($requisitoenrevision == 1 ){
      $estatuscolocar= 191;
    } else if ($requisitoconfirmado == 1 ){
      $estatuscolocar= 189;
    }

    $resultado = $conexion->doUpdate("usuario", "
      l_estatus_id = '$estatuscolocar'
      ", "usuario_id='$usuario_id'"); 


}

function verificarExtensionArchivoExcel($extension=null){

  $extension = trim(strtolower($extension));

  if ($extension=="xlsx" || $extension=="xls" ){
    return 1;
  }

  return 0;

}


function verificarExtensionArchivoImagen($extension=null){

  $extension = strtolower($extension);

  if ($extension=="jpg" || $extension=="jpeg" || $extension=="png" || $extension=="bmp" || $extension=="gif"  || $extension=="webp"  || $extension=="svg"){
    return 1;
  }
  
  return 0;

}

// function ObtenerUsuarioPerfilDefecto($perfil=null, $cuentaseleccionada=null, $companiaseleccionada=null){

//   $fechaactual = formatoFechaHoraBd(1);    

//   $conexion = new ConexionBd();

//   $arrresultado = $conexion->doSelect("tipolista.tipolista_id, tipolista_nombre, tipolista_descrip, 
//     tipodato_id, listaconfig_valoruno, listaconfig_valordos, listaconfig_valortres, listaconfig_activo,
//     tipolista_idlistarel, tipolista_multiple
//   ",
//     "
//     tipolista
//       inner join listaconfig on tipolista.tipolista_id = listaconfig.tipolista_id and listaconfig_activo = '1' 
//                 and listaconfig.cuenta_id = '$cuentaseleccionada' and listaconfig.compania_id = '$companiaseleccionada'
//     ",
//     "tipolista_activo = '1' and tipolista.tipolista_config = '1' and listaconfig.tipolista_id = '35' ");

//   foreach($arrresultado as $i=>$valor){
//           $tipolista_id = utf8_encode($valor["tipolista_id"]);
//     $tipolista_nombre = utf8_encode($valor["tipolista_nombre"]);
//     $tipolista_descrip = utf8_encode($valor["tipolista_descrip"]);  
//     $t_tipodato_id = utf8_encode($valor["tipodato_id"]);
//     $lista_orden = utf8_encode($valor["lista_orden"]);
//     $lista_activo = utf8_encode($valor["lista_activo"]);
//     $listaconfig_valoruno = utf8_encode($valor["listaconfig_valoruno"]);
//   }

//   if ($listaconfig_valoruno=="1"){

//     $arrresultado = $conexion->doSelect("usuario_id","usuario",
//       "usuario_activo = '1' and usuario.cuenta_id = '$cuentaseleccionada' and usuario.compania_id = '$companiaseleccionada' and usuario_defecto = '1' and usuario.perfil_id = '$perfil'");

//     foreach($arrresultado as $i=>$valor){
//       $usuario_id = utf8_encode($valor["usuario_id"]);
//     }

//   }

//   return $usuario_id;

// }

function ListadoMensajes($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $getdate=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (chat.chat_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (chat.chat_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (chat.chat_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (chat.chat_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }


  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and chat.cuenta_id = '$_COOKIE[idcuenta]' ";

      //$where .= " and chat.usuario_idpropietario = '$_COOKIE[iniuser]' ";

  } else if ($_COOKIE[perfil]=="85" || $_COOKIE[perfil]=="80"){ // Administrador de Condominio  
      
      //$columnacompania = "<th>Compañia</th>";
      //$where = " and chat.cuenta_id = '$_COOKIE[idcuenta]' ";

      $where .= " and chat.cuenta_id = '$_COOKIE[idcuenta]' and chat.compania_id = '$_COOKIE[idcompania]' and chat.usuario_idpropietario = '$_COOKIE[iniuser]' ";

  } else if ($_COOKIE[perfil]=="82" || $_COOKIE[perfil]=="84"){ // Propietario de Condominio  
      
      //$columnacompania = "<th>Compañia</th>";
      //$where = " and chat.cuenta_id = '$_COOKIE[idcuenta]' ";

      $where .= " and chat.cuenta_id = '$_COOKIE[idcuenta]' and chat.compania_id = '$_COOKIE[idcompania]' and chat.usuario_idcliente = '$_COOKIE[iniuser]' ";

  }   else { 

    $where = " and chat.cuenta_id = '$_COOKIE[idcuenta]' and chat.compania_id = '$_COOKIE[idcompania]' 
    and (chat.usuario_idcliente = '$_COOKIE[iniuser]'  or chat.usuario_idpropietario = '$_COOKIE[iniuser]' )  ";

  } 


  $conexion = new ConexionBd();

  
  $arrresultado = $conexion->doSelect("
      chat.chat_id, chat.chat_titulo, chat.chat_ultmsje, chat.usuario_idorigen, chat.usuario_iddestino, 
      chat.chat_leido, chat.modulo_id, chat.elemento_id, chat.cuenta_id, chat.compania_id, 
      chat.chat_activo, chat.chat_eliminado, chat.usuario_idcliente, chat.usuario_idpropietario, chat.chat_msjes,
      usuarioorigen.usuario_nombre, usuarioorigen.usuario_apellido, usuarioorigen.usuario_img,
      DATE_FORMAT(chat.chat_fechareg,'%d/%m/%Y %H:%i:%s') as chat_fechareg,
      DATE_FORMAT(chat.chat_ultfecha,'%d/%m/%Y %H:%i:%s') as chat_ultfecha,
      modulo_url, modulo_nombreunico,
      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre
      ",
    "chat 
        inner join usuario usuarioorigen on usuarioorigen.usuario_id = chat.usuario_idorigen
        left join modulo on modulo.modulo_id = chat.modulo_id
        inner join usuario cuenta on cuenta.usuario_id = chat.cuenta_id
        inner join compania on compania.compania_id = chat.compania_id 

    ",
    "chat.chat_eliminado = '0' $where $wherefecha ", null, "chat.chat_ultfecha desc");
  foreach($arrresultado as $i=>$valor){

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $chat_id = utf8_encode($valor["chat_id"]);
    $chat_titulo = utf8_encode($valor["chat_titulo"]);
    $chat_activo = utf8_encode($valor["chat_activo"]);
    $chat_ultmsje = utf8_encode($valor["chat_ultmsje"]);
    $usuario_idorigen = utf8_encode($valor["usuario_idorigen"]);
    $usuario_iddestino = utf8_encode($valor["usuario_iddestino"]);
    $chat_leido = utf8_encode($valor["chat_leido"]);
    $t_modulo_id = utf8_encode($valor["modulo_id"]);
    $elemento_id = utf8_encode($valor["elemento_id"]);
    $usuario_idcliente = utf8_encode($valor["usuario_idcliente"]);
    $usuario_idpropietario = utf8_encode($valor["usuario_idpropietario"]);
    $chat_msjes = utf8_encode($valor["chat_msjes"]);
    $chat_fechareg = utf8_encode($valor["chat_fechareg"]);
    $chat_ultfecha = utf8_encode($valor["chat_ultfecha"]);
    $modulo_url = utf8_encode($valor["modulo_url"]);
    $modulo_nombreunico = utf8_encode($valor["modulo_nombreunico"]);    

    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_img = utf8_encode($valor["usuario_img"]);
    $usuario = $usuario_nombre." ".$usuario_apellido;

  
    if ($chat_activo=="0"){
      $activo = "<i onclick='cambiarestatuschat(\"".$chat_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatuschat(\"".$chat_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarchat(\"".$chat_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
         

    //$moduloidchat = "88";
    $mensajes = "<a href='mensajedetalle?mid=$t_modulo_id&id=$elemento_id&chid=$chat_id'><i title='Enviar Mensaje' class='fa fa-envelope btn-mensajes'></i></a>";


    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    } 

    $titulo = "";  

    if ($modulo_url =="" ){
      $modulo_url="mensajedetalle?mid=$t_modulo_id&id=$elemento_id&chid=$chat_id";
    } 

    if ($modulo_url !="" ){
      $titulo = "
      <a href='$modulo_url'>
        $chat_titulo
      </a>
      ";
    }

    $textohtml .= "
           <tr>               
              $mostrarcolumnacuenta
              $mostrarcolumnacompania
              <td>$titulo</td>
              <td>$usuario</td>            
              <td>$chat_ultmsje</td>            
              <td>$chat_ultfecha</td>  
              <td style='text-align: center'>$mensajes &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}

function ObtenerInfoIdElementoModulo($modulo_id=null, $idelemento=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (foro_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
    $titulo = "Ventas del Día";
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (foro_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (foro_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (foro_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }
 
  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and foro.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and foro.cuenta_id = '$_COOKIE[idcuenta]' and foro.compania_id = '$_COOKIE[idcompania]' and foro_activo = '1' ";

  } 

  $conexion = new ConexionBd();

  if ($modulo_id=="88"){

    $arrresultado = $conexion->doSelect("transaccion.trans_id, CONCAT('Presupuesto', ' #' , trans_codigo) as titulo,
      transaccion.cliente_id, usuario_nombre, usuario_apellido, usuario_img, usuario_whatsapp,
      DATE_FORMAT(trans_fechareg,'%d/%m/%Y %H:%i:%s') as fecha
      ",
      "transaccion        
          inner join compania on transaccion.compania_id = compania.compania_id
          inner join usuario on transaccion.cliente_id = usuario.usuario_id         
      ",
      "trans_eliminado = '0' and transaccion.l_tipotrans_id = '90' and transaccion.trans_id = '$idelemento'");

  } else if ($modulo_id=="51"){

    $arrresultado = $conexion->doSelect("transaccion.trans_id, CONCAT('Venta', ' #' , trans_codigo) as titulo,
      transaccion.cliente_id, usuario_nombre, usuario_apellido, usuario_img, usuario_whatsapp,
      DATE_FORMAT(trans_fechareg,'%d/%m/%Y %H:%i:%s') as fecha
      ",
      "transaccion        
          inner join compania on transaccion.compania_id = compania.compania_id
          inner join usuario on transaccion.cliente_id = usuario.usuario_id         
      ",
      "trans_eliminado = '0' and transaccion.l_tipotrans_id = '15' and transaccion.trans_id = '$idelemento'");

  } else if ($modulo_id=="132"){

    $arrresultado = $conexion->doSelect("transaccion.trans_id, CONCAT('Compra', ' #' , trans_codigo) as titulo,
      transaccion.cliente_id, usuario_nombre, usuario_apellido, usuario_img, usuario_whatsapp,
      DATE_FORMAT(trans_fechareg,'%d/%m/%Y %H:%i:%s') as fecha
      ",
      "transaccion        
          inner join compania on transaccion.compania_id = compania.compania_id
          inner join usuario on transaccion.cliente_id = usuario.usuario_id         
      ",
      "trans_eliminado = '0' and transaccion.l_tipotrans_id = '16' and transaccion.trans_id = '$idelemento'");

  } else if ($modulo_id=="95"){

    $arrresultado = $conexion->doSelect("ticket_id, CONCAT('Ticket', ' #' , ticket_codigo) as titulo,
      usuario_nombre, usuario_apellido, usuario_img, usuario_whatsapp,
      DATE_FORMAT(ticket_fechareg,'%d/%m/%Y %H:%i:%s') as fecha
      ",
      "ticket                  
          inner join compania on ticket.compania_id = compania.compania_id
          inner join usuario on ticket.usuario_id = usuario.usuario_id         
      ",
      "ticket_eliminado = '0' and ticket.ticket_id = '$idelemento'");
  }  else if ($modulo_id=="82"){

    $arrresultado = $conexion->doSelect("tareausuario_id, CONCAT('Tarea', ' #' , tareausuario_codigo, ':', tarea_nombre) as titulo,
      usuario_nombre, usuario_apellido, usuario_img, usuario_whatsapp,
      DATE_FORMAT(tareausuario_fecha,'%d/%m/%Y %H:%i:%s') as fecha
      ",
      "tareausuario        
          inner join tarea on tareausuario.tarea_id = tarea.tarea_id
          inner join compania on tareausuario.compania_id = compania.compania_id
          inner join usuario on tareausuario.usuario_id = usuario.usuario_id         
      ",
      "tareausuario_eliminado = '0' and tareausuario.tareausuario_id = '$idelemento'");

  } else if ($modulo_id=="658"){

    $arrresultado = $conexion->doSelect("usuario_id, CONCAT(usuario_nombre, ' ' , usuario_apellido) as titulo,
      usuario_nombre, usuario_apellido, usuario_img, usuario_whatsapp      
      ",
      "usuario         
      ",
      "usuario_eliminado = '0' and usuario_id = '$idelemento'");
  }

  return $arrresultado;

}

function ResumenForos($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $getdate=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (foro_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
    $titulo = "Ventas del Día";
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (foro_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (foro_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (foro_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }
 
  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and foro.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and foro.cuenta_id = '$_COOKIE[idcuenta]' and foro.compania_id = '$_COOKIE[idcompania]' and foro_activo = '1' ";

  } 

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("count(foro.foro_id) as total",
     "foro
      inner join usuario cuenta on cuenta.usuario_id = foro.cuenta_id
        inner join compania on compania.compania_id = foro.compania_id
    ",
    "foro_eliminado = '0' $where", null, "foro_id  asc");

    $total = 0; 
    foreach($arrresultado as $i=>$valor){    
      $total = utf8_encode($valor["total"]);    
    }

  $url ="foro?date=$getdate"; 

  $resumenforos  .="
        <div class='col-lg-3 col-sm-6 col-xs-12'>      
          <div class='small-box div_accesodirecto' style='background: #0c7a0c'>
            <div class='inner'>
              <a href='$url'><h3>$total</h3></a>
              <a href='$url'><p>Foros</p></a>
            </div>
            <div class='icon'>
              <a href='$url'>
                <i class='fa fa-tasks'></i>
              </a>
            </div>
            <a href='$url' class='small-box-footer'>Ver &nbsp <i class='fa fa-arrow-circle-right'></i></a>
          </div>
        </div>
      ";    

  return $resumenforos;

}


function ListadoForos($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $getdate=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (foro_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
    $titulo = "Ventas del Día";
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (foro_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (foro_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (foro_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and foro.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and foro.cuenta_id = '$_COOKIE[idcuenta]' and foro.compania_id = '$_COOKIE[idcompania]' and foro_activo = '1' ";

  } 
  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("foro.foro_id, foro.foro_nombre, foro.foro_descrip, 
  foro.foro_img, foro.l_estatus_id, foro.foro_usuarios, 
  foro.usuario_id, foro.cuenta_id, foro.compania_id, foro.foro_activo, foro.foro_eliminado,
  cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
     cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
     DATE_FORMAT(foro.foro_fechareg,'%d/%m/%Y %H:%i:%s') as foro_fechareg
        ",
    "foro
      inner join usuario cuenta on cuenta.usuario_id = foro.cuenta_id
        inner join compania on compania.compania_id = foro.compania_id
    ",
    "foro_eliminado = '0' $where", null, "foro_id  asc");
  foreach($arrresultado as $i=>$valor){

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $compania_nombre = utf8_encode($valor["compania_nombre"]);
    
    $foro_id = utf8_encode($valor["foro_id"]);
    $foro_nombre = utf8_encode($valor["foro_nombre"]);
    $foro_descrip = utf8_encode($valor["foro_descrip"]);
    $foro_img = utf8_encode($valor["foro_img"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $foro_usuarios = utf8_encode($valor["foro_usuarios"]);
    $t_usuario_id = utf8_encode($valor["usuario_id"]);
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $foro_activo = utf8_encode($valor["foro_activo"]);
    $foro_fechareg = utf8_encode($valor["foro_fechareg"]);    

    if ($foro_activo=="0"){
      $activo = "<i onclick='cambiarestatusforo(\"".$foro_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatusforo(\"".$foro_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminarforo(\"".$foro_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
    $modificar = "<a href='modificarforo?id=$foro_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $categorias = "<a href='forocategoria?id=$foro_id'>Ver Categorias</a>";

    $imagen = "<img src='arch/$foro_img' style='height: 50px;' />";
    

    $mostrarcolumnacuenta = "<td>$cuenta</td>";
    $mostrarcolumnacompania = "<td>$compania_nombre</td>";

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    if ($_COOKIE[perfil]=="1"){      
      
    }
    else if ($_COOKIE[perfil]=="2"){       
      $mostrarcolumnacuenta = "";
    }
    else {      
      $mostrarcolumnacuenta = "";
      $mostrarcolumnacompania = ""; 
    }

    $textohtml .= "
          <tr>
            $mostrarcolumnacuenta
            $mostrarcolumnacompania                 
            <td>$foro_nombre</td>
            <td>$imagen</td>
            <td>$foro_fechareg</td> 
            <td>$categorias</td>                
            <td style='text-align: center'>$modificar &nbsp $activo &nbsp $accioneliminar</td>
            </tr>
        ";

  }

  return $textohtml;

}



// function ListadoInventario($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $getdate=null){

//   $fechaactual = formatoFechaHoraBd(1);    

//   if ($fechadesde=="" && $fechahasta==""){
//     $wherefecha = " and (prod_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
//     $titulo = "Ventas del Día";
//   } else if ($fechadesde!="" && $fechahasta!=""){
//     $wherefecha = " and (prod_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
//   } else if ($fechadesde!=""){
//     $wherefecha = " and (prod_fechareg > '$fechadesde 00:00:00' ) ";  
//   } else if ($fechahasta!=""){
//     $wherefecha = " and (prod_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
//   }

//   if ($ultimosregistros!=""){
//     $limitregistros =" LIMIT $ultimosregistros";
//   }

//   if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
//     $where = "";
//     $columnacuenta = "<th>Cuenta</th>";
//     $columnacompania = "<th>Compañia</th>";

//   } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
//       $columnacompania = "<th>Compañia</th>";
//       $where = " and producto.cuenta_id = '$_COOKIE[idcuenta]' ";

//   }  else { 

//     $where = " and producto.cuenta_id = '$_COOKIE[idcuenta]' and producto.compania_id = '$_COOKIE[idcompania]'  ";

//   } 
//   $conexion = new ConexionBd();

//   $arrresultado = $conexion->doSelect("prod_id, prod_nombre, prod_descrip, prod_stockgeneral, prod_activo, prod_eliminado, prod_fechareg, producto.prod_codigo, prod_costo, 
//     prod_venta, prod_img, producto.cuenta_id, producto.compania_id,
//     producto.l_tipoproducto_id, producto.l_claseproducto_id, producto.l_tipounidad_id,
//     cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
//      cuenta.usuario_apellido as cuenta_apellido, compania_nombre
//     ",
//     "producto           
//       inner join usuario cuenta on cuenta.usuario_id = producto.cuenta_id
//       inner join compania on compania.compania_id = producto.compania_id    
//     ",
//     "prod_eliminado = '0' $where ", null, "prod_id desc");
//   foreach($arrresultado as $i=>$valor){

//     $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
//     $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
//     $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

//     $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

//     $compania_nombre = utf8_encode($valor["compania_nombre"]);

//     $prod_id = utf8_encode($valor["prod_id"]);
//     $prod_nombre = utf8_encode($valor["prod_nombre"]);
//     $prod_descrip = utf8_encode($valor["prod_descrip"]);
//     $prod_stockgeneral = utf8_encode($valor["prod_stockgeneral"]);
//     $prod_activo = utf8_encode($valor["prod_activo"]);
//     $prod_fechareg = utf8_encode($valor["prod_fechareg"]);
//     $t_prod_fechareg = utf8_encode($valor["prod_fechareg"]);
//     $prod_codigo = utf8_encode($valor["prod_codigo"]);
//     $prod_costo = utf8_encode($valor["prod_costo"]);
//     $prod_venta = utf8_encode($valor["prod_venta"]);
//     $t_categ_id = utf8_encode($valor["categ_id"]);
//     $t_proveedor_id = utf8_encode($valor["proveedor_id"]);
//     $t_marca_id = utf8_encode($valor["marca_id"]);
//     $prod_tienda = utf8_encode($valor["prod_tienda"]);
    
//     $proveedor_nombre = utf8_encode($valor["proveedor_nombre"]);
//     $prod_img = utf8_encode($valor["prod_img"]);
      
//     $l_tipoproducto_id = utf8_encode($valor["l_tipoproducto_id"]);
//     $l_claseproducto_id = utf8_encode($valor["l_claseproducto_id"]);
//     $l_tipounidad_id = utf8_encode($valor["l_tipounidad_id"]);
      
//     $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
//     $t_compania_id = utf8_encode($valor["compania_id"]);
      
//     $verproductosucursal = "<a href='inventarioproducto?id=$prod_id'>Por Sucursales</a>";
    
//     if (P_Mod!="1"){$modificar = ""; $activo = "";}
//     if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

//     $mostrarcolumnacuenta = "<td>$cuenta</td>";
//     $mostrarcolumnacompania = "<td>$compania_nombre</td>";

//     if ($_COOKIE[perfil]=="1"){      
      
//     }
//     else if ($_COOKIE[perfil]=="2"){       
//       $mostrarcolumnacuenta = "";
//     }
//     else {      
//       $mostrarcolumnacuenta = "";
//       $mostrarcolumnacompania = ""; 
//     }
    

//     $textohtml .= "
//            <tr>
//               $mostrarcolumnacuenta
//               $mostrarcolumnacompania                 
//               <td>$prod_nombre</td>
//               <td>$prod_stockgeneral</td>                                
//               <td>$verproductosucursal</td>     
                  
//             </tr>
//         ";

//   }

//   return $textohtml;

// }

// function ListadoTareasAsignadas($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null){

//   $fechaactual = formatoFechaHoraBd(1);    

//   if ($fechadesde=="" && $fechahasta==""){
//     $wherefecha = " and (tarea_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
//     $titulo = "Ventas del Día";
//   } else if ($fechadesde!="" && $fechahasta!=""){
//     $wherefecha = " and (tarea_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
//   } else if ($fechadesde!=""){
//     $wherefecha = " and (tarea_fechareg > '$fechadesde 00:00:00' ) ";  
//   } else if ($fechahasta!=""){
//     $wherefecha = " and (tarea_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
//   }

//   if ($estatusseleccionado!=""){
//     $whereestatus =" and tareausuario.l_estatus_id = '$estatusseleccionado' ";
//   }

//   if ($ultimosregistros!=""){
//     $limitregistros =" LIMIT $ultimosregistros";
//   }

//   if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
//     $where = "";
//     $columnacuenta = "<th>Cuenta</th>";
//     $columnacompania = "<th>Compañia</th>";

//   } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
//       $columnacompania = "<th>Compañia</th>";
//       $where = " and tareausuario.cuenta_id = '$_COOKIE[idcuenta]' ";

//   }  else { 

//     $where = " and tareausuario.cuenta_id = '$_COOKIE[idcuenta]' and tareausuario.compania_id = '$_COOKIE[icompania]' and tareausuario_activo = '1' ";

//   } 

//   $conexion = new ConexionBd();

//   $arrresultado = $conexion->doSelect("tarea.tarea_id, tarea_nombre, tarea_descrip, tarea_img, tarea_activo, 
//     tarea_eliminado, tarea_fechareg, tareausuario.cuenta_id,  tareausuario.compania_id,
//     cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
//     cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
//     tareausuario.usuario_id as empleado_id, 
//     tareausuario_observ, tareausuario.l_estatus_id, tareausuario_notificada, tareausuario_orden,
//     DATE_FORMAT(tareausuario_fecha,'%d/%m/%Y') as fecha,
//     DATE_FORMAT(tareausuario_fecha,'%H:%i') as hora, 
//     DATE_FORMAT(tareausuario_fecha,'%d/%m/%Y %H:%i') as tareausuario_fecha, 
//     tareausuario_id, tareausuario_cantidad, tareausuario_cantrealiz,
//     tareausuario_activo, tareausuario_eliminado,    
//     empleado.usuario_codigo as empleado_codigo, 
//     empleado.usuario_nombre as empleado_nombre,
//     empleado.usuario_apellido as empleado_apellido, 

//     estatus.lista_nombre as estatus_nombre,
//     progreso.lista_nombre as progreso_nombre
//     ",
//     "tarea
//       inner join tareausuario on tareausuario.tarea_id = tarea.tarea_id
//       inner join lista estatus on estatus.lista_id = tareausuario.l_estatus_id
//       inner join usuario empleado on empleado.usuario_id = tareausuario.usuario_id
//       inner join usuario cuenta on cuenta.usuario_id = tareausuario.cuenta_id
//       inner join compania on compania.compania_id = tareausuario.compania_id
//       left join lista progreso on progreso.lista_id = tareausuario.l_progreso_id
//     ",
//     "tarea_eliminado = '0' and tareausuario_activo = '1'  $where $wherefecha $whereestatus ");
//   foreach($arrresultado as $i=>$valor){

//     $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
//     $progreso_nombre = utf8_encode($valor["progreso_nombre"]);

//     $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
//     $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
//     $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

//     $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

//     $empleado_nombre = utf8_encode($valor["empleado_nombre"]);
//     $empleado_apellido = utf8_encode($valor["empleado_apellido"]);
//     $empleado_codigo = utf8_encode($valor["empleado_codigo"]);

//     $empleado = $empleado_nombre." ".$empleado_apellido." ";

//     $compania_nombre = utf8_encode($valor["compania_nombre"]);
    
//     $tarea_id = utf8_encode($valor["tarea_id"]);
//     $tarea_nombre = utf8_encode($valor["tarea_nombre"]);
//     $tarea_descrip = utf8_encode($valor["tarea_descrip"]);
//     $tarea_img = utf8_encode($valor["tarea_img"]);
//     $tarea_activo = utf8_encode($valor["tarea_activo"]);
//     $tarea_fechareg = utf8_encode($valor["tarea_fechareg"]);

//     $tareausuario_cantidad = utf8_encode($valor["tareausuario_cantidad"]);
//     $tareausuario_cantrealiz = utf8_encode($valor["tareausuario_cantrealiz"]);
//     $tareausuario_id = utf8_encode($valor["tareausuario_id"]);
//     $tareausuario_fecha = utf8_encode($valor["tareausuario_fecha"]);
//     $empleado_id = utf8_encode($valor["empleado_id"]);
//     $tareausuario_observ = utf8_encode($valor["tareausuario_observ"]);
//     $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
//     $tareausuario_notificada = utf8_encode($valor["tareausuario_notificada"]);
//     $tareausuario_orden = utf8_encode($valor["tareausuario_orden"]);
//     $tareausuario_activo = utf8_encode($valor["tareausuario_activo"]);
//     $tareausuario_eliminado = utf8_encode($valor["tareausuario_eliminado"]);

//     $fecha = utf8_encode($valor["fecha"]);
//     $hora = utf8_encode($valor["hora"]);

//     $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
//     $t_compania_id = utf8_encode($valor["compania_id"]);
    
    

//     $realizartarea = "<a href='realizartarea?id=$tareausuario_id'><i title='Realizar Tarea' class='fa fa-play btn-realizar-tarea'></i></a>";
    

//     if ($tareausuario_activo=="0"){
//       $activo = "<i onclick='cambiarestatustareausuario(\"".$tareausuario_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
//     }else{
//       $activo = "<i onclick='cambiarestatustareausuario(\"".$tareausuario_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
//     }
    
//     $accioneliminar = "<i onclick='eliminartareausuario(\"".$tareausuario_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
//     $modificar = "<a href='asignartarea?id=$tareausuario_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

//     $cantidadrealizadas = " ($tareausuario_cantrealiz / $tareausuario_cantidad)";

//     $vertarea = "<a href='vertareausuario?id=$tareausuario_id'>$tarea_nombre </a> ";

//     $verrealizadas = "<a href='tareasrealizadas?id=$tareausuario_id'>Ver Actividad $cantidadrealizadas</a> ";

//     $moduloidchat = "82";
//     $mensajes = "<a href='mensajedetalle?mid=$moduloidchat&id=$tareausuario_id&cu=$t_cuenta_id&co=$t_compania_id'><i title='Enviar Mensaje' class='fa fa-envelope btn-mensajes'></i></a>";

//     if (P_Mod!="1"){$modificar = ""; $activo = "";}
//     if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

//     $mostrarcolumnacuenta = "<td>$cuenta</td>";
//     $mostrarcolumnacompania = "<td>$compania_nombre</td>";

//     if ($_COOKIE[perfil]=="1"){      
      
//     }
//     else if ($_COOKIE[perfil]=="2"){       
//       $mostrarcolumnacuenta = "";
//     }
//     else {      
//       $mostrarcolumnacuenta = "";
//       $mostrarcolumnacompania = ""; 
//     }


//     $textohtml .= "
//            <tr>
//             $mostrarcolumnacuenta
//             $mostrarcolumnacompania                 
//             <td>$empleado</td>
//             <td>$vertarea</td>
//             <td>$estatus_nombre ($progreso_nombre %)</td>                                        
//             <td>$tareausuario_fecha</td>
//             <td>$verrealizadas</td>                                        
                                                                                                                        
//             <td style='text-align: center'>$mensajes &nbsp $realizartarea &nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
//             </tr>
//         ";

//   }

//   return $textohtml;

// }



// function ListadoTareas($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null){

//   $fechaactual = formatoFechaHoraBd(1);    

//   if ($fechadesde=="" && $fechahasta==""){
//     $wherefecha = " and (tarea_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
//     $titulo = "Ventas del Día";
//   } else if ($fechadesde!="" && $fechahasta!=""){
//     $wherefecha = " and (tarea_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
//   } else if ($fechadesde!=""){
//     $wherefecha = " and (tarea_fechareg > '$fechadesde 00:00:00' ) ";  
//   } else if ($fechahasta!=""){
//     $wherefecha = " and (tarea_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
//   }

//   if ($estatusseleccionado!=""){
//     $whereestatus =" and tarea.l_estatus_id = '$estatusseleccionado' ";
//   }

//   if ($ultimosregistros!=""){
//     $limitregistros =" LIMIT $ultimosregistros";
//   }


//   if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
//     $where = "";
//     $columnacuenta = "<th>Cuenta</th>";
//     $columnacompania = "<th>Compañia</th>";

//   } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
//       $columnacompania = "<th>Compañia</th>";
//       $where = " and tarea.cuenta_id = '$_COOKIE[idcuenta]' ";

//   }  else { 

//     $where = " and tarea.cuenta_id = '$_COOKIE[idcuenta]' and tarea.compania_id = '$_COOKIE[idcompania]' and tarea_activo = '1' ";

//   } 

//   $conexion = new ConexionBd();

  
//   $arrresultado = $conexion->doSelect("tarea_id, tarea_nombre, tarea_descrip, tarea_img, tarea_activo, 
//   tarea_eliminado, tarea.cuenta_id, 
//   cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
//      cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
//      DATE_FORMAT(tarea_fechareg,'%d/%m/%Y %H:%i:%s') as tarea_fechareg
//         ",
//     "tarea
//       inner join usuario cuenta on cuenta.usuario_id = tarea.cuenta_id
//         inner join compania on compania.compania_id = tarea.compania_id
//     ",
//     "tarea_eliminado = '0' $where $wherefecha $whereestatus", null, "tarea_id  desc");
//   foreach($arrresultado as $i=>$valor){

//     $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
//     $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
//     $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

//     $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

//     $compania_nombre = utf8_encode($valor["compania_nombre"]);
    
//     $tarea_id = utf8_encode($valor["tarea_id"]);
//     $tarea_nombre = utf8_encode($valor["tarea_nombre"]);
//     $tarea_descrip = utf8_encode($valor["tarea_descrip"]);
//     $tarea_img = utf8_encode($valor["tarea_img"]);
//     $tarea_activo = utf8_encode($valor["tarea_activo"]);
//     $tarea_fechareg = utf8_encode($valor["tarea_fechareg"]);
    

//     if ($tarea_activo=="0"){
//       $activo = "<i onclick='cambiarestatustarea(\"".$tarea_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
//     }else{
//       $activo = "<i onclick='cambiarestatustarea(\"".$tarea_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
//     }
    
//     $accioneliminar = "<i onclick='eliminartarea(\"".$tarea_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
//     $modificar = "<a href='modificartarea?id=$tarea_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

//     $configurartarea = "<a href='tareaconfiguracion?id=$tarea_id'><i title='Configurar Tarea' class='fa fa-gears btn-configurar'></i></a>";

//     $asignar = "<a href='asignartarea?tid=$tarea_id'>Asignar Tarea</a>";

//     $vertarea = "<a href='vertarea?id=$tarea_id'>$tarea_nombre (Ver)</a>";


//     if (P_Mod!="1"){$modificar = ""; $activo = ""; $configurartarea="";}
//     if (P_Eli!="1"){$accioneliminar = ""; $activo = ""; $configurartarea = "";}

//     $mostrarcolumnacuenta = "<td>$cuenta</td>";
//     $mostrarcolumnacompania = "<td>$compania_nombre</td>";

//     if ($_COOKIE[perfil]=="1"){      
      
//     }
//     else if ($_COOKIE[perfil]=="2"){       
//       $mostrarcolumnacuenta = "";
//     }
//     else {      
//       $mostrarcolumnacuenta = "";
//       $mostrarcolumnacompania = ""; 
//     }

//     $textohtml .= "
//            <tr>
//               $mostrarcolumnacuenta
//               $mostrarcolumnacompania                 
//                   <td>$vertarea</td>    
//               <td>$asignar</td>   
//               <td>$tarea_fechareg</td>   
//                   <td style='text-align: center'>$configurartarea &nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
//               </tr>
//         ";

//   }

//   return $textohtml;

// }


function ResumenPresupuestosPorEstatus($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $estatus=null, $getdate=null){

  $conexion = new ConexionBd();    

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
    $titulo = "Ventas del Día";
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (trans_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }
  

  session_start();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema  
    //$where = " and transaccion.cuenta_id = '$cuentaseleccionada' and transaccion.compania_id = '$companiaseleccionada' ";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta        
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";
  } else { 
    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' and trans_activo = '1'  ";
  } 

  $totalcantidad = 0;


    
    $arrresultado = $conexion->doSelect("count(transaccion.trans_id) as total, estatus.lista_nombre as estatus_nombre",
    "
   lista estatus
      left join transaccion on transaccion.l_estatus_id = estatus.lista_id
      left join transaccionventa on transaccionventa.trans_id = transaccion.trans_id
      left join usuario on transaccion.cliente_id = usuario.usuario_id
      left join usuario cuenta on cuenta.usuario_id = transaccion.cuenta_id
      left join compania on compania.compania_id = transaccion.compania_id     
      left join lista moneda on moneda.lista_id = transaccion.l_moneda_id           
  ",
    "trans_eliminado = '0' and transaccion.l_tipotrans_id = '90' and transaccion.l_estatus_id = '$estatus' $where $wherefecha ", "estatus_nombre", "estatus_nombre asc");
    foreach($arrresultado as $i=>$valor){
        $totalcantidad = utf8_encode($valor["total"]);   
        $estatus_nombre = utf8_encode($valor["estatus_nombre"]);   
    }


     $arrresultado = $conexion->doSelect("sum(trans_montototal) as suma, moneda.lista_nombredos as moneda_siglas",
    "
   lista estatus
      left join transaccion on transaccion.l_estatus_id = estatus.lista_id
      left join transaccionventa on transaccionventa.trans_id = transaccion.trans_id
      left join usuario on transaccion.cliente_id = usuario.usuario_id
      left join usuario cuenta on cuenta.usuario_id = transaccion.cuenta_id
      left join compania on compania.compania_id = transaccion.compania_id     
      left join lista moneda on moneda.lista_id = transaccion.l_moneda_id           
  ",
    "trans_eliminado = '0' and transaccion.l_tipotrans_id = '90' and transaccion.l_estatus_id = '$estatus' $where $wherefecha ", "moneda_siglas", "moneda_siglas asc");

    $divTotal ="";
    foreach($arrresultado as $i=>$valor){

        $suma = utf8_encode($valor["suma"]);   
        if ($suma==""){$suma=0;}
        $moneda_siglas = utf8_encode($valor["moneda_siglas"]);   

        $suma = number_format($suma, 2, ',', '.')." ".$moneda_siglas; 

        $divTotal .="<strong>Suma:</strong> $suma <br>";            
    }
    if ($divTotal==""){
      $monedaprincipal = ObtenerMonedaPrincipal($cuentaseleccionada, $companiaseleccionada);

      $divTotal ="<strong>Suma:</strong> 0 $monedaprincipal <br>";                   
    }

    //$fechadesdepasar =     
    $titulo = $estatus_nombre;
    

    $divretorno ="
      <div class='col-md-3 col-sm-6 col-xs-12'>
          <div class='info-box'>
            <a href='presupuesto?date=$getdate&e=$estatus' style='color: inherit'>
              <span class='info-box-icon bg-red'><i class='fa fa-exclamation-triangle'></i></span>

              <div class='info-box-content'>
                <span class='info-box-text'>$titulo</span>
                <span class='info-box-number'><strong>Cantidad:</strong> $totalcantidad</span>
                <span class='info-box-number'>$divTotal</span>
              </div>
            </a>
          </div>          
        </div>
    ";


  return $divretorno;

}




function ListadoPresupuestos($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (trans_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  //echo $wherefecha;
  //exit();

  if ($estatusseleccionado!=""){
    $whereestatus =" and transaccion.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' and trans_activo = '1' ";

  } 

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("transaccion.trans_id, trans_montosub, trans_montoiva, trans_montototal, trans_codigo, 
    trans_observ, trans_fechavenc, transaccion.compania_id, transaccion.l_moneda_id, trans_tipocambio, 
    transaccion.l_formapago_id, transaccion.cliente_id,
    DATE_FORMAT(trans_fechareg,'%d/%m/%Y %H:%i:%s') as trans_fechareg, 
    usuario.usuario_nombre, usuario.usuario_apellido, usuario.usuario_whatsapp,
    trans_activo, transaccion.cuenta_id,
    cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre, 
      estatus.lista_nombre as estatus_nombre, transaccion.l_estatus_id, 
       DATE_FORMAT(trans_fecha,'%d/%m/%Y') as trans_fecha, trans_montoganancia,
       moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas
    ",
    "transaccion          
      inner join usuario on transaccion.cliente_id = usuario.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = transaccion.cuenta_id
      inner join compania on compania.compania_id = transaccion.compania_id 
      inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id   
      inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id    
    ",
    "trans_eliminado = '0' and transaccion.l_tipotrans_id = '90' $where $wherefecha $whereestatus ", null, "transaccion.trans_id asc");
  foreach($arrresultado as $i=>$valor){

    $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
    $moneda_siglas = utf8_encode($valor["moneda_siglas"]);

      $formadepago_nombre = utf8_encode($valor["formadepago_nombre"]);
      $trans_montoganancia = utf8_encode($valor["trans_montoganancia"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

    $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
    $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
    $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

    $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

    $compania_nombre = utf8_encode($valor["compania_nombre"]);

    $trans_id = utf8_encode($valor["trans_id"]);
    $trans_montosub = utf8_encode($valor["trans_montosub"]);      
    $trans_montoiva = utf8_encode($valor["trans_montoiva"]);
    $trans_montototal = utf8_encode($valor["trans_montototal"]);
    $trans_codigo = utf8_encode($valor["trans_codigo"]);
    $trans_observ = utf8_encode($valor["trans_observ"]);
    $trans_fechavenc = utf8_encode($valor["trans_fechavenc"]);
    $t_usuario_id = utf8_encode($valor["usuario_id"]);
    $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
    $t_compania_id = utf8_encode($valor["compania_id"]);
    $t_l_moneda_id = utf8_encode($valor["l_moneda_id"]);
    $trans_tipocambio = utf8_encode($valor["trans_tipocambio"]);
    $t_formapago_id = utf8_encode($valor["formapago_id"]);
    $t_cliente_id = utf8_encode($valor["cliente_id"]);
    $t_l_tipofactura_id = utf8_encode($valor["l_tipofactura_id"]);
    $trans_fechareg = utf8_encode($valor["trans_fechareg"]);
    $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
    $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
    $usuario_whatsapp = utf8_encode($valor["usuario_whatsapp"]);
    $trans_activo = utf8_encode($valor["trans_activo"]);
      $trans_fecha = utf8_encode($valor["trans_fecha"]);

      $colocarnombrecliente ="";
        if ($usuario_nombre!=""){
          $colocarnombrecliente = "$usuario_nombre $usuario_apellido";
        }else if ($usuario_whatsapp!=""){
          $colocarnombrecliente = "+$usuario_whatsapp";
        }

    
    if ($trans_activo=="0"){
      $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
    }else{
      $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
    }
    
    $accioneliminar = "<i onclick='eliminartransaccion(\"".$trans_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
    $modificar = "<a href='registrarpresupuesto?id=$trans_id&cu=$t_cuenta_id&co=$t_compania_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

    $moduloidchat = "88";
    $mensajes = "<a href='mensajedetalle?mid=$moduloidchat&id=$trans_id&cu=$t_cuenta_id&co=$t_compania_id'><i title='Enviar Mensaje' class='fa fa-envelope btn-mensajes'></i></a>";
    

    $verpresupuestopdf = "<a href='presupuestopdf?id=$trans_id&cu=$t_cuenta_id&co=$t_compania_id' target='_blank'>
      <img title='Ver Presupuesto' style='cursor:pointer; height: 24px; width: 20px' src='dist/img/pdf.png'>
    </a>";

    $trans_montosub = number_format_personalizado($trans_montosub, $moneda_siglas);
    $trans_montoiva = number_format_personalizado($trans_montoiva, $moneda_siglas);
    $trans_montototal = number_format_personalizado($trans_montototal, $moneda_siglas);
    $trans_montoganancia = number_format_personalizado($trans_montoganancia, $moneda_siglas);


    $trans_codigo = "
    <a href='verpresupuesto?id=$trans_id'>
      $trans_codigo (Ver Presupuesto)
    </a>";

    if (P_Mod!="1"){$modificar = ""; $activo = "";}
    if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

    $mostrarcolumnacuenta = "<td>$cuenta</td>";   

    if ($_COOKIE[perfil]!="1"){      
      $mostrarcolumnacuenta = "";     
    }   

    $textohtml .= "
           <tr>               
            $mostrarcolumnacuenta
            <td>$compania_nombre</td>
            <td>$colocarnombrecliente</td>
            <td>$trans_codigo</td>
            <td>$estatus_nombre</td>                                    
            <td style='text-align: center'>$trans_montototal</td>                                       
            <td>$trans_fechareg</td>                      
            <td style='text-align: center'>$mensajes_old &nbsp $modificar &nbsp $verpresupuestopdf &nbsp $activo &nbsp $accioneliminar </td>
              </tr>
        ";

  }

  return $textohtml;

}



// function ListadoCompras($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null){

//   $fechaactual = formatoFechaHoraBd(1);    

//   if ($fechadesde=="" && $fechahasta==""){
//     $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
//   } else if ($fechadesde!="" && $fechahasta!=""){
//     $wherefecha = " and (trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
//   } else if ($fechadesde!=""){
//     $wherefecha = " and (trans_fechareg > '$fechadesde 00:00:00' ) ";  
//   } else if ($fechahasta!=""){
//     $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
//   }

//   //echo $wherefecha;
//   //exit();

//   if ($estatusseleccionado!=""){
//     $whereestatus =" and transaccion.l_estatus_id = '$estatusseleccionado' ";
//   }

//   if ($ultimosregistros!=""){
//     $limitregistros =" LIMIT $ultimosregistros";
//   }

//   if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
//     $where = "";
//     $columnacuenta = "<th>Cuenta</th>";
//     $columnacompania = "<th>Compañia</th>";

//   } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
//       $columnacompania = "<th>Compañia</th>";
//       $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";

//   }  else { 

//     $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' and trans_activo = '1' ";

//   } 

//   $conexion = new ConexionBd();

//   $arrresultado = $conexion->doSelect("transaccion.trans_id, trans_montosub, trans_montoiva, trans_montototal, trans_codigo, 
//     trans_observ, trans_fechavenc, transaccion.compania_id, transaccion.l_moneda_id, trans_tipocambio, 
//     transaccion.l_formapago_id, transaccion.cliente_id, 
//     DATE_FORMAT(trans_fechareg,'%d/%m/%Y %H:%i:%s') as trans_fechareg, 
//     trans_activo, transaccion.cuenta_id,
//       cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
//       cuenta.usuario_apellido as cuenta_apellido, compania_nombre, 
//       estatus.lista_nombre as estatus_nombre, transaccion.l_estatus_id, 
//       formadepago.lista_nombre as formadepago_nombre, DATE_FORMAT(trans_fecha,'%d/%m/%Y') as trans_fecha,
//       transaccioncompra.proveedor_id, transaccioncompra.transcompra_fechapago, 
//       transaccioncompra.transcompra_nombrevendedor, transaccioncompra.transcompra_codigo,       
//       proveedor.usuario_empresa as proveedor_empresa,
//       moneda.lista_nombre as moneda_nombre, moneda.lista_nombredos as moneda_siglas
      
//     ",
//     "transaccion    
//           inner join transaccioncompra on transaccioncompra.trans_id = transaccion.trans_id      
//           inner join usuario cuenta on cuenta.usuario_id = transaccion.cuenta_id
//           inner join usuario proveedor on proveedor.usuario_id = transaccioncompra.proveedor_id
//           inner join compania on compania.compania_id = transaccion.compania_id 
//           inner join lista estatus on estatus.lista_id = transaccion.l_estatus_id 
//           left join lista formadepago on formadepago.lista_id = transaccion.l_formapago_id    
//           inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id          
//     ",
//     "trans_eliminado = '0' and transaccion.l_tipotrans_id = '16' $where $wherefecha $whereestatus ", null, "transaccion.trans_id asc");
//   foreach($arrresultado as $i=>$valor){

//     $moneda_nombre = utf8_encode($valor["moneda_nombre"]);
//     $moneda_siglas = utf8_encode($valor["moneda_siglas"]);
  
//     $proveedor_id = utf8_encode($valor["proveedor_id"]);
//     $proveedor_empresa = utf8_encode($valor["proveedor_empresa"]);
//     $transcompra_fechapago = utf8_encode($valor["transcompra_fechapago"]);
//     $transcompra_nombrevendedor = utf8_encode($valor["transcompra_nombrevendedor"]);
//     $transcompra_codigo = utf8_encode($valor["transcompra_codigo"]);
   
//     $formadepago_nombre = utf8_encode($valor["formadepago_nombre"]);
//     $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
//     $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

//     $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
//     $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
//     $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

//     $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

//     $compania_nombre = utf8_encode($valor["compania_nombre"]);

//     $trans_id = utf8_encode($valor["trans_id"]);
//     $trans_montosub = utf8_encode($valor["trans_montosub"]);
//       $transventa_porciva = utf8_encode($valor["transventa_porciva"]);
//     $trans_montoiva = utf8_encode($valor["trans_montoiva"]);
//     $trans_montototal = utf8_encode($valor["trans_montototal"]);
//     $trans_codigo = utf8_encode($valor["trans_codigo"]);
//     $trans_observ = utf8_encode($valor["trans_observ"]);
//     $trans_fechavenc = utf8_encode($valor["trans_fechavenc"]);
//     $t_usuario_id = utf8_encode($valor["usuario_id"]);
//     $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
//     $t_compania_id = utf8_encode($valor["compania_id"]);
//     $t_l_moneda_id = utf8_encode($valor["l_moneda_id"]);
//     $trans_tipocambio = utf8_encode($valor["trans_tipocambio"]);
//     $t_formapago_id = utf8_encode($valor["formapago_id"]);
//     $t_cliente_id = utf8_encode($valor["cliente_id"]);
//     $t_l_tipofactura_id = utf8_encode($valor["l_tipofactura_id"]);
//     $trans_fechareg = utf8_encode($valor["trans_fechareg"]);
//     $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
//     $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
//     $trans_activo = utf8_encode($valor["trans_activo"]);
//     $trans_fecha = utf8_encode($valor["trans_fecha"]);

    
//     if ($trans_activo=="0"){
//       $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
//     }else{
//       $activo = "<i onclick='cambiarestatustransaccion(\"".$trans_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
//     }
    
//     $accioneliminar = "<i onclick='eliminartransaccion(\"".$trans_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
//     $modificar = "<a href='registrarcompra?id=$trans_id&cu=$t_cuenta_id&co=$t_compania_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";
    

//     $verfactursapdf = "<a href='transaccioncomprapdf?id=$trans_id&cu=$t_cuenta_id&co=$t_compania_id' target='_blank'>
//     <img title='Ver Venta' style='cursor:pointer; height: 24px; width: 20px' src='dist/img/pdf.png'>
//     </a>";

//     $moduloidchat = "132";
//     $mensajes = "<a href='mensajedetalle?mid=$moduloidchat&id=$trans_id'><i title='Enviar Mensaje' class='fa fa-envelope btn-mensajes'></i></a>";

//     $trans_montosub = number_format_personalizado($trans_montosub, $moneda_siglas);
//     $trans_montoiva = number_format_personalizado($trans_montoiva, $moneda_siglas);
//     $trans_montototal = number_format_personalizado($trans_montototal, $moneda_siglas);

//     $trans_codigo = "
//     <a href='vertransaccioncompra?id=$trans_id'>
//       $trans_codigo (Ver Compra)
//     </a>";

//     if (P_Mod!="1"){$modificar = ""; $activo = "";}
//     if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

//     $mostrarcolumnacuenta = "<td>$cuenta</td>";
//     $mostrarcolumnacompania = "<td>$compania_nombre</td>";

//     if ($_COOKIE[perfil]=="1"){      
      
//     }
//     else if ($_COOKIE[perfil]=="2"){       
//       $mostrarcolumnacuenta = "";
//     }
//     else if ($_COOKIE[perfil]=="3"){       
//       $mostrarcolumnacuenta = "";
//       $mostrarcolumnacompania = ""; 
//     }
//     else if ($_COOKIE[perfil]=="4"){       
//       $mostrarcolumnacuenta = "";
//       $mostrarcolumnacompania = ""; 
//     }
//     else if ($_COOKIE[perfil]=="5"){       
//       $mostrarcolumnacuenta = "";
//       $mostrarcolumnacompania = ""; 
//     }
//     else {
//       $columnacuenta = "";
//       $mostrarcolumnacuenta = ""; 
//       $mostrarcolumnacompania = ""; 
//     }
    

//     $textohtml .= "
//            <tr>               
//                   $mostrarcolumnacuenta
//                   $mostrarcolumnacompania 
//                   <td>$proveedor_empresa</td>
//                   <td>$trans_codigo</td>

//                   <td>$transcompra_codigo</td>     
//                   <td>$estatus_nombre</td>                                             
//                   <td>$trans_montototal</td>
//                   <td>$trans_fechareg</td>
//                   <td style='text-align: center'>$mensajes &nbsp $modificar &nbsp$verfacturapdf &nbsp $activo &nbsp $accioneliminar </td>
//               </tr>
//         ";

//   }

//   return $textohtml;

// }

function RedireccionNoAcceso(){
  echo "<script language='JavaScript'>window.location = 'noacceso'; </script>";
}



function ResumenSucursales($cuentaseleccionada=null, $companiaseleccionada=null){  

  $fechaactual = formatoFechaHoraBd(1);    

    
  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and sucursal.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and sucursal.cuenta_id = '$_COOKIE[idcuenta]' and sucursal.compania_id = '$_COOKIE[idcompania]'  ";

  } 


  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("count(*) as total
        ",
    "sucursal
      inner join usuario cuenta on cuenta.usuario_id = sucursal.cuenta_id
        inner join compania on compania.compania_id = sucursal.compania_id
    ",
    "sucursal_eliminado = '0' $where");
  $total = 0;
  foreach($arrresultado as $i=>$valor){

    $total = utf8_encode($valor["total"]); 
  }

  $divretorno  .="
    <div class='col-lg-3 col-sm-6 col-xs-12'>      
      <div class='small-box div_accesodirecto' style='background: #188E11'>
        <div class='inner'>
          <a href='sucursal'><h3>$total</h3></a>
          <a href='sucursal'><p>Sucursales</p></a>
        </div>
        <div class='icon'>
          <a href='sucursal'>
            <i class='fa fa-building'></i>
          </a>
        </div>
        <a href='sucursal' class='small-box-footer'>Ver &nbsp <i class='fa fa-arrow-circle-right'></i></a>
      </div>
    </div>
  ";    

 


  return $divretorno;

}



// function ResumenClientes($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $getdate=null){  

//   $fechaactual = formatoFechaHoraBd(1);    

//   if ($fechadesde=="" && $fechahasta==""){
//     $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
//   } else if ($fechadesde!="" && $fechahasta!=""){
//     $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
//   } else if ($fechadesde!=""){
//     $wherefecha = " and (usuarioperfil.usuario_fechareg > '$fechadesde 00:00:00' ) ";  
//   } else if ($fechahasta!=""){
//     $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
//   }


//   if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

//     $where = "";
//     $columnacuenta = "<th>Cuenta</th>";
//     $columnacompania = "<th>Compañia</th>";

//   } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
//       $columnacompania = "<th>Compañia</th>";
//       $where = " and usuarioperfil.cuenta_id = '$_COOKIE[idcuenta]' ";

//   }  else { 

//     $where = " and usuarioperfil.cuenta_id = '$_COOKIE[idcuenta]' and usuarioperfil.compania_id = '$_COOKIE[idcompania]' ";

//   } 

//   if($perfil!=""){
//     $whereperfil= " and usuarioperfil.perfil_id = '$perfil' ";
//   }

  
//     $arrresultado = $conexion->doSelect("count(*) as total, perfil.perfil_nombre, perfil.perfil_color, perfil_icono, perfil_url
//           ",
//         "usuario usuarioperfil
//             inner join usuario cuenta on usuarioperfil.cuenta_id = cuenta.usuario_id
//             inner join compania on compania.compania_id = usuarioperfil.compania_id
//             inner join perfil on usuarioperfil.perfil_id = perfil.perfil_id
//         ",
//         "usuarioperfil.usuario_eliminado = '0' and perfil.perfil_id in (4,5,6,7) $wheree $whereperfill  $wherefecha ", "perfil.perfil_id", "perfil.perfil_id asc");
  

//   $conexion = new ConexionBd();

//   $arrresultado = $conexion->doSelect("count(usuarioperfil.usuario_id) as total, perfil.perfil_nombre, perfil.perfil_color, perfil_icono, perfil_url
//       ",
//     "
//     perfil
//       left join usuario usuarioperfil on usuarioperfil.perfil_id = perfil.perfil_id and usuarioperfil.usuario_eliminado = '0'
//     ",
//     "perfil_activo = '1' and perfil.perfil_id in (4,5,6,7) $where $whereperfillll  $wherefecha ", "perfil.perfil_id", "perfil.perfil_id asc");

//   $divTotal ="";
//   $total = "0";
//   foreach($arrresultado as $i=>$valor){
//     $total = utf8_encode($valor["total"]); 
//     $perfil_id = utf8_encode($valor["perfil_id"]); 
//     $perfil_nombre = utf8_encode($valor["perfil_nombre"]); 
//     $perfil_color = utf8_encode($valor["perfil_color"]); 
//     $perfil_icono = utf8_encode($valor["perfil_icono"]); 
//     $perfil_url = utf8_encode($valor["perfil_url"]); 

//     $perfil_url = str_replace(".php","",$perfil_url);

//      $divretorno  .="
//         <div class='col-lg-3 col-sm-6 col-xs-12'>      
//           <div class='small-box div_accesodirecto' style='background: $perfil_color'>
//             <div class='inner'>
//               <a href='$perfil_url?date=$getdate'><h3>$total</h3></a>
//               <a href='$perfil_url?date=$getdate'><p>$perfil_nombre</p></a>
//             </div>
//             <div class='icon'>
//               <a href='$perfil_url?date=$getdate'>
//                 <i class='fa $perfil_icono'></i>
//               </a>
//             </div>
//             <a href='$perfil_url?date=$getdate' class='small-box-footer'>Ver &nbsp <i class='fa fa-arrow-circle-right'></i></a>
//           </div>
//         </div>
//       ";    
//   }

 


//   return $divretorno;

// }



// function ListadoUsuarios($cuentaseleccionada=null, $companiaseleccionada=null, $perfil=null, $fechadesde =null, $fechahasta=null, $getdate=null){

//   $fechaactual = formatoFechaHoraBd(1);    

//   if ($fechadesde=="" && $fechahasta==""){
//     $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
//   } else if ($fechadesde!="" && $fechahasta!=""){
//     $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
//   } else if ($fechadesde!=""){
//     $wherefecha = " and (usuarioperfil.usuario_fechareg > '$fechadesde 00:00:00' ) ";  
//   } else if ($fechahasta!=""){
//     $wherefecha = " and (usuarioperfil.usuario_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
//   }


//   if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema

//     $where = "";
//     $columnacuenta = "<th>Cuenta</th>";
//     $columnacompania = "<th>Compañia</th>";

//   } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
//       $columnacompania = "<th>Compañia</th>";
//       $where = " and usuarioperfil.cuenta_id = '$_COOKIE[idcuenta]' ";

//   }  else { 

//     $where = " and usuarioperfil.cuenta_id = '$_COOKIE[idcuenta]' and usuarioperfil.compania_id = '$_COOKIE[idcompania]' ";

//   } 

//   if($perfil!=""){
//     $whereperfil= " and usuarioperfil.perfil_id = '$perfil' ";
//   }

//   $conexion = new ConexionBd();

//   $arrresultado = $conexion->doSelect("usuarioperfil.usuario_id, usuarioperfil.usuario_codigo, usuarioperfil.usuario_email, usuarioperfil.usuario_clave, 
//       usuarioperfil.usuario_nombre, usuarioperfil.usuario_apellido, usuarioperfil.usuario_telf,  usuarioperfil.usuario_activo, 
//       usuarioperfil.usuario_eliminado, usuarioperfil.usuario_documento, usuarioperfil.usuario_img, usuarioperfil.perfil_id,
//       usuarioperfil.usuario_direccion, usuarioperfil.usuario_localidad, usuarioperfil.usuario_actividad, usuarioperfil.nacionalidad_id,
//       usuarioperfil.sexo_id, usuarioperfil.e_estadocivil_id, usuarioperfil.usuario_conyugenombre, usuarioperfil.usuario_conyugetelf,
//       usuarioperfil.usuario_pariente, usuarioperfil.usuario_parientetelf, usuarioperfil.e_parentesco_id, usuarioperfil.usuario_telfdos, 
//       usuarioperfil.usuario_notas, usuarioperfil.usuario_porcentajecolocador, usuarioperfil.usuario_balance, usuarioperfil.usuario_comentarios, 
//       DATE_FORMAT(usuarioperfil.usuario_fechanac,'%d/%m/%Y') as usuario_fechanac, usuarioperfil.nivelriesgo_id,
//       usuarioperfil.l_tipodocumento_id,
//       cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
//       cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
//       DATE_FORMAT(usuarioperfil.usuario_fechareg,'%d/%m/%Y %H:%i:%s') as usuario_fechareg,
//       perfil_nombre, 
//       usuarioperfil.l_estatus_id, estatus.lista_nombre as estatus_nombre
//       ",
//     "usuario usuarioperfil
//         inner join usuario cuenta on usuarioperfil.cuenta_id = cuenta.usuario_id
//         inner join compania on compania.compania_id = usuarioperfil.compania_id
//         inner join perfil on usuarioperfil.perfil_id = perfil.perfil_id
//         left join lista estatus on estatus.lista_id = usuarioperfil.l_estatus_id
//     ",
//     "usuarioperfil.usuario_eliminado = '0' and usuarioperfil.usuario_id not in ($_COOKIE[iniuser]) $where $whereperfil  $wherefecha ", null, "usuarioperfil.usuario_id desc");
//   foreach($arrresultado as $i=>$valor){

//     $t_perfil_id = utf8_encode($valor["perfil_id"]);
//     $perfil_nombre = utf8_encode($valor["perfil_nombre"]);

//     $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
//     $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
//     $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);
//     $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

//     $usuario_id = utf8_encode($valor["usuario_id"]);
//     $usuario_codigo = utf8_encode($valor["usuario_codigo"]);
//     $usuario_email = utf8_encode($valor["usuario_email"]);
//     $usuario_clave = utf8_encode($valor["usuario_clave"]);
//     $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
//     $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
//     $usuario_telf = utf8_encode($valor["usuario_telf"]);
//     $usuario_fechareg = utf8_encode($valor["usuario_fechareg"]);
//     $usuario_activo = utf8_encode($valor["usuario_activo"]);
//     $usuario_documento = utf8_encode($valor["usuario_documento"]);  
    
//     $usuario_direccion = utf8_encode($valor["usuario_direccion"]);
//     $usuario_localidad = utf8_encode($valor["usuario_localidad"]);
//     $usuario_actividad = utf8_encode($valor["usuario_actividad"]);
//     $t_nacionalidad_id = utf8_encode($valor["nacionalidad_id"]);
//     $t_sexo_id = utf8_encode($valor["sexo_id"]);
//     $e_estadocivil_id = utf8_encode($valor["e_estadocivil_id"]);  
//     $usuario_conyugenombre = utf8_encode($valor["usuario_conyugenombre"]);
//     $usuario_conyugetelf = utf8_encode($valor["usuario_conyugetelf"]);
//     $usuario_pariente = utf8_encode($valor["usuario_pariente"]);
//     $usuario_parientetelf = utf8_encode($valor["usuario_parientetelf"]);
//     $e_parentesco_id = utf8_encode($valor["e_parentesco_id"]);
//     $usuario_telfdos = utf8_encode($valor["usuario_telfdos"]);
//     $usuario_notas = utf8_encode($valor["usuario_notas"]);
//     $usuario_porcentajecolocador = utf8_encode($valor["usuario_porcentajecolocador"]);
//     $usuario_balance = utf8_encode($valor["usuario_balance"]);
//     $usuario_comentarios = utf8_encode($valor["usuario_comentarios"]);
//     $usuario_tasapref = utf8_encode($valor["usuario_tasapref"]);
//     $usuario_fechanac = utf8_encode($valor["usuario_fechanac"]);
//     $t_nivelriesgo_id = utf8_encode($valor["nivelriesgo_id"]);

//     $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
//     $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
    
    
//       $compania_nombre = utf8_encode($valor["compania_nombre"]);

//     if ($usuario_id!= "1"){
//       if ($usuario_activo=="0"){
//         $activo = "<i onclick='cambiarestatususuario(\"".$usuario_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
//       }else{
//         $activo = "<i onclick='cambiarestatususuario(\"".$usuario_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
//       }
      
//       $accioneliminar = "<i onclick='eliminarusuario(\"".$usuario_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";
//     }

//     $urlmodificar = "";
//     if ($t_perfil_id=="2"){$urlmodificar = "modificarcuenta?id=$usuario_id";}
//     if ($t_perfil_id=="3"){$urlmodificar = "modificaradmincompania?id=$usuario_id";}
//     if ($t_perfil_id=="4"){$urlmodificar = "modificarcliente?id=$usuario_id";}
//     if ($t_perfil_id=="5"){$urlmodificar = "modificarvendedor?id=$usuario_id";}
//     if ($t_perfil_id=="6"){$urlmodificar = "modificarproveedor?id=$usuario_id";}
//     if ($t_perfil_id=="7"){$urlmodificar = "modificarempleado?id=$usuario_id";}
//     if ($t_perfil_id=="8"){$urlmodificar = "modificarcliente?id=$usuario_id";}
//     if ($t_perfil_id=="9"){$urlmodificar = "modificarcliente?id=$usuario_id";}
    
    
//     $modificar = "<a href='$urlmodificar'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

//     if ($urlmodificar==""){$modificar = "";}

//     if (P_Mod!="1"){$modificar = ""; $activo = "";}
//     if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

//     $mostrarcolumnacuenta = "<td>$cuenta</td>";
//     $mostrarcolumnacompania = "<td>$compania_nombre</td>";

//     if ($_COOKIE[perfil]=="1"){      
      
//     }
//     else if ($_COOKIE[perfil]=="2"){       
//       $mostrarcolumnacuenta = "";
//     }
//     else {      
//       $mostrarcolumnacuenta = "";
//       $mostrarcolumnacompania = ""; 
//     }
    
//     $simularusuario = "<img onclick='simularusuario(\"".$usuario_id."\")' title='Simular a Usuario' style='cursor:pointer; height: 25px; width: 29px' src='dist/img/usuario1.png'>";
//     if ($_COOKIE[perfil]!="1"){$simularusuario="";}

//     $textohtml .= "
//            <tr>               
//             $mostrarcolumnacuenta
//             $mostrarcolumnacompania
//             <td>$perfil_nombre</td>
//             <td>$usuario_nombre $usuario_apellido</td>            
//             <td>$usuario_email</td>
//             <td>$estatus_nombre</td>
//             <td>$usuario_fechareg</td>  
//             <td style='text-align: center'>$simularusuario &nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
//               </tr>
//         ";

//   }

//   return $textohtml;

// }

function ConvertirFechaBdFechaHoraNormal($fecha = null){

  $ano = substr($fecha,0,4);
  $mes = substr($fecha,5,2);
  $dia = substr($fecha,8,2);

  $hora = substr($fecha,10,10);
    
  $fecha = $dia."/".$mes."/".$ano." ".$hora;

  return $fecha;
}


function ConvertirFechaBdFechaNormal($fecha = null){

  $ano = substr($fecha,0,4);
  $mes = substr($fecha,5,2);
  $dia = substr($fecha,8,2);
    
  $fecha = $dia."/".$mes."/".$ano;

  return $fecha;
}

function ConvertirFechaNormalFechaBd($fecha = null){

  $dia = substr($fecha,0,2);
  $mes = substr($fecha,3,2);
  $ano = substr($fecha,6,4);
  $fecha = $ano."-".$mes."-".$dia;

  return $fecha;
}


function ResumenVentasGanancia($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $getdate=null){

  $conexion = new ConexionBd();    

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
    $titulo = "Ventas del Día";
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (trans_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }  

  session_start();  

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema  
    //$where = " and transaccion.cuenta_id = '$cuentaseleccionada' and transaccion.compania_id = '$companiaseleccionada' ";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta        
      $columnacompania = "<th>Compañia</th>";
      $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";
  } else { 
    $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' and trans_activo = '1'  ";
  } 

     $arrresultado = $conexion->doSelect("sum(trans_montoganancia) as suma, moneda.lista_nombredos as moneda_siglas",
    "
   lista estatus
      inner join transaccion on transaccion.l_estatus_id = estatus.lista_id
      inner join transaccionventa on transaccionventa.trans_id = transaccion.trans_id
      inner join usuario on transaccion.cliente_id = usuario.usuario_id
      inner join usuario cuenta on cuenta.usuario_id = transaccion.cuenta_id
      inner join compania on compania.compania_id = transaccion.compania_id     
      inner join lista moneda on moneda.lista_id = transaccion.l_moneda_id           
  ",
    "trans_eliminado = '0' and transaccion.l_tipotrans_id = '15' $where $wherefecha ", "moneda_siglas");

    $divTotal ="";
    foreach($arrresultado as $i=>$valor){

        $suma = utf8_encode($valor["suma"]);   
        if ($suma==""){$suma=0;}
        $moneda_siglas = utf8_encode($valor["moneda_siglas"]);   
        $suma = number_format($suma, 2, ',', '.')." ".$moneda_siglas; 

        $divTotal .="<strong>Ganancia:</strong> $suma <br>";            
    }
    if ($divTotal==""){
      $monedaprincipal = ObtenerMonedaPrincipal($cuentaseleccionada, $companiaseleccionada);

      $divTotal ="<strong>Suma:</strong> 0 $monedaprincipal <br>";                       
    }

    //$fechadesdepasar =     
    $titulo = $estatus_nombre;
    

    $divretorno ="
      <div class='col-md-3 col-sm-6 col-xs-12'>
          <div class='info-box'>
            <a href='transaccionventa?date=$getdate' style='color: inherit'>
              <span class='info-box-icon bg-blue'><i class='fa fa-money'></i></span>

              <div class='info-box-content'>
                <span class='info-box-text'>Ganancia: </span>                
                <span class='info-box-number'>$divTotal</span>
              </div>
            </a>
          </div>          
        </div>
    ";


  return $divretorno;

}

// function ResumenVentasPorEstatus($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $estatus=null, $getdate=null){

//   $conexion = new ConexionBd();    

//   $fechaactual = formatoFechaHoraBd(1);    

//   if ($fechadesde=="" && $fechahasta==""){
//     $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
//     $titulo = "Ventas del Día";
//   } else if ($fechadesde!="" && $fechahasta!=""){
//     $wherefecha = " and (trans_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
//   } else if ($fechadesde!=""){
//     $wherefecha = " and (trans_fechareg > '$fechadesde 00:00:00' ) ";  
//   } else if ($fechahasta!=""){
//     $wherefecha = " and (trans_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
//   }
  

//   session_start();  

//   if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema  
//     //$where = " and transaccion.cuenta_id = '$cuentaseleccionada' and transaccion.compania_id = '$companiaseleccionada' ";

//   } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta        
//       $columnacompania = "<th>Compañia</th>";
//       $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' ";
//   } else { 
//     $where = " and transaccion.cuenta_id = '$_COOKIE[idcuenta]' and transaccion.compania_id = '$_COOKIE[idcompania]' and trans_activo = '1'  ";
//   } 

//   $totalcantidad = 0;
    
//     $arrresultado = $conexion->doSelect("count(transaccion.trans_id) as total, estatus.lista_nombre as estatus_nombre",
//     "
//    lista estatus
//       left join transaccion on transaccion.l_estatus_id = estatus.lista_id
//       left join transaccionventa on transaccionventa.trans_id = transaccion.trans_id
//       left join usuario on transaccion.cliente_id = usuario.usuario_id
//       left join usuario cuenta on cuenta.usuario_id = transaccion.cuenta_id
//       left join compania on compania.compania_id = transaccion.compania_id     
//       left join lista moneda on moneda.lista_id = transaccion.l_moneda_id           
//   ",
//     "trans_eliminado = '0' and transaccion.l_tipotrans_id = '15' and transaccion.l_estatus_id = '$estatus' $where $wherefecha ", "estatus_nombre", "estatus_nombre asc");
//     foreach($arrresultado as $i=>$valor){
//         $totalcantidad = utf8_encode($valor["total"]);   
//         $estatus_nombre = utf8_encode($valor["estatus_nombre"]);   
//     }


//      $arrresultado = $conexion->doSelect("sum(trans_montototal) as suma, moneda.lista_nombredos as moneda_siglas",
//     "
//    lista estatus
//       left join transaccion on transaccion.l_estatus_id = estatus.lista_id
//       left join transaccionventa on transaccionventa.trans_id = transaccion.trans_id
//       left join usuario on transaccion.cliente_id = usuario.usuario_id
//       left join usuario cuenta on cuenta.usuario_id = transaccion.cuenta_id
//       left join compania on compania.compania_id = transaccion.compania_id     
//       left join lista moneda on moneda.lista_id = transaccion.l_moneda_id           
//   ",
//     "trans_eliminado = '0' and transaccion.l_tipotrans_id = '15' and transaccion.l_estatus_id = '$estatus' $where $wherefecha ", "moneda_siglas", "moneda_siglas asc");

//     $divTotal ="";
//     foreach($arrresultado as $i=>$valor){

//         $suma = utf8_encode($valor["suma"]);   
//         if ($suma==""){$suma=0;}
//         $moneda_siglas = utf8_encode($valor["moneda_siglas"]);   

//         $suma = number_format($suma, 2, ',', '.')." ".$moneda_siglas; 

//         $divTotal .="<strong>Suma:</strong> $suma <br>";            
//     }
//     if ($divTotal==""){
//       $monedaprincipal = ObtenerMonedaPrincipal($cuentaseleccionada, $companiaseleccionada);

//       $divTotal ="<strong>Suma:</strong> 0 $monedaprincipal <br>";                   
//     }

//     //$fechadesdepasar =     
//     $titulo = $estatus_nombre;
    

//     $divretorno ="
//       <div class='col-md-3 col-sm-6 col-xs-12'>
//           <div class='info-box'>
//             <a href='transaccionventa?date=$getdate&e=$estatus' style='color: inherit'>
//               <span class='info-box-icon bg-red'><i class='fa fa-exclamation-triangle'></i></span>

//               <div class='info-box-content'>
//                 <span class='info-box-text'>$titulo</span>
//                 <span class='info-box-number'><strong>Cantidad:</strong> $totalcantidad</span>
//                 <span class='info-box-number'>$divTotal</span>
//               </div>
//             </a>
//           </div>          
//         </div>
//     ";


//   return $divretorno;

// }




function ListadoVehiculoRevisionDetalle($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null, $vehiculorevision_id=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (vehiculorevision_fecha BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (vehiculorevision_fecha BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (vehiculorevision_fecha > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (vehiculorevision_fecha BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  //echo $wherefecha;
  //exit();

  if ($estatusseleccionado!=""){
    $whereestatus =" and vehiculorevision.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and vehiculorevision.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and vehiculorevision.cuenta_id = '$_COOKIE[idcuenta]' and vehiculorevision.compania_id = '$_COOKIE[idcompania]' and vehiculorevision_activo = '1' ";

  } 

  $conexion = new ConexionBd();



  $arrresultado = $GLOBALS[conexion]->doSelect("

    vehiculorevision.vehiculorevision_id, vehiculorevision.vehiculo_id, vehiculorevision.l_estatus_id, 
    vehiculorevision.cuenta_id, vehiculorevision.compania_id, vehiculorevision.usuario_id, 
    vehiculorevision.vehiculorevision_fechareg, vehiculorevision.vehiculorevision_activo, 
    vehiculorevision.vehiculorevision_eliminado, vehiculorevision.vehiculorevision_fecha, 
    vehiculorevision.u_chofer_id,

    vehiculorevisiondetalle.vehiculorevisiondet_id, vehiculorevisiondetalle.vehiculorevision_id, 
    vehiculorevisiondetalle.vehiculo_id, vehiculorevisiondetalle.l_revision_id, 
    vehiculorevisiondetalle.vehiculorevisiondet_ok, 
    vehiculorevisiondetalle.vehiculorevisiondet_nook, 
    vehiculorevisiondetalle.vehiculorevisiondet_observ, 
    vehiculorevisiondetalle.vehiculorevisiondet_activo, vehiculorevisiondetalle.vehiculorevisiondet_eliminado,

      estatus.lista_nombre as estatus_nombre,

      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

      usuariorevision.usuario_nombre as usuariorevision_nombre, 
      usuariorevision.usuario_apellido as usuariorevision_apellido,   

      chofer.usuario_nombre as chofer_nombre, 
      chofer.usuario_apellido as chofer_apellido, 

      listarevision.lista_nombre as revision_nombre, listarevision.lista_cod as revision_cod,

      vehiculo_patente

      ",
      "
      vehiculorevision      
        inner join vehiculo on vehiculo.vehiculo_id = vehiculorevision.vehiculo_id
        inner join vehiculorevisiondetalle on vehiculorevisiondetalle.vehiculorevision_id = vehiculorevision.vehiculorevision_id
        inner join usuario usuariorevision on usuariorevision.usuario_id = vehiculorevision.usuario_id      
        inner join usuario chofer on chofer.usuario_id = vehiculorevision.u_chofer_id      
        inner join usuario cuenta on cuenta.usuario_id = vehiculorevision.cuenta_id
        inner join compania on compania.compania_id = vehiculorevision.compania_id 
        inner join lista estatus on estatus.lista_id = vehiculorevision.l_estatus_id             
        inner join lista listarevision on listarevision.lista_id = vehiculorevisiondetalle.l_revision_id             
        
      ",
      "vehiculorevision_eliminado = '0' and vehiculorevision.vehiculorevision_id = '$vehiculorevision_id' $where $whereestatus $wherefecha");
    foreach($arrresultado as $i=>$valor){       

      $vehiculo_patente = utf8_encode($valor["vehiculo_patente"]);

      $vehiculorevision_id = utf8_encode($valor["vehiculorevision_id"]);
      $t_vehiculo_id = utf8_encode($valor["vehiculo_id"]);
      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
      $t_compania_id = utf8_encode($valor["compania_id"]);
      $usuario_idrevision = utf8_encode($valor["usuario_id"]);
      $vehiculorevision_fechareg = utf8_encode($valor["vehiculorevision_fechareg"]);
      $vehiculorevision_activo = utf8_encode($valor["vehiculorevision_activo"]);
      $vehiculorevision_fecha = utf8_encode($valor["vehiculorevision_fecha"]);
      $u_chofer_id = utf8_encode($valor["u_chofer_id"]);

      $vehiculorevisiondet_id = utf8_encode($valor["vehiculorevisiondet_id"]);
      $l_revision_id = utf8_encode($valor["l_revision_id"]);
      $vehiculorevisiondet_ok = utf8_encode($valor["vehiculorevisiondet_ok"]);
      $vehiculorevisiondet_nook = utf8_encode($valor["vehiculorevisiondet_nook"]);
      $vehiculorevisiondet_observ = utf8_encode($valor["vehiculorevisiondet_observ"]);
      $vehiculorevisiondet_activo = utf8_encode($valor["vehiculorevisiondet_activo"]);

      $resultadorevdetalle = "";
      if ($vehiculorevisiondet_ok=="1"){
        $resultadorevdetalle = "OK";
      } else if ($vehiculorevisiondet_nook=="1"){
        $resultadorevdetalle = "NO OK";
      }

      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
      $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
      $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
      $cuenta = $cuenta_nombre." ".$cuenta_apellido;

      $compania_nombre = utf8_encode($valor["compania_nombre"]);

      $usuariorevision_nombre = utf8_encode($valor["usuariorevision_nombre"]);
      $usuariorevision_apellido = utf8_encode($valor["usuariorevision_apellido"]);
      $usuariorevision = $usuariorevision_nombre." ".$usuariorevision_apellido;

      $chofer_nombre = utf8_encode($valor["chofer_nombre"]);
      $chofer_apellido = utf8_encode($valor["chofer_apellido"]);
      $chofer = $chofer_nombre." ".$chofer_apellido;

      $revision_nombre = utf8_encode($valor["revision_nombre"]);
      $revision_cod = utf8_encode($valor["revision_cod"]);

      $revision_codmostrar = "No Obligatorio";
      if ($revision_cod=="1"){
        $revision_codmostrar = "Obligatorio";
      }

      
      if ($vehiculorevisiondet_activo=="0"){
        $activo = "<i onclick='cambiarestatusvehiculorevisiondetalle(\"".$vehiculorevisiondet_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
      }else{
        $activo = "<i onclick='cambiarestatusvehiculorevisiondetalle(\"".$vehiculorevisiondet_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
      }
      
      $accioneliminar = "<i onclick='eliminarvehiculorevisiondetalle(\"".$vehiculorevisiondet_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";


      if (P_Mod!="1"){$modificar = ""; $activo = "";}
      if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

      $mostrarcolumnacuenta = "<td>$cuenta</td>";
      $mostrarcolumnacompania = "<td>$compania_nombre</td>";

      if ($_COOKIE[perfil]=="1"){      
        
      }
      else if ($_COOKIE[perfil]=="2"){       
        $mostrarcolumnacuenta = "";
      }
      else {       
        $mostrarcolumnacuenta = "";
        $mostrarcolumnacompania = ""; 
      }
      

      $textohtml .= "
           <tr>               
                  $mostrarcolumnacuenta
                  $mostrarcolumnacompania 
                  <td>$revision_nombre</td>
                  <td>$resultadorevdetalle</td>                  
                  <td>$revision_codmostrar</td>                                                  
                  <td style='text-align: center'>$activo &nbsp $accioneliminar </td>
              </tr>
        ";

  }

  return $textohtml;

}


function ListadoVehiculoRevision($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null){

  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (vehiculorevision_fecha BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (vehiculorevision_fecha BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (vehiculorevision_fecha > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (vehiculorevision_fecha BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }

  //echo $wherefecha;
  //exit();

  if ($estatusseleccionado!=""){
    $whereestatus =" and vehiculorevision.l_estatus_id = '$estatusseleccionado' ";
  }

  if ($ultimosregistros!=""){
    $limitregistros =" LIMIT $ultimosregistros";
  }

  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";
    $columnacuenta = "<th>Cuenta</th>";
    $columnacompania = "<th>Compañia</th>";

  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
      $columnacompania = "<th>Compañia</th>";
      $where = " and vehiculorevision.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and vehiculorevision.cuenta_id = '$_COOKIE[idcuenta]' and vehiculorevision.compania_id = '$_COOKIE[idcompania]' and vehiculorevision_activo = '1' ";

  } 

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("

    vehiculorevision.vehiculorevision_id, vehiculorevision.vehiculo_id, vehiculorevision.l_estatus_id, 
    vehiculorevision.cuenta_id, vehiculorevision.compania_id, vehiculorevision.usuario_id, 
    vehiculorevision.vehiculorevision_fechareg, vehiculorevision.vehiculorevision_activo, 
    vehiculorevision.vehiculorevision_eliminado, vehiculorevision.vehiculorevision_fecha, 
    vehiculorevision.u_chofer_id,
    DATE_FORMAT(vehiculorevision_fechareg,'%d/%m/%Y %H:%i:%s') as vehiculorevision_fechareg,
    DATE_FORMAT(vehiculorevision_fecha,'%d/%m/%Y') as vehiculorevision_fecha,
      estatus.lista_nombre as estatus_nombre,

      cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
      cuenta.usuario_apellido as cuenta_apellido, compania_nombre,

      usuariorevision.usuario_nombre as usuariorevision_nombre, 
      usuariorevision.usuario_apellido as usuariorevision_apellido,   
      vehiculo_patente, vehiculorevision_chofer, 

      destino.lista_nombre as destino_nombre
      ",
      "
      vehiculorevision              
        inner join vehiculo on vehiculo.vehiculo_id = vehiculorevision.vehiculo_id
        inner join usuario usuariorevision on usuariorevision.usuario_id = vehiculorevision.usuario_id              
        inner join usuario cuenta on cuenta.usuario_id = vehiculorevision.cuenta_id
        inner join compania on compania.compania_id = vehiculorevision.compania_id 
        inner join lista estatus on estatus.lista_id = vehiculorevision.l_estatus_id                     
        inner join lista destino on destino.lista_id = vehiculorevision.l_destino_id                     
        
      ",
      "vehiculorevision_eliminado = '0' $where $whereestatus $wherefecha", null, "vehiculorevision_id desc");
    foreach($arrresultado as $i=>$valor){       

      $vehiculo_patente = utf8_encode($valor["vehiculo_patente"]);
      $vehiculorevision_id = utf8_encode($valor["vehiculorevision_id"]);
      $t_vehiculo_id = utf8_encode($valor["vehiculo_id"]);
      $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
      $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
      $t_compania_id = utf8_encode($valor["compania_id"]);
      $usuario_idrevision = utf8_encode($valor["usuario_id"]);
      $vehiculorevision_fechareg = utf8_encode($valor["vehiculorevision_fechareg"]);
      $vehiculorevision_activo = utf8_encode($valor["vehiculorevision_activo"]);
      $vehiculorevision_fecha = utf8_encode($valor["vehiculorevision_fecha"]);
      $u_chofer_id = utf8_encode($valor["u_chofer_id"]);

      $estatus_nombre = utf8_encode($valor["estatus_nombre"]);
      $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
      $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
      $cuenta = $cuenta_nombre." ".$cuenta_apellido;

      $compania_nombre = utf8_encode($valor["compania_nombre"]);
      $destino_nombre = utf8_encode($valor["destino_nombre"]);


      $usuariorevision_nombre = utf8_encode($valor["usuariorevision_nombre"]);
      $usuariorevision_apellido = utf8_encode($valor["usuariorevision_apellido"]);
      $usuariorevision = $usuariorevision_nombre." ".$usuariorevision_apellido;

      $vehiculorevision_chofer = utf8_encode($valor["vehiculorevision_chofer"]);
      

      $revision_nombre = utf8_encode($valor["revision_nombre"]);
      $revision_cod = utf8_encode($valor["revision_cod"]);

      
      if ($vehiculorevision_activo=="0"){
        $activo = "<i onclick='cambiarestatusvehiculorevision(\"".$vehiculorevision_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
      }else{
        $activo = "<i onclick='cambiarestatusvehiculorevision(\"".$vehiculorevision_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
      }
      
      $accioneliminar = "<i onclick='eliminarvehiculorevision(\"".$vehiculorevision_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

      $verdetalle = "<a href='vehiculorevisiondetalle?id=$vehiculorevision_id'>
        Ver Detalle
      </a>";

      $verimagenrevision = "<a href='vehiculomarcar?id=$vehiculorevision_id'>
        Ver Imagen
      </a>";

      /*
      $modificar = "<a href='registrarventa?id=$trans_id&cu=$t_cuenta_id&co=$t_compania_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";

      $moduloidchat = "51";
      $mensajes = "<a href='mensajedetalle?mid=$moduloidchat&id=$trans_id&cu=$t_cuenta_id&co=$t_compania_id'><i title='Enviar Mensaje' class='fa fa-envelope btn-mensajes'></i></a>";
      

      

      */

      $verpdf = "<a href='vehiculorevisiondetallepdf?id=$vehiculorevision_id' target='_blank'>
      <img title='Ver PDF' style='cursor:pointer; height: 24px; width: 20px' src='dist/img/pdf.png'>
      </a>";

      if (P_Mod!="1"){$modificar = ""; $activo = "";}
      if (P_Eli!="1"){$accioneliminar = ""; $activo = "";}

      $mostrarcolumnacuenta = "<td>$cuenta</td>";
      $mostrarcolumnacompania = "<td>$compania_nombre</td>";

      if ($_COOKIE[perfil]=="1"){      
        
      }
      else if ($_COOKIE[perfil]=="2"){       
        $mostrarcolumnacuenta = "";
      }
      else {       
        $mostrarcolumnacuenta = "";
        $mostrarcolumnacompania = ""; 
      }
      

      $textohtml .= "
           <tr>               
                  $mostrarcolumnacuenta
                  $mostrarcolumnacompania 
                  <td>$vehiculo_patente</td>
                  <td>$verimagenrevision</td>
                  <td>$vehiculorevision_fecha</td>                  
                  <td>$estatus_nombre</td>
                  <td>$verdetalle</td>                                    
                  <td style='text-align: center'>$vehiculorevision_fechareg</td>                 
                  <td style='text-align: center'>$usuariorevision</td>                  
                  <td style='text-align: center'>$verpdf &nbsp $modificar &nbsp $activo &nbsp $accioneliminar </td>
              </tr>
        ";

  }

  return $textohtml;

}



function ResumenPorAgendador($cuentaseleccionada=null, $companiaseleccionada=null, $fechadesde =null, $fechahasta=null, $estatus=null){
 
  $fechaactual = formatoFechaHoraBd(1);    

  if ($fechadesde=="" && $fechahasta==""){
    $wherefecha = " and (agenda_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";    
  } else if ($fechadesde!="" && $fechahasta!=""){
    $wherefecha = " and (agenda_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
  } else if ($fechadesde!=""){
    $wherefecha = " and (agenda_fechareg > '$fechadesde 00:00:00' ) ";  
  } else if ($fechahasta!=""){
    $wherefecha = " and (agenda_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
  }
 
  if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
    $where = "";


  } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      

      $where = " and agenda.cuenta_id = '$_COOKIE[idcuenta]' ";

  }  else { 

    $where = " and agenda.cuenta_id = '$_COOKIE[idcuenta]' and agenda.compania_id = '$_COOKIE[idcompania]' and agenda_activo  = '1' and agenda.usuario_idorigen = '$_COOKIE[iniuser]' ";

  } 

   if ($_COOKIE[perfil]=="60"){
    $whereperfilestatus = " and lista.lista_cod in  (3,4)";   

    $where = " and agenda.cuenta_id = '$_COOKIE[idcuenta]' and agenda.compania_id = '$_COOKIE[idcompania]' and agenda_activo  = '1' and agenda.usuario_iddestino = '$_COOKIE[iniuser]' ";

  }

  if ($estatus!=""){
    $whereestatus = " and agenda.l_estatus_id = '$estatus' ";
  }

  $conexion = new ConexionBd();  
  //$where $wherefecha $whereperfilestatus

  $arrresultado = $conexion->doSelect("count(agenda.agenda_id) as total, usuario_nombre, usuario_apellido",
    "
    agenda
      inner join usuario on usuario.usuario_id = agenda.usuario_idorigen
    ",
    "agenda_eliminado = '0' $where $wherefecha $whereperfilestatus $whereestatus", 
    "usuario_nombre, usuario_apellido", 
    "usuario_nombre, usuario_apellido asc");

    $totalsuma = 0;
    $armandosubmenu = 0; 
    foreach($arrresultado as $i=>$valor){
    
      $total = utf8_encode($valor["total"]);
      $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
      $usuario_apellido = utf8_encode($valor["usuario_apellido"]);

      $totalsuma = $totalsuma + $total; 

      $usuario = $usuario_nombre." ".$usuario_apellido;
    
      $divresumen  .="
        <div class='row'>
          <div class='col-md-2 col-xs-6' style='text-align: right;'>
            <h4 style='font-size: 16px; font-weight: 600'>
                $usuario:
            </h4>
          </div>     
          <div class='col-md-8 col-xs-6'>
            <h4 style='font-size: 16px'>
                $total
            </h4>
          </div>                    
        </div> 
      ";    
    }

    if ($divresumen!=""){

       $divresumentitulo  ="
        <div class='row'>
          <div class='col-md-2 col-xs-6' style='text-align: right;'>
            <h4 style='font-size: 16px; font-weight: 600'>
                Agendador
            </h4>
          </div>     
          <div class='col-md-8 col-xs-6'>
            <h4 style='font-size: 16px'>
                Total
            </h4>
          </div>                    
        </div>
        ";

        $divresumentotal  ="
        <div class='row'>
          <div class='col-md-2 col-xs-6' style='text-align: right;'>
            <h4 style='font-size: 16px; font-weight: 600'>
                TOTAL:
            </h4>
          </div>     
          <div class='col-md-8 col-xs-6'>
            <h4 style='font-size: 16px'>
                $totalsuma
            </h4>
          </div>                    
        </div>
        ";

      $divresumen = $divresumentitulo.$divresumen.$divresumentotal."<hr>";
    }

  return $divresumen;

}



function ListaModulosResumenPorId($cuentaseleccionada=null, $companiaseleccionada=null, $moduloresumen_id=null){

  $conexion = new ConexionBd();   
  
  $arrresultado = $conexion->doSelect("
  modulo.modulo_id, modulo_url,   
  moduloresumen_id, moduloresumen_titulo, moduloresumen_backcolor, 
  moduloresumen_bordercolor, moduloresumen_icono, moduloresumen_orden
  ",
    "
    modulo 
      inner join perfilpermiso on perfilpermiso.modulo_id = modulo.modulo_id    
      inner join moduloresumen on moduloresumen.modulo_id = modulo.modulo_id
    ",
    "modulo.modulo_activo = '1' and moduloresumen_activo = '1' and modulo_activo = '1' and perfilpermiso_activo = '1'  and perfilpermiso.perfil_id = '$_COOKIE[perfilactual]' and moduloresumen_id = '$moduloresumen_id'");   
  foreach($arrresultado as $i=>$valor){

    $modulo_id = utf8_encode($valor["modulo_id"]);
    $modulo_url = utf8_encode($valor["modulo_url"]);
    $moduloresumen_id = utf8_encode($valor["moduloresumen_id"]);
    $moduloresumen_titulo = utf8_encode($valor["moduloresumen_titulo"]);
    $moduloresumen_backcolor = utf8_encode($valor["moduloresumen_backcolor"]);
    $moduloresumen_bordercolor = utf8_encode($valor["moduloresumen_bordercolor"]);
    $moduloresumen_icono = utf8_encode($valor["moduloresumen_icono"]);

    $modulo_url = str_replace(".php","",$modulo_url);    

  }

  return $arrresultado;
}



// function ListadoTickets($cuentaseleccionada=null, $companiaseleccionada=null, $estatusseleccionado=null, $ultimosregistros=null, $fechadesde =null, $fechahasta=null){

//   $fechaactual = formatoFechaHoraBd(1);    

//   if ($fechadesde=="" && $fechahasta==""){
//     $wherefecha = " and (ticket_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechaactual 23:59:59' ) ";
//     $titulo = "Ventas del Día";
//   } else if ($fechadesde!="" && $fechahasta!=""){
//     $wherefecha = " and (ticket_fechareg BETWEEN '$fechadesde 00:00:00' and '$fechahasta 23:59:59' ) ";    
//   } else if ($fechadesde!=""){
//     $wherefecha = " and (ticket_fechareg > '$fechadesde 00:00:00' ) ";  
//   } else if ($fechahasta!=""){
//     $wherefecha = " and (ticket_fechareg BETWEEN '$fechaactual 00:00:00' and '$fechahasta 23:59:59' ) "; 
//   }

//   if ($estatusseleccionado!=""){
//     $whereestatus =" and ticket.l_estatus_id = '$estatusseleccionado' ";
//   }

//   if ($ultimosregistros!=""){
//     $limitregistros =" LIMIT $ultimosregistros";
//   }

//   if ($_COOKIE[perfil]=="1"){ // Administrador del Sistema
    
//     $where = "";
//     $columnacuenta = "<th>Cuenta</th>";
//     $columnacompania = "<th>Compañia</th>";

//   } else if ($_COOKIE[perfil]=="2"){ // Administrador de Cuenta  
      
//       $columnacompania = "<th>Compañia</th>";
//       $where = " and ticket.cuenta_id = '$_COOKIE[idcuenta]' ";

//   }  else { 

//     $where = " and ticket.cuenta_id = '$_COOKIE[idcuenta]' and ticket.compania_id = '$_COOKIE[idcompania]' and ticket_activo = '1' ";

//   } 

//   $conexion = new ConexionBd();

//   $arrresultado = $conexion->doSelect("ticket.ticket_id, ticket_titulo, ticket_descrip, ticket_img, 
//     DATE_FORMAT(ticket_fechaest,'%d/%m/%Y') as ticket_fechaest, ticket.l_estatus_id, ticket.l_prioridadcliente_id, ticket.l_prioridadinterna_id,
//     ticket.usuario_id, ticket.usuario_idasignado, ticket.cuenta_id, ticket.compania_id, ticket.l_progreso_id,
//     DATE_FORMAT(ticket_fechareg,'%d/%m/%Y %H:%i:%s') as ticket_fechareg, ticket_ultrespuesta,
//     DATE_FORMAT(ticket_ultfecha,'%d/%m/%Y %H:%i:%s') as ticket_ultfecha, ticket_activo,
//     cuenta.usuario_codigo as cuenta_codigo, cuenta.usuario_nombre as cuenta_nombre,
//     cuenta.usuario_apellido as cuenta_apellido, compania_nombre,
//     usuario.usuario_codigo as usuario_codigo, 
//     usuario.usuario_nombre as usuario_nombre,
//     usuario.usuario_apellido as usuario_apellido, 
//     usuarioasignado.usuario_codigo as usuarioasignado_codigo, 
//     usuarioasignado.usuario_nombre as usuarioasignado_nombre,
//     usuarioasignado.usuario_apellido as usuarioasignado_apellido, 
//     estatus.lista_nombre as estatus_nombre,
//     prioridadcliente.lista_nombre as prioridadcliente_nombre,
//     prioridadcliente.lista_color as prioridadcliente_color,
//     prioridadinterno.lista_nombre as prioridadinterno_nombre,
//     progreso.lista_nombre as progreso_nombre

//     ",
//     "ticket
//       inner join lista estatus on estatus.lista_id = ticket.l_estatus_id
//       inner join lista prioridadcliente on prioridadcliente.lista_id = ticket.l_prioridadcliente_id     
//       inner join usuario on usuario.usuario_id = ticket.usuario_id          
//       inner join usuario cuenta on cuenta.usuario_id = ticket.cuenta_id
//       inner join compania on compania.compania_id = ticket.compania_id
//       inner join lista progreso on progreso.lista_id = ticket.l_progreso_id

//       left join lista prioridadinterno on prioridadinterno.lista_id = ticket.l_prioridadinterna_id
//       left join usuario usuarioasignado on usuarioasignado.usuario_id = ticket.usuario_idasignado   
//     ",
//     "ticket_eliminado = '0' $where $whereestatus $wherefecha", null, "ticket.ticket_id desc $limitregistros");
//   foreach($arrresultado as $i=>$valor){
  
//     $t_ticket_id = utf8_encode($valor["ticket_id"]);
//     $ticket_titulo = utf8_encode($valor["ticket_titulo"]);
//     $ticket_descrip = utf8_encode($valor["ticket_descrip"]);
//     $ticket_img = utf8_encode($valor["ticket_img"]);
//     $ticket_fechaest = utf8_encode($valor["ticket_fechaest"]);
//     $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
//     $l_prioridadcliente_id = utf8_encode($valor["l_prioridadcliente_id"]);
//     $l_prioridadinterna_id = utf8_encode($valor["l_prioridadinterna_id"]);
//     $t_usuario_id = utf8_encode($valor["usuario_id"]);
//     $usuario_idasignado = utf8_encode($valor["usuario_idasignado"]);
//     $t_cuenta_id = utf8_encode($valor["cuenta_id"]);
//     $t_compania_id = utf8_encode($valor["compania_id"]);
//     $l_progreso_id = utf8_encode($valor["l_progreso_id"]);
//     $ticket_fechareg = utf8_encode($valor["ticket_fechareg"]);
//     $ticket_ultrespuesta = utf8_encode($valor["ticket_ultrespuesta"]);
//     $ticket_ultfecha = utf8_encode($valor["ticket_ultfecha"]);
//     $ticket_activo = utf8_encode($valor["ticket_activo"]);
//     $estatus_nombre = utf8_encode($valor["estatus_nombre"]);

//     $compania_nombre = utf8_encode($valor["compania_nombre"]);
  
//     $cuenta_nombre = utf8_encode($valor["cuenta_nombre"]);
//     $cuenta_apellido = utf8_encode($valor["cuenta_apellido"]);
//     $cuenta_codigo = utf8_encode($valor["cuenta_codigo"]);

//     $cuenta = $cuenta_nombre." ".$cuenta_apellido." ";

//     $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
//     $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
//     $usuario_codigo = utf8_encode($valor["usuario_codigo"]);

//     $usuario = $usuario_nombre." ".$usuario_apellido." ";

//     $usuarioasignado_nombre = utf8_encode($valor["usuarioasignado_nombre"]);
//     $usuarioasignado_apellido = utf8_encode($valor["usuarioasignado_apellido"]);
//     $usuarioasignado_codigo = utf8_encode($valor["usuarioasignado_codigo"]);

//     $usuarioasignado = $usuarioasignado_nombre." ".$usuarioasignado_apellido." ";

//     $prioridadcliente_nombre = utf8_encode($valor["prioridadcliente_nombre"]);
//     $prioridadcliente_color = utf8_encode($valor["prioridadcliente_color"]);
//     $prioridadinterno_nombre = utf8_encode($valor["prioridadinterno_nombre"]);
//     $progreso_nombre = utf8_encode($valor["progreso_nombre"]);

//     $prioridad = "";
//     if ($prioridadcliente_color!=""){
//       $prioridad = "<small class='label' style='font-size: 14px; font-weight: normal; background-color: $prioridadcliente_color'>$prioridadcliente_nombre</small>";
//     }
    

//     if ($ticket_activo=="0"){
//       $activo = "<i onclick='cambiarestatusticket(\"".$t_ticket_id."\",1)' title='Deshabilitado' class='fa fa-minus btn-deshabilitar'></i>";
//     }else{
//       $activo = "<i onclick='cambiarestatusticket(\"".$t_ticket_id."\",0)' title='Habilitado' class='fa fa-check btn-habilitar'></i>";
//     }
    
//     $accioneliminar = "<i onclick='eliminarticket(\"".$t_ticket_id."\",0)' title='Eliminar?' class='fa fa-trash btn-eliminar'></i>";

    
//     $modificarrrrrrrrrrr = "<a href='modificarticket?id=$t_ticket_id'><i title='Ver' class='fa fa-edit btn-modificar'></i></a>";


//     $resolverticket = "<a href='resolverticket?id=$t_ticket_id'><img title='Resolver Ticket' style='cursor:pointer; height: 25px; width: 29px' src='dist/img/usuario1.png'></a>";

//     $verticket = "<a href='verticket?id=$t_ticket_id'>$ticket_titulo (Ver)</a>";

//     $historial = "<a href='tickethistorial?id=$t_ticket_id'>(Ver)</a>";

//     $moduloidchat = "95";
//     $mensajes = "<a href='mensajedetalle?mid=$moduloidchat&id=$t_ticket_id&cu=$t_cuenta_id&co=$t_compania_id'><i title='Enviar Mensaje' class='fa fa-envelope btn-mensajes'></i></a>";
    

//     if (P_Mod!="1"){$modificar = ""; $activo = ""; $configurartarea=""; $resolverticket="";}
//     if (P_Eli!="1"){$accioneliminar = ""; $activo = ""; $configurartarea = "";}

//     $mostrarcolumnacuenta = "<td>$cuenta</td>";
//     $mostrarcolumnacompania = "<td>$compania_nombre</td>";

//     if ($_COOKIE[perfil]=="1"){      
      
//     }
//     else if ($_COOKIE[perfil]=="2"){       
//       $mostrarcolumnacuenta = "";
//     }
//     else {      
//       $mostrarcolumnacuenta = "";
//       $mostrarcolumnacompania = ""; 
//     }

//     $textohtml .= "
//            <tr style='font-size: 14px; text-align: center'>
//               $mostrarcolumnacuenta
//               $mostrarcolumnacompania                 
//                   <td>$verticket</td>   
//               <td>$estatus_nombre</td>    
//               <td>$prioridad</td>   
//               <td>$progreso_nombre%</td>   
//               <td>$historial</td>   
//               <td>$ticket_fechareg</td>   
//                   <td style='text-align: center'>$mensajes &nbsp $resolverticket &nbsp $modificar &nbsp $activo &nbsp $accioneliminar</td>
//               </tr>
//         ";

//   }

//   return $textohtml;

// }

function ObtenerCodigoTicket($codigo=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  $codigo = $codigo;

  return $codigo;

}

// function ObtenerTipoDato($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado =null){

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
//   if ($cuentaseleccionada==""){
//     $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
//   }else if ($cuentaseleccionada==""){
//     $option = "<option  value=''>Seleccione Primero la Compañia</option>";
//   }  
//   else {
      
//      $arrresultado = $conexion->doSelect("tipodato_id, tipodato_nombre, tipodato_descrip",
//        "tipodato",
//        "tipodato_activo = '1' ", null, "tipodato_nombre asc");

//       $option = "<option value=''>-- Seleccione --</option>";
//       foreach($arrresultado as $i=>$valor){

//        $tipodato_id = utf8_encode($valor["tipodato_id"]);
//        $tipodato_nombre = utf8_encode($valor["tipodato_nombre"]);        
//         $tipodato_descrip = utf8_encode($valor["tipodato_descrip"]);  

//        if ($idseleccionado==$tipodato_id){
//               $option .= "<option selected='selected' value='$tipodato_id'>$tipodato_descrip</option>";
//           }else{
//               $option .= "<option value='$tipodato_id'>$tipodato_descrip</option>";
//           }

//       }
        
//       if (count($arrresultado)==0){
//         $option = "<option  value=''>NO EXISTEN TIPOS DE DATOS</option>";
//       }

//       if (count($arrresultado)==1){
//         $option = "<option selected='selected' value='$tipodato_id'>$tipodato_descrip</option>";
//       } 
//   }
  

//   return $option;

// }

// function ObtenerTipoLista($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado =null){

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
//   if ($cuentaseleccionada==""){
//     $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
//   }else if ($cuentaseleccionada==""){
//     $option = "<option  value=''>Seleccione Primero la Compañia</option>";
//   }  
//   else {
      
//      $arrresultado = $conexion->doSelect("tipolista_id, tipolista_nombre",
//        "tipolista",
//        "tipolista_activo = '1' and tipolista_person = '1' ", null, "tipolista_nombre asc");

//       $option = "<option value=''>-- Seleccione --</option>";
//       foreach($arrresultado as $i=>$valor){

//        $tipolista_id = utf8_encode($valor["tipolista_id"]);
//        $tipolista_nombre = utf8_encode($valor["tipolista_nombre"]);        

//        if ($idseleccionado==$tipolista_id){
//               $option .= "<option selected='selected' value='$tipolista_id'>$tipolista_nombre</option>";
//           }else{
//               $option .= "<option value='$tipolista_id'>$tipolista_nombre</option>";
//           }

//       }
        
//       if (count($arrresultado)==0){
//         $option = "<option  value=''>NO EXISTEN TIPOS DE LISTA</option>";
//       }

//       if (count($arrresultado)==1){
//         $option = "<option selected='selected' value='$tipolista_id'>$tipolista_nombre</option>";
//       } 
//   }
  

//   return $option;

// }

// function ObtenerListaTareas($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado =null){

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
//   if ($cuentaseleccionada==""){
//     $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
//   }else if ($cuentaseleccionada==""){
//     $option = "<option  value=''>Seleccione Primero la Compañia</option>";
//   }  
//   else {
      
//      $arrresultado = $conexion->doSelect("tarea_id, tarea_nombre",
//        "tarea",
//        "tarea_activo = '1' and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada'", null, "tarea_nombre asc");

//       $option = "<option value=''>-- Seleccione --</option>";
//       foreach($arrresultado as $i=>$valor){

//        $tarea_id = utf8_encode($valor["tarea_id"]);
//        $tarea_nombre = utf8_encode($valor["tarea_nombre"]);

//        if ($idseleccionado==$tarea_id){
//               $option .= "<option selected='selected' value='$tarea_id'>$tarea_nombre</option>";
//           }else{
//               $option .= "<option value='$tarea_id'>$tarea_nombre</option>";
//           }

//       }
        
//       if (count($arrresultado)==0){
//         $option = "<option  value=''>NO EXISTEN TAREAS</option>";
//       }

//       if (count($arrresultado)==1){
//         $option = "<option selected='selected' value='$tarea_id'>$tarea_nombre</option>";
//       } 
//   }
  

//   return $option;

// }



function TareaColocarIcono($tipo=null, $valor=null){

    $conexion = new ConexionBd();  

    session_start();
    $_COOKIE[iniuser] = $_COOKIE[iniuser];
    $_COOKIE[perfil] = $_COOKIE[perfil];
    $_COOKIE[idcuenta] = $_COOKIE[idcuenta];

    if ($_COOKIE[perfil]!="1"){
      $cuenta = $_COOKIE[idcuenta];
    }   
  
  $colocar = "";

  if ($valor!=""){
    if ($tipo=="7"){ //WhatsApp
      $colocar = "<a href='whatsapp://send?phone=$valor'><i class='fa fa-whatsapp btn-whatsapp'></i></a>";
    }else if ($tipo=="8"){ //Telefono
      $colocar = "<a href='tel:$valor'><i class='fa fa-phone btn-telefono'></i></a>";
    }else if ($tipo=="9"){ //Email
      $colocar = "<a href='mailto:$valor'><i class='fa fa-envelope btn-email'></i></a>";
    }else if ($tipo=="10"){ //Perfil Facebook
      $colocar = "<a href='$valor'><i class='fa fa-facebook btn-facebook'></i></a>";
    }
  }

  return $colocar;

}


function ConsultarNotificacionesTotal(){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[iniuser] = $_COOKIE[iniuser];
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $total = 0;
  
  $arrresultado = $conexion->doSelect("count(*) as total",
    "notificacion",
    "notif_activo = '1' and usuario_iddestino  = '$_COOKIE[iniuser]' and (notif_leido is null or notif_leido = '0')", null, "notif_id desc");
  
  foreach($arrresultado as $i=>$valor){
    $total = utf8_encode($valor["total"]);
  }
  
  return $total;

}

function ConsultarNotificacionesPanel($solonoleidas=null){

  $conexion = new ConexionBd();  

  if ($solonoleidas=="1"){
    $wheresolonoleidas = " and (notif_leido is null or notif_leido = '0')  ";
  }

  session_start();
  $_COOKIE[iniuser] = $_COOKIE[iniuser];
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];

  $obtenerCodigoLista = 2;
  $obtenerTipoLista = 33;
  $tiponotificacion = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

  
  $arrresultado = $conexion->doSelect("notificacion.notif_id, notificacion.notif_tabla, notificacion.modulo_id, notificacion.elemento_id, 
    notificacion.notif_descrip, notificacion.notif_email, notificacion.notif_telf, notificacion.notif_fechareg, notificacion.l_estatus_id, 
    notificacion.usuario_idorigen, notificacion.usuario_iddestino, notificacion.cuenta_id, notificacion.compania_id, notificacion.notif_activo, 
    notificacion.notif_notificadoemail, notificacion.notif_leido,
    modulo_url, notif_titulo
    
    ",
    "notificacion
      left join modulo on modulo.modulo_id = notificacion.modulo_id
    ",
    "notif_activo = '1' and notif_visible = '1' and notificacion.l_tiponotif_id = '$tiponotificacion' and usuario_iddestino  = '$_COOKIE[iniuser]' $wheresolonoleidas", null, "notif_id desc LIMIT 5");
  
  foreach($arrresultado as $i=>$valor){

    $notif_id = utf8_encode($valor["notif_id"]);
    $notif_tabla = utf8_encode($valor["notif_tabla"]);
    $modulo_id = utf8_encode($valor["modulo_id"]);
    $elemento_id = utf8_encode($valor["elemento_id"]);
    $notif_titulo = utf8_encode($valor["notif_titulo"]);
    $notif_descrip = utf8_encode($valor["notif_descrip"]);
    $notif_email = utf8_encode($valor["notif_email"]);
    $notif_telf = utf8_encode($valor["notif_telf"]);
    $notif_fechareg = utf8_encode($valor["notif_fechareg"]);
    $l_estatus_id = utf8_encode($valor["l_estatus_id"]);
    $usuario_idorigen = utf8_encode($valor["usuario_idorigen"]);
    $usuario_iddestino = utf8_encode($valor["usuario_iddestino"]);
    $cuenta_id = utf8_encode($valor["cuenta_id"]);
    $compania_id = utf8_encode($valor["compania_id"]);
    $notif_activo = utf8_encode($valor["notif_activo"]);
    $notif_notificadoemail = utf8_encode($valor["notif_notificadoemail"]);
    $notif_leido = utf8_encode($valor["notif_leido"]);
    $modulo_url = utf8_encode($valor["modulo_url"]);

    $linkurl = "$modulo_url?id=$elemento_id";

    $classnoleido = "";
    if ($notif_leido!="1"){
      $classnoleido = "aa";
    }

    $htmlnotificaciones .="
      <div class='row'>
        <div class='col-md-12'>
          <div class='callout callout-info'>
            <a href='$linkurl' style='text-decoration: none'>
              <h4>$notif_titulo!</h4>
              $notif_descrip
            </a>
          </div>
        </div>
      </div>
    ";
  }

  
  return $htmlnotificaciones;

}


function distanceCalculation($point1_lat, $point1_long, $point2_lat, $point2_long, $unit = 'km', $decimals = 2) {
  // Cálculo de la distancia en grados
  $degrees = rad2deg(acos((sin(deg2rad($point1_lat))*sin(deg2rad($point2_lat))) + (cos(deg2rad($point1_lat))*cos(deg2rad($point2_lat))*cos(deg2rad($point1_long-$point2_long)))));

  // Conversión de la distancia en grados a la unidad escogida (kilómetros, millas o millas naúticas)
  switch($unit) {
    case 'km':
      $distance = $degrees * 111.13384; // 1 grado = 111.13384 km, basándose en el diametro promedio de la Tierra (12.735 km)
      break;
    case 'mi':
      $distance = $degrees * 69.05482; // 1 grado = 69.05482 millas, basándose en el diametro promedio de la Tierra (7.913,1 millas)
      break;
    case 'nmi':
      $distance =  $degrees * 59.97662; // 1 grado = 59.97662 millas naúticas, basándose en el diametro promedio de la Tierra (6,876.3 millas naúticas)
  }
  return round($distance, $decimals);
}



function AsignarRegistrosCreacionCompania($cuenta=null, $compania_id=null, $categoria_id=null){

    $conexion = new ConexionBd();  

    if ($categoria_id==""){$categoria_id=0;}

    $instancialista = new Lista();

    session_start();
    if ($_SESSION[perfil]!="1"){
      $cuenta = $_SESSION[idcuenta];
    }    

    $arrresultado2 = $conexion->doSelect("cuenta_id, compania_img","compania", "compania_id = '$compania_id'");
      if (count($arrresultado2)>0){
      foreach($arrresultado2 as $i=>$valor){
        $cuenta = ($valor["cuenta_id"]);
        $compania_img = ($valor["compania_img"]);
      }
    }

    $fechaactual = formatoFechaHoraBd();
    
    
      // Creo Cliente por Defecto
      $resultado = $conexion->doInsert("
      usuario
        (usuario_nombre, usuario_fechareg, usuario_activo, usuario_eliminado, usuario_img, perfil_id, 
        cuenta_id, compania_id, usuario_defecto, usuario_email) 
      ",
      "'Consumidor Final', '$fechaactual', '1', '0', '1.png', '4',
      '$cuenta','$compania_id',0,null");


      // Creo Vendedor por Defecto
      $resultado = $conexion->doInsert("
      usuario
        (usuario_nombre, usuario_fechareg, usuario_activo, usuario_eliminado, usuario_img, perfil_id, cuenta_id, compania_id, usuario_defecto) 
      ",
      "'Vendedor General', '$fechaactual', '1', '0', '1.png', '5','$cuenta','$compania_id',0");


      // Creo Proveedor por Defecto
      $resultado = $conexion->doInsert("
      usuario
        (usuario_nombre, usuario_empresa, usuario_fechareg, usuario_activo, usuario_eliminado, usuario_img, perfil_id, cuenta_id, compania_id, usuario_defecto) 
      ",
      "'Proveedor General','Proveedor General', '$fechaactual', '1', '0', '1.png', '6','$cuenta','$compania_id', '1'");


    // Creo Empleado por Defecto
      $resultado = $conexion->doInsert("
      usuario
        (usuario_nombre, usuario_fechareg, usuario_activo, usuario_eliminado, usuario_img, perfil_id, cuenta_id, compania_id, usuario_defecto) 
      ",
      "'Empleado General', '$fechaactual', '1', '0', '1.png', '7','$cuenta','$compania_id',0");

    // Creo Sucursal por Defecto
    $resultado = $conexion->doInsert("
      sucursal
        (sucursal_nombre, sucursal_razonsocial, sucursal_img, sucursal_activo, sucursal_eliminado,
        sucursal_fechareg, cuenta_id, usuario_idreg, compania_id, sucursal_ppal) 
      ",
      "'Principal', '','0.jpg','1', '0',
      '$fechaactual', '$cuenta','$_SESSION[iniuser]','$compania_id', '1'");

    $arrresultado2 = $conexion->doSelect("max(sucursal_id) as sucursal_id","sucursal");
      if (count($arrresultado2)>0){
      foreach($arrresultado2 as $i=>$valor){
        $sucursal_id = ($valor["sucursal_id"]);
      }
    }

    
    $obtenerCodigoLista = 1; 
    $obtenerTipoLista = 46;
    $tipobanner = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

    // Banner por Defecto
    $resultado = $conexion->doInsert("
      banner
        (banner_nombre, banner_textouno, banner_textodos, banner_textotres, banner_botonnombre, 
        banner_botonurl, banner_img, cuenta_id, compania_id, banner_activo, banner_eliminado, 
        banner_fechareg, banner_orden, usuario_idreg, l_tipobanner_id)

      ",
      "'', '', '', '', '', 
      '', '4.jpg', '$cuenta', '$compania_id', '1', '0',
       '$fechaactual','1', '$_SESSION[iniuser]','$tipobanner'");

    $arrresultado2 = $conexion->doSelect("max(banner_id) as banner_id","banner");
    if (count($arrresultado2)>0){
      foreach($arrresultado2 as $i=>$valor){
        $banner_id = ($valor["banner_id"]);
      }
    }


    $obtenerCodigoLista = 1; //Unidad
    $obtenerTipoLista = 3;
    $tipounidad = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

    $obtenerCodigoLista = 1; //Dolares
    $obtenerTipoLista = 16;
    $moneda = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

    $obtenerCodigoLista = 1; //Producto Unico
    $obtenerTipoLista = 4;
    $tipoproducto = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

    $obtenerCodigoLista = 1; //Producto
    $obtenerTipoLista = 7;
    $claseproducto = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

    $prod_nombre = "Producto General";

    $find = array('á', 'é', 'í', 'ó', 'ú', 'ñ');
    $repl = array('a', 'e', 'i', 'o', 'u', 'n');
    $prod_nombreurl = str_replace($find, $repl, $prod_nombre);
    $urlamigableprod = urls_amigables($prod_nombreurl);

    $urlamigableprod = substr($urlamigableprod, 0,120);

    // Producto General
    $resultado = $conexion->doInsert("
    producto
      (prod_nombre, prod_descrip, prod_img, prod_stockgeneral, prod_codigo,
      l_tipounidad_id, prod_valorunidad, prod_costo, prod_venta, l_moneda_id, l_tipoproducto_id, 
      l_claseproducto_id, prod_idpadre, cuenta_id, compania_id, prod_activo, prod_eliminado, prod_fechareg, usuario_idreg, prod_ganancia, prod_porcganancia, prod_url, l_categ_id) 

    ",
    "'$prod_nombre', '$prod_nombre', '3.jpg', '10', '0', 
    '$tipounidad', '0', '50', '100', '$moneda', '$tipoproducto',
    '$claseproducto', '0', '$cuenta', '$compania_id', '1', '0', '$fechaactual', '$_SESSION[iniuser]','50','100','$urlamigableprod','$categoria_id'");

    $arrresultado2 = $conexion->doSelect("max(prod_id) as prod_id","producto");
      if (count($arrresultado2)>0){
      foreach($arrresultado2 as $i=>$valor){
        $prod_id = ($valor["prod_id"]);
      }
    }


    $resultado = $conexion->doInsert("
    productostock
      (prod_id, sucursal_id, prodstock_cantidad, prodstock_fechareg, prodstock_activo, prodstock_eliminado, cuenta_id, compania_id)
    ",
    "'$prod_id', '$sucursal_id', '10', '$fechaactual', '1', '0','$_SESSION[idcuenta]','$compania_id'");


    // Crear Forma de Pago General
    $tipolista_id = 21;

    $lista_nombre = "Transferencia Bancaria";
    $lista_nombredos = "";
    $lista_descrip = "";
    $lista_img = "0.jpg";
    $lista_ppal = 0;
    $lista_orden = 0;
    $compania = $compania_id;
    $lista_icono = "";
    $lista_idrel = 0;
    $lista_url = "";
    $fechaactual = formatoFechaHoraBd(); 
    $lista_cod = "";

    $resultadoGuardarLista = GuardarProcesoLista($lista_nombre, $lista_nombredos, $lista_descrip, $lista_img, $lista_ppal, $lista_orden, $tipolista_id, $cuenta, $compania, $lista_icono, $lista_color, $lista_idrel, $lista_url, $fechaactual, null, null, $lista_cod);

    foreach ($resultadoGuardarLista as $key => $value) {
      $lista_id = $resultadoGuardarLista["lista_id"];
      $listacuenta_id = $resultadoGuardarLista["listacuenta_id"];
    }

    $listaformapago_titular = "";
    $listaformapago_documento = "";
    $listaformapago_email = "";
    $listaformapago_banco = "";
    $listaformapago_tipocuenta = "";
    $listaformapago_nrocuenta = "";
    $listaformapago_otros = "";
    $listaformapago_token = "";
    $listaformapago_clavepublica = "";
    $iniuser = $_SESSION[iniuser];


    $resultadoGuardarListaFormaPago = GuardarListaFormaPago("", $lista_id, $listaformapago_titular, $listaformapago_documento, $listaformapago_email, $listaformapago_banco,  $listaformapago_tipocuenta, $listaformapago_nrocuenta, $listaformapago_otros, $fechaactual, $cuenta, $compania, $listacuenta_id, $listaformapago_token, $listaformapago_clavepublica, $iniuser);

    $tipolista_idrel = 117; // Web
    $resultado = $conexion->doInsert("
        listacuentarel
          (tipolista_id, lista_id, cuenta_id, compania_id, listacuentarel_fechareg, listacuentarel_activo, 
          listacuentarel_eliminado, usuario_idreg) 
        ",
      "'$tipolista_idrel', '$lista_id', '$cuenta', '$compania', '$fechaactual', '1',
      '0', '$_SESSION[iniuser]'"); 

    $tipolista_idrel = 118; // Sistema
    $resultado = $conexion->doInsert("
        listacuentarel
          (tipolista_id, lista_id, cuenta_id, compania_id, listacuentarel_fechareg, listacuentarel_activo, 
          listacuentarel_eliminado, usuario_idreg) 
        ",
      "'$tipolista_idrel', '$lista_id', '$cuenta', '$compania', '$fechaactual', '1',
      '0', '$_SESSION[iniuser]'"); 


    // Moneda por Defecto
    $tipolistamonedadefecto = 12;

    $obtenerCodigoMonedaDefecto = 999;
    $obtenerTipoLista = 16;
    $idmonedaprincipal = $instancialista->ObtenerIdLista($obtenerCodigoMonedaDefecto, $obtenerTipoLista);  

    $resultado = $conexion->doInsert("
        listaconfig
          (tipolista_id,cuenta_id,compania_id, listaconfig_valoruno,listaconfig_valordos,
          listaconfig_valortres,listaconfig_fechareg,listaconfig_activo,listaconfig_eliminado,usuario_idreg) 
        ",
        "'$tipolistamonedadefecto', '$cuenta', '$compania', '$idmonedaprincipal', '', '', '$fechaactual','1','0','$_SESSION[iniuser]'");


    // Asignar por defecto consumidor final
    $tipolistaconsumidorfinal = 35;
    $resultado = $conexion->doInsert("
        listaconfig
          (tipolista_id,cuenta_id,compania_id, listaconfig_valoruno,listaconfig_valordos,
          listaconfig_valortres,listaconfig_fechareg,listaconfig_activo,listaconfig_eliminado,usuario_idreg) 
        ",
        "'$tipolistaconsumidorfinal', '$cuenta', '$compania', '1', '', '', '$fechaactual','1','0','$_SESSION[iniuser]'");


    // Abrir caja por defecto

    $tipomovimiento = 4;
    
    $obtenerCodigoLista = 1;
    $obtenerTipoLista = 134;
    $idestatusabierta = $instancialista->ObtenerIdLista($obtenerCodigoLista, $obtenerTipoLista);

    $montocaja = 0;
    $monto = $montocaja;

    $resultado = $conexion->doInsert("
      caja
        (caja_fecha, caja_saldoinicial, caja_saldoentrada, caja_saldosalida, caja_saldoimporteteorico, 
        caja_saldoimportereal, caja_saldodescuadre, caja_fechaabierto, caja_activo, caja_eliminado, l_estatus_id,
        cuenta_id, compania_id, l_moneda_id)
      ",
      "'$fechaactual', '$monto', '0', '0', '$monto',
      '0','0','$fechaactual', '1', '0','$idestatusabierta',
      '$cuenta', '$compania', '$idmonedaprincipal'");

    $arrresultado = $conexion->doSelect("max(caja_id) as caja_id","caja");
    foreach($arrresultado as $i=>$valor){
      $caja_id = utf8_encode($valor["caja_id"]);
    }


    $tipomovimiento=="4";

    // historial de caja
    $resultado = $conexion->doInsert("
    cajahistorial
      (caja_id, tipomovimientocaja_id, cajahistorial_saldo, cajahistorial_comentario, 
      cajahistorial_fechareg, cajahistorial_activo, cajahistorial_eliminado)
    ",
    "'$caja_id', '$tipomovimiento', '$monto', '', 
    '$fechaactual', '1', '0'");

    
    $resultado = $conexion->doQuery("
        INSERT INTO usuarioperfil
        (usuario_id, perfil_id, usuarioperfil_activo, usuarioperfil_eliminado, usuarioperfil_fechareg) 
        SELECT '$cuenta', perfil_id, '1', '0', '$fechaactual'
        FROM perfil WHERE perfil_defecto = '1'
      ");


      if ($cuenta==2179){
        // Copiar Terminos, Politicas y Nosotros
        
        $resultado = $conexion->doQuery("
          INSERT INTO seccion 
          (seccion_nombre, seccion_descrip, seccion_img, cuenta_id, compania_id, 
          seccion_activo, seccion_eliminado, seccion_fechareg, seccion_orden, usuario_idreg, 
          seccion_url, l_tiposeccion_id, seccion_footer, l_tipomenuweb_id)

          SELECT seccion_nombre, seccion_descrip, '0.jpg', cuenta_id, '$compania', 
          seccion_activo, seccion_eliminado, '$fechaactual', seccion_orden, usuario_idreg, 
          seccion_url, l_tiposeccion_id, seccion_footer, l_tipomenuweb_id
              
          FROM seccion WHERE seccion_activo = '1' and compania_id = '358'
        ");

      }


}

// function = $instanciaperfil->ObtenerListaPerfilParaPerfil($cuentaseleccionada=null, $companiaseleccionada=null, $perfil_idactual =null, $paraperfil=null){

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
//   if ($cuentaseleccionada==""){
//     $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
//   }else if ($cuentaseleccionada==""){
//     $option = "<option  value=''>Seleccione Primero la Compañia</option>";
//   }  
//   else {

//     if ($paraperfil!=""){
//       $whereperfil = " and perfil_id = '$paraperfil' ";
//     }
      
//      $arrresultado = $conexion->doSelect("perfil_id, perfil_nombre, perfil_personalizado",
//        "perfil",
//        "perfil_activo = '1' and perfil_defecto = '1' $whereperfil or ( perfil_personalizado = '1' and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada' )", null, "perfil_id asc");

//       $option = "<option value=''>-- Seleccione --</option>";
//       foreach($arrresultado as $i=>$valor){

//        $perfil_id = utf8_encode($valor["perfil_id"]);
//        $perfil_nombre = utf8_encode($valor["perfil_nombre"]);
//        $perfil_personalizado = utf8_encode($valor["perfil_personalizado"]);
        
//         $colocar  ="";
//         if ($perfil_personalizado=="1"){
//           $colocar  =" (Personalizado)";
//         }

//        if ($perfil_idactual==$perfil_id){
//               $option .= "<option selected='selected' value='$perfil_id'>$perfil_nombre $colocar</option>";
//           }else{
//               $option .= "<option value='$perfil_id'>$perfil_nombre $colocar</option>";
//           }

//       }
        
//       if (count($arrresultado)==0){
//         $option = "<option  value=''>NO EXISTEN PERFILES</option>";
//       }

//       if (count($arrresultado)==1){
//         $option = "<option selected='selected' value='$perfil_id'>$perfil_nombre $colocar</option>";
//       } 
//   }
  

//   return $option;

// }


function AsignarPerfilesPorDefecto($cuentaseleccionada=null, $companiaseleccionada=null, $perfil_id=null){

  $conexion = new ConexionBd();  

  session_start();
  if ($_SESSION[perfil]!="1"){$cuentaseleccionada = $_SESSION[idcuenta];} 
  if ($cuentaseleccionada==""){$cuentaseleccionada = $_SESSION[idcompania];}
  if ($cuentaseleccionada==""){$cuentaseleccionada=0;}
  if ($perfil_id==""){$perfil_id=0;}
      
  $arrresultado = $conexion->doQuery("    
    INSERT INTO
      perfilpermiso
        (perfil_id, modulo_id, cuenta_id, compania_id, perfilpermiso_create, perfilpermiso_read, perfilpermiso_update, perfilpermiso_delete, perfilpermiso_usuario,  perfilpermiso_all, 
        perfilpermiso_activo, perfilpermiso_eliminado, perfilpermiso_fechareg, usuario_idreg, tipopermiso_id) 
    SELECT 
        '$perfil_id', modulo_id, '$cuentaseleccionada', '$companiaseleccionada', perfilpermiso_create, perfilpermiso_read, perfilpermiso_update, perfilpermiso_delete, perfilpermiso_usuario, perfilpermiso_all, 
        perfilpermiso_activo, perfilpermiso_eliminado, perfilpermiso_fechareg, usuario_idreg, tipopermiso_id
    FROM 
      perfilpermiso
    WHERE 
      perfilpermiso_activo = '1' and perfilpermiso.perfil_id = '15' and perfilpermiso.compania_id = '10' 
  ");

  //and perfilpermiso.cuenta_id = '2' and perfilpermiso.compania_id = '1'  and perfilpermiso.perfil_id in (2)   
    

  return 1;

}

function ObtenerSucursalPrincipal($cuentaseleccionada=null, $companiaseleccionada=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  

  if ($_COOKIE[perfil]=="1"){  
    
    if ($cuentaseleccionada!=""){
      $wheresucursal = " and cuenta_id = '$cuentaseleccionada' ";     
    }

    if ($companiaseleccionada!=""){
      $wheresucursal = " and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada' ";     
    }
    
  } else {  
  
    $wheresucursal = " and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada' ";     
    
  } 
  
  $sucursaldevolver = 0;
      
  $arrresultado = $conexion->doSelect("sucursal_id, sucursal_nombre",
    "sucursal ",
    "sucursal_activo = '1' and sucursal_ppal = '1' $wheresucursal ", null, "sucursal_nombre asc");

  
  foreach($arrresultado as $i=>$valor){

      $sucursal_id = utf8_encode($valor["sucursal_id"]);  
      $sucursal_nombre = utf8_encode($valor["sucursal_nombre"]);  
      
      $sucursaldevolver = $sucursal_id;
  }

  return $sucursaldevolver;

}


// function $instancialista->ObtenerListaProveedores($cuentaseleccionada=null, $companiaseleccionada=null, $proveedorseleccionado =null){

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
//   if ($cuentaseleccionada==""){
//     $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
//   }else if ($cuentaseleccionada==""){
//     $option = "<option  value=''>Seleccione Primero la Compañia</option>";
//   }  
//   else {
      
//      $arrresultado = $conexion->doSelect("usuario_id, usuario_nombre, usuario_apellido, usuario_empresa",
//        "usuario",
//        "usuario_activo = '1' and perfil_id = '6' and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada'", null, "usuario_nombre, usuario_apellido asc");

//       $option = "<option value=''>-- Seleccione --</option>";
//       foreach($arrresultado as $i=>$valor){

//        $usuario_id = utf8_encode($valor["usuario_id"]);
//        $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
//        $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
//         $usuario_empresa = utf8_encode($valor["usuario_empresa"]);

//        if ($proveedorseleccionado==$usuario_id){
//               $option .= "<option selected='selected' value='$usuario_id'>$usuario_empresa</option>";
//           }else{
//               $option .= "<option value='$usuario_id'>$usuario_empresa</option>";
//           }

//       }
        
//       if (count($arrresultado)==0){
//         $option = "<option  value=''>NO EXISTEN PROVEEDORES</option>";
//       }

//       if (count($arrresultado)==1){
//         $option = "<option selected='selected' value='$usuario_id'>$usuario_empresa</option>";
//       } 
//   }
  

//   return $option;

// }

function ObtenerCodigo($codigo=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  $codigo = $codigo;

  return $codigo;

}

function ObtenerListaVendedor($cuentaseleccionada=null, $companiaseleccionada=null, $vendedorseleccionado =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else {
      
     $arrresultado = $conexion->doSelect("usuario_id, usuario_nombre, usuario_apellido",
        "usuario",
        "usuario_activo = '1' and perfil_id = '5' and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada'", null, "usuario_nombre, usuario_apellido asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

        $usuario_id = utf8_encode($valor["usuario_id"]);
        $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
        $usuario_apellido = utf8_encode($valor["usuario_apellido"]);

        if ($vendedorseleccionado==$usuario_id){
              $option .= "<option selected='selected' value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
          }else{
              $option .= "<option value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
          }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN VENDEDORES</option>";
      }

      if (count($arrresultado)==1){
        $option = "<option selected='selected' value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
      } 
  }
  

  return $option;

}


// function ObtenerListaPaises($paisseleccionado=null){

//   $conexion = new ConexionBd();  
  
//   $arrresultado = $conexion->doSelect("pais_id, pais_nombre",
//     "pais ",
//     "pais_activo = '1'", null, "pais_principal, pais_nombre asc");

//   $option = "<option value=''>-- Seleccione --</option>";
//   foreach($arrresultado as $i=>$valor){

//       $pais_id = utf8_encode($valor["pais_id"]);  
//       $pais_nombre = utf8_encode($valor["pais_nombre"]);  

//       if ($paisseleccionado==$pais_id){
//           $option .= "<option selected='selected' value='$pais_id'>$pais_nombre</option>";
//       }else{
//           $option .= "<option value='$pais_id'>$pais_nombre</option>";
//       }
//   }
  
//   if (count($arrresultado)==0){
//     $option = "<option  value=''>NO EXISTEN PAISES CARGADOS</option>";
//   }

//   if (count($arrresultado)==1){
//     $option = "<option selected='selected' value='$pais_id'>$pais_nombre</option>";
//   } 
  

//   return $option;

// }


function ObtenerListaSexo($sexoseleccionado=null){

  $conexion = new ConexionBd();  
  
  $arrresultado = $conexion->doSelect("sexo_id, sexo_nombre",
    "sexo ",
    "sexo_activo = '1'", null, "sexo_nombre asc");

  $option = "<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

      $sexo_id = utf8_encode($valor["sexo_id"]);  
      $sexo_nombre = utf8_encode($valor["sexo_nombre"]);  

      if ($sexoseleccionado==$sexo_id){
          $option .= "<option selected='selected' value='$sexo_id'>$sexo_nombre</option>";
      }else{
          $option .= "<option value='$sexo_id'>$sexo_nombre</option>";
      }
  }
  
  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN SEXOS CARGADOS</option>";
  }
 
  return $option;

}


function ObtenerListaVehiculos($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else { 
      
     $arrresultado = $conexion->doSelect("vehiculo_id, vehiculo_patente",
        "vehiculo",
        "vehiculo_activo = '1' and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada'", null, "vehiculo_patente asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

        $vehiculo_id = utf8_encode($valor["vehiculo_id"]);
        $vehiculo_patente = utf8_encode($valor["vehiculo_patente"]);        

        if ($idseleccionado==$vehiculo_id){
              $option .= "<option selected='selected' value='$vehiculo_id'>$vehiculo_patente</option>";
          }else{
              $option .= "<option value='$vehiculo_id'>$vehiculo_patente</option>";
          }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN VEHICULOS EN LA COMPAÑIA</option>";
      }

      if ($companiaseleccionada==""){
        $option = "<option  value=''>-- Primero seleccione la Compañia --</option>"; 
      }

  }
  

  return $option;

}

function ObtenerListaUsuarios($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else { 
      
     $arrresultado = $conexion->doSelect("usuario_id, usuario_nombre, usuario_apellido",
        "usuario",
        "usuario_activo = '1' and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada'", null, "usuario_nombre, usuario_apellido asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

        $usuario_id = utf8_encode($valor["usuario_id"]);
        $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
        $usuario_apellido = utf8_encode($valor["usuario_apellido"]);

        if ($idseleccionado==$usuario_id){
              $option .= "<option selected='selected' value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
          }else{
              $option .= "<option value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
          }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN USUARIOS EN COMPAÑIA</option>";
      }

      if ($companiaseleccionada==""){
        $option = "<option  value=''>-- Primero seleccione la Compañia --</option>"; 
      }

      if (count($arrresultado)==1){
        $option = "<option selected='selected' value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
      } 
  }
  

  return $option;

}


function ObtenerListaEmpleados($cuentaseleccionada=null, $companiaseleccionada=null, $idseleccionado =null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
  }else if ($cuentaseleccionada==""){
    $option = "<option  value=''>Seleccione Primero la Compañia</option>";
  }  
  else { 
      
     $arrresultado = $conexion->doSelect("usuario_id, usuario_nombre, usuario_apellido",
        "usuario",
        "usuario_activo = '1' and perfil_id = '7' and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada'", null, "usuario_nombre, usuario_apellido asc");

      $option = "<option value=''>-- Seleccione --</option>";
      foreach($arrresultado as $i=>$valor){

        $usuario_id = utf8_encode($valor["usuario_id"]);
        $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
        $usuario_apellido = utf8_encode($valor["usuario_apellido"]);

        if ($idseleccionado==$usuario_id){
              $option .= "<option selected='selected' value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
          }else{
              $option .= "<option value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
          }

      }
        
      if (count($arrresultado)==0){
        $option = "<option  value=''>NO EXISTEN EMPLEADOS EN COMPAÑIA</option>";
      }

      if ($companiaseleccionada==""){
        $option = "<option  value=''>-- Primero seleccione la Compañia --</option>"; 
      }

      if (count($arrresultado)==1){
        $option = "<option selected='selected' value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
      } 
  }
  

  return $option;

}

// function ObtenerListaClientes($cuentaseleccionada=null, $companiaseleccionada=null, $clienteseleccionado =null){

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
//   if ($cuentaseleccionada==""){
//     $option = "<option  value=''>Seleccione Primero la Cuenta</option>";
//   }else if ($cuentaseleccionada==""){
//     $option = "<option  value=''>Seleccione Primero la Compañia</option>";
//   }  
//   else {
      
//      $arrresultado = $conexion->doSelect("usuario_id, usuario_nombre, usuario_apellido, usuario_whatsapp",
//        "usuario",
//        "usuario_activo = '1' and perfil_id = '4' and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada'", null, "usuario_nombre, usuario_apellido asc");

//       $option = "<option value=''>-- Seleccione --</option>";
//       foreach($arrresultado as $i=>$valor){

//        $usuario_id = utf8_encode($valor["usuario_id"]);
//        $usuario_nombre = utf8_encode($valor["usuario_nombre"]);
//        $usuario_apellido = utf8_encode($valor["usuario_apellido"]);
//         $usuario_whatsapp = utf8_encode($valor["usuario_whatsapp"]);

//         $colocar ="";
//         if ($usuario_nombre!=""){
//           $colocar = "$usuario_nombre $usuario_apellido";
//         }else if ($usuario_whatsapp!=""){
//           $colocar = "+$usuario_whatsapp";
//         }

//        if ($clienteseleccionado==$usuario_id){
//               $option .= "<option selected='selected' value='$usuario_id'>$colocar</option>";
//           }else{
//               $option .= "<option value='$usuario_id'>$colocar</option>";
//           }

//       }
        
//       if (count($arrresultado)==0){
//         $option = "<option  value=''>NO EXISTEN CLIENTES</option>";
//       }

//       /*
//       if (count($arrresultado)==1){
//         $option = "<option selected='selected' value='$usuario_id'>$usuario_nombre $usuario_apellido</option>";
//       } 
//       */
//   }
  

//   return $option;

// }

// function ObtenerSucursalCompanias($cuentaseleccionada=null, $companiaseleccionada=null, $sucursalseleccionada=null, $variassucursales=null){

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
//   if ($cuentaseleccionada==""){
//     $option = "<option  value=''>NO EXISTEN SUCURSALES (CUENTA NO SELECCIONADA)</option>";
//   }else {
      
//       if ($_COOKIE[perfil]=="1"){   
    
//         if ($cuentaseleccionada!=""){
//           $wheresucursal = " and cuenta_id = '$cuentaseleccionada' ";     
//         }

//         if ($companiaseleccionada!=""){
//           $wheresucursal = " and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada' ";     
//         }
    
//       } else {   
  
//         $wheresucursal = " and cuenta_id = '$cuentaseleccionada' and compania_id = '$companiaseleccionada' ";     
    
//       } 

//       foreach ($variassucursales as $key => $value) {    
//         $existesucursalesvarias = 1;
//       }
      
//       $arrresultado = $conexion->doSelect("sucursal_id, sucursal_nombre",
//         "sucursal ",
//         "sucursal_activo = '1' $wheresucursal ", null, "sucursal_nombre asc");

//       $option = "<option value=''>-- Seleccione --</option>";
//       foreach($arrresultado as $i=>$valor){

//           $sucursal_id = utf8_encode($valor["sucursal_id"]);  
//           $sucursal_nombre = utf8_encode($valor["sucursal_nombre"]);  


//           if ($existesucursalesvarias==1){
//             $noesta= 1;
//             foreach ($variassucursales as $key => $value) {    
//               if ($value==$sucursal_id){
//                 $option .= "<option selected='selected' value='$sucursal_id'>$sucursal_nombre</option>";
//                 $noesta = 0;
//               }
//             }

//             if ($noesta==1){
//               $option .= "<option value='$sucursal_id'>$sucursal_nombre</option>";
//             }

//           }else{
//             if ($sucursalseleccionada==$sucursal_id) {
//                 $option .= "<option selected='selected' value='$sucursal_id'>$sucursal_nombre</option>";
//             }else{
//                 $option .= "<option value='$sucursal_id'>$sucursal_nombre</option>";
//             }
//           }
//       }
        
//       if (count($arrresultado)==0){
//         $option = "<option  value=''>NO EXISTEN SUCURSALES</option>";
//       }

//       if (count($arrresultado)==1){
//         $option = "<option selected='selected' value='$sucursal_id'>$sucursal_nombre</option>";
//       } 
//   }
  

//   return $option;

// }


// function ObtenerListaCompaniasRel($cuentaseleccionada=null, $companiaseleccionada=null, $companianegocio=null){

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
//   if ($_COOKIE[perfil]=="1"){  
    
    
//     if ($cuentaseleccionada!=""){
//       $wherecompania = " and cuenta_id = '$cuentaseleccionada' ";     
//     } 
    
//   } else if ($_COOKIE[perfil]=="2"){   
  
//     $wherecompania = " and cuenta_id = '$_COOKIE[idcuenta]' ";     
    
//   } else {
  
//     $wherecompania = " and cuenta_id = '$_COOKIE[idcuenta]' and compania_id = '$_COOKIE[idcompania]' ";     
    
//   }

  
//   $arrresultado = $conexion->doSelect("compania_id, compania_nombre",
//     "compania ",
//     "compania_activo = '1' and compania_idrel  = '$companiaseleccionada' $wherecompania", null, "compania_nombre asc");

//   $option = "<option value=''>-- Seleccione --</option>";
//   foreach($arrresultado as $i=>$valor){

//       $compania_id = utf8_encode($valor["compania_id"]);  
//       $compania_nombre = utf8_encode($valor["compania_nombre"]);  

//       if ($companianegocio==$compania_id) {
//           $option .= "<option selected='selected' value='$compania_id'>$compania_nombre</option>";
//       }else{
//           $option .= "<option value='$compania_id'>$compania_nombre</option>";
//       }
//   }

//   if (count($arrresultado)==0){
//     $option = "<option  value=''>NO EXISTEN COMPAÑIAS</option>";
//   }

//   if (count($arrresultado)==1){
//     //$option = "<option selected='selected' value='$compania_id'>$compania_nombre</option>";
//   }


//   return $option;

// }



function ObtenerListaCompaniasCondominio($cuentaseleccionada=null, $companiaseleccionada=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($_COOKIE[perfil]=="1"){  
    
    
    if ($cuentaseleccionada!=""){
      $wherecompania = " and cuenta_id = '$cuentaseleccionada' ";     
    } 
    
  } else if ($_COOKIE[perfil]=="2"){   
  
    $wherecompania = " and cuenta_id = '$_COOKIE[idcuenta]' ";     
    
  } else {
  
    $wherecompania = " and cuenta_id = '$_COOKIE[idcuenta]' and compania_id = '$_COOKIE[idcompania]' ";     
    
  }

  $wherecompania = " and cuenta_id = '$cuentaseleccionada' ";


  
  $arrresultado = $conexion->doSelect("compania_id, compania_nombre",
    "compania ",
    "compania_activo = '1' and compania_idrel is null $wherecompania", null, "compania_nombre asc");

  $option = "<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

      $compania_id = utf8_encode($valor["compania_id"]);  
      $compania_nombre = utf8_encode($valor["compania_nombre"]);  

      if ($companiaseleccionada==$compania_id) {
          $option .= "<option selected='selected' value='$compania_id'>$compania_nombre</option>";
      }else{
          $option .= "<option value='$compania_id'>$compania_nombre</option>";
      }
  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN COMPAÑIAS</option>";
  }

  if (count($arrresultado)==1){
    //$option = "<option selected='selected' value='$compania_id'>$compania_nombre</option>";
  }

  return $option;

}

// function ObtenerListaCompanias($cuentaseleccionada=null, $companiaseleccionada=null){

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
//   if ($_COOKIE[perfil]=="1"){   
    
    
//     if ($cuentaseleccionada!=""){
//       $wherecompania = " and cuenta_id = '$cuentaseleccionada' ";     
//     } 
    
//   } else if ($_COOKIE[perfil]=="2"){  
  
//     $wherecompania = " and cuenta_id = '$_COOKIE[idcuenta]' ";     
    
//   } else {
  
//     $wherecompania = " and cuenta_id = '$_COOKIE[idcuenta]' and compania_id = '$_COOKIE[idcompania]' ";     
    
//   }

  
//   $arrresultado = $conexion->doSelect("compania_id, compania_nombre",
//     "compania ",
//     "compania_activo = '1' and compania_idrel is null $wherecompania", null, "compania_nombre asc");

//   $option = "<option value=''>-- Seleccione --</option>";
//   foreach($arrresultado as $i=>$valor){

//       $compania_id = utf8_encode($valor["compania_id"]);  
//       $compania_nombre = utf8_encode($valor["compania_nombre"]);  

//       if ($companiaseleccionada==$compania_id) {
//           $option .= "<option selected='selected' value='$compania_id'>$compania_nombre</option>";
//       }else{
//           $option .= "<option value='$compania_id'>$compania_nombre</option>";
//       }
//   }

//   if (count($arrresultado)==0){
//     $option = "<option  value=''>NO EXISTEN COMPAÑIAS</option>";
//   }

//   if (count($arrresultado)==1){
//     //$option = "<option selected='selected' value='$compania_id'>$compania_nombre</option>";
//   }

//   return $option;

// }


// function ObtenerListaCuentas($cuentaseleccionada=null){

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
//   if ($_COOKIE[perfil]=="1"){  
//   }
//   else if ($_COOKIE[perfil]=="2"){  
//     $wherecuenta = " and usuario.usuario_id = '$_COOKIE[iniuser]' ";   
//   } 
//   else {   
//    $wherecuenta = " and usuario.cuenta_id = '$_COOKIE[idcuenta]' ";   
//   } 

//   /*
//    $arrresultado = $conexion->doSelect("usuario_id, usuario_codigo,  usuario_nombre, usuario_apellido",
//     "usuario
//       inner join perfil on usuario.perfil_id = perfil.perfil_id
//     ",
//     "usuario_activo = '1' and ( perfil.perfil_id = '2' or perfil.perfil_idorig = '2' ) $wherecuenta ", null, "usuario_nombre, usuario_apellido asc");

//   */

//   $arrresultado = $conexion->doSelect("usuario_id, usuario_codigo,  usuario_nombre, usuario_apellido",
//    "usuario
//       inner join perfil on usuario.perfil_id = perfil.perfil_id
//     ",
//    "usuario_activo = '1' and ( perfil.perfil_id = '2' or perfil.perfil_idorig = '2' )  $wherecuenta ", null, "usuario_nombre, usuario_apellido asc");


//   $option = "<option value=''>-- Seleccione --</option>";
//   foreach($arrresultado as $i=>$valor){

//    $cuenta_usuario_id = utf8_encode($valor["usuario_id"]);
//    $cuenta_usuario_nombre = utf8_encode($valor["usuario_nombre"]);
//    $cuenta_usuario_apellido = utf8_encode($valor["usuario_apellido"]);
//    $cuenta_usuario_codigo = utf8_encode($valor["usuario_codigo"]);
    
//     $cuentanombremostrar = $cuenta_usuario_nombre." ".$cuenta_usuario_apellido."";

//     if ($cuentaseleccionada==$cuenta_usuario_id){
//         $option .= "<option selected='selected' value='$cuenta_usuario_id'>$cuentanombremostrar</option>";
//     }else{
//         $option .= "<option value='$cuenta_usuario_id'>$cuentanombremostrar</option>";
//     }
//   }
  

//   if (count($arrresultado)==0){
//     $option = "<option  value=''>NO EXISTEN CUENTAS</option>";
//   }

//   if (count($arrresultado)==1){
//     $option = "<option selected='selected' value='$cuenta_usuario_id'>$cuentanombremostrar</option>";
//   }

//   return $option;

// }

function CompaniaSeleccionada($getidcompaniaselect=null, $geturlcompania_id=null){

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  $_COOKIE[iniuser] = $_COOKIE[iniuser];
  
  
  
  if ($getidcompaniaselect!=""){$companiacolocar = $getidcompaniaselect;}
  if ($geturlcompania_id!=""){$companiacolocar = $geturlcompania_id;}

  //echo "companiacolocar:$companiacolocar";
  
  if ($_COOKIE[perfil]=="1"){ // Si es admin admin se asigna la que viene, sino se asigna el de usuario conectado
    
    if ($companiacolocar==""){
      $companiaseleccionada = $_COOKIE[idcompania];
    }else{
      $companiaseleccionada = $companiacolocar;
    }    

  }else if($_COOKIE[perfil]=="2") {

    if ($companiacolocar==""){
      /*
      $conexion = new ConexionBd();  
      $arrresultado = $conexion->doSelect("compania_id","compania","cuenta_id= '$_COOKIE[idcuenta]'");
      foreach($arrresultado as $i=>$valor){
        $compania_id = utf8_encode($valor["compania_id"]); 

        $companiacolocar = $compania_id;     
      }
      */
    }

    $companiaseleccionada = $companiacolocar;    
    
  }  else {

    $companiaseleccionada = $_COOKIE[idcompania];    
    
  }     

  if ($companiaseleccionada==""){
    $companiaseleccionada = $_COOKIE[idcompania];
  }

  return $companiaseleccionada;  
}


function CuentaSeleccionada($getidcuentaselect=null, $geturlcuenta_id=null){

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  $_COOKIE[iniuser] = $_COOKIE[iniuser];
  
    
  if ($getidcuentaselect!=""){$cuentacolocar = $getidcuentaselect;}
  if ($geturlcuenta_id!=""){$cuentacolocar = $geturlcuenta_id;}
  
  if ($_COOKIE[perfil]=="1"){ // Si es admin admin se asigna la que viene, sino se asigna el de usuario conectado
    
    if ($cuentacolocar==""){
      $cuentaseleccionada = $_COOKIE[idcuenta];
    }else{
      $cuentaseleccionada = $cuentacolocar;
    }   
    
  }else {

    $cuentaseleccionada = $_COOKIE[idcuenta];    
    
  }       

  return $cuentaseleccionada;
}



function ObtenerListaRelMoneda($tipolista_id=null, $cuenta=null, $compania=null, $elementoid=null){

  $conexion = new ConexionBd();  

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];


  $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuentarel_id, listacuenta_nombre, listacuenta_id ",
        "lista 

            inner join listacuentarel on listacuentarel.lista_id = lista.lista_id and listacuentarel.cuenta_id ='$cuenta' 
            and listacuentarel.compania_id = '$compania' and listacuentarel.tipolista_id = '$tipolista_id' and listacuentarel_activo = '1'
          
            left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
            and listacuenta.compania_id = '$compania' and listacuenta_activo = '1'
           
          ",
        "lista_activo = '1' and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "lista_nombre asc");

  $option = "<option value='0'>-- Seleccione --</option>";

  if (count($arrresultado)==0){

     $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuentarel_id, listacuenta_nombre, listacuenta_id ",
        "lista 

            left join listacuentarel on listacuentarel.lista_id = lista.lista_id and listacuentarel.cuenta_id ='$cuenta' 
            and listacuentarel.compania_id = '$compania' and listacuentarel.tipolista_id = '$tipolista_id' and listacuentarel_activo = '1'
          
            left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
            and listacuenta.compania_id = '$compania' and listacuenta_activo = '1'
           
          ",
        "lista_activo = '1' and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "lista_nombre asc");  

  }

  $option = "<option value='0'>-- Seleccione --</option>";

  foreach($arrresultado as $i=>$valor){

    $lista_id = utf8_encode($valor["lista_id"]);  
    $lista_nombre = utf8_encode($valor["lista_nombre"]);  
    $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
    $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
    $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
    $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  
    $listacuentarel_id = utf8_encode($valor["listacuentarel_id"]);  

    $nombrecolocar = $lista_nombre;

    if ($listacuenta_id!=""){
      $nombrecolocar = $listacuenta_nombre;
    }

    if ($listacuentarel_id!=""){
      if ($elementoid==$lista_id){
          $option .= "<option selected='selected' value='$lista_id'>$nombrecolocar</option>";
      }else{
          $option .= "<option value='$lista_id'>$nombrecolocar</option>";
      }   
    }else{
      if ($elementoid==$lista_id){
          $option .= "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
      }else{
          $option .= "<option value='$lista_id'>$lista_nombre</option>";
      }    
    } 

  }

  if (count($arrresultado)==0){
    $option = "<option  value=''>NO EXISTEN VALORES</option>";
  }

  if (count($arrresultado)==1){
    $option = "<option selected='selected' value='$lista_id'>$nombrecolocar</option>";
  }

  return $option;

}


// function ObtenerDefectoListaConfig($tipolista_id=null, $cuenta=null, $compania=null){

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];

//   $arrresultado = $conexion->doSelect("tipolista.tipolista_id, tipolista_nombre, tipolista_descrip, 
//     tipodato_id, listaconfig_valoruno, listaconfig_valordos, listaconfig_valortres, listaconfig_activo,
//     tipolista_idlistarel, tipolista_multiple
//   ",
//     "
//     tipolista
//       inner join listaconfig on tipolista.tipolista_id = listaconfig.tipolista_id and listaconfig_activo = '1' 
//                 and listaconfig.cuenta_id = '$cuenta' and listaconfig.compania_id = '$compania'
//     ",
//     "tipolista_activo = '1' and tipolista.tipolista_config = '1' and tipolista.tipolista_id = '$tipolista_id' ", null, "tipolista_orden asc");

//   foreach($arrresultado as $i=>$valor){
      
//     $tipolista_id = utf8_encode($valor["tipolista_id"]);
//     $tipolista_nombre = utf8_encode($valor["tipolista_nombre"]);
//     $tipolista_descrip = utf8_encode($valor["tipolista_descrip"]);  
//     $t_tipodato_id = utf8_encode($valor["tipodato_id"]);
//     $lista_orden = utf8_encode($valor["lista_orden"]);
//     $lista_activo = utf8_encode($valor["lista_activo"]);
//     $listaconfig_valoruno = utf8_encode($valor["listaconfig_valoruno"]);
//     $listaconfig_valordos = utf8_encode($valor["listaconfig_valordos"]);
//     $listaconfig_valortres = utf8_encode($valor["listaconfig_valortres"]);
//     $tipolista_idlistarel = utf8_encode($valor["tipolista_idlistarel"]);
//     $tipolista_multiple = utf8_encode($valor["tipolista_multiple"]);

//   }

//   return $listaconfig_valoruno;


// }


// function ObtenerListaRel($tipolista_id=null, $cuenta=null, $compania=null, $elementoid=null){

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];


//   $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuentarel_id, listacuenta_nombre, listacuenta_id ",
//         "lista 
//             inner join listacuentarel on listacuentarel.lista_id = lista.lista_id and listacuentarel.cuenta_id ='$cuenta' 
//             and listacuentarel.compania_id = '$compania' and listacuentarel.tipolista_id = '$tipolista_id' and listacuentarel_activo = '1'

//             left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
//             and listacuenta.compania_id = '$compania' and listacuenta_activo = '1'
            
//           ",
//         "lista_activo = '1' and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "lista_orden asc");

//   if (count($arrresultado)==0){

//      $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuentarel_id, listacuenta_nombre, listacuenta_id ",
//         "lista 

//             left join listacuentarel on listacuentarel.lista_id = lista.lista_id and listacuentarel.cuenta_id ='$cuenta' 
//             and listacuentarel.compania_id = '$compania' and listacuentarel.tipolista_id = '$tipolista_id' and listacuentarel_activo = '1'
          
//             left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
//             and listacuenta.compania_id = '$compania' and listacuenta_activo = '1'
           
//           ",
//         "lista_activo = '1' and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "lista_orden asc");  

//   }


//   $option = "<option value='0'>-- Seleccione --</option>";

//   foreach($arrresultado as $i=>$valor){

//     $lista_id = utf8_encode($valor["lista_id"]);  
//     $lista_nombre = utf8_encode($valor["lista_nombre"]);  
//     $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
//     $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
//     $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
//     $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  
//     $listacuentarel_id = utf8_encode($valor["listacuentarel_id"]);  

//     $nombrecolocar = $lista_nombre;

//     if ($listacuenta_id!=""){
//       $nombrecolocar = $listacuenta_nombre;
//     }

//     if ($listacuentarel_id!=""){
//       if ($elementoid==$lista_id){
//           $option .= "<option selected='selected' value='$lista_id'>$nombrecolocar</option>";
//       }else{
//           $option .= "<option value='$lista_id'>$nombrecolocar</option>";
//       }   
//     }else{
//       if ($elementoid==$lista_id){
//           $option .= "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
//       }else{
//           $option .= "<option value='$lista_id'>$lista_nombre</option>";
//       }    
//     } 

//   }

//   if (count($arrresultado)==0){
//     $option = "<option  value=''>NO EXISTEN VALORES</option>";
//   }

//   if (count($arrresultado)==1){
//     $option = "<option selected='selected' value='$lista_id'>$nombrecolocar</option>";
//   }

//   return $option;

// }


// function ObtenerListaMultiple($tipolista_id=null, $cuenta=null, $compania=null){

//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];

//   $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuentarel_id, listacuenta_nombre, listacuenta_id ",
//       "lista 
        
//         left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
//         and listacuenta.compania_id = '$compania' and listacuenta_activo = '1'

//         left join listacuentarel on listacuentarel.lista_id = lista.lista_id and listacuentarel.cuenta_id ='$cuenta' 
//         and listacuentarel.compania_id = '$compania' and listacuentarel.tipolista_id = '$tipolista_id' and listacuentarel_activo = '1'
//       ",
//       "lista_activo = '1' and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "lista_nombre asc");

//   foreach($arrresultado as $i=>$valor){

//     $lista_id = utf8_encode($valor["lista_id"]);  
//     $lista_nombre = utf8_encode($valor["lista_nombre"]);  
//     $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
//     $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
//     $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
//     $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  
//     $listacuentarel_id = utf8_encode($valor["listacuentarel_id"]);  

//     $nombrecolocar = $lista_nombre;

//     if ($listacuenta_id!=""){
//       $nombrecolocar = $listacuenta_nombre;
//     }

//     if ($listacuentarel_id!=""){
//       $option .= "<option selected='selected' value='$lista_id'>$nombrecolocar</option>";
//     }else{
//       $option .= "<option value='$lista_id'>$nombrecolocar</option>";
//     }
//   }

//   $option = "
//     <select class='form-control select2' id='$tipolista_id' name='valoresmultiple".$tipolista_id."[]' multiple='multiple' style='width:100%' >
//       $option
//     </select>
//   ";


//   return $option;

// }



// function ObtenerLista($tipolista_id=null, $cuenta=null, $compania=null, $elementoid=null, $ordenar=null, $agregardespues=null, $listaid_rel=null){

//   if ($ordenar=="entero"){
//     $orderby = "CAST(lista_nombre AS UNSIGNED)";
//   }else{
//     $orderby = "listacuenta_nombre";
//   }



//   $conexion = new ConexionBd();  

//   session_start();
//   $_COOKIE[perfil] = $_COOKIE[perfil];
//   $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
//   $_COOKIE[idcompania] = $_COOKIE[idcompania];

//   $option = "<option value=''>-- Seleccione --</option>";

//   if ($listaid_rel!=""){
//     $wherelistarel = " and lista.lista_idrel = '$listaid_rel' ";
//   }

//   /*
//      inner join listacuentarel on listacuentarel.lista_id = lista.lista_id and listacuentarel.cuenta_id ='$cuenta' 
//                 and listacuentarel.compania_id = '$compania' and listacuentarel.tipolista_id = '$tipolista_id' 
//                 and listacuentarel_activo = '1'
//   */


//   if ($cuenta!="" ){
    
//       $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, lista_activo, 
//         listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
//             "lista                
//                 left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
//                 and listacuenta.compania_id = '$compania' 
//             ",
//             "lista_activo = '1' and lista.tipolista_id = '$tipolista_id' $wherelistarel  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "$orderby asc");
   

//       if (count($arrresultado)==0){

//          $arrresultado = $conexion->doSelect("lista.lista_id, lista_nombre, listacuenta_id, 
//           listacuenta_activo, listacuenta_nombre, listacuenta_nombredos",
//             "lista                 
//                 left join listacuenta on listacuenta.lista_id = lista.lista_id and listacuenta.cuenta_id ='$cuenta' 
//                 and listacuenta.compania_id = '$compania' 
//             ",
//             "lista_activo = '1' $wherelistarel and lista.tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and lista.cuenta_id ='$cuenta' and lista.compania_id = '$compania'))  ", null, "$orderby asc");


//       }

    
//     foreach($arrresultado as $i=>$valor){

//       $lista_id = utf8_encode($valor["lista_id"]);  
//       $lista_nombre = utf8_encode($valor["lista_nombre"]);  
//       $listacuenta_id = utf8_encode($valor["listacuenta_id"]);  
//       $listacuenta_nombre = utf8_encode($valor["listacuenta_nombre"]);  
//       $listacuenta_nombredos = utf8_encode($valor["listacuenta_nombredos"]);  
//       $listacuenta_activo = utf8_encode($valor["listacuenta_activo"]);  

//       if ($listacuenta_id!=""){
//         if ($listacuenta_activo=="1"){
//           if ($elementoid==$lista_id){
//               $option .= "<option selected='selected' value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
//           }else{
//               $option .= "<option value='$lista_id'>$listacuenta_nombre$agregardespues</option>";
//           }    
//         }
//       }else{
//         if ($elementoid==$lista_id){
//             $option .= "<option selected='selected' value='$lista_id'>$lista_nombre$agregardespues</option>";
//         }else{
//             $option .= "<option value='$lista_id'>$lista_nombre$agregardespues</option>";
//         }    
//       }  
//     }
//   }
  
//   if (count($arrresultado)==0 && $compania==""){
//     $option = "<option  value=''>Seleccione Primero la Compañia</option>";
//   }else if (count($arrresultado)==0){
//     $option = "<option  value=''>NO EXISTEN VALORES</option>";
//   }

//   if (count($arrresultado)==1){
//     $option = "<option selected='selected' value='$lista_id'>$lista_nombre $agregardespues</option>";
//   }

 

//   /*
  
//   $arrresultado = $conexion->doSelect("lista_id, lista_nombre","lista ",
//             "lista_activo = '1' and tipolista_id = '$tipolista_id'  and ((lista_ppal = '1') or (lista_ppal = '0' and cuenta_id ='$cuenta' and compania_id = '$compania'))  ", null, "lista_nombre asc");

//   $option = "<option value='0'>-- Seleccione --</option>";
//   foreach($arrresultado as $i=>$valor){

//     $lista_id = utf8_encode($valor["lista_id"]);  
//     $lista_nombre = utf8_encode($valor["lista_nombre"]);  

//     if ($elementoid==$lista_id){
//         $option .= "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
//     }else{
//         $option .= "<option value='$lista_id'>$lista_nombre</option>";
//     }
//   }

//   if (count($arrresultado)==1){
//     $option = "<option selected='selected' value='$lista_id'>$lista_nombre</option>";
//   }

//   */

//   return $option;

// }


function ObtenerNombreArchivo(){

  /*
  $link = $_SERVER['PHP_SELF'];
  $link_array = explode('/',$link);
  $url = end($link_array);
  */

  $url = $_GET["url"];

  //echo $url;
  //exit();

  return $url;
}


function VerificarPermisosPerfilRelacionado($modulo_id=null, $auditoria_id=null){

  $GLOBALS['P_Acceso'] ="";

  $conexion = new ConexionBd();

  $fechaactual = formatoFechaHoraBd();  

  if ($_COOKIE[perfil]>"2"){
    $wherecompaniacolocarrrrrr = " and perfilpermiso.compania_id = '$_COOKIE[idcompania]' ";
  }

  session_start();

    //echo "modulo_id:".$modulo_id;
    //exit();

  $arrresultado = $conexion->doSelect("count(perfilpermiso_id) as total",
    "perfilpermiso",
    "perfilpermiso.perfil_id = '$_COOKIE[perfilactual]' and perfilpermiso.cuenta_id = '$_COOKIE[idcuenta]' $wherecompaniacolocar ");
  $total = 0;
  foreach($arrresultado as $i=>$valor){  
    $total = utf8_encode($valor["total"]);
  }

  if ($total==0){ // Si NO tiene permisos personalizados la empresa para ese perfil se toma en cuenta los principales
    $cuentaidcolocar = "2";
    $companiaidcolocar = "1";
  }else{
    $cuentaidcolocar = $_COOKIE[idcuenta];
    $companiaidcolocar = $_COOKIE[idcompania];
  }

  if ($_COOKIE[perfil]>2){
    $wherecompaniaaaaaaaaaaaaa = " and perfilpermiso.compania_id = '$companiaidcolocar' ";
  }


  $tienepermisos = 0;

  $arrresultado = $conexion->doSelect("perfilpermiso_id, perfilpermiso.perfil_id, perfilpermiso.modulo_id, 
    perfilpermiso.cuenta_id, perfilpermiso.compania_id, perfilpermiso_create, perfilpermiso_read, 
    perfilpermiso_update, perfilpermiso_delete, perfilpermiso_all, perfilpermiso_usuario, perfilpermiso_activo, 
    perfilpermiso_eliminado, perfilpermiso_fechareg, perfilpermiso.usuario_idreg, perfilpermiso.tipopermiso_id, 
    modulo_padre, modulo_defecto, modulo_sistema, modulo_relmodulo
    ",
    "perfilpermiso 
      inner join modulo on perfilpermiso.modulo_id = modulo.modulo_id      
    ",
    "perfilpermiso_activo = '1' and perfilpermiso.modulo_id = '$modulo_id' 
      and perfilpermiso.perfil_id = '$_COOKIE[perfilactual]'
      and perfilpermiso.cuenta_id = '$cuentaidcolocar'
      $wherecompania
    ");

  
  foreach($arrresultado as $i=>$valor){



    $perfilpermiso_create = utf8_encode($valor["perfilpermiso_create"]);  
    $perfilpermiso_read = utf8_encode($valor["perfilpermiso_read"]);  
    $perfilpermiso_update = utf8_encode($valor["perfilpermiso_update"]);  
    $perfilpermiso_delete = utf8_encode($valor["perfilpermiso_delete"]);  
    $perfilpermiso_all = utf8_encode($valor["perfilpermiso_all"]);
    $perfilpermiso_usuario = utf8_encode($valor["perfilpermiso_usuario"]);

    $modulo_padre = utf8_encode($valor["modulo_padre"]);
    $modulo_defecto = utf8_encode($valor["modulo_defecto"]); 
    $modulo_sistema = utf8_encode($valor["modulo_sistema"]);
    $modulo_relmodulo = utf8_encode($valor["modulo_relmodulo"]);
    
    $GLOBALS['P_Tod'] = $perfilpermiso_all;

    if ($perfilpermiso_all=="1"){
      $GLOBALS['P_Ins'] = "1";
      $GLOBALS['P_Lee'] = "1";
      $GLOBALS['P_Mod'] = "1";
      $GLOBALS['P_Eli'] = "1";      
    }else{
      $GLOBALS['P_Ins'] = $perfilpermiso_create;
      $GLOBALS['P_Lee'] = $perfilpermiso_read;;
      $GLOBALS['P_Mod'] = $perfilpermiso_update;;
      $GLOBALS['P_Eli'] = $perfilpermiso_delete;
      $GLOBALS['P_User'] = $perfilpermiso_usuario;
    }

    $GLOBALS['P_User'] = $perfilpermiso_usuario;      
    
    $GLOBALS['P_Acceso'] ="1";
  }    

  if ($urlmodulo==""){
    $GLOBALS['P_Acceso'] ="1";
  }

  if ($urlmodulo=="noacceso"){
    $GLOBALS['P_Acceso'] ="1";
  }

  if ($urlmodulo=="index"){
    $GLOBALS['P_Acceso'] ="1";
  }

  if ($urlmodulo=="registrar"){
    $GLOBALS['P_Acceso'] ="1";
  }

  if ($urlmodulo=="generarclave"){
    $GLOBALS['P_Acceso'] ="1";
  }

  if ($urlmodulo=="loadinfomodal"){
    $GLOBALS['P_Acceso'] ="1";
  }


  $auditoriadet_create = $GLOBALS['P_Ins'];
  $auditoriadet_read = $GLOBALS['P_Lee'];
  $auditoriadet_update = $GLOBALS['P_Mod'];
  $auditoriadet_delete = $GLOBALS['P_Eli'];
  $auditoriadet_all = $GLOBALS['P_Tod'];
  $auditoriadet_acceso = $GLOBALS['P_Acceso'];
  $auditoriadet_usuario = $GLOBALS['P_User'];

  if ($auditoriadet_create==""){$auditoriadet_create=0;}
  if ($auditoriadet_read==""){$auditoriadet_read=0;}
  if ($auditoriadet_update==""){$auditoriadet_update=0;}
  if ($auditoriadet_delete==""){$auditoriadet_delete=0;}
  if ($auditoriadet_all==""){$auditoriadet_all=0;}
  if ($auditoriadet_acceso==""){$auditoriadet_acceso=0;}
  if ($auditoriadet_usuario==""){$auditoriadet_usuario=0;}


  $resultado = $conexion->doInsert("
  auditoriadetalle
    (auditoria_id, auditoriadet_create, auditoriadet_read, auditoriadet_update, 
    auditoriadet_delete, auditoriadet_all, auditoriadet_usuario, auditoriadet_acceso, auditoriadet_fechareg, 
    auditoriadet_activo, auditoriadet_eliminado) 
  ",
  "'$auditoria_id', '$auditoriadet_create', '$auditoriadet_read', '$auditoriadet_update',
  '$auditoriadet_delete', '$auditoriadet_all', '$auditoriadet_usuario', '$auditoriadet_acceso', '$fechaactual',
  '1', '0'");


  


}


function VerificarPermisosPerfil(){

  $urlmodulo = ObtenerNombreArchivo();

  $GLOBALS['P_Acceso'] ="";

  $conexion = new ConexionBd();

  session_start();

  


  $arrresultado = $conexion->doSelect("modulo_relmodulo, modulo_padre, modulo_defecto, modulo_sistema, tipomodulo_id, modulo_id, modulo_multiplemenu","modulo","modulo_activo = '1' and modulo_url = '$urlmodulo' ");  
  foreach($arrresultado as $i=>$valor){

    $modulo_id = utf8_encode($valor["modulo_id"]);
    $modulo_relmodulo = utf8_encode($valor["modulo_relmodulo"]);
    $modulo_defecto = utf8_encode($valor["modulo_defecto"]);
    $modulo_sistema = utf8_encode($valor["modulo_sistema"]);
    $tipomodulo_id = utf8_encode($valor["tipomodulo_id"]);
    $modulo_multiplemenu = utf8_encode($valor["modulo_multiplemenu"]);
    $modulo_padre = utf8_encode($valor["modulo_padre"]);

    if ($modulo_padre=="1"){
      $modulo_relmodulo = "";
    }
 
    if ($modulo_multiplemenu=="1"){
      if ($tipomodulo_id=="1"){     
        $_SESSION[urlmodulo] = $urlmodulo;    
      }          
    } 
    if ($tipomodulo_id=="1"){     
      $_SESSION[urlmodulo] = $urlmodulo;    
    }

    if ($tipomodulo_id=="5"){
       $_SESSION[urlmodulo] = "";
    }   
  }  

  $modulo_idpasar = $modulo_id;

  $iniuser = $_COOKIE[iniuser];
  if ($iniuser==""){$iniuser = 0;}
  if ($modulo_idpasar==""){$modulo_idpasar = 0;}
  $fechaactual = formatoFechaHoraBd();    

  // Insertar Auditoria
  $auditoria_id = 0;

  $resultado = $conexion->doInsert("
  auditoria
  (usuario_id, modulo_id, auditoria_fechareg, auditoria_activo, auditoria_eliminado)
  ",
  "'$iniuser', '$modulo_idpasar', '$fechaactual', '1','0'");

  $arrresultado2 = $conexion->doSelect("max(auditoria_id) as auditoria_id","auditoria");
  if (count($arrresultado2)>0){
    foreach($arrresultado2 as $i=>$valor){
      $auditoria_id = ($valor["auditoria_id"]);
    }
  }


  if ($modulo_defecto=="1"){
      $GLOBALS['P_Ins'] = "1";
      $GLOBALS['P_Lee'] = "1";
      $GLOBALS['P_Mod'] = "1";
      $GLOBALS['P_Eli'] = "1";
      $GLOBALS['P_User'] = "";
      $GLOBALS['P_Acceso'] ="1";  

    }

  if (($modulo_defecto=="1" || $modulo_sistema == "1") && ($_COOKIE[perfil]=="1") ){
    if ($modulo_sistema=="1" && $_COOKIE[perfil]=="1"){
      $GLOBALS['P_Ins'] = "1";
      $GLOBALS['P_Lee'] = "1";
      $GLOBALS['P_Mod'] = "1";
      $GLOBALS['P_Eli'] = "1";
      $GLOBALS['P_Acceso'] ="1";  
      $GLOBALS['P_User'] = "";

      $auditoriadet_create = 1;
      $auditoriadet_read = 1;
      $auditoriadet_update = 1;
      $auditoriadet_delete = 1;
      $auditoriadet_all = 0;
      $auditoriadet_acceso = 1;
      $auditoriadet_usuario = 0;


      $resultado = $conexion->doInsert("
      auditoriadetalle
        (auditoria_id, auditoriadet_create, auditoriadet_read, auditoriadet_update, 
        auditoriadet_delete, auditoriadet_all, auditoriadet_usuario, auditoriadet_acceso, auditoriadet_fechareg, 
        auditoriadet_activo, auditoriadet_eliminado) 
      ",
      "'$auditoria_id', '$auditoriadet_create', '$auditoriadet_read', '$auditoriadet_update',
      '$auditoriadet_delete', '$auditoriadet_all', '$auditoriadet_usuario', '$auditoriadet_acceso', '$fechaactual',
      '1', '0'");

    
    }
    
  }
  else if ($modulo_relmodulo!=""){

    VerificarPermisosPerfilRelacionado($modulo_relmodulo, $auditoria_id);
  }else{

   

    
    $tienepermisos = 0;

    if ($_COOKIE[perfil]>"2"){
      $wherecompaniacolocar = " and perfilpermiso.compania_id = '$_COOKIE[idcompania]' ";
    }



    $arrresultado = $conexion->doSelect("count(perfilpermiso_id) as total",
      "perfilpermiso",
      "perfilpermiso.perfil_id = '$_COOKIE[perfilactual]' and perfilpermiso.cuenta_id = '$_COOKIE[idcuenta]' $wherecompaniacolocarrrrr ");
    $total = 0;
    foreach($arrresultado as $i=>$valor){  
      $total = utf8_encode($valor["total"]);
    }
    /*

    echo "perfilactual:".$_COOKIE[perfilactual];
    echo "idcuenta:".$_COOKIE[idcuenta];
    echo "idcompania:".$_COOKIE[idcompania];
    echo "total:".$total;
    exit();
  */

    if ($total==0){ // Si NO tiene permisos personalizados la empresa para ese perfil se toma en cuenta los principales
      $cuentaidcolocar = "2";
      $companiaidcolocar = "1";
    }else{
      $cuentaidcolocar = $_COOKIE[idcuenta];
      $companiaidcolocar = $_COOKIE[idcompania];
    }

    if ($_COOKIE[perfil]>2){
      $wherecompaniaaaaaaaa = " and perfilpermiso.compania_id = '$companiaidcolocar' ";
    }
    /*
    echo "cuentaidcolocar:".$cuentaidcolocar;
    exit();
*/
    /*
    echo "perfilactual:". $_COOKIE[perfilactual];
    echo "<br>";
    echo "perfil:". $_COOKIE[perfil];
    exit();
    //echo "modulo2_id:".$modulo_id;
    //exit();
    */

    $arrresultado = $conexion->doSelect("perfilpermiso_id, perfilpermiso.perfil_id, perfilpermiso.modulo_id, 
      perfilpermiso.cuenta_id, perfilpermiso.compania_id, perfilpermiso_create, perfilpermiso_read, 
      perfilpermiso_update, perfilpermiso_delete, perfilpermiso_all, perfilpermiso_usuario, perfilpermiso_activo, 
      perfilpermiso_eliminado, perfilpermiso_fechareg, perfilpermiso.usuario_idreg, perfilpermiso.tipopermiso_id, 
      modulo_padre, modulo_defecto, modulo_sistema, modulo_relmodulo
      ",
      "perfilpermiso 
        inner join modulo on perfilpermiso.modulo_id = modulo.modulo_id      
      ",
      "perfilpermiso_activo = '1' and modulo.modulo_id = '$modulo_id' 
      and perfilpermiso.perfil_id = '$_COOKIE[perfilactual]' 
      and perfilpermiso.cuenta_id = '$cuentaidcolocar'
      $wherecompania
    ");   

     //echo "perfilactual:".$_COOKIE[perfilactual];
    //exit();

    //print_r($arrresultado);
    //print("<pre>".print_r($arrresultado,true)."</pre>");
    //exit();


  //echo "cuentaidcolocar: $cuentaidcolocar";    
    foreach($arrresultado as $i=>$valor){

      //echo "entra";

      $perfilpermiso_create = utf8_encode($valor["perfilpermiso_create"]);  
      $perfilpermiso_read = utf8_encode($valor["perfilpermiso_read"]);  
      $perfilpermiso_update = utf8_encode($valor["perfilpermiso_update"]);  
      $perfilpermiso_delete = utf8_encode($valor["perfilpermiso_delete"]);  
      $perfilpermiso_all = utf8_encode($valor["perfilpermiso_all"]);
      $perfilpermiso_usuario = utf8_encode($valor["perfilpermiso_usuario"]);

      $modulo_padre = utf8_encode($valor["modulo_padre"]);
      $modulo_defecto = utf8_encode($valor["modulo_defecto"]); 
      $modulo_sistema = utf8_encode($valor["modulo_sistema"]);
      $modulo_relmodulo = utf8_encode($valor["modulo_relmodulo"]);

      $GLOBALS['P_Tod'] = $perfilpermiso_all;

      if ($perfilpermiso_all=="1"){
        $GLOBALS['P_Ins'] = "1";
        $GLOBALS['P_Lee'] = "1";
        $GLOBALS['P_Mod'] = "1";
        $GLOBALS['P_Eli'] = "1";        

      }else{
        $GLOBALS['P_Ins'] = $perfilpermiso_create;
        $GLOBALS['P_Lee'] = $perfilpermiso_read;
        $GLOBALS['P_Mod'] = $perfilpermiso_update;
        $GLOBALS['P_Eli'] = $perfilpermiso_delete;
      
      }

      $GLOBALS['P_User'] = $perfilpermiso_usuario;
      
      $GLOBALS['P_Acceso'] ="1";
      
    }    



    //echo 1;
    //exit();


    if ($urlmodulo=="noacceso.php"){
      $GLOBALS['P_Acceso'] ="1";
    }

    if ($urlmodulo=="index.php"){
      $GLOBALS['P_Acceso'] ="1";
    }

    if ($urlmodulo=="index.php"){
      $GLOBALS['P_Acceso'] ="1";
    }

    if ($urlmodulo=="registrar.php"){
      $GLOBALS['P_Acceso'] ="1";
    }

    if ($urlmodulo=="generarclave.php"){
      $GLOBALS['P_Acceso'] ="1";
      }

      if ($urlmodulo=="loadinfomodal.php"){
        $GLOBALS['P_Acceso'] ="1";
      }

      if ($urlmodulo==""){
      $GLOBALS['P_Acceso'] ="1";
      }

      $auditoriadet_create = $GLOBALS['P_Ins'];
      $auditoriadet_read = $GLOBALS['P_Lee'];
      $auditoriadet_update = $GLOBALS['P_Mod'];
      $auditoriadet_delete = $GLOBALS['P_Eli'];
      $auditoriadet_all = $GLOBALS['P_Tod'];
      $auditoriadet_acceso = $GLOBALS['P_Acceso'];
      $auditoriadet_usuario = $GLOBALS['P_User'];

      if ($auditoriadet_create==""){$auditoriadet_create=0;}
      if ($auditoriadet_read==""){$auditoriadet_read=0;}
      if ($auditoriadet_update==""){$auditoriadet_update=0;}
      if ($auditoriadet_delete==""){$auditoriadet_delete=0;}
      if ($auditoriadet_all==""){$auditoriadet_all=0;}
      if ($auditoriadet_acceso==""){$auditoriadet_acceso=0;}
      if ($auditoriadet_usuario==""){$auditoriadet_usuario=0;}


      $resultado = $conexion->doInsert("
      auditoriadetalle
        (auditoria_id, auditoriadet_create, auditoriadet_read, auditoriadet_update, 
        auditoriadet_delete, auditoriadet_all, auditoriadet_usuario, auditoriadet_acceso, auditoriadet_fechareg, 
        auditoriadet_activo, auditoriadet_eliminado) 
      ",
      "'$auditoria_id', '$auditoriadet_create', '$auditoriadet_read', '$auditoriadet_update',
      '$auditoriadet_delete', '$auditoriadet_all', '$auditoriadet_usuario', '$auditoriadet_acceso', '$fechaactual',
      '1', '0'");
   
    }
    

  }



  function crearMenu(){

    $urlmodulo = ObtenerNombreArchivo();
  
    $conexion = new ConexionBd();

    $arrresultado = $conexion->doSelect("compania_urlweb",
    "compania",
    "compania_id = '$_COOKIE[idcompania]'");  
    foreach($arrresultado as $i=>$valor){
      $compania_urlweb = utf8_encode($valor["compania_urlweb"]);    
    }

    $arrresultado = $conexion->doSelect("sistema_id",
    "sistemausuario",
    "usuario_id = '$_COOKIE[iniuser]' and sistemausuario_activo = '1'");  
    foreach($arrresultado as $i=>$valor){
      $sistema_id = utf8_encode($valor["sistema_id"]);    
    }
    if ($sistema_id==""){$sistema_id=1;}

    $linksalir = "index?s=1";
    if ($compania_urlweb==""){
      $linksalir = "index?s=1";
    }else{
      $linksalir = "index?s=1";
    }

 
    session_start();    

  //$_SESSION[urlmodulo]  ="";
    /* 
  if ($_SESSION[urlmodulo]!=""){
    $urlmodulo = $_SESSION[urlmodulo];    
  } */

  //       left join menusistema on menusistema.menu_id = menu.menu_id and menusistema.sistema_id  ='$sistema_id'
  /*
 $arrresultado = $conexion->doSelect("modulo.modulo_id, modulo.modulo_relmodulo, modulo.modulo_defecto, 
    modulo.modulo_sistema, modulo.modulo_ppal, menusistema.menu_id, modulo.modulo_url, 
    menusistema.menu_icono, menusistema.menu_nombre, modulo.tipomodulo_id, 
    menusistema.menu_idrel,
    menuppal.menu_nombre as menuppal_nombre,
    menuppal.menu_icono as menuppal_icono,
    moduloppal.modulo_url as moduloppal_url    
    ",
    "modulo
      left join menu on menu.modulo_id = modulo.modulo_id
      left join modulo moduloppal on moduloppal.modulo_id = modulo.modulo_relmodulo
      left join menu menuppal on menuppal.modulo_id = moduloppal.modulo_id
    ",
    "modulo.modulo_activo = '1' and modulo.modulo_url = '$urlmodulo' ");  
  */


  $arrresultado = $conexion->doSelect("modulo.modulo_id, modulo.modulo_relmodulo, modulo.modulo_defecto, 
    modulo.modulo_sistema, modulo.modulo_ppal, menu.menu_id, modulo.modulo_url, 
    menu.menu_icono, menu.menu_nombre, modulo.tipomodulo_id, 
    menu.menu_idrel,
    menuppal.menu_nombre as menuppal_nombre,
    menuppal.menu_icono as menuppal_icono,
    moduloppal.modulo_url as moduloppal_url    
    ",
    "modulo
      left join menu on menu.modulo_id = modulo.modulo_id
      left join modulo moduloppal on moduloppal.modulo_id = modulo.modulo_relmodulo
      left join menu menuppal on menuppal.modulo_id = moduloppal.modulo_id
    ",
    "modulo.modulo_activo = '1' and modulo.modulo_url = '$urlmodulo' ");  
  foreach($arrresultado as $i=>$valor){
    $modulo_id = utf8_encode($valor["modulo_id"]);
    $modulo_relmodulo = utf8_encode($valor["modulo_relmodulo"]);
    $modulo_defecto = utf8_encode($valor["modulo_defecto"]);
    $modulo_sistema = utf8_encode($valor["modulo_sistema"]);
    $modulo_ppal = utf8_encode($valor["modulo_ppal"]);
    $menu_id = utf8_encode($valor["menu_id"]);
    $menu_idseleccionado = utf8_encode($valor["menu_id"]);
    $menu_icono = utf8_encode($valor["menu_icono"]);
    $menu_nombre = utf8_encode($valor["menu_nombre"]);
    $modulo_url = utf8_encode($valor["modulo_url"]);
    $tipomodulo_id = utf8_encode($valor["tipomodulo_id"]);
    $menu_idrel = utf8_encode($valor["menu_idrel"]);
    $moduloppal_url = utf8_encode($valor["moduloppal_url"]);
    $menuppal_icono = utf8_encode($valor["menuppal_icono"]);
    $menuppal_nombre = utf8_encode($valor["menuppal_nombre"]);
    $modulorelid = utf8_encode($valor["modulorelid"]);
    $menurel_idrel = utf8_encode($valor["menurel_idrel"]);
  }

  /*
  echo "urlmodulo:". $urlmodulo;
  echo "<br>";
  echo "modulo_id:". $modulo_id;
  exit();
  */



  $modulo_url = str_replace(".php","",$modulo_url);

  /*

  if ($tipomodulo_id=="2"){//Se crea submenu


    if ($menu_idrel=="" || $menu_idrel=="0"){
      
        //echo "idrel:".$modulo_relmodulo;
        //exit();

       $arrresultado = $conexion->doSelect("distinct modulo.modulo_id, modulo.modulo_relmodulo, modulo.modulo_defecto, 
        modulo.modulo_sistema, modulo.modulo_ppal, menusistema.menu_id, modulo.modulo_url, 
        menusistema.menu_icono, menusistema.menu_nombre, modulo.tipomodulo_id, 
        menusistema.menu_idrel,
        menuppal.menu_nombre as menuppal_nombre,
        menuppal.menu_icono as menuppal_icono,
        moduloppal.modulo_url as moduloppal_url   
        ",
        "modulo
          left join menu on menu.modulo_id = modulo.modulo_id
          left join menusistema on menusistema.menu_id = menu.menu_id  and menusistema.sistema_id  ='$sistema_id'
          left join menu menuppal on menuppal.menu_id = menu.menu_idrel
          left join modulo moduloppal on moduloppal.modulo_id = menuppal.modulo_id     

        ",
        "modulo.modulo_activo = '1' and modulo.modulo_id = '$modulo_relmodulo' ");  
      foreach($arrresultado as $i=>$valor){

        $modulo_id = utf8_encode($valor["modulo_id"]);
        $modulo_relmodulo = utf8_encode($valor["modulo_relmodulo"]);
        $modulo_defecto = utf8_encode($valor["modulo_defecto"]);
        $modulo_sistema = utf8_encode($valor["modulo_sistema"]);
        $modulo_ppal = utf8_encode($valor["modulo_ppal"]);
        $menu_idrel = utf8_encode($valor["menu_id"]);

        $menu_idseleccionado = utf8_encode($valor["menu_id"]);
        $menuppal_icono = utf8_encode($valor["menu_icono"]);
        $menuppal_nombre = utf8_encode($valor["menu_nombre"]);
        $moduloppal_url = utf8_encode($valor["modulo_url"]);
        $tipomodulo_id = utf8_encode($valor["tipomodulo_id"]);

        $moduloppal_url = str_replace(".php","",$moduloppal_url);
        

      }
    }

    //echo $menu_idrel;
    //exit();


    $menu_idppal = $menu_id;  

    $menuppal_nombre = "Resumen";  

    $where = " and menu.menu_idrel = '$menu_idrel' and menu.tipomenu_id = '2'  ";
    $menu .= "
      <li><a href='panel'><i class='fa fa-arrow-circle-left'></i> <span>Volver </span></a></li>       
      <li><a href='$moduloppal_url'><i class='fa fa-dashboard'></i> <span>$menuppal_nombre</span></a></li>
      ";    
  }else if ($tipomodulo_id=="1"){

    if ($menu_id==""){// Si no tiene menu, porque es interno el permiso del modulo

      $where = " and menu.menu_idrel = '$menu_id' and menu.tipomenu_id = '1'  ";
      $menu .= "
       <li><a href='panel'><i class='fa fa-dashboard'></i> <span>Panel</span></a></li>
      "; 

    }else{


      $menu_nombre = "Resumen";
      
      $where = " and menu.menu_idrel = '$menu_id' and menu.tipomenu_id = '2'  ";
      $menu .= "      
        <li><a href='panel'><i class='fa fa-arrow-circle-left'></i> <span>Volver </span></a></li> 
        <li class='activee'><a href='$modulo_url'><i class='fa fa-dashboard'></i> <span>$menu_nombre</span></a></li>
      ";   

    }
       
  }else if ($tipomodulo_id=="5"){
    $menu_idppal = $menu_id;
    $where = " and menu.tipomenu_id = '1' ";  
    $menu .= "      
      <li  class='active'><a href='$modulo_url'><i class='fa $menu_icono'></i> <span>$menu_nombre</span></a></li>
      ";       

  }else if ($tipomodulo_id=="6" || $tipomodulo_id=="7"){
    $menu_idppal = $menu_id;
    $where = " and menu.tipomenu_id = '1' ";  
    $menu .= "
       <li><a href='panel'><i class='fa fa-dashboard'></i> <span>Panel</span></a></li>
      ";       


  }

  else{
    

    $menu .= "
       <li><a href='panel'><i class='fa fa-dashboard'></i> <span>Panel</span></a></li>
      ";        
  }



  if ($_COOKIE[perfil]>"2"){
    $wherecompaniacolocarrrrrrrrrrrrrrr = " and perfilpermiso.compania_id = '$_COOKIE[idcompania]' ";
  }


  $arrresultado = $conexion->doSelect("count(perfilpermiso_id) as total",
    "perfilpermiso",
    "perfilpermiso.perfil_id = '$_COOKIE[perfilactual]' and perfilpermiso.cuenta_id = '$_COOKIE[idcuenta]' $wherecompaniacolocar");
  $total = 0;
  foreach($arrresultado as $i=>$valor){  
    $total = utf8_encode($valor["total"]);
  }

  if ($total==0){ // Si NO tiene permisos personalizados la empresa para ese perfil se toma en cuenta los principales
    $cuentaidcolocar = "2";
    $companiaidcolocar = "1";
  }else{
    $cuentaidcolocar = $_COOKIE[idcuenta];
    $companiaidcolocar = $_COOKIE[idcompania];
  }

  if ($_COOKIE[perfil]>2){
    //$wherecompania = " and perfilpermiso.compania_id = '$companiaidcolocar' ";    
  }


  $menu = "";
  $menu .= "
       <li><a href='panel'><i class='fa fa-dashboard'></i> <span>Panel</span></a></li>
      ";       
  */

  //and perfilpermiso.cuenta_id = '$cuentaidcolocar'
  //    $wherecompania

  $menunuevo = "
       <li><a href='panel'><i class='fa fa-dashboard'></i> <span>Panel</span></a></li>
      "; 

  /*
  $arrresultado = $conexion->doSelect("distinct menusistema.menu_id, menusistema.menu_nombre, menusistema.menu_icono, menu.menu_url, menusistema.menu_ppal, menusistema.menu_submenu,  menusistema.menu_idrel, menurel.menu_nombre as menurel_nombre, menurel.menu_icono as menurel_icono, menurel.menu_url  as menurel_url, menurel.menu_submenu as menurel_submenu,  menu.modulo_id, modulo_url
  ",
    "
    menu 
      inner join menusistema on menusistema.menu_id = menu.menu_id  
      inner join modulo on modulo.modulo_id = menu.modulo_id           
      inner join perfilpermiso on perfilpermiso.modulo_id = modulo.modulo_id       
      left join menu menurel on menurel.menu_id = menu.menu_idrel
    ",
    "menu.menu_activo = '1' and menusistema.sistema_id  ='$sistema_id' and modulo_activo = '1' and perfilpermiso_activo = '1' $where
    and perfilpermiso.perfil_id = '$_COOKIE[perfilactual]' and menu.tipomenu_id = '1' 
    
    ", null, "menu.tipomenu_id, menu.menu_orden asc");
    */

      
  $arrresultado = $conexion->doSelect("distinct menu.menu_id, menu.menu_nombre, menu.menu_icono, menu.menu_url, menu.menu_ppal, menu.menu_submenu,  menu.menu_idrel, menurel.menu_nombre as menurel_nombre, menurel.menu_icono as menurel_icono, menurel.menu_url  as menurel_url, menurel.menu_submenu as menurel_submenu,  menu.modulo_id, modulo_url
  ",
    "
    menu 
      inner join modulo on modulo.modulo_id = menu.modulo_id           
      inner join perfilpermiso on perfilpermiso.modulo_id = modulo.modulo_id       
      left join menu menurel on menurel.menu_id = menu.menu_idrel
    ",
    "menu.menu_activo = '1' and modulo_activo = '1' and perfilpermiso_activo = '1' $where
    and perfilpermiso.perfil_id = '$_COOKIE[perfilactual]' and menu.tipomenu_id = '1' 
    
    ", null, "menu.tipomenu_id, menu.menu_orden asc");
    

    
  /*
  echo "<pre>";
  print_r($arrresultado);
  echo "</pre>";
  exit();
  */


  $armandosubmenu = 0; 
  foreach($arrresultado as $i=>$valor){

    $menu_id = utf8_encode($valor["menu_id"]);
    $menu_nombre = utf8_encode($valor["menu_nombre"]);
    $menu_icono = utf8_encode($valor["menu_icono"]);
    $menu_url = utf8_encode($valor["menu_url"]);    
    $menu_submenu = utf8_encode($valor["menu_submenu"]);    
    $menu_ppal = utf8_encode($valor["menu_ppal"]);
    $menu_idrel = utf8_encode($valor["menu_idrel"]);
    $menurel_nombre = utf8_encode($valor["menurel_nombre"]);
    $menurel_icono = utf8_encode($valor["menurel_icono"]);
    $menurel_url = utf8_encode($valor["menurel_url"]);    
    $menurel_submenu = utf8_encode($valor["menurel_submenu"]);
    $modulo_idconsulta = utf8_encode($valor["modulo_id"]);
    $modulo_url = utf8_encode($valor["modulo_url"]);

    $modulo_url = str_replace(".php","",$modulo_url);  
    
    

    $existesubmenu = 0;

    $arrresultado2 = $conexion->doSelect("distinct menu.menu_id, menu.menu_nombre, menu.menu_icono, menu.menu_url, menu.menu_ppal, menu.menu_submenu,  menu.menu_idrel, menurel.menu_nombre as menurel_nombre, menurel.menu_icono as menurel_icono, menurel.menu_url  as menurel_url, menurel.menu_submenu as menurel_submenu,  menu.modulo_id, modulo_url
    ",
      "
      menu 
        inner join modulo on modulo.modulo_id = menu.modulo_id           
        inner join perfilpermiso on perfilpermiso.modulo_id = modulo.modulo_id       
        left join menu menurel on menurel.menu_id = menu.menu_idrel
      ",
      "menu.menu_activo = '1' and modulo_activo = '1' and perfilpermiso_activo = '1' $where
      and perfilpermiso.perfil_id = '$_COOKIE[perfilactual]' and menu.tipomenu_id = '2'  and menu.menu_idrel = '$menu_id'
      ", null, "menu.tipomenu_id, menu.menu_orden asc");

      /*
      $arrresultado2 = $conexion->doSelect("distinct menusistema.menu_id, menusistema.menu_nombre, menusistema.menu_icono, menu.menu_url, menusistema.menu_ppal, menusistema.menu_submenu,  menusistema.menu_idrel, menurel.menu_nombre as menurel_nombre, menurel.menu_icono as menurel_icono, menurel.menu_url  as menurel_url, menurel.menu_submenu as menurel_submenu,  menu.modulo_id, modulo_url
      ",
      "
      menu 
        inner join menusistema on menusistema.menu_id = menu.menu_id  
        inner join modulo on modulo.modulo_id = menu.modulo_id           
        inner join perfilpermiso on perfilpermiso.modulo_id = modulo.modulo_id       
        left join menu menurel on menurel.menu_id = menu.menu_idrel
      ",
      "menu.menu_activo = '1' and menusistema.sistema_id  ='$sistema_id' and modulo_activo = '1' and perfilpermiso_activo = '1' $where
      and perfilpermiso.perfil_id = '$_COOKIE[perfilactual]' and menu.tipomenu_id = '2'  and menu.menu_idrel = '$menu_id'
      ", null, "menu.tipomenu_id, menu.menu_orden asc");
      */

    $detallesubmenu= "";
    $activosubmenu = 0;

    
    foreach($arrresultado2 as $i2=>$valor2){

      $existesubmenu = 1;

      $menu_id2 = utf8_encode($valor2["menu_id"]);
      $menu_nombre2 = utf8_encode($valor2["menu_nombre"]);
      $menu_icono2 = utf8_encode($valor2["menu_icono"]);
      $menu_url2 = utf8_encode($valor2["menu_url"]);    
      $menu_submenu2 = utf8_encode($valor["menu_submenu"]);    
      $menu_ppal2 = utf8_encode($valor2["menu_ppal"]);
      $menu_idrel2 = utf8_encode($valor2["menu_idrel"]);
      $menurel_nombre2 = utf8_encode($valor2["menurel_nombre"]);
      $menurel_icono2 = utf8_encode($valor2["menurel_icono"]);
      $menurel_url2 = utf8_encode($valor2["menurel_url"]);    
      $menurel_submenu2 = utf8_encode($valor2["menurel_submenu"]);
      $modulo_idconsulta2 = utf8_encode($valor2["modulo_id"]);
      $modulo_url2 = utf8_encode($valor2["modulo_url"]);

      $modulo_url2 = str_replace(".php","",$modulo_url2); 
      
      $submenuactivo = "";
      $submenuactivo_a = "";
      if ($modulo_id==$modulo_idconsulta2){
        $submenuactivo = " class='activosubmenu' ";
        $submenuactivo_a = " class='activosubmenu_a' ";
        $activosubmenu = 1;
      }



      $detallesubmenu  .=" <li $submenuactivo ><a $submenuactivo_a href='$modulo_url2'><i class='fa $menu_icono2'></i> $menu_nombre2</a></li> ";

    }

    if ($existesubmenu==0){

      $menuactivo_a = "";
      if ($modulo_id==$modulo_idconsulta){
        $menuactivo_a = " class='active' ";
      }

      $menunuevo .= "      
        <li $menuactivo_a ><a href='$modulo_url'><i class='fa $menu_icono'></i> <span>$menu_nombre</span></a></li>
      ";       

    }else{

      $menuopen = "";
      $menuopendiv = "";

      if ($activosubmenu==1){
        $menuopen = " menu-open ";
        $menuopendiv = " style='display: block;' ";
      }

      $menunuevo .="
          <li class='treeview $menuopen'>
            <a href='#'>
              <i class='fa $menu_icono'></i> <span>$menu_nombre</span>
              <span class='pull-right-container'>
                <i class='fa fa-angle-right pull-right'></i>
              </span>
            </a>
            <ul class='treeview-menu' $menuopendiv>
              $detallesubmenu
            </ul>
          </li>
      ";

    }



  }



  /*
  //<li><a href='panelmensajes'><i class='fa fa-envelope'></i> <span>Mensajes</span></a></li>

  $menu = "
          <li class='treeview'>
            <a href='#'>
              <i class='fa fa-dashboard'></i> <span>Dashboard</span>
              <span class='pull-right-container'>
                <i class='fa fa-angle-left pull-right'></i>
              </span>
            </a>
            <ul class='treeview-menu'>
              <li><a href='../../index.html'><i class='fa fa-circle-o'></i> Dashboard v1</a></li>
              <li><a href='../../index2.html'><i class='fa fa-circle-o'></i> Dashboard v2</a></li>
            </ul>
          </li>
  ".$menu;

     


  */
  
  $menunuevo .= "      
      
      <li><a href='$linksalir'><i class='fa fa-sign-out'></i> <span>Salir</span></a></li>
      ";   

    
  return $menunuevo;
  
}

function crearMenuOld(){

    $urlmodulo = ObtenerNombreArchivo();
    
    $conexion = new ConexionBd();

    $arrresultado = $conexion->doSelect("compania_urlweb",
    "compania",
    "compania_id = '$_COOKIE[idcompania]'");  
    foreach($arrresultado as $i=>$valor){
      $compania_urlweb = utf8_encode($valor["compania_urlweb"]);    
    }

    $arrresultado = $conexion->doSelect("sistema_id",
    "sistemausuario",
    "usuario_id = '$_COOKIE[iniuser]' and sistemausuario_activo = '1'");  
    foreach($arrresultado as $i=>$valor){
      $sistema_id = utf8_encode($valor["sistema_id"]);    
    }
    if ($sistema_id==""){$sistema_id=1;}


    

    $linksalir = "index?s=1";
    if ($compania_urlweb==""){
      $linksalir = "index?s=1";
    }else{
      $linksalir = "index?s=1";
    }


    session_start();    

  //$_SESSION[urlmodulo]  ="";

  if ($_SESSION[urlmodulo]!=""){
    $urlmodulo = $_SESSION[urlmodulo];    
  }

  $arrresultado = $conexion->doSelect("modulo.modulo_id, modulo.modulo_relmodulo, modulo.modulo_defecto, 
    modulo.modulo_sistema, modulo.modulo_ppal, menusistema.menu_id, modulo.modulo_url, 
    menusistema.menu_icono, menusistema.menu_nombre, modulo.tipomodulo_id, 
    menusistema.menu_idrel,
    menuppal.menu_nombre as menuppal_nombre,
    menuppal.menu_icono as menuppal_icono,
    moduloppal.modulo_url as moduloppal_url    
    ",
    "modulo
      left join menu on menu.modulo_id = modulo.modulo_id
      left join menusistema on menusistema.menu_id = menu.menu_id and menusistema.sistema_id  ='$sistema_id'
      left join modulo moduloppal on moduloppal.modulo_id = modulo.modulo_relmodulo
      left join menu menuppal on menuppal.modulo_id = moduloppal.modulo_id
    ",
    "modulo.modulo_activo = '1' and modulo.modulo_url = '$urlmodulo' ");  
  foreach($arrresultado as $i=>$valor){
    $modulo_id = utf8_encode($valor["modulo_id"]);
    $modulo_relmodulo = utf8_encode($valor["modulo_relmodulo"]);
    $modulo_defecto = utf8_encode($valor["modulo_defecto"]);
    $modulo_sistema = utf8_encode($valor["modulo_sistema"]);
    $modulo_ppal = utf8_encode($valor["modulo_ppal"]);
    $menu_id = utf8_encode($valor["menu_id"]);
    $menu_idseleccionado = utf8_encode($valor["menu_id"]);
    $menu_icono = utf8_encode($valor["menu_icono"]);
    $menu_nombre = utf8_encode($valor["menu_nombre"]);
    $modulo_url = utf8_encode($valor["modulo_url"]);
    $tipomodulo_id = utf8_encode($valor["tipomodulo_id"]);
    $menu_idrel = utf8_encode($valor["menu_idrel"]);
    $moduloppal_url = utf8_encode($valor["moduloppal_url"]);
    $menuppal_icono = utf8_encode($valor["menuppal_icono"]);
    $menuppal_nombre = utf8_encode($valor["menuppal_nombre"]);
    $modulorelid = utf8_encode($valor["modulorelid"]);
    $menurel_idrel = utf8_encode($valor["menurel_idrel"]);
  }

  $modulo_url = str_replace(".php","",$modulo_url);
/*
  print_r($menuppal_nombre);
  echo "<br><br>";

  print_r($tipomodulo_id);
  echo "<br><br>";

  print_r($urlmodulo);
  echo "<br><br>";

  print_r($arrresultado);
  exit();

*/



  if ($tipomodulo_id=="2"){//Se crea submenu


    if ($menu_idrel=="" || $menu_idrel=="0"){
      
        //echo "idrel:".$modulo_relmodulo;
        //exit();

       $arrresultado = $conexion->doSelect("distinct modulo.modulo_id, modulo.modulo_relmodulo, modulo.modulo_defecto, 
        modulo.modulo_sistema, modulo.modulo_ppal, menusistema.menu_id, modulo.modulo_url, 
        menusistema.menu_icono, menusistema.menu_nombre, modulo.tipomodulo_id, 
        menusistema.menu_idrel,
        menuppal.menu_nombre as menuppal_nombre,
        menuppal.menu_icono as menuppal_icono,
        moduloppal.modulo_url as moduloppal_url   
        ",
        "modulo
          left join menu on menu.modulo_id = modulo.modulo_id
          left join menusistema on menusistema.menu_id = menu.menu_id  and menusistema.sistema_id  ='$sistema_id'
          left join menu menuppal on menuppal.menu_id = menu.menu_idrel
          left join modulo moduloppal on moduloppal.modulo_id = menuppal.modulo_id     

        ",
        "modulo.modulo_activo = '1' and modulo.modulo_id = '$modulo_relmodulo' ");  
      foreach($arrresultado as $i=>$valor){

        $modulo_id = utf8_encode($valor["modulo_id"]);
        $modulo_relmodulo = utf8_encode($valor["modulo_relmodulo"]);
        $modulo_defecto = utf8_encode($valor["modulo_defecto"]);
        $modulo_sistema = utf8_encode($valor["modulo_sistema"]);
        $modulo_ppal = utf8_encode($valor["modulo_ppal"]);
        $menu_idrel = utf8_encode($valor["menu_id"]);

        $menu_idseleccionado = utf8_encode($valor["menu_id"]);
        $menuppal_icono = utf8_encode($valor["menu_icono"]);
        $menuppal_nombre = utf8_encode($valor["menu_nombre"]);
        $moduloppal_url = utf8_encode($valor["modulo_url"]);
        $tipomodulo_id = utf8_encode($valor["tipomodulo_id"]);

        $moduloppal_url = str_replace(".php","",$moduloppal_url);
        

      }
    }

    //echo $menu_idrel;
    //exit();


    $menu_idppal = $menu_id;  

    $menuppal_nombre = "Resumen";  

    $where = " and menu.menu_idrel = '$menu_idrel' and menu.tipomenu_id = '2'  ";
    $menu .= "
      <li><a href='panel'><i class='fa fa-arrow-circle-left'></i> <span>Volver </span></a></li>       
      <li><a href='$moduloppal_url'><i class='fa fa-dashboard'></i> <span>$menuppal_nombre</span></a></li>
      ";    
  }else if ($tipomodulo_id=="1"){

    if ($menu_id==""){// Si no tiene menu, porque es interno el permiso del modulo

      $where = " and menu.menu_idrel = '$menu_id' and menu.tipomenu_id = '1'  ";
      $menu .= "
       <li><a href='panel'><i class='fa fa-dashboard'></i> <span>Panel</span></a></li>
      "; 

    }else{


      $menu_nombre = "Resumen";
      
      $where = " and menu.menu_idrel = '$menu_id' and menu.tipomenu_id = '2'  ";
      $menu .= "      
        <li><a href='panel'><i class='fa fa-arrow-circle-left'></i> <span>Volver </span></a></li> 
        <li class='activee'><a href='$modulo_url'><i class='fa fa-dashboard'></i> <span>$menu_nombre</span></a></li>
      ";   

    }
       
  }else if ($tipomodulo_id=="5"){
    $menu_idppal = $menu_id;
    $where = " and menu.tipomenu_id = '1' ";  
    $menu .= "      
      <li  class='active'><a href='$modulo_url'><i class='fa $menu_icono'></i> <span>$menu_nombre</span></a></li>
      ";       

  }else if ($tipomodulo_id=="6" || $tipomodulo_id=="7"){
    $menu_idppal = $menu_id;
    $where = " and menu.tipomenu_id = '1' ";  
    $menu .= "
       <li><a href='panel'><i class='fa fa-dashboard'></i> <span>Panel</span></a></li>
      ";       


  }

  else{
    

    $menu .= "
       <li><a href='panel'><i class='fa fa-dashboard'></i> <span>Panel</span></a></li>
      ";        
  }



  //echo $tipomodulo_id;
  //exit();



  //$moduloId = ModuloId;

  /*
    
  */

  /*

  echo $_COOKIE[perfil];
  echo "<br>";
  echo $_COOKIE[perfilactual];
  echo "<br>";
  echo $_COOKIE[idcuenta];
  echo "<br>";
  echo $_COOKIE[idcompania];
  
  exit();

  */

  if ($_COOKIE[perfil]>"2"){
    $wherecompaniacolocarrrrrrrrrrrrrrr = " and perfilpermiso.compania_id = '$_COOKIE[idcompania]' ";
  }


  $arrresultado = $conexion->doSelect("count(perfilpermiso_id) as total",
    "perfilpermiso",
    "perfilpermiso.perfil_id = '$_COOKIE[perfilactual]' and perfilpermiso.cuenta_id = '$_COOKIE[idcuenta]' $wherecompaniacolocar");
  $total = 0;
  foreach($arrresultado as $i=>$valor){  
    $total = utf8_encode($valor["total"]);
  }

  if ($total==0){ // Si NO tiene permisos personalizados la empresa para ese perfil se toma en cuenta los principales
    $cuentaidcolocar = "2";
    $companiaidcolocar = "1";
  }else{
    $cuentaidcolocar = $_COOKIE[idcuenta];
    $companiaidcolocar = $_COOKIE[idcompania];
  }

  if ($_COOKIE[perfil]>2){
    //$wherecompania = " and perfilpermiso.compania_id = '$companiaidcolocar' ";    
  }



//and perfilpermiso.cuenta_id = '$cuentaidcolocar'
//    $wherecompania

  $arrresultado = $conexion->doSelect("distinct  menusistema.menu_id, menusistema.menu_nombre, menusistema.menu_icono, menu.menu_url, menusistema.menu_ppal, menusistema.menu_submenu,  menusistema.menu_idrel, menurel.menu_nombre as menurel_nombre, menurel.menu_icono as menurel_icono, menurel.menu_url  as menurel_url, menurel.menu_submenu as menurel_submenu,  menu.modulo_id, modulo_url
  ",
    "
    menu 
      inner join menusistema on menusistema.menu_id = menu.menu_id  
      inner join modulo on modulo.modulo_id = menu.modulo_id           
      inner join perfilpermiso on perfilpermiso.modulo_id = modulo.modulo_id       
      left join menu menurel on menurel.menu_id = menu.menu_idrel
    ",
    "menu.menu_activo = '1' and menusistema.sistema_id  ='$sistema_id' and modulo_activo = '1' and perfilpermiso_activo = '1' $where
    and perfilpermiso.perfil_id = '$_COOKIE[perfilactual]' 
    
    

    ", null, "menu.menu_orden asc");
    /*print("<pre>".print_r($arrresultado,true)."</pre>");


exit();


  echo "pa:".$_COOKIE[perfilactual];
  exit(); 

*/
  $armandosubmenu = 0; 
  foreach($arrresultado as $i=>$valor){
  
    $menu_id = utf8_encode($valor["menu_id"]);
    $menu_nombre = utf8_encode($valor["menu_nombre"]);
    $menu_icono = utf8_encode($valor["menu_icono"]);
    $menu_url = utf8_encode($valor["menu_url"]);    
    $menu_submenu = utf8_encode($valor["menu_submenu"]);    
    $menu_ppal = utf8_encode($valor["menu_ppal"]);
    $menu_idrel = utf8_encode($valor["menu_idrel"]);
    $menurel_nombre = utf8_encode($valor["menurel_nombre"]);
    $menurel_icono = utf8_encode($valor["menurel_icono"]);
    $menurel_url = utf8_encode($valor["menurel_url"]);    
    $menurel_submenu = utf8_encode($valor["menurel_submenu"]);
    $modulo_idconsulta = utf8_encode($valor["modulo_id"]);
    $modulo_url = utf8_encode($valor["modulo_url"]);

    $modulo_url = str_replace(".php","",$modulo_url);    

    $classactive = "";

    if ($menu_idseleccionado==$menu_id){
      $classactive = " active";
    }
    
    
    if ($moduloId==$modulo_idconsulta){
      $classactive  = " active ";
    }
    
    $listamenuconurl = "<li class='$classactive'><a href='$modulo_url'><i class='fa $menu_icono'></i> <span>$menu_nombre</span></a></li>";
    
    if ($menu_submenu=="0" && $menu_ppal=="0"){
    
       // Es menu solo normal
      $menu .= $listamenuconurl;
      
    }
    else if ($menu_submenu=="1" ){
    
       // Es un submenu y concateno
      $submenuconcatenado .= $listamenuconurl;

      
    } 

   

    if ($armandosubmenu=="1" && ($menu_idrelold!=$menu_idrel) && $menu_ppalold=="0"){


      $menu .= "
          <li class='treeview $classactive'>
          
              $tituloppalmenuconsubmenus
             
              <ul class='treeview-menu'>
              
                 $submenuconcatenado  
                 
              </ul>
            </li> 
          </li>
        ";

      $armandosubmenu = 0;       

    }


    if ($menu_ppal =="1" && $armandosubmenu==0){  

    
       // Borro el concateneo de submenus
      $submenuconcatenado = "";
      
      // Empieza el concateneo de submenus
      $armandosubmenu = 1;
      
      $tituloppalmenuconsubmenus = "
        <a href='#'>
          <i class='fa $menu_icono'></i>
          <span>$menu_nombre</span>
          <span class='pull-right-container'>
            <i class='fa fa-angle-left pull-right'></i>
          </span>
        </a>
      ";

      
      //$submenuconcatenado .= $listamenuconurl;
      
    } 



    /*
    if ($armandosubmenu=="1" && $menu_submenu=="0"){
      // Entra armando submenu

      if ($menu_idrelold!=$menu_idrel){
         $menu .= "
          <li class='treeview $classactive'>
          
              $tituloppalmenuconsubmenus
             
              <ul class='treeview-menu'>
              
                 $submenuconcatenado  
                 
              </ul>
            </li> 
          </li>
        ";

        $armandosubmenu = 0;

      }

      if ($menu_ppal =="1" && $armandosubmenu=="0"){   

        // Borro el concateneo de submenus
        $submenuconcatenado = "";
        
        // Empieza el concateneo de submenus
        $armandosubmenu = 1;
        
        $tituloppalmenuconsubmenus = "
          <a href='#'>
            <i class='fa $menu_icono'></i>
            <span>$menu_nombre 1</span>
            <span class='pull-right-container'>
              <i class='fa fa-angle-left pull-right'></i>
            </span>
          </a>
        ";

      }




    }

    */

/*



    else if ($menu_submenuold=="1" && $menu_submenu !="1"){

    //else if ($menurel_submenuold=="1" && $menurel_submenu!="1"){ 
    
      // Verifico que si el anterior tenia un menu y ahora en el actual no lo tiene, significa que termina submenu
      $menu .= "
        <li class='treeview $classactive'>
        
            $tituloppalmenuconsubmenus
           
            <ul class='treeview-menu'>
            
               $submenuconcatenado  
               
            </ul>
          </li> 
        </li>
      ";

      // Finaliza el concateneo de submenus
      $armandosubmenu  ="0";      
    }
    */
    
    $armandosubmenuold = $armandosubmenu;
    $menurel_submenuold = $menurel_submenu;
    $menu_ppalold = $menu_ppal;
    $menu_ppalnombrecolocar = $menu_nombre;
    $menu_submenuold = $menu_submenu;
    $menu_idrelold = $menu_idrel;
    
  
  }
  
   if ($armandosubmenu=="1"){ 
    
      // El ultimo es un menu con submenus
      $menu .= "
        <li class='treeview'>
        
            $tituloppalmenuconsubmenus           
            <ul class='treeview-menu $classactive'>
              
               $submenuconcatenado  
               
            </ul>
          </li> 
        </li>
      ";    
  }

  //<li><a href='panelmensajes'><i class='fa fa-envelope'></i> <span>Mensajes</span></a></li>

  $menu .= "      
      
      <li><a href='$linksalir'><i class='fa fa-sign-out'></i> <span>Salir</span></a></li>
      ";    

  
  
  return $menufinal.$menu;
  
}

function ConsultarPermisoModulo(){

  session_start();
  $_COOKIE[perfil] = $_COOKIE[perfil];
  $_COOKIE[idcuenta] = $_COOKIE[idcuenta];
  $_COOKIE[idcompania] = $_COOKIE[idcompania];
  
  if ($_COOKIE[perfil]!="1"){
    $where = " and perfilpermiso.cuenta_id = '$_COOKIE[idcuenta]' and perfilpermiso.compania_id = '$_COOKIE[idcompania]' ";
  }

  $moduloId = ModuloId;

  $conexion = new ConexionBd();    
  $arrresultado = $conexion->doSelect("perfilpermiso_create, perfilpermiso_read, perfilpermiso_update, perfilpermiso_delete, perfilpermiso_all, perfilpermiso_usuario",
    "
    modulo 
      inner join perfilpermiso on perfilpermiso.modulo_id = modulo.modulo_id and      
    ",
    "modulo_activo = '1' and perfilpermiso_activo = '1'  and perfilpermiso.modulo_id = '$moduloId' and perfilpermiso.perfil_id = '$_COOKIE[perfilactual]' $where");
    
  foreach($arrresultado as $i=>$valor){
  
    $perfilpermiso_create = utf8_encode($valor["perfilpermiso_create"]);
    $perfilpermiso_read = utf8_encode($valor["perfilpermiso_read"]);
    $perfilpermiso_update = utf8_encode($valor["perfilpermiso_update"]);
    $perfilpermiso_delete = utf8_encode($valor["perfilpermiso_delete"]);
    $perfilpermiso_all = utf8_encode($valor["perfilpermiso_all"]);
    $perfilpermiso_usuario = utf8_encode($valor["perfilpermiso_usuario"]);

    if ($perfilpermiso_create=="1"){setlocale (P_Ins, '1');}
    if ($perfilpermiso_read=="1"){setlocale (P_Lee, '1');}
    if ($perfilpermiso_update=="1"){setlocale (P_Mod, '1');}
    if ($perfilpermiso_delete=="1"){setlocale (P_Eli, '1');}
    if ($perfilpermiso_all=="1"){setlocale (P_Tod, '1');}
    if ($perfilpermiso_usuario=="1"){setlocale (P_User, '1');}
    
    setlocale (P_Acceso, '1');
  }
  
  
}


function ObtenerListaMoneda($valoractual=null, $elementoid=null){

  $conexion = new ConexionBd();  
  
  $arrresultado = $conexion->doSelect("l_moneda_id, moneda_nombre",
    "moneda ",
    "moneda_activo = '1'", null, "moneda_nombre asc");

  $option = "<option value=''>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

      $l_moneda_id = utf8_encode($valor["l_moneda_id"]);  
      $moneda_nombre = utf8_encode($valor["moneda_nombre"]);  

      if ($valoractual==$l_moneda_id){
          $option .= "<option selected='selected' value='$l_moneda_id'>$moneda_nombre</option>";
      }else{
          $option .= "<option value='$l_moneda_id'>$moneda_nombre</option>";
      }
      
  }
    
  $option = "
    <select class='form-control' id='$elementoid' name='valores'>
      $option
    </select>
  ";

  
  return $option;
}

function ObtenerCampoEntradaDatos($tipodato=null, $valor=null, $elementoid=null, $tipolista_id=null, $cuentaseleccionada=null, $companiaseleccionada=null, $colocarelementoarrayupload=null, $placeholder=null, $requerido=null, $deshabilitado=null ){


  $instancialista = new Lista();

  if ($tipodato=="1"){ // Eleccion de SI o NO
    $capturarvalor = TipoDato_SioNo($valor, $elementoid, $colocarelementoarrayupload, $requerido, $deshabilitado);    
  } 
  else if ($tipodato=="2"){ // Contiene decimales tambien
    $capturarvalor = TipoDato_Inputarea($valor, $elementoid, $colocarelementoarrayupload, $placeholder, $requerido, $deshabilitado);    
  } 
  else if ($tipodato=="3"){ // Textarea
    $capturarvalor = TipoDato_Textarea($valor, $elementoid, $colocarelementoarrayupload, $placeholder, $requerido, $deshabilitado);    
  } 
  else if ($tipodato=="4"){ // Input
    $capturarvalor = TipoDato_Inputarea($valor, $elementoid, $colocarelementoarrayupload, $placeholder, $requerido, $deshabilitado);    
  } 
  else if ($tipodato=="5"){ // Lista    

    if ($colocarelementoarrayupload=="1"){
      $agregararray = "[$elementoid]";
    }
    
    if ($tipolista_id == "256"){
     
      $instanciapais = new Pais();
      $capturarvalor = $instanciapais->ObtenerListaPaises($valor);  

    }else if ($tipolista_id == "397"){ // Dia semana límite pago conductor
     
      $instanciadiasemana = new DiaSemana();
      $capturarvalor = $instanciadiasemana->ObtenerListaDiaSemana($valor); 

    }else{
      $capturarvalor = $instancialista->ObtenerListaRel($tipolista_id, $cuentaseleccionada, $companiaseleccionada, $valor); 
    }
    
    if ($requerido=="1"){$requeridocolocar = "required='required'";}
    if ($deshabilitado=="1"){$deshabilitadocolocar = " disabled ";}

    $capturarvalor = "
      <select class='form-control' id='$elementoid' name='valores$agregararray' $requeridocolocar $deshabilitadocolocar>
        $capturarvalor
      </select>
    ";   
  }
  else if ($tipodato=="6"){ // Lista de monedas
    //$capturarvalor = ObtenerListaMoneda($valor, $elementoid);    
  }
  else if ($tipodato=="7"){ // CheckBox
    $capturarvalor = TipoDato_Checkbox($valor, $elementoid, $colocarelementoarrayupload, $requerido, $deshabilitado);    
  }
  else if ($tipodato=="12"){ // Hora
    $capturarvalor = TipoDato_InputareaHora($valor, $elementoid, $colocarelementoarrayupload, $placeholder, $requerido, $deshabilitado);    
  } 
  else{
    $capturarvalor = TipoDato_Inputarea($valor, $elementoid, $colocarelementoarrayupload, $placeholder, $requerido, $deshabilitado);    
  }  
  return $capturarvalor;
}

function ObtenerCampoEntradaDatos2($tipodato=null, $valor=null, $elementoid=null, $tipolista_id=null, $cuentaseleccionada=null, $companiaseleccionada=null){

  $instancialista = new Lista();

  $capturarvalor = TipoDato_Inputarea2($valor, $elementoid);    
  
  return $capturarvalor;
}


function ObtenerCampoEntradaDatos3($tipodato=null, $valor=null, $elementoid=null, $tipolista_id=null, $cuentaseleccionada=null, $companiaseleccionada=null){

  $instancialista = new Lista();

  $capturarvalor = TipoDato_Inputarea3($valor, $elementoid);    
  
  return $capturarvalor;
}

function TipoDato_Inputarea3($valor=null, $elementoid=null){

  $valorretorno = "<input type='text' class='form-control' value='$valor' name='valores[$elementoid]' id='$elementoid' autocomplete='off' style='text-align: left' />";
  
  return $valorretorno;
}





function TipoDato_SioNo($valor=null, $elementoid=null, $colocarelementoarrayupload=null, $requerido=null, $deshabilitado=null){

  if ($colocarelementoarrayupload=="1"){
    $agregararray = "[$elementoid]";
  }

  if ($requerido=="1"){$requeridocolocar = "required='required'";}
  if ($deshabilitado=="1"){$deshabilitadocolocar = " disabled ";}

  if ($valor=="1"){$valorsi = "selected='selected'";}
  if ($valor=="2"){$valorno = "selected='selected'";}

  $select = "<option value=''>-- Seleccione --</option>";
  $select .= "<option value='1' $valorsi>SI</option>";
  $select .= "<option value='2' $valorno>NO</option>";
  
  $select = "
    <select class='form-control' id='$elementoid' name='valores$agregararray' $requeridocolocar $deshabilitadocolocar>
      $select
    </select>
  ";
  
  return $select;
}


function ObtenerListaEstatus($valoractual=null, $elementoid=null, $tipoestatus_id=null){

  $conexion = new ConexionBd();

  $arrresultado = $conexion->doSelect("estatus_id, estatus_nombre","estatus ",
          "estatus_activo = '1' and tipoestatus_id = '$tipoestatus_id'", null, "estatus_nombre asc");

  $optionestatus = "<option value='0'>-- Seleccione --</option>";
  foreach($arrresultado as $i=>$valor){

    $estatus_id = utf8_encode($valor["estatus_id"]);  
    $estatus_nombre = utf8_encode($valor["estatus_nombre"]);  

    if ($valoractual==$estatus_id){
        $optionestatus .= "<option selected='selected' value='$estatus_id'>$estatus_nombre</option>";
    }else{
        $optionestatus .= "<option value='$estatus_id'>$estatus_nombre</option>";
    }
  }
  
  $optionestatus = "
    <select class='form-control' id='$elementoid' name='valores'>
      $optionestatus
    </select>
  ";

  
  return $optionestatus;
}

function TipoDato_InputareaDoble($valor=null, $elementoid=null, $cant=null, $disabled=null){

  if ($disabled=="1"){
    $disabled = " disabled = 'disabled' ";
  }

  if($cant==""){
    $valorretorno = "<input type='hidden' class='form-control' value='$valor' name='valores' id='$elementoid' autocomplete='off' />";
  }else{
    $valorretorno = "<input type='text' $disabled class='form-control' value='$valor' name='valores$cant' id='".$cant."_".$elementoid."' autocomplete='off' />";  
  }
  
  
  return $valorretorno;
}



function TipoDato_Textarea($valor=null, $elementoid=null, $colocarelementoarrayupload=null, $placeholder=nul, $requerido=null, $deshabilitado=null){

  if ($colocarelementoarrayupload=="1"){
    $agregararray = "[$elementoid]";
  }

  if ($requerido=="1"){$requeridocolocar = "required='required'";}
  if ($deshabilitado=="1"){$deshabilitadocolocar = " disabled ";}

  $valorretorno = "<textarea name='valores$agregararray' placeholder='$placeholder' id='$elementoid' class='form-control' style='width:100%' $requeridocolocar $deshabilitadocolocar>$valor</textarea>";
  
  return $valorretorno;
}

function TipoDato_Inputnumero($valor=null, $elementoid=null, $colocarelementoarrayupload=null, $placeholder=null, $requerido=null, $deshabilitado=null){

  if ($colocarelementoarrayupload=="1"){
    $agregararray = "[$elementoid]";
  }

  if ($requerido=="1"){$requeridocolocar = "required='required'";}
  if ($deshabilitado=="1"){$deshabilitadocolocar = " disabled ";}

  $valorretorno = "<input type='number' placeholder='$placeholder' class='form-control' value='$valor' name='valores$agregararray' id='$elementoid' autocomplete='off' style='text-align: center' $requeridocolocar $deshabilitadocolocar/>";
  
  return $valorretorno;
}

function TipoDato_InputnumeroDos($valor=null, $elementoid=null, $colocarelementoarrayupload=null, $placeholder=null, $requerido=null, $deshabilitado=null){

  if ($colocarelementoarrayupload=="1"){
    $agregararray = "[$elementoid]";
  }

  if ($requerido=="1"){$requeridocolocar = "required='required'";}
  if ($deshabilitado=="1"){$deshabilitadocolocar = " disabled ";}

  $valorretorno = "<input type='number' placeholder='$placeholder' class='form-control' value='$valor' name='valores$agregararray' id='$elementoid' min='00' max='99'  autocomplete='off' style='text-align: center' $requeridocolocar $deshabilitadocolocar/>";
  
  return $valorretorno;
}

function TipoDato_Inputarea($valor=null, $elementoid=null, $colocarelementoarrayupload=null, $placeholder=null, $requerido=null, $deshabilitado=null){

  if ($colocarelementoarrayupload=="1"){
    $agregararray = "[$elementoid]";
  }

  if ($requerido=="1"){$requeridocolocar = "required='required'";}
  if ($deshabilitado=="1"){$deshabilitadocolocar = " disabled ";}

  $valorretorno = "<input type='text' placeholder='$placeholder' class='form-control' value='$valor' name='valores$agregararray' id='$elementoid' autocomplete='off' style='text-align: center' $requeridocolocar $deshabilitadocolocar/>";
  
  return $valorretorno;
}

function TipoDato_Inputarea2($valor=null, $elementoid=null){

  $valorretorno = "<input type='text' class='form-control' value='$valor' name='valores' id='$elementoid' autocomplete='off' style='text-align: left' />";
  
  return $valorretorno;
}


function TipoDato_Checkbox($valor=null, $elementoid=null, $colocarelementoarrayupload=null, $requerido=null, $deshabilitado=null){

  if ($colocarelementoarrayupload=="1"){
    $agregararray = "[$elementoid]";
  }

  if ($valor=="1"){
    $valorchecked =" checked='checked' ";
  }

  if ($requerido=="1"){$requeridocolocar = "required='required'";}
  if ($deshabilitado=="1"){$deshabilitadocolocar = " disabled ";}

  $valorretorno = "<input type='checkbox' $requeridocolocar $deshabilitadocolocar $valorchecked name='valores$agregararray' id='$elementoid' style='cursor: pointer'> ";
  
  return $valorretorno;
}


function TipoDato_CheckboxPermisos($tipopermiso=null, $perfil=null, $modulo=null, $valor=null){

  if ($valor=="1"){
    $valorchecked =" checked='checked' ";
  }

  $valorretorno = "<input type='checkbox' $valorchecked name='valorespermisos' id='".$tipopermiso."__".$modulo."' onclick='marcartodospermisosmodulo(\"".$tipopermiso."\",\"".$modulo."\")' value='".$tipopermiso."' style='cursor: pointer'> ";
  
  return $valorretorno;
}


function TipoDato_InputRevision($lista_id=null, $tipo=null, $valor=null){

  $valorretorno = "<input type='text' class='form-control' value='$valor'  id='".$lista_id."__".$tipo."' autocomplete='off' />";
  
  return $valorretorno;
}


function TipoDato_CheckboxRevisión($lista_id=null, $tipo=null, $valor=null){

  if ($valor=="1"){
    $valorchecked =" checked='checked' ";
  }

  $valorretorno = "<input type='radio' $valorchecked name='valor_".$lista_id."' id='".$lista_id."__".$tipo."' style='cursor: pointer'> ";
  
  return $valorretorno;
}


function generateRandomNumber() {
  $length = 4;
  $characters = '0123456789';
  $randomString = '';
  for ($i = 0; $i < $length; $i++) {
    $randomString .= $characters[rand(0, strlen($characters) - 1)];
  }
  return $randomString;
}

function generateRandomString() {
  $length = 2;
  $characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  $randomString = '';
  for ($i = 0; $i < $length; $i++) {
    $randomString .= $characters[rand(0, strlen($characters) - 1)];
  }
  return $randomString;
}

function generarId() {
  $codigo = generateRandomString().generateRandomNumber();
  return $codigo;
}


function formatoFechaHoraBd($sinhora=null, $diasatras=null, $mesesrecorrer =null, $colocarletra=null, $compania_id=null) {


  $idcuenta = $_COOKIE[idcuenta];
  $idcompania = $_COOKIE[idcompania];

  if ($compania_id!=""){
    $idcompania = $compania_id;
  }

  $conexion = new ConexionBd();  
  $arrresultado = $conexion->doSelect("listaconfig_valoruno","listaconfig",
    "tipolista_id = '169' and compania_id = '$idcompania'  and listaconfig_activo = '1' "); 
  foreach($arrresultado as $i=>$valor){   
    $zonahoraria = utf8_encode($valor["listaconfig_valoruno"]);    
  }

  $obtenerIdLista = $zonahoraria;
  $obtenerTipoLista = 169;
  $zonahorariacompania = ObtenerListaNombreDos($obtenerIdLista, $obtenerTipoLista);
  
  
  /*
  if ($zonahorariacompania==""){
    if ($idcuenta=="1766"){ 
      date_default_timezone_set('America/Costa_Rica');  
    }else if ($idcuenta=="2388"){ 
      date_default_timezone_set('America/Bogota');  
    }else if ($idcompania=="380"){ 
      date_default_timezone_set('America/La_Paz');
    }
    else if ($idcompania=="387"){ 
      date_default_timezone_set('America/Guayaquil');
    }
    else if ($idcompania=="388"){ 
      date_default_timezone_set('America/Mexico_City');
    }
    else if ($idcompania=="389"){ 
      date_default_timezone_set('America/Argentina/Buenos_Aires');
    }
    else if ($idcompania=="390"){ 
      date_default_timezone_set('America/Lima');
    }
    else if ($idcompania=="391"){ 
      date_default_timezone_set('America/Mexico_City');
    }
    else if ($idcompania=="392"){ 
      date_default_timezone_set('America/Mexico_City');
    }
    else if ($idcompania=="393"){ 
      date_default_timezone_set('America/Mexico_City');
    }
    
    else{
      date_default_timezone_set('America/Argentina/Buenos_Aires');  
    }

  }else{
    date_default_timezone_set($zonahorariacompania);
  }
  */
  /*
  if ($idcompania=="410"){ 
    date_default_timezone_set('America/Caracas');
  }else{
    date_default_timezone_set('America/El_Salvador');
  }

  if ($idcuenta=="1766"){ 

  }
  */
  
  if ($zonahorariacompania==""){
    date_default_timezone_set('America/Bogota');  
  }else{
    date_default_timezone_set($zonahorariacompania);    
  }
  

  

  //ini_set('date.timezone','UTC');
  
  //date_default_timezone_set('Europe/Madrid');
  
  $fecha_actual = date("Y-m-d H:i:s");

  $tiempoMod = time();
  if($sinhora=="1"){
    if($mesesrecorrer!=""){          
      $fecha_actual = date("Y-m-d",strtotime($fecha_actual." $mesesrecorrer months"));
      if ($colocarletra!=""){$fecha_actual = str_replace(" ", "$colocarletra", $fecha_actual);}
      return $fecha_actual;
    }else if($diasatras!=""){  
      if ($diasatras=="1"){
        $diasatras = 30;
      }    
      $fecha_actual = date("Y-m-d",strtotime($fecha_actual." - $diasatras days")); 
      if ($colocarletra!=""){$fecha_actual = str_replace(" ", "$colocarletra", $fecha_actual);}
      return $fecha_actual;
    }else{
      $fecha_actual = date("Y-m-d",$tiempoMod);  
      if ($colocarletra!=""){$fecha_actual = str_replace(" ", "$colocarletra", $fecha_actual);}
      return $fecha_actual;
    }
  }else if($diasatras!=""){
    if ($diasatras=="1"){
      $diasatras = 30;
    }
    $fecha_actual = date("Y-m-d H:i:s",strtotime($fecha_actual." - $diasatras days")); 
    if ($colocarletra!=""){$fecha_actual = str_replace(" ", "$colocarletra", $fecha_actual);}
    return $fecha_actual;
  }else if($mesesrecorrer!=""){    
    $fecha_actual = date("Y-m-d H:i:s",strtotime($fecha_actual." $mesesrecorrer months"));
    if ($colocarletra!=""){$fecha_actual = str_replace(" ", "$colocarletra", $fecha_actual);}
    return $fecha_actual;
  }else{
    $fecha_actual = date("Y-m-d H:i:s",$tiempoMod);
    if ($colocarletra!=""){$fecha_actual = str_replace(" ", "$colocarletra", $fecha_actual);}
    return $fecha_actual;
  }
}


function sumarSegundosAFecha($fecha=null, $segundossumar=null) {  


  $nueva_fecha = date("Y-m-d H:i:s", strtotime($fecha. " + $segundossumar seconds"));

  return $nueva_fecha;

  /*
  if ($segundossumar==""){
    $segundossumar = 0;
  }
  */

  //$fecha_actual = time();
  $segundos_a_sumar = $segundossumar; // 1 hora en segundos

  $nueva_fecha = strtotime("+$segundos_a_sumar seconds", $fecha);

  $formato_fecha = date("Y-m-d H:i:s", $nueva_fecha);

  return $formato_fecha;


  //return date("Y-m-d H:i:s",strtotime($fecha." + $segundossumar seconds"));
}

function formatoFechaHoraBdPasarHoras($horassumar=null) {
  //ini_set('date.timezone','UTC');
  date_default_timezone_set('America/Argentina/Buenos_Aires');
  //date_default_timezone_set('Europe/Madrid');

  $fecha_actual = date("Y-m-d H:i:s");

  //$tiempoMod = time();

  return date("Y-m-d H:i:s",strtotime($fecha_actual." + $horassumar hours"));
/*

  if($sinhora=="1"){
    if($mesesrecorrer!=""){          
      return date("Y-m-d",strtotime($fecha_actual." $mesesrecorrer months"));
    }else{
      return date("Y-m-d",$tiempoMod);  
    }
  }else if($diasatras!=""){
    if ($diasatras=="1"){
      $diasatras = 30;
    }
    return date("Y-m-d",strtotime($fecha_actual." - $diasatras days")); ;
  }else if($mesesrecorrer!=""){    
    return date("Y-m-d",strtotime($fecha_actual." $mesesrecorrer months"));
  }else{
    return date("Y-m-d H:i:s",$tiempoMod);
  }
  */
}


function formatoFechaHoraBd2($sinhora=null, $diasatras=null, $mesesrecorrer =null) {
  //ini_set('date.timezone','UTC');
  date_default_timezone_set('America/Argentina/Buenos_Aires');

  $fecha_actual = date("d/m/Y H:i:s");

  $tiempoMod = time();
  if($sinhora=="1"){
    if($mesesrecorrer!=""){          
      return date("d/m/Y",strtotime($fecha_actual." $mesesrecorrer months"));
    }else{
      return date("d/m/Y",$tiempoMod);  
    }
  }else if($diasatras!=""){
    if ($diasatras=="1"){
      $diasatras = 30;
    }
    return date("d/m/Y H:i:s",strtotime($fecha_actual." - $diasatras days")); ;
  }else if($mesesrecorrer!=""){    
    return date("d/m/Y H:i:s",strtotime($fecha_actual." $mesesrecorrer months"));
  }else{
    return date("d/m/Y H:i:s",$tiempoMod);
  }
}



?>